Below is a **PRD (Product Requirements Document)** you can use for a Replit Agent to fix the issue where the *Orders & Positions* dialog in your tool displays **‚Äú0.00 available funds‚Äù** instead of the **actual funds from Upstox backend**. It also incorporates relevant Upstox API documentation insights and helps the dev team update the code correctly. ([Upstox - Online Stock and Share Trading][1])

---

# üìå **Product Requirements Document (PRD)**

## Title

**Fix: Wrong Available Funds Display in Orders & Positions Dialog (Upstox Integration)**

## Authors

Product / Engineering Team

## Date

**Feb 9, 2026**

---

## 1Ô∏è‚É£ **Overview**

The *Orders & Positions* UI dialog currently shows **‚Äú0.00 available funds‚Äù** even when real funds exist in the Upstox account. This is due to an incorrect use or handling of the Upstox **Get Funds & Margin API** response. The agent should fetch and display the correct funds available to trade from the Upstox backend.

---

## 2Ô∏è‚É£ **Problem Statement**

* Users see **0.00 available funds** for their Upstox account in the *Orders & Positions* dialog.
* The underlying code is likely reading the wrong field or not parsing the API response correctly.
* The Upstox API now may **combine funds only in the `equity` object** (even for other segments) as part of a response change released on July 19, 2025. This can break older code expecting separate segment values. ([Upstox - Online Stock and Share Trading][2])

---

## 3Ô∏è‚É£ **Goals**

### üü¢ Primary Goal

Show *correct available funds* fetched from Upstox in the user‚Äôs *Orders & Positions* dialog.

### üü° Secondary Goals

* Simplify UI code to follow Upstox API specification.
* Support both *equity* and *combined* fund responses.
* Ensure the fix works in all relevant views where funds are displayed.

---

## 4Ô∏è‚É£ **Current API Reference**

### üìå Upstox Get Funds & Margin API

**Endpoint:**

```http
GET https://api/upstox.com/v2/user/get-funds-and-margin
Authorization: Bearer {access_token}
Accept: application/json
```

**Response:**

```json
{
  "status": "success",
  "data": {
    "equity": {
      "used_margin": 0.8,
      "payin_amount": 200.0,
      "span_margin": 0,
      "adhoc_margin": 0,
      "notional_cash": 0,
      "available_margin": 15507.46,
      "exposure_margin": 0
    },
    "commodity": {
      "available_margin": 0,
      ...
    }
  }
}
```

* `data.equity.available_margin`: the primary field for *available funds*. ([Upstox - Online Stock and Share Trading][1])
* After the API change in 2025, **funds may all appear in the `equity` object** even for other segments. ([Upstox - Online Stock and Share Trading][2])

---

## 5Ô∏è‚É£ **Functional Requirements**

### üìå 1. **Update API Fetch Logic**

* Use the `/user/get-funds-and-margin` endpoint instead of older or deprecated endpoints.
* Pass a valid **Bearer token** and correct headers.
* Consider supporting the optional `segment` parameter (`SEC` / `COM`) if required.

---

### üìå 2. **Parse the Correct Field**

Update code to use:

* `response.data.equity.available_margin` as the **source of truth** for available funds.
* Use fallback logic **only if `available_margin` is undefined/null**.

**Example logic:**

```js
const fundsResponse = await getFundsAndMargin();
let availableFunds = 0.0;

if (fundsResponse.data && fundsResponse.data.equity) {
  availableFunds = fundsResponse.data.equity.available_margin || 0.0;
}
```

*(Pseudo-code)*

---

### üìå 3. **UI Update**

* Replace the placeholder ‚Äú0.00‚Äù with `availableFunds`.
* Refresh the UI only after a successful API response.

---

### üìå 4. **Error Handling**

* If the API returns an error, show a user-friendly message like:

  > ‚ÄúUnable to fetch available funds. Please retry.‚Äù
* If API rate limit or token expired, trigger token refresh/reauth flow.

---

## 6Ô∏è‚É£ **Non-Functional Requirements**

| Category        | Requirement                                           |
| --------------- | ----------------------------------------------------- |
| **Performance** | Funds fetch must complete within 2s to avoid UI delay |
| **Security**    | Bearer token must be securely stored & refreshed      |
| **Resilience**  | Gracefully fallback with cached value if API fails    |
| **Logging**     | Log errors and raw API responses for debugging        |

---

## 7Ô∏è‚É£ **Acceptance Criteria**

üü° **Given** valid Upstox credentials and a funded account
üîµ **When** the *Orders & Positions* dialog loads
üü¢ **Then** the dialog should show the *correct available funds* matching the Upstox account value fetched from API

---

## 8Ô∏è‚É£ **Test Cases**

| Scenario                         | Expected Result                   |
| -------------------------------- | --------------------------------- |
| Available margin > 0             | UI shows the actual margin amount |
| API returns null/undefined field | UI shows 0.00 and logs a warning  |
| API error                        | UI shows error message            |
| Segment filter (if used)         | Funds fetch still correct         |

---

## 9Ô∏è‚É£ **Assumptions & Notes**

* Upstox‚Äôs **Get Funds & Margin** API returns *available margin* equivalent to *funds available to trade*. ([Upstox Community][3])
* There‚Äôs no separate dedicated API for *wallet balance* beyond this endpoint. ([Upstox Community][4])

---

## 10Ô∏è‚É£ **Implementation Checklist**

* [ ] Update backend fetch code to call the correct API with auth
* [ ] Validate and unit-test parsing of `available_margin`
* [ ] Update frontend binding logic
* [ ] Add error states and logs
* [ ] QA test across multiple user accounts

---

If you want, I can also generate one **ready-to-use code patch** (with Replit syntax) that implements the fix in JavaScript or Python for your agent. Just tell me the language and framework!

[1]: https://upstox.com/developer/api-documentation/get-user-fund-margin?utm_source=chatgpt.com "Get Fund And Margin | Upstox Developer API"
[2]: https://upstox.com/developer/api-documentation/announcements/fund-margin-api-change/?utm_source=chatgpt.com "Fund and Margin API Response Change | Upstox Developer API"
[3]: https://community.upstox.com/t/get-fund-and-margin-api/7204?utm_source=chatgpt.com "Get Fund And Margin API - Developer API - Upstox Community"
[4]: https://community.upstox.com/t/is-there-an-api-to-fetch-wallet-balance/4949?utm_source=chatgpt.com "Is there an API to fetch wallet balance? - Developer API - Upstox Community"
