import { motion, AnimatePresence } from "framer-motion";\n\nimport { BrokerData } from "@/components/broker-data";\n\nimport React, {\n  useState,\n  useEffect,\n  useMemo,\n  useCallback,\n  useRef,\n} from "react";\nimport { useLocation } from "wouter";\n\nimport { useToast } from "@/hooks/use-toast";\n\nimport { AuthButtonAngelOne, AngelOneStatus, AngelOneApiStatistics, AngelOneSystemStatus, AngelOneLiveMarketPrices } from "@/components/auth-button-angelone";\n\nimport { AuthButtonUpstox } from "@/components/auth-button-upstox";\n\nimport { TradingJournalModal } from "@/components/trading-journal-modal";\n\n// REMOVED: All Fyers-related imports\n// import { AuthButton } from "@/components/auth-button";\n\n// import { ConnectionStatus } from "@/components/connection-status";\n\n// import { MonthlyProgressTracker } from "@/components/monthly-progress-tracker";\n\n// import { ApiStatistics } from "@/components/api-statistics";\n\n// import { ErrorPanel } from "@/components/error-panel";\n\nimport { SigninDataWindow } from "@/components/signin-data-window";\n\nimport { TradingViewWidget } from "@/components/tradingview-widget";\n\nimport { AdvancedCandlestickChart } from "@/components/advanced-candlestick-chart";\n\nimport { EnhancedTradingViewWidget } from "@/components/enhanced-tradingview-widget";\n\nimport { TradingViewStyleChart } from "@/components/tradingview-style-chart";\n\nimport { MinimalChart } from "@/components/minimal-chart";\n\nimport {\n\n  MultipleImageUpload,\n  MultipleImageUploadRef,\n} from "@/components/multiple-image-upload";\nimport { IndicatorCrossingsDisplay } from "@/components/indicator-crossings-display";\n\n// import { BattuScanSimulation } from "@/components/battu-scan-simulation";\n\n// import { FourCandleRuleScanner } from "@/components/four-candle-rule-scanner";\n\nimport NeoFeedSocialFeed from "@/components/neofeed-social-feed";\nimport SimpleCompleteScanner from "@/components/simple-complete-scanner";\n// import { BattuDocumentationDisplay } from "@/components/battu-documentation-display";\n\nimport { StrategyBuilder } from "@/components/strategy-builder";\n\nimport { TradingMaster } from "@/components/trading-master";\n\nimport { WorldMap } from "@/components/world-map";\n\nimport { DemoHeatmap } from "@/components/DemoHeatmap";\n\nimport { PersonalHeatmap } from "@/components/PersonalHeatmap";\n\nimport { useTheme } from "@/components/theme-provider";\n\nimport { useCurrentUser } from "@/hooks/useCurrentUser";\n\nimport { useAngelOneAutoconnect } from "@/hooks/useAngelOneAutoconnect";\n\nimport { cognitoSignOut, getCognitoToken, sendEmailVerificationCode, confirmEmailVerification, checkEmailVerified } from "@/cognito";\n\nimport { createChart, ColorType, IChartApi, ISeriesApi, CandlestickSeries, LineSeries, HistogramSeries, IPriceLine, createSeriesMarkers } from 'lightweight-charts';\n\nimport { ArrowLeft, Banknote, Clock, ExternalLink, Info, Loader2, LogOut, Newspaper, RefreshCw, Save, TrendingUp, Award, Headset, X, Play, Music2, Pencil, CheckCircle } from "lucide-react";\n\nimport { parseBrokerTrades, ParseError } from "@/utils/trade-parser";\n\n\n// Global window type declaration for audio control\ndeclare global {\n  interface Window {\n    stopNewsAudio?: () => void;\n  }\n}\n\n// import ThreeCycleScanner from "@/components/three-cycle-scanner";\nimport HistoricalTradeSimulator from "@/components/historical-trade-simulator";\nimport {\n\n  PriceChangeAnimation,\n  TradeExecutionAnimation,\n  VolumeSpikeAnimation,\n  MarketStatusPulse,\n  ProfitLossAnimation,\n  CandlestickAnimation,\n  MarketDataSkeleton,\n} from "@/components/micro-animations";\nimport { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";\n\nimport {\n\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from "@/components/ui/card";\nimport { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";\nimport { Button } from "@/components/ui/button";\n\nimport { Input } from "@/components/ui/input";\n\nimport { Label } from "@/components/ui/label";\n\nimport { Switch } from "@/components/ui/switch";\n\nimport {\n\n  Dialog,\n  DialogContent,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from "@/components/ui/dialog";\nimport { Textarea } from "@/components/ui/textarea";\n\nimport {\n\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from "@/components/ui/select";\nimport {\n\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from "@/components/ui/table";\nimport {\n\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from "@/components/ui/popover";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";\n\nimport {\n\n  TrendingDown,\n  Activity,\n  Calendar,\n  BarChart3,\n  \n  Pause,\n  RotateCcw,\n  RotateCw,\n  DollarSign,\n  Zap,\n  Sun,\n  Moon,\n  GraduationCap,\n  Download,\n  Mic,\n  MessageCircle,\n  BookOpen,\n  Home as HomeIcon,\n  Search,\n  Code,\n  PenTool,\n  Target,\n  Grid3X3,\n  Send,\n  Sparkles,\n  Users,\n  Upload,\n  Timer,\n  Edit,\n  Check,\n  Mail,\n  \n  ChevronLeft,\n  ChevronRight,\n  ChevronDown,\n  ChevronUp,\n  Tag,\n  Trash2,\n  AlertTriangle,\n  AlertCircle,\n  Shield,\n  Bot,\n  User,\n  SkipBack,\n  SkipForward,\n  Heart,\n  Lightbulb,\n  Star,\n  FileText,\n  Bell,\n  Briefcase,\n  PieChart,\n  Lock,\n  Trophy,\n  Radio,\n  Eye,\n  EyeOff,\n  Blocks,\n  Hammer,\n  Plus,\n  Share2,\n  Copy,\n  Link2,\n  Facebook,\n  Linkedin,\n  Twitter,\n  Settings,\n  Filter,\n  Radar,\n  RefreshCcw,\n  MoreVertical,\n  ChevronsUpDown,\n  CalendarDays,\n  Brain,\n  ShieldCheck,\n} from "lucide-react";\nimport { AIChatWindow } from "@/components/ai-chat-window";\n\nimport { BrokerImportDialog } from "@/components/broker-import-dialog";\n\nimport { TradeBlockEditor } from "@/components/TradeBlockEditor";\n\nimport type { BrokerTrade } from "@shared/schema";\n\n// Type definitions for stock data and trading\ninterface StockData {\n  symbol: string;\n  price: number;\n  change: number;\n  changePercent: number;\n  volume: string | number;\n  marketCap: string;\n  pe: number;\n  high: number;\n  low: number;\n  open: number;\n  sentiment: {\n    trend?: string;\n    confidence?: string;\n    score?: number;\n  } | null;\n  indicators: {\n    rsi?: string;\n    ema50?: string;\n    macd?: string;\n  } | null;\n}\n\ninterface TradeMarker {\n  candleIndex: number;\n  price: number;\n  type: "buy" | "sell";\n  symbol: string;\n  quantity: number;\n  time: string;\n  pnl: string;\n}\n\n// SwipeableCardStack Component\ninterface SwipeableCardStackProps {\n  onSectorChange: (sector: string) => void;\n  selectedSector: string;\n  onCardIndexChange?: (index: number) => void;\n  currentCardIndex?: number;\n}\n\nfunction SwipeableCardStack({\n  onSectorChange,\n  selectedSector,\n  onCardIndexChange,\n  currentCardIndex = 0,\n}: SwipeableCardStackProps) {\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [currentContent, setCurrentContent] = useState<string>("");\n  const [isLoading, setIsLoading] = useState(false);\n  const [currentAudio, setCurrentAudio] =\n    useState<SpeechSynthesisUtterance | null>(null);\n\n  const [cards, setCards] = useState([\n    {\n      id: 1,\n      title: "TECH NEWS",\n      subtitle: "Latest in\ntechnology",\n      buttonText: "Read Now",\n      gradient: "from-blue-500 to-blue-600",\n      buttonColor: "text-blue-600",\n      icon: "💻",\n      sector: "IT",\n    },\n    {\n      id: 2,\n      title: "FINANCE NEWS",\n      subtitle: "Market updates\n& trends",\n      buttonText: "Listen",\n      gradient: "from-green-500 to-green-600",\n      buttonColor: "text-green-600",\n      icon: "📈",\n      sector: "FINANCE",\n    },\n    {\n      id: 3,\n      title: "COMMODITY NEWS",\n      subtitle: "Commodity\nmarket trends",\n      buttonText: "Listen",\n      gradient: "from-orange-500 to-orange-600",\n      buttonColor: "text-orange-600",\n      icon: "🏗️",\n      sector: "COMMODITY",\n    },\n    {\n      id: 4,\n      title: "GLOBAL NEWS",\n      subtitle: "World events\n& updates",\n      buttonText: "Listen",\n      gradient: "from-purple-500 to-purple-600",\n      buttonColor: "text-purple-600",\n      icon: "🌍",\n      sector: "GLOBAL",\n    },\n    {\n      id: 5,\n      title: "BANKING NEWS",\n      subtitle: "Banking sector\nupdates",\n      buttonText: "Listen",\n      gradient: "from-indigo-500 to-indigo-600",\n      buttonColor: "text-indigo-600",\n      icon: "🏦",\n      sector: "BANKS",\n    },\n    {\n      id: 6,\n      title: "AUTO NEWS",\n      subtitle: "Automotive\nindustry news",\n      buttonText: "Listen",\n      gradient: "from-red-500 to-red-600",\n      buttonColor: "text-red-600",\n      icon: "🚗",\n      sector: "AUTOMOBILE",\n    },\n  ]);\n\n  // News cache for faster loading - ultra-short cache for speed\n  const newsCache = React.useRef<\n    Record<string, { content: string; timestamp: number }>\n  >({});\n  const CACHE_DURATION = 10 * 1000; // 10 seconds - ultra-short for instant refresh\n\n  // Global cleanup function to stop all audio\n  const globalStopAudio = React.useCallback(() => {\n    if (currentAudio) {\n      speechSynthesis.cancel();\n      setCurrentAudio(null);\n      setIsPlaying(false);\n    }\n  }, [currentAudio]);\n\n  // Fetch AI-generated news content for current card with caching\n  const fetchAndPlayContent = async (cardTitle: string, sector: string) => {\n    // Stop any currently playing audio immediately\n    globalStopAudio();\n\n    try {\n      setIsLoading(true);\n\n      // Check cache first\n      const cacheKey = sector;\n      const cachedData = newsCache.current[cacheKey];\n      const now = Date.now();\n\n      if (cachedData && now - cachedData.timestamp < CACHE_DURATION) {\n        // Use cached content\n        setCurrentContent(cachedData.content);\n        playAudio(cachedData.content);\n        setIsLoading(false);\n        return;\n      }\n\n      const response = await fetch(getFullApiUrl("/api/daily-news"), {\n        method: "POST",\n        headers: {\n          "Content-Type": "application/json",\n        },\n        body: JSON.stringify({ sector: sector }),\n      });\n\n      if (!response.ok) {\n        throw new Error("Failed to generate news content");\n      }\n\n      const data = await response.json();\n      const content = data.summary;\n\n      // Cache the content\n      newsCache.current[cacheKey] = {\n        content,\n        timestamp: now,\n      };\n\n      setCurrentContent(content);\n      playAudio(content);\n    } catch (error) {\n      console.error("Error fetching news:", error);\n      const fallbackContent = `${sector.toLowerCase()} market update. Current developments in progress. Trading activity continues.`;\n      setCurrentContent(fallbackContent);\n      playAudio(fallbackContent);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // Play audio using Speech Synthesis with optimized settings\n  const playAudio = (text: string) => {\n    // Stop current audio if playing\n    if (currentAudio) {\n      speechSynthesis.cancel();\n    }\n\n    // Clean the text to remove any potential greetings\n    const cleanText = text\n      .replace(\n        /^(good morning|good afternoon|good evening|hello|hi|welcome)/gi,\n        "",\n      )\n      .replace(/^(ladies and gentlemen|dear listeners|in today's news)/gi, "")\n      .replace(/^[.,\s]+/, "") // Remove leading punctuation and spaces\n      .trim();\n\n    const utterance = new SpeechSynthesisUtterance(cleanText);\n\n    const voices = speechSynthesis.getVoices();\n    const voiceProfileMap: Record<string, string[]> = {\n      ravi: ["Samantha", "Google UK English Male", "Microsoft Ravi Online (Natural)", "en-IN-Wavenet-B", "en-IN-Standard-B", "ravi", "moira"],\n      vaib: ["Maro", "Google US English", "Microsoft Vaibhav Online (Natural)", "en-IN-Wavenet-A", "en-IN-Standard-A", "samantha", "aria"],\n      kids: ["Heera", "Google UK English Female", "Microsoft Heera Online (Natural)", "en-IN-Wavenet-D", "en-IN-Standard-D", "ava", "samantha"]\n    };\n    const selectedProfile = (typeof window !== "undefined" && localStorage.getItem("activeVoiceProfileId")) || "ravi";\n    const priorityKeywords = voiceProfileMap[selectedProfile as keyof typeof voiceProfileMap] || voiceProfileMap.ravi;\n\n    let preferredVoice = voices.find(v => \n      v.lang.startsWith("en") && \n      priorityKeywords.some(keyword => v.name.toLowerCase().includes(keyword.toLowerCase()))\n    );\n\n    if (!preferredVoice) {\n      preferredVoice = voices.find(v => v.lang.startsWith("en"));\n    }\n\n    if (preferredVoice) {\n      utterance.voice = preferredVoice;\n    }\n\n    utterance.onstart = () => setIsPlaying(true);\n    utterance.onend = () => {\n      setIsPlaying(false);\n      setCurrentAudio(null);\n    };\n    utterance.onerror = () => {\n      setIsPlaying(false);\n      setCurrentAudio(null);\n    };\n\n    setCurrentAudio(utterance);\n    speechSynthesis.speak(utterance);\n  };\n\n  // Stop audio playback\n  const stopAudio = () => {\n    if (currentAudio) {\n      speechSynthesis.cancel();\n      setIsPlaying(false);\n      setCurrentAudio(null);\n    }\n  };\n\n  const swipeCard = (direction: "left" | "right") => {\n    // Immediately stop current audio\n    globalStopAudio();\n\n    setCards((prev) => {\n      const newCards = [...prev];\n      let newIndex = currentCardIndex;\n\n      if (direction === "right") {\n        // Right swipe: Move to next card (current card goes to back)\n        const topCard = newCards.shift();\n        if (topCard) {\n          newCards.push(topCard);\n        }\n        newIndex = (currentCardIndex + 1) % 7;\n      } else {\n        // Left swipe: Move to previous card (bottom card comes to front)\n        const bottomCard = newCards.pop();\n        if (bottomCard) {\n          newCards.unshift(bottomCard);\n        }\n        newIndex = (currentCardIndex - 1 + 7) % 7;\n      }\n\n      // Notify parent of index change\n      if (onCardIndexChange) {\n        onCardIndexChange(newIndex);\n      }\n\n      // Auto-play content for the new front card (faster response)\n      if (newCards.length > 0) {\n        const frontCard = newCards[0];\n        setTimeout(() => {\n          fetchAndPlayContent(frontCard.title, frontCard.sector);\n        }, 100); // Reduced delay for faster response\n      }\n\n      return newCards;\n    });\n  };\n\n  // Expose global stop function to window for tab switching\n  React.useEffect(() => {\n    window.stopNewsAudio = globalStopAudio;\n\n    return () => {\n      delete window.stopNewsAudio;\n    };\n  }, [globalStopAudio]);\n\n  // Add window focus/blur detection to stop voice when clicking away\n  React.useEffect(() => {\n    const handleWindowBlur = () => {\n      // Stop audio when user clicks away from the window\n      globalStopAudio();\n    };\n\n    const handleVisibilityChange = () => {\n      // Stop audio when tab becomes hidden\n      if (document.hidden) {\n        globalStopAudio();\n      }\n    };\n\n    // Listen for window losing focus\n    window.addEventListener("blur", handleWindowBlur);\n    // Listen for tab visibility changes\n    document.addEventListener("visibilitychange", handleVisibilityChange);\n\n    return () => {\n      window.removeEventListener("blur", handleWindowBlur);\n      document.removeEventListener("visibilitychange", handleVisibilityChange);\n    };\n  }, [globalStopAudio]);\n\n  // Load voices on component mount\n  React.useEffect(() => {\n    // Ensure voices are loaded\n    const loadVoices = () => {\n      speechSynthesis.getVoices();\n    };\n\n    // Load voices immediately and on voiceschanged event\n    loadVoices();\n    speechSynthesis.addEventListener("voiceschanged", loadVoices);\n\n    // Cleanup on unmount\n    return () => {\n      speechSynthesis.removeEventListener("voiceschanged", loadVoices);\n      globalStopAudio(); // Stop any playing audio when component unmounts\n    };\n  }, [globalStopAudio]);\n\n  // Voice functionality is now only triggered by manual clicks\n\n  return (\n    <div className="relative w-56 h-48 md:w-44 md:h-52">\n      {cards.map((card, index) => {\n        const isTop = index === 0;\n        const isSecond = index === 1;\n        const isThird = index === 2;\n\n        return (\n          <div\n            key={card.id}\n            data-card-index={index}\n            className={`absolute inset-0 transition-all duration-300 ease-out cursor-grab active:cursor-grabbing ${\n              isTop\n                ? "z-40 scale-100 rotate-0"\n                : isSecond\n                  ? "z-30 scale-95 rotate-1 translate-y-2"\n                  : isThird\n                    ? "z-20 scale-90 rotate-2 translate-y-4"\n                    : "z-10 scale-85 rotate-3 translate-y-6 opacity-50"\n            }`}\n            onMouseDown={(e: React.MouseEvent<HTMLDivElement>) => {\n              if (!isTop) return;\n\n              const startX = e.clientX;\n              const startY = e.clientY;\n              const cardElement = e.currentTarget as HTMLElement;\n              let isDragging = false;\n\n              const handleMouseMove = (e: MouseEvent) => {\n                const deltaX = e.clientX - startX;\n                const deltaY = e.clientY - startY;\n\n                if (\n                  !isDragging &&\n                  (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)\n                ) {\n                  isDragging = true;\n                }\n\n                if (isDragging) {\n                  const rotation = deltaX * 0.1;\n                  cardElement.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;\n                  cardElement.style.opacity = String(\n                    Math.max(0.3, 1 - Math.abs(deltaX) / 300),\n                  );\n                }\n              };\n\n              const handleMouseUp = (e: MouseEvent) => {\n                if (isDragging) {\n                  const deltaX = e.clientX - startX;\n                  if (Math.abs(deltaX) > 100) {\n                    // Determine swipe direction\n                    const swipeDirection = deltaX > 0 ? "right" : "left";\n\n                    if (swipeDirection === "right") {\n                      // Right swipe: Card moves away animation\n                      const direction = "150%";\n                      const rotation = "30deg";\n                      cardElement.style.transform = `translate(${direction}, ${\n                        deltaX * 0.5\n                      }px) rotate(${rotation})`;\n                      cardElement.style.opacity = "0";\n\n                      setTimeout(() => {\n                        cardElement.style.transform = "";\n                        cardElement.style.opacity = "";\n                        swipeCard(swipeDirection);\n                      }, 300);\n                    } else {\n                      // Left swipe: Previous card slides in from left (reverse animation)\n                      cardElement.style.transform = "";\n                      cardElement.style.opacity = "";\n\n                      // Change the card order first\n                      swipeCard(swipeDirection);\n\n                      // Then animate the new top card sliding in from the right (coming back)\n                      setTimeout(() => {\n                        const newTopCard =\n                          cardElement.parentElement?.querySelector(\n                            '[data-card-index="0"]',\n                          ) as HTMLElement;\n                        if (newTopCard) {\n                          // Start from right side with rotation (like it's coming back)\n                          newTopCard.style.transform =\n                            "translate(150%, 0) rotate(30deg)";\n                          newTopCard.style.opacity = "0";\n\n                          // Animate to center\n                          setTimeout(() => {\n                            newTopCard.style.transform = "";\n                            newTopCard.style.opacity = "";\n                            newTopCard.style.transition =\n                              "transform 300ms ease-out, opacity 300ms ease-out";\n\n                            // Clear transition after animation\n                            setTimeout(() => {\n                              newTopCard.style.transition = "";\n                            }, 300);\n                          }, 10);\n                        }\n                      }, 10);\n                    }\n                  } else {\n                    // Snap back to center\n                    cardElement.style.transform = "";\n                    cardElement.style.opacity = "";\n                  }\n                }\n\n                document.removeEventListener("mousemove", handleMouseMove);\n                document.removeEventListener("mouseup", handleMouseUp);\n              };\n\n              document.addEventListener("mousemove", handleMouseMove);\n              document.addEventListener("mouseup", handleMouseUp);\n            }}\n            onTouchStart={(e: React.TouchEvent<HTMLDivElement>) => {\n              if (!isTop) return;\n\n              const startX = e.touches[0].clientX;\n              const startY = e.touches[0].clientY;\n              const cardElement = e.currentTarget as HTMLElement;\n              let isDragging = false;\n\n              const handleTouchMove = (e: TouchEvent) => {\n                const deltaX = e.touches[0].clientX - startX;\n                const deltaY = e.touches[0].clientY - startY;\n\n                if (\n                  !isDragging &&\n                  (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5)\n                ) {\n                  isDragging = true;\n                }\n\n                if (isDragging) {\n                  e.preventDefault();\n                  const rotation = deltaX * 0.1;\n                  cardElement.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${rotation}deg)`;\n                  cardElement.style.opacity = String(\n                    Math.max(0.3, 1 - Math.abs(deltaX) / 300),\n                  );\n                }\n              };\n\n              const handleTouchEnd = (e: TouchEvent) => {\n                if (isDragging) {\n                  const deltaX = e.changedTouches[0].clientX - startX;\n                  if (Math.abs(deltaX) > 100) {\n                    // Determine swipe direction\n                    const swipeDirection = deltaX > 0 ? "right" : "left";\n\n                    if (swipeDirection === "right") {\n                      // Right swipe: Card moves away animation\n                      const direction = "150%";\n                      const rotation = "30deg";\n                      cardElement.style.transform = `translate(${direction}, ${\n                        deltaX * 0.5\n                      }px) rotate(${rotation})`;\n                      cardElement.style.opacity = "0";\n\n                      setTimeout(() => {\n                        cardElement.style.transform = "";\n                        cardElement.style.opacity = "";\n                        swipeCard(swipeDirection);\n                      }, 300);\n                    } else {\n                      // Left swipe: Previous card slides in from left (reverse animation)\n                      cardElement.style.transform = "";\n                      cardElement.style.opacity = "";\n\n                      // Change the card order first\n                      swipeCard(swipeDirection);\n\n                      // Then animate the new top card sliding in from the right (coming back)\n                      setTimeout(() => {\n                        const newTopCard =\n                          cardElement.parentElement?.querySelector(\n                            '[data-card-index="0"]',\n                          ) as HTMLElement;\n                        if (newTopCard) {\n                          // Start from right side with rotation (like it's coming back)\n                          newTopCard.style.transform =\n                            "translate(150%, 0) rotate(30deg)";\n                          newTopCard.style.opacity = "0";\n\n                          // Animate to center\n                          setTimeout(() => {\n                            newTopCard.style.transform = "";\n                            newTopCard.style.opacity = "";\n                            newTopCard.style.transition =\n                              "transform 300ms ease-out, opacity 300ms ease-out";\n\n                            // Clear transition after animation\n                            setTimeout(() => {\n                              newTopCard.style.transition = "";\n                            }, 300);\n                          }, 10);\n                        }\n                      }, 10);\n                    }\n                  } else {\n                    // Snap back to center\n                    cardElement.style.transform = "";\n                    cardElement.style.opacity = "";\n                  }\n                }\n\n                document.removeEventListener("touchmove", handleTouchMove);\n                document.removeEventListener("touchend", handleTouchEnd);\n              };\n\n              document.addEventListener("touchmove", handleTouchMove, {\n                passive: false,\n              });\n              document.addEventListener("touchend", handleTouchEnd);\n            }}\n            onClick={() => {\n              if (isTop) {\n                console.log(`Clicked on ${card.title}`);\n                onSectorChange(card.sector);\n              }\n            }}\n          >\n            <div\n              className={`bg-gradient-to-br ${card.gradient} rounded-2xl p-5 md:p-6 h-full relative overflow-hidden shadow-xl border-2 border-white/10 flex flex-col`}\n            >\n              {/* Character illustration area */}\n              <div className="absolute bottom-0 right-0 w-20 h-20 md:w-24 md:h-24 opacity-20">\n                <div className="w-full h-full bg-gradient-to-br from-white/20 to-white/10 rounded-full"></div>\n              </div>\n\n              {/* Card content */}\n              <div className="relative z-10 flex flex-col h-full">\n                <div className="text-[10px] md:text-[9px] text-white/90 mb-1 md:mb-1.5 uppercase tracking-wider font-semibold">\n                  {card.title}\n                </div>\n                <h3 className="text-lg md:text-base font-bold text-white mb-3 md:mb-3 leading-snug flex-grow">\n                  {card.subtitle.split("\n").map((line, i) => (\n                    <div key={i} className="hidden md:block">{line}</div>\n                  ))}\n                </h3>\n                <Button\n                  className={`bg-white ${card.buttonColor} hover:bg-gray-100 px-3 py-1.5 md:px-3 md:py-1 rounded-full text-xs md:text-[11px] font-semibold shadow-lg w-fit`}\n                  onClick={() => {\n                    if (isTop) {\n                      const userId = localStorage.getItem('currentUserId');\n                      const userEmail = localStorage.getItem('currentUserEmail');\n\n                      if (!userId || !userEmail) {\n                        console.log('🔒 User not authenticated, redirecting to login');\n                        window.location.href = '/login';\n                        return;\n                      }\n\n                      if (isPlaying) {\n                        stopAudio();\n                      } else {\n                        fetchAndPlayContent(card.title, card.sector);\n                      }\n                    }\n                  }}\n                  disabled={isLoading && isTop}\n                >\n                  <div className="flex items-center gap-2">\n                    {isTop && isLoading ? (\n                      <RotateCcw className="w-4 h-4 animate-spin" />\n                    ) : isTop && isPlaying ? (\n                      <Pause className="w-4 h-4" />\n                    ) : (\n                      <Play className="w-4 h-4" />\n                    )}\n                    <span>\n                      {isTop && isLoading\n                        ? "Generating..."\n                        : isTop && isPlaying\n                          ? "Pause"\n                          : card.buttonText}\n                    </span>\n                  </div>\n                </Button>\n              </div>\n\n              {/* Icon */}\n              <div className="absolute top-2 right-2 md:top-1.5 md:right-1.5 text-xl md:text-lg filter drop-shadow-lg">\n                {card.icon}\n              </div>\n\n              {/* Stack indicator for non-top cards */}\n              {!isTop && (\n                <div className="absolute inset-0 bg-black/10 rounded-2xl"></div>\n              )}\n            </div>\n          </div>\n        );\n      })}\n    </div>\n  );\n}\nimport { format } from "date-fns";\n\nimport { apiRequest } from "@/lib/queryClient";\n\nimport {\n\n  LineChart,\n  Line,\n  AreaChart,\n  Area,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  ResponsiveContainer,\n  Tooltip,\n  CartesianGrid,\n  Pie,\n  Cell,\n  ReferenceLine,\n} from "recharts";\n\nfunction NiftyIndex() {\n  const {\n    data: marketData,\n    isLoading,\n    error,\n  } = useQuery({\n    queryKey: ["/api/market-data"],\n    refetchInterval: 3000, // Refresh every 3 seconds for live data\n  });\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className="flex items-center gap-2">\n            <Activity className="h-5 w-5" />\n            NIFTY 50 Index\n          </CardTitle>\n          <CardDescription>Live market data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className="animate-pulse">Loading...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className="flex items-center gap-2">\n            <Activity className="h-5 w-5" />\n            NIFTY 50 Index\n          </CardTitle>\n          <CardDescription>Live market data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className="text-red-500">Error loading data</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // Find NIFTY50 data from the response\n  const niftyData = Array.isArray(marketData)\n    ? marketData.find((item: any) => item.symbol === "NIFTY50")\n    : null;\n\n  if (!niftyData) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className="flex items-center gap-2">\n            <Activity className="h-5 w-5" />\n            NIFTY 50 Index\n          </CardTitle>\n          <CardDescription>Live market data</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div>NIFTY data not available</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const isPositive = niftyData.change >= 0;\n  const TrendIcon = isPositive ? TrendingUp : TrendingDown;\n  const trendColor = isPositive ? "text-green-600" : "text-red-600";\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className="flex items-center gap-2">\n          <Activity className="h-5 w-5" />\n          {niftyData.name}\n        </CardTitle>\n        <CardDescription>Live streaming data from NSE</CardDescription>\n      </CardHeader>\n      <CardContent className="space-y-4">\n        <div className="grid grid-cols-2 gap-4">\n          <div>\n            <div className="text-2xl font-bold">\n              {niftyData.ltp?.toLocaleString("en-IN", {\n                minimumFractionDigits: 2,\n                maximumFractionDigits: 2,\n              }) || "N/A"}\n            </div>\n            <div className="text-sm text-gray-500">Last Traded Price</div>\n          </div>\n          <div className={`text-right ${trendColor}`}>\n            <div className="flex items-center justify-end gap-1">\n              <TrendIcon className="h-4 w-4" />\n              <span className="text-lg font-semibold">\n                {isPositive ? "+" : ""}\n                {niftyData.change?.toFixed(2) || "N/A"}\n              </span>\n            </div>\n            <div className="text-sm">\n              ({isPositive ? "+" : ""}\n              {niftyData.changePercent?.toFixed(2) || "N/A"}%)\n            </div>\n          </div>\n        </div>\n\n        <div className="pt-4 border-t">\n          <div className="text-xs text-gray-500">\n            Last Updated: {new Date(niftyData.lastUpdate).toLocaleTimeString()}\n          </div>\n          <div className="text-xs text-gray-500">Code: {niftyData.code}</div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface HistoricalDataResponse {\n  symbol: string;\n  resolution: string;\n  range_from: string;\n  range_to: string;\n  candles: Array<{\n    timestamp: number;\n    open: number;\n    high: number;\n    low: number;\n    close: number;\n    volume: number;\n  }>;\n}\n\nfunction HistoricalDataSection() {\n  // Set default dates to a few days ago to ensure data availability (avoid weekends/holidays)\n  const defaultDate = new Date();\n  defaultDate.setDate(defaultDate.getDate() - 3); // Go back 3 days to avoid weekend issues\n  const [fromDate, setFromDate] = useState(format(defaultDate, "yyyy-MM-dd"));\n  const [toDate, setToDate] = useState(format(defaultDate, "yyyy-MM-dd"));\n  const [timeframe, setTimeframe] = useState("1");\n  const [selectedSymbol, setSelectedSymbol] = useState("NSE:INFY-EQ");\n  const [sentimentAnalysis, setSentimentAnalysis] = useState<any[]>([]);\n  const [isAnalyzingSentiment, setIsAnalyzingSentiment] = useState(false);\n  const queryClient = useQueryClient();\n\n  const { data: historicalData } = useQuery<HistoricalDataResponse>({\n    queryKey: [\n      "/api/historical-data",\n      selectedSymbol,\n      fromDate,\n      toDate,\n      timeframe,\n    ],\n    enabled: true, // Enable automatic fetching\n  });\n\n  const fetchHistoricalData = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(getFullApiUrl("/api/historical-data"), {\n        method: "POST",\n        headers: {\n          "Content-Type": "application/json",\n        },\n        body: JSON.stringify({\n          symbol: selectedSymbol,\n          resolution: timeframe,\n          range_from: fromDate,\n          range_to: toDate,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || "Failed to fetch historical data");\n      }\n\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.setQueryData(\n        ["/api/historical-data", selectedSymbol, fromDate, toDate, timeframe],\n        data,\n      );\n    },\n  });\n\n  const handleFetchData = () => {\n    fetchHistoricalData.mutate();\n  };\n\n  const analyzeSentiment = async (candles: any[], symbol: string) => {\n    if (!candles || candles.length === 0) return;\n\n    setIsAnalyzingSentiment(true);\n    try {\n      const response = await fetch(getFullApiUrl("/api/sentiment-analysis"), {\n        method: "POST",\n        headers: {\n          "Content-Type": "application/json",\n        },\n        body: JSON.stringify({\n          candles,\n          symbol,\n        }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        setSentimentAnalysis(data.sentiment || []);\n      } else {\n        console.error("Failed to analyze sentiment");\n        setSentimentAnalysis([]);\n      }\n    } catch (error) {\n      console.error("Sentiment analysis error:", error);\n      setSentimentAnalysis([]);\n    } finally {\n      setIsAnalyzingSentiment(false);\n    }\n  };\n\n  // Auto-analyze sentiment when historical data changes\n  React.useEffect(() => {\n    if (historicalData?.candles && historicalData.candles.length > 0) {\n      analyzeSentiment(historicalData.candles, selectedSymbol);\n    }\n  }, [historicalData, selectedSymbol]);\n\n  const handleExportToExcel = () => {\n    if (\n      !historicalData ||\n      !historicalData.candles ||\n      historicalData.candles.length === 0\n    ) {\n      return;\n    }\n\n    // Prepare CSV content with sentiment data\n    const headers = [\n      "Date",\n      "Time",\n      "Open",\n      "High",\n      "Low",\n      "Close",\n      "Volume",\n      "Sentiment_Signal",\n      "Sentiment_Score",\n      "Confidence",\n    ];\n    const csvContent = [\n      headers.join(","),\n      ...historicalData.candles.map((candle, index) => {\n        const date = new Date(candle.timestamp * 1000);\n        const dateStr = format(date, "d/M/yyyy");\n        const timeStr = format(date, "HH:mm:ss");\n        const sentiment = sentimentAnalysis[index];\n        return [\n          dateStr,\n          timeStr,\n          candle.open.toFixed(2),\n          candle.high.toFixed(2),\n          candle.low.toFixed(2),\n          candle.close.toFixed(2),\n          candle.volume.toString(),\n          sentiment?.signal || "N/A",\n          sentiment?.score?.toFixed(2) || "N/A",\n          sentiment?.confidence?.toFixed(0) || "N/A",\n        ].join(",");\n      }),\n    ].join("\n");\n\n    // Create and download file\n    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });\n    const link = document.createElement("a");\n    const url = URL.createObjectURL(blob);\n    link.setAttribute("href", url);\n\n    // Generate filename with symbol, timeframe, and date range\n    const symbolName = (selectedSymbol || "UNKNOWN")\n      .replace("NSE:", "")\n      .replace("-EQ", "")\n      .replace("-INDEX", "");\n    const timeframeName = timeframe === "1" ? "1min" : `${timeframe}min`;\n    const dateRange =\n      fromDate === toDate ? fromDate : `${fromDate}_to_${toDate}`;\n    const filename = `${symbolName}_${timeframeName}_${dateRange}_OHLC.csv`;\n\n    link.setAttribute("download", filename);\n    link.style.visibility = "hidden";\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className="flex items-center gap-2">\n          <BarChart3 className="h-5 w-5" />\n          Historical OHLC Data\n        </CardTitle>\n        <CardDescription>\n          Custom date range, symbol, and timeframe selection with real-time\n          Fyers API data\n        </CardDescription>\n      </CardHeader>\n      <CardContent className="space-y-6">\n        {/* Date, Symbol, and Timeframe Selection */}\n        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">\n          <div className="space-y-2">\n            <Label htmlFor="from-date">From Date</Label>\n            <Input\n              id="from-date"\n              type="date"\n              value={fromDate}\n              onChange={(e) => setFromDate(e.target.value)}\n            />\n          </div>\n          <div className="space-y-2">\n            <Label htmlFor="to-date">To Date</Label>\n            <Input\n              id="to-date"\n              type="date"\n              value={toDate}\n              onChange={(e) => setToDate(e.target.value)}\n            />\n          </div>\n          <div className="space-y-2">\n            <Label htmlFor="symbol">Symbol</Label>\n            <Select value={selectedSymbol} onValueChange={setSelectedSymbol}>\n              <SelectTrigger>\n                <SelectValue placeholder="Select symbol" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value="NSE:NIFTY50-INDEX">NIFTY 50</SelectItem>\n                <SelectItem value="NSE:INFY-EQ">INFOSYS</SelectItem>\n                <SelectItem value="NSE:RELIANCE-EQ">RELIANCE</SelectItem>\n                <SelectItem value="NSE:TCS-EQ">TCS</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <div className="space-y-2">\n            <Label htmlFor="timeframe">Timeframe</Label>\n            <Select value={timeframe} onValueChange={setTimeframe}>\n              <SelectTrigger>\n                <SelectValue placeholder="Select timeframe" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value="1">1 Minute</SelectItem>\n                <SelectItem value="5">5 Minutes</SelectItem>\n                <SelectItem value="10">10 Minutes</SelectItem>\n                <SelectItem value="15">15 Minutes</SelectItem>\n                <SelectItem value="20">20 Minutes</SelectItem>\n                <SelectItem value="30">30 Minutes</SelectItem>\n                <SelectItem value="40">40 Minutes</SelectItem>\n                <SelectItem value="60">1 Hour</SelectItem>\n                <SelectItem value="80">80 Minutes</SelectItem>\n                <SelectItem value="120">2 Hours</SelectItem>\n                <SelectItem value="160">160 Minutes</SelectItem>\n                <SelectItem value="240">4 Hours</SelectItem>\n                <SelectItem value="320">320 Minutes</SelectItem>\n                <SelectItem value="480">8 Hours</SelectItem>\n                <SelectItem value="960">16 Hours</SelectItem>\n                <SelectItem value="1D">1 Day</SelectItem>\n                <SelectItem value="2D">2 Days</SelectItem>\n                <SelectItem value="4D">4 Days</SelectItem>\n                <SelectItem value="8D">8 Days</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          <div className="space-y-2">\n            <Label>&nbsp;</Label>\n            <div className="flex gap-1.5">\n              <Button\n                onClick={handleFetchData}\n                disabled={fetchHistoricalData.isPending}\n                className="flex-1"\n              >\n                <Calendar className="h-4 w-4 mr-2" />\n                {fetchHistoricalData.isPending ? "Fetching..." : "Fetch Data"}\n              </Button>\n              <Button\n                onClick={handleExportToExcel}\n                disabled={\n                  !historicalData || historicalData.candles.length === 0\n                }\n                variant="outline"\n                size="default"\n                className="px-3"\n                title="Export OHLC data to Excel"\n              >\n                <Download className="h-4 w-4" />\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Results Display */}\n        {fetchHistoricalData.isError && (\n          <div className="p-4 bg-red-50 border border-red-200 rounded-lg">\n            <div className="flex items-start space-x-3">\n              <div className="bg-red-100 rounded-full p-1">\n                <svg\n                  className="h-5 w-5 text-red-600"\n                  fill="currentColor"\n                  viewBox="0 0 20 20"\n                >\n                  <path\n                    fillRule="evenodd"\n                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"\n                    clipRule="evenodd"\n                  />\n                </svg>\n              </div>\n              <div className="flex-1">\n                <h3 className="text-red-800 font-medium">\n                  Fyers API Temporary Service Issue\n                </h3>\n                <div className="text-red-700 text-sm mt-1 space-y-2">\n                  <p>\n                    <strong>Current Status:</strong> Fyers API is experiencing\n                    intermittent service issues with historical data endpoints.\n                    Live market data continues working perfectly.\n                  </p>\n                  <div className="bg-green-100 p-3 rounded border-l-4 border-green-400">\n                    <p className="font-medium text-green-800">\n                      What's Still Working:\n                    </p>\n                    <ul className="mt-1 space-y-1 text-xs text-green-700">\n                      <li>\n                        • <strong>Live Market Data:</strong> Real-time prices\n                        streaming every 3 seconds (Dashboard tab)\n                      </li>\n                      <li>\n                        • <strong>Chart Tab:</strong> Professional interactive\n                        candlestick chart with zoom controls\n                      </li>\n                      <li>\n                        • <strong>Pattern Analysis:</strong> All 14 Battu API\n                        endpoints for technical analysis\n                      </li>\n                      <li>\n                        • <strong>Previously Successful:</strong> CB Tab fetched\n                        375 candles earlier before API maintenance\n                      </li>\n                    </ul>\n                  </div>\n                  <div className="bg-blue-100 p-3 rounded border-l-4 border-blue-400">\n                    <p className="font-medium text-blue-800">\n                      Alternative Solutions:\n                    </p>\n                    <ul className="mt-1 space-y-1 text-xs text-blue-700">\n                      <li>\n                        • <strong>Use Chart Tab:</strong> Interactive\n                        candlestick chart may have different data endpoints\n                      </li>\n                      <li>\n                        • <strong>Try Later:</strong> API maintenance typically\n                        resolves within 30-60 minutes\n                      </li>\n                      <li>\n                        • <strong>Different Dates:</strong> Try various past\n                        trading days as availability varies\n                      </li>\n                      <li>\n                        • <strong>Monitor Dashboard:</strong> Live streaming\n                        data remains fully functional\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {historicalData && (\n          <div className="space-y-4">\n            <div className="p-3 bg-green-50 border border-green-200 rounded-lg mb-4">\n              <div className="flex items-center space-x-2">\n                <div className="bg-green-100 rounded-full p-1">\n                  <svg\n                    className="h-4 w-4 text-green-600"\n                    fill="currentColor"\n                    viewBox="0 0 20 20"\n                  >\n                    <path\n                      fillRule="evenodd"\n                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"\n                      clipRule="evenodd"\n                    />\n                  </svg>\n                </div>\n                <div className="text-green-800 font-medium">\n                  ✅ Fyers API Successfully Connected & Data Loaded!\n                </div>\n              </div>\n              <div className="text-green-700 text-sm mt-1">\n                Real-time historical OHLC data fetched successfully from Fyers\n                API v3.0.0\n              </div>\n            </div>\n            <div className="flex items-center justify-between">\n              <h3 className="text-lg font-semibold">\n                OHLC Data ({historicalData?.candles?.length || 0} candles) - CB\n                Tab\n              </h3>\n              <div className="text-sm text-gray-500 space-y-1">\n                <div>\n                  {fromDate} to {toDate} | {timeframe} minute timeframe\n                </div>\n                <div className="text-xs">\n                  Total Candles: {historicalData?.candles?.length || 0}\n                </div>\n              </div>\n            </div>\n\n            <div className="max-h-96 overflow-auto border rounded-lg custom-thin-scrollbar">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Date/Time</TableHead>\n                    <TableHead className="text-right">Open</TableHead>\n                    <TableHead className="text-right">High</TableHead>\n                    <TableHead className="text-right">Low</TableHead>\n                    <TableHead className="text-right">Close</TableHead>\n                    <TableHead className="text-right">Volume</TableHead>\n                    <TableHead className="text-center">Sentiment</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {historicalData?.candles?.map((candle, index) => (\n                    <TableRow key={index}>\n                      <TableCell className="font-medium">\n                        {new Date(candle.timestamp * 1000).toLocaleString()}\n                      </TableCell>\n                      <TableCell className="text-right">\n                        {candle.open.toFixed(2)}\n                      </TableCell>\n                      <TableCell className="text-right">\n                        {candle.high.toFixed(2)}\n                      </TableCell>\n                      <TableCell className="text-right">\n                        {candle.low.toFixed(2)}\n                      </TableCell>\n                      <TableCell className="text-right">\n                        {candle.close.toFixed(2)}\n                      </TableCell>\n                      <TableCell className="text-right">\n                        {candle.volume.toLocaleString()}\n                      </TableCell>\n                      <TableCell className="text-center">\n                        {isAnalyzingSentiment &&\n                        index < sentimentAnalysis.length ? (\n                          <div className="flex items-center justify-center space-x-1">\n                            <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"></div>\n                            <span className="text-xs text-gray-500">\n                              Analyzing...\n                            </span>\n                          </div>\n                        ) : sentimentAnalysis[index] ? (\n                          <div className="space-y-1 bg-white dark:bg-gray-900/50 rounded-lg p-3">\n                            <div\n                              className={`text-xs font-semibold px-2 py-1 rounded ${\n                                sentimentAnalysis[index].signal === "BUY"\n                                  ? "bg-green-100 text-green-800"\n                                  : sentimentAnalysis[index].signal === "SELL"\n                                    ? "bg-red-100 text-red-800"\n                                    : "bg-gray-100 text-gray-800"\n                              }`}\n                            >\n                              {sentimentAnalysis[index].signal}\n                            </div>\n                            <div className="text-xs text-gray-600">\n                              {sentimentAnalysis[index].confidence}%\n                            </div>\n                            <div className="w-full bg-gray-200 rounded-full h-1">\n                              <div\n                                className={`h-1 rounded-full ${\n                                  sentimentAnalysis[index].score > 0\n                                    ? "bg-green-500"\n                                    : "bg-red-500"\n                                }`}\n                                style={{\n                                  width: `${\n                                    Math.abs(sentimentAnalysis[index].score) *\n                                    100\n                                  }%`,\n                                }}\n                              ></div>\n                            </div>\n                          </div>\n                        ) : (\n                          <span className="text-xs text-gray-400">-</span>\n                        )}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                  {(!historicalData?.candles ||\n                    historicalData.candles.length === 0) && (\n                    <TableRow>\n                      <TableCell\n                        colSpan={7}\n                        className="text-center text-gray-500"\n                      >\n                        <div className="space-y-2">\n                          <div>No historical data available</div>\n                          <div className="text-sm">\n                            Historical data access may require specific API\n                            permissions or market hours. Use the "Fetch Data"\n                            button above to attempt loading data.\n                          </div>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction MicroAnimationsDemoPage() {\n  const [demoPrice, setDemoPrice] = useState(1552.5);\n  const [prevPrice, setPrevPrice] = useState(1552.5);\n  const [isExecuting, setIsExecuting] = useState(false);\n  const [tradeType, setTradeType] = useState<"buy" | "sell">("buy");\n  const [volume, setVolume] = useState(1000000);\n  const [isLive, setIsLive] = useState(true);\n  const [profitLoss, setProfitLoss] = useState(0);\n  const [showCandleAnimation, setShowCandleAnimation] = useState(false);\n\n  // Demo candle data\n  const demoCandleData = {\n    open: 1580.0,\n    high: 1585.5,\n    low: 1548.2,\n    close: 1552.5,\n  };\n\n  const updatePrice = (direction: "up" | "down") => {\n    setPrevPrice(demoPrice);\n    const change =\n      direction === "up" ? Math.random() * 5 + 1 : -(Math.random() * 5 + 1);\n    setDemoPrice((prev) => Math.max(prev + change, 1500));\n  };\n\n  const simulateTradeExecution = () => {\n    setIsExecuting(true);\n    setTimeout(() => {\n      setIsExecuting(false);\n      const change =\n        tradeType === "buy"\n          ? Math.random() * 10 + 5\n          : -(Math.random() * 10 + 5);\n      setProfitLoss(change);\n    }, 3000);\n  };\n\n  const simulateVolumeSpike = () => {\n    setVolume((prev) => prev * (1.5 + Math.random()));\n    setTimeout(() => setVolume(1000000), 3000);\n  };\n\n  const toggleMarketStatus = () => {\n    setIsLive(!isLive);\n  };\n\n  const triggerCandleAnimation = () => {\n    setShowCandleAnimation(false);\n    setTimeout(() => setShowCandleAnimation(true), 100);\n  };\n\n  return (\n    <div className="max-w-7xl mx-auto space-y-8">\n      <Card>\n        <CardHeader>\n          <CardTitle className="flex items-center gap-2">\n            <Zap className="h-5 w-5" />\n            Micro-Animations for Trading Interface\n          </CardTitle>\n          <CardDescription>\n            Interactive demos showcasing smooth animations for trade execution\n            and market movements\n          </CardDescription>\n        </CardHeader>\n      </Card>\n\n      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">\n        {/* Price Change Animation */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Price Change Animation</CardTitle>\n            <CardDescription>\n              Live price updates with directional indicators\n            </CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="flex items-center justify-center p-6 bg-gray-50 dark:bg-white dark:bg-gray-900 rounded-lg">\n              <PriceChangeAnimation\n                value={demoPrice}\n                previousValue={prevPrice}\n                className="text-lg"\n              />\n            </div>\n            <div className="flex gap-1.5">\n              <Button onClick={() => updatePrice("up")} className="flex-1">\n                <TrendingUp className="h-4 w-4 mr-2" />\n                Price Up\n              </Button>\n              <Button\n                onClick={() => updatePrice("down")}\n                variant="outline"\n                className="flex-1"\n              >\n                <TrendingDown className="h-4 w-4 mr-2" />\n                Price Down\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Trade Execution Animation */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Trade Execution Animation</CardTitle>\n            <CardDescription>\n              Order execution feedback with loading states\n            </CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="space-y-1">\n              <div className="flex gap-1.5">\n                <Button\n                  onClick={() => setTradeType("buy")}\n                  variant={tradeType === "buy" ? "default" : "outline"}\n                  size="sm"\n                >\n                  Buy\n                </Button>\n                <Button\n                  onClick={() => setTradeType("sell")}\n                  variant={tradeType === "sell" ? "default" : "outline"}\n                  size="sm"\n                >\n                  Sell\n                </Button>\n              </div>\n              <Button\n                onClick={simulateTradeExecution}\n                disabled={isExecuting}\n                className="w-full"\n              >\n                {isExecuting ? (\n                  <>\n                    <Activity className="h-4 w-4 mr-2 animate-spin" />\n                    Executing...\n                  </>\n                ) : (\n                  <>\n                    <Play className="h-4 w-4 mr-2" />\n                    Execute {tradeType.toUpperCase()} Order\n                  </>\n                )}\n              </Button>\n            </div>\n            <TradeExecutionAnimation\n              isExecuting={isExecuting}\n              tradeType={tradeType}\n              amount="100"\n              symbol="INFY"\n            />\n          </CardContent>\n        </Card>\n\n        {/* Volume Spike Animation */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Volume Spike Animation</CardTitle>\n            <CardDescription>\n              Animated volume alerts and notifications\n            </CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="flex items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 rounded-lg">\n              <VolumeSpikeAnimation\n                volume={volume}\n                averageVolume={1000000}\n                className="text-sm"\n              />\n            </div>\n            <Button onClick={simulateVolumeSpike} className="w-full">\n              <Zap className="h-4 w-4 mr-2" />\n              Trigger Volume Spike\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Market Status Pulse */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Market Status Animation</CardTitle>\n            <CardDescription>\n              Live market status with pulsing indicators\n            </CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="flex items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 rounded-lg">\n              <MarketStatusPulse isLive={isLive} />\n            </div>\n            <Button onClick={toggleMarketStatus} className="w-full">\n              <RotateCcw className="h-4 w-4 mr-2" />\n              Toggle Market Status\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Profit/Loss Animation */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Profit/Loss Animation</CardTitle>\n            <CardDescription>\n              Animated P&L with color transitions\n            </CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="flex items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 rounded-lg">\n              <ProfitLossAnimation\n                value={profitLoss}\n                showCurrency={true}\n                className="text-lg"\n              />\n            </div>\n            <div className="grid grid-cols-2 gap-2">\n              <Button\n                onClick={() => setProfitLoss(Math.random() * 100 + 10)}\n                size="sm"\n              >\n                <TrendingUp className="h-3 w-3 mr-1" />\n                Profit\n              </Button>\n              <Button\n                onClick={() => setProfitLoss(-(Math.random() * 100 + 10))}\n                variant="outline"\n                size="sm"\n              >\n                <TrendingDown className="h-3 w-3 mr-1" />\n                Loss\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Candlestick Animation */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Candlestick Formation</CardTitle>\n            <CardDescription>Animated candle drawing process</CardDescription>\n          </CardHeader>\n          <CardContent className="space-y-4">\n            <div className="flex items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 rounded-lg">\n              {showCandleAnimation && (\n                <CandlestickAnimation candle={demoCandleData} duration={2000} />\n              )}\n            </div>\n            <Button onClick={triggerCandleAnimation} className="w-full">\n              <BarChart3 className="h-4 w-4 mr-2" />\n              Animate Candle Formation\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Loading Skeleton Demo */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Market Data Loading Animation</CardTitle>\n          <CardDescription>\n            Skeleton loading states for market data\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className="space-y-4">\n            <MarketDataSkeleton />\n            <MarketDataSkeleton />\n            <MarketDataSkeleton />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Integration Examples */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Live Market Data with Animations</CardTitle>\n          <CardDescription>\n            Real INFY data enhanced with micro-animations\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">\n            <div className="space-y-2">\n              <Label>Live Price</Label>\n              <PriceChangeAnimation\n                value={1552.5}\n                previousValue={1574.5}\n                className="p-3 border rounded-lg bg-white dark:bg-gray-700"\n              />\n            </div>\n            <div className="space-y-2">\n              <Label>P&L Today</Label>\n              <ProfitLossAnimation\n                value={-22.0}\n                showCurrency={true}\n                className="p-3 border rounded-lg bg-white dark:bg-gray-700"\n              />\n            </div>\n            <div className="space-y-2">\n              <Label>Market Status</Label>\n              {isReportLoading && (\n                                                  <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 rounded-lg">\n                                                    <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg p-8 border border-gray-700 shadow-2xl max-w-md">\n                                                      <div className="text-center">\n                                                        <style>{`\n                                                          @keyframes thinkingDot {\n                                                            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }\n                                                            30% { opacity: 1; transform: translateY(-8px); }\n                                                          }\n                                                          .thinking-dot {\n                                                            display: inline-block;\n                                                            width: 10px;\n                                                            height: 10px;\n                                                            border-radius: 50%;\n                                                            background-color: #3b82f6;\n                                                            animation: thinkingDot 1.4s infinite;\n                                                            margin: 0 4px;\n                                                          }\n                                                          .thinking-dot:nth-child(2) { animation-delay: 0.2s; }\n                                                          .thinking-dot:nth-child(3) { animation-delay: 0.4s; }\n                                                        `}</style>\n                                                        <h3 className="text-lg font-semibold text-white mb-4">Generating Financial Report</h3>\n                                                        <div className="flex items-center justify-center gap-2 mb-3">\n                                                          <div className="thinking-dot"></div>\n                                                          <div className="thinking-dot"></div>\n                                                          <div className="thinking-dot"></div>\n                                                        </div>\n                                                        <p className="text-sm text-gray-400">Analyzing quarterly data, company insights, and financial statements...</p>\n                                                      </div>\n                                                    </div>\n                                                  </div>\n                                                )}\n                                                <div className="p-3 border rounded-lg bg-white dark:bg-gray-700">\n                <MarketStatusPulse isLive={false} />\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n// API base URL for Cloud Run compatibility - use environment variable\n// BUT: In development mode (localhost), always use relative URLs to avoid CORS issues\nconst isDevelopmentMode = window.location.hostname === 'localhost' || \n                          window.location.hostname === '127.0.0.1' ||\n                          window.location.hostname.includes('replit.dev') ||\n                          window.location.port === '5000';\n\nconst API_BASE_URL = isDevelopmentMode ? '' : (import.meta.env.VITE_API_URL || '');\n\n// Helper function to construct full API URLs for Cloud Run compatibility\nconst getFullApiUrl = (path: string): string => {\n  if (path.startsWith('http')) return path;\n  return `${API_BASE_URL}${path}`;\n};\n\nexport default function Home() {\n  const [activeVoiceProfileId, setActiveVoiceProfileId] = useState<string>(() => { if (typeof window !== 'undefined') { return localStorage.getItem('activeVoiceProfileId') || 'ravi'; } return 'ravi'; });\n\n  useEffect(() => { localStorage.setItem('activeVoiceProfileId', activeVoiceProfileId); }, [activeVoiceProfileId]);\n  const [location, setLocation] = useLocation();\n\n  // 🔶 Detect Angel One OAuth callback from redirect\n  React.useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.has("angelone_connected")) {\n      console.log("✅ Angel One connected successfully (redirect callback)");\n      setAngelOneIsConnected(true);\n      setAngelOneAccessToken(params.get("angelone_client_code") || "P176266");\n      localStorage.setItem("angel_one_client_code", params.get("angelone_client_code") || "P176266");\n      toast({ title: "Success", description: "Angel One connected successfully" });\n      window.history.replaceState({}, document.title, window.location.pathname);\n    }\n    if (params.has("angelone_error")) {\n      const error = decodeURIComponent(params.get("angelone_error") || "");\n      console.error("❌ Angel One auth error:", error);\n      toast({ variant: "destructive", title: "Error", description: error });\n      window.history.replaceState({}, document.title, window.location.pathname);\n    }\n  }, []);\n  // AUTO-CONNECT: Angel One API - Automatically connect when app loads\n  useAngelOneAutoconnect();\n  const { theme, toggleTheme } = useTheme();\n  const [activeTab, setActiveTab] = useState("trading-home");\n  const [showTutorOverlay, setShowTutorOverlay] = useState(false);\n  const [swipeStartY, setSwipeStartY] = useState(0);\n  const [swipeCurrentY, setSwipeCurrentY] = useState(0);\n  const [isSwipingUp, setIsSwipingUp] = useState(false);\n  const [showJournalAI, setShowJournalAI] = useState(false);\n  const [journalAIData, setJournalAIData] = useState<any>(null);\n  const [statisticsTab, setStatisticsTab] = useState("overview");\n  // Shared timeframe state for chart and crossings display\n  const [chartTimeframe, setChartTimeframe] = useState<string>("1");\n  const [isEditingUsername, setIsEditingUsername] = useState(false);\n  const [isEditingDisplayName, setIsEditingDisplayName] = useState(false);\n  const [newDisplayName, setNewDisplayName] = useState("");\n  const [isEditingDob, setIsEditingDob] = useState(false);\n  const [newDob, setNewDob] = useState("");\n  const [isEditingLocation, setIsEditingLocation] = useState(false);\n  const [newLocation, setNewLocation] = useState("");\n  const [newUsername, setNewUsername] = useState("");\n  const [isUsernameAvailable, setIsUsernameAvailable] = useState<boolean | null>(null);\n  const [isCheckingUsername, setIsCheckingUsername] = useState(false);\n  // Navigation menu state\n  const [isNavOpen, setIsNavOpen] = useState(false);\n  const [isProfileActive, setIsProfileActive] = useState(false);\n  const [isVoiceActive, setIsVoiceActive] = useState(false);\n\n  const handleUpdateProfile = async (updates: any) => {\n    try {\n      const token = await getCognitoToken();\n      const response = await fetch("/api/user/profile", {\n        method: "PATCH",\n        headers: {\n          "Content-Type": "application/json",\n          "Authorization": `Bearer ${token}`\n        },\n        body: JSON.stringify(updates),\n      });\n      if (response.ok) {\n        toast({ description: "Profile updated successfully" });\n        window.location.reload();\n      } else {\n        throw new Error("Failed to update profile");\n      }\n    } catch (error) {\n      console.error("Profile update error:", error);\n      toast({ description: "Error updating profile", variant: "destructive" });\n    }\n  };\n\n  // Mobile bottom navigation state (home, insight, ranking, paper-trade)\n  const [mobileBottomTab, setMobileBottomTab] = useState<\n    "home" | "insight" | "ranking" | "paper-trade"\n  >("home");\n  // Settings panel state\n  const [showSettingsPanel, setShowSettingsPanel] = useState(false);\n  const [emailVerified, setEmailVerified] = useState<boolean | null>(null);\n  const [verificationOtp, setVerificationOtp] = useState("");\n  const [verificationSending, setVerificationSending] = useState(false);\n  const [verificationConfirming, setVerificationConfirming] = useState(false);\n  const [verificationCodeSent, setVerificationCodeSent] = useState(false);\n  const [verificationError, setVerificationError] = useState("");\n\n  // Clear old localStorage data - using AWS only now\n  useEffect(() => {\n    localStorage.removeItem("tradingDataByDate");\n    console.log("🧹 Cleared old localStorage tradingDataByDate - using AWS only");\n  }, []);\n\n  // Auth state initialization - wait for AWS to sync\n  const [authInitialized, setAuthInitialized] = useState(false);\n  // View-only mode for unauthenticated users - they can view but not interact with protected features\n  const [isViewOnlyMode, setIsViewOnlyMode] = useState(false);\n  const [selectedAudioTrack, setSelectedAudioTrack] = useState<{title: string, duration: string, id: string, youtubeId: string} | null>({ title: 'Bruce Lee: "Your Greatest Enemy Is Within"', duration: "22:30", id: "p1", youtubeId: "KnppzfiZcgM" });\n  const [audioProgress, setAudioProgress] = useState(0);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [duration, setDuration] = useState(0);\n  const [isAudioPlaying, setIsAudioPlaying] = useState(false);\n  const youtubePlayerRef = useRef<any>(null);\n\n  useEffect(() => {\n    const tag = document.createElement("script");\n    tag.src = "https://www.youtube.com/iframe_api";\n    const firstScriptTag = document.getElementsByTagName("script")[0];\n    firstScriptTag.parentNode?.insertBefore(tag, firstScriptTag);\n\n    (window as any).onYouTubeIframeAPIReady = () => {\n      console.log("📺 YouTube IFrame API Ready");\n    };\n  }, []);\n\n  useEffect(() => {\n    if (selectedAudioTrack?.youtubeId) {\n      if (youtubePlayerRef.current) {\n        youtubePlayerRef.current.destroy();\n      }\n\n      const playerContainer = document.getElementById("youtube-audio-player");\n      if (playerContainer) {\n        youtubePlayerRef.current = new (window as any).YT.Player("youtube-audio-player", {\n          height: "0",\n          width: "0",\n          videoId: selectedAudioTrack.youtubeId,\n          playerVars: {\n            autoplay: 1,\n            controls: 0,\n            showinfo: 0,\n            modestbranding: 1,\n            loop: 1,\n            fs: 0,\n            cc_load_policy: 0,\n            iv_load_policy: 3,\n            autohide: 0\n          },\n          events: {\n            onReady: (event: any) => {\n              setDuration(event.target.getDuration());\n              const interval = setInterval(() => {\n                if (youtubePlayerRef.current && youtubePlayerRef.current.getCurrentTime) {\n                  const time = youtubePlayerRef.current.getCurrentTime();\n                  setCurrentTime(time);\n                  if (youtubePlayerRef.current.getDuration) {\n                    const dur = youtubePlayerRef.current.getDuration();\n                    setDuration(dur);\n                    setAudioProgress((time / dur) * 100);\n                  }\n                }\n              }, 1000);\n              console.log("🎵 YouTube Audio Ready");\n              event.target.playVideo();\n              setIsAudioPlaying(true);\n            },\n            onStateChange: (event: any) => {\n              if (event.data === (window as any).YT.PlayerState.ENDED) {\n                event.target.playVideo();\n              }\n            }\n          }\n        });\n      }\n    }\n  }, [selectedAudioTrack]);\n\n  useEffect(() => {\n    if (youtubePlayerRef.current) {\n      if (isAudioPlaying) {\n        youtubePlayerRef.current.playVideo();\n      } else {\n        youtubePlayerRef.current.pauseVideo();\n      }\n    }\n  }, [isAudioPlaying]);\n\n  // Get current user data from AWS DynamoDB\n  const { currentUser } = useCurrentUser();\n\n  // Initialize AWS auth sync with localStorage - NO AUTOMATIC REDIRECT\n  // Users can view the home screen, redirect only happens when they try to interact with protected content\n  useEffect(() => {\n    const userId = localStorage.getItem('currentUserId');\n    const userEmail = localStorage.getItem('currentUserEmail');\n\n    if (userId && userEmail && userId !== 'null' && userEmail !== 'null') {\n      console.log('✅ Auth initialized from localStorage:', { userId, userEmail });\n      setAuthInitialized(true);\n      setIsViewOnlyMode(false);\n    } else {\n      // Wait for AWS auth state with timeout - but DON'T redirect, just enable view-only mode\n      const timer = setTimeout(() => {\n        const finalUserId = localStorage.getItem('currentUserId');\n        const finalUserEmail = localStorage.getItem('currentUserEmail');\n\n        if (!finalUserId || !finalUserEmail || finalUserId === 'null' || finalUserEmail === 'null') {\n          console.log('🎯 No auth found - enabling view-only mode (no redirect)');\n          setIsViewOnlyMode(true);\n          setAuthInitialized(true); // Mark as initialized so UI renders\n        } else {\n          console.log('✅ Auth initialized after delay:', { finalUserId, finalUserEmail });\n          setAuthInitialized(true);\n          setIsViewOnlyMode(false);\n        }\n      }, 500); // Use AWS Cognito for authentication sync\n\n      return () => clearTimeout(timer);\n    }\n  }, []);\n\n  // AI Search state\n\n  // Check email verification status when settings panel opens\n  useEffect(() => {\n    if (showSettingsPanel && currentUser) {\n      checkEmailVerified().then((verified) => {\n        setEmailVerified(verified);\n      }).catch(() => {\n        setEmailVerified(false);\n      });\n    }\n  }, [showSettingsPanel, currentUser]);\n\n  // Handle sending verification OTP\n  const handleSendVerificationOtp = async () => {\n    setVerificationSending(true);\n    setVerificationError("");\n    try {\n      await sendEmailVerificationCode();\n      setVerificationCodeSent(true);\n    } catch (error: any) {\n      setVerificationError(error?.message || "Failed to send verification code");\n    } finally {\n      setVerificationSending(false);\n    }\n  };\n\n  // Handle confirming email verification\n  const handleConfirmVerification = async () => {\n    if (!verificationOtp || verificationOtp.length !== 6) {\n      setVerificationError("Please enter a valid 6-digit code");\n      return;\n    }\n    setVerificationConfirming(true);\n    setVerificationError("");\n    try {\n      await confirmEmailVerification(verificationOtp);\n      setEmailVerified(true);\n      setVerificationCodeSent(false);\n      setVerificationOtp("");\n    } catch (error: any) {\n      if (error?.name === "CodeMismatchException") {\n        setVerificationError("Invalid verification code. Please try again.");\n      } else if (error?.name === "ExpiredCodeException") {\n        setVerificationError("Code expired. Please request a new one.");\n      } else {\n        setVerificationError(error?.message || "Verification failed");\n      }\n    } finally {\n      setVerificationConfirming(false);\n    }\n  };\n  const [searchQuery, setSearchQuery] = useState("");\n  const [isSearchActive, setIsSearchActive] = useState(false);\n  const [searchResults, setSearchResults] = useState("");\n  const [isSearchLoading, setIsSearchLoading] = useState(false);\n  const [isReportLoading, setIsReportLoading] = useState(false);\n  const [isWatchlistLoading, setIsWatchlistLoading] = useState(false);\n  const [searchResultsNews, setSearchResultsNews] = useState<any[]>([]);\n  const [searchResultsNewsSymbol, setSearchResultsNewsSymbol] = useState("");\n  const [aiChartSelectedTimeframe, setAiChartSelectedTimeframe] = useState('1Y');\n\n  // Listen for timeframe change events to trigger re-render\n  useEffect(() => {\n    const handleTimeframeChange = () => {\n      const newTimeframe = (window as any).aiAssistantSelectedTimeframe || '1Y';\n      setAiChartSelectedTimeframe(newTimeframe);\n    };\n\n    window.addEventListener('timeframeChange', handleTimeframeChange);\n    return () => window.removeEventListener('timeframeChange', handleTimeframeChange);\n  }, []);\n\n  // Fetch news for search results when symbol changes (use same source as chart: window.companyInsightsData)\n  useEffect(() => {\n    if (!searchResults || !isSearchActive) return;\n\n    // Get symbol from the same source the chart uses\n    const companyInsights = (window as any).companyInsightsData;\n    const stockData = (window as any).aiAssistantStockData;\n\n    // Extract symbol: prefer companyInsightsData.symbol, fallback to aiAssistantStockData.name\n    let currentSymbol = companyInsights?.symbol || '';\n    if (!currentSymbol && stockData?.name) {\n      // Extract symbol from stock name (format: "RELIANCE\nReliance Industries")\n      currentSymbol = stockData.name.split('\n')[0]?.trim() || '';\n    }\n\n    if (!currentSymbol || currentSymbol === searchResultsNewsSymbol) return;\n\n    console.log('📰 Fetching news for search results symbol:', currentSymbol);\n    setSearchResultsNewsSymbol(currentSymbol);\n    setSearchResultsNews([]);\n\n    (async () => {\n      try {\n        const response = await fetch(`/api/stock-news/${encodeURIComponent(currentSymbol.toUpperCase())}?refresh=${Date.now()}`);\n        const data = await response.json();\n\n        const articles = Array.isArray(data) ? data : (data.articles || data.data || []);\n\n        if (articles && articles.length > 0) {\n          const getRelativeTime = (dateString: string) => {\n            try {\n              const date = new Date(dateString);\n              const now = new Date();\n              const diffMs = now.getTime() - date.getTime();\n              const diffSecs = Math.floor(diffMs / 1000);\n              const diffMins = Math.floor(diffSecs / 60);\n              const diffHours = Math.floor(diffMins / 60);\n              const diffDays = Math.floor(diffHours / 24);\n              const diffWeeks = Math.floor(diffDays / 7);\n\n              if (diffSecs < 60) return 'Just now';\n              if (diffMins < 60) return `${diffMins}m ago`;\n              if (diffHours < 24) return `${diffHours}h ago`;\n              if (diffDays < 7) return `${diffDays}d ago`;\n              if (diffWeeks < 4) return `${diffWeeks}w ago`;\n              return 'Recently';\n            } catch (error) {\n              return 'Recently';\n            }\n          };\n\n          const formattedNews = articles.map((article: any) => ({\n            title: article.title,\n            source: article.source || "Market News",\n            time: getRelativeTime(article.publishedAt || article.date || new Date().toISOString()),\n            url: article.url || article.link || '#'\n          }));\n\n          console.log('📰 News fetched successfully:', formattedNews.length, 'articles');\n          setSearchResultsNews(formattedNews);\n        } else {\n          console.log('📰 No news articles found for:', currentSymbol);\n        }\n      } catch (error) {\n        console.warn("Failed to fetch news for symbol:", currentSymbol, error);\n      }\n    })();\n  }, [searchResults, isSearchActive]);\n\n  // ❌ REMOVED: journalSelectedDate - manual search chart is now completely standalone\n\n  // Trending podcasts state\n  const [selectedSector, setSelectedSector] = useState<string>("FINANCE");\n  const [trendingPodcasts, setTrendingPodcasts] = useState<any[]>([]);\n  const [isPodcastsLoading, setIsPodcastsLoading] = useState(false);\n  const [selectedPodcast, setSelectedPodcast] = useState<any>(null);\n  const [currentCardIndex, setCurrentCardIndex] = useState<number>(0);\n\n  // Animated greeting stocks state\n  const [currentStockIndex, setCurrentStockIndex] = useState(0);\n  const [showingInitialGreeting, setShowingInitialGreeting] = useState(true);\n  const animatedStocks = [\n    { symbol: "NIFTY", price: "59273.80", change: +1.24, isProfit: true },\n    { symbol: "BANKNIFTY", price: "52841.35", change: +0.87, isProfit: true },\n    { symbol: "SENSEX", price: "85138.27", change: -0.45, isProfit: false },\n    { symbol: "Top Gainers", price: "TCS +2.1%", change: +2.1, isProfit: true },\n    { symbol: "Top Losers", price: "SUNPHARMA -1.8%", change: -1.8, isProfit: false },\n  ];\n\n  // Passcode protection state\n  const [showPasscodeModal, setShowPasscodeModal] = useState(false);\n  const [passcodeInput, setPasscodeInput] = useState("");\n  const [authenticatedTabs, setAuthenticatedTabs] = useState<Set<string>>(\n    new Set(),\n  );\n  const [pendingTab, setPendingTab] = useState<string>("");\n  const [showSavedFormatsDropdown, setShowSavedFormatsDropdown] = useState(false);\n\n  // Show initial greeting for 2 seconds, then switch to animated stocks\n  useEffect(() => {\n    if (!isViewOnlyMode) {\n      const initialTimer = setTimeout(() => {\n        setShowingInitialGreeting(false);\n      }, 2000);\n      return () => clearTimeout(initialTimer);\n    }\n  }, [isViewOnlyMode]);\n\n  // Auto-rotate stock display every 3 seconds (only after initial greeting)\n  useEffect(() => {\n    if (!isViewOnlyMode && !showingInitialGreeting) {\n      const interval = setInterval(() => {\n        setCurrentStockIndex(prev => (prev + 1) % animatedStocks.length);\n      }, 3000);\n      return () => clearInterval(interval);\n    }\n  }, [animatedStocks.length, isViewOnlyMode, showingInitialGreeting]);\n\n  // Expose toggle nav function to window for profile icon in right sidebar\n  useEffect(() => {\n    window.toggleNav = () => {\n      setIsNavOpen(prev => !prev);\n    };\n    return () => {\n      delete window.toggleNav;\n    };\n  }, []);\n\n  // Passcode verification functions\n  const protectedTabs = [\n    "trading-home",\n    "dashboard",\n    "backtest",\n  ]; // Protected tabs\n\n  const handleTabClick = (tabName: string) => {\n    if (protectedTabs.includes(tabName) && !authenticatedTabs.has(tabName)) {\n      setPendingTab(tabName);\n      setShowPasscodeModal(true);\n    } else {\n      setTabWithAuthCheck(tabName);\n    }\n  };\n\n  const handlePasscodeSubmit = () => {\n    if (passcodeInput === "1302") {\n      const newAuthenticatedTabs = new Set(authenticatedTabs);\n      newAuthenticatedTabs.add(pendingTab);\n      setAuthenticatedTabs(newAuthenticatedTabs);\n      setTabWithAuthCheck(pendingTab);\n      setShowPasscodeModal(false);\n      setPasscodeInput("");\n      setPendingTab("");\n    } else {\n      // Reset on wrong passcode\n      setPasscodeInput("");\n    }\n  };\n\n  const handlePasscodeCancel = () => {\n    setShowPasscodeModal(false);\n    setPasscodeInput("");\n    setPendingTab("");\n  };\n\n  // Trading Master Coming Soon Modal State\n  const [showTradingMasterComingSoon, setShowTradingMasterComingSoon] = useState(false);\n  const { toast } = useToast();\n\n  // Share tradebook modal state\n  const [showShareDialog, setShowShareDialog] = useState(false);\n  const [shareableUrl, setShareableUrl] = useState<string | null>(null);\n  const [isCreatingShareableLink, setIsCreatingShareableLink] = useState(false);\n  const [isSharedReportMode, setIsSharedReportMode] = useState(false);\n  const [sharedReportData, setSharedReportData] = useState<any>(null);\n\n  // Handle shared report from URL query parameter\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const sharedReportId = params.get('sharedReport');\n\n    if (sharedReportId) {\n      // Open dialog immediately to show loading state\n      setIsSharedReportMode(true);\n      setShowShareDialog(true);\n\n      // Fetch the shared report in background\n      fetch(`/api/verified-reports/${sharedReportId}`)\n        .then(res => res.json())\n        .then(data => {\n          if (data.success && data.report) {\n            setSharedReportData(data.report);\n            setShareableUrl(data.report.shareUrl);\n          } else {\n            // Close dialog if report not found\n            setShowShareDialog(false);\n            setIsSharedReportMode(false);\n          }\n        })\n        .catch(err => {\n          console.error('Failed to load shared report:', err);\n          setShowShareDialog(false);\n          setIsSharedReportMode(false);\n        });\n    }\n  }, []);\n\n  // Handle share dialog close in shared report mode\n  const handleShareDialogClose = () => {\n    setShowShareDialog(false);\n\n    if (isSharedReportMode) {\n      // Clean up query parameter and reset shared mode\n      window.history.replaceState({}, '', '/');\n      setIsSharedReportMode(false);\n      setSharedReportData(null);\n      setShareableUrl(null);\n    }\n  };\n\n  // Centralized authentication check helper - ALL tab switches MUST use this\n  const setTabWithAuthCheck = (tabName: string) => {\n    const userId = localStorage.getItem('currentUserId');\n    const userEmail = localStorage.getItem('currentUserEmail');\n\n    // Robust check for Cloud Run compatibility\n    if (!userId || !userEmail || userId === 'null' || userEmail === 'null') {\n      console.log('[AUTH] Authentication required for tab:', tabName, '- redirecting to login');\n      setLocation('/login');\n      return false;\n    }\n\n    console.log('[AUTH] User authenticated, setting tab:', tabName);\n    setActiveTab(tabName);\n    return true;\n  };\n\n  // Check if user is logged in, redirect to login if not\n  const checkAuthAndNavigate = (tabName: string) => {\n    return setTabWithAuthCheck(tabName);\n  };\n\n  // Handle Trading Master access - only for chiranjeevi.perala99@gmail.com\n  const handleTradingMasterAccess = () => {\n    const userId = localStorage.getItem('currentUserId');\n    const userEmail = localStorage.getItem('currentUserEmail');\n\n    // Robust check for Cloud Run compatibility\n    if (!userId || !userEmail || userId === 'null' || userEmail === 'null') {\n      console.log('[AUTH] Authentication required for Trading Master - redirecting to login');\n      setLocation('/login');\n      return;\n    }\n\n    console.log('[AUTH] User authenticated for Trading Master check - email:', userEmail);\n    // Check if user is authorized for Trading Master\n    if (userEmail === 'chiranjeevi.perala99@gmail.com') {\n      // Authorized user - navigate to trading-master tab\n      setActiveTab('trading-master');\n    } else {\n      // Unauthorized user - show coming soon modal\n      setShowTradingMasterComingSoon(true);\n    }\n  };\n\n  // Create shareable trading report\n  const handleCreateShareableLink = async () => {\n    try {\n      setIsCreatingShareableLink(true);\n\n      // Gather trading data from the calendar\n      const filteredData = getFilteredHeatmapData();\n      const dates = Object.keys(filteredData).sort();\n\n      // Calculate comprehensive stats\n      let totalPnL = 0;\n      let totalTrades = 0;\n      let winningTrades = 0;\n      let fomoCount = 0;\n      const streaks: number[] = [];\n      let currentStreak = 0;\n\n      dates.forEach(dateKey => {\n        const dayData = filteredData[dateKey];\n        const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n        const tags = dayData?.tradingData?.tradingTags || dayData?.tradingTags || [];\n\n        if (metrics) {\n          const netPnL = metrics.netPnL || 0;\n          totalPnL += netPnL;\n          totalTrades += metrics.totalTrades || 0;\n          winningTrades += metrics.winningTrades || 0;\n\n          // Track FOMO tags\n          if (Array.isArray(tags) && tags.some((tag: string) => tag.toLowerCase() === 'fomo')) {\n            fomoCount++;\n          }\n\n          // Track win streaks\n          if (netPnL > 0) {\n            currentStreak++;\n          } else if (netPnL < 0 && currentStreak > 0) {\n            streaks.push(currentStreak);\n            currentStreak = 0;\n          }\n        }\n      });\n\n      // Final streak\n      if (currentStreak > 0) {\n        streaks.push(currentStreak);\n      }\n\n      const maxStreak = streaks.length > 0 ? Math.max(...streaks) : 0;\n      const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;\n\n      // Create verified report\n      const response = await fetch('/api/verified-reports', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          userId: currentUser?.userId || 'demo',\n          username: currentUser?.displayName || currentUser?.email || 'Demo User',\n          reportData: {\n            tradingDataByDate: filteredData,\n            totalPnL,\n            totalTrades,\n            winRate: Number(winRate.toFixed(2)),\n            fomoCount,\n            maxStreak,\n            userId: currentUser?.userId || 'demo',\n            username: currentUser?.displayName || currentUser?.email || 'Demo User',\n            tagline: 'rethink & reinvest',\n          }\n        })\n      });\n\n      const result = await response.json();\n\n      if (result.success && result.report) {\n        setShareableUrl(result.report.shareUrl);\n        toast({\n          title: "Shareable link created!",\n          description: "Your trading report is ready to share. Link expires in 7 days.",\n        });\n      } else {\n        throw new Error(result.error || 'Failed to create shareable link');\n      }\n    } catch (error) {\n      console.error('[SHARE] Error creating shareable link:', error);\n      toast({\n        title: "Error",\n        description: "Failed to create shareable link. Please try again.",\n        variant: "destructive",\n      });\n    } finally {\n      setIsCreatingShareableLink(false);\n    }\n  };\n\n  // AI Finance Assistant Logic - Real data fetching and analysis\n  const fetchRealStockData = async (\n    symbol: string,\n  ): Promise<StockData | null> => {\n    try {\n      console.log(`🤖 AI Search fetching real data for ${symbol}...`);\n      const response = await fetch(`/api/stock-analysis/${symbol}`);\n      const data = await response.json();\n\n      if (data && data.priceData) {\n        console.log(\n          `✅ AI Search got real data for ${symbol}:`,\n          data.priceData,\n        );\n        return {\n          symbol: symbol,\n          price: data.priceData.close || data.priceData.price || 0,\n          change: (data.priceData.close || 0) - (data.priceData.open || 0),\n          changePercent: data.sentiment?.score\n            ? ((data.priceData.close - data.priceData.open) /\n                data.priceData.open) *\n              100\n            : 0,\n          volume: data.priceData.volume || "N/A",\n          marketCap: data.valuation?.marketCap || "N/A",\n          pe: data.valuation?.peRatio || 0,\n          high: data.priceData.high || 0,\n          low: data.priceData.low || 0,\n          open: data.priceData.open || 0,\n          sentiment: data.sentiment || null,\n          indicators: data.indicators || null,\n        };\n      }\n      return null;\n    } catch (error) {\n      console.error(`❌ AI Search failed to fetch data for ${symbol}:`, error);\n      return null;\n    }\n  };\n\n  // Optimized unified search with caching and performance improvements\n  const handleSearch = async (queryOverride?: string) => {\n    let query = queryOverride || searchQuery;\n    if (!query.trim()) return;\n\n    // Convert stock symbol format (RELIANCE-EQ) to human language (reliance)\n    if (query.includes('-') && query.toUpperCase() === query) {\n      const symbolPart = query.split('-')[0]; // Extract "RELIANCE" from "RELIANCE-EQ"\n      query = symbolPart.toLowerCase(); // Convert to "reliance"\n      console.log(`✅ [SYMBOL-DETECTED] Converted ${queryOverride} to human language: ${query}`);\n    }\n\n    // Check authentication before allowing search\n    const userId = localStorage.getItem('currentUserId');\n    const userEmail = localStorage.getItem('currentUserEmail');\n\n    if (!userId || !userEmail || userId === 'null' || userEmail === 'null') {\n      console.log('[AUTH] Authentication required for search - redirecting to login');\n      setLocation('/login');\n      return;\n    }\n\n    // Prevent concurrent searches\n    if (isSearchLoading) return;\n\n    setIsSearchLoading(true);\n\n    try {\n      const message = query.toLowerCase();\n      const stockSymbols = [\n        "reliance",\n        "tcs",\n        "infy",\n        "infosys",\n        "hdfcbank",\n        "icicibank",\n        "bhartiartl",\n        "itc",\n        "nifty",\n        "banknifty",\n        "sbin",\n        "adaniports",\n        "asianpaint",\n        "bajfinance",\n        "wipro",\n        "techm",\n      ];\n      const mentionedStock = stockSymbols.find((stock) =>\n        message.includes(stock),\n      );\n\n      // USE TRADING AI AGENT FOR ALL QUERIES - Like Replit Agent for Trading\n      // This agent uses tool calling to intelligently gather data from multiple sources\n      console.log(\n        "🤖 [TRADING-AGENT] Triggering AI Trading Agent (Tool Calling Enabled)...",\n      );\n\n      try {\n        // Call the new Trading AI Agent endpoint\n        const response = await fetch(getFullApiUrl("/api/trading-agent"), {\n          method: "POST",\n          headers: {\n            "Content-Type": "application/json",\n          },\n          body: JSON.stringify({\n            query: query,\n            context: {\n              userId: currentUser?.userId || localStorage.getItem('currentUserId'),\n            },\n          }),\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n\n          if (data.success && data.message) {\n            let result = data.message;\n\n            // Store chart data for rendering if available\n            if (data.charts && data.charts.length > 0) {\n              (window as any).tradingAgentCharts = data.charts;\n              console.log("📊 [TRADING-AGENT] Received chart data:", data.charts.length, "charts");\n            }\n\n            // Store stock insights for rendering\n            if (data.stocks && data.stocks.length > 0) {\n              (window as any).tradingAgentStocks = data.stocks;\n              console.log("📈 [TRADING-AGENT] Received stock insights:", data.stocks.length, "stocks");\n            }\n\n            // Store company insights data on window for chart rendering\n            if (data.companyInsights) {\n              (window as any).companyInsightsData = data.companyInsights;\n              console.log("✅ [TRADING-AGENT] Received company insights:", data.companyInsights.symbol, data.companyInsights.trend);\n\n              // Store stock data for chart display\n              (window as any).aiAssistantStockData = {\n                name: data.companyInsights.name || data.companyInsights.symbol,\n                price: data.companyInsights.price || 0,\n                change: (data.companyInsights.price || 0) - (data.companyInsights.open || 0),\n                changePercent: ((data.companyInsights.price - (data.companyInsights.open || data.companyInsights.price)) / ((data.companyInsights.open || data.companyInsights.price) || 1)) * 100,\n                symbol: data.companyInsights.symbol\n              };\n              (window as any).aiAssistantSelectedTimeframe = '1Y';\n\n              // Fetch price chart data for the symbol\n              try {\n                const symbol = data.companyInsights.symbol || "";\n                if (symbol) {\n                  const chartResponse = await fetch(getFullApiUrl(`/api/stock-chart-data/${symbol}?timeframe=1Y`));\n                  if (chartResponse.ok) {\n                    const chartData = await chartResponse.json();\n                    if (chartData && chartData.length > 0) {\n                      (window as any).aiAssistantPriceChartData = chartData;\n                      // Insert price chart marker at the beginning of results\n                      result = "[CHART:PRICE_CHART]\n" + result;\n                      console.log("📈 [TRADING-AGENT] Fetched price chart data:", chartData.length, "candles");\n                    }\n                  }\n                }\n              } catch (chartError) {\n                console.warn("⚠️ Could not fetch price chart data:", chartError);\n              }\n            } else {\n              (window as any).companyInsightsData = null;\n            }\n\n            // Add sources footer if available\n            if (data.sources && data.sources.length > 0) {\n              result += `\n\n---\n**Sources:** ${data.sources.join(' | ')}`;\n            }\n\n            setSearchResults(result);\n\n            // Fetch news if query is about financial/market topics\n            const isNewsQuery = query.toLowerCase().includes("news") || query.toLowerCase().includes("market") || query.toLowerCase().includes("update") || query.toLowerCase().includes("financial");\n            if (isNewsQuery) {\n              try {\n                const newsPromises = ["IT", "FINANCE", "COMMODITY", "GLOBAL", "BANKS", "AUTOMOBILE"].map(sector =>\n                  fetch("/api/daily-news", {\n                    method: "POST",\n                    headers: { "Content-Type": "application/json" },\n                    body: JSON.stringify({ sector })\n                  })\n                    .then(res => res.json())\n                    .then(data => ({...data, url: "#", source: sector, time: new Date().toLocaleTimeString()}))\n                    .catch(err => null)\n                );\n                const results = await Promise.all(newsPromises);\n                const validResults = results.filter(r => r !== null);\n                if (validResults.length > 0) setSearchResultsNews(validResults);\n              } catch (err) {console.warn("Error fetching news:", err);}\n            }\n            console.log("✅ [TRADING-AGENT] Query processing complete!");\n            setIsSearchLoading(false);\n            return;\n          }\n        }\n\n        // Fallback to advanced-query if trading-agent fails\n        console.log("⚠️ [TRADING-AGENT] Falling back to advanced query...");\n\n        let journalTrades: any[] = [];\n        try {\n          const journalResponse = await fetch(getFullApiUrl("/api/journal/all-dates"));\n          if (journalResponse.ok) {\n            const allJournalData = await journalResponse.json();\n            Object.entries(allJournalData).forEach(\n              ([date, data]: [string, any]) => {\n                if (data.tradeHistory && Array.isArray(data.tradeHistory)) {\n                  journalTrades.push(\n                    ...data.tradeHistory.map((trade: any) => ({\n                      ...trade,\n                      date,\n                    })),\n                  );\n                }\n              },\n            );\n          }\n        } catch (journalError) {\n          console.warn("⚠️ Could not load journal data:", journalError);\n        }\n\n        const fallbackResponse = await fetch(getFullApiUrl("/api/advanced-query"), {\n          method: "POST",\n          headers: { "Content-Type": "application/json" },\n          body: JSON.stringify({ query: query, journalTrades: journalTrades }),\n        });\n\n        if (fallbackResponse.ok) {\n          const data = await fallbackResponse.json();\n          if (data.companyInsights) {\n            (window as any).companyInsightsData = data.companyInsights;\n          }\n          setSearchResults(data.answer);\n          setIsSearchLoading(false);\n          return;\n        }\n      } catch (error) {\n        console.error("❌ [TRADING-AGENT] Error:", error);\n        // Fall through to other handlers\n      }\n\n      // Technical Indicator Search (RSI, EMA, MACD, etc.)\n      if (\n        message.includes("rsi") ||\n        message.includes("ema") ||\n        message.includes("macd") ||\n        message.includes("bollinger") ||\n        message.includes("moving average") ||\n        message.includes("technical")\n      ) {\n        const stock = (mentionedStock || "RELIANCE").toUpperCase();\n        const realData = await fetchRealStockData(stock);\n\n        if (realData) {\n          const technicalResult = `## 📊 Technical Analysis: ${stock}\n\n**🎯 Technical Indicators (Live Data):**\n• **RSI (14):** ${realData.indicators?.rsi || "Calculating..."} ${\n            parseFloat(realData.indicators?.rsi || "50") > 70\n              ? "🔴 Overbought"\n              : parseFloat(realData.indicators?.rsi || "50") < 30\n                ? "🟢 Oversold"\n                : "🟡 Neutral"\n          }\n• **EMA 50:** ₹${realData.indicators?.ema50 || "Loading..."}\n• **MACD:** ${realData.indicators?.macd || "Processing..."}\n• **Volume:** ${realData.volume} ${\n            parseInt(String(realData.volume)) > 1000000\n              ? "(High Volume)"\n              : "(Normal Volume)"\n          }\n\n**📈 Price Action:**\n• **Current:** ₹${realData.price.toLocaleString()} (${realData.changePercent.toFixed(\n            2,\n          )}%)\n• **Support:** ₹${(realData.price * 0.98).toFixed(0)} | **Resistance:** ₹${(\n            realData.price * 1.02\n          ).toFixed(0)}\n• **Trend:** ${\n            realData.changePercent > 0 ? "Bullish momentum" : "Bearish pressure"\n          }\n\n**🔮 Trading Signals:**\n${\n  parseFloat(realData.indicators?.rsi || "50") > 70\n    ? "• RSI suggests overbought condition - Consider profit booking"\n    : parseFloat(realData.indicators?.rsi || "50") < 30\n      ? "• RSI shows oversold levels - Potential buying opportunity"\n      : "• RSI in neutral zone - Wait for clear signals"\n}\n\n**💡 Technical Strategy:**\nUse Trading Master for detailed chart analysis with all 14 timeframes and advanced indicators.`;\n\n          setSearchResults(technicalResult);\n        } else {\n          setSearchResults(\n            `📊 **Technical Analysis Hub**\n\nAccess advanced technical indicators through:\n• **Trading Master:** Full charting suite with RSI, MACD, Bollinger Bands\n• **Live Options:** Greeks and technical levels\n• **Community Analysis:** Social Feed technical discussions\n\n🚀 Switch to Trading Master for comprehensive technical analysis.`,\n          );\n        }\n      }\n\n      // Social Feed Search - Optimized with timeout and caching\n      else if (\n        message.includes("social") ||\n        message.includes("community") ||\n        message.includes("discussion") ||\n        message.includes("trending") ||\n        message.includes("sentiment")\n      ) {\n        try {\n          // Fast timeout for social data to prevent slow loading\n          const controller = new AbortController();\n          const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 second timeout\n\n          const socialResponse = await fetch(getFullApiUrl("/api/social-posts?limit=5"), {\n            signal: controller.signal,\n          });\n          clearTimeout(timeoutId);\n\n          if (socialResponse.ok) {\n            const socialData = await socialResponse.json();\n\n            // Filter relevant posts based on query\n            let relevantPosts = socialData;\n            if (mentionedStock) {\n              relevantPosts = socialData.filter(\n                (post: any) =>\n                  post.content &&\n                  post.content.toLowerCase().includes(mentionedStock),\n              );\n            }\n\n            // Extract trending topics\n            const trendingTopics = Array.from(\n              new Set(\n                socialData.flatMap((post: any) =>\n                  (post.content?.match(/\b[A-Z]{3,}\b/g) || []).slice(0, 3),\n                ),\n              ),\n            ).slice(0, 8);\n\n            const socialResult = `## 💬 Social Feed Intelligence ${\n              mentionedStock ? `- ${mentionedStock.toUpperCase()}` : ""\n            }\n\n**💹 Trending Discussions:**\n${\n  trendingTopics.map((topic) => `• ${topic}`).join("\n") ||\n  "• General market discussions"\n}\n\n**📊 Community Insights (${relevantPosts.length} posts):**\n${relevantPosts\n  .slice(0, 5)\n  .map(\n    (post: any, index: number) =>\n      `${index + 1}. **${post.authorUsername || "Trader"}:** ${(\n        post.content || ""\n      ).substring(0, 120)}...`,\n  )\n  .join("\n\n")}\n\n**🎯 Sentiment Analysis:**\n${\n  relevantPosts.length > 0\n    ? `Community is actively discussing ${\n        mentionedStock ? mentionedStock.toUpperCase() + " with" : "market with"\n      } ${\n        relevantPosts.some(\n          (p: any) =>\n            p.content?.toLowerCase().includes("bullish") ||\n            p.content?.toLowerCase().includes("buy"),\n        )\n          ? "bullish sentiment"\n          : relevantPosts.some(\n                (p: any) =>\n                  p.content?.toLowerCase().includes("bearish") ||\n                  p.content?.toLowerCase().includes("sell"),\n              )\n            ? "bearish sentiment"\n            : "mixed sentiment"\n      }`\n    : "Limited recent discussions on this topic"\n}\n\n**🚀 Platform Integration:**\n• **Full Feed:** Access complete Social Feed for detailed discussions  \n• **Real-time Updates:** Live community posts and market reactions\n• **Expert Analysis:** Professional trader insights and strategies\n\n💡 **Quick Access:** Switch to Social Feed tab for complete community analysis.`;\n\n            setSearchResults(socialResult);\n          } else {\n            setSearchResults(\n              `💬 **Social Feed Center**\n\nAccess community insights:\n• **Live Discussions:** Real-time market conversations\n• **Expert Analysis:** Professional trader perspectives\n• **Trending Topics:** What the community is discussing\n\n🚀 Switch to Social Feed tab for full community analysis.`,\n            );\n          }\n        } catch (error) {\n          setSearchResults(\n            `💬 **Social Feed Access**\n\nConnect with the trading community through our Social Feed tab for:\n• Live market discussions\n• Community sentiment analysis\n• Expert trading insights\n\n💡 Navigate to Social Feed for real-time community intelligence.`,\n          );\n        }\n      }\n\n      // Journal & Trading History Search\n      else if (\n        message.includes("journal") ||\n        message.includes("trades") ||\n        message.includes("history") ||\n        message.includes("performance") ||\n        message.includes("pnl")\n      ) {\n        const journalResult = `## 📝 Trading Journal & Performance Hub\n\n**📊 Performance Analytics Available:**\n• **Daily P&L Tracking:** Comprehensive trade-by-trade analysis\n• **Strategy Performance:** Success rates and optimization insights  \n• **Risk Management:** Drawdown analysis and position sizing\n• **Pattern Recognition:** Identify winning and losing patterns\n\n**💼 Journal Features:**\n• **Trade Documentation:** Screenshots, notes, and market context\n• **Tag System:** Categorize trades by strategy, emotion, setup\n• **Performance Metrics:** Win rate, average profit/loss, Sharpe ratio\n• **Calendar View:** Visual P&L heatmap and trading frequency\n\n**🎯 Quick Journal Actions:**\n• **Today's Trades:** Check current session performance\n• **Weekly Review:** Analyze recent trading patterns  \n• **Monthly Summary:** Comprehensive performance overview\n• **Strategy Analysis:** Deep dive into specific trading approaches\n\n**📈 Performance Insights:**\n• **Best Performing Days:** Identify optimal trading conditions\n• **Loss Analysis:** Understand and fix problematic patterns\n• **Time Analysis:** Find your most profitable trading hours\n• **Risk Metrics:** Monitor and optimize risk-adjusted returns\n\n**🚀 Platform Integration:**\nUse Journal tab for detailed performance tracking and trade analysis.`;\n\n        setSearchResults(journalResult);\n      }\n\n      // Quick Actions (Add to watchlist, set alerts, etc.)\n      else if (\n        message.includes("add") ||\n        message.includes("watchlist") ||\n        message.includes("alert") ||\n        message.includes("notification")\n      ) {\n        const quickResult = `## ⚡ Quick Actions Hub\n\n**📋 Watchlist Management:**\n${\n  mentionedStock\n    ? `• **Add ${mentionedStock.toUpperCase()}:** Monitor price movements and alerts\n• **Set Price Alert:** Get notified at target levels\n• **Technical Alert:** RSI/MACD signal notifications\n• **News Alert:** Breaking news for ${mentionedStock.toUpperCase()}`\n    : `• **Add Stocks:** Build your monitoring portfolio\n• **Create Lists:** Sector-wise or strategy-based groupings\n• **Bulk Actions:** Import/export watchlist data\n• **Smart Alerts:** AI-powered signal notifications`\n}\n\n**🔔 Alert System:**\n• **Price Targets:** Get notified at support/resistance levels\n• **Technical Signals:** RSI overbought/oversold alerts\n• **News Alerts:** Breaking developments on watched stocks\n• **Volume Alerts:** Unusual trading activity notifications\n\n**🎯 Quick Setup Actions:**\n• **Portfolio Sync:** Connect with Trading Master for live tracking\n• **Risk Alerts:** Position size and stop-loss monitoring  \n• **Calendar Alerts:** Earnings, dividends, and event reminders\n• **Community Alerts:** Social Feed mentions and discussions\n\n**⚙️ Automation Features:**\n• **Smart Scanning:** Auto-detect trading opportunities\n• **Pattern Alerts:** Chart pattern recognition notifications\n• **Sector Rotation:** Industry momentum change alerts\n• **Market Regime:** Bull/bear market transition signals\n\n**🚀 Platform Integration:**\nConfigure alerts through Trading Master and monitor via Social Feed updates.`;\n\n        setSearchResults(quickResult);\n      }\n\n      // Stock price requests - Optimized with fast loading\n      else if (\n        message.includes("price") ||\n        message.includes("stock") ||\n        message.includes("nifty") ||\n        message.includes("sensex") ||\n        message.includes("live")\n      ) {\n        const stock = (mentionedStock || "RELIANCE").toUpperCase();\n\n        // Show immediate response for better UX\n        setSearchResults(\n          `🔍 **Loading ${stock} Data...**\n\n⏱️ Fetching live market data...`,\n        );\n\n        // Use existing stock analysis endpoint with timeout\n        let realData: StockData | null = null;\n        try {\n          realData = await Promise.race([\n            fetchRealStockData(stock),\n            new Promise<StockData | null>((_, reject) =>\n              setTimeout(() => reject(new Error("Timeout")), 4000),\n            ),\n          ]);\n        } catch (error) {\n          console.log("Stock data timeout, using fallback");\n        }\n\n        if (realData) {\n          // Get additional fundamental data from social feed\n          let fundamentalData = "";\n          try {\n            const socialResponse = await fetch(getFullApiUrl("/api/social-posts?limit=5"));\n            if (socialResponse.ok) {\n              const socialData = await socialResponse.json();\n              const relevantPosts = socialData.filter(\n                (post: any) =>\n                  post.content &&\n                  (post.content.toLowerCase().includes(stock.toLowerCase()) ||\n                    post.content.toLowerCase().includes("market") ||\n                    post.content.toLowerCase().includes("analysis")),\n              );\n\n              if (relevantPosts.length > 0) {\n                fundamentalData = `\n**📊 Community Analysis:**\n${relevantPosts\n                  .slice(0, 2)\n                  .map(\n                    (post: any, index: number) =>\n                      `${index + 1}. ${post.content.substring(0, 150)}...`,\n                  )\n                  .join("\n")}\n`;\n              }\n            }\n          } catch (e) {\n            console.log("Social data not available");\n          }\n\n          const trend = realData.changePercent > 0 ? "bullish" : "bearish";\n          const trendIcon = trend === "bullish" ? "📈" : "📉";\n          const sentimentEmoji =\n            realData.sentiment?.trend === "Bullish"\n              ? "🟢"\n              : realData.sentiment?.trend === "Bearish"\n                ? "🔴"\n                : "🟡";\n          const sentimentText = realData.sentiment?.trend || "Neutral";\n          const sentimentConfidence =\n            realData.sentiment?.confidence || "Medium";\n\n          const analysisResult = `## ${stock} Stock Analysis ${trendIcon}\n\n**📈 Live Market Data (Fyers API):**\n• **Current Price:** ₹${realData.price.toLocaleString()} (${realData.changePercent.toFixed(\n            2,\n          )}%)\n• **Open:** ₹${realData.open.toLocaleString()} | **High:** ₹${realData.high.toLocaleString()}\n• **Low:** ₹${realData.low.toLocaleString()} | **Volume:** ${realData.volume}\n• **Market Cap:** ${realData.marketCap}\n• **P/E Ratio:** ${realData.pe || "N/A"}\n\n**🎯 Market Sentiment:** ${sentimentEmoji} ${sentimentText} (${sentimentConfidence} confidence)\n\n**📊 Technical Indicators:**\n• **RSI:** ${realData.indicators?.rsi || "Calculating..."}\n• **EMA 50:** ${realData.indicators?.ema50 || "Loading..."}\n• **Trend:** ${trend === "bullish" ? "Upward momentum" : "Consolidation phase"}\n• **Support:** ₹${(realData.price * 0.98).toFixed(0)} | **Resistance:** ₹${(\n            realData.price * 1.02\n          ).toFixed(0)}\n${fundamentalData}\n**💡 AI Trading Insight:**\n${\n  trend === "bullish"\n    ? `Strong buying momentum with ${\n        realData.volume\n      } volume. Consider position entry with stop-loss below ₹${(\n        realData.price * 0.95\n      ).toFixed(0)}.`\n    : `Cautious sentiment prevailing. Wait for confirmation above ₹${(\n        realData.price * 1.02\n      ).toFixed(0)} for bullish reversal.`\n}\n\n**⚖️ Risk Level:** ${\n            realData.changePercent > 5\n              ? "High"\n              : realData.changePercent > 2\n                ? "Medium"\n                : "Low"\n          } Volatility | ${sentimentConfidence} Confidence\n\n🚀 **Platform Features:** Use Trading Master for advanced charts and options analysis.`;\n\n          setSearchResults(analysisResult);\n        } else {\n          // Fallback with platform guidance\n          setSearchResults(`📈 **${stock} Stock Analysis**\n\n⏰ **Data Status:** Real-time data temporarily unavailable\n\n**🔧 Alternative Data Sources:**\n• **Trading Master:** Live charts, options chain, technical indicators\n• **Social Feed:** Community analysis and discussions\n• **Market Dashboard:** Real-time quotes and market sentiment\n\n**📱 Platform Features Available:**\n• **Live Options Chain:** Greeks calculation and analysis\n• **Technical Charts:** 14 timeframes with indicators\n• **Community Insights:** Social trading feed\n• **Risk Management:** Journal and performance tracking\n\n💡 **Quick Access:** Switch to Trading Master tab for live ${stock} data and analysis.`);\n        }\n      }\n\n      // Market news requests using existing platform news data\n      else if (\n        message.includes("news") ||\n        message.includes("market") ||\n        message.includes("update")\n      ) {\n        try {\n          // Use the same news API that's already working successfully\n          const query = mentionedStock\n            ? mentionedStock.toUpperCase()\n            : "Indian stock market finance news";\n          const response = await fetch(\n            `/api/stock-news?query=${encodeURIComponent(query)}`,\n          );\n          const data = await response.json();\n\n          if (data.success && data.articles && data.articles.length > 0) {\n            // Organize the news data that's already being fetched\n            const newsArticles = data.articles.slice(0, 6);\n\n            // Analyze sentiment from the news\n            const getNewssentiment = (articles: any[]) => {\n              const positiveWords = [\n                "growth",\n                "profit",\n                "gain",\n                "rise",\n                "bullish",\n                "strong",\n                "beat",\n                "up",\n                "higher",\n                "surge",\n              ];\n              const negativeWords = [\n                "loss",\n                "decline",\n                "fall",\n                "bearish",\n                "weak",\n                "miss",\n                "concern",\n                "down",\n                "lower",\n                "crash",\n              ];\n\n              let positiveCount = 0;\n              let negativeCount = 0;\n\n              articles.forEach((article) => {\n                const text = (\n                  article.title +\n                  " " +\n                  (article.description || "")\n                ).toLowerCase();\n                positiveWords.forEach((word) => {\n                  if (text.includes(word)) positiveCount++;\n                });\n                negativeWords.forEach((word) => {\n                  if (text.includes(word)) negativeCount++;\n                });\n              });\n\n              if (positiveCount > negativeCount)\n                return {\n                  sentiment: "Bullish",\n                  score: positiveCount - negativeCount,\n                };\n              if (negativeCount > positiveCount)\n                return {\n                  sentiment: "Bearish",\n                  score: negativeCount - positiveCount,\n                };\n              return { sentiment: "Neutral", score: 0 };\n            };\n\n            const sentimentAnalysis = getNewssentiment(newsArticles);\n            const targetSymbol = mentionedStock\n              ? mentionedStock.toUpperCase()\n              : "Market";\n\n            const newsResult = `## 📰 Latest ${targetSymbol} News & Analysis\n\n**🎯 News Sentiment Analysis:**\n• **Overall Tone:** ${sentimentAnalysis.sentiment} ${\n              sentimentAnalysis.sentiment === "Bullish"\n                ? "🟢"\n                : sentimentAnalysis.sentiment === "Bearish"\n                  ? "🔴"\n                  : "🟡"\n            }\n• **Confidence Score:** ${Math.abs(sentimentAnalysis.score)} signals detected\n• **Market Impact:** ${\n              sentimentAnalysis.sentiment === "Bullish"\n                ? "Positive momentum expected"\n                : sentimentAnalysis.sentiment === "Bearish"\n                  ? "Caution advised"\n                  : "Mixed signals, focus on fundamentals"\n            }\n\n**📈 Trading Implications:**\n${\n  sentimentAnalysis.sentiment === "Bullish"\n    ? `• Positive news flow may support price appreciation\n• Consider gradual position building on dips\n• Monitor for continuation patterns`\n    : sentimentAnalysis.sentiment === "Bearish"\n      ? `• Negative sentiment may create selling pressure\n• Wait for news clarity before fresh positions\n• Look for oversold bounce opportunities`\n      : `• Mixed news requires balanced approach\n• Focus on technical levels over news sentiment\n• Maintain risk management discipline`\n}\n\n**📋 Recent Headlines (${newsArticles.length} articles):**\n${newsArticles\n  .map(\n    (article: any, index: number) =>\n      `${index + 1}. **${article.title}**\n   ${\n        article.description || "Breaking market development"\n      }\n   _Source: ${article.source || "Market News"}_`,\n  )\n  .join("\n\n")}\n\n**💡 Platform Integration:**\n• **Social Feed:** Community discussions about these developments\n• **Trading Master:** Technical analysis with news correlation\n• **Journal:** Track news-driven trading decisions\n\n🚀 **Next Steps:** Use Social Feed for community insights on these news developments.`;\n\n            setSearchResults(newsResult);\n          } else {\n            // Fallback when news API doesn't have data\n            setSearchResults(`📰 **Market News Dashboard**\n\n**🔧 News Sources Available:**\n• **Social Feed:** Real-time community discussions and market insights\n• **Trading Platform:** Live market updates and analysis\n• **Community Posts:** User-generated market commentary\n\n**📱 Platform Features:**\n• **Breaking News:** Check Social Feed for latest developments\n• **Market Analysis:** Community-driven insights and discussions\n• **Technical Updates:** Trading Master for chart-based news correlation\n\n**💡 Alternative Sources:**\n• Switch to Social Feed tab for community market discussions\n• Check Trading Master for technical news impact analysis\n• Monitor Journal for news-driven trading patterns\n\n🚀 **Quick Access:** Social Feed contains the most up-to-date market discussions.`);\n          }\n        } catch (error) {\n          console.error("News fetch error:", error);\n          setSearchResults(\n            `📰 **News Center**\n\nAccess the latest market news through our platform features:\n\n• **Social Feed:** Community market discussions\n• **Trading Master:** Technical analysis and market updates\n• **Platform Dashboard:** Real-time market information\n\n💡 Use Social Feed for the most current market insights.`,\n          );\n        }\n      }\n\n      // IPO requests using AI Finance Assistant logic\n      else if (\n        message.includes("ipo") ||\n        message.includes("listing") ||\n        message.includes("upcoming")\n      ) {\n        const ipoAnalysis = `🚀 **IPO Market Intelligence**\n\n**Current IPO Landscape:**\nThe IPO market is experiencing selective activity with quality companies commanding premium valuations. Key focus areas:\n\n• **Technology Sector:** Fintech and SaaS companies leading the pipeline with strong digital transformation themes\n• **Green Energy:** Renewable energy firms gaining significant investor attention amid sustainability focus\n• **Healthcare:** Specialty pharma and medical device companies benefiting from health sector growth\n• **Financial Services:** NBFCs and insurance companies exploring listings amid credit growth cycle\n\n**Investment Framework for IPO Analysis:**\n\n**1. Fundamental Due Diligence:**\n• Business model sustainability and competitive moats\n• Revenue growth consistency and profit margins\n• Management track record and corporate governance\n• Industry positioning and market opportunity size\n\n**2. Valuation Assessment:**\n• Compare with listed peers in same sector\n• Evaluate growth prospects vs. premium pricing\n• Assess price band reasonableness\n• Consider post-listing price performance patterns\n\n**3. Risk Evaluation:**\n• Market timing and overall sentiment\n• Lock-in period implications for promoters\n• Regulatory environment and compliance history\n• Competition intensity and market share sustainability\n\n**Professional IPO Strategy:**\n• **Research Phase:** Thorough analysis of DRHP and company financials\n• **Application Strategy:** Multiple family member applications for better allocation\n• **Post-Listing:** Monitor for 3-6 months before major position changes\n• **Portfolio Integration:** Limit IPO exposure to 5-10% of total portfolio\n\n**Current Market Dynamics:**\n• Quality companies with clear business models preferred\n• Premium valuations acceptable for proven growth stories\n• Retail participation remains strong but selective\n• Institutional investors focusing on long-term value creation\n\n💡 **Platform Integration:** Use our Social Feed for community IPO discussions and Trading Master for technical analysis of newly listed stocks.`;\n\n        setSearchResults(ipoAnalysis);\n      }\n\n      // Fundamental analysis using existing social feed data\n      else if (\n        message.includes("fundamental") ||\n        message.includes("analysis") ||\n        message.includes("financials")\n      ) {\n        try {\n          // Combine stock data with social feed fundamental insights\n          const stock = mentionedStock\n            ? mentionedStock.toUpperCase()\n            : "MARKET";\n\n          // Get stock data and social feed data in parallel\n          const [stockData, socialResponse] = await Promise.all([\n            mentionedStock ? fetchRealStockData(stock) : Promise.resolve(null),\n            fetch("/api/social-posts?limit=10"),\n          ]);\n\n          let fundamentalInsights = "";\n          if (socialResponse.ok) {\n            const socialData = await socialResponse.json();\n            // Filter for fundamental analysis posts\n            const fundamentalPosts = socialData.filter(\n              (post: any) =>\n                post.content &&\n                (post.content.toLowerCase().includes("pe ratio") ||\n                  post.content.toLowerCase().includes("p/e") ||\n                  post.content.toLowerCase().includes("valuation") ||\n                  post.content.toLowerCase().includes("earnings") ||\n                  post.content.toLowerCase().includes("fundamental") ||\n                  post.content.toLowerCase().includes("financial") ||\n                  post.content.toLowerCase().includes("balance sheet") ||\n                  post.content.toLowerCase().includes("revenue") ||\n                  post.content.toLowerCase().includes("profit margin") ||\n                  (mentionedStock &&\n                    post.content\n                      .toLowerCase()\n                      .includes(mentionedStock.toLowerCase()))),\n            );\n\n            if (fundamentalPosts.length > 0) {\n              fundamentalInsights = `**📈 Community Fundamental Analysis:**\n${fundamentalPosts\n  .slice(0, 3)\n  .map(\n    (post: any, index: number) =>\n      `${index + 1}. ${post.content.substring(0, 200)}...`,\n  )\n  .join("\n\n")}\n\n`;\n            }\n          }\n\n          if (stockData && mentionedStock) {\n            // Specific stock fundamental analysis\n            const fundamentalResult = `## ${stock} Fundamental Analysis 📊\n\n**📋 Key Financial Metrics (Live Data):**\n• **Current Price:** ₹${stockData.price.toLocaleString()}\n• **Market Capitalization:** ${stockData.marketCap}\n• **P/E Ratio:** ${stockData.pe || "N/A"} ${\n              stockData.pe\n                ? stockData.pe < 15\n                  ? "(Attractive)"\n                  : stockData.pe < 25\n                    ? "(Fair)"\n                    : "(Premium)"\n                : ""\n            }\n• **Daily Volume:** ${stockData.volume}\n• **Price Change:** ${stockData.changePercent.toFixed(2)}% (${\n              stockData.changePercent > 0\n                ? "Positive momentum"\n                : "Under pressure"\n            })\n\n**💹 Valuation Assessment:**\n${\n  stockData.pe > 0\n    ? `• P/E of ${stockData.pe} suggests ${\n        stockData.pe < 15\n          ? "**undervalued** opportunity"\n          : stockData.pe < 25\n            ? "**fairly valued** with reasonable premium"\n            : "**premium valuation** requiring strong growth"\n      }\n• Sector comparison needed for complete picture`\n    : "• P/E data unavailable - focus on revenue and earnings trends\n• Check recent quarterly results for growth trajectory"\n}\n\n**🎯 Investment Framework:**\n• **Growth Quality:** Consistent revenue and earnings expansion\n• **Financial Health:** Strong balance sheet with manageable debt levels\n• **Market Position:** Competitive advantages and market share trends\n• **Management:** Track record of value creation and strategic vision\n\n**⚠️ Risk Analysis:**\n• **Volatility Level:** ${\n              stockData.changePercent > 5\n                ? "High"\n                : stockData.changePercent > 2\n                  ? "Medium"\n                  : "Low"\n            } (based on recent price movement)\n• **Sentiment Risk:** ${\n              stockData.sentiment?.confidence || "Medium"\n            } confidence level\n• **Liquidity:** ${\n              stockData.volume !== "N/A"\n                ? "Good trading volumes"\n                : "Limited liquidity"\n            }\n\n${fundamentalInsights}**💡 Platform Resources:**\n• **Trading Master:** Complete financial ratios and technical analysis\n• **Social Feed:** Community fundamental discussions and insights\n• **Market Dashboard:** Real-time valuation metrics\n\n🚀 **Next Steps:** Check Social Feed for community fundamental analysis discussions.`;\n\n            setSearchResults(fundamentalResult);\n          } else {\n            // General fundamental analysis framework with social insights\n            const generalFundamental = `📊 **Fundamental Analysis Center**\n\n**🔍 Platform Data Sources:**\n• **Social Feed:** Community fundamental analysis and insights\n• **Trading Master:** Complete financial ratios and valuation metrics\n• **Market Data:** Real-time price and volume information\n\n${fundamentalInsights}**📈 Essential Analysis Framework:**\n\n**1. Profitability Ratios:**\n• **ROE (Return on Equity):** >15% indicates efficient capital use\n• **ROA (Return on Assets):** >10% shows strong asset management\n• **Net Margin:** >10% suggests healthy profitability\n• **EBITDA Margin:** Industry-specific operational efficiency\n\n**2. Valuation Metrics:**\n• **P/E Ratio:** Compare with sector average and growth rate\n• **P/B Ratio:** <3 generally attractive for most sectors\n• **EV/EBITDA:** Comprehensive valuation including debt structure\n• **PEG Ratio:** <1 indicates growth at reasonable price\n\n**3. Financial Strength:**\n• **Debt-to-Equity:** <0.5 preferred for financial stability\n• **Current Ratio:** >1.5 shows good short-term liquidity\n• **Interest Coverage:** >5x indicates comfortable debt servicing\n• **Free Cash Flow:** Positive and growing cash generation\n\n**🎯 Sector-Wise Opportunities:**\n\n**Banking (P/E: 12-15x)**\n• Post-cycle recovery phase with improving asset quality\n• Focus: Private banks with strong digital transformation\n\n**Technology (P/E: 20-25x)**\n• Premium justified by consistent growth and global exposure\n• Focus: Export-oriented companies with recurring revenue models\n\n**FMCG (P/E: 35-45x)**\n• Quality premium for stable cash flows and market leadership\n• Focus: Rural recovery themes and premiumization trends\n\n**🚨 Red Flags to Avoid:**\n⚠️ Declining revenue for 3+ consecutive quarters\n⚠️ Rising debt without corresponding asset growth\n⚠️ Frequent management changes or governance issues\n⚠️ Sector headwinds without clear resolution path\n\n**💡 Platform Integration:**\n• **Social Feed:** Real-time community fundamental discussions\n• **Trading Master:** Detailed financial ratio analysis\n• **Journal:** Track fundamental-based investment decisions\n\n🚀 **Quick Access:** Social Feed contains active fundamental analysis discussions.`;\n\n            setSearchResults(generalFundamental);\n          }\n        } catch (error) {\n          console.error("Fundamental analysis error:", error);\n          setSearchResults(\n            `📊 **Fundamental Analysis Hub**\n\n**📱 Available Resources:**\n• **Social Feed:** Community fundamental discussions\n• **Trading Master:** Financial ratios and analysis tools\n• **Platform Data:** Real-time market and company information\n\n💡 Check Social Feed for active fundamental analysis discussions.`,\n          );\n        }\n      }\n\n      // Advanced AI Search - Uses Gemini AI + Web Search (like Replit Agent)\n      else {\n        console.log(`🤖 Using Advanced AI Agent for query: ${query}`);\n\n        try {\n          const response = await fetch(getFullApiUrl("/api/advanced-search"), {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({\n              query,\n              includeWebSearch: true,\n            }),\n          });\n\n          const data = await response.json();\n\n          if (data.success && data.answer) {\n            let result = `## 🤖 AI Assistant\n\n${data.answer}`;\n\n            if (data.sources && data.sources.length > 0) {\n              result += `\n\n**📚 Sources:**\n${data.sources.map((source: string) => `• ${source}`).join("\n")}`;\n            }\n\n            setSearchResults(result);\n          } else {\n            throw new Error("AI search failed");\n          }\n        } catch (error) {\n          console.error("Advanced AI search error:", error);\n\n          const fallbackResponse = `🤖 **AI Trading Assistant Ready!**\n\nI can help you with comprehensive trading and investment analysis:\n\n📈 **Live Stock Prices & Analysis:**\n• Real-time market data and technical indicators\n• Sector performance and trend analysis\n• Support/resistance levels and price targets\n\n📰 **Market News & Updates:**\n• Latest financial news and market movements\n• Economic indicators and policy impacts\n• Corporate earnings and sector trends\n\n🚀 **IPO Analysis & Information:**\n• Upcoming IPO calendar and subscription details\n• Post-listing performance tracking\n• Investment recommendations and risk assessment\n\n📊 **Fundamental Analysis:**\n• Company financials and valuation metrics\n• Sector comparisons and growth prospects\n• Risk analysis and investment recommendations\n\n💡 **Try asking:** "Get NIFTY price", "Latest market news", "IPO updates", or "Analyze fundamentals"`;\n\n          setSearchResults(fallbackResponse);\n        }\n      }\n    } catch (error) {\n      console.error("AI Search error:", error);\n      setSearchResults(\n        "🤖 I'm here to help with all your trading and finance questions! I can assist with:\n\n• Stock analysis and live quotes\n• Market news and IPO updates\n• Trading strategies and risk management\n• Platform features (Trading Master, Journal, Social Feed)\n• Options trading and Greeks calculation\n\nWhat would you like to know more about?",\n      );\n    } finally {\n      setIsSearchLoading(false);\n    }\n  };\n\n  // Handle suggestion button clicks\n  const handleSuggestionClick = (suggestion: string) => {\n    setSearchQuery(suggestion);\n    setIsSearchActive(true);\n    // Automatically trigger search with the suggestion\n    handleSearch(suggestion);\n  };\n\n  // Generate Trading Journal AI Performance Report\n  const generateJournalAIReport = async () => {\n    setIsSearchLoading(true);\n    setIsSearchActive(true);\n    setSearchQuery("Trading Journal Performance Analysis");\n\n    try {\n      // Fetch all journal dates and data\n      const allDatesResponse = await fetch(getFullApiUrl("/api/journal/all-dates"));\n      const allJournalData = allDatesResponse.ok\n        ? await allDatesResponse.json()\n        : {};\n\n      // AWS is the only data source - no localStorage fallback\n      const journalData = allJournalData;\n\n      if (Object.keys(journalData).length === 0) {\n        setSearchResults(\n          "## 📝 Trading Journal Analysis\n\n❌ **No journal data found**\n\nPlease add some trading entries in the Journal tab to see your performance analysis.",\n        );\n        setIsSearchLoading(false);\n        return;\n      }\n\n      // Analyze journal data for performance metrics\n      let totalTrades = 0;\n      let winningTrades = 0;\n      let losingTrades = 0;\n      let totalProfit = 0;\n      let totalLoss = 0;\n      let netPnL = 0;\n      let fomoTrades = 0;\n      let psychologyTags: { [key: string]: number } = {};\n      let dailyPnL: { date: string; pnl: number }[] = [];\n\n      // Process each date's journal data\n      Object.entries(journalData).forEach(([date, dateData]: [string, any]) => {\n        if (dateData && typeof dateData === "object") {\n          // Extract trades from the date data - use correct structure\n          const trades = dateData.tradeHistory || dateData.trades || [];\n          const notes = dateData.tradingNotes || dateData.notes || "";\n          const tags = dateData.tradingTags || dateData.selectedTags || [];\n\n          let dayPnL = 0;\n\n          trades.forEach((trade: any) => {\n            totalTrades++;\n\n            // Parse P&L from string format like "₹506.80", "₹-826.00"\n            let pnl = 0;\n            if (trade.pnl && typeof trade.pnl === "string") {\n              const pnlStr = trade.pnl.replace(/[₹,+\s]/g, ""); // Remove ₹, commas, + and spaces\n              pnl = parseFloat(pnlStr) || 0;\n            } else if (typeof trade.pnl === "number") {\n              pnl = trade.pnl;\n            }\n\n            dayPnL += pnl;\n\n            if (pnl > 0) {\n              winningTrades++;\n              totalProfit += pnl;\n            } else if (pnl < 0) {\n              losingTrades++;\n              totalLoss += Math.abs(pnl);\n            }\n          });\n\n          // Count psychology tags\n          tags.forEach((tag: string) => {\n            psychologyTags[tag] = (psychologyTags[tag] || 0) + 1;\n            if (tag.toLowerCase().includes("fomo")) {\n              fomoTrades++;\n            }\n          });\n\n          // Track daily P&L for trend analysis\n          if (dayPnL !== 0) {\n            dailyPnL.push({ date, pnl: dayPnL });\n          }\n\n          netPnL += dayPnL;\n        }\n      });\n\n      const winRate =\n        totalTrades > 0 ? Math.round((winningTrades / totalTrades) * 100) : 0;\n      const avgWin =\n        winningTrades > 0 ? Math.round(totalProfit / winningTrades) : 0;\n      const avgLoss =\n        losingTrades > 0 ? Math.round(totalLoss / losingTrades) : 0;\n\n      // Get top psychology patterns\n      const topPsychologyPatterns = Object.entries(psychologyTags)\n        .sort(([, a], [, b]) => b - a)\n        .slice(0, 3)\n        .map(([tag, count]) => `${tag} (${count}x)`)\n        .join(", ");\n\n      // Generate mini performance trend (last 10 trading days)\n      const recentTrend = dailyPnL.slice(-10);\n      const trendData = recentTrend.map((day) => day.pnl).join(",");\n\n      // Create performance trend visualization (simple ASCII-style)\n      const maxPnL = Math.max(...recentTrend.map((d) => d.pnl));\n      const minPnL = Math.min(...recentTrend.map((d) => d.pnl));\n      const range = maxPnL - minPnL;\n\n      let trendLine = "";\n      if (range > 0) {\n        recentTrend.forEach((day) => {\n          const normalized = Math.round(((day.pnl - minPnL) / range) * 10);\n          trendLine += normalized >= 5 ? "📈" : normalized >= 3 ? "📊" : "📉";\n        });\n      }\n\n      // Create chart data for Performance Trend\n      const chartData = recentTrend.map((day, index) => ({\n        day: `Day ${index + 1}`,\n        value: day.pnl,\n        date: day.date,\n      }));\n\n      const performanceReport = `## 📝 Trading Journal AI Performance Report\n\n### 📊 **Overall Performance Metrics**\n**🎯 Total Trades:** ${totalTrades}\n**✅ Winning Trades:** ${winningTrades} (${winRate}% Win Rate)\n**❌ Losing Trades:** ${losingTrades}\n**💰 Net P&L:** ₹${netPnL.toLocaleString("en-IN")} ${netPnL >= 0 ? "🟢" : "🔴"}\n\n### 💡 **Detailed Analytics**\n**📈 Total Profit:** ₹${totalProfit.toLocaleString("en-IN")}\n**📉 Total Loss:** ₹${totalLoss.toLocaleString("en-IN")}\n**⚡ Average Win:** ₹${avgWin.toLocaleString("en-IN")}\n**⚠️ Average Loss:** ₹${avgLoss.toLocaleString("en-IN")}\n\n### 🧠 **Psychology Analysis**\n**💹 FOMO Trades:** ${fomoTrades} trades\n**🎭 Top Patterns:** ${topPsychologyPatterns || "No patterns identified"}\n\n### 📈 **Performance Trend (Recent)**\n[CHART:PERFORMANCE_TREND]\n*${recentTrend.length} trading sessions tracked*\n\n### 🎯 **AI Insights & Recommendations**\n${\n  winRate >= 60\n    ? "🟢 **Strong Performance:** Your win rate shows good trading discipline!"\n    : winRate >= 40\n      ? "🟡 **Moderate Performance:** Focus on improving entry/exit timing."\n      : "🔴 **Needs Improvement:** Consider reviewing your trading strategy and risk management."\n}\n\n${\n  fomoTrades > totalTrades * 0.2\n    ? "⚠️ **FOMO Alert:** High emotional trading detected. Consider implementing cooling-off periods."\n    : "✅ **Good Discipline:** Low FOMO trading indicates strong emotional control."\n}\n\n**📚 Next Steps:**\n• Review losing trades for common patterns\n• Maintain detailed trade notes for better analysis\n• ${\n        netPnL < 0\n          ? "Focus on risk management and position sizing"\n          : "Continue current strategy with slight optimizations"\n      }\n\n---\n*📱 Use Journal tab for detailed trade entries and analysis*`;\n\n      // Store chart data for rendering\n      (window as any).performanceTrendChartData = chartData;\n\n      setSearchResults(performanceReport);\n    } catch (error) {\n      console.error("Error generating journal report:", error);\n      setSearchResults(\n        "## 📝 Trading Journal Analysis\n\n❌ **Error loading journal data**\n\nPlease try again or check your internet connection.",\n      );\n    } finally {\n      setIsSearchLoading(false);\n    }\n  };\n\n  // Function to fetch trending podcasts for a specific sector\n  const fetchTrendingPodcasts = async (sector: string) => {\n    setIsPodcastsLoading(true);\n    try {\n      const response = await fetch(getFullApiUrl("/api/trending-podcasts"), {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify({ sector }),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        setTrendingPodcasts(data.podcasts || []);\n      } else {\n        throw new Error("Failed to fetch trending podcasts");\n      }\n    } catch (error) {\n      console.error("Error fetching trending podcasts:", error);\n      setTrendingPodcasts([]);\n    } finally {\n      setIsPodcastsLoading(false);\n    }\n  };\n\n  // Handler for sector change\n  const handleSectorChange = (sector: string) => {\n    setSelectedSector(sector);\n    fetchTrendingPodcasts(sector);\n    setSelectedPodcast(null); // Clear selected podcast when sector changes\n  };\n\n  // Dynamic greeting based on local time\n  const getTimeBasedGreeting = () => {\n    const hour = new Date().getHours();\n    if (hour >= 5 && hour < 12) {\n      return "Hey, Good Morning! 🌅";\n    } else if (hour >= 12 && hour < 17) {\n      return "Hey, Good Afternoon! ☀️";\n    } else if (hour >= 17 && hour < 21) {\n      return "Hey, Good Evening! 🌆";\n    } else {\n      return "Hey, Good Night! 🌙";\n    }\n  };\n\n  // Handler for podcast selection\n  const handlePodcastSelect = (podcast: any) => {\n    setSelectedPodcast(podcast);\n  };\n\n  // Load default podcasts on startup\n  React.useEffect(() => {\n    fetchTrendingPodcasts("FINANCE");\n  }, []);\n\n  // Podcasts are now only selected when manually clicked\n  // Removed AI image generation - using user provided images\n\n  // State to track slope pattern configuration from TradingMaster\n  const [slopePatternConfig, setSlopePatternConfig] = useState({\n    symbol: "NSE:INFY-EQ",\n    timeframe: "1",\n    fromDate: format(new Date(), "yyyy-MM-dd"),\n    toDate: format(new Date(), "yyyy-MM-dd"),\n  });\n\n  // Event images - using gradient placeholders for cloud deployment\n  const getEventImage = (eventName: string) => {\n    // Return a data URL with gradient based on event type\n    const gradients: Record<string, string> = {\n      "Global Startup Summit | Hyderabad 2025": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",\n      "TiE Bangalore Founders Summit": "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",\n      "Pharma Bio Summit Hyderabad": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",\n      "Hyderabad Food Festival": "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",\n      "HITEX IT Expo Hyderabad": "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",\n      "Mumbai Fintech Festival": "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",\n      "Nasscom Product Conclave Bangalore": "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",\n      "India AI Summit Mumbai": "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",\n    };\n    const gradient = gradients[eventName] || "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";\n    // Return empty string to use CSS gradient instead\n    return "";\n  };\n\n  // Removed AI image generation effects\n\n  // Import Modal State\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [showConnectDialog, setShowConnectDialog] = useState(false);\n\n  const [zerodhaAccessToken, setZerodhaAccessToken] = useState<string | null>(null);\n  const [zerodhaIsConnected, setZerodhaIsConnected] = useState(false);\n  const [zerodhaClientId, setZerodhaClientId] = useState<string | null>(null);\n  const [brokerFunds, setBrokerFunds] = useState<number | null>(() => {\n    if (typeof window !== "undefined") {\n      const saved = localStorage.getItem("zerodha_broker_funds");\n      return saved ? parseFloat(saved) : null;\n    }\n    return null;\n  });\n  const [zerodhaUserName, setZerodhaUserName] = useState<string | null>(null);\nconst [zerodhaTradesDialog, setZerodhaTradesDialog] = useState(false);\n  const [showUserId, setShowUserId] = useState(true);\n  const [zerodhaTradesLoading, setZerodhaTradesLoading] = useState(false);\n  const [zerodhaTradesData, setZerodhaTradesData] = useState<any[]>([]);\n  const [zerodhaProfileData, setZerodhaProfileData] = useState<any>(null);\n  const [importData, setImportData] = useState("");\n  const [importError, setImportError] = useState("");\n  const [upstoxIsConnected, setUpstoxIsConnected] = useState(false);\n  const [upstoxAccessToken, setUpstoxAccessToken] = useState<string | null>(null);\n  const [upstoxUserId, setUpstoxUserId] = useState<string | null>(null);\n  const [upstoxUserName, setUpstoxUserName] = useState<string | null>(null);\n\n  useEffect(() => {\n    if (upstoxAccessToken) {\n      fetch("/api/upstox/profile")\n        .then(r => r.json())\n        .then(data => {\n          if (data.success) {\n            const userId = data.userId && data.userId !== "undefined" ? data.userId : null;\n            const userName = data.userName && data.userName !== "undefined" ? data.userName : null;\n            \n            if (userId) {\n              setUpstoxUserId(userId);\n              localStorage.setItem("upstox_user_id", userId);\n            }\n            if (userName) {\n              setUpstoxUserName(userName);\n              localStorage.setItem("upstox_user_name", userName);\n            }\n          }\n        })\n        .catch(err => console.error("Failed to fetch Upstox profile:", err));\n    }\n  }, [upstoxAccessToken]);\n  const [angelOneAccessToken, setAngelOneAccessToken] = useState<string | null>(null);\n  const [angelOneIsConnected, setAngelOneIsConnected] = useState(false);\n  const [dhanAccessToken, setDhanAccessToken] = useState<string | null>(null);\n  const [dhanIsConnected, setDhanIsConnected] = useState(false);\n  // Zerodha OAuth Handlers\n  // Check localStorage on mount to restore connection state\n  useEffect(() => {\n    console.log('🔷 [ZERODHA] Checking localStorage on mount...');\n    const savedToken = localStorage.getItem('zerodha_token');\n    console.log('🔷 [ZERODHA] Saved token:', savedToken ? 'FOUND ✅' : 'NOT FOUND ❌');\n    if (savedToken) {\n      setZerodhaAccessToken(savedToken);\n      setZerodhaIsConnected(true);\n      console.log('✅ [ZERODHA] Connection restored from localStorage');\n      const savedClientId = localStorage.getItem('zerodha_client_id');\n      if (savedClientId) {\n        setZerodhaClientId(savedClientId);\n        console.log('✅ [ZERODHA] Client ID restored from localStorage');\n      }\n    } else {\n      console.log('⚠️ [ZERODHA] No saved token in localStorage');\n    }\n      const savedUserName = localStorage.getItem("zerodha_user_name");\n      if (savedUserName && savedUserName !== "undefined") {\n        setZerodhaUserName(savedUserName);\n        console.log("✅ [ZERODHA] User Name restored from localStorage");\n      }\n  }, []);\n\n\n  // Fetch Zerodha profile to get both userId and userName - with persistence\n\n  // Restore Upstox connection from localStorage on mount\n  useEffect(() => {\n    console.log('🔵 [UPSTOX] Checking localStorage on mount...');\n    const savedToken = localStorage.getItem('upstox_token');\n    console.log('🔵 [UPSTOX] Saved token:', savedToken ? 'FOUND ✅' : 'NOT FOUND ❌');\n    if (savedToken) {\n      setUpstoxAccessToken(savedToken);\n      setUpstoxIsConnected(true);\n      console.log('✅ [UPSTOX] Connection restored from localStorage');\n      const savedUserId = localStorage.getItem('upstox_user_id');\n      const savedUserName = localStorage.getItem('upstox_user_name');\n      if (savedUserId) {\n        setUpstoxUserId(savedUserId);\n        console.log('✅ [UPSTOX] User ID restored from localStorage');\n      }\n      if (savedUserName && savedUserName !== "undefined") {\n        setUpstoxUserName(savedUserName);\n        console.log('✅ [UPSTOX] User Name restored from localStorage');\n      }\n    } else {\n      console.log('⚠️ [UPSTOX] No saved token in localStorage');\n    }\n  }, []);\n\n  // Restore Angel One connection from localStorage on mount\n  useEffect(() => {\n    console.log('✅ [ANGEL ONE] Checking localStorage on mount...');\n    const savedToken = localStorage.getItem('angel_one_token');\n    console.log('✅ [ANGEL ONE] Saved token:', savedToken ? 'FOUND ✅' : 'NOT FOUND ❌');\n    if (savedToken) {\n      setAngelOneAccessToken(savedToken);\n      setAngelOneIsConnected(true);\n      console.log('✅ [ANGEL ONE] Connection restored from localStorage');\n    } else {\n      console.log('⚠️ [ANGEL ONE] No saved token in localStorage');\n    }\n  }, []);\n\n  // Restore Dhan connection from localStorage on mount\n  useEffect(() => {\n    console.log('🔵 [DHAN] Checking localStorage on mount...');\n    const savedToken = localStorage.getItem('dhan_token');\n    console.log('🔵 [DHAN] Saved token:', savedToken ? 'FOUND ✅' : 'NOT FOUND ❌');\n    if (savedToken) {\n      setDhanAccessToken(savedToken);\n      setDhanIsConnected(true);\n      console.log('✅ [DHAN] Connection restored from localStorage');\n    } else {\n      console.log('⚠️ [DHAN] No saved token in localStorage');\n    }\n  }, []);\n\n  useEffect(() => {\n    if (zerodhaAccessToken) {\n      // Check if we already have profile in localStorage\n      const savedId = localStorage.getItem('zerodha_client_id');\n      const savedName = localStorage.getItem('zerodha_user_name');\n      \n      if (savedId && savedName && !zerodhaClientId) {\n        setZerodhaClientId(savedId);\n        setZerodhaUserName(savedName);\n        console.log('✅ [ZERODHA] Profile restored from cache');\n        return;\n      }\n      \n      // If not in cache or state, fetch it from backend\n      if (!zerodhaClientId || !zerodhaUserName) {\n        const fetchZerodhaProfile = async () => {\n          try {\n            const response = await fetch('/api/broker/zerodha/profile', {\n              headers: {\n                'Authorization': `Bearer ${zerodhaAccessToken}`\n              }\n            });\n            if (response.ok) {\n              const data = await response.json();\n              if (data.profile && data.profile.userId && data.profile.userName) {\n                localStorage.setItem('zerodha_client_id', data.profile.userId);\n                localStorage.setItem('zerodha_user_name', data.profile.userName);\n                setZerodhaClientId(data.profile.userId);\n                setZerodhaUserName(data.profile.userName);\n                setZerodhaProfileData(data.profile);\n                console.log('✅ [ZERODHA] Profile fetched and saved:', data.profile.userId);\n              }\n            }\n          } catch (error) {\n            console.error('❌ [ZERODHA] Failed to fetch profile:', error);\n          }\n        };\n        fetchZerodhaProfile();\n      }\n    }\n  }, [zerodhaAccessToken]);\n\n  // Handle Zerodha OAuth callback from URL (popup communication)\n  useEffect(() => {\n    const handleZerodhaCallback = async () => {\n      console.log('🔷 [ZERODHA] Checking URL for callback token...');\n      const params = new URLSearchParams(window.location.search);\n      const zerodhaToken = params.get("zerodha_token");\n      console.log('🔷 [ZERODHA] Token in URL:', zerodhaToken ? '✅ FOUND' : '❌ NOT FOUND');\n      \n      if (zerodhaToken) {\n        console.log('✅ [ZERODHA] Token received in URL:', zerodhaToken.substring(0, 20) + '...');\n        localStorage.setItem("zerodha_token", zerodhaToken); document.cookie = `zerodha_token=${zerodhaToken}; path=/; SameSite=Lax; Secure`; setZerodhaAccessToken(zerodhaToken); setZerodhaIsConnected(true);\n        setZerodhaAccessToken(zerodhaToken);\n        setZerodhaIsConnected(true);\n        \n        // Notify parent window if this is a popup\n        if (window.opener) {\n          console.log("📡 Sending token to opener:", window.opener.location.origin); window.opener.postMessage({ type: "ZERODHA_TOKEN", token: zerodhaToken }, "*");\n          console.log('📡 Sent token to parent window');\n        }\n        \n        // Fetch trades\n        setTimeout(() => {\n          setZerodhaTradesLoading(true);\n          fetch("/api/broker/zerodha/trades", {\n            headers: { "Authorization": `Bearer ${zerodhaToken}` }\n          })\n            .then(res => res.json())\n            .then(data => {\n              setZerodhaTradesData(data.trades || []);\n              setZerodhaTradesDialog(true);\n              console.log('✅ Zerodha trades fetched:', data.trades?.length);\n              \n              // Close popup after trades loaded\n              if (window.opener) {\n                setTimeout(() => window.close(), 2000);\n              }\n            })\n            .catch(err => console.error("Error fetching Zerodha trades:", err))\n            .finally(() => setZerodhaTradesLoading(false));\n        }, 300);\n        \n        window.history.replaceState({}, document.title, window.location.pathname);\n      }\n    };\n    \n    handleZerodhaCallback();\n  }, []);\n\n  // Listen for messages from popup windows\n  useEffect(() => {\n    const handleMessage = (event: MessageEvent) => {\n      console.log("📡 [MESSAGE] Received message:", event.data.type, event.data);\n      \n      if (event.data.type === 'ANGELONE_AUTH_SUCCESS' && event.data.token) {\n        const token = event.data.token;\n        console.log('✅ [ANGELONE] Token received from popup:', token.substring(0, 20) + '...');\n        \n        localStorage.setItem("angelone_token", token);\n        if (event.data.feedToken) localStorage.setItem("angelone_feed_token", event.data.feedToken);\n        if (event.data.refreshToken) localStorage.setItem("angelone_refresh_token", event.data.refreshToken);\n        if (event.data.clientCode) localStorage.setItem("angelone_client_code", event.data.clientCode);\n        \n        document.cookie = `angelone_token=${token}; path=/; SameSite=Lax; Secure`;\n        setAngelOneAccessToken(token);\n        setAngelOneIsConnected(true);\n        setShowConnectDialog(false);\n        \n        console.log('✅ [ANGELONE] Connection established and saved to localStorage');\n      } else if (event.data.type === 'ZERODHA_TOKEN' && event.data.token) {\n        const token = event.data.token;\n        console.log('✅ [ZERODHA] Token received from popup:', token.substring(0, 20) + '...');\n        \n        localStorage.setItem("zerodha_token", token); document.cookie = `zerodha_token=${token}; path=/; SameSite=Lax; Secure`; setZerodhaAccessToken(token); setZerodhaIsConnected(true);\n        setZerodhaAccessToken(token);\n        setZerodhaIsConnected(true);\n        setShowConnectDialog(false);\n        console.log('✅ [ZERODHA] Connection established and saved to localStorage');\n        \n        // Fetch trades\n        setTimeout(() => {\n          // Also fetch profile\n          fetch("/api/broker/zerodha/profile", {\n            headers: { "Authorization": `Bearer ${token}` }\n          })\n            .then(res => res.json())\n            .then(data => {\n              if (data.profile) {\n                setZerodhaProfileData(data.profile);\n                setZerodhaClientId(data.profile.userId);\n                setZerodhaUserName(data.profile.userName);\n                localStorage.setItem("zerodha_client_id", data.profile.userId);\n                localStorage.setItem("zerodha_user_name", data.profile.userName);\n                console.log('✅ [ZERODHA] Profile fetched:', data.profile.email);\n              }\n            })\n            .catch(err => console.error("❌ [ZERODHA] Error fetching profile:", err));\n\n          console.log('📡 [ZERODHA] Fetching trades with token...');\n          setZerodhaTradesLoading(true);\n          fetch("/api/broker/zerodha/trades", {\n            headers: { "Authorization": `Bearer ${token}` }\n          })\n            .then(res => res.json())\n            .then(data => {\n              setZerodhaTradesData(data.trades || []);\n              setZerodhaTradesDialog(true);\n              console.log('✅ [ZERODHA] Trades fetched:', data.trades?.length || 0, 'trades');\n            })\n            .catch(err => {\n              console.error("❌ [ZERODHA] Error fetching trades:", err);\n            })\n            .finally(() => setZerodhaTradesLoading(false));\n        }, 300);\n      } else if (event.data.type === 'ZERODHA_ERROR') {\n        console.error('❌ [ZERODHA] Error from callback:', event.data.error);\n        alert('Zerodha error: ' + event.data.error);\n      } else if (event.data.type === 'DHAN_TOKEN' && event.data.token) {\n        const token = event.data.token;\n        console.log('🔵 [DHAN] Token received from popup:', token.substring(0, 20) + '...');\n        \n        localStorage.setItem("dhan_token", token);\n        localStorage.setItem("dhan_token", token);\n        localStorage.setItem("dhan_user_id", "dhan_user");\n        localStorage.setItem("dhan_user_name", "Dhan Account");\n        document.cookie = `dhan_token=${token}; path=/; SameSite=Lax; Secure`;\n        setDhanIsConnected(true);\n        setShowConnectDialog(false);\n        console.log('✅ [DHAN] Connection established and saved to localStorage');\n      } else if (event.data.type === 'ANGEL_ONE_TOKEN' && event.data.token) {\n        const token = event.data.token;\n        console.log('🔶 [ANGEL ONE] Token received from popup:', token.substring(0, 20) + '...');\n        \n        localStorage.setItem("angel_one_token", token);\n        document.cookie = `angel_one_token=${token}; path=/; SameSite=Lax; Secure`;\n        setAngelOneAccessToken(token);\n        setAngelOneIsConnected(true);\n        setShowConnectDialog(false);\n        console.log('✅ [ANGEL ONE] Connection established and saved to localStorage');\n      } else if (event.data.type === 'ANGEL_ONE_ERROR') {\n        console.error('❌ [ANGEL ONE] Error from callback:', event.data.error);\n        alert('Angel One error: ' + event.data.error);\n      } else if (event.data.type === 'DHAN_ERROR') {\n        console.error('❌ [DHAN] Error from callback:', event.data.error);\n        alert('Dhan error: ' + event.data.error);\n      }\n    };\n    \n    window.addEventListener('message', handleMessage);\n    return () => window.removeEventListener('message', handleMessage);\n  }, []);\n\n  const handleZerodhaConnect = async () => {\n    try {\n      console.log('🔷 Starting Zerodha OAuth flow...');\n      const response = await fetch('/api/broker/zerodha/login-url');\n      const data = await response.json();\n      \n      if (data.error) {\n        alert('Setup Error:\n' + data.message + '\n\nSteps to fix:\n1. Go to https://developers.kite.trade\n2. Click your app\n3. Find "Redirect URL" and register:\nhttps://YOUR_APP_DOMAIN/api/broker/zerodha/callback\n4. Save and try again');\n        return;\n      }\n      \n      const { loginUrl } = data;\n      console.log('🔗 Zerodha login URL:', loginUrl);\n      \n      const popup = window.open(\n        loginUrl,\n        'zerodha_oauth',\n        'width=600,height=800,resizable=yes,scrollbars=yes'\n      );\n      \n      if (!popup) {\n        console.warn('❌ Popup blocked, falling back to main window');\n        alert('Popup blocked. Please enable popups and try again.');\n        return;\n      }\n      \n      console.log('✅ Popup opened, waiting for OAuth callback...');\n      \n      // Monitor popup closing\n      let checkCount = 0;\n      const monitorPopup = setInterval(() => {\n        checkCount++;\n        if (popup.closed) {\n          clearInterval(monitorPopup);\n          console.log('⚠️ Zerodha popup closed');\n          return;\n        }\n        if (checkCount > 300) {\n          clearInterval(monitorPopup);\n          popup.close();\n          console.log('⚠️ Zerodha popup timeout');\n        }\n      }, 1000);\n      \n    } catch (error) {\n      console.error('❌ Zerodha error:', error);\n      alert('Error: ' + (error instanceof Error ? error.message : 'Failed to connect'));\n    }\n  };\n\n  const handleUpstoxConnect = async () => {\n    try {\n      console.log('🔵 Starting Upstox OAuth flow...');\n      const response = await fetch('/api/upstox/auth-url');\n      const data = await response.json();\n      \n      if (!data.authUrl) {\n        alert('Error: Could not generate Upstox authorization URL');\n        return;\n      }\n      \n      console.log('🔗 Upstox auth URL:', data.authUrl);\n      \n      const popup = window.open(\n        data.authUrl,\n        'upstox_oauth',\n        'width=600,height=800,resizable=yes,scrollbars=yes'\n      );\n      \n      if (!popup) {\n        console.warn('❌ Popup blocked, falling back to main window');\n        alert('Popup blocked. Please enable popups and try again.');\n        return;\n      }\n      \n      console.log('✅ Upstox popup opened, waiting for OAuth callback...');\n      \n      // Listen for messages from the OAuth callback popup\n      const messageListener = (event: MessageEvent) => {\n        if (event.data.type === "UPSTOX_AUTH_SUCCESS") {\n          console.log("✅ Upstox authentication successful!");\n          localStorage.setItem("upstox_token", event.data.token);\n          localStorage.setItem("upstox_user_id", event.data.userId || "");\n          localStorage.setItem("upstox_user_email", event.data.userEmail || "");\n          localStorage.setItem("upstox_user_name", event.data.userName || "");\n          setUpstoxAccessToken(event.data.token);\n          setUpstoxIsConnected(true);\n          window.removeEventListener("message", messageListener);\n          toast({\n            title: "Success",\n            description: "Upstox connected successfully!",\n          });\n        } else if (event.data.type === "UPSTOX_AUTH_ERROR") {\n          console.error("❌ Upstox authentication failed:", event.data.error);\n          window.removeEventListener("message", messageListener);\n          toast({\n            title: "Error",\n            description: event.data.error || "Failed to authenticate with Upstox",\n            variant: "destructive",\n          });\n        }\n      };\n\n      window.addEventListener("message", messageListener);\n      \n      // Monitor popup closing and cleanup\n      let checkCount = 0;\n      const monitorPopup = setInterval(() => {\n        checkCount++;\n        if (popup.closed) {\n          clearInterval(monitorPopup);\n          window.removeEventListener("message", messageListener);\n          console.log('⚠️ Upstox popup closed');\n          return;\n        }\n        if (checkCount > 300) {\n          clearInterval(monitorPopup);\n          window.removeEventListener("message", messageListener);\n          popup.close();\n          console.log('⚠️ Upstox popup timeout');\n        }\n      }, 1000);\n      \n    } catch (error) {\n      console.error('❌ Upstox error:', error);\n      alert('Error: ' + (error instanceof Error ? error.message : 'Failed to connect to Upstox'));\n    }\n  };\n\n  const handleUpstoxDisconnect = async () => {\n    try {\n      const token = upstoxAccessToken;\n      if (!token) {\n        // No token to revoke, just clear locally\n        localStorage.removeItem("upstox_token");\n        localStorage.removeItem("upstox_user_id");\n        localStorage.removeItem("upstox_user_email");\n        localStorage.removeItem("upstox_user_name");\n        setUpstoxAccessToken(null);\n        setUpstoxIsConnected(false);\n        return;\n      }\n\n      // Call Upstox logout API\n      const response = await fetch('https://api.upstox.com/v2/logout', {\n        method: 'DELETE',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json',\n          'Authorization': `Bearer ${token}`\n        }\n      });\n\n      console.log('🔵 Upstox logout response:', response.status);\n      \n      // Clear local storage regardless of API response\n      localStorage.removeItem("upstox_token");\n      localStorage.removeItem("upstox_user_id");\n      localStorage.removeItem("upstox_user_email");\n      localStorage.removeItem("upstox_user_name");\n      setUpstoxAccessToken(null);\n      setUpstoxIsConnected(false);\n    } catch (error) {\n      console.error('❌ Upstox disconnect error:', error);\n      // Clear local storage even if API call fails\n      localStorage.removeItem("upstox_token");\n      localStorage.removeItem("upstox_user_id");\n      localStorage.removeItem("upstox_user_email");\n      localStorage.removeItem("upstox_user_name");\n      setUpstoxAccessToken(null);\n      setUpstoxIsConnected(false);\n    }\n  };\n\n  const handleAngelOneConnect = async () => {\n    try {\n      console.log("🔶 Attempting Angel One auto-login (web scraping)...");\n      \n      // Try auto-login first (uses backend credentials + TOTP)\n      const autoLoginResponse = await fetch("/api/angelone/auto-login", {\n        method: "POST",\n        headers: { "Content-Type": "application/json" }\n      });\n      \n      const autoLoginData = await autoLoginResponse.json();\n      \n      if (autoLoginData.success && autoLoginData.token && autoLoginData.feedToken) {\n        console.log("✅ [ANGEL ONE] Auto-login successful! Using backend credentials...");\n        localStorage.setItem("angel_one_token", autoLoginData.token);\n        localStorage.setItem("angel_one_refresh_token", autoLoginData.refreshToken || "");\n        localStorage.setItem("angel_one_feed_token", autoLoginData.feedToken);\n        localStorage.setItem("angel_one_client_code", autoLoginData.clientCode);\n        setAngelOneAccessToken(autoLoginData.token);\n        setAngelOneIsConnected(true);\n        toast({ title: "Success", description: `Connected to Angel One (${autoLoginData.clientCode})` });\n        return;\n      }\n      \n      console.log("⚠️ Auto-login failed, checking status endpoint...");\n      const response = await fetch("/api/angelone/status");\n      const data = await response.json();\n      \n      if (data.isConnected && data.token && data.feedToken) {\n        console.log("✅ [ANGEL ONE] Using status endpoint tokens!");\n        localStorage.setItem("angel_one_token", data.token);\n        localStorage.setItem("angel_one_refresh_token", data.refreshToken || "");\n        localStorage.setItem("angel_one_feed_token", data.feedToken);\n        localStorage.setItem("angel_one_client_code", data.clientCode || "P176266");\n        setAngelOneAccessToken(data.token);\n        setAngelOneIsConnected(true);\n        toast({ title: "Success", description: `Connected to Angel One (${data.clientCode || "P176266"})` });\n        return;\n      }\n      \n      console.log("⚠️ No tokens available, attempting popup OAuth...");\n      const authResponse = await fetch("/api/angelone/auth-url");\n      const authData = await authResponse.json();\n      \n      if (!authData.authUrl) {\n        toast({ variant: "destructive", title: "Error", description: "Could not generate authorization URL" });\n        return;\n      }\n      \n      console.log("🔗 Angel One auth URL generated");\n      \n      const popup = window.open(\n        authData.authUrl,\n        "angel_one_oauth",\n        "width=600,height=800,resizable=yes,scrollbars=yes"\n      );\n      \n      if (!popup) {\n        toast({ variant: "destructive", title: "Error", description: "Popup blocked. Please enable popups and try again." });\n        return;\n      }\n      \n      console.log("✅ Angel One popup opened, waiting for authentication...");\n      \n      const messageListener = (event: MessageEvent) => {\n        if (event.data.type === "ANGELONE_AUTH_SUCCESS") {\n          console.log("✅ [ANGEL ONE] Successfully authenticated via popup!");\n          localStorage.setItem("angel_one_token", event.data.token);\n          localStorage.setItem("angel_one_refresh_token", event.data.refreshToken);\n          localStorage.setItem("angel_one_feed_token", event.data.feedToken);\n          localStorage.setItem("angel_one_client_code", event.data.clientCode);\n          setAngelOneAccessToken(event.data.token);\n          setAngelOneIsConnected(true);\n          window.removeEventListener("message", messageListener);\n          clearInterval(monitorPopupRef);\n          toast({ title: "Success", description: `Connected to Angel One (${event.data.clientCode})` });\n        } else if (event.data.type === "ANGELONE_AUTH_ERROR") {\n          console.error("❌ Angel One error:", event.data.error);\n          window.removeEventListener("message", messageListener);\n          clearInterval(monitorPopupRef);\n          toast({ variant: "destructive", title: "Error", description: event.data.error || "Authentication failed" });\n        }\n      };\n      \n      window.addEventListener("message", messageListener);\n      \n      let checkCount = 0;\n      const monitorPopupRef = setInterval(() => {\n        checkCount++;\n        if (popup.closed) {\n          clearInterval(monitorPopupRef);\n          window.removeEventListener("message", messageListener);\n          console.log("⚠️ Angel One popup closed");\n          return;\n        }\n        if (checkCount > 300) {\n          clearInterval(monitorPopupRef);\n          window.removeEventListener("message", messageListener);\n          popup.close();\n          toast({ variant: "destructive", title: "Error", description: "Authentication timeout" });\n        }\n      }, 100);\n      \n    } catch (error) {\n      console.error("❌ Angel One error:", error);\n      toast({ variant: "destructive", title: "Error", description: error instanceof Error ? error.message : "Failed to connect" });\n    }\n  };\n\n  const handleAngelOneConnect_OLD = async () => {\n    try {\n      console.log('🔶 Starting Angel One OAuth flow...');\n      const response = await fetch('/api/angel-one/auth-url');\n      const data = await response.json();\n      \n      if (!data.authUrl) {\n        alert('Error: Could not generate Angel One authorization URL');\n        return;\n      }\n      \n      console.log('🔗 Angel One auth URL:', data.authUrl);\n      \n      const popup = window.open(\n        data.authUrl,\n        'angel_one_oauth',\n        'width=600,height=800,resizable=yes,scrollbars=yes'\n      );\n      \n      if (!popup) {\n        console.warn('❌ Popup blocked');\n        alert('Popup blocked. Please enable popups and try again.');\n        return;\n      }\n      \n      console.log('✅ Angel One popup opened, polling for authentication...');\n      \n      let checkCount = 0;\n      const pollAuthStatus = setInterval(async () => {\n        checkCount++;\n        \n        if (popup.closed) {\n          clearInterval(pollAuthStatus);\n          console.log('⚠️ Angel One popup closed by user');\n          return;\n        }\n        \n        try {\n          const statusResponse = await fetch('/api/angel-one/status');\n          const status = await statusResponse.json();\n          \n          if (status.authenticated && status.accessToken) {\n            console.log('✅ [ANGEL ONE] Authenticated! Token received:', status.accessToken.substring(0, 20) + '...');\n            clearInterval(pollAuthStatus);\n            \n            // STORE TOKEN AND UPDATE STATE\n            localStorage.setItem('angel_one_token', status.accessToken);\n            localStorage.setItem('angel_one_client_code', status.clientCode || 'P176266');\n            document.cookie = `angel_one_token=${status.accessToken}; path=/; max-age=86400`;\n            \n            setAngelOneAccessToken(status.accessToken);\n            setAngelOneIsConnected(true);\n            \n            console.log('💾 Stored Angel One token in localStorage and cookies');\n            \n            popup.close();\n            setConnectDialogOpen(false);\n            return;\n          }\n        } catch (err) {\n          console.debug('🔶 [ANGEL ONE] Status polling...');\n        }\n        \n        if (checkCount > 300) {\n          clearInterval(pollAuthStatus);\n          popup.close();\n          console.log('⚠️ Angel One timeout');\n          alert('Angel One login timeout. Please try again.');\n        }\n      }, 1000);\n      \n    } catch (error) {\n      console.error('❌ Angel One error:', error);\n      alert('Error: ' + (error instanceof Error ? error.message : 'Failed to connect'));\n    }\n  };\n\n  const handleDhanConnect = async () => {\n    try {\n      console.log('🔵 Starting Dhan OAuth flow...');\n      const response = await fetch('/api/broker/dhan/login-url');\n      const data = await response.json();\n      \n      if (data.error) {\n        alert('Setup Error:\n' + data.error);\n        return;\n      }\n      \n      const { loginUrl } = data;\n      console.log('🔗 Dhan login URL:', loginUrl);\n      \n      const popup = window.open(\n        loginUrl,\n        'dhan_oauth',\n        'width=600,height=800,resizable=yes,scrollbars=yes'\n      );\n      \n      if (!popup) {\n        console.warn('❌ Popup blocked');\n        alert('Popup blocked. Please enable popups and try again.');\n        return;\n      }\n      \n      console.log('✅ Popup opened, waiting for OAuth callback...');\n      \n      let checkCount = 0;\n      const monitorPopup = setInterval(() => {\n        checkCount++;\n        if (popup.closed) {\n          clearInterval(monitorPopup);\n          console.log('⚠️ Dhan popup closed');\n          return;\n        }\n        if (checkCount > 300) {\n          clearInterval(monitorPopup);\n          popup.close();\n          console.log('⚠️ Dhan popup timeout');\n        }\n      }, 1000);\n      \n    } catch (error) {\n      console.error('❌ Dhan error:', error);\n      alert('Error: ' + (error instanceof Error ? error.message : 'Failed to connect'));\n    }\n  };\n\n  const handleRevokeZerodha = () => {\n    localStorage.removeItem("zerodha_token"); document.cookie = "zerodha_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";\n    setZerodhaAccessToken(null);\n    setZerodhaIsConnected(false);\n    setZerodhaTradesData([]);\n    console.log('🔓 Zerodha connection revoked');\n  };\n\n  const handleFetchZerodhaTrades = async () => {\n    if (!zerodhaAccessToken) {\n      alert('Please connect to Zerodha first');\n      return;\n    }\n    \n    setZerodhaTradesLoading(true);\n    try {\n      const response = await fetch('/api/broker/zerodha/trades', {\n        headers: { 'Authorization': `Bearer ${zerodhaAccessToken}` }\n      });\n      const { trades } = await response.json();\n      setZerodhaTradesData(trades);\n      setZerodhaTradesDialog(true);\n    } catch (error) {\n      console.error('Error fetching trades:', error);\n      alert('Failed to fetch trades');\n    } finally {\n      setZerodhaTradesLoading(false);\n    }\n  };\n  const [parseErrors, setParseErrors] = useState<ParseError[]>([]);\n  const [isBuildMode, setIsBuildMode] = useState(false);\n\n  // Define the format type with position-based structure (supports multiple positions per field)\n  type FormatData = {\n    id?: string;  // Unique ID for the format (generated on save)\n    label?: string;  // Human-readable label for display\n    sampleLine: string;  // Original first line of trade data\n    positions: {\n      time: number[];  // Array of positions\n      order: number[];\n      symbol: number[];\n      type: number[];\n      qty: number[];\n      price: number[];\n    };\n    // Keep string values for display in build table\n    displayValues: {\n      time: string;\n      order: string;\n      symbol: string;\n      type: string;\n      qty: string;\n      price: string;\n    };\n  };\n\n  // Define ParseResult type for trade parsing\n  type ParseResult = {\n    trades: any[];\n    errors: ParseError[];\n  };\n\n  const [buildModeData, setBuildModeData] = useState<FormatData>({\n    sampleLine: "",\n    positions: {\n      time: [],\n      order: [],\n      symbol: [],\n      type: [],\n      qty: [],\n      price: []\n    },\n    displayValues: {\n      time: "",\n      order: "",\n      symbol: "",\n      type: "",\n      qty: "",\n      price: ""\n    }\n  });\n  const [brokerSearchInput, setBrokerSearchInput] = useState("");\n  const [showBrokerSuggestions, setShowBrokerSuggestions] = useState(false);\n  const [availableBrokers, setAvailableBrokers] = useState<string[]>([\n    // Top Discount Brokers\n    "Zerodha", "Groww", "Angel One", "Upstox", "5paisa", "Fyers", "Paytm Money", "Alice Blue",\n    "Shoonya by Finvasia", "Samco Securities", "Motilal Oswal",\n\n    // Crypto Exchanges & Brokers\n    "Coinbase", "Kraken", "Binance", "Delta Exchange", "WazirX", "Bybit", "OKX", "Huobi",\n    "Kucoin", "FTX", "Gemini", "Bitstamp", "Upbit", "Bithumb", "Crypto.com", "Bitcoin India",\n    "CoinDCX", "Zebpay", "BTCXIndia", "Unocoin", "BTCXINDIA", "Paxful", "LocalBitcoins", "Coinswitch",\n\n    // Full-Service Brokers\n    "ICICI Securities", "HDFC Securities", "Kotak Securities", "Axis Securities",\n    "SBI Securities", "Sharekhan", "IIFL Securities", "JM Financial",\n    "Geojit Financial", "Edelweiss Broking", "Religare Broking", "Centrum Broking",\n\n    // Bank-Integrated Brokers\n    "YES Bank Securities", "IDBI Bank Securities", "RBL Bank", "Aditya Birla Money",\n    "Federal Bank Securities", "Bandhan Bank Securities",\n\n    // Other Established Brokers\n    "Arihant Capital", "Ashika Stock Broking", "Augment Financial", "B. D. Ranka",\n    "Bhavik Shares & Stock Brokers", "Bombay Bullion", "Bosch Stock Broking",\n    "BrightMoney", "Brokerking", "CARE Broking", "Choice Equities", "Cityline Stock Brokers",\n    "Claire Equity", "Clearly Brokerage", "D. A. Stock Broking", "Deepak Stock Brokers",\n    "Dhanraj Brokers", "Dharwani Equities", "DHI Finance", "Dolat Brokerage",\n    "Edelweiss Private", "ERM Stock Brokers", "Equity Infotech", "Euro Exim Securities",\n    "Exclusive Equities", "Federal Bank Broking", "Fimpro Financial", "Fincare Stock Broking",\n    "Finquest Securities", "Finvasia", "Fiscal Broking", "Flat Securities",\n    "Flipstone Consultancy", "Fortis Broking", "Forward Broking", "Fortwell Equities",\n    "Four Stone Consultants", "Frances Commodities", "Franklin Securities", "Gajjar Securities",\n    "Ganesh Securities", "Garuda Capstock", "Gaurav Stock Brokers", "GCL Securities",\n    "Genesis Broking", "Geo Securities", "Ginodia Stock Brokers", "Global Capital",\n    "Global Equities", "Global Funds", "Global Securities", "Globe Brokers",\n    "Glorious Capital", "Good Sign Equities", "Grand Finserve", "Grapes Broking",\n    "Gravesham Broking", "Grin Broking", "GT Securities", "Guide Stock Brokers",\n    "Gulimex Broking", "Gumption Securities", "Gupta Securities", "Guru Arjun Consultants",\n    "Gurukul Equities", "Gyan Capital", "Gyan Securities", "H. R. Equities",\n    "Harsh Broking", "Harveys Broking", "Hasib Securities", "Haycroft Broking",\n    "Helix Securities", "H Equities", "Heritage Broking", "Heston Brokers",\n    "Hi-Tech Securities", "Hi-Wealth Stock Brokers", "Himalayan Equities", "Himalaya Capital",\n    "Hind Securities", "Hindsight Broking", "Hippo Broking", "Hoho Equities",\n    "Holistic Investments", "Holmes Broking", "Home Capital", "Homestead Equities",\n    "Honing Brokers", "Horizon Equities", "Horizon Securities", "Horizo Broking",\n    "Horseplay Broking", "Hot Stock Brokers", "House of Brokers", "Houston Capital",\n    "Hovercraft Brokers", "Howdy Equities", "Hullark Brokers", "Hullabaloo Capital",\n    "Humana Securities", "Humble Brokers", "Humidor Equities", "Humility Securities",\n    "Humor Capital", "Hump Day Brokers", "Huntec Capital", "Huntsman Equities",\n    "Hurdles Broking", "Hurray Securities", "Hurricane Capital", "Hurried Brokers",\n    "Hurtling Equities", "Husband Broking", "Hush Capital", "Hustle Brokers",\n    "Hustlers Equities", "Hut Stock Brokers", "Hydrogen Capital", "Hyped Equities",\n    "Hype Broking", "Hypothesis Capital", "Hyundai Securities", "Hyve Broking",\n\n    // Indian Stock Brokers (Additional)\n    "Invested", "Indiabulls Securities", "IIFL Wealth", "IndiaMart Securities",\n    "Jagjeet Stock Brokers", "Jaiprakash Securities", "Jal Stock Broking", "Jalamar Brokers",\n    "Jalata Equities", "Jamboree Capital", "Jambul Brokers", "Jamestown Securities",\n    "Jan Capital", "Janata Broking", "Janglee Equities", "Janitor Securities",\n    "Jannat Capital", "Janta Brokers", "Jaswant Broking", "Jata Securities",\n    "Jayant Brokers", "Jayesh Equities", "Jayesh Securities", "Jb Capital",\n    "Jdm Securities", "Jeera Broking", "Jeeva Equities", "Jehandad Capital",\n    "Jen Stock Broking", "Jenco Securities", "Jericho Brokers", "Jerkin Equities",\n    "Jeroboam Capital", "Jerry's Broking", "Jet Brokers", "Jetpack Securities",\n    "Jetta Capital", "Jetton Equities", "Jewell Securities", "Jfc Capital",\n    "Jha Stock Brokers", "Jhon Broking", "Jhoti Securities", "Jhunjhunwala Brokers",\n    "Jig Securities", "Jigsaw Brokers", "Jihad Capital", "Jila Equities",\n    "Jill's Broking", "Jilt Securities", "Jimbo Brokers", "Jimnastic Capital",\n    "Jimmy's Equities", "Jin Capital", "Jingle Broking", "Jingle Bells Securities",\n    "Jingle Jangle Brokers", "Jingly Equities", "Jingoism Capital", "Jinxed Securities",\n    "Jirawala Brokers", "Jism Equities", "Jitney Capital", "Jitter Broking",\n    "Jittery Securities", "Jiuzhaigou Brokers", "Jive Capital", "Jive Equities",\n    "Jive Turkey Brokers", "Jiver Securities", "Jjim Capital", "Job Broking",\n    "Jobber Equities", "Jobcentre Capital", "Jobless Securities", "Jobname Brokers",\n    "Jobsworth Equities", "Jock Capital", "Jockey Broking", "Jockeys Securities",\n    "Jocular Brokers", "Jocund Equities", "Jodeci Capital", "Jodhpur Securities",\n    "Jodhpurs Broking", "Jodi Brokers", "Joe Capital", "Joes Equities",\n    "Joey's Broking", "Joeys Securities", "Jog Capital", "Jogee Brokers",\n    "Jogging Equities", "Joggs Securities", "Joghurt Capital", "Jogles Broking",\n    "John Deere Brokers", "John Equities", "Johns Capital", "Johnny Broking",\n    "Johnny's Securities", "Johnnys Brokers", "Johny's Capital", "Join Equities",\n    "Joined Securities", "Joining Capital", "Joins Broking", "Joint Equities",\n    "Joint Venture Securities", "Jointed Brokers", "Jointless Capital", "Joists Equities",\n    "Joist Securities", "Joke Capital", "Joker Broking", "Jokers Equities",\n    "Jokes Securities", "Jokester Capital", "Jokily Broking", "Jokiness Equities"\n  ]);\n  const [savedFormats, setSavedFormats] = useState<Record<string, FormatData>>({});\n  const [activeFormat, setActiveFormat] = useState<FormatData | null>(null);\n  const [detectedFormatLabel, setDetectedFormatLabel] = useState<string | null>(null);\n  const [formatsLoading, setFormatsLoading] = useState(false);\n  const importDataTextareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const filteredBrokers = brokerSearchInput.trim() \n    ? availableBrokers.filter(b => b.toLowerCase().includes(brokerSearchInput.toLowerCase()))\n    : [];\n\n  // Check if all columns are filled\n  const allColumnsFilledForSave = \n    buildModeData.positions.time.length > 0 &&\n    buildModeData.positions.order.length > 0 &&\n    buildModeData.positions.symbol.length > 0 &&\n    buildModeData.positions.type.length > 0 &&\n    buildModeData.positions.qty.length > 0 &&\n    buildModeData.positions.price.length > 0;\n\n  // Get missing columns for tooltip\n  const missingColumns = [];\n  if (buildModeData.positions.time.length === 0) missingColumns.push("Time");\n  if (buildModeData.positions.order.length === 0) missingColumns.push("Order");\n  if (buildModeData.positions.symbol.length === 0) missingColumns.push("Symbol");\n  if (buildModeData.positions.type.length === 0) missingColumns.push("Type");\n  if (buildModeData.positions.qty.length === 0) missingColumns.push("Qty");\n  if (buildModeData.positions.price.length === 0) missingColumns.push("Price");\n\n  // Helper function to save formats to Universal Broker Library AND user personal formats\n  const saveFormatToUniversalLibrary = async (formatLabel: string, format: FormatData, brokerName: string) => {\n    if (!currentUser?.userId) {\n      toast({\n        title: "Authentication Required",\n        description: "Please log in to save formats",\n        variant: "destructive"\n      });\n      return false;\n    }\n\n    try {\n      const idToken = await getCognitoToken();\n      if (!idToken) return false;\n\n      // Generate a unique ID for this format (timestamp + random suffix)\n      const uniqueFormatId = `${brokerName}_${formatLabel}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;\n\n      // Create format with ID and label embedded\n      const formatWithMetadata: FormatData = {\n        ...format,\n        id: uniqueFormatId,\n        label: formatLabel\n      };\n\n      console.log(`💾 Saving format "${formatLabel}" to ${brokerName} library with ID: ${uniqueFormatId}`);\n      const response = await fetch('/api/broker-formats/save', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${idToken}`\n        },\n        body: JSON.stringify({\n          brokerName,\n          formatName: formatLabel,\n          sampleLine: format.sampleLine,\n          positions: format.positions,\n          displayValues: format.displayValues,\n          userId: currentUser.userId\n        })\n      });\n\n      const data = await response.json();\n      if (response.ok) {\n        console.log(`✅ Format saved to ${brokerName} library`);\n\n        // SYNC to user's personal formats for live preview\n        // Use unique ID as key to prevent overwriting existing formats with same label\n        const updatedFormats = {\n          ...savedFormats,\n          [uniqueFormatId]: formatWithMetadata\n        };\n        setSavedFormats(updatedFormats);\n\n        // Also set this as the active format immediately\n        setActiveFormat(formatWithMetadata);\n        setDetectedFormatLabel(formatLabel);\n\n        // Save to user's personal formats backend\n        const userFormatsResponse = await fetch(`/api/user-formats/${currentUser.userId}`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${idToken}`\n          },\n          body: JSON.stringify(updatedFormats)\n        });\n\n        if (userFormatsResponse.ok) {\n          console.log(`✅ Format also synced to personal formats for live preview`);\n        }\n\n        toast({\n          title: "Format Saved Successfully",\n          description: `Your format "${formatLabel}" has been saved to the ${brokerName} library!`\n        });\n        return true;\n      } else {\n        console.error("❌ Failed to save format:", data.error);\n        toast({\n          title: "Save Failed",\n          description: data.error || "Failed to save format to library",\n          variant: "destructive"\n        });\n        return false;\n      }\n    } catch (error) {\n      console.error("❌ Error saving format:", error);\n      toast({\n        title: "Network Error",\n        description: "Could not connect to server",\n        variant: "destructive"\n      });\n      return false;\n    }\n  };\n\n\n  // Load user's saved formats from AWS when user is authenticated\n  useEffect(() => {\n    const loadUserFormats = async () => {\n      console.log("🔄 loadUserFormats triggered, currentUser:", currentUser?.userId ? `userId: ${currentUser.userId}` : "NO USER");\n\n      if (!currentUser?.userId) {\n        console.log("⏳ No authenticated user, skipping format load");\n        setSavedFormats({});\n        setFormatsLoading(false);\n        return;\n      }\n\n      setFormatsLoading(true);\n      try {\n        console.log("📥 Loading user formats for userId:", currentUser.userId);\n        const idToken = await getCognitoToken();\n        if (!idToken) {\n          console.error("❌ Failed to get Cognito ID token");\n          setFormatsLoading(false);\n          return;\n        }\n\n        console.log("🔑 Got Cognito ID token, making request to /api/user-formats/", currentUser.userId);\n        const response = await fetch(`/api/user-formats/${currentUser.userId}`, {\n          headers: {\n            'Authorization': `Bearer ${idToken}`\n          }\n        });\n\n        console.log("📡 Response status:", response.status, response.statusText);\n        if (response.ok) {\n          const formats = await response.json();\n          console.log("✅ Loaded formats from AWS:", Object.keys(formats).length, "formats", formats);\n          setSavedFormats(formats);\n          if (Object.keys(formats).length > 0) {\n            console.log("📦 Formats available in dropdown:", Object.keys(formats).join(", "));\n          }\n        } else {\n          const errorText = await response.text();\n          console.log("📭 No saved formats found in AWS, status:", response.status, "error:", errorText);\n          setSavedFormats({});\n        }\n      } catch (error) {\n        console.error("❌ Error loading user formats:", error);\n        setSavedFormats({});\n      } finally {\n        setFormatsLoading(false);\n      }\n    };\n\n    loadUserFormats();\n  }, [currentUser?.userId]);\n\n  // Reload formats when import dialog opens\n  useEffect(() => {\n    if (showImportModal && currentUser?.userId) {\n      console.log("📂 Import dialog opened, reloading formats...");\n      setFormatsLoading(true);\n      // Create a function to reload formats without dependency on state\n      (async () => {\n        try {\n          const idToken = await getCognitoToken();\n          if (idToken) {\n            const response = await fetch(`/api/user-formats/${currentUser.userId}`, {\n              headers: { 'Authorization': `Bearer ${idToken}` }\n            });\n            if (response.ok) {\n              const formats = await response.json();\n              console.log("✅ Dialog opened - formats reloaded:", Object.keys(formats).length);\n              setSavedFormats(formats);\n              if (Object.keys(formats).length > 0) {\n                console.log("📦 Formats now available in dropdown:", Object.keys(formats).join(", "));\n              }\n            }\n          }\n        } catch (err) {\n          console.error("❌ Failed to reload formats on dialog open:", err);\n        } finally {\n          setFormatsLoading(false);\n        }\n      })();\n    }\n  }, [showImportModal, currentUser?.userId]);\n\n  // Track if user has manually selected a format (to avoid auto-override)\n  const [userSelectedFormatId, setUserSelectedFormatId] = useState<string | null>(null);\n\n  // Auto-apply saved formats to live preview when data is pasted\n  // BUT respect user's manual selection if they've chosen a specific format\n  useEffect(() => {\n    if (!importData.trim()) {\n      setActiveFormat(null);\n      setDetectedFormatLabel(null);\n      return;\n    }\n\n    // If user has manually selected a format, don't auto-override\n    if (userSelectedFormatId && savedFormats[userSelectedFormatId]) {\n      console.log(`🔒 Respecting user's manual format selection: ${userSelectedFormatId}`);\n      const userFormat = savedFormats[userSelectedFormatId];\n      const currentFirstLine = importData.trim().split('\n')[0];\n      const recalculatedFormat = recalculateFormatPositions(userFormat, currentFirstLine);\n      setActiveFormat(recalculatedFormat);\n      setDetectedFormatLabel(userFormat.label || userSelectedFormatId);\n      return;\n    }\n\n    // PRIORITY 1: Auto-apply first saved format only if no manual selection\n    if (Object.keys(savedFormats).length > 0 && !userSelectedFormatId) {\n      // Use the first saved format automatically for live preview\n      const firstFormatId = Object.keys(savedFormats)[0];\n      const firstFormat = savedFormats[firstFormatId];\n\n      // CRITICAL FIX: Recalculate positions based on current pasted data's first line\n      const currentFirstLine = importData.trim().split('\n')[0];\n      const recalculatedFormat = recalculateFormatPositions(firstFormat, currentFirstLine);\n\n      const displayLabel = firstFormat.label || firstFormatId;\n      console.log(`📲 Auto-applying saved format: "${displayLabel}" with recalculated positions for live preview`);\n      console.log(`   Original positions:`, firstFormat.positions);\n      console.log(`   Recalculated positions:`, recalculatedFormat.positions);\n      setActiveFormat(recalculatedFormat);\n      setDetectedFormatLabel(displayLabel);\n      return;\n    }\n\n    // PRIORITY 2: Fall back to universal library detection if no saved formats\n    const autoDetect = async () => {\n      try {\n        const firstLine = importData.trim().split('\n')[0];\n        const response = await fetch('/api/broker-formats/detect', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ firstLine })\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n          if (data.success && data.format) {\n            console.log(`🎯 Auto-detected format from universal library - ${data.brokerName}: ${data.format.formatName} (${(data.confidence * 100).toFixed(0)}% confidence)`);\n            setActiveFormat(data.format);\n            setDetectedFormatLabel(`${data.brokerName}/${data.format.formatName}`);\n          } else {\n            setActiveFormat(null);\n            setDetectedFormatLabel(null);\n          }\n        }\n      } catch (error) {\n        console.error('❌ Auto-detection error:', error);\n        setActiveFormat(null);\n        setDetectedFormatLabel(null);\n      }\n    };\n\n    autoDetect();\n  }, [importData, savedFormats, showImportModal, userSelectedFormatId]);\n\n  // Broker Import State\n  const [showBrokerImportModal, setShowBrokerImportModal] = useState(false);\n  const [selectedBrokerForImport, setSelectedBrokerForImport] = useState<string>("");\n  const [brokerCredentials, setBrokerCredentials] = useState({\n    apiKey: "",\n    apiSecret: "",\n    clientId: "",\n  });\n  const [brokerImportLoading, setBrokerImportLoading] = useState(false);\n  const [brokerImportError, setBrokerImportError] = useState("");\n\n  // Order Modal State\n  const [showOrderModal, setShowOrderModal] = useState(false);\n  const [orderTab, setOrderTab] = useState("history");\n  // Fetch broker positions when tab changes - supports all 4 brokers (Zerodha, Upstox, Angel One, Dhan)\n  useEffect(() => {\n    if (orderTab === "positions" && (zerodhaAccessToken || upstoxAccessToken || angelOneAccessToken || dhanAccessToken)) {\n      const fetchPositions = async () => {\n        setFetchingBrokerPositions(true);\n        try {\n          // Determine which broker is connected and get correct endpoint/token\n          let endpoint = '';\n          let token = '';\n          let broker = '';\n          \n          if (zerodhaAccessToken) {\n            endpoint = '/api/broker/zerodha/positions';\n            token = zerodhaAccessToken;\n            broker = 'Zerodha';\n          } else if (upstoxAccessToken) {\n            endpoint = '/api/broker/upstox/positions';\n            token = upstoxAccessToken;\n            broker = 'Upstox';\n          } else if (angelOneAccessToken) {\n            endpoint = '/api/broker/angelone/positions';\n            token = angelOneAccessToken;\n            broker = 'Angel One';\n          } else if (dhanAccessToken) {\n            endpoint = '/api/broker/dhan/positions';\n            token = dhanAccessToken;\n            broker = 'Dhan';\n          }\n          \n          if (!endpoint || !token) return;\n          \n          const res = await fetch(endpoint, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          });\n          const data = await res.json();\n          let positions = data.positions || [];\n\n          // Fetch live prices for each position from WebSocket stream\n          if (positions.length > 0) {\n            const livePositions = await Promise.all(\n              positions.map(async (pos: any) => {\n                try {\n                  const symbol = pos.symbol || '';\n                  const liveRes = await fetch(`/api/live-quotes/NSE:${symbol}-EQ`);\n                  if (liveRes.ok) {\n                    const liveData = await liveRes.json();\n                    return {\n                      ...pos,\n                      currentPrice: liveData.price || pos.currentPrice || pos.current_price || 0\n                    };\n                  }\n                } catch (err) {\n                  console.warn(`⚠️ [LIVE-PRICE] Could not fetch live price for ${pos.symbol}`);\n                }\n                return pos;\n              })\n            );\n            positions = livePositions;\n          }\n\n          setBrokerPositions(positions);\n          console.log('✅ [POSITIONS]', broker, 'Fetched', positions.length, 'positions with live prices via WebSocket');\n        } catch (err) {\n          console.error('❌ [POSITIONS] Error fetching positions:', err);\n          setBrokerPositions([]);\n        } finally {\n          setFetchingBrokerPositions(false);\n        }\n      };\n\n      // Fetch positions immediately when tab opens\n      fetchPositions();\n\n      // Set up polling to refresh every 700ms while tab is open\n      const pollInterval = setInterval(fetchPositions, 700);\n\n      // Cleanup: clear interval when tab changes\n      return () => clearInterval(pollInterval);\n    }\n  }, [zerodhaAccessToken, upstoxAccessToken, angelOneAccessToken, dhanAccessToken, orderTab]);\n  const [brokerOrders, setBrokerOrders] = useState<any[]>([]);\n  const [fetchingBrokerOrders, setFetchingBrokerOrders] = useState(false);\n  const [brokerPositions, setBrokerPositions] = useState<any[]>([]);\n  const [fetchingBrokerPositions, setFetchingBrokerPositions] = useState(false);\n  const [orderData, setOrderData] = useState({\n    symbol: "",\n    action: "Buy",\n    orderType: "Market",\n    quantity: "",\n    price: "",\n    stopLoss: "",\n    target: "",\n  });\n  const previousBrokerOrdersLengthRef = useRef<number>(0);\n  const previousCompleteOrdersLengthRef = useRef<number>(0);\n\n  // Save Confirmation Dialog State\n  const [showSaveConfirmation, setShowSaveConfirmation] = useState(false);\n  const [saveConfirmationData, setSaveConfirmationData] = useState<any>(null);\n\n  // Trade History Data State\n  const [tradeHistoryData, setTradeHistoryData] = useState([]);\n\n  // Fetch broker orders when Orders dialog opens - supports all 4 brokers (Zerodha, Upstox, Angel One, Dhan)\n  useEffect(() => {\n    if (orderTab === 'history' && (zerodhaAccessToken || upstoxAccessToken || angelOneAccessToken || dhanAccessToken)) {\n      const fetchOrders = async () => {\n        setFetchingBrokerOrders(true);\n        try {\n          // Determine which broker is connected and get correct endpoint/token\n          let endpoint = '';\n          let token = '';\n          let broker = '';\n          \n          if (zerodhaAccessToken) {\n            endpoint = '/api/broker/zerodha/trades';\n            token = zerodhaAccessToken;\n            broker = 'Zerodha';\n          } else if (upstoxAccessToken) {\n            endpoint = '/api/broker/upstox/trades';\n            token = upstoxAccessToken;\n            broker = 'Upstox';\n          } else if (angelOneAccessToken) {\n            endpoint = '/api/broker/angelone/trades';\n            token = angelOneAccessToken;\n            broker = 'Angel One';\n          } else if (dhanAccessToken) {\n            endpoint = '/api/broker/dhan/trades';\n            token = dhanAccessToken;\n            broker = 'Dhan';\n          }\n          \n          if (!endpoint || !token) return;\n          \n          const res = await fetch(endpoint, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          });\n          const data = await res.json();\n          setBrokerOrders(data.trades || []);\n          console.log('✅ [ORDERS]', broker, 'Fetched', (data.trades || []).length, 'trades');\n        } catch (err) {\n          console.error('❌ [ORDERS] Error fetching trades:', err);\n          setBrokerOrders([]);\n        } finally {\n          setFetchingBrokerOrders(false);\n        }\n      };\n\n      // Fetch orders immediately when dialog opens\n      fetchOrders();\n\n      // Set up polling to refresh every 1 second while dialog is open\n      const pollInterval = setInterval(fetchOrders, 1000);\n\n      // Cleanup: clear interval when dialog closes\n      return () => clearInterval(pollInterval);\n    }\n  }, [zerodhaAccessToken, upstoxAccessToken, angelOneAccessToken, dhanAccessToken, orderTab]);\n// Fetch broker funds when dialog opens - with auto-refresh polling\n  useEffect(() => {\n    if (showOrderModal && (zerodhaAccessToken || upstoxAccessToken)) {\n      const fetchBrokerFunds = async () => {\n        try {\n          const endpoint = zerodhaAccessToken ? '/api/broker/zerodha/margins' : '/api/broker/upstox/margins';\n          const token = zerodhaAccessToken || upstoxAccessToken;\n          const response = await fetch(endpoint, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          });\n          const data = await response.json();\n          if (response.ok && data.success && data.availableCash !== undefined) {\n            setBrokerFunds(data.availableCash);\n            localStorage.setItem("zerodha_broker_funds", data.availableCash.toString());\n            console.log('✅ [BROKER] Fetched available funds:', data.availableCash);\n          } else {\n            console.error('❌ [BROKER] Failed to fetch funds:', data.error || 'Invalid response');\n            setBrokerFunds(null);\n          }\n        } catch (error) {\n          console.error('❌ [BROKER] Failed to fetch funds:', error);\n        }\n      };\n      \n      // Fetch funds immediately when dialog opens\n      fetchBrokerFunds();\n      \n      // Set up polling to refresh every 2 seconds while dialog is open\n      const pollInterval = setInterval(fetchBrokerFunds, 2000);\n      \n      // Cleanup: clear interval when dialog closes\n      return () => clearInterval(pollInterval);\n    }\n  }, [showOrderModal, zerodhaAccessToken]);\n\n  // Restore broker funds from localStorage on mount when Zerodha connected\n  useEffect(() => {\n    if (zerodhaAccessToken && !brokerFunds) {\n      const saved = localStorage.getItem("zerodha_broker_funds");\n      if (saved) {\n        setBrokerFunds(parseFloat(saved));\n      }\n    }\n  }, [zerodhaAccessToken, brokerFunds]);\n\n  // Fetch broker funds when dialog opens - supports all 4 brokers (Zerodha, Upstox, Angel One, Dhan)\n  useEffect(() => {\n    if (showOrderModal && (zerodhaAccessToken || upstoxAccessToken || angelOneAccessToken || dhanAccessToken)) {\n      const fetchBrokerFunds = async () => {\n        try {\n          // Determine which broker is connected\n          let endpoint = '';\n          let token = '';\n          let broker = '';\n          \n          if (zerodhaAccessToken) {\n            endpoint = '/api/broker/zerodha/margins';\n            token = zerodhaAccessToken;\n            broker = 'Zerodha';\n          } else if (upstoxAccessToken) {\n            endpoint = '/api/broker/upstox/margins';\n            token = upstoxAccessToken;\n            broker = 'Upstox';\n          } else if (angelOneAccessToken) {\n            endpoint = '/api/broker/angelone/margins';\n            token = angelOneAccessToken;\n            broker = 'Angel One';\n          } else if (dhanAccessToken) {\n            endpoint = '/api/broker/dhan/margins';\n            token = dhanAccessToken;\n            broker = 'Dhan';\n          }\n          \n          if (!endpoint || !token) return;\n          \n          const response = await fetch(endpoint, {\n            headers: { 'Authorization': `Bearer ${token}` }\n          });\n          const data = await response.json();\n          setBrokerFunds(data.availableCash || data.availableFunds || 0);\n          console.log('✅ [FUNDS]', broker, 'Fetched available funds:', data.availableCash || data.availableFunds);\n        } catch (error) {\n          console.error('❌ [FUNDS] Error fetching broker funds:', error);\n          setBrokerFunds(0);\n        }\n      };\n      \n      // Fetch funds immediately when dialog opens\n      fetchBrokerFunds();\n      \n      // Set up polling to refresh every 2 seconds while dialog is open\n      const pollInterval = setInterval(fetchBrokerFunds, 2000);\n      \n      // Cleanup: clear interval when dialog closes\n      return () => clearInterval(pollInterval);\n    }\n  }, [showOrderModal, zerodhaAccessToken, upstoxAccessToken, angelOneAccessToken, dhanAccessToken]);\n\n  // PAPER TRADING (DEMO TRADING) STATE - Like TradingView Practice Account\n  // ============================================\n  const [showPaperTradingModal, setShowPaperTradingModal] = useState(false);\n  const [showTradingChallengeModal, setShowTradingChallengeModal] = useState(false); // Trading Challenge Coming Soon modal\n  const [showJournalInfoModal, setShowJournalInfoModal] = useState<boolean | 'auto' | 'manual'>(false); // Trading Journal Info modal\n  const [hidePositionDetails, setHidePositionDetails] = useState(false); // Eye icon toggle\n  const [swipedPositionId, setSwipedPositionId] = useState<string | null>(null);\n  const swipeStartXRef = useRef<number>(0);\n  const swipeStartYRef = useRef<number>(0);\n  const [paperTradingCapital, setPaperTradingCapital] = useState(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("paperTradingCapital");\n      return stored ? parseFloat(stored) : 1800000; // 18 Lakhs default\n    }\n    return 1800000;\n  });\n\n  // Track cumulative realized P&L from all closed trades (persisted to AWS)\n  const [paperTradingRealizedPnl, setPaperTradingRealizedPnl] = useState(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("paperTradingRealizedPnl");\n      return stored ? parseFloat(stored) : 0;\n    }\n    return 0;\n  });\n\n  // Paper trading position interface\n  interface PaperPosition {\n    id: string;\n    symbol: string;\n    type: 'STOCK' | 'FUTURES' | 'OPTIONS';\n    action: 'BUY' | 'SELL';\n    quantity: number;\n    entryPrice: number;\n    currentPrice: number;\n    entryTime: string;\n    pnl: number;\n    pnlPercent: number;\n    isOpen: boolean;\n    // Stop Loss fields\n    slEnabled?: boolean;\n    slType?: 'price' | 'percent' | 'duration' | 'high' | 'low';\n    slValue?: string;\n    slTimeframe?: string;\n    slDurationUnit?: string;\n    slTriggerPrice?: number;\n    slExpiryTime?: number; // For duration-based SL\n  }\n\n  // Paper trading trade history\n  interface PaperTrade {\n    id: string;\n    symbol: string;\n    type: 'STOCK' | 'FUTURES' | 'OPTIONS';\n    action: 'BUY' | 'SELL';\n    quantity: number;\n    price: number;\n    time: string;\n    pnl?: string;\n    closedAt?: string;\n  }\n\n  const [paperPositions, setPaperPositions] = useState<PaperPosition[]>(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("paperPositions");\n      return stored ? JSON.parse(stored) : [];\n    }\n    return [];\n  });\n\n  const [paperTradeHistory, setPaperTradeHistory] = useState<PaperTrade[]>(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("paperTradeHistory");\n      return stored ? JSON.parse(stored) : [];\n    }\n    return [];\n  });\n\n  // AWS Paper Trading Sync State\n  const [paperTradingAwsLoaded, setPaperTradingAwsLoaded] = useState(false);\n  const [paperTradingAwsSaving, setPaperTradingAwsSaving] = useState(false);\n  const paperTradingSaveTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  // Load paper trading data from AWS when user is authenticated\n  const loadPaperTradingFromAWS = useCallback(async () => {\n    const userId = localStorage.getItem('currentUserId');\n    if (!userId || userId === 'null') return;\n\n    try {\n      const idToken = await getCognitoToken();\n      if (!idToken) {\n        console.log('⚠️ No Cognito token for paper trading AWS load');\n        return;\n      }\n\n      console.log('📊 Loading paper trading data from AWS for user:', userId);\n      const response = await fetch(`/api/paper-trading/${userId}`, {\n        headers: { 'Authorization': `Bearer ${idToken}` }\n      });\n\n      if (response.ok) {\n        const result = await response.json();\n        if (result.success && result.data) {\n          console.log('✅ Loaded paper trading data from AWS:', result.isNew ? '(new user, defaults)' : '');\n          setPaperTradingCapital(result.data.capital || 1800000);\n          setPaperPositions(result.data.positions || []);\n          setPaperTradeHistory(result.data.tradeHistory || []);\n          setPaperTradingRealizedPnl(result.data.realizedPnl || 0);\n          // Also update localStorage for offline access\n          localStorage.setItem("paperTradingCapital", String(result.data.capital || 1800000));\n          localStorage.setItem("paperPositions", JSON.stringify(result.data.positions || []));\n          localStorage.setItem("paperTradeHistory", JSON.stringify(result.data.tradeHistory || []));\n          localStorage.setItem("paperTradingRealizedPnl", String(result.data.realizedPnl || 0));\n        }\n        setPaperTradingAwsLoaded(true);\n      } else {\n        console.warn('⚠️ Failed to load paper trading data from AWS:', response.status);\n        setPaperTradingAwsLoaded(true); // Mark as loaded even on error to prevent retries\n      }\n    } catch (error) {\n      console.error('❌ Error loading paper trading from AWS:', error);\n      setPaperTradingAwsLoaded(true); // Mark as loaded even on error to prevent retries\n    }\n  }, []);\n\n  // Save paper trading data to AWS (debounced)\n  const savePaperTradingToAWS = useCallback(async (\n    capital: number, \n    positions: PaperPosition[], \n    tradeHistory: PaperTrade[],\n    realizedPnl: number\n  ) => {\n    const userId = localStorage.getItem('currentUserId');\n    if (!userId || userId === 'null') return;\n\n    try {\n      const idToken = await getCognitoToken();\n      if (!idToken) {\n        console.log('⚠️ No Cognito token for paper trading AWS save');\n        return;\n      }\n\n      setPaperTradingAwsSaving(true);\n      const totalPnl = positions.reduce((total, p) => total + (p.pnl || 0), 0);\n\n      const response = await fetch(`/api/paper-trading/${userId}`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${idToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          capital,\n          positions,\n          tradeHistory,\n          totalPnl,\n          realizedPnl\n        })\n      });\n\n      if (response.ok) {\n        console.log('✅ Paper trading data saved to AWS');\n      } else {\n        console.warn('⚠️ Failed to save paper trading data to AWS:', response.status);\n      }\n    } catch (error) {\n      console.error('❌ Error saving paper trading to AWS:', error);\n    } finally {\n      setPaperTradingAwsSaving(false);\n    }\n  }, []);\n\n  // Debounced save to AWS when paper trading data changes\n  useEffect(() => {\n    if (!paperTradingAwsLoaded) return; // Don't save until we've loaded from AWS\n\n    const userId = localStorage.getItem('currentUserId');\n    if (!userId || userId === 'null') return;\n\n    // Clear any pending save\n    if (paperTradingSaveTimeoutRef.current) {\n      clearTimeout(paperTradingSaveTimeoutRef.current);\n    }\n\n    // Debounce save by 2 seconds to avoid too many API calls\n    paperTradingSaveTimeoutRef.current = setTimeout(() => {\n      savePaperTradingToAWS(paperTradingCapital, paperPositions, paperTradeHistory, paperTradingRealizedPnl);\n    }, 2000);\n\n    return () => {\n      if (paperTradingSaveTimeoutRef.current) {\n        clearTimeout(paperTradingSaveTimeoutRef.current);\n      }\n    };\n  }, [paperTradingCapital, paperPositions, paperTradeHistory, paperTradingRealizedPnl, paperTradingAwsLoaded, savePaperTradingToAWS]);\n\n  // Load paper trading data from AWS when user is authenticated\n  useEffect(() => {\n    const userId = localStorage.getItem('currentUserId');\n    if (userId && userId !== 'null' && authInitialized && !isViewOnlyMode && !paperTradingAwsLoaded) {\n      loadPaperTradingFromAWS();\n    }\n  }, [authInitialized, isViewOnlyMode, paperTradingAwsLoaded, loadPaperTradingFromAWS]);\n\n  // Paper trading form state\n  const [paperTradeSymbol, setPaperTradeSymbol] = useState("");\n  const [paperTradeSymbolSearch, setPaperTradeSymbolSearch] = useState("");\n  const [paperTradeSearchResults, setPaperTradeSearchResults] = useState<any[]>([]);\n  const [paperTradeSearchLoading, setPaperTradeSearchLoading] = useState(false);\n  const [selectedPaperTradingInstrument, setSelectedPaperTradingInstrument] = useState<any>(null);\n  const [paperTradeType, setPaperTradeType] = useState<'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX'>('STOCK');\n  const [paperTradeQuantity, setPaperTradeQuantity] = useState("");\n  const [paperTradeLotInput, setPaperTradeLotInput] = useState(""); // For futures/options (multiplied by lot size)\n  const [paperTradeAction, setPaperTradeAction] = useState<'BUY' | 'SELL'>('BUY');\n  const [paperTradeCurrentPrice, setPaperTradeCurrentPrice] = useState<number | null>(null);\n  const [paperTradePriceLoading, setPaperTradePriceLoading] = useState(false);\n\n  // Stop Loss state\n  const [showPaperTradeSLDropdown, setShowPaperTradeSLDropdown] = useState(false);\n  const [showMobilePaperTradeSLDropdown, setShowMobilePaperTradeSLDropdown] = useState(false);\n  const [paperTradeSLPrice, setPaperTradeSLPrice] = useState("");\n  const [paperTradeSLType, setPaperTradeSLType] = useState<'price' | 'percent' | 'duration' | 'high' | 'low'>('price');\n  const [paperTradeSLValue, setPaperTradeSLValue] = useState("");\n  const [paperTradeSLTimeframe, setPaperTradeSLTimeframe] = useState("5m");\n  const [paperTradeSLDurationUnit, setPaperTradeSLDurationUnit] = useState("min");\n  const [paperTradeSLEnabled, setPaperTradeSLEnabled] = useState(false); // SL is enabled when user sets it\n  const paperTradingStreamSymbolsRef = useRef<Set<string>>(new Set());\n\n  // Paper trading LIVE WebSocket streaming state (TradingView-style real-time P&L)\n  const [paperTradingWsStatus, setPaperTradingWsStatus] = useState<'connected' | 'connecting' | 'disconnected'>('disconnected');\n  const [paperTradingLivePrices, setPaperTradingLivePrices] = useState<Map<string, number>>(new Map());\n  const paperTradingEventSourcesRef = useRef<Map<string, EventSource>>(new Map());\n  const paperTradingLastUpdateRef = useRef<number>(Date.now());\n\n  // 🔴 CRITICAL FIX: Sync live prices from WebSocket stream to paper positions immediately\n  // This ensures that when a new position is opened, its LTP updates instantly as prices stream in\n  useEffect(() => {\n    if (paperTradingLivePrices.size === 0 || paperPositions.length === 0) return;\n\n    const updatedPositions = paperPositions.map(position => {\n      const livePrice = paperTradingLivePrices.get(position.symbol);\n      if (livePrice && livePrice !== position.currentPrice) {\n        const pnl = (livePrice - position.entryPrice) * position.quantity;\n        const pnlPercent = ((livePrice - position.entryPrice) / position.entryPrice) * 100;\n        return {\n          ...position,\n          currentPrice: livePrice,\n          pnl: position.action === "BUY" ? pnl : -pnl,\n          pnlPercent: position.action === "BUY" ? pnlPercent : -pnlPercent\n        };\n      }\n      return position;\n    });\n\n    if (JSON.stringify(updatedPositions) !== JSON.stringify(paperPositions)) {\n      setPaperPositions(updatedPositions);\n    }\n  }, [paperTradingLivePrices]);\n  // Map paper trade type to exchange segment for filtering\n  const getExchangeForTradeType = (type: 'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX'): string => {\n    switch (type) {\n      case 'STOCK':\n        return 'NSE,BSE';  // Equity stocks\n      case 'FUTURES':\n        return 'NFO,BFO';  // NSE F&O + BSE F&O for futures\n      case 'OPTIONS':\n        return 'NFO,BFO';  // NSE F&O + BSE F&O for options\n      case 'MCX':\n        return 'MCX,NCDEX';  // MCX + NCDEX for commodities\n      default:\n        return 'NSE,BSE';\n    }\n  };\n\n  // Get lot size for Angel One instruments based on API standards\n  const getLotSizeForInstrument = (symbol: string, type: 'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX'): number => {\n\n    // Current lot sizes (effective now)\n\n    // NSE Futures lot sizes - CURRENT\n    const futuresLotSizes: { [key: string]: number } = {\n      'NIFTY': 75,          // 1 lot = 75 qty\n      'BANKNIFTY': 35,      // 1 lot = 35 qty\n      'FINNIFTY': 65,       // 1 lot = 65 qty\n      'MIDCPNIFTY': 40,     // 1 lot = 40 qty\n      'SENSEX': 20,         // 1 lot = 20 qty (BSE)\n      'BANKEX': 15,         // 1 lot = 15 qty (BSE)\n      'NIFTYIT': 50,\n      'NIFTYPHARMA': 50,\n      'NIFTYINFRA': 50,\n      'NIFTYAUTO': 50,\n      'NIFTYBANK': 50,\n    };\n\n    // MCX lot sizes (in units)\n    const mcxLotSizes: { [key: string]: number } = {\n      'GOLD': 100,      // 100 grams\n      'SILVER': 30,     // 30 kg\n      'CRUDEOIL': 100,  // 100 barrels\n      'NATURALGAS': 250, // 250 MMBtu\n      'COPPER': 1,      // 1 MT\n      'LEAD': 1,        // 1 MT\n      'NICKEL': 1,      // 1 MT\n      'ZINC': 1,        // 1 MT\n      'ALUMMINI': 1,    // 1 MT\n      'COTTON': 1,      // 1 bale\n      'MENTHAOIL': 1,   // 1 MT\n    };\n\n    // NCDEX lot sizes\n    const ncdexLotSizes: { [key: string]: number } = {\n      'TURMERIC': 1,\n      'MAIZE': 100,\n      'SOYBEANGRDER': 100,\n      'SOYBEAN': 100,\n      'MUSTARD': 100,\n      'CARDAMOM': 1,\n      'PEPPER': 1,\n      'DHANIYA': 100,\n    };\n\n    // Extract base symbol: remove everything from first digit onwards\n    // E.g., "BANKNIFTY30DEC25FUT" → "BANKNIFTY"\n    const baseSymbol = symbol.replace(/\d.*$/i, '').toUpperCase();\n\n    switch (type) {\n      case 'FUTURES':\n        return futuresLotSizes[baseSymbol] || 1;\n      case 'OPTIONS':\n        return futuresLotSizes[baseSymbol] || 1; // Options use same lot size as underlying futures\n      case 'MCX':\n        return mcxLotSizes[baseSymbol] || 1;\n      case 'STOCK':\n      default:\n        return 1; // Stocks can be bought in any quantity\n    }\n  };\n\n  // Get placeholder text based on selected type\n  const getSearchPlaceholder = (): string => {\n    switch (paperTradeType) {\n      case 'STOCK':\n        return 'Search RELIANCE, TCS, INFY...';\n      case 'FUTURES':\n        return 'Search NIFTY, BANKNIFTY futures...';\n      case 'OPTIONS':\n        return 'Search NIFTY, BANKNIFTY options...';\n      case 'MCX':\n        return 'Search GOLD, SILVER, CRUDEOIL...';\n      default:\n        return 'Search instruments...';\n    }\n  };\n\n  // Sort instruments by category: Index -> Futures (near, next, far) -> Options\n  const sortInstruments = (instruments: any[]): any[] => {\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n\n    // Categorize instruments\n    const categories: any = {\n      index: [],\n      futuresNear: [],\n      futuresNext: [],\n      futuresFar: [],\n      options: [],\n      others: []\n    };\n\n    instruments.forEach((inst) => {\n      const instrumentType = inst.instrumentType || '';\n\n      // Check if it's an index (NIFTY50, NIFTY, BANKNIFTY, etc)\n      if (instrumentType === 'FUTIDX' || instrumentType === 'OPTIDX' || \n          inst.symbol?.match(/^(NIFTY50|NIFTY|BANKNIFTY|FINNIFTY|MIDCPNIFTY)$/i)) {\n        if (instrumentType === 'OPTIDX') {\n          categories.options.push(inst);\n        } else {\n          categories.index.push(inst);\n        }\n      }\n      // Check if it's a future\n      else if (instrumentType === 'FUTSTK' || instrumentType === 'FUTIDX' || instrumentType === 'FUTCOM') {\n        if (inst.expiry) {\n          const expiryDate = new Date(inst.expiry);\n          expiryDate.setHours(0, 0, 0, 0);\n          const daysUntilExpiry = Math.floor((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n\n          if (daysUntilExpiry <= 7) {\n            categories.futuresNear.push(inst);\n          } else if (daysUntilExpiry <= 37) {\n            categories.futuresNext.push(inst);\n          } else {\n            categories.futuresFar.push(inst);\n          }\n        } else {\n          categories.futuresNear.push(inst);\n        }\n      }\n      // Check if it's an option\n      else if (instrumentType === 'OPTSTK' || instrumentType === 'OPTFUT' || instrumentType === 'OPTIDX') {\n        categories.options.push(inst);\n      }\n      // Everything else\n      else {\n        categories.others.push(inst);\n      }\n    });\n\n    // Combine in order: Index -> Futures Near -> Futures Next -> Futures Far -> Options -> Others\n    return [\n      ...categories.index,\n      ...categories.futuresNear,\n      ...categories.futuresNext,\n      ...categories.futuresFar,\n      ...categories.options,\n      ...categories.others\n    ];\n  };\n\n  // Dynamic search for paper trading instruments filtered by type/exchange\n  const searchPaperTradingInstruments = async (query: string) => {\n    if (!query || query.length < 1) {\n      setPaperTradeSearchResults([]);\n      return;\n    }\n\n    setPaperTradeSearchLoading(true);\n    try {\n      // Get exchange segment based on selected trade type\n      const exchange = getExchangeForTradeType(paperTradeType);\n      console.log(`🔍 [PAPER-TRADE] Searching for "${query}" on exchange: ${exchange} (type: ${paperTradeType})`);\n\n      const url = `/api/angelone/search-instruments?query=${encodeURIComponent(query)}&exchange=${encodeURIComponent(exchange)}&limit=50`;\n      console.log(`🔍 [PAPER-TRADE] API URL: ${url}`);\n\n      const response = await fetch(url);\n\n      if (response.ok) {\n        const data = await response.json();\n        console.log(`🔍 [PAPER-TRADE] API Response:`, data);\n        const instruments = data.instruments || data.results || [];\n        console.log(`🔍 [PAPER-TRADE] Found ${instruments.length} instruments`);\n\n        // Format instruments for display\n        const formatted = instruments.map((inst: any) => ({\n          symbol: inst.symbol || inst.tradingSymbol || "",\n          name: inst.name || inst.symbol || "",\n          token: inst.token || inst.symbolToken || "",\n          exchange: inst.exchange || "",\n          instrumentType: inst.instrumentType || "",\n          type: inst.type || paperTradeType,\n          lotSize: inst.lotSize || 1,\n          expiry: inst.expiry || null,\n        }));\n\n        // Sort by category (Index -> Futures near/next/far -> Options)\n        const sorted = sortInstruments(formatted);\n\n        console.log(`🔍 [PAPER-TRADE] Formatted and sorted ${sorted.length} results:`, sorted.slice(0, 3));\n        sorted.forEach((inst, idx) => {\n          if (idx < 3) {\n            console.log(`  [${idx}] ${inst.symbol} | Token: ${inst.token} | Exchange: ${inst.exchange} | Type: ${inst.instrumentType}`);\n          }\n        });\n        setPaperTradeSearchResults(sorted);\n      } else {\n        console.error(`🔍 [PAPER-TRADE] API error: ${response.status}`);\n        setPaperTradeSearchResults([]);\n      }\n    } catch (error) {\n      console.error("Paper trading search error:", error);\n      setPaperTradeSearchResults([]);\n    } finally {\n      setPaperTradeSearchLoading(false);\n    }\n  };\n\n  // 🔴 FIX: Keep paper trading WebSocket OPEN for continuous 700ms streaming (not just first price!)\n  const fetchPaperTradePrice = async (stockInfoOverride?: any) => {\n    const stockInfo = stockInfoOverride || selectedPaperTradingInstrument;\n\n    if (!stockInfo) {\n      console.warn(`⚠️ [PAPER-TRADE-PRICE] No instrument selected`);\n      return;\n    }\n\n    // Close previous stream if any\n    if (paperTradingEventSourcesRef.current.has(stockInfo.symbol)) {\n      const prevStream = paperTradingEventSourcesRef.current.get(stockInfo.symbol);\n      if (prevStream) prevStream.close();\n      paperTradingEventSourcesRef.current.delete(stockInfo.symbol);\n    }\n\n    console.log(`🔍 [PAPER-TRADE-PRICE] Selected instrument:`, {\n      symbol: stockInfo.symbol,\n      token: stockInfo.token,\n      exchange: stockInfo.exchange,\n      instrumentType: stockInfo.instrumentType,\n      type: stockInfo.type\n    });\n\n    // Validate required fields\n    if (!stockInfo.symbol || !stockInfo.exchange) {\n      console.error(`❌ [PAPER-TRADE-PRICE] Missing required fields:`, {\n        symbol: stockInfo.symbol,\n        token: stockInfo.token,\n        exchange: stockInfo.exchange\n      });\n      setPaperTradePriceLoading(false);\n      return;\n    }\n\n    setPaperTradePriceLoading(true);\n    setPaperTradingWsStatus('connecting');\n    try {\n      // 🔴 CRITICAL FIX: Stream continuous live prices at 700ms (tick data!)\n      // Using interval=0 to get raw tick updates from Angel One, NOT binned candles\n      const sseUrl = `/api/angelone/live-stream-ws?symbol=${stockInfo.symbol}&symbolToken=${stockInfo.token}&exchange=${stockInfo.exchange}&tradingSymbol=${stockInfo.symbol}&interval=0`; // 0 = live tick data at 700ms\n\n      console.log(`📊 [PAPER-TRADE-PRICE] Opening CONTINUOUS live price stream for ${stockInfo.symbol} (NSE, BSE, MCX, NCDEX, NFO, BFO, CDS)`);\n      console.log(`  URL: ${sseUrl}`);\n\n      const eventSource = new EventSource(sseUrl);\n      paperTradingEventSourcesRef.current.set(stockInfo.symbol, eventSource);\n\n      let priceReceived = false;\n      const timeout = setTimeout(() => {\n        if (!priceReceived) {\n          console.warn(`⚠️ [PAPER-TRADE-PRICE] No price received for ${stockInfo.symbol} after 5s`);\n          setPaperTradePriceLoading(false);\n        }\n      }, 5000);\n\n      eventSource.onopen = () => {\n        console.log(`✅ [PAPER-TRADE-PRICE] WebSocket STREAMING for ${stockInfo.symbol} @ 700ms`);\n        setPaperTradingWsStatus('connected');\n      };\n\n      eventSource.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          const ltp = data.ltp || data.close;\n\n          if (ltp && ltp > 0) {\n            if (!priceReceived) {\n              console.log(`✅ [PAPER-TRADE-PRICE] Got initial price for ${stockInfo.symbol}: ₹${ltp}`);\n              clearTimeout(timeout);\n              setPaperTradePriceLoading(false);\n              priceReceived = true;\n            }\n            // 🔴 CRITICAL: Keep connection OPEN and update continuously (not close!)\n            setPaperTradeCurrentPrice(ltp);\n            setPaperTradingLivePrices(prev => new Map(prev).set(stockInfo.symbol, ltp));\n          }\n        } catch (err) {\n          console.error(`[PAPER-TRADE-PRICE] Parse error for ${stockInfo.symbol}:`, err);\n        }\n      };\n\n      eventSource.onerror = (event) => {\n        console.error(`❌ [PAPER-TRADE-PRICE] Connection error for ${stockInfo.symbol}:`, event);\n        clearTimeout(timeout);\n        eventSource.close();\n        paperTradingEventSourcesRef.current.delete(stockInfo.symbol);\n        setPaperTradingWsStatus('disconnected');\n        if (!priceReceived) {\n          setPaperTradePriceLoading(false);\n        }\n      };\n    } catch (error) {\n      console.error("❌ [PAPER-TRADE-PRICE] Exception:", error);\n      setPaperTradePriceLoading(false);\n      setPaperTradingWsStatus('disconnected');\n    }\n  };\n\n  // Execute paper trade (BUY or SELL)\n  const executePaperTrade = () => {\n    const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n    if (!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice) {\n      toast({\n        title: "Invalid Trade",\n        description: `Please select a symbol and enter ${paperTradeType === 'STOCK' ? 'quantity' : 'lots'}`,\n        variant: "destructive"\n      });\n      return;\n    }\n\n    // Calculate quantity: for stocks it's direct, for futures/options it's lots * lot size\n    let quantity = parseInt(inputValue);\n    if (paperTradeType !== 'STOCK') {\n      const lotSize = getLotSizeForInstrument(paperTradeSymbol, paperTradeType);\n      quantity = quantity * lotSize;\n    }\n    const tradeValue = quantity * paperTradeCurrentPrice;\n\n    if (paperTradeAction === 'BUY') {\n      // Check if enough capital\n      if (tradeValue > paperTradingCapital) {\n        toast({\n          title: "Insufficient Capital",\n          description: `Need ₹${tradeValue.toLocaleString()} but only ₹${paperTradingCapital.toLocaleString()} available`,\n          variant: "destructive"\n        });\n        return;\n      }\n\n      // Calculate SL trigger price if SL is enabled\n      let slTriggerPrice: number | undefined;\n      let slExpiryTime: number | undefined;\n\n      if (paperTradeSLEnabled && paperTradeSLValue) {\n        if (paperTradeSLType === 'price') {\n          slTriggerPrice = parseFloat(paperTradeSLValue);\n        } else if (paperTradeSLType === 'percent') {\n          const percentValue = parseFloat(paperTradeSLValue);\n          slTriggerPrice = paperTradeCurrentPrice * (1 - percentValue / 100);\n        } else if (paperTradeSLType === 'duration') {\n          const durationValue = parseFloat(paperTradeSLValue);\n          const multiplier = paperTradeSLDurationUnit === 'hr' ? 60 : 1;\n          slExpiryTime = Date.now() + (durationValue * multiplier * 60 * 1000);\n        }\n      }\n\n      // Create new position\n      const newPosition: PaperPosition = {\n        id: `PT-${Date.now()}`,\n        symbol: paperTradeSymbol,\n        type: paperTradeType as any,\n        action: 'BUY',\n        quantity: quantity,\n        entryPrice: paperTradeCurrentPrice,\n        currentPrice: paperTradeCurrentPrice,\n        entryTime: new Date().toLocaleTimeString(),\n        pnl: 0,\n        pnlPercent: 0,\n        isOpen: true,\n        // Store token and exchange for WebSocket live price streaming\n        symbolToken: (selectedPaperTradingInstrument as any)?.token || "0",\n        exchange: (selectedPaperTradingInstrument as any)?.exchange || (paperTradeType === 'MCX' ? 'MCX' : paperTradeType === 'FUTURES' || paperTradeType === 'OPTIONS' ? 'NFO' : 'NSE'),\n        // Stop Loss settings\n        slEnabled: paperTradeSLEnabled,\n        slType: paperTradeSLEnabled ? paperTradeSLType : undefined,\n        slValue: paperTradeSLEnabled ? paperTradeSLValue : undefined,\n        slTimeframe: paperTradeSLEnabled ? paperTradeSLTimeframe : undefined,\n        slDurationUnit: paperTradeSLEnabled ? paperTradeSLDurationUnit : undefined,\n        slTriggerPrice: slTriggerPrice,\n        slExpiryTime: slExpiryTime\n      } as any;\n\n      // Add to positions\n      const updatedPositions = [...paperPositions, newPosition];\n      setPaperPositions(updatedPositions);\n      localStorage.setItem("paperPositions", JSON.stringify(updatedPositions));\n\n      // 🔴 CRITICAL: Start live price streaming for the new position\n      const instrumentForStreaming = {\n        symbol: newPosition.symbol,\n        exchange: newPosition.exchange,\n        token: newPosition.symbolToken,\n        name: newPosition.symbol\n      };\n      fetchPaperTradePrice(instrumentForStreaming);\n\n      // Deduct from capital\n      const newCapital = paperTradingCapital - tradeValue;\n      setPaperTradingCapital(newCapital);\n      localStorage.setItem("paperTradingCapital", String(newCapital));\n\n      // Add to trade history\n      const newTrade: PaperTrade = {\n        id: newPosition.id,\n        symbol: paperTradeSymbol,\n        type: 'MIS',\n        action: 'BUY',\n        quantity: quantity,\n        price: paperTradeCurrentPrice,\n        time: new Date().toLocaleTimeString()\n      };\n      const updatedHistory = [...paperTradeHistory, newTrade];\n      setPaperTradeHistory(updatedHistory);\n      localStorage.setItem("paperTradeHistory", JSON.stringify(updatedHistory));\n\n      // Build toast message with SL info\n      let toastDescription = `Bought ${quantity} ${paperTradeSymbol} @ ₹${paperTradeCurrentPrice.toFixed(2)}`;\n      if (paperTradeSLEnabled && slTriggerPrice) {\n        toastDescription += ` | SL: ₹${slTriggerPrice.toFixed(2)}`;\n      } else if (paperTradeSLEnabled && slExpiryTime) {\n        toastDescription += ` | SL: ${paperTradeSLValue} ${paperTradeSLDurationUnit}`;\n      }\n\n      toast({\n        title: "Trade Executed",\n        description: toastDescription\n      });\n\n      // Reset SL settings after trade\n      setPaperTradeSLEnabled(false);\n      setPaperTradeSLValue("");\n      setShowPaperTradeSLDropdown(false);\n\n    } else {\n      // SELL - Close an existing position\n      const openPosition = paperPositions.find(p => p.symbol === paperTradeSymbol && p.isOpen);\n\n      if (!openPosition) {\n        toast({\n          title: "No Open Position",\n          description: `You don't have an open position in ${paperTradeSymbol} to sell`,\n          variant: "destructive"\n        });\n        return;\n      }\n\n      // Calculate P&L\n      const pnl = (paperTradeCurrentPrice - openPosition.entryPrice) * openPosition.quantity;\n      const pnlPercent = ((paperTradeCurrentPrice - openPosition.entryPrice) / openPosition.entryPrice) * 100;\n\n      // Close the position\n      const updatedPositions = paperPositions.map(p => \n        p.id === openPosition.id \n          ? { \n              ...p, \n              isOpen: false, \n              currentPrice: paperTradeCurrentPrice, \n              pnl, \n              pnlPercent,\n              // Preserve token and exchange for logging\n              symbolToken: (p as any).symbolToken,\n              exchange: (p as any).exchange\n            }\n          : p\n      );\n      setPaperPositions(updatedPositions);\n      localStorage.setItem("paperPositions", JSON.stringify(updatedPositions));\n\n      // Add sale value back to capital plus P&L\n      const saleValue = openPosition.quantity * paperTradeCurrentPrice;\n      const newCapital = paperTradingCapital + saleValue;\n      setPaperTradingCapital(newCapital);\n      localStorage.setItem("paperTradingCapital", String(newCapital));\n\n      // Add sell trade to history\n      const sellTrade: PaperTrade = {\n        id: `PT-${Date.now()}`,\n        symbol: paperTradeSymbol,\n        type: 'MIS',\n        action: 'SELL',\n        quantity: openPosition.quantity,\n        price: paperTradeCurrentPrice,\n        time: new Date().toLocaleTimeString(),\n        pnl: `₹${pnl.toFixed(2)}`,\n        closedAt: new Date().toLocaleTimeString()\n      };\n      const updatedHistory = [...paperTradeHistory, sellTrade];\n      setPaperTradeHistory(updatedHistory);\n      localStorage.setItem("paperTradeHistory", JSON.stringify(updatedHistory));\n\n      toast({\n        title: pnl >= 0 ? "Profit Booked!" : "Loss Booked",\n        description: `Sold ${openPosition.quantity} ${paperTradeSymbol} @ ₹${paperTradeCurrentPrice.toFixed(2)} | P&L: ₹${pnl.toFixed(2)}`\n      });\n    }\n\n    // Reset form\n    setPaperTradeSymbol("");\n    setPaperTradeQuantity("");\n    setPaperTradeLotInput("");\n    setPaperTradeCurrentPrice(null);\n    setPaperTradeSymbolSearch("");\n  };\n\n  // Reset paper trading account\n  const resetPaperTradingAccount = async () => {\n    setPaperTradingCapital(1800000);\n    setPaperPositions([]);\n    setPaperTradeHistory([]);\n    setPaperTradeSymbol("");\n    setPaperTradeQuantity("");\n    setPaperTradeLotInput("");\n    setPaperTradeCurrentPrice(null);\n    localStorage.setItem("paperTradingCapital", "1800000");\n    localStorage.setItem("paperPositions", "[]");\n    localStorage.setItem("paperTradeHistory", "[]");\n    setPaperTradingRealizedPnl(0);\n    localStorage.setItem("paperTradingRealizedPnl", "0");\n    // Reset AWS data\n    setPaperTradingAwsLoaded(false);\n    const userId = localStorage.getItem('currentUserId');\n    if (userId && userId !== 'null') {\n      try {\n        const idToken = await getCognitoToken();\n        if (idToken) {\n          await fetch(`/api/paper-trading/${userId}`, {\n            method: 'DELETE',\n            headers: { 'Authorization': `Bearer ${idToken}` }\n          });\n          console.log('✅ Paper trading AWS data reset');\n        }\n      } catch (error) {\n        console.error('❌ Error resetting AWS paper trading data:', error);\n      }\n      setPaperTradingAwsLoaded(true);\n    }\n    toast({\n      title: "Account Reset",\n      description: "Paper trading account reset to ₹18,00,000"\n    });\n  };\n\n  // 🔴 NEW: Record all paper trades - opens Trade History Summary (like Import P&L does)\n  const recordAllPaperTrades = () => {\n    if (paperTradeHistory.length === 0) {\n      toast({\n        title: "No Trades",\n        description: "No trade history to record",\n        variant: "destructive"\n      });\n      return;\n    }\n\n\n    // 🔴 AUTO-SWITCH to personal mode if in demo - record trades immediately in single tap\n    if (isDemoMode) {\n      console.log("🔄 Auto-switching to personal mode to record trades...");\n      setIsDemoMode(false);\n    }\n\n\n    console.log("📊 Converting paper trades to journal format...");\n\n    // Convert paper trades to trade journal format (time, order, symbol, type, qty, price)\n    const convertedTrades = paperTradeHistory.map((trade: any) => ({\n      time: trade.time,\n      order: trade.action, // BUY or SELL\n      symbol: trade.symbol,\n      type: trade.type || 'MIS',\n      qty: trade.quantity,\n      price: trade.price,\n      pnl: trade.pnl || '-',\n      duration: trade.closedAt ? '0m 0s' : '-'\n    }));\n\n    // 1️⃣ Calculate P&L (same as Import P&L does)\n    const processedData = calculateSimplePnL(convertedTrades);\n\n    // 2️⃣ Add to trade history summary (opens the summary window)\n    setTradeHistoryData(processedData); // Reset history with new trades only\n\n    // 3️⃣ Also record to today's personal heatmap for tracking\n    const today = new Date();\n    const todayKey = formatDateKey(today);\n    const existingData = tradingDataByDate[todayKey] || {};\n    const existingTrades = existingData.tradeHistory || [];\n\n    // Convert for heatmap storage (different format)\n    const heatmapTrades = paperTradeHistory.map((trade: any) => ({\n      symbol: trade.symbol,\n      type: trade.type || 'MIS',\n      action: trade.action,\n      quantity: trade.quantity,\n      price: trade.price,\n      time: trade.time,\n      pnl: trade.pnl,\n      closedAt: trade.closedAt\n    }));\n\n    const mergedTrades = [...existingTrades, ...heatmapTrades];\n    const updatedData = {\n      ...existingData,\n      tradeHistory: mergedTrades,\n      profitLossAmount: mergedTrades.reduce((sum: number, trade: any) => {\n        if (trade.pnl && trade.pnl !== '-') {\n          const pnlStr = String(trade.pnl).replace('₹', '').replace('+', '');\n          return sum + (parseFloat(pnlStr) || 0);\n        }\n        return sum;\n      }, 0),\n      totalTrades: mergedTrades.length\n    };\n\n    setPersonalTradingDataByDate((prev: any) => ({\n      ...prev,\n      [todayKey]: updatedData\n    }));\n\n    localStorage.setItem("personalTradingDataByDate", JSON.stringify({\n      ...personalTradingDataByDate,\n      [todayKey]: updatedData\n    }));\n\n    // 4️⃣ Auto-select today's date on both heatmap AND journal calendar\n    setHeatmapSelectedDate(todayKey);\n    setSelectedDate(today);\n\n    // 5️⃣ Close paper trading dialog and show summary\n    setShowPaperTradingModal(false);\n    setIsDemoMode(false);\n\n    toast({\n      title: "Trades Recorded",\n      description: `Recorded ${convertedTrades.length} trades to today's summary and personal tradebook`\n    });\n\n    console.log("✅ Paper trades recorded to journal summary and heatmap");\n\n    // 🔄 Trigger PersonalHeatmap refresh to immediately display colors after save\n    setPersonalHeatmapRevision(prev => prev + 1);\n  };\n\n\n  // 🔴 NEW: Record all broker orders to journal (same flow as paper trading)\n  const recordAllBrokerOrders = () => {\n    if (brokerOrders.length === 0) {\n      toast({\n        title: "No Orders",\n        description: "No broker orders to record",\n        variant: "destructive"\n      });\n      return;\n    }\n\n    // Filter to only COMPLETE orders (successful orders only)\n    const completeOrders = brokerOrders.filter((order: any) => order.status === 'COMPLETE');\n    \n    if (completeOrders.length === 0) {\n      toast({\n        title: "No Complete Orders",\n        description: "Only COMPLETE orders are imported. Skipping REJECTED, CANCELLED, and PENDING orders.",\n        variant: "destructive"\n      });\n      return;\n    }\n\n    if (isDemoMode) {\n      console.log("🔄 Auto-switching to personal mode to record broker orders...");\n      setIsDemoMode(false);\n    }\n\n    console.log("📊 Converting broker orders to journal format (COMPLETE orders only)...");\n    console.log(`✅ Importing ${completeOrders.length} COMPLETE orders (skipped ${brokerOrders.length - completeOrders.length} non-complete orders)`);\n\n    const convertedTrades = completeOrders.map((trade: any) => ({\n      time: trade.time,\n      order: trade.order,\n      symbol: trade.symbol,\n      type: trade.type || 'MIS',\n      qty: trade.qty,\n      price: trade.price,\n      pnl: trade.pnl || '-',\n      duration: trade.duration || '-'\n    }));\n\n    const processedData = calculateSimplePnL(convertedTrades);\n    setTradeHistoryData(processedData);\n\n    const today = new Date();\n    const todayKey = formatDateKey(today);\n    const existingData = tradingDataByDate[todayKey] || {};\n    const existingTrades = existingData.tradeHistory || [];\n\n    const heatmapTrades = completeOrders.map((trade: any) => ({\n      symbol: trade.symbol,\n      type: trade.type || 'MIS',\n      action: trade.order,\n      quantity: trade.qty,\n      price: trade.price,\n      time: trade.time,\n      pnl: trade.pnl,\n      duration: trade.duration\n    }));\n\n    const mergedTrades = [...existingTrades, ...heatmapTrades];\n    const updatedData = {\n      ...existingData,\n      tradeHistory: mergedTrades,\n      profitLossAmount: mergedTrades.reduce((sum: number, trade: any) => {\n        if (trade.pnl && trade.pnl !== '-') {\n          const pnlStr = String(trade.pnl).replace('₹', '').replace('+', '');\n          return sum + (parseFloat(pnlStr) || 0);\n        }\n        return sum;\n      }, 0),\n      totalTrades: mergedTrades.length\n    };\n\n    setPersonalTradingDataByDate((prev: any) => ({...prev, [todayKey]: updatedData}));\n    localStorage.setItem("personalTradingDataByDate", JSON.stringify({...personalTradingDataByDate, [todayKey]: updatedData}));\n\n    setHeatmapSelectedDate(todayKey);\n    setSelectedDate(today);\n    setShowOrderModal(false);\n\n    toast({\n      title: "Orders Recorded",\n      description: `Recorded ${completeOrders.length} orders`\n    });\n\n    console.log("✅ Broker orders recorded to journal summary and heatmap");\n    setPersonalHeatmapRevision(prev => prev + 1);\n  };\n\n  // Exit all open positions at once\n\n  // Auto-tap: Automatically record broker orders when NEW COMPLETE orders are added\n  useEffect(() => {\n    // Count only COMPLETE orders\n    const completeOrders = brokerOrders.filter((order: any) => order.status === 'COMPLETE');\n    const completeOrdersCount = completeOrders.length;\n    \n    // Only auto-trigger if COMPLETE count increased (new success orders added)\n    if (completeOrdersCount > previousCompleteOrdersLengthRef.current && completeOrdersCount > 0) {\n      console.log(`🤖 [AUTO-TAP] Detected ${completeOrdersCount} COMPLETE orders (was ${previousCompleteOrdersLengthRef.current}), auto-recording only success orders...`);\n      \n      // Schedule the auto-record for next tick to ensure state is updated\n      setTimeout(() => {\n        recordAllBrokerOrders();\n      }, 500);\n    }\n    \n    // Update the ref with current COMPLETE orders count\n    previousCompleteOrdersLengthRef.current = completeOrdersCount;\n    \n    // Keep tracking total for reference (but don't use for trigger)\n    previousBrokerOrdersLengthRef.current = brokerOrders.length;\n  }, [brokerOrders]);\n  const exitAllPaperPositions = () => {\n    const openPositions = paperPositions.filter(p => p.isOpen);\n    if (openPositions.length === 0) {\n      toast({\n        title: "No Positions",\n        description: "No open positions to exit",\n        variant: "destructive"\n      });\n      return;\n    }\n\n    let totalPnl = 0;\n    let newCapital = paperTradingCapital;\n    const newHistoryEntries: PaperTrade[] = [];\n    const exitTime = new Date().toLocaleTimeString();\n\n    // Close all positions and calculate total P&L\n    const updatedPositions = paperPositions.map(p => {\n      if (!p.isOpen) return p;\n\n      // Calculate P&L for this position\n      const pnl = (p.currentPrice - p.entryPrice) * p.quantity;\n      const pnlPercent = ((p.currentPrice - p.entryPrice) / p.entryPrice) * 100;\n      totalPnl += pnl;\n\n      // Add sale value back to capital\n      const saleValue = p.quantity * p.currentPrice;\n      newCapital += saleValue;\n\n      // Create sell trade entry for history\n      const sellTrade: PaperTrade = {\n        id: `PT-EXIT-${Date.now()}-${p.id}`,\n        symbol: p.symbol,\n        type: p.type,\n        action: 'SELL',\n        quantity: p.quantity,\n        price: p.currentPrice,\n        time: exitTime,\n        pnl: `₹${pnl.toFixed(2)}`,\n        closedAt: exitTime\n      };\n      newHistoryEntries.push(sellTrade);\n\n      // Return closed position\n      return {\n        ...p,\n        isOpen: false,\n        pnl,\n        pnlPercent\n      };\n    });\n\n    // Update positions\n    setPaperPositions(updatedPositions);\n    localStorage.setItem("paperPositions", JSON.stringify(updatedPositions));\n\n    // Update capital\n    setPaperTradingCapital(newCapital);\n    localStorage.setItem("paperTradingCapital", String(newCapital));\n\n    // Add all sell trades to history\n    const updatedHistory = [...paperTradeHistory, ...newHistoryEntries];\n    setPaperTradeHistory(updatedHistory);\n    localStorage.setItem("paperTradeHistory", JSON.stringify(updatedHistory));\n\n    // Accumulate realized P&L from all closed positions\n    setPaperTradingRealizedPnl(prev => {\n      const newRealizedPnl = prev + totalPnl;\n      localStorage.setItem("paperTradingRealizedPnl", String(newRealizedPnl));\n      return newRealizedPnl;\n    });\n\n    // Show toast with summary\n    toast({\n      title: totalPnl >= 0 ? "All Positions Closed - Profit!" : "All Positions Closed - Loss",\n      description: `Exited ${openPositions.length} position${openPositions.length > 1 ? 's' : ''} | Total P&L: ${totalPnl >= 0 ? '+' : ''}₹${totalPnl.toFixed(2)}`\n    });\n  };\n\n  const exitPosition = (positionId: string) => {\n    const position = paperPositions.find(p => p.id === positionId);\n\n    if (!position) {\n      toast({\n        title: "Position Not Found",\n        description: "Could not find the position to exit",\n        variant: "destructive"\n      });\n      return;\n    }\n\n    const exitPnL = position.pnl;\n    const exitPrice = position.currentPrice;\n\n    // Update position as closed\n    const updatedPositions = paperPositions.map(p =>\n      p.id === positionId ? { ...p, isOpen: false } : p\n    );\n    setPaperPositions(updatedPositions);\n    localStorage.setItem("paperPositions", JSON.stringify(updatedPositions));\n\n    // Add to trade history\n    const newTrade: PaperTrade = {\n      id: `exit-${positionId}`,\n      symbol: position.symbol,\n      type: position.type,\n      action: position.action === 'BUY' ? 'SELL' : 'BUY', // Exit action is opposite of entry\n      quantity: position.quantity,\n      price: exitPrice,\n      time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),\n      pnl: `${exitPnL >= 0 ? '+' : ''}₹${exitPnL.toFixed(0)}`,\n      closedAt: new Date().toISOString()\n    };\n\n    const updatedHistory = [...paperTradeHistory, newTrade];\n    setPaperTradeHistory(updatedHistory);\n    localStorage.setItem("paperTradeHistory", JSON.stringify(updatedHistory));\n\n    // Accumulate realized P&L from closed position\n    setPaperTradingRealizedPnl(prev => {\n      const newRealizedPnl = prev + exitPnL;\n      localStorage.setItem("paperTradingRealizedPnl", String(newRealizedPnl));\n      return newRealizedPnl;\n    });\n\n    setSwipedPositionId(null);\n\n    toast({\n      title: "Position Exited",\n      description: `${position.symbol} exited at ₹${exitPrice.toFixed(2)} | P&L: ₹${exitPnL.toFixed(0)}`,\n      duration: 2000\n    });\n  };\n\n  // Persist paper trading positions to localStorage when they change\n  useEffect(() => {\n    localStorage.setItem("paperPositions", JSON.stringify(paperPositions));\n  }, [paperPositions]);\n\n  // ============================================\n  // PAPER TRADING LIVE WEBSOCKET STREAMING (TradingView-style real-time P&L)\n  // Uses same SSE stream as journal chart for live 700ms price updates\n  // ============================================\n  useEffect(() => {\n    // Only stream when modal is open OR mobile paper trading tab is active, and there are open positions\n    const openPositions = paperPositions.filter(p => p.isOpen);\n    const openSymbols = new Set(openPositions.map(p => p.symbol));\n\n    // Check if paper trading is active (either desktop modal OR mobile tab)\n    const isMobilePaperTradeTabActive = activeTab === 'journal' && mobileBottomTab === 'paper-trade';\n    const isPaperTradingActive = showPaperTradingModal || isMobilePaperTradeTabActive;\n\n    if (!isPaperTradingActive || openPositions.length === 0) {\n      // Clean up all existing connections\n      paperTradingEventSourcesRef.current.forEach((es) => {\n        es.close();\n      });\n      paperTradingEventSourcesRef.current.clear();\n      setPaperTradingWsStatus('disconnected');\n      return;\n    }\n\n    // Clean up stale connections (positions that were closed)\n    paperTradingEventSourcesRef.current.forEach((es, symbol) => {\n      if (!openSymbols.has(symbol)) {\n        console.log(`🔌 [PAPER-TRADING] Closing stale connection: ${symbol}`);\n        es.close();\n        paperTradingEventSourcesRef.current.delete(symbol);\n      }\n    });\n\n    setPaperTradingWsStatus('connecting');\n    console.log(`📊 [PAPER-TRADING] Starting live stream for ${openPositions.length} positions`);\n\n    // Subscribe to live stream for each open position\n    openPositions.forEach(position => {\n      // Skip if already connected\n      if (paperTradingEventSourcesRef.current.has(position.symbol)) return;\n\n      // For open positions, we store symbol, token, exchange in the position data\n      // Or fetch it from search results if available\n      const symbolToken = (position as any).symbolToken || "0";\n      const exchange = (position as any).exchange || "NSE";\n\n      // 🔴 Use 700ms live tick stream for instant P&L updates (same as initial price fetch)\n      const sseUrl = `/api/angelone/live-stream-ws?symbol=${position.symbol}&symbolToken=${symbolToken}&exchange=${exchange}&tradingSymbol=${position.symbol}&interval=0`; // 0 = 700ms live tick data\n\n      console.log(`📡 [PAPER-TRADING] Subscribing to ${position.symbol} live stream`);\n\n      const eventSource = new EventSource(sseUrl);\n      paperTradingEventSourcesRef.current.set(position.symbol, eventSource);\n\n      eventSource.onopen = () => {\n        console.log(`✅ [PAPER-TRADING] Connected: ${position.symbol}`);\n        setPaperTradingWsStatus('connected');\n      };\n\n      eventSource.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          const ltp = data.ltp || data.close;\n\n          if (ltp && ltp > 0) {\n            paperTradingLastUpdateRef.current = Date.now();\n\n            // Update live prices map\n            setPaperTradingLivePrices(prev => {\n              const newMap = new Map(prev);\n              newMap.set(position.symbol, ltp);\n              return newMap;\n            });\n\n            // Update position with new price and recalculate P&L\n            // CRITICAL: Account for trade direction (BUY = long, SELL = short)\n            setPaperPositions(prevPositions => {\n              return prevPositions.map(p => {\n                if (p.symbol === position.symbol && p.isOpen) {\n                  // For BUY (long): P&L = (current - entry) * qty (profit when price rises)\n                  // For SELL (short): P&L = (entry - current) * qty (profit when price falls)\n                  const priceDiff = p.action === 'BUY' \n                    ? (ltp - p.entryPrice) \n                    : (p.entryPrice - ltp);\n                  const pnl = priceDiff * p.quantity;\n                  const pnlPercent = (priceDiff / p.entryPrice) * 100;\n                  return {\n                    ...p,\n                    currentPrice: ltp,\n                    pnl: pnl,\n                    pnlPercent: pnlPercent\n                  };\n                }\n                return p;\n              });\n            });\n          }\n        } catch (err) {\n          console.error(`[PAPER-TRADING] Parse error for ${position.symbol}:`, err);\n        }\n      };\n\n      eventSource.onerror = () => {\n        console.warn(`⚠️ [PAPER-TRADING] Connection error: ${position.symbol}`);\n        // Try to reconnect after a delay\n        setTimeout(() => {\n          if (paperTradingEventSourcesRef.current.has(position.symbol)) {\n            const es = paperTradingEventSourcesRef.current.get(position.symbol);\n            if (es) es.close();\n            paperTradingEventSourcesRef.current.delete(position.symbol);\n          }\n        }, 5000);\n      };\n    });\n\n    // Cleanup on unmount or when dependencies change\n    return () => {\n      console.log(`🔌 [PAPER-TRADING] Cleaning up live stream connections`);\n      paperTradingEventSourcesRef.current.forEach((es) => {\n        es.close();\n      });\n      paperTradingEventSourcesRef.current.clear();\n    };\n  }, [showPaperTradingModal, activeTab, mobileBottomTab, paperPositions.filter(p => p.isOpen).map(p => `${p.symbol}:${p.action}`).join(',')]);\n\n  // Calculate total P&L: realized (from closed trades) + unrealized (from open positions)\n  const paperTradingTotalPnl = useMemo(() => {\n    // Realized P&L from closed trades + Unrealized P&L from open positions\n    const unrealizedPnl = paperPositions.filter(p => p.isOpen).reduce((total, p) => total + (p.pnl || 0), 0);\n    return paperTradingRealizedPnl + unrealizedPnl;\n  }, [paperPositions, paperTradingRealizedPnl]);\n\n  // SL Monitoring Effect - Auto-exit positions when SL is triggered\n  useEffect(() => {\n    const openPositions = paperPositions.filter(p => p.isOpen);\n    if (openPositions.length === 0) return;\n\n    // Check each open position for SL trigger\n    openPositions.forEach(position => {\n      const pos = position as any;\n      if (!pos.slEnabled) return;\n\n      let slTriggered = false;\n      let slReason = '';\n\n      // Price-based SL (for both price and percent types)\n      if (pos.slTriggerPrice && pos.currentPrice > 0) {\n        if (pos.action === 'BUY') {\n          // For long positions, trigger SL when price drops below trigger price\n          if (pos.currentPrice <= pos.slTriggerPrice) {\n            slTriggered = true;\n            slReason = `Price SL hit at ₹${pos.currentPrice.toFixed(2)} (SL: ₹${pos.slTriggerPrice.toFixed(2)})`;\n          }\n        } else {\n          // For short positions, trigger SL when price rises above trigger price\n          if (pos.currentPrice >= pos.slTriggerPrice) {\n            slTriggered = true;\n            slReason = `Price SL hit at ₹${pos.currentPrice.toFixed(2)} (SL: ₹${pos.slTriggerPrice.toFixed(2)})`;\n          }\n        }\n      }\n\n      // Duration-based SL\n      if (pos.slExpiryTime && Date.now() >= pos.slExpiryTime) {\n        slTriggered = true;\n        slReason = `Time SL expired (${pos.slValue} ${pos.slDurationUnit})`;\n      }\n\n      // If SL is triggered, auto-exit the position\n      if (slTriggered) {\n        console.log(`🛑 [SL-TRIGGER] Auto-exiting ${pos.symbol}: ${slReason}`);\n\n        // Calculate final P&L\n        const priceDiff = pos.action === 'BUY' \n          ? (pos.currentPrice - pos.entryPrice) \n          : (pos.entryPrice - pos.currentPrice);\n        const finalPnl = priceDiff * pos.quantity;\n        const finalPnlPercent = (priceDiff / pos.entryPrice) * 100;\n\n        // Close the position\n        setPaperPositions(prevPositions => {\n          const updated = prevPositions.map(p => \n            p.id === pos.id \n              ? { ...p, isOpen: false, pnl: finalPnl, pnlPercent: finalPnlPercent }\n              : p\n          );\n          localStorage.setItem("paperPositions", JSON.stringify(updated));\n          return updated;\n        });\n\n        // Add sale value back to capital\n        const saleValue = pos.quantity * pos.currentPrice;\n        setPaperTradingCapital(prev => {\n          const newCapital = prev + saleValue;\n          localStorage.setItem("paperTradingCapital", String(newCapital));\n          return newCapital;\n        });\n\n        // Add to trade history\n        const exitTrade = {\n          id: `PT-${Date.now()}`,\n          symbol: pos.symbol,\n          type: 'MIS',\n          action: 'SELL' as const,\n          quantity: pos.quantity,\n          price: pos.currentPrice,\n          time: new Date().toLocaleTimeString(),\n          pnl: `${finalPnl >= 0 ? '+' : ''}₹${finalPnl.toFixed(2)}`\n        };\n        setPaperTradeHistory(prev => {\n          const updated = [...prev, exitTrade];\n          localStorage.setItem("paperTradeHistory", JSON.stringify(updated));\n          return updated;\n        });\n\n        // Show toast notification\n        toast({\n          title: "Stop Loss Triggered",\n          description: `${pos.symbol}: ${slReason} | P&L: ${finalPnl >= 0 ? '+' : ''}₹${finalPnl.toFixed(2)}`,\n          variant: finalPnl >= 0 ? "default" : "destructive"\n        });\n      }\n    });\n  }, [paperPositions.map(p => `${p.id}:${p.currentPrice}:${p.isOpen}`).join(',')]);\n\n  // ============================================\n  // END PAPER TRADING STATE\n  // ============================================\n\n  // ✅ SIMPLIFIED: TWO SEPARATE HEATMAP DATA STATES - NO localStorage!\n  // Demo heatmap data (Heatmap loaded from AWS DynamoDB\n  const [demoTradingDataByDate, setDemoTradingDataByDate] = useState<Record<string, any>>({});\n\n  // Personal heatmap data (Heatmap loaded from AWS DynamoDB\n  const [personalTradingDataByDate, setPersonalTradingDataByDate] = useState<Record<string, any>>({});\n\n  // ✅ PERSONAL HEATMAP REVISION: Track updates to force React re-renders\n  // This counter increments after personal auto-clicking completes\n  // Ensures heatmap cells update when personalTradingDataByDate changes\n  const [personalHeatmapRevision, setPersonalHeatmapRevision] = useState(0);\n\n  // Demo mode state - toggle between demo data (same for all users) and user-specific data\n  // Switch ON (true) = Demo mode active (shared demo data, Heatmap #1)\n  // Switch OFF (false) = Personal mode active (user-specific data, Heatmap #2)\n  const [isDemoMode, setIsDemoMode] = useState(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("tradingJournalDemoMode");\n      // If user has explicitly set a preference, respect it\n      if (stored !== null) {\n        return stored === "true";\n      }\n\n      // ✅ SMART DEFAULT: If no userId exists, automatically start in Demo mode\n      // This ensures heatmap loads instantly without needing to toggle\n      const userId = localStorage.getItem("currentUserId");\n      if (!userId) {\n        console.log("🎯 Auto-default: Demo mode ON (no userId found)");\n        return true; // Demo mode\n      }\n    }\n    // If userId exists, default to personal mode\n    console.log("🎯 Default: Personal mode (userId found)");\n    return false;\n  });\n\n  // Loading state for heatmap data\n  const [isLoadingHeatmapData, setIsLoadingHeatmapData] = useState(false);\n\n\n  // ✅ CLEANUP: Remove stale localStorage data on startup to prevent state mismatches\n  // This ensures fresh data is always fetched from AWS DynamoDB\n  useEffect(() => {\n    console.log("🧹 Startup cleanup: Removing stale localStorage trading data caches...");\n\n    // Remove stale personal trading data cache - forces fresh fetch from AWS\n    localStorage.removeItem("personalTradingDataByDate");\n\n    // Remove stale calendar data cache\n    localStorage.removeItem("calendarData");\n\n    // Remove stale heatmap data cache\n    localStorage.removeItem("heatmapDataCache");\n\n    console.log("✅ Stale localStorage caches cleared - will fetch fresh data from AWS");\n  }, []); // Empty dependency array = runs once on mount\n  // Loading state for date selection\n  const [isDateLoading, setIsDateLoading] = useState(false);\n\n  // ✅ FIXED: Use useMemo with personalHeatmapRevision dependency to force re-renders\n  // When personal mode auto-clicking completes, personalHeatmapRevision increments\n  // This triggers React to re-compute tradingDataByDate and re-render the heatmap\n  const tradingDataByDate = useMemo(() => {\n    const activeData = isDemoMode ? demoTradingDataByDate : personalTradingDataByDate;\n    console.log(`🔄 tradingDataByDate recomputed [Mode: ${isDemoMode ? 'DEMO' : 'PERSONAL'}, Revision: ${personalHeatmapRevision}, Dates: ${Object.keys(activeData).length}]`);\n    return activeData;\n  }, [isDemoMode, demoTradingDataByDate, personalTradingDataByDate, personalHeatmapRevision]);\n\n  // Mini sparkline data for navigation bar icon - shows performance trend\n  const navSparklineData = useMemo(() => {\n    // Get data source - prefer personal, fallback to demo\n    const personalHasData = Object.keys(personalTradingDataByDate).length > 0;\n    const dataSource = personalHasData ? personalTradingDataByDate : demoTradingDataByDate;\n\n    if (Object.keys(dataSource).length === 0) {\n      return { points: "0,12 20,12 40,12", hasData: false, trend: "neutral" };\n    }\n\n    // Sort dates and calculate cumulative P/L\n    const sortedDates = Object.keys(dataSource).sort();\n    const recentDates = sortedDates.slice(-7); // Last 7 data points\n\n    let cumulativePnL = 0;\n    const pnlValues: number[] = [];\n\n    recentDates.forEach(date => {\n      const dayData = dataSource[date];\n      const dailyPnL = dayData?.totalPnL || dayData?.pnl || 0;\n      cumulativePnL += dailyPnL;\n      pnlValues.push(cumulativePnL);\n    });\n\n    if (pnlValues.length === 0) {\n      return { points: "0,12 20,12 40,12", hasData: false, trend: "neutral" };\n    }\n\n    // Normalize to SVG coordinates (width: 40, height: 24)\n    const minVal = Math.min(...pnlValues);\n    const maxVal = Math.max(...pnlValues);\n    const range = maxVal - minVal || 1;\n\n    const points = pnlValues.map((val, idx) => {\n      const x = (idx / (pnlValues.length - 1 || 1)) * 40;\n      const y = 20 - ((val - minVal) / range) * 16; // 4px padding top/bottom\n      return `${x.toFixed(1)},${y.toFixed(1)}`;\n    }).join(" ");\n\n    const trend = pnlValues[pnlValues.length - 1] >= pnlValues[0] ? "up" : "down";\n\n    return { points, hasData: true, trend };\n  }, [personalTradingDataByDate, demoTradingDataByDate]);\n\n\n  const setTradingDataByDate = isDemoMode ? setDemoTradingDataByDate : setPersonalTradingDataByDate;\n  const getActiveStorageKey = () => isDemoMode ? "demoTradingDataByDate" : "personalTradingDataByDate";\n\n  // Helper function to get AWS userId from localStorage\n  // Returns null if user is not logged in with AWS\n  const getUserId = (): string | null => {\n    if (typeof window === "undefined") return null;\n\n    // Use the actual AWS user ID from authentication ONLY\n    const awsUserId = localStorage.getItem("currentUserId");\n    if (awsUserId) {\n      console.log(`🔑 Using AWS user ID: ${awsUserId}`);\n      return awsUserId;\n    }\n\n    // No AWS user logged in - return null instead of generating random IDs\n    console.log(`⚠️ No AWS user logged in - getUserId() returns null`);\n    return null;\n  };\n\n  // Load all heatmap data on startup and when userId or tab changes - ALWAYS from userId, never demo\n  useEffect(() => {\n    const loadAllHeatmapData = async () => {\n      // Only load heatmap data when on journal tab\n      if (activeTab !== "journal") {\n        console.log(`⏭️ Skipping heatmap load - not on journal tab (current: ${activeTab})`);\n        return;\n      }\n\n      // ALWAYS load from userId, not demo mode\n      const userId = currentUser?.userId;\n\n      console.log(`🔄 Loading heatmap data - userId: ${userId || "NO USER (demo)"}`);\n      try {\n        setIsLoadingHeatmapData(true);\n\n        if (!userId) {\n          // No user logged in - clear heatmap data\n          console.log("⚠️ No user ID found - heatmap requires login");\n          setPersonalTradingDataByDate({});\n          setCalendarData({});\n          setIsLoadingHeatmapData(false);\n          return;\n        }\n\n        // Load user data from AWS DynamoDB\n        console.log("📥 HEATMAP: Fetching user data from AWS for userId:", userId);\n        const response = await fetch(getFullApiUrl(`/api/user-journal/${userId}/all`));\n        if (response.ok) {\n          const personalData = await response.json();\n          console.log("✅ HEATMAP data loaded:", Object.keys(personalData).length, "dates");\n\n          setTradingDataByDate(personalData);\n          setCalendarData(personalData);\n\n\n          // Auto-click all available dates to populate heatmap colors - ULTRA FAST\n          // This simulates clicking each date to ensure colors appear immediately\n          setTimeout(async () => {\n            console.log(\n              "🔄 Ultra-fast auto-clicking all PERSONAL dates for heatmap colors...",\n            );\n\n            // Create all fetch promises in parallel for maximum speed\n            const fetchPromises = Object.keys(personalData).map(\n              async (dateStr) => {\n                try {\n                  const response = await fetch(getFullApiUrl(`/api/user-journal/${userId}/${dateStr}`));\n                  if (response.ok) {\n                    const journalData = await response.json();\n                    if (journalData && Object.keys(journalData).length > 0) {\n                      return { dateStr, journalData };\n                    }\n                  }\n                } catch (error) {\n                  console.error(\n                    `❌ Error auto-loading PERSONAL date ${dateStr}:`,\n                    error,\n                  );\n                }\n                return null;\n              },\n            );\n\n            // Wait for all fetches to complete in parallel\n            const results = await Promise.all(fetchPromises);\n\n            // Update state with all loaded data\n            const validResults = results.filter((r) => r !== null);\n            if (validResults.length > 0) {\n              const updatedData = { ...personalData };\n              validResults.forEach((result: any) => {\n                if (result) {\n                  updatedData[result.dateStr] = result.journalData;\n                }\n              });\n              setTradingDataByDate(updatedData);\n              setCalendarData(updatedData);\n              console.log(\n                `✅ Ultra-fast PERSONAL heatmap population complete! Loaded ${validResults.length} dates in parallel.`,\n              );\n            }\n\n            // Auto-select latest date AFTER all data is loaded\n            if (!selectedDate && Object.keys(personalData).length > 0) {\n              const sortedDates = Object.keys(personalData).sort(\n                (a, b) => new Date(b).getTime() - new Date(a).getTime(),\n              );\n              const latestDateStr = sortedDates[0];\n              const latestDate = new Date(latestDateStr);\n              console.log("🎯 Auto-selecting latest PERSONAL date:", latestDateStr);\n              setSelectedDate(latestDate);\n              await handleDateSelect(latestDate);\n            }\n          }, 100);\n        } else {\n          console.log("📭 No personal data found for user:", userId);\n        }\n      } catch (error) {\n        console.error("❌ Error loading heatmap data:", error);\n        console.error("Error type:", typeof error);\n        console.error("Error message:", error instanceof Error ? error.message : 'Unknown error');\n        console.error("Error stack:", error instanceof Error ? error.stack : 'No stack');\n      } finally {\n        setIsLoadingHeatmapData(false);\n      }\n    };\n\n    loadAllHeatmapData();\n  }, [activeTab, currentUser?.userId]); // Re-run when tab or user changes - ALWAYS load from userId\n\n  // Images state for saving (with proper type)\n  const [tradingImages, setTradingImages] = useState<any[]>([]);\n  const imageUploadRef = useRef<MultipleImageUploadRef>(null);\n\n  // Journal chart controls state - WITH CUSTOM TIMEFRAME SUPPORT\n  const [selectedJournalSymbol, setSelectedJournalSymbol] =\n    useState("NSE:NIFTY50-INDEX");\n  const [selectedJournalInterval, setSelectedJournalInterval] = useState("5");  // Default to 5min\n  const [showJournalCustomTimeframe, setShowJournalCustomTimeframe] = useState(false);\n  const [journalCustomTimeframeType, setJournalCustomTimeframeType] = useState('minutes');\n  const [journalCustomTimeframeInterval, setJournalCustomTimeframeInterval] = useState('');\n  const [journalCustomTimeframes, setJournalCustomTimeframes] = useState<Array<{value: string, label: string, deletable: boolean}>>([]);\n  const [journalHiddenPresetTimeframes, setJournalHiddenPresetTimeframes] = useState<string[]>([]);\n\n  const [showStockSearch, setShowStockSearch] = useState(false);\n  const [stockSearchQuery, setStockSearchQuery] = useState("");\n  const [journalSearchType, setJournalSearchType] = useState<'STOCK' | 'COMMODITY' | 'F&O'>('STOCK');\n\n  // Traded symbols tracking for Next button navigation\n  const [tradedSymbols, setTradedSymbols] = useState<string[]>([]);\n  const [currentSymbolIndex, setCurrentSymbolIndex] = useState(0);\n\n  // Option Chain state\n  const [showOptionChain, setShowOptionChain] = useState(false);\n  const [optionChainData, setOptionChainData] = useState<any>(null);\n  const [optionChainLoading, setOptionChainLoading] = useState(false);\n  const [selectedOptionExpiry, setSelectedOptionExpiry] = useState<string>("");\n  const [selectedOptionIndex, setSelectedOptionIndex] = useState<string>("NIFTY");\n  const [selectedOptionExpiryDate, setSelectedOptionExpiryDate] = useState<string>("");\n\n  // ✨ OPTIMIZED FILTERING LOGIC\n  // Normalize date to YYYY-MM-DD format\n  const normalizeExpiryDate = (date: any): string | null => {\n    if (!date) return null;\n    if (typeof date === 'string') {\n      try {\n        return new Date(date).toISOString().split('T')[0];\n      } catch {\n        return null;\n      }\n    }\n    return null;\n  };\n\n  // Filter options by selected expiry (if expiry selected, otherwise return all)\n  const filterOptionsByExpiry = (options: any[], selectedExpiry: string | null): any[] => {\n    if (!options) return [];\n    if (!selectedExpiry) return options; // No filter = show all\n    return options.filter(option => {\n      if (!option.expiry) return true;\n      const optionExpiry = normalizeExpiryDate(option.expiry);\n      return optionExpiry === selectedExpiry;\n    });\n  };\n\n  // Get effective selected expiry (user choice or first available)\n  const getEffectiveExpiry = (): string | null => {\n    if (selectedOptionExpiryDate) return selectedOptionExpiryDate;\n    const allExpiries = getOptionExpiryDates(selectedOptionIndex);\n    return allExpiries.length > 0 ? allExpiries[0].value : null;\n  };\n\n  // Get expiry dates - extract from actual options data or backend response\n  const getOptionExpiryDates = (index?: string): Array<{value: string, label: string}> => {\n    if (!optionChainData) return [];\n\n    // First try: backend expiryDates field\n    let expiries = optionChainData?.expiryDates || optionChainData?.expiries || [];\n\n    // Second try: extract from actual calls/puts if backend didn't provide dates\n    if (!expiries || expiries.length === 0) {\n      const allOptions = [...(optionChainData?.calls || []), ...(optionChainData?.puts || [])];\n      const uniqueExpiries = new Set(\n        allOptions\n          .map((opt: any) => opt.expiry)\n          .filter((exp: any) => exp && typeof exp === 'string')\n      );\n      expiries = Array.from(uniqueExpiries).sort();\n      console.log('📅 Extracted expiry dates from options:', expiries);\n    }\n\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n\n    // Filter future dates\n    const futureExpiries = expiries.filter((expiry: any) => {\n      try {\n        const expiryDate = new Date(expiry);\n        expiryDate.setHours(0, 0, 0, 0);\n        return expiryDate >= today;\n      } catch {\n        return false;\n      }\n    });\n\n    // Map to display format\n    return futureExpiries.slice(0, 10).map((expiry: any) => ({\n      value: String(expiry),\n      label: (() => {\n        try {\n          return new Date(expiry).toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" });\n        } catch {\n          return String(expiry);\n        }\n      })()\n    }));\n  };\n\n  // Auto-select first expiry date when option chain data loads (mobile fix)\n  useEffect(() => {\n    if (optionChainData?.expiryDates && optionChainData.expiryDates.length > 0 && !selectedOptionExpiryDate) {\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      const futureExpiries = optionChainData.expiryDates.filter((expiry: string) => {\n        const expiryDate = new Date(expiry);\n        expiryDate.setHours(0, 0, 0, 0);\n        return expiryDate >= today;\n      });\n      if (futureExpiries.length > 0) {\n        setSelectedOptionExpiryDate(futureExpiries[0]);\n      }\n    }\n  }, [optionChainData, selectedOptionExpiryDate]);\n\n  // Auto-fetch option chain data when dialog opens (mobile fix)\n  useEffect(() => {\n    if (showOptionChain && selectedOptionIndex) {\n      fetchOptionChainData(selectedOptionIndex);\n    }\n  }, [showOptionChain, selectedOptionIndex]);\n  const foEligibleSymbols = [\n    'KOTAKBANK', 'LT', 'ITC', 'AXISBANK', 'HINDUNILVR', 'BAJFINANCE', 'MARUTI',\n    'ASIANPAINT', 'TITAN', 'TATAMOTORS', 'SUNPHARMA', 'WIPRO', 'ULTRACEMCO',\n    'TECHM', 'HCLTECH', 'NTPC', 'POWERGRID', 'ONGC', 'COALINDIA', 'M&M',\n    'TATASTEEL', 'JSWSTEEL', 'HINDALCO', 'ADANIPORTS', 'BPCL', 'GRASIM',\n    'DRREDDY', 'CIPLA', 'APOLLOHOSP', 'DIVISLAB', 'EICHERMOT', 'TATACONSUM',\n    'BAJAJFINSV', 'HDFCLIFE', 'SBILIFE', 'INDUSINDBK', 'BRITANNIA', 'NESTLEIND',\n    'NIFTY', 'BANKNIFTY', 'NIFTY50', 'NIFTYIT', 'FINNIFTY', 'MIDCPNIFTY'\n  ];\n\n  // Check if current instrument has options available\n  const hasOptionsAvailable = (): boolean => {\n    if (!selectedInstrument) return false;\n\n    const symbol = selectedInstrument.symbol.replace('-EQ', '').replace('-INDEX', '').toUpperCase();\n    const type = selectedInstrument.instrumentType || '';\n    const exchange = selectedInstrument.exchange;\n\n    // Indices always have options\n    if (type === 'AMXIDX' || type === 'INDEX') return true;\n\n    // Futures have corresponding options\n    if (type === 'FUTIDX' || type === 'FUTSTK') return true;\n\n    // F&O eligible stocks on NSE\n    if ((exchange === 'NSE' || exchange === 'BSE') && (!type || type === '' || type === 'EQ')) {\n      return foEligibleSymbols.some(s => symbol.includes(s) || s.includes(symbol));\n    }\n\n    return false;\n  };\n\n  // Get underlying symbol for option chain\n  const getUnderlyingSymbol = (indexOverride?: string): string => {\n    if (!selectedInstrument) {\n    // If an index is explicitly provided (e.g., from option chain dropdown), use it directly\n    if (indexOverride) {\n      return indexOverride;\n    }\n    const pt = paperTradeSymbol ? paperTradeSymbol.replace(/-..*$/, "").toUpperCase() : "NIFTY";\n    return pt;\n  }\n\n    const symbol = selectedInstrument.symbol.replace('-EQ', '').replace('-INDEX', '').toUpperCase();\n\n    // For indices\n    if (symbol.includes('NIFTY50') || symbol === 'NIFTY 50') return 'NIFTY';\n    if (symbol.includes('BANKNIFTY') || symbol.includes('NIFTY BANK')) return 'BANKNIFTY';\n    if (symbol.includes('FINNIFTY')) return 'FINNIFTY';\n    if (symbol.includes('MIDCPNIFTY')) return 'MIDCPNIFTY';\n\n    // For futures, extract underlying\n    if (symbol.includes('FUT')) {\n      const match = symbol.match(/^([A-Z]+)/);\n      if (match) return match[1];\n    }\n\n    return symbol;\n  };\n\n  // Fetch option chain data\n    const fetchOptionChainData = async (indexToFetch?: string, expiryToFetch?: string) => {\n    const underlying = getUnderlyingSymbol(indexToFetch);\n    if (!underlying) return;\n\n    setOptionChainLoading(true);\n    try {\n      const expiry = expiryToFetch ? `&expiry=${encodeURIComponent(expiryToFetch)}` : '';\n      const url = `/api/options/chain?symbol=${underlying}${expiry}`;\n      console.log('🔗 [OPTIONS] Fetching from:', url);\n\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        }\n      });\n\n      console.log('📡 [OPTIONS] Response status:', response.status, response.statusText);\n\n      if (!response.ok) {\n        throw new Error(`API error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log('📊 [OPTIONS] Data received:', data.success ? '✅' : '❌', data);\n\n      if (data.success && data.data) {\n        setOptionChainData(data.data);\n        console.log('✅ [OPTIONS] Option chain loaded:', data.data.calls?.length || 0, 'calls,', data.data.puts?.length || 0, 'puts');\n\n        // Auto-select first expiry if not already selected\n        // Try expiryDates first (backend field), then expiries (fallback)\n        const expiries = data.data.expiryDates || data.data.expiries || [];\n        if (expiries && expiries.length > 0) {\n          const firstExpiry = expiries[0];\n          if (!selectedOptionExpiryDate) {\n            setSelectedOptionExpiryDate(firstExpiry);\n            console.log('✅ [OPTIONS] Auto-selected first expiry:', firstExpiry);\n          }\n        }\n      } else {\n        console.warn('⚠️ [OPTIONS] Invalid response format:', data);\n        setOptionChainData(null);\n      }\n    } catch (error) {\n      console.error('❌ [OPTIONS] Error fetching option chain:', error);\n      setOptionChainData(null);\n    } finally {\n      setOptionChainLoading(false);\n    }\n  };\n  const [selectedInstrumentCategory, setSelectedInstrumentCategory] = useState("all");\n  const [selectedJournalDate, setSelectedJournalDate] = useState("2025-09-12");\n  const [journalChartData, setJournalChartData] = useState<Array<{ time: number; open: number; high: number; low: number; close: number; volume?: number }>>([]);\n  const [journalChartLoading, setJournalChartLoading] = useState(false);\n  const [journalChartTimeframe, setJournalChartTimeframe] = useState('5'); // Default 5 minutes (matches selectedJournalInterval)\n  const [showJournalTimeframeDropdown, setShowJournalTimeframeDropdown] = useState(false);\n  const [showHeatmapTimeframeDropdown, setShowHeatmapTimeframeDropdown] = useState(false);\n  const [showTradeMarkers, setShowTradeMarkers] = useState(true); // Toggle for trade markers visibility\n\n  // Watchlist Feature State\n  const [isWatchlistOpen, setIsWatchlistOpen] = useState(false);\n  const [watchlistSymbols, setWatchlistSymbols] = useState<Array<{\n    symbol: string;\n    name: string;\n    token: string;\n    exchange: string;\n    displayName: string;\n    tradingSymbol: string;\n  }>>(() => {\n    const saved = localStorage.getItem('watchlistSymbols');\n    return saved ? JSON.parse(saved) : [\n      { symbol: 'RELIANCE-EQ', name: 'Reliance Industries', token: '2885', exchange: 'NSE', displayName: 'RELIANCE', tradingSymbol: 'RELIANCE-EQ' },\n      { symbol: 'TCS-EQ', name: 'Tata Consultancy Services', token: '11536', exchange: 'NSE', displayName: 'TCS', tradingSymbol: 'TCS-EQ' },\n      { symbol: 'HDFCBANK-EQ', name: 'HDFC Bank', token: '1333', exchange: 'NSE', displayName: 'HDFCBANK', tradingSymbol: 'HDFCBANK-EQ' },\n    ];\n  });\n  const [selectedWatchlistSymbol, setSelectedWatchlistSymbol] = useState<string>('RELIANCE-EQ');\n  const [watchlistSearchQuery, setWatchlistSearchQuery] = useState('');\n  const [watchlistSearchResults, setWatchlistSearchResults] = useState<Array<{\n    symbol: string;\n    name: string;\n    token: string;\n    exchange: string;\n    displayName: string;\n    tradingSymbol: string;\n  }>>([]);\n  const [isWatchlistSearching, setIsWatchlistSearching] = useState(false);\n  const [watchlistNews, setWatchlistNews] = useState<Array<{\n    title: string;\n    description: string;\n    url: string;\n    publishedAt: string;\n    source: string;\n  }>>([]);\n  const [isWatchlistNewsLoading, setIsWatchlistNewsLoading] = useState(false);\n  const [allWatchlistQuarterlyData, setAllWatchlistQuarterlyData] = useState<{[symbol: string]: Array<{\n    quarter: string;\n    revenue: string;\n    net_profit: string;\n    eps: string;\n    change_percent: string;\n  }>}>({});\n  const [isWatchlistQuarterlyLoading, setIsWatchlistQuarterlyLoading] = useState(false);\n  const [nifty50Timeframe, setNifty50Timeframe] = useState('1D');\n  const [niftyBankTimeframe, setNiftyBankTimeframe] = useState('1D');\n\n  // Queries for NIFTY50 and NIFTYBANK chart data - optimized with caching\n  const { data: nifty50ChartData = [], isLoading: isNifty50Loading } = useQuery({\n    queryKey: ['stock-chart', 'NIFTY50', nifty50Timeframe],\n    queryFn: () => fetch(`/api/stock-chart-data/NIFTY50?timeframe=${nifty50Timeframe}`).then(res => res.json()),\n    refetchInterval: nifty50Timeframe === '1D' ? 60000 : 300000,\n    staleTime: 0,\n    gcTime: 600000,\n    refetchOnMount: true,\n    refetchOnWindowFocus: false\n  });\n\n  const { data: niftyBankChartData = [], isLoading: isNiftyBankLoading } = useQuery({\n    queryKey: ['stock-chart', selectedWatchlistSymbol, niftyBankTimeframe],\n    queryFn: () => {\n      const symbol = selectedWatchlistSymbol.replace('-EQ', '').replace('-BE', '');\n      return fetch(`/api/stock-chart-data/${symbol}?timeframe=${niftyBankTimeframe}`).then(res => res.json());\n    },\n    refetchInterval: niftyBankTimeframe === '1D' ? 60000 : 300000,\n    staleTime: 0,\n    gcTime: 600000,\n    refetchOnMount: true,\n    refetchOnWindowFocus: false\n  });\n\n  // Transform chart data to match LineChart format - uses price field consistently\n  const transformChartData = (data: any[]) => {\n    if (!Array.isArray(data)) return [];\n    return data.map((candle: any) => ({\n      time: candle.time || new Date(candle.timestamp * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),\n      price: Number(candle.price) || Number(candle.close) || 0\n    }));\n  };\n\n  const nifty50FormattedData = transformChartData(nifty50ChartData);\n  const niftyBankFormattedData = transformChartData(niftyBankChartData);\n\n  // Get current price from chart data (latest point) - matches NeoFeed pattern\n  const getNifty50CurrentPrice = () => {\n    if (nifty50ChartData && nifty50ChartData.length > 0) {\n      return nifty50ChartData[nifty50ChartData.length - 1]?.price || nifty50ChartData[nifty50ChartData.length - 1]?.close || 0;\n    }\n    return 0;\n  };\n\n  const getNiftyBankCurrentPrice = () => {\n    if (niftyBankChartData && niftyBankChartData.length > 0) {\n      return niftyBankChartData[niftyBankChartData.length - 1]?.price || niftyBankChartData[niftyBankChartData.length - 1]?.close || 0;\n    }\n    return 0;\n  };\n\n  // Calculate baseline for change calculation - uses first data point as baseline\n  const getNifty50Baseline = () => {\n    if (!nifty50ChartData || nifty50ChartData.length === 0) {\n      return getNifty50CurrentPrice();\n    }\n    return nifty50ChartData[0]?.price || nifty50ChartData[0]?.close || getNifty50CurrentPrice();\n  };\n\n  const getNiftyBankBaseline = () => {\n    if (!niftyBankChartData || niftyBankChartData.length === 0) {\n      return getNiftyBankCurrentPrice();\n    }\n    return niftyBankChartData[0]?.price || niftyBankChartData[0]?.close || getNiftyBankCurrentPrice();\n  };\n\n  const getNifty50Change = () => {\n    const current = getNifty50CurrentPrice();\n    const baseline = getNifty50Baseline();\n    return current - baseline;\n  };\n\n  const getNiftyBankChange = () => {\n    const current = getNiftyBankCurrentPrice();\n    const baseline = getNiftyBankBaseline();\n    return current - baseline;\n  };\n\n  // Save watchlist to localStorage whenever it changes\n  useEffect(() => {\n    localStorage.setItem('watchlistSymbols', JSON.stringify(watchlistSymbols));\n  }, [watchlistSymbols]);\n\n  // Fetch quarterly data when watchlist stock is selected\n  useEffect(() => {\n    if (!searchResultsNewsSymbol) {\n      setAllWatchlistQuarterlyData({});\n      return;\n    }\n\n    const fetchQuarterlyData = async () => {\n      setIsWatchlistQuarterlyLoading(true);\n      try {\n        const cleanSymbol = searchResultsNewsSymbol.replace('-EQ', '').replace('-BE', '');\n        const response = await fetch(`/api/quarterly-results/${cleanSymbol}`);\n        if (response.ok) {\n          const data = await response.json();\n          setAllWatchlistQuarterlyData({\n            [searchResultsNewsSymbol]: data.results || []\n          });\n        }\n      } catch (error) {\n        console.error(`Error fetching quarterly data:`, error);\n        setAllWatchlistQuarterlyData({ [searchResultsNewsSymbol]: [] });\n      } finally {\n        setIsWatchlistQuarterlyLoading(false);\n      }\n    };\n\n    fetchQuarterlyData();\n  }, [searchResultsNewsSymbol]);\n  // Sync watchlist stock selection with search results symbol to trigger quarterly fetch\n  useEffect(() => {\n    if (selectedWatchlistSymbol && searchResults.includes("[CHART:WATCHLIST]")) {\n      setSearchResultsNewsSymbol(selectedWatchlistSymbol);\n    }\n  }, [selectedWatchlistSymbol, searchResults]);\n\n\n\n  // Fetch news for selected watchlist symbol\n  useEffect(() => {\n    if (selectedWatchlistSymbol && (isWatchlistOpen || searchResults.includes("[CHART:WATCHLIST]"))) {\n      const fetchWatchlistNews = async () => {\n        setIsWatchlistNewsLoading(true);\n        try {\n          const cleanSymbol = selectedWatchlistSymbol.replace('-EQ', '').replace('-BE', '');\n          const response = await fetch(`/api/stock-news/${cleanSymbol}?refresh=${Date.now()}`);\n          if (response.ok) {\n            const data = await response.json();\n            const newsItems = Array.isArray(data) ? data : (data.news || []);\n            setWatchlistNews(newsItems.slice(0, 20));\n          }\n        } catch (error) {\n          console.error('Error fetching watchlist news:', error);\n        } finally {\n          setIsWatchlistNewsLoading(false);\n        }\n      };\n      fetchWatchlistNews();\n    }\n  }, [selectedWatchlistSymbol, isWatchlistOpen, searchResults]);\n\n  // Auto-fetch news for search results\n  useEffect(() => {\n    if (searchResultsNewsSymbol && searchResults.includes("[CHART:SEARCH_RESULTS]")) {\n      const fetchSearchResultsNews = async () => {\n        setIsWatchlistNewsLoading(true);\n        try {\n          const cleanSymbol = searchResultsNewsSymbol.replace('-EQ', '').replace('-BE', '');\n          const response = await fetch(`/api/stock-news/${cleanSymbol}?refresh=${Date.now()}`);\n          if (response.ok) {\n            const data = await response.json();\n            const newsItems = Array.isArray(data) ? data : (data.news || []);\n            setWatchlistNews(newsItems.slice(0, 20));\n          }\n        } catch (error) {\n          console.error('Error fetching search results news:', error);\n        } finally {\n          setIsWatchlistNewsLoading(false);\n        }\n      };\n      fetchSearchResultsNews();\n    }\n  }, [searchResultsNewsSymbol, searchResults]);\n\n  // Search stocks for watchlist\n  const searchWatchlistStocks = async (query: string) => {\n    if (!query.trim() || query.length < 2) {\n      setWatchlistSearchResults([]);\n      return;\n    }\n    setIsWatchlistSearching(true);\n    try {\n      const response = await fetch(`/api/angelone/search-instruments?query=${encodeURIComponent(query)}&exchange=NSE,BSE,MCX&limit=10`);\n      if (response.ok) {\n        const data = await response.json();\n        const instruments = data.instruments || data || [];\n        // Map to display format with symbol and name\n        const formatted = instruments.slice(0, 10).map((inst: any) => ({\n          symbol: inst.symbol || inst.trading_symbol || '',\n          displayName: inst.symbol || inst.trading_symbol || '',\n          name: inst.name || inst.company_name || inst.instrument_name || '',\n          token: inst.token || inst.exch_instrument_token || '',\n          exchange: inst.exch_seg || 'NSE',\n          tradingSymbol: inst.symbol || inst.trading_symbol || ''\n        })).filter((item: any) => item.symbol);\n        setWatchlistSearchResults(formatted);\n      }\n    } catch (error) {\n      console.error('Error searching stocks:', error);\n      setWatchlistSearchResults([]);\n    } finally {\n      setIsWatchlistSearching(false);\n    }\n  };\n\n  // Trigger search when watchlist search query changes (with debouncing)\n  useEffect(() => {\n    const debounceTimer = setTimeout(() => {\n      if (watchlistSearchQuery.trim().length > 0) {\n        searchWatchlistStocks(watchlistSearchQuery);\n      } else {\n        setWatchlistSearchResults([]);\n      }\n    }, 300); // 300ms debounce\n\n    return () => clearTimeout(debounceTimer);\n  }, [watchlistSearchQuery]);\n\n\n  // Fetch company insights when watchlist stock is selected (same logic as main search)\n  useEffect(() => {\n    if (selectedWatchlistSymbol) {\n      const fetchWatchlistCompanyInsights = async () => {\n        try {\n          const response = await fetch(`/api/trading-agent?symbol=${encodeURIComponent(selectedWatchlistSymbol)}`);\n          if (response.ok) {\n            const data = await response.json();\n            if (data.companyInsights) {\n              (window as any).companyInsightsData = data.companyInsights;\n            }\n          }\n        } catch (error) {\n          console.error('Error fetching watchlist company insights:', error);\n        }\n      };\n      fetchWatchlistCompanyInsights();\n    }\n  }, [selectedWatchlistSymbol]);\n  // Add stock to watchlist\n  const addToWatchlist = (stock: { symbol: string; name: string; token: string; exchange: string; displayName: string; tradingSymbol: string }) => {\n    if (!watchlistSymbols.find(s => s.symbol === stock.symbol)) {\n      setWatchlistSymbols(prev => [...prev, stock]);\n      setSelectedWatchlistSymbol(stock.symbol);\n    }\n    setWatchlistSearchQuery('');\n    setWatchlistSearchResults([]);\n  };\n\n  // Remove stock from watchlist\n  const removeFromWatchlist = (symbol: string) => {\n    setWatchlistSymbols(prev => prev.filter(s => s.symbol !== symbol));\n    if (selectedWatchlistSymbol === symbol && watchlistSymbols.length > 1) {\n      const remaining = watchlistSymbols.filter(s => s.symbol !== symbol);\n      setSelectedWatchlistSymbol(remaining[0]?.symbol || '');\n    }\n  };\n\n  // Get relative time for news\n  const getWatchlistNewsRelativeTime = (publishedAt: string) => {\n    const now = new Date();\n    const published = new Date(publishedAt);\n    const diffMs = now.getTime() - published.getTime();\n    const diffMins = Math.floor(diffMs / (1000 * 60));\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    return `${diffDays}d ago`;\n  };\n\n  // Journal chart timeframe options (same as Trading Master OHLC window)\n  const journalTimeframeOptions = [\n    { value: '1', label: '1min' },\n    { value: '3', label: '3min' },\n    { value: '5', label: '5min' },\n    { value: '10', label: '10min' },\n    { value: '15', label: '15min' },\n    { value: '30', label: '30min' },\n    { value: '60', label: '1hr' },\n    { value: '120', label: '2hr' },\n    { value: '1D', label: '1D' },\n  ];\n\n  // Get label for current timeframe\n  const getJournalTimeframeLabel = (value: string) => {\n    const tf = journalTimeframeOptions.find(t => t.value === value);\n    return tf ? tf.label : value;\n  };\n\n  // Convert timeframe to Angel One API interval format (minutes)\n  const getJournalAngelOneInterval = (timeframe: string): string => {\n    // Convert preset timeframes to minutes (1D -> 1440 minutes)\n    const presetToMinutes: { [key: string]: string } = {\n      '1D': '1440',\n      '1W': '10080',\n      '1M': '43200'\n    };\n\n    // If preset (1D/1W/1M), convert to minutes; otherwise pass as-is (already in minutes)\n    return presetToMinutes[timeframe] || timeframe;\n  };\n\n  // Default popular instruments for each category (pre-populated)\n  // Note: Only stocks and indices have stable tokens. Commodity/F&O tokens change with contract expiry.\n  const defaultInstruments = {\n    all: [\n      { symbol: 'RELIANCE-EQ', name: 'Reliance Industries', token: '2885', exchange: 'NSE', instrumentType: '', displayName: 'RELIANCE', tradingSymbol: 'RELIANCE-EQ' },\n      { symbol: 'TCS-EQ', name: 'Tata Consultancy Services', token: '11536', exchange: 'NSE', instrumentType: '', displayName: 'TCS', tradingSymbol: 'TCS-EQ' },\n      { symbol: 'INFY-EQ', name: 'Infosys Limited', token: '1594', exchange: 'NSE', instrumentType: '', displayName: 'INFY', tradingSymbol: 'INFY-EQ' },\n      { symbol: 'HDFCBANK-EQ', name: 'HDFC Bank', token: '1333', exchange: 'NSE', instrumentType: '', displayName: 'HDFCBANK', tradingSymbol: 'HDFCBANK-EQ' },\n      { symbol: 'Nifty 50', name: 'Nifty 50 Index', token: '99926000', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'NIFTY 50', tradingSymbol: 'Nifty 50' },\n      { symbol: 'Nifty Bank', name: 'Nifty Bank Index', token: '99926009', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'BANK NIFTY', tradingSymbol: 'Nifty Bank' },\n    ],\n    stock: [\n      { symbol: 'RELIANCE-EQ', name: 'Reliance Industries', token: '2885', exchange: 'NSE', instrumentType: '', displayName: 'RELIANCE', tradingSymbol: 'RELIANCE-EQ' },\n      { symbol: 'TCS-EQ', name: 'Tata Consultancy Services', token: '11536', exchange: 'NSE', instrumentType: '', displayName: 'TCS', tradingSymbol: 'TCS-EQ' },\n      { symbol: 'INFY-EQ', name: 'Infosys Limited', token: '1594', exchange: 'NSE', instrumentType: '', displayName: 'INFY', tradingSymbol: 'INFY-EQ' },\n      { symbol: 'HDFCBANK-EQ', name: 'HDFC Bank', token: '1333', exchange: 'NSE', instrumentType: '', displayName: 'HDFCBANK', tradingSymbol: 'HDFCBANK-EQ' },\n      { symbol: 'ICICIBANK-EQ', name: 'ICICI Bank', token: '4963', exchange: 'NSE', instrumentType: '', displayName: 'ICICIBANK', tradingSymbol: 'ICICIBANK-EQ' },\n      { symbol: 'SBIN-EQ', name: 'State Bank of India', token: '3045', exchange: 'NSE', instrumentType: '', displayName: 'SBIN', tradingSymbol: 'SBIN-EQ' },\n      { symbol: 'BHARTIARTL-EQ', name: 'Bharti Airtel', token: '10604', exchange: 'NSE', instrumentType: '', displayName: 'BHARTIARTL', tradingSymbol: 'BHARTIARTL-EQ' },\n      { symbol: 'KOTAKBANK-EQ', name: 'Kotak Mahindra Bank', token: '1922', exchange: 'NSE', instrumentType: '', displayName: 'KOTAKBANK', tradingSymbol: 'KOTAKBANK-EQ' },\n    ],\n    commodity: [], // Commodity tokens change with contract expiry - use search\n    fo: [], // F&O tokens change with contract expiry - use search\n    index: [\n      { symbol: 'Nifty 50', name: 'Nifty 50 Index', token: '99926000', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'NIFTY 50', tradingSymbol: 'Nifty 50' },\n      { symbol: 'Nifty Bank', name: 'Nifty Bank Index', token: '99926009', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'BANK NIFTY', tradingSymbol: 'Nifty Bank' },\n      { symbol: 'Nifty IT', name: 'Nifty IT Index', token: '99926013', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'NIFTY IT', tradingSymbol: 'Nifty IT' },\n      { symbol: 'NIFTY NEXT 50', name: 'Nifty Next 50 Index', token: '99926001', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'NIFTY NEXT 50', tradingSymbol: 'NIFTY NEXT 50' },\n      { symbol: 'Nifty Midcap 50', name: 'Nifty Midcap 50 Index', token: '99926027', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'NIFTY MIDCAP', tradingSymbol: 'Nifty Midcap 50' },\n      { symbol: 'INDIA VIX', name: 'India VIX', token: '99926004', exchange: 'NSE', instrumentType: 'AMXIDX', displayName: 'INDIA VIX', tradingSymbol: 'INDIA VIX' },\n    ],\n  };\n\n  // Search suggestions for categories without pre-populated defaults\n  const categorySearchSuggestions: Record<string, string[]> = {\n    commodity: ['gold', 'silver', 'crude', 'copper', 'natural gas', 'aluminium', 'zinc', 'nickel'],\n    fo: ['nifty', 'banknifty', 'finnifty', 'reliance', 'tcs', 'infy', 'hdfcbank'],\n    currency: ['usdinr', 'eurinr', 'gbpinr', 'jpyinr', 'eurusd'],\n  };\n\n  // Dynamic instrument search state\n  const [searchedInstruments, setSearchedInstruments] = useState<Array<{\n    symbol: string;\n    name: string;\n    token: string;\n    exchange: string;\n    instrumentType: string;\n    displayName: string;\n    tradingSymbol: string;\n  }>>([]);\n  const [isSearchingInstruments, setIsSearchingInstruments] = useState(false);\n\n  // Currently selected instrument details (for chart loading)\n  const [selectedInstrument, setSelectedInstrument] = useState<{\n    symbol: string;\n    token: string;\n    exchange: string;\n    tradingSymbol: string;\n    instrumentType?: string;\n  } | null>(null);\n\n  // FIX CRITICAL BUG: Sync selectedJournalSymbol with selectedInstrument\n  // When user selects a new instrument from search, update selectedJournalSymbol to match\n  useEffect(() => {\n    if (selectedInstrument) {\n      const newSymbol = `${selectedInstrument.exchange}:${selectedInstrument.symbol}`;\n      setSelectedJournalSymbol(newSymbol);\n      console.log(`✅ SYNC FIX: Updated selectedJournalSymbol to "${newSymbol}" (was: ${selectedJournalSymbol})`);\n    }\n  }, [selectedInstrument]);\n\n  // TradingView-style chart refs for Journal\n  const journalChartContainerRef = useRef<HTMLDivElement>(null);\n  const journalCandleCountRef = useRef<HTMLDivElement>(null);\n  const journalCountdownBarRef = useRef<HTMLDivElement>(null);\n  const journalChartRef = useRef<IChartApi | null>(null);\n  const journalCandlestickSeriesRef = useRef<ISeriesApi<'Candlestick'> | null>(null);\n  const journalEma12SeriesRef = useRef<ISeriesApi<'Line'> | null>(null);\n  const journalEma26SeriesRef = useRef<ISeriesApi<'Line'> | null>(null);\n  const journalVolumeSeriesRef = useRef<ISeriesApi<'Histogram'> | null>(null);\n  const journalPriceLineRef = useRef<IPriceLine | null>(null);\n  const journalChartDataRef = useRef<Array<{ time: number; open: number; high: number; low: number; close: number; volume?: number }>>([]);\n\n  // EMA values for display in header\n  const [journalEmaValues, setJournalEmaValues] = useState<{ ema12: number | null; ema26: number | null }>({ ema12: null, ema26: null });\n\n  // Live streaming state for Journal Chart\n  const [journalLiveData, setJournalLiveData] = useState<{\n    ltp: number;\n    countdown: { remaining: number; total: number; formatted: string };\n    currentCandle: { time: number; open: number; high: number; low: number; close: number; volume: number };\n    isMarketOpen: boolean;\n  } | null>(null);\n  const [isJournalStreaming, setIsJournalStreaming] = useState(false);\n  const journalEventSourceRef = useRef<EventSource | null>(null);\n\n  // Live OHLC ticker for display\n  const [liveOhlc, setLiveOhlc] = useState<{ open: number; high: number; low: number; close: number; change: number } | null>(null);\n\n  // Hovered candle OHLC for crosshair display (TradingView style)\n  const [hoveredCandleOhlc, setHoveredCandleOhlc] = useState<{\n    open: number;\n    high: number;\n    low: number;\n    close: number;\n    change: number;\n    changePercent: number;\n    time: number;\n  } | null>(null);\n\n  // ========== CHART MODE SYSTEM ==========\n  // Two separate charts: Search Chart (manual symbol search) vs Heatmap Chart (date selection)\n  const [journalChartMode, setJournalChartMode] = useState<'search' | 'heatmap'>('search');\n\n  // ========== HEATMAP CHART STATE (Separate from Search Chart) ==========\n  const [heatmapChartData, setHeatmapChartData] = useState<Array<{ time: number; open: number; high: number; low: number; close: number; volume?: number }>>([]);\n  const [heatmapChartLoading, setHeatmapChartLoading] = useState(false);\n  const [heatmapChartTimeframe, setHeatmapChartTimeframe] = useState('1'); // Default 1 minute\n  const [heatmapSelectedSymbol, setHeatmapSelectedSymbol] = useState(''); // Symbol from heatmap date\n  const [heatmapSelectedDate, setHeatmapSelectedDate] = useState(''); // Date from heatmap calendar\n  const [heatmapTradeHistory, setHeatmapTradeHistory] = useState<any[]>([]); // Trade history for heatmap date\n\n  // Heatmap Chart refs (completely separate from Search Chart)\n  const heatmapChartContainerRef = useRef<HTMLDivElement>(null);\n  const heatmapChartRef = useRef<IChartApi | null>(null);\n  const heatmapCandlestickSeriesRef = useRef<ISeriesApi<'Candlestick'> | null>(null);\n  const heatmapEma12SeriesRef = useRef<ISeriesApi<'Line'> | null>(null);\n  const heatmapEma26SeriesRef = useRef<ISeriesApi<'Line'> | null>(null);\n  const heatmapVolumeSeriesRef = useRef<ISeriesApi<'Histogram'> | null>(null);\n  const heatmapSeriesMarkersRef = useRef<any>(null); // Stores createSeriesMarkers wrapper\n  const heatmapChartDataRef = useRef<Array<{ time: number; open: number; high: number; low: number; close: number; volume?: number }>>([]);\n\n  // Heatmap OHLC display (separate from search chart)\n  const [heatmapHoveredOhlc, setHeatmapHoveredOhlc] = useState<{\n    open: number;\n    high: number;\n    low: number;\n    close: number;\n    change: number;\n    changePercent: number;\n    time: number;\n  } | null>(null);\n\n  // Angel One Stock Token Mapping for Journal Chart (Expanded for all exchanges)\n  const journalAngelOneTokens: { [key: string]: { token: string, exchange: string, tradingSymbol: string } } = {\n    // NSE Indices\n    'NIFTY50': { token: '99926000', exchange: 'NSE', tradingSymbol: 'Nifty 50' },\n    'NIFTY': { token: '99926000', exchange: 'NSE', tradingSymbol: 'Nifty 50' },\n    'BANKNIFTY': { token: '99926009', exchange: 'NSE', tradingSymbol: 'Nifty Bank' },\n    'NIFTYIT': { token: '99926013', exchange: 'NSE', tradingSymbol: 'Nifty IT' },\n    'NIFTYNEXT50': { token: '99926001', exchange: 'NSE', tradingSymbol: 'NIFTY NEXT 50' },\n    'NIFTYMIDCAP50': { token: '99926027', exchange: 'NSE', tradingSymbol: 'Nifty Midcap 50' },\n    'INDIAVIX': { token: '99926004', exchange: 'NSE', tradingSymbol: 'INDIA VIX' },\n    // NSE Stocks\n    'RELIANCE': { token: '2885', exchange: 'NSE', tradingSymbol: 'RELIANCE-EQ' },\n    'TCS': { token: '11536', exchange: 'NSE', tradingSymbol: 'TCS-EQ' },\n    'HDFCBANK': { token: '1333', exchange: 'NSE', tradingSymbol: 'HDFCBANK-EQ' },\n    'INFY': { token: '1594', exchange: 'NSE', tradingSymbol: 'INFY-EQ' },\n    'ICICIBANK': { token: '4963', exchange: 'NSE', tradingSymbol: 'ICICIBANK-EQ' },\n    'SBIN': { token: '3045', exchange: 'NSE', tradingSymbol: 'SBIN-EQ' },\n    'BHARTIARTL': { token: '10604', exchange: 'NSE', tradingSymbol: 'BHARTIARTL-EQ' },\n    'ITC': { token: '1660', exchange: 'NSE', tradingSymbol: 'ITC-EQ' },\n    'KOTAKBANK': { token: '1922', exchange: 'NSE', tradingSymbol: 'KOTAKBANK-EQ' },\n    'LT': { token: '11483', exchange: 'NSE', tradingSymbol: 'LT-EQ' },\n    'AXISBANK': { token: '5900', exchange: 'NSE', tradingSymbol: 'AXISBANK-EQ' },\n    'WIPRO': { token: '3787', exchange: 'NSE', tradingSymbol: 'WIPRO-EQ' },\n    'TATASTEEL': { token: '3499', exchange: 'NSE', tradingSymbol: 'TATASTEEL-EQ' },\n    // BSE Indices\n    'SENSEX': { token: '99919000', exchange: 'BSE', tradingSymbol: 'SENSEX' },\n    // MCX Commodities\n    'GOLD': { token: '232801', exchange: 'MCX', tradingSymbol: 'GOLD' },\n    'CRUDEOIL': { token: '232665', exchange: 'MCX', tradingSymbol: 'CRUDEOIL' },\n    'SILVER': { token: '234977', exchange: 'MCX', tradingSymbol: 'SILVER' },\n  };\n\n  // Store selected instrument with token (direct from search API)\n  const [selectedInstrumentToken, setSelectedInstrumentToken] = useState<{ token: string; exchange: string; tradingSymbol: string } | null>(null);\n\n  // Convert NSE/MCX symbol format to Angel One format with fuzzy matching\n  const getJournalAngelOneSymbol = (symbol: string): string => {\n    let cleanSymbol = symbol\n      .replace(/^(NSE|BSE|MCX|NCDEX|NFO|BFO|CDS):/, '')\n      .replace(/-EQ$/, '')\n      .replace(/-INDEX$/, '')\n      .replace(/-COM$/, '')\n      .replace(/-FUT$/, '')\n      .replace(/-OPT$/, '');\n\n    // Normalize spaces and case for better matching\n    cleanSymbol = cleanSymbol.replace(/\s+/g, '').toUpperCase();\n\n    // Try direct lookup first\n    if (journalAngelOneTokens[cleanSymbol]) {\n      return cleanSymbol;\n    }\n\n    // Try fuzzy matching (handle "Nifty 50" → "NIFTY50")\n    const fuzzyMatches: { [key: string]: string } = {\n      'NIFTY50': 'NIFTY50',\n      'NIFTYBANK': 'BANKNIFTY',\n      'NIFTYIT': 'NIFTYIT',\n      'BANKNIFTY': 'BANKNIFTY',\n      'INDIAVIX': 'INDIAVIX',\n      'SENSEX': 'SENSEX',\n      'GOLD': 'GOLD',\n      'CRUDEOIL': 'CRUDEOIL',\n      'SILVER': 'SILVER',\n    };\n\n    return fuzzyMatches[cleanSymbol] || cleanSymbol;\n  };\n\n  // 🔶 PURE NUMERIC: Convert custom timeframe to minutes ONLY (no "2D", only "2880")\n  const convertJournalCustomTimeframe = (type: string, interval: string): string => {\n    const num = parseInt(interval);\n    if (isNaN(num) || num <= 0) return '1';\n\n    switch (type) {\n      case 'minutes': return num.toString(); // 80 → "80"\n      case 'hr': return (num * 60).toString(); // 2hr → "120"\n      case 'd': return (num * 1440).toString(); // 2d → "2880" (numeric minutes!)\n      case 'm': return (num * 43200).toString(); // 1m → "43200" (30 days)\n      case 'w': return (num * 10080).toString(); // 2w → "20160" (numeric minutes!)\n      default: return '1';\n    }\n  };\n\n  const createJournalCustomTimeframeLabel = (type: string, interval: string): string => {\n    const num = parseInt(interval);\n    switch (type) {\n      case 'minutes': return `${num}min`;\n      case 'hr': return `${num}hr`;\n      case 'd': return `${num}d`;\n      case 'm': return `${num}m`;\n      case 'w': return `${num}w`;\n      default: return `${num}min`;\n    }\n  };\n\n  // 🔶 PURE NUMERIC: Just parse as integer (no more .endsWith checks!)\n  const getJournalTimeframeMinutes = (value: string): number => {\n    return parseInt(value) || 1; // Already converted by getJournalAngelOneInterval()\n  };\n\n  const deleteJournalTimeframe = (valueToDelete: string) => {\n    const isCustom = journalCustomTimeframes.some(tf => tf.value === valueToDelete);\n    if (isCustom) {\n      setJournalCustomTimeframes(prev => prev.filter(tf => tf.value !== valueToDelete));\n    } else {\n      setJournalHiddenPresetTimeframes(prev => [...prev, valueToDelete]);\n    }\n    if (selectedJournalInterval === valueToDelete) {\n      setSelectedJournalInterval('5');\n    }\n  };\n\n  const getAllJournalTimeframes = () => {\n    const allPresetTimeframes = [\n      { value: '1', label: '1min', deletable: false },\n      { value: '5', label: '5min', deletable: false },\n      { value: '10', label: '10min', deletable: true },\n      { value: '15', label: '15min', deletable: true },\n      { value: '20', label: '20min', deletable: true },\n      { value: '30', label: '30min', deletable: true },\n      { value: '40', label: '40min', deletable: true },\n      { value: '60', label: '1hr', deletable: true },\n      { value: '80', label: '80min', deletable: true },\n      { value: '120', label: '2hr', deletable: true },\n      { value: '1D', label: '1D', deletable: true },\n    ];\n    const visiblePresetTimeframes = allPresetTimeframes.filter(tf => \n      !journalHiddenPresetTimeframes.includes(tf.value)\n    );\n    const allTimeframes = [...visiblePresetTimeframes, ...journalCustomTimeframes];\n    return allTimeframes.sort((a, b) => {\n      const minutesA = getJournalTimeframeMinutes(a.value);\n      const minutesB = getJournalTimeframeMinutes(b.value);\n      return minutesA - minutesB;\n    });\n  };\n\n\n  // Map journal search type to exchange segment for filtering (similar to paper trading)\n  const getExchangeForJournalSearchType = (type: 'STOCK' | 'COMMODITY' | 'F&O'): string => {\n    switch (type) {\n      case 'STOCK':\n        return 'NSE,BSE';  // Equity stocks from NSE and BSE\n      case 'COMMODITY':\n        return 'MCX,NCDEX';  // Commodities from MCX and NCDEX\n      case 'F&O':\n        return 'NFO,BFO';  // Futures & Options from NSE F&O and BSE F&O\n      default:\n        return 'NSE,BSE';\n    }\n  };\n\n  // 🔍 Fetch instruments from Angel One master file API\n  const fetchInstruments = async (searchQuery: string, searchType: 'STOCK' | 'COMMODITY' | 'F&O') => {\n    if (!searchQuery || searchQuery.trim().length < 2) {\n      setSearchedInstruments([]);\n      return;\n    }\n\n    setIsSearchingInstruments(true);\n    try {\n      // Get exchange segment based on selected journal search type\n      const exchange = getExchangeForJournalSearchType(searchType);\n      console.log(`🔍 [JOURNAL-CHART] Searching for "${searchQuery}" on exchange: ${exchange} (type: ${searchType})`);\n\n      const response = await fetch(`/api/angelone/search-instruments?query=${encodeURIComponent(searchQuery)}&exchange=${encodeURIComponent(exchange)}&limit=50`);\n      const data = await response.json();\n\n      if (data.success && data.instruments) {\n        console.log(`🔍 [JOURNAL-CHART] Found ${data.instruments.length} instruments`);\n        setSearchedInstruments(data.instruments);\n      } else {\n        setSearchedInstruments([]);\n      }\n    } catch (error) {\n      console.error('❌ Failed to fetch instruments:', error);\n      setSearchedInstruments([]);\n    } finally {\n      setIsSearchingInstruments(false);\n    }\n  };\n\n  // useEffect to fetch instruments when search query or search type changes (with debouncing)\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (stockSearchQuery.length >= 2) {\n        fetchInstruments(stockSearchQuery, journalSearchType);\n      } else {\n        setSearchedInstruments([]);\n      }\n    }, 300); // 300ms debounce\n\n    return () => clearTimeout(timer);\n  }, [stockSearchQuery, journalSearchType]);\n\n  // Mobile carousel state for journal panels (0=chart, 1=image, 2=notes)\n  const [mobileJournalPanel, setMobileJournalPanel] = useState(2);\n\n\n  // Mobile trade history dropdown state\n  const [showMobileTradeHistory, setShowMobileTradeHistory] = useState(false);\n\n  // Calculate EMA (Exponential Moving Average)\n  const calculateEMA = (prices: number[], period: number): number[] => {\n    if (prices.length === 0) return [];\n    const k = 2 / (period + 1);\n    const ema: number[] = [];\n    let sma = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;\n    ema.push(sma);\n    for (let i = period; i < prices.length; i++) {\n      sma = prices[i] * k + sma * (1 - k);\n      ema.push(sma);\n    }\n    return ema;\n  };\n\n  // ✅ MANUAL SEARCH CHART: Standalone - NO dependency on heatmap date selection\n  const fetchJournalChartData = useCallback(async () => {\n    try {\n      // STEP 1: Destroy old chart IMMEDIATELY\n      console.log(`🔄 [SEARCH CHART] Destroying old chart...`);\n      if (journalChartRef.current) {\n        try { journalChartRef.current.remove(); } catch (e) {}\n        journalChartRef.current = null;\n        journalCandlestickSeriesRef.current = null;\n        journalEma12SeriesRef.current = null;\n        journalEma26SeriesRef.current = null;\n        journalVolumeSeriesRef.current = null;\n      }\n\n      // STEP 2: Validate inputs - ONLY need symbol (for manual search)\n      if (!selectedJournalSymbol) {\n        console.warn('❌ [SEARCH CHART] No symbol selected');\n        setJournalChartLoading(false);\n        return;\n      }\n\n      console.log(`📊 [SEARCH CHART] Fetching ${selectedJournalSymbol} (manual search)`);\n      setJournalChartLoading(true);\n\n      // STEP 3: Get token - Use direct token if available, otherwise lookup\n      let stockToken = selectedInstrumentToken;\n      let cleanSymbol = selectedJournalSymbol; // Define cleanSymbol here for use in logs\n\n      if (!stockToken) {\n        // Fallback: Extract clean symbol and lookup\n        cleanSymbol = getJournalAngelOneSymbol(selectedJournalSymbol);\n        stockToken = journalAngelOneTokens[cleanSymbol];\n        console.log(`📊 [SEARCH CHART] Symbol: ${cleanSymbol}, Token: ${stockToken?.token}`);\n      } else {\n        console.log(`📊 [SEARCH CHART] Using direct token from search: ${selectedJournalSymbol}, Token: ${stockToken.token}`);\n        cleanSymbol = getJournalAngelOneSymbol(selectedJournalSymbol);\n      }\n\n      if (!stockToken) {\n        console.warn(`❌ [SEARCH CHART] No token for: ${selectedJournalSymbol}`);\n        setJournalChartLoading(false);\n        return;\n      }\n\n      // STEP 4: Build API request - fetch last 10 days for search chart\n      const interval = getJournalAngelOneInterval(journalChartTimeframe);\n      const today = new Date();\n      const tenDaysAgo = new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000);\n      const formatDateWithTime = (d: Date, time: string) => {\n        const year = d.getFullYear();\n        const month = String(d.getMonth() + 1).padStart(2, '0');\n        const day = String(d.getDate()).padStart(2, '0');\n        return `${year}-${month}-${day} ${time}`;\n      };\n\n      const requestBody = {\n        exchange: stockToken.exchange,\n        symbolToken: stockToken.token,\n        interval: interval,\n        fromDate: formatDateWithTime(tenDaysAgo, '09:15'), // Market open time\n        toDate: formatDateWithTime(today, '15:30'), // Market close time\n      };\n\n      console.log(`📊 [SEARCH CHART] API Request:`, requestBody);\n\n      // STEP 5: Fetch chart data\n      const response = await fetch(getFullApiUrl("/api/angelone/historical"), {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify(requestBody),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`❌ [SEARCH CHART] API Error ${response.status}: ${errorText}`);\n        throw new Error(`Failed to fetch chart data: ${response.status}`);\n      }\n\n      // STEP 6: Parse and map candle data\n      const data = await response.json();\n      let candleData: any[] = [];\n\n      if (data.success && data.candles && Array.isArray(data.candles)) {\n        candleData = data.candles.map((candle: any) => {\n          let unixSeconds: number;\n\n          if (typeof candle.timestamp === 'string') {\n            const [datePart, timePart] = candle.timestamp.split(' ');\n            const [year, month, day] = datePart.split('-').map(Number);\n            const [hours, minutes] = timePart.split(':').map(Number);\n            const utcDate = new Date(Date.UTC(year, month - 1, day, hours, minutes, 0));\n            const istOffsetMs = 5.5 * 60 * 60 * 1000;\n            unixSeconds = Math.floor((utcDate.getTime() - istOffsetMs) / 1000);\n          } else {\n            unixSeconds = candle.timestamp > 10000000000 ? Math.floor(candle.timestamp / 1000) : candle.timestamp;\n          }\n\n          return {\n            time: unixSeconds as any,\n            open: parseFloat(candle.open),\n            high: parseFloat(candle.high),\n            low: parseFloat(candle.low),\n            close: parseFloat(candle.close),\n            volume: parseInt(candle.volume) || 0,\n          };\n        });\n      }\n\n      console.log(`✅ [SEARCH CHART] Chart ready: ${candleData.length} candles for ${cleanSymbol}`);\n      setJournalChartData(candleData);\n\n      // Ensure we're on journal tab only (don't change mode here - let auto-fetch handle mode detection)\n      setActiveTab('journal');\n\n    } catch (error) {\n      console.error("❌ [SEARCH CHART] Error:", error);\n      setJournalChartData([]);\n    } finally {\n      setJournalChartLoading(false);\n    }\n  }, [selectedJournalSymbol, journalChartTimeframe]);\n\n  // ✅ AUTO-FETCH CHART DATA IN MANUAL MODE (only when symbol changes)\n  // ✅ AUTO-FETCH CHART DATA IN MANUAL MODE (only when symbol changes)\n  useEffect(() => {\n    if (!selectedJournalSymbol || activeTab !== "journal") return;\n\n    // Auto-fetch when symbol is selected or journal tab is opened\n    const timer = setTimeout(() => {\n      console.log(`🔄 [AUTO-FETCH] Triggering auto-fetch for ${selectedJournalSymbol}`);\n      setJournalChartMode("search"); \n      fetchJournalChartData();\n    }, 500); \n\n    return () => clearTimeout(timer);\n  }, [selectedJournalSymbol, activeTab, fetchJournalChartData]);\n\n  // ✅ AUTO-RELOAD CHART ON MOBILE PANEL SWITCH (Fixes zoom/resize issues)\n  useEffect(() => {\n    if (mobileJournalPanel === 0 && activeTab === 'journal') {\n      const timer = setTimeout(() => {\n        console.log("📱 [MOBILE-CHART] Switching to Chart panel, auto-reloading...");\n        fetchJournalChartData();\n      }, 300);\n      return () => clearTimeout(timer);\n    }\n  }, [mobileJournalPanel, activeTab, fetchJournalChartData]);\n\n  // ========== HEATMAP CHART FETCH FUNCTION (Completely Separate) ==========\n\n  // ✅ INSTANT REFETCH when Angel One token refreshes (next day or new session)\n  useEffect(() => {\n    if (!selectedJournalSymbol || !angelOneAccessToken || activeTab !== 'journal') return;\n    \n    console.log(`🔄 [TOKEN-REFRESH] Journal chart refetching with new Angel One token`);\n    fetchJournalChartData();\n  }, [angelOneAccessToken, selectedJournalSymbol, activeTab, fetchJournalChartData]);\n  const fetchHeatmapChartData = useCallback(async (symbol: string, date: string) => {\n    try {\n      console.log(`🗓️ [HEATMAP FETCH] Starting fetch for ${symbol} on ${date}`);\n\n      // STEP 1: Destroy old heatmap chart\n      if (heatmapChartRef.current) {\n        try { heatmapChartRef.current.remove(); } catch (e) {}\n        heatmapChartRef.current = null;\n        heatmapCandlestickSeriesRef.current = null;\n        heatmapEma12SeriesRef.current = null;\n        heatmapEma26SeriesRef.current = null;\n        heatmapVolumeSeriesRef.current = null;\n      }\n\n      // STEP 2: Validate inputs\n      if (!symbol) {\n        console.warn('❌ [HEATMAP FETCH] No symbol provided');\n        setHeatmapChartLoading(false);\n        return;\n      }\n\n      if (!date) {\n        console.warn('❌ [HEATMAP FETCH] No date provided');\n        setHeatmapChartLoading(false);\n        return;\n      }\n\n      setHeatmapChartLoading(true);\n      setHeatmapChartData([]);\n\n      // ✅ ENSURE DATE FORMAT IS YYYY-MM-DD STRING\n      let formattedDate = '';\n      if (typeof date === 'string') {\n        formattedDate = date;\n      } else if (date && typeof (date as any).getFullYear === 'function') {\n        const d = date as any;\n        formattedDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;\n      } else {\n        formattedDate = String(date);\n      }\n\n      setHeatmapSelectedSymbol(symbol);\n      setHeatmapSelectedDate(formattedDate);\n      console.log(`🗓️ [HEATMAP SYNC] Updated header - Date: ${formattedDate}, Symbol: ${symbol}`);\n\n      // STEP 3: Extract clean symbol and underlying symbol\n      let cleanSymbol = symbol\n        .replace(/^(NSE|BSE):/, '')\n        .replace(/-INDEX$/, '')\n        .replace(/-EQ$/, '');\n\n      // Extract underlying from options/futures (e.g., "NIFTY 22nd w MAY PE" -> "NIFTY50", "SENSEX 4th w SEP PE" -> "SENSEX")\n      const parts = cleanSymbol.split(' ');\n      if (parts.length > 1) {\n        // This is likely an option/future symbol, extract underlying\n        const underlyingPart = parts[0];\n        if (underlyingPart === 'NIFTY') {\n          cleanSymbol = 'NIFTY50';\n        } else if (['SENSEX', 'BANKNIFTY', 'FINNIFTY', 'MIDCPNIFTY'].includes(underlyingPart)) {\n          cleanSymbol = underlyingPart;\n        }\n      }\n\n      const stockToken = journalAngelOneTokens[cleanSymbol];\n      console.log(`🗓️ [HEATMAP FETCH] Symbol: ${cleanSymbol}, Token: ${stockToken?.token}`);\n\n      if (!stockToken) {\n        console.warn(`❌ [HEATMAP FETCH] No token for: ${cleanSymbol}`);\n        setHeatmapChartLoading(false);\n        return;\n      }\n\n      // STEP 4: Build API request\n      const interval = getJournalAngelOneInterval(heatmapChartTimeframe);\n      const requestBody = {\n        exchange: stockToken.exchange,\n        symbolToken: stockToken.token,\n        interval: interval,\n        date: date,\n      };\n\n      console.log(`🗓️ [HEATMAP FETCH] API Request:`, requestBody);\n\n      // STEP 5: Fetch chart data\n      const response = await fetch(getFullApiUrl("/api/angelone/historical"), {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify(requestBody),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`❌ [HEATMAP FETCH] API Error ${response.status}: ${errorText}`);\n        throw new Error(`Failed to fetch heatmap chart data: ${response.status}`);\n      }\n\n      // STEP 6: Parse and map candle data\n      const data = await response.json();\n      let candleData: any[] = [];\n\n      if (data.success && data.candles && Array.isArray(data.candles)) {\n        candleData = data.candles.map((candle: any) => {\n          let unixSeconds: number;\n\n          if (typeof candle.timestamp === 'string') {\n            const [datePart, timePart] = candle.timestamp.split(' ');\n            const [year, month, day] = datePart.split('-').map(Number);\n            const [hours, minutes] = timePart.split(':').map(Number);\n            const utcDate = new Date(Date.UTC(year, month - 1, day, hours, minutes, 0));\n            const istOffsetMs = 5.5 * 60 * 60 * 1000;\n            unixSeconds = Math.floor((utcDate.getTime() - istOffsetMs) / 1000);\n          } else {\n            unixSeconds = candle.timestamp > 10000000000 ? Math.floor(candle.timestamp / 1000) : candle.timestamp;\n          }\n\n          return {\n            time: unixSeconds as any,\n            open: parseFloat(candle.open),\n            high: parseFloat(candle.high),\n            low: parseFloat(candle.low),\n            close: parseFloat(candle.close),\n            volume: parseInt(candle.volume) || 0,\n          };\n        });\n      }\n\n      console.log(`✅ [HEATMAP FETCH] Chart ready: ${candleData.length} candles for ${cleanSymbol} on ${date}`);\n      setHeatmapChartData(candleData);\n\n      // STEP 7: Also fetch journal data for trade history markers\n      try {\n        const userId = getUserId();\n        let journalResponse;\n        let journalData = null;\n\n        // Try user-specific data first (if authenticated)\n        if (userId) {\n          journalResponse = await fetch(getFullApiUrl(`/api/user-journal/${userId}/${formattedDate}`));\n          if (journalResponse.ok) {\n            const userData = await journalResponse.json();\n            if (userData.tradeHistory && Array.isArray(userData.tradeHistory)) {\n              journalData = userData;\n              console.log(`✅ [HEATMAP FETCH] Loaded ${userData.tradeHistory.length} trades from user data for markers`);\n            }\n          }\n        }\n\n        // If no user data, try demo/shared data\n        if (!journalData) {\n          journalResponse = await fetch(getFullApiUrl(`/api/journal/${formattedDate}`));\n          if (journalResponse.ok) {\n            const demoData = await journalResponse.json();\n            if (demoData.tradeHistory && Array.isArray(demoData.tradeHistory)) {\n              journalData = demoData;\n              console.log(`✅ [HEATMAP FETCH] Loaded ${demoData.tradeHistory.length} trades from demo data for markers`);\n            }\n          }\n        }\n\n        if (journalData?.tradeHistory && Array.isArray(journalData.tradeHistory)) {\n          setHeatmapTradeHistory(journalData.tradeHistory);\n        } else {\n          console.warn('⚠️ [HEATMAP FETCH] No trade history found');\n          setHeatmapTradeHistory([]);\n        }\n      } catch (journalError) {\n        console.warn('⚠️ [HEATMAP FETCH] Could not fetch journal data for markers:', journalError);\n        setHeatmapTradeHistory([]);\n      }\n\n      // Auto-switch to heatmap mode when data loads\n      setJournalChartMode('heatmap');\n\n    } catch (error) {\n      console.error("❌ [HEATMAP FETCH] Error:", error);\n      setHeatmapChartData([]);\n    } finally {\n      setHeatmapChartLoading(false);\n    }\n  }, [heatmapChartTimeframe]);\n\n  // Reset Heatmap OHLC display when heatmap chart data changes\n  useEffect(() => {\n    if (heatmapChartData && heatmapChartData.length > 0) {\n      const latest = heatmapChartData[heatmapChartData.length - 1];\n      setHeatmapHoveredOhlc({\n        open: latest.open,\n        high: latest.high,\n        low: latest.low,\n        close: latest.close,\n        change: latest.close - latest.open,\n        changePercent: latest.open > 0 ? ((latest.close - latest.open) / latest.open) * 100 : 0,\n        time: latest.time,\n      });\n      console.log(`✅ [HEATMAP] OHLC loaded, showing latest candle`);\n    } else {\n      setHeatmapHoveredOhlc(null);\n    }\n  }, [heatmapChartData]);\n\n  // Keep heatmap chart data ref updated\n  useEffect(() => {\n    heatmapChartDataRef.current = heatmapChartData;\n  }, [heatmapChartData]);\n\n  // Auto-update heatmap chart when timeframe changes (without needing to re-select date)\n  useEffect(() => {\n    if (journalChartMode === 'heatmap' && heatmapSelectedDate && heatmapSelectedSymbol) {\n      console.log(`⏱️ [HEATMAP TIMEFRAME] Changed to ${getJournalTimeframeLabel(heatmapChartTimeframe)} - re-fetching chart for ${heatmapSelectedDate}`);\n      fetchHeatmapChartData(heatmapSelectedSymbol, heatmapSelectedDate);\n    }\n  }, [heatmapChartTimeframe, journalChartMode, fetchHeatmapChartData]);\n\n  // Reset OHLC display when chart data changes (simple - same as Trading Master)\n  useEffect(() => {\n    if (journalChartData && journalChartData.length > 0) {\n      const latest = journalChartData[journalChartData.length - 1];\n      setHoveredCandleOhlc({\n        open: latest.open,\n        high: latest.high,\n        low: latest.low,\n        close: latest.close,\n        change: latest.close - latest.open,\n        changePercent: latest.open > 0 ? ((latest.close - latest.open) / latest.open) * 100 : 0,\n        time: latest.time,\n      });\n      console.log(`✅ JOURNAL OHLC: 1-minute candles loaded, showing latest candle`);\n    } else {\n      setHoveredCandleOhlc(null);\n    }\n  }, [journalChartData]);\n\n  // 🔴 DISCONNECT: When user leaves journal tab, close SSE\n  useEffect(() => {\n    if (activeTab !== 'journal') {\n      if (journalEventSourceRef.current) {\n        journalEventSourceRef.current.close();\n        journalEventSourceRef.current = null;\n        setIsJournalStreaming(false);\n        setJournalLiveData(null);\n        console.log('🔴 [SSE] Disconnected from live stream (tab change)');\n      }\n      return;\n    }\n  }, [activeTab]);\n\n  // ✅ LIVE STREAMING: SSE connection starts immediately on journal tab open (no delay)\n  useEffect(() => {\n    if (activeTab !== 'journal') {\n      return;\n    }\n\n    // Get stock token info\n    // 🔶 IN SEARCH MODE: ALWAYS use selectedJournalSymbol (manual search)\n    // Otherwise: Try selectedInstrument (from heatmap) or fallback to mapping\n    let stockToken: { token: string, exchange: string, tradingSymbol: string } | undefined;\n\n    if (journalChartMode === 'search') {\n      // Search mode: Use selectedJournalSymbol with Angel One token mapping\n      const cleanSymbol = getJournalAngelOneSymbol(selectedJournalSymbol);\n      stockToken = journalAngelOneTokens[cleanSymbol];\n      console.log(`✅ [SSE SEARCH MODE] Using selectedJournalSymbol: ${selectedJournalSymbol} → ${cleanSymbol}, Token: ${stockToken?.token}`);\n    } else if (selectedInstrument) {\n      // Heatmap mode: Use dynamically selected instrument\n      stockToken = {\n        token: selectedInstrument.token,\n        exchange: selectedInstrument.exchange,\n        tradingSymbol: selectedInstrument.tradingSymbol\n      };\n      console.log('✅ [SSE HEATMAP MODE] Using dynamically selected instrument:', selectedInstrument);\n    } else {\n      // Fallback: Use hardcoded mapping\n      const cleanSymbol = getJournalAngelOneSymbol(selectedJournalSymbol);\n      stockToken = journalAngelOneTokens[cleanSymbol];\n      console.log('✅ [SSE FALLBACK] Using hardcoded token mapping for:', cleanSymbol);\n    }\n\n    if (!stockToken) {\n      console.warn(`❌ [SSE] No token found for symbol: ${selectedJournalSymbol} (mode: ${journalChartMode})`);\n      return;\n    }\n\n    // Close existing connection if any\n    if (journalEventSourceRef.current) {\n      journalEventSourceRef.current.close();\n      journalEventSourceRef.current = null;\n    }\n\n    // 🔴 FIX: Get last candle from chart data for initial OHLC values (if available)\n    // Don't block SSE connection if chart data isn't ready yet - SSE starts independently\n    const lastCandle = journalChartData && journalChartData.length > 0 ? journalChartData[journalChartData.length - 1] : undefined;\n\n    // 🔶 Convert selected timeframe to seconds (selectedJournalInterval is in minutes)\n    const intervalSeconds = parseInt(selectedJournalInterval || "1") * 60;\n\n    // Start new WebSocket SSE connection with REAL Angel One market data\n    let sseUrl = getFullApiUrl(`/api/angelone/live-stream-ws?symbol=${stockToken.tradingSymbol}&symbolToken=${stockToken.token}&exchange=${stockToken.exchange}&tradingSymbol=${stockToken.tradingSymbol}&interval=${intervalSeconds}`);\n\n    // Add initial OHLC as fallback for when real API fails\n    if (lastCandle && lastCandle.close > 0) {\n      sseUrl += `&open=${lastCandle.open}&high=${lastCandle.high}&low=${lastCandle.low}&close=${lastCandle.close}&volume=${lastCandle.volume || 0}`;\n      console.log('📡 [SSE] Initial fallback OHLC:', { open: lastCandle.open, high: lastCandle.high, low: lastCandle.low, close: lastCandle.close });\n    }\n\n    console.log(`📡 [SSE] Connecting with timeframe: ${selectedJournalInterval}min (${intervalSeconds}s candle interval)`);\n\n    const eventSource = new EventSource(sseUrl);\n    journalEventSourceRef.current = eventSource;\n\n    eventSource.onopen = () => {\n      console.log('📡 [SSE] Connected to:', sseUrl);\n      setIsJournalStreaming(true);\n    };\n\n    eventSource.onmessage = (event) => {\n      try {\n        console.log('📡 [SSE MESSAGE] Raw data:', event.data.substring(0, 100));\n        const liveCandle = JSON.parse(event.data);\n        console.log('💹 [PRICE] LTP:', liveCandle.close, 'Open:', liveCandle.open, 'Time:', liveCandle.time);\n\n        // Update demo trading positions with live price (700ms real-time P&L)\n        if (liveCandle.close > 0 && paperPositions.length > 0) {\n          setPaperPositions(prev => prev.map(position => {\n            if (position.isOpen && position.symbol === selectedJournalSymbol.replace('NSE:', '').replace('-INDEX', '')) {\n              const pnl = (liveCandle.close - position.entryPrice) * position.quantity;\n              const pnlPercent = ((liveCandle.close - position.entryPrice) / position.entryPrice) * 100;\n              return { ...position, currentPrice: liveCandle.close, pnl, pnlPercent };\n            }\n            return position;\n          }));\n\n          // 🔴 FIX: Only update current price for trade entry form if user EXPLICITLY selected an instrument in paper trading\n          // WITHOUT THIS CHECK: Empty paperTradeSymbol caused "".includes to be true for all strings!\n          if (paperTradeSymbol && selectedJournalSymbol.includes(paperTradeSymbol)) {\n            setPaperTradeCurrentPrice(liveCandle.close);\n          }\n        }\n\n        // Update chart candlestick - only if chart is initialized\n        if (journalCandlestickSeriesRef.current && journalChartRef.current && liveCandle.close > 0) {\n          // 🔶 Convert selected timeframe to seconds (selectedJournalInterval is in minutes)\n          const intervalSeconds = parseInt(selectedJournalInterval || "1") * 60;\n          console.log(`⏱️ [INTERVAL] Using ${selectedJournalInterval}min = ${intervalSeconds}s for countdown`);\n\n          // Get the last candle from the chart (use ref to avoid triggering re-render)\n          const chartData = journalChartDataRef.current;\n          if (!chartData || chartData.length === 0) {\n            console.warn('⚠️ Chart data ref is empty, skipping update');\n            return;\n          }\n          const lastChartCandle = chartData[chartData.length - 1];\n          if (!lastChartCandle) return;\n\n          // Calculate the candle start time for the incoming live data (align to interval)\n          const currentCandleStartTime = Math.floor(liveCandle.time / intervalSeconds) * intervalSeconds;\n\n          // Calculate the start time of the last chart candle\n          const lastCandleStartTime = Math.floor(lastChartCandle.time / intervalSeconds) * intervalSeconds;\n\n          // Calculate countdown for the current candle\n          const currentTime = Math.floor(Date.now() / 1000);\n          const nextCandleTime = currentCandleStartTime + intervalSeconds;\n          const remainingSeconds = Math.max(0, nextCandleTime - currentTime);\n          const remainingMinutes = Math.floor(remainingSeconds / 60);\n          const remainingSecondsDisplay = remainingSeconds % 60;\n\n          // CRITICAL FIX: Check if market is open from SSE response (isMarketOpen or marketStatus)\n          const isMarketActuallyOpen = liveCandle.isMarketOpen === true || liveCandle.marketStatus === 'live' || liveCandle.marketStatus === 'delayed';\n\n          // Only show countdown if market is open, otherwise show empty\n          const countdownFormatted = isMarketActuallyOpen \n            ? (remainingMinutes > 0 \n            ? `${remainingMinutes}:${remainingSecondsDisplay.toString().padStart(2, '0')}`\n            : `${remainingSeconds}s`)\n            : "";\n\n          // Update or create price line with LTP and countdown\n          if (journalCandlestickSeriesRef.current) {\n            // Remove existing price line if it exists\n            if (journalPriceLineRef.current) {\n              journalCandlestickSeriesRef.current.removePriceLine(journalPriceLineRef.current);\n            }\n\n            // Create new price line with current LTP and countdown\n            journalPriceLineRef.current = journalCandlestickSeriesRef.current.createPriceLine({\n              price: liveCandle.close,\n              color: liveCandle.close >= liveCandle.open ? '#16a34a' : '#dc2626',\n              lineWidth: 1,\n              lineStyle: 2,\n              axisLabelVisible: true,\n              title: isMarketActuallyOpen ? countdownFormatted : '',\n            });\n          }\n\n          // Update journalLiveData state with countdown\n          setJournalLiveData({\n            ltp: liveCandle.close,\n            countdown: {\n              remaining: isMarketActuallyOpen ? remainingSeconds : 0,\n              total: intervalSeconds,\n              formatted: isMarketActuallyOpen ? countdownFormatted : 'Market Closed'\n            },\n            currentCandle: {\n              time: liveCandle.time,\n              open: liveCandle.open,\n              high: liveCandle.high,\n              low: liveCandle.low,\n              close: liveCandle.close,\n              volume: liveCandle.volume || 0\n            },\n            isMarketOpen: isMarketActuallyOpen\n          });\n\n          // Only update if we're within the same candle interval\n          if (currentCandleStartTime === lastCandleStartTime) {\n            // CRITICAL: Preserve candle OHLC - update only what changed\n            // Use the last chart candle's open value (don't replace with latest price)\n            const candleOpen = lastChartCandle.open; // PRESERVE original open\n            const candleHigh = Math.max(lastChartCandle.high, liveCandle.close); // Update high if price exceeded\n            const candleLow = Math.min(lastChartCandle.low, liveCandle.close); // Update low if price went below\n            const candleClose = liveCandle.close; // Update close with latest price\n\n            const changePercent = candleOpen > 0 ? ((candleClose - candleOpen) / candleOpen) * 100 : 0;\n\n            // 🔴 CRITICAL: SAVE the current candle's final OHLC to use when it becomes the "previous" candle\n            (window as any).journalLastFinalizedOHLC = {\n              open: candleOpen,\n              high: candleHigh,\n              low: candleLow,\n              close: candleClose,\n              time: lastChartCandle.time\n            };\n\n            setLiveOhlc({\n              open: candleOpen,\n              high: candleHigh,\n              low: candleLow,\n              close: candleClose,\n              change: changePercent\n            });\n\n            // Update the current candle with preserved OHLC\n            setTimeout(() => {\n              try {\n                journalCandlestickSeriesRef.current?.update({\n                  time: lastChartCandle.time as any,\n                  open: candleOpen,\n                  high: candleHigh,\n                  low: candleLow,\n                  close: candleClose\n                });\n              } catch (e) {\n                console.warn('⚠️ Chart update skipped (time conflict)', e);\n              }\n            }, 50);\n\n            console.log(`📊 [UPDATE] Same candle interval, OHLC: O${candleOpen} H${candleHigh} L${candleLow} C${candleClose}`);\n          } else if (currentCandleStartTime > lastCandleStartTime && isMarketActuallyOpen) {\n            // We've crossed into a new candle interval AND market is open - add new candle\n            console.log('🆕 [NEW CANDLE] New interval detected, adding new candle to chart (market is open)');\n\n            // 🔴 CRITICAL: Use the SAVED final OHLC from the previous candle's last update\n            // NOT the new candle's data!\n            const savedOHLC = (window as any).journalLastFinalizedOHLC;\n            const prevCandleOpen = savedOHLC?.open || lastChartCandle.open;\n            const prevCandleHigh = savedOHLC?.high || lastChartCandle.high;\n            const prevCandleLow = savedOHLC?.low || lastChartCandle.low;\n            const prevCandleClose = savedOHLC?.close || lastChartCandle.close;\n\n            console.log(`✅ [USING SAVED OHLC] From last update: O${prevCandleOpen} H${prevCandleHigh} L${prevCandleLow} C${prevCandleClose} (NOT from new candle with close: ${liveCandle.close})`);\n\n            // 🔴 CRITICAL FIX: For new candle, initialize OHLC properly\n            // Don't use live data's OHLC directly (it's just a single price point)\n            // Instead, initialize new candle with current price for all OHLC values\n            // Subsequent updates will adjust H and L while preserving O and C\n            const newCandle = {\n              time: currentCandleStartTime,\n              open: liveCandle.close,  // 🔴 FIX: Initialize with current price (not liveCandle.open)\n              high: liveCandle.close,  // 🔴 FIX: Initialize with current price\n              low: liveCandle.close,   // 🔴 FIX: Initialize with current price\n              close: liveCandle.close,\n              volume: liveCandle.volume || 0\n            };\n            console.log(`🕯️ [NEW CANDLE INIT] Initialized O/H/L/C all to ${liveCandle.close} (will update H/L with future prices)`);\n\n            // UPDATE STATE: Finalize previous candle + add new candle atomically\n            const updatedChartData = (() => {\n              const prev = journalChartDataRef.current || [];\n              // Avoid duplicate new candles\n              const newCandleExists = prev.some(c => c.time === currentCandleStartTime);\n              if (newCandleExists) return prev;\n\n              // Create updated array with:\n              // 1. All previous candles EXCEPT the last one\n              // 2. The last candle with its FINALIZED OHLC\n              // 3. The new candle\n              const updated = [...prev];\n              if (updated.length > 0) {\n                // Update the last candle's OHLC to match what we calculated\n                updated[updated.length - 1] = {\n                  ...updated[updated.length - 1],\n                  open: prevCandleOpen,\n                  high: prevCandleHigh,\n                  low: prevCandleLow,\n                  close: prevCandleClose\n                };\n              }\n              updated.push(newCandle);\n              return updated;\n            })();\n\n            // Update BOTH state and ref synchronously to prevent desync\n            setJournalChartData(updatedChartData);\n            journalChartDataRef.current = updatedChartData;\n\n            // 🔴 CRITICAL: Save viewport BEFORE any chart updates to prevent flickering\n            let savedViewportRange: any = null;\n            if (journalChartRef.current) {\n              try {\n                const timeScale = journalChartRef.current.timeScale();\n                savedViewportRange = timeScale.getVisibleRange();\n              } catch (e) {\n                console.warn('⚠️ Could not save viewport range', e);\n              }\n            }\n\n            // Update chart series with viewport preservation\n            setTimeout(() => {\n              if (journalCandlestickSeriesRef.current && journalChartRef.current) {\n                try {\n                  // FINALIZE previous candle on chart with its complete OHLC\n                  journalCandlestickSeriesRef.current.update({\n                    time: lastChartCandle.time as any,\n                    open: prevCandleOpen,\n                    high: prevCandleHigh,\n                    low: prevCandleLow,\n                    close: prevCandleClose\n                  });\n                  console.log(`✅ [CANDLE FINALIZED] Previous candle locked with OHLC: O${prevCandleOpen} H${prevCandleHigh} L${prevCandleLow} C${prevCandleClose}`);\n\n                  // Add the new candle immediately after finalizing previous\n                  // 🔴 FIX: Use corrected OHLC values (all initialized to current price)\n                  journalCandlestickSeriesRef.current.update({\n                    time: currentCandleStartTime as any,\n                    open: newCandle.open,\n                    high: newCandle.high,\n                    low: newCandle.low,\n                    close: newCandle.close\n                  });\n                  console.log(`🕯️ [CANDLE ADDED] New candle: O${newCandle.open} H${newCandle.high} L${newCandle.low} C${newCandle.close}`);\n\n                  // 🎯 Restore viewport IMMEDIATELY after all candle updates\n                  if (savedViewportRange) {\n                    try {\n                      const timeScale = journalChartRef.current.timeScale();\n                      timeScale.setVisibleRange(savedViewportRange);\n                      console.log('✅ [VIEWPORT RESTORED] Smooth transition complete');\n                    } catch (e) {\n                      console.warn('⚠️ Viewport restoration skipped', e);\n                    }\n                  }\n                } catch (e) {\n                  console.warn('⚠️ Candle update skipped (time conflict)', e);\n                }\n              }\n            }, 20);\n\n            // 🔴 FIX: Update live OHLC display using corrected new candle values\n            const changePercent = newCandle.open > 0 ? ((newCandle.close - newCandle.open) / newCandle.open) * 100 : 0;\n            setLiveOhlc({\n              open: newCandle.open,\n              high: newCandle.high,\n              low: newCandle.low,\n              close: newCandle.close,\n              change: changePercent\n            });\n\n            // Update candle count display (use ref to get count)\n            if (journalCandleCountRef.current) {\n              journalCandleCountRef.current.textContent = `${chartData.length + 1}`;\n            }\n\n            console.log(`🕯️ [CANDLE ADDED] Time: ${new Date(currentCandleStartTime * 1000).toLocaleTimeString()} OHLC: O${newCandle.open} H${newCandle.high} L${newCandle.low} C${newCandle.close}`);\n          }\n\n          // Update countdown bar\n          if (journalCountdownBarRef.current) {\n            const percentRemaining = (remainingSeconds / intervalSeconds) * 100;\n            journalCountdownBarRef.current.style.width = `${percentRemaining}%`;\n            journalCountdownBarRef.current.style.transformOrigin = 'right center';\n            journalCountdownBarRef.current.title = `${remainingSeconds}s / ${intervalSeconds}s`;\n          }\n        } else {\n          console.log('⏳ Chart not ready yet:', { hasRef: !!journalCandlestickSeriesRef.current, hasChart: !!journalChartRef.current });\n        }\n      } catch (err) {\n        console.error('❌ SSE parse error:', err instanceof Error ? err.message : String(err));\n      }\n    };\n\n    eventSource.onerror = (err) => {\n      console.error('❌ [SSE ERROR]:', err);\n      setIsJournalStreaming(false);\n    };\n\n    return () => {\n      if (eventSource) {\n        eventSource.close();\n      }\n      setIsJournalStreaming(false);\n    };\n  }, [activeTab, selectedJournalSymbol, selectedJournalInterval, journalChartMode]);\n\n  // Keep ref in sync with state for SSE logic (avoid recreating SSE on every data change)\n  useEffect(() => {\n    journalChartDataRef.current = journalChartData;\n  }, [journalChartData]);\n\n  // ❌ REMOVED: useEffect that fetched based on journalSelectedDate\n  // Manual search chart is now standalone - only fetches on explicit button click\n\n  // Initialize and render TradingView-style chart for Journal\n  useEffect(() => {\n    if (activeTab !== 'journal') {\n      if (journalChartRef.current) {\n        try {\n          journalChartRef.current.remove();\n        } catch (e) {}\n        journalChartRef.current = null;\n        journalCandlestickSeriesRef.current = null;\n        journalEma12SeriesRef.current = null;\n        journalEma26SeriesRef.current = null;\n      }\n      return;\n    }\n\n    if (!journalChartContainerRef.current) return;\n\n    // Only render chart if we have data - don't show placeholder (user sees loading indicator)\n    if (!journalChartData || journalChartData.length === 0) {\n      return;\n    }\n\n    // ✅ ALWAYS recreate chart when data changes (master effect already destroyed old one)\n    console.log(`📊 Rendering chart with ${journalChartData.length} candles`);\n\n    // Clear container first to remove any placeholder or old content\n    journalChartContainerRef.current.innerHTML = '';\n\n    // Defer chart creation until layout is ready\n    requestAnimationFrame(() => {\n      if (!journalChartContainerRef.current) return;\n\n      try {\n        const containerWidth = journalChartContainerRef.current.clientWidth || 800;\n        const containerHeight = journalChartContainerRef.current.clientHeight || 400;\n\n        console.log('📊 Chart container dimensions:', { containerWidth, containerHeight });\n\n        const chart = createChart(journalChartContainerRef.current, {\n        layout: {\n          background: { type: ColorType.Solid, color: '#ffffff' },\n          textColor: '#1f2937',\n        },\n        grid: {\n          vertLines: { color: '#f3f4f6', style: 1 },\n          horzLines: { color: '#f3f4f6', style: 1 },\n        },\n        crosshair: {\n          mode: 1,\n          vertLine: { color: '#9ca3af', width: 1, style: 2, labelBackgroundColor: '#f3f4f6' },\n          horzLine: { color: '#9ca3af', width: 1, style: 2, labelBackgroundColor: '#f3f4f6' },\n        },\n        rightPriceScale: {\n          visible: true,\n          borderVisible: true,\n          borderColor: '#e5e7eb',\n          scaleMargins: { top: 0.1, bottom: 0.25 },\n          autoScale: true,\n        },\n        timeScale: {\n          visible: true,\n          borderVisible: true,\n          borderColor: '#e5e7eb',\n          timeVisible: true,\n          secondsVisible: false,\n          barSpacing: 12,\n          minBarSpacing: 4,\n          fixLeftEdge: false,\n          fixRightEdge: false,\n          lockVisibleTimeRangeOnResize: false,\n          tickMarkFormatter: (time: number) => {\n            // Convert UTC timestamp to IST (UTC+5:30) and format for display\n            const date = new Date(time * 1000);\n            // Add IST offset: 5 hours 30 minutes = 330 minutes\n            const istDate = new Date(date.getTime() + (330 * 60 * 1000));\n            const hours = istDate.getUTCHours().toString().padStart(2, '0');\n            const minutes = istDate.getUTCMinutes().toString().padStart(2, '0');\n            return `${hours}:${minutes}`;\n          },\n        },\n        localization: {\n          timeFormatter: (time: number) => {\n            // Format time for crosshair tooltip in IST\n            const date = new Date(time * 1000);\n            const istDate = new Date(date.getTime() + (330 * 60 * 1000));\n            const hours = istDate.getUTCHours().toString().padStart(2, '0');\n            const minutes = istDate.getUTCMinutes().toString().padStart(2, '0');\n            const day = istDate.getUTCDate().toString().padStart(2, '0');\n            const month = (istDate.getUTCMonth() + 1).toString().padStart(2, '0');\n            return `${day}/${month} ${hours}:${minutes} IST`;\n          },\n        },\n        width: containerWidth,\n        height: containerHeight,\n      });\n\n      const candlestickSeries = chart.addSeries(CandlestickSeries, {\n        upColor: '#16a34a',\n        downColor: '#dc2626',\n        borderUpColor: '#15803d',\n        borderDownColor: '#b91c1c',\n        wickUpColor: '#15803d',\n        wickDownColor: '#b91c1c',\n      });\n\n      const volumeSeries = chart.addSeries(HistogramSeries, {\n        priceFormat: { type: 'volume' },\n        priceScaleId: '',\n        color: 'rgba(22, 163, 74, 0.3)',\n      });\n      volumeSeries.priceScale().applyOptions({\n        scaleMargins: { top: 0.85, bottom: 0 },\n      });\n\n      const ema12Series = chart.addSeries(LineSeries, {\n        color: '#0066ff',\n        lineWidth: 2,\n        priceLineVisible: false,\n        lastValueVisible: true,\n        crosshairMarkerVisible: true,\n        crosshairMarkerRadius: 4,\n      });\n\n      const ema26Series = chart.addSeries(LineSeries, {\n        color: '#ff6600',\n        lineWidth: 2,\n        priceLineVisible: false,\n        lastValueVisible: true,\n        crosshairMarkerVisible: true,\n        crosshairMarkerRadius: 4,\n      });\n\n      journalChartRef.current = chart;\n      journalCandlestickSeriesRef.current = candlestickSeries;\n      journalEma12SeriesRef.current = ema12Series;\n      journalEma26SeriesRef.current = ema26Series;\n      journalVolumeSeriesRef.current = volumeSeries;\n\n      // Subscribe to crosshair move for OHLC display (TradingView style)\n      chart.subscribeCrosshairMove((param) => {\n        if (!param.time || !param.point) {\n          // Reset to latest candle when cursor leaves chart\n          const latestData = journalChartData[journalChartData.length - 1];\n          if (latestData) {\n            const prevCandle = journalChartData[journalChartData.length - 2];\n            const prevClose = prevCandle?.close || latestData.open;\n            const change = latestData.close - prevClose;\n            const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;\n            setHoveredCandleOhlc({\n              open: latestData.open,\n              high: latestData.high,\n              low: latestData.low,\n              close: latestData.close,\n              change,\n              changePercent,\n              time: latestData.time,\n            });\n          }\n          return;\n        }\n\n        // Get candle data at crosshair position\n        const candleData = param.seriesData.get(candlestickSeries);\n        if (candleData && 'open' in candleData) {\n          // Find previous candle for change calculation\n          const sortedData = [...journalChartData].sort((a, b) => a.time - b.time);\n          const currentIndex = sortedData.findIndex((c) => c.time === param.time);\n          const prevCandle = currentIndex > 0 ? sortedData[currentIndex - 1] : null;\n          const prevClose = prevCandle?.close || candleData.open;\n          const change = candleData.close - prevClose;\n          const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;\n\n          setHoveredCandleOhlc({\n            open: candleData.open,\n            high: candleData.high,\n            low: candleData.low,\n            close: candleData.close,\n            change,\n            changePercent,\n            time: param.time as number,\n          });\n        }\n      });\n\n      // Set data immediately\n      const sortedData = [...journalChartData].sort((a: any, b: any) => a.time - b.time);\n\n      const chartData = sortedData.map((candle: any) => ({\n        time: candle.time as any,\n        open: candle.open,\n        high: candle.high,\n        low: candle.low,\n        close: candle.close,\n      }));\n\n      candlestickSeries.setData(chartData);\n\n      // Initialize hovered OHLC with latest candle data\n      if (sortedData.length > 0) {\n        const latestCandle = sortedData[sortedData.length - 1];\n        const prevCandle = sortedData.length > 1 ? sortedData[sortedData.length - 2] : null;\n        const prevClose = prevCandle?.close || latestCandle.open;\n        const change = latestCandle.close - prevClose;\n        const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;\n        setHoveredCandleOhlc({\n          open: latestCandle.open,\n          high: latestCandle.high,\n          low: latestCandle.low,\n          close: latestCandle.close,\n          change,\n          changePercent,\n          time: latestCandle.time,\n        });\n      }\n\n      // Volume data with color based on price movement\n      const volumeData = sortedData.map((candle: any) => ({\n        time: candle.time as any,\n        value: candle.volume || 0,\n        color: candle.close >= candle.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',\n      }));\n      volumeSeries.setData(volumeData);\n\n      const closePrices = sortedData.map((c: any) => c.close);\n      const ema12 = calculateEMA(closePrices, 12);\n      const ema26 = calculateEMA(closePrices, 26);\n\n      const ema12Data = ema12.map((value, index) => ({\n        time: sortedData[index + 11]?.time as any,\n        value: value,\n      })).filter(d => d.time);\n\n      const ema26Data = ema26.map((value, index) => ({\n        time: sortedData[index + 25]?.time as any,\n        value: value,\n      })).filter(d => d.time);\n\n      if (ema12Data.length > 0) {\n        ema12Series.setData(ema12Data);\n        setJournalEmaValues(prev => ({ ...prev, ema12: ema12Data[ema12Data.length - 1]?.value || null }));\n      }\n      if (ema26Data.length > 0) {\n        ema26Series.setData(ema26Data);\n        setJournalEmaValues(prev => ({ ...prev, ema26: ema26Data[ema26Data.length - 1]?.value || null }));\n      }\n\n\n\n      // Fit content but with better zoom to show time scale\n      setTimeout(() => {\n        if (journalChartRef.current) {\n          journalChartRef.current.timeScale().fitContent();\n          // Reset zoom to prevent over-zooming that hides time scale\n          journalChartRef.current.timeScale().applyOptions({ rightOffset: 10 });\n        }\n      }, 100);\n\n      const handleResize = () => {\n        if (journalChartContainerRef.current && journalChartRef.current) {\n          journalChartRef.current.applyOptions({\n            width: journalChartContainerRef.current.clientWidth,\n          });\n        }\n      };\n\n      window.addEventListener('resize', handleResize);\n      } catch (error) {\n        console.error('❌ Error rendering journal chart:', error instanceof Error ? error.message : String(error));\n        if (error instanceof Error) console.error('Stack:', error.stack);\n        // Show error message instead of placeholder\n        if (journalChartContainerRef.current) {\n          journalChartContainerRef.current.innerHTML = `\n            <div style="display: flex; align-items: center; justify-center; height: 100%; font-size: 12px; color: #e74c3c;">\n              Chart render error: ${error instanceof Error ? error.message : 'Unknown error'}\n            </div>\n          `;\n        }\n      }\n    });\n\n    return () => {\n      if (journalChartContainerRef.current && journalChartRef.current) {\n        window.removeEventListener('resize', () => {});\n      }\n    };\n  }, [activeTab, selectedJournalSymbol, journalChartTimeframe, journalChartData]);\n\n  // ========== HEATMAP CHART INITIALIZATION ==========\n  // Separate chart for heatmap date selection - completely independent from search chart\n  useEffect(() => {\n    if (activeTab !== 'journal') {\n      if (heatmapChartRef.current) {\n        try {\n          heatmapChartRef.current.remove();\n        } catch (e) {}\n        heatmapChartRef.current = null;\n        heatmapCandlestickSeriesRef.current = null;\n      }\n      return;\n    }\n\n    if (!heatmapChartContainerRef.current) return;\n    if (!heatmapChartData || heatmapChartData.length === 0) return;\n\n    console.log(`🗓️ [HEATMAP CHART] Rendering with ${heatmapChartData.length} candles for date: ${heatmapSelectedDate}`);\n\n    // Defer chart creation until layout is ready\n    requestAnimationFrame(() => {\n      if (!heatmapChartContainerRef.current) return;\n\n      try {\n        // Clean up existing chart first\n        if (heatmapChartRef.current) {\n          try {\n            heatmapChartRef.current.remove();\n          } catch (e) {}\n          heatmapChartRef.current = null;\n          heatmapCandlestickSeriesRef.current = null;\n        }\n\n        // Clear container\n        heatmapChartContainerRef.current.innerHTML = '';\n\n        const containerWidth = heatmapChartContainerRef.current.clientWidth || 800;\n        const containerHeight = heatmapChartContainerRef.current.clientHeight || 400;\n\n        console.log('🗓️ [HEATMAP CHART] Container dimensions:', { containerWidth, containerHeight });\n\n        const chart = createChart(heatmapChartContainerRef.current, {\n          layout: {\n            background: { type: ColorType.Solid, color: '#ffffff' },\n            textColor: '#1f2937',\n          },\n          grid: {\n            vertLines: { color: '#f3f4f6', style: 1 },\n            horzLines: { color: '#f3f4f6', style: 1 },\n          },\n          crosshair: {\n            mode: 1,\n            vertLine: { color: '#9ca3af', width: 1, style: 2, labelBackgroundColor: '#f3f4f6' },\n            horzLine: { color: '#9ca3af', width: 1, style: 2, labelBackgroundColor: '#f3f4f6' },\n          },\n          rightPriceScale: {\n            visible: true,\n            borderVisible: true,\n            borderColor: '#e5e7eb',\n            scaleMargins: { top: 0.1, bottom: 0.25 },\n            autoScale: true,\n          },\n          timeScale: {\n            visible: true,\n            borderVisible: true,\n            borderColor: '#e5e7eb',\n            timeVisible: true,\n            secondsVisible: false,\n            barSpacing: 12,\n            minBarSpacing: 4,\n            fixLeftEdge: false,\n            fixRightEdge: false,\n            lockVisibleTimeRangeOnResize: false,\n            tickMarkFormatter: (time: number) => {\n              const date = new Date(time * 1000);\n              const istDate = new Date(date.getTime() + (330 * 60 * 1000));\n              const hours = istDate.getUTCHours().toString().padStart(2, '0');\n              const minutes = istDate.getUTCMinutes().toString().padStart(2, '0');\n              return `${hours}:${minutes}`;\n            },\n          },\n          localization: {\n            timeFormatter: (time: number) => {\n              const date = new Date(time * 1000);\n              const istDate = new Date(date.getTime() + (330 * 60 * 1000));\n              const hours = istDate.getUTCHours().toString().padStart(2, '0');\n              const minutes = istDate.getUTCMinutes().toString().padStart(2, '0');\n              const day = istDate.getUTCDate().toString().padStart(2, '0');\n              const month = (istDate.getUTCMonth() + 1).toString().padStart(2, '0');\n              return `${day}/${month} ${hours}:${minutes} IST`;\n            },\n          },\n          width: containerWidth,\n          height: containerHeight,\n        });\n\n        const candlestickSeries = chart.addSeries(CandlestickSeries, {\n          upColor: '#16a34a',\n          downColor: '#dc2626',\n          borderUpColor: '#15803d',\n          borderDownColor: '#b91c1c',\n          wickUpColor: '#15803d',\n          wickDownColor: '#b91c1c',\n        });\n\n        const volumeSeries = chart.addSeries(HistogramSeries, {\n          priceFormat: { type: 'volume' },\n          priceScaleId: '',\n          color: 'rgba(147, 51, 234, 0.3)', // Purple for heatmap chart\n        });\n        volumeSeries.priceScale().applyOptions({\n          scaleMargins: { top: 0.85, bottom: 0 },\n        });\n\n        heatmapChartRef.current = chart;\n        heatmapCandlestickSeriesRef.current = candlestickSeries;\n\n        // Subscribe to crosshair move for OHLC display\n        chart.subscribeCrosshairMove((param) => {\n          if (!param.time || !param.point) {\n            const latestData = heatmapChartData[heatmapChartData.length - 1];\n            if (latestData) {\n              const prevCandle = heatmapChartData[heatmapChartData.length - 2];\n              const prevClose = prevCandle?.close || latestData.open;\n              const change = latestData.close - prevClose;\n              const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;\n              setHeatmapHoveredOhlc({\n                open: latestData.open,\n                high: latestData.high,\n                low: latestData.low,\n                close: latestData.close,\n                change,\n                changePercent,\n                time: latestData.time,\n              });\n            }\n            return;\n          }\n\n          const candleData = param.seriesData.get(candlestickSeries);\n          if (candleData && 'open' in candleData) {\n            const sortedData = [...heatmapChartData].sort((a, b) => a.time - b.time);\n            const currentIndex = sortedData.findIndex((c) => c.time === param.time);\n            const prevCandle = currentIndex > 0 ? sortedData[currentIndex - 1] : null;\n            const prevClose = prevCandle?.close || candleData.open;\n            const change = candleData.close - prevClose;\n            const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;\n\n            setHeatmapHoveredOhlc({\n              open: candleData.open,\n              high: candleData.high,\n              low: candleData.low,\n              close: candleData.close,\n              change,\n              changePercent,\n              time: param.time as number,\n            });\n          }\n        });\n\n        // Set data\n        const sortedData = [...heatmapChartData].sort((a: any, b: any) => a.time - b.time);\n\n        const chartData = sortedData.map((candle: any) => ({\n          time: candle.time as any,\n          open: candle.open,\n          high: candle.high,\n          low: candle.low,\n          close: candle.close,\n        }));\n\n        const volumeData = sortedData.map((candle: any) => ({\n          time: candle.time as any,\n          value: candle.volume || 0,\n          color: candle.close >= candle.open ? 'rgba(147, 51, 234, 0.4)' : 'rgba(220, 38, 38, 0.4)',\n        }));\n\n        candlestickSeries.setData(chartData);\n        volumeSeries.setData(volumeData);\n\n        // ========== ADD BUY/SELL TRADE MARKERS ==========\n        if (heatmapTradeHistory && heatmapTradeHistory.length > 0) {\n          const markers: any[] = [];\n\n          // Extract the underlying symbol from the current chart\n          let currentChartUnderlying = heatmapSelectedSymbol\n            .replace(/^(NSE|BSE):/, '')\n            .replace(/-INDEX$/, '')\n            .replace(/-EQ$/, '');\n\n          console.log(`🔍 [HEATMAP MARKERS] Processing ${heatmapTradeHistory.length} trades, filtering for symbol: ${currentChartUnderlying}...`);\n\n          heatmapTradeHistory.forEach((trade) => {\n            // FILTER BY SYMBOL: Extract underlying from trade symbol and compare\n            const tradeSymbol = trade.symbol || '';\n            const tradeParts = tradeSymbol.split(' ');\n            let tradeUnderlying = tradeParts[0]; // e.g., "NIFTY", "SENSEX", "BANKNIFTY"\n\n            // Normalize trade underlying to match chart symbol\n            if (tradeUnderlying === 'NIFTY') {\n              tradeUnderlying = 'NIFTY50';\n            }\n\n            // Only process trades for the current chart's underlying symbol\n            if (tradeUnderlying !== currentChartUnderlying) {\n              console.log(`⏭️ [HEATMAP MARKERS] Skipping trade for ${tradeUnderlying} (current chart: ${currentChartUnderlying})`);\n              return;\n            }\n\n            // Parse trade time (format: "HH:MM:SS AM/PM")\n            const timeStr = trade.time || '';\n            if (!timeStr) {\n              console.warn(`⚠️ [HEATMAP MARKERS] Trade has no time: ${JSON.stringify(trade)}`);\n              return;\n            }\n\n            console.log(`📝 [HEATMAP MARKERS] Processing trade: ${JSON.stringify(trade)}`);  \n\n            try {\n              // Extract hours, minutes, seconds from time string\n              // Supports both "HH:MM:SS AM/PM" and "HH:MM:SS" (24-hour) formats\n              const match = timeStr.match(/(\d+):(\d+)(?::(\d+))?\s*(AM|PM)?/i);\n              if (!match) {\n                console.warn(`⚠️ [HEATMAP MARKERS] Could not parse time: "${timeStr}"`);\n                return;\n              }\n\n              let hours = parseInt(match[1]);\n              const minutes = parseInt(match[2]);\n              const seconds = match[3] ? parseInt(match[3]) : 0; // Default to 0 if not provided\n              const period = match[4] ? match[4].toUpperCase() : null; // AM/PM is optional\n\n              // Convert to 24-hour format only if AM/PM is provided\n              if (period === 'PM' && hours !== 12) hours += 12;\n              if (period === 'AM' && hours === 12) hours = 0;\n\n              console.log(`⏱️  [HEATMAP MARKERS] Trade "${trade.order}" at ${timeStr} -> ${hours}:${minutes} IST`);\n\n              // Find matching candle by time of day (IST)\n              const matchingCandle = sortedData.find((candle) => {\n                const candleDate = new Date(candle.time * 1000);\n                const istCandleDate = new Date(candleDate.getTime() + (330 * 60 * 1000));\n                const candleHours = istCandleDate.getUTCHours();\n                const candleMinutes = istCandleDate.getUTCMinutes();\n\n                // Match within the same minute\n                return candleHours === hours && candleMinutes === minutes;\n              });\n\n              if (matchingCandle) {\n                const isGreen = trade.order === 'BUY';\n\n                markers.push({\n                  time: matchingCandle.time as any,\n                  position: isGreen ? 'belowBar' : 'aboveBar',\n                  color: isGreen ? '#16a34a' : '#dc2626',\n                  shape: isGreen ? 'arrowUp' : 'arrowDown',\n                  text: `${trade.order}`,\n                });\n\n                console.log(`✅ [HEATMAP MARKERS] Matched "${trade.order}" at ${timeStr} to candle time ${matchingCandle.time}`);\n              } else {\n                console.warn(`❌ [HEATMAP MARKERS] No matching candle found for time ${timeStr} (${hours}:${minutes})`);\n              }\n            } catch (e) {\n              console.error(`❌ [HEATMAP MARKERS] Parse error for "${timeStr}":`, e);\n            }\n          });\n\n          if (markers.length > 0) {\n            // Use createSeriesMarkers wrapper for proper API support\n            heatmapSeriesMarkersRef.current = createSeriesMarkers(candlestickSeries);\n            heatmapSeriesMarkersRef.current.setMarkers(markers);\n\n            const buyCount = heatmapTradeHistory.filter(t => t.order === 'BUY').length;\n            const sellCount = heatmapTradeHistory.filter(t => t.order === 'SELL').length;\n            console.log(`📍 [HEATMAP] Successfully added ${markers.length} trade markers (${buyCount} BUY, ${sellCount} SELL)`);\n          } else {\n            console.warn(`⚠️ [HEATMAP] No markers created despite ${heatmapTradeHistory.length} trades`);\n          }\n        }\n\n        // Fit content\n        setTimeout(() => {\n          if (heatmapChartRef.current) {\n            heatmapChartRef.current.timeScale().fitContent();\n            heatmapChartRef.current.timeScale().applyOptions({ rightOffset: 10 });\n          }\n        }, 100);\n\n        const handleResize = () => {\n          if (heatmapChartContainerRef.current && heatmapChartRef.current) {\n            heatmapChartRef.current.applyOptions({\n              width: heatmapChartContainerRef.current.clientWidth,\n            });\n          }\n        };\n\n        window.addEventListener('resize', handleResize);\n\n        console.log('🗓️ [HEATMAP CHART] Successfully rendered');\n      } catch (error) {\n        console.error('🗓️ [HEATMAP CHART] Error rendering:', error instanceof Error ? error.message : String(error));\n      }\n    });\n\n    return () => {\n      if (heatmapChartContainerRef.current && heatmapChartRef.current) {\n        window.removeEventListener('resize', () => {});\n      }\n    };\n  }, [activeTab, heatmapChartData, heatmapTradeHistory, heatmapSelectedDate]);\n\n  // Extract underlying symbol from option/futures trade symbol\n  const getTradeUnderlyingSymbol = (tradeSymbol: string): string => {\n    // For options/futures like "NIFTY 22nd w MAR PE", "BANKNIFTY 15 AUG CE", "SENSEX FEB PE", extract the underlying\n    const indexSymbols = ['NIFTY50', 'NIFTY', 'BANKNIFTY', 'SENSEX', 'FINNIFTY', 'MIDCPNIFTY', 'NIFTYIT'];\n    const cleanSymbol = tradeSymbol.toUpperCase().trim();\n\n    // Try to match longest symbols first to avoid partial matches\n    const sorted = [...indexSymbols].sort((a, b) => b.length - a.length);\n\n    for (const idx of sorted) {\n      if (cleanSymbol.includes(idx)) {\n        const result = idx === 'NIFTY' ? 'NIFTY50' : idx; // Map NIFTY to NIFTY50\n        return result;\n      }\n    }\n    return cleanSymbol; // Return clean symbol if no index match\n  };\n\n  // Check if trade symbol matches chart symbol (including option/futures on underlying)\n  const doesTradeMatchChart = (tradeSymbol: string, chartSymbol: string): boolean => {\n    const tradeUnderlying = getTradeUnderlyingSymbol(tradeSymbol);\n    const chartUnderlying = getTradeUnderlyingSymbol(chartSymbol);\n    const matches = tradeUnderlying === chartUnderlying;\n\n    console.log(`🔍 Symbol Match Check: Trade="${tradeSymbol}" (underlying="${tradeUnderlying}") vs Chart="${chartSymbol}" (underlying="${chartUnderlying}") = ${matches}`);\n    return matches;\n  };\n\n  // Convert trade history to chart markers (TIME-BASED ONLY - ignores symbol matching)\n  const getTradeMarkersForChart = useCallback(() => {\n    if (\n      !tradeHistoryData ||\n      tradeHistoryData.length === 0 ||\n      !journalChartData ||\n      journalChartData.length === 0\n    ) {\n      console.log('🔴 MARKER ABORT: No trade or chart data', { trades: tradeHistoryData?.length || 0, candles: journalChartData?.length || 0 });\n      return [];\n    }\n\n    console.log('🟢 MARKER START: Processing', tradeHistoryData.length, 'trades against', journalChartData.length, 'candles');\n    const markers: TradeMarker[] = [];\n\n    // Use heatmap selected date for chart markers (independent from search chart)\n\n    tradeHistoryData.forEach((trade, index) => {\n      try {\n        // 🔶 TIME-BASED MATCHING ONLY - ignore symbol, use only trade time\n        // Parse trade time (e.g., "1:16:33 PM" or "11:23:56 AM")\n        const tradeTime = trade.time;\n        if (!tradeTime) {\n          console.log(`❌ Trade #${index + 1}: No time found`);\n          return;\n        }\n\n        // Convert 12-hour format to 24-hour format\n        const [time, period] = tradeTime.split(" ");\n        const [hours, minutes, seconds] = time.split(":").map(Number);\n        let hour24 = hours;\n\n        if (period?.toUpperCase() === "PM" && hours !== 12) {\n          hour24 = hours + 12;\n        } else if (period?.toUpperCase() === "AM" && hours === 12) {\n          hour24 = 0;\n        }\n\n        // Create target time in minutes from midnight for comparison\n        const tradeMinutesFromMidnight = hour24 * 60 + minutes;\n\n        console.log(`🕐 Trade #${index + 1}: ${tradeTime} → 24h: ${hour24}:${String(minutes).padStart(2, '0')} (${tradeMinutesFromMidnight}min) [${trade.order}]`);\n\n        // Find closest candle in chart data by matching time\n        let closestCandleIndex = -1;\n        let minTimeDiff = Infinity;\n\n        journalChartData.forEach((candle, candleIndex) => {\n          // Candle timestamp is UTC (Unix seconds), convert to IST for matching\n          // IST = UTC + 5:30 hours = UTC + 330 minutes\n          const candleDate = new Date(candle.time * 1000);\n          const utcMinutes = candleDate.getUTCHours() * 60 + candleDate.getUTCMinutes();\n          const istMinutes = (utcMinutes + 330) % 1440; // Add IST offset, wrap at midnight\n\n          const timeDiff = Math.abs(istMinutes - tradeMinutesFromMidnight);\n\n          if (timeDiff < minTimeDiff) {\n            minTimeDiff = timeDiff;\n            closestCandleIndex = candleIndex;\n          }\n        });\n\n        // Use timeframe interval to determine matching tolerance\n        // For 1-min candles, use 1-min tolerance; for 5-min candles, use 3-min tolerance, etc.\n        const timeframeMinutes = parseInt(journalChartTimeframe) || 1;\n        const timeframeTolerance = Math.max(Math.ceil(timeframeMinutes / 2), 1);\n\n        if (closestCandleIndex !== -1 && minTimeDiff <= timeframeTolerance) {\n          const candle = journalChartData[closestCandleIndex];\n          // Use candle high/low for marker position (BUY below bar, SELL above bar)\n          const price = trade.order === "BUY" ? candle.low : candle.high;\n\n          markers.push({\n            candleIndex: closestCandleIndex,\n            price: trade.price || price,\n            type: trade.order.toLowerCase() as "buy" | "sell",\n            symbol: trade.symbol,\n            quantity: trade.qty,\n            time: trade.time,\n            pnl: trade.pnl,\n          });\n          console.log(`✅ Marker added: ${trade.order} @ ${trade.time} → Candle #${closestCandleIndex} (diff: ${minTimeDiff}min)`);\n        } else {\n          console.log(`⚠️ No matching candle for trade @ ${trade.time} (closest diff: ${minTimeDiff}min, tolerance: ${timeframeTolerance}min)`);\n        }\n      } catch (error) {\n        console.error("Error parsing trade for markers:", trade, error);\n      }\n    });\n\n    console.log(\n      "📊 Generated trade markers:",\n      markers.length,\n      "markers from",\n      tradeHistoryData.length,\n      "trades (TIME-BASED matching)",\n    );\n    return markers;\n  }, [tradeHistoryData, journalChartData, journalChartTimeframe]);\n\n  // Check if symbol is an INDEX (NIFTY50, BANKNIFTY, etc) - marks only for indices\n  const isIndexChart = () => {\n    const indexSymbols = ['NIFTY50', 'BANKNIFTY', 'SENSEX', 'FINNIFTY', 'MIDCPNIFTY', 'NIFTYIT'];\n    const cleanSymbol = getJournalAngelOneSymbol(selectedJournalSymbol);\n    return indexSymbols.some(idx => cleanSymbol.toUpperCase().includes(idx));\n  };\n\n  // Apply trade marks to chart (TIME-BASED - matches trade history times to candles)\n  useEffect(() => {\n    if (activeTab !== 'journal' || !journalCandlestickSeriesRef.current || !journalChartRef.current) {\n      return;\n    }\n\n    // If markers are hidden, skip\n    if (!showTradeMarkers) {\n      return;\n    }\n\n    // Only display marks if there's chart data AND trade data for current date\n    if (!journalChartData || journalChartData.length === 0 || !tradeHistoryData || tradeHistoryData.length === 0) {\n      return;\n    }\n\n    const markers = getTradeMarkersForChart();\n    console.log('📊 MARKER DEBUG (TIME-BASED) - Trades:', tradeHistoryData.length, 'Chart candles:', journalChartData.length);\n    console.log('  - Generated markers:', markers.length, 'Visible:', showTradeMarkers);\n\n    markers.forEach((m, idx) => {\n      console.log(`  📍 [${idx}] Candle#${m.candleIndex} TIME: ${m.time} - ${m.type.toUpperCase()} @ ₹${m.price}`);\n    });\n\n    try {\n      if (markers.length > 0) {\n        // Use built-in setMarkers with TradingView-style arrows\n        const chartMarkers = markers.map((marker, idx) => {\n          const candle = journalChartData[marker.candleIndex];\n          const markTime = candle?.time;\n\n          const mObj: any = {\n            time: markTime,\n            position: marker.type === 'buy' ? 'belowBar' : 'aboveBar',\n            color: marker.type === 'buy' ? '#22c55e' : '#ef4444', // Bright green/red\n            shape: marker.type === 'buy' ? 'arrowUp' : 'arrowDown',\n            text: `${marker.type === 'buy' ? 'BUY' : 'SELL'} ${marker.time}`,\n          };\n\n          console.log(`  🔄 [${idx}] time:${markTime} ${mObj.shape} pos:${mObj.position} text:${mObj.text}`);\n          return mObj;\n        }).filter((m, idx) => {\n          const hasTime = m.time !== undefined;\n          if (!hasTime) console.log(`  ❌ Filtered marker ${idx} - undefined time`);\n          return hasTime;\n        });\n\n        // Sort markers by time (required by lightweight-charts)\n        chartMarkers.sort((a: any, b: any) => a.time - b.time);\n\n        console.log(`  🎯 Final markers to apply: ${chartMarkers.length}`);\n\n        // ✅ Markers disabled - LightweightCharts doesn't support setMarkers on series\n        (journalCandlestickSeriesRef.current as any).setMarkers(chartMarkers);\n        console.log(`📊 ✅ Markers applied to series: ${chartMarkers.length}`);\n      } else {\n        console.log('📊 No markers to apply - clearing');\n if (journalCandlestickSeriesRef.current) (journalCandlestickSeriesRef.current as any).setMarkers([]);\n      }\n    } catch (e) {\n      console.error('📊 ❌ Marker Error:', e);\n    }\n  }, [activeTab, journalChartData, tradeHistoryData, getTradeMarkersForChart, showTradeMarkers, selectedJournalSymbol]);\n\n  // Notes state for journal tab\n  const [notesContent, setNotesContent] = useState(() => {\n    if (typeof window !== "undefined") {\n      return localStorage.getItem("tradingNotes") || "";\n    }\n    return "";\n  });\n  const [isEditingNotes, setIsEditingNotes] = useState(false);\n  const [tempNotesContent, setTempNotesContent] = useState(notesContent);\n\n  // Get all valid trading tags from tradingTagSystem\n  const getAllValidTags = () => {\n    const allTags: string[] = [];\n    // Note: tradingTagSystem is defined below, so we need to reference it carefully\n    // For now, we'll create a helper after tradingTagSystem is defined\n    return allTags;\n  };\n\n  // Trading tags state\n  const [selectedTags, setSelectedTags] = useState<string[]>(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("tradingTags");\n      return stored ? JSON.parse(stored) : [];\n    }\n    return [];\n  });\n  const [isTagDropdownOpen, setIsTagDropdownOpen] = useState(false);\n\n  // Daily life factors state - affects trading performance\n  const [selectedDailyFactors, setSelectedDailyFactors] = useState<string[]>(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("tradingDailyFactors");\n      return stored ? JSON.parse(stored) : [];\n    }\n    return [];\n  });\n  const [isDailyFactorsDropdownOpen, setIsDailyFactorsDropdownOpen] = useState(false);\n\n  // Daily life factors system - personal factors affecting market performance\n  const dailyFactorsSystem = {\n    financial: {\n      name: "Financial",\n      color: "amber",\n      maxSelections: 3,\n      tags: [\n        "debt",\n        "money shortage",\n        "total risk high",\n        "borrowed money",\n        "unexpected expense",\n        "loan pressure",\n      ],\n    },\n    physical: {\n      name: "Physical & Sleep",\n      color: "orange",\n      maxSelections: 3,\n      tags: [\n        "poor sleep",\n        "exhausted",\n        "hungry",\n        "sick",\n        "hangover",\n        "jet lag",\n      ],\n    },\n    stress: {\n      name: "Work & Stress",\n      color: "red",\n      maxSelections: 3,\n      tags: [\n        "work stress",\n        "family tension",\n        "relationship issues",\n        "health anxiety",\n        "deadline pressure",\n        "personal crisis",\n      ],\n    },\n    distraction: {\n      name: "Distraction & Calls",\n      color: "yellow",\n      maxSelections: 3,\n      tags: [\n        "telegram calls",\n        "youtube calls",\n        "social media",\n        "whatsapp messages",\n        "family calls",\n        "others suggestions",\n      ],\n    },\n  };\n\n  const toggleDailyFactor = (factor: string) => {\n    setSelectedDailyFactors((prev) => {\n      const updated = prev.includes(factor)\n        ? prev.filter((f) => f !== factor)\n        : [...prev, factor];\n      if (typeof window !== "undefined") {\n        localStorage.setItem("tradingDailyFactors", JSON.stringify(updated));\n      }\n      return updated;\n    });\n  };\n\n  const clearAllDailyFactors = () => {\n    setSelectedDailyFactors([]);\n    if (typeof window !== "undefined") {\n      localStorage.setItem("tradingDailyFactors", JSON.stringify([]));\n    }\n  };\n\n  // Indicators state for tracking mistakes with indicators and timeframes\n  const [selectedIndicators, setSelectedIndicators] = useState<string[]>(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("tradingIndicators");\n      return stored ? JSON.parse(stored) : [];\n    }\n    return [];\n  });\n  const [indicatorTimeframe, setIndicatorTimeframe] = useState<string>(() => {\n    if (typeof window !== "undefined") {\n      return localStorage.getItem("indicatorTimeframe") || "5min";\n    }\n    return "5min";\n  });\n  const [isIndicatorDropdownOpen, setIsIndicatorDropdownOpen] = useState(false);\n  const [isCustomTimeframeDialogOpen, setIsCustomTimeframeDialogOpen] = useState(false);\n  const [customTimeframeInput, setCustomTimeframeInput] = useState("");\n\n  // Indicator list system\n  const indicatorList = [\n    "Moving Average",\n    "EMA",\n    "MACD",\n    "RSI",\n    "Stochastic",\n    "Bollinger Bands",\n    "ATR",\n    "Volume",\n    "ADX",\n    "Ichimoku",\n    "Fibonacci",\n    "Pivot Points",\n    "Price Action",\n  ];\n\n  const timeframeOptions = [\n    { value: "1min", label: "1 Min" },\n    { value: "5min", label: "5 Min" },\n    { value: "15min", label: "15 Min" },\n    { value: "30min", label: "30 Min" },\n    { value: "1h", label: "1 Hour" },\n    { value: "daily", label: "Daily" },\n    { value: "weekly", label: "Weekly" },\n  ];\n\n  const toggleIndicator = (indicator: string) => {\n    setSelectedIndicators((prev) => {\n      const updated = prev.includes(indicator)\n        ? prev.filter((i) => i !== indicator)\n        : [...prev, indicator];\n      if (typeof window !== "undefined") {\n        localStorage.setItem("tradingIndicators", JSON.stringify(updated));\n      }\n      return updated;\n    });\n  };\n\n  const clearAllIndicators = () => {\n    setSelectedIndicators([]);\n    if (typeof window !== "undefined") {\n      localStorage.setItem("tradingIndicators", JSON.stringify([]));\n    }\n  };\n\n  // Trade book window states\n  const [showTradingNotesWindow, setShowTradingNotesWindow] = useState(false);\n  const [showPerformanceWindow, setShowPerformanceWindow] = useState(false);\n  const [showMultipleImageUpload, setShowMultipleImageUpload] = useState(false);\n\n  // Enhanced trading tag system with categories and rules\n  const tradingTagSystem = {\n    psychology: {\n      name: "Psychology",\n      color: "red",\n      maxSelections: 2,\n      tags: [\n        "fomo",\n        "greedy",\n        "overtrading",\n        "hero zero",\n        "fear",\n        "euphoric",\n        "revenge trading",\n        "disciplined",\n        "patient",\n        "confident",\n        "anxious",\n        "impulsive",\n      ],\n    },\n    strategy: {\n      name: "Strategy",\n      color: "blue",\n      maxSelections: 2,\n      tags: [\n        "planned",\n        "unplanned",\n        "scalping",\n        "swing trading",\n        "intraday",\n        "position",\n        "btst",\n        "breakout",\n        "trend following",\n        "counter trend",\n        "momentum",\n        "mean reversion",\n      ],\n    },\n    market: {\n      name: "Market Conditions",\n      color: "green",\n      maxSelections: 2,\n      tags: [\n        "trending",\n        "sideways",\n        "volatile",\n        "low volume",\n        "high volume",\n        "news driven",\n        "technical setup",\n        "gap up",\n        "gap down",\n        "pre market",\n        "post market",\n        "expiry day",\n      ],\n    },\n    timeframe: {\n      name: "Timeframe",\n      color: "purple",\n      maxSelections: 1,\n      tags: ["short terms", "intraday", "swing", "investment", "long term"],\n    },\n    setup: {\n      name: "Trade Setup",\n      color: "orange",\n      maxSelections: 2,\n      tags: [\n        "no setup",\n        "blind trades",\n        "technical analysis",\n        "fundamental analysis",\n        "news based",\n        "price action",\n        "indicator based",\n        "pattern based",\n      ],\n    },\n  };\n\n  // Tag validation rules\n  const tagValidationRules = {\n    conflictingTags: [\n      ["planned", "unplanned", "no setup"],\n      ["fomo", "disciplined", "patient"],\n      ["patient", "impulsive"],\n      ["trending", "sideways"],\n      ["gap up", "gap down"],\n      ["disciplined", "blind trades"],\n      ["technical analysis", "blind trades", "no setup"],\n    ],\n    maxTotalTags: 8,\n    minRequiredTags: 0,\n  };\n\n  // Get all tags as flat array for compatibility\n  const getAllTags = () => {\n    return Object.values(tradingTagSystem).flatMap((category) => category.tags);\n  };\n\n  // Filter tags to only include valid trading tags (remove indicators that might be mixed in)\n  const getValidTags = (tags: string[]) => {\n    const validTagsList = getAllTags();\n    return tags.filter((tag) => validTagsList.includes(tag));\n  };\n\n  // Tag validation functions\n  const validateTagSelection = (newTags: string[]) => {\n    const errors: string[] = [];\n\n    // Check total tag limit\n    if (newTags.length > tagValidationRules.maxTotalTags) {\n      errors.push(`Maximum ${tagValidationRules.maxTotalTags} tags allowed`);\n    }\n\n    // Check minimum required tags\n    if (newTags.length < tagValidationRules.minRequiredTags) {\n      errors.push(\n        `Minimum ${tagValidationRules.minRequiredTags} tags required`,\n      );\n    }\n\n    // Check category limits\n    Object.entries(tradingTagSystem).forEach(([categoryKey, category]) => {\n      const categoryTags = newTags.filter((tag) => category.tags.includes(tag));\n      if (categoryTags.length > category.maxSelections) {\n        errors.push(\n          `Maximum ${\n            category.maxSelections\n          } ${category.name.toLowerCase()} tags allowed`,\n        );\n      }\n    });\n\n    // Check required categories\n    Object.entries(tradingTagSystem).forEach(([categoryKey, category]) => {\n      if ((category as any).required) {\n        const categoryTags = newTags.filter((tag) =>\n          category.tags.includes(tag),\n        );\n        if (categoryTags.length === 0) {\n          errors.push(\n            `At least one ${category.name.toLowerCase()} tag is required`,\n          );\n        }\n      }\n    });\n\n    // Check conflicting tags\n    tagValidationRules.conflictingTags.forEach((conflictGroup) => {\n      const selectedConflicts = newTags.filter((tag) =>\n        conflictGroup.includes(tag),\n      );\n      if (selectedConflicts.length > 1) {\n        errors.push(`Conflicting tags: ${selectedConflicts.join(", ")}`);\n      }\n    });\n\n    return errors;\n  };\n\n  // Enhanced toggle tag function with validation\n  const toggleTagWithValidation = (tag: string) => {\n    const validCurrentTags = getValidTags(selectedTags);\n    const newTags = validCurrentTags.includes(tag)\n      ? validCurrentTags.filter((t) => t !== tag)\n      : [...validCurrentTags, tag];\n\n    // Only check basic limits when adding tags\n    if (!validCurrentTags.includes(tag)) {\n      // Check total limit\n      if (newTags.length > tagValidationRules.maxTotalTags) {\n        alert(`Maximum ${tagValidationRules.maxTotalTags} tags allowed`);\n        return;\n      }\n\n      // Check category limits\n      const tagCategory = getTagCategory(tag);\n      if (tagCategory) {\n        const categoryTags = newTags.filter((t) =>\n          tagCategory.tags.includes(t),\n        );\n        if (categoryTags.length > tagCategory.maxSelections) {\n          alert(\n            `Maximum ${\n              tagCategory.maxSelections\n            } ${tagCategory.name.toLowerCase()} tags allowed`,\n          );\n          return;\n        }\n      }\n    }\n\n    const validTags = getValidTags(newTags);\n    setSelectedTags(validTags);\n    localStorage.setItem("tradingTags", JSON.stringify(validTags));\n  };\n\n  // Get category for a tag\n  const getTagCategory = (tag: string) => {\n    for (const [categoryKey, category] of Object.entries(tradingTagSystem)) {\n      if (category.tags.includes(tag)) {\n        return { key: categoryKey, ...category };\n      }\n    }\n    return null;\n  };\n\n  // Calendar state for PROFIT CONSISTENCY\n  const [currentCalendarDate, setCurrentCalendarDate] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState(null as Date | null);\n  const [calendarData, setCalendarData] = useState(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("calendarData");\n      return stored ? JSON.parse(stored) : {};\n    }\n    return {};\n  });\n\n  // Tag highlighting state for curved line visualization\n  const [activeTagHighlight, setActiveTagHighlight] = useState<{\n    tag: string;\n    dates: string[];\n  } | null>(null);\n\n  // Stats customization state for purple panel\n  const [visibleStats, setVisibleStats] = useState({\n    pnl: true,\n    trend: true,\n    fomo: true,\n    winRate: true,\n    streak: true,\n    overtrading: false,\n    topTags: false,\n    aiAnalysis: false,\n    planned: false,\n  });\n\n  // Load Magic Bar preferences from localStorage on mount\n  useEffect(() => {\n    const saved = localStorage.getItem("magicBarPrefs");\n    if (saved) {\n      try {\n        const prefs = JSON.parse(saved);\n        setVisibleStats(prefs);\n      } catch (e) {\n        console.log("Could not load Magic Bar preferences");\n      }\n    }\n  }, []);\n\n  // Refs for curved line connections from tag block to heatmap dates\n  const fomoButtonRef = useRef<HTMLButtonElement>(null);\n  const overtradingButtonRef = useRef<HTMLButtonElement>(null);\n  const plannedButtonRef = useRef<HTMLButtonElement>(null);\n  const heatmapContainerRef = useRef<HTMLDivElement>(null);\n\n  // Refs for share dialog curved line connections\n  const shareDialogFomoButtonRef = useRef<HTMLButtonElement>(null);\n  const shareDialogHeatmapContainerRef = useRef<HTMLDivElement>(null);\n\n  // State to trigger re-render of curved lines during scroll\n  const [scrollTrigger, setScrollTrigger] = useState(0);\n  const [shareDialogScrollTrigger, setShareDialogScrollTrigger] = useState(0);\n\n  // Effect to handle scroll updates for curved lines - ULTRA FAST VERSION\n  useEffect(() => {\n    if (!activeTagHighlight || (activeTagHighlight.tag !== 'fomo' && activeTagHighlight.tag !== 'overtrading' && activeTagHighlight.tag !== 'planned')) return;\n\n    const heatmapWrapper = heatmapContainerRef.current;\n    if (!heatmapWrapper) return;\n\n    // Find the actual scrollable element inside the heatmap component immediately\n    const scrollableElement = heatmapWrapper.querySelector('.overflow-x-auto');\n    if (!scrollableElement) {\n      // Retry after a tiny delay if not found\n      const retryTimeout = setTimeout(() => {\n        const element = heatmapWrapper.querySelector('.overflow-x-auto');\n        if (element) {\n          attachScrollListener(element);\n        }\n      }, 10);\n\n      return () => clearTimeout(retryTimeout);\n    }\n\n    let rafId: number | null = null;\n\n    const handleScroll = () => {\n      // Immediate update for instant response\n      setScrollTrigger(prev => prev + 1);\n\n      // Cancel any pending RAF\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n\n      // Also schedule RAF for next frame to ensure smooth rendering\n      rafId = requestAnimationFrame(() => {\n        setScrollTrigger(prev => prev + 1);\n        rafId = null;\n      });\n    };\n\n    const attachScrollListener = (element: Element) => {\n      // Listen to scroll events with passive for best performance\n      element.addEventListener('scroll', handleScroll, { passive: true });\n\n      // Also listen for resize events\n      window.addEventListener('resize', handleScroll, { passive: true });\n\n      console.log('⚡ Attached ULTRA-FAST scroll listener to heatmap');\n    };\n\n    // Attach immediately\n    attachScrollListener(scrollableElement);\n\n    // Cleanup\n    return () => {\n      scrollableElement.removeEventListener('scroll', handleScroll);\n      window.removeEventListener('resize', handleScroll);\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n    };\n  }, [activeTagHighlight]);\n\n  // ✅ SEPARATE STATE FOR SHARE DIALOG: Prevents interference with main tradebook (moved before useEffect)\n  const [shareDialogTagHighlight, setShareDialogTagHighlight] = useState<{\n    tag: string;\n    dates: string[];\n  } | null>(null);\n\n  // Effect to handle scroll updates for share dialog curved lines\n  useEffect(() => {\n    if (!shareDialogTagHighlight || shareDialogTagHighlight.tag !== 'fomo') return;\n\n    const heatmapWrapper = shareDialogHeatmapContainerRef.current;\n    if (!heatmapWrapper) return;\n\n    // Find the scrollable element (parent with overflow-auto class)\n    const scrollableElement = heatmapWrapper;\n    if (!scrollableElement) return;\n\n    let rafId: number | null = null;\n\n    const handleScroll = () => {\n      // Immediate update for instant response\n      setShareDialogScrollTrigger(prev => prev + 1);\n\n      // Cancel any pending RAF\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n\n      // Also schedule RAF for next frame\n      rafId = requestAnimationFrame(() => {\n        setShareDialogScrollTrigger(prev => prev + 1);\n        rafId = null;\n      });\n    };\n\n    // Attach scroll listener\n    scrollableElement.addEventListener('scroll', handleScroll, { passive: true });\n    window.addEventListener('resize', handleScroll, { passive: true });\n\n    console.log('⚡ Attached scroll listener to share dialog heatmap');\n\n    // Cleanup\n    return () => {\n      scrollableElement.removeEventListener('scroll', handleScroll);\n      window.removeEventListener('resize', handleScroll);\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n    };\n  }, [shareDialogTagHighlight]);\n\n  // ✅ SEPARATE STATE FOR REPORT DIALOG: Prevents interference with main tradebook\n  const [reportDialogTagHighlight, setReportDialogTagHighlight] = useState<{\n    tag: string;\n    dates: string[];\n  } | null>(null);\n\n  // Refs for report dialog curved line connections\n  const reportDialogFomoButtonRef = useRef<HTMLButtonElement>(null);\n  const reportDialogHeatmapContainerRef = useRef<HTMLDivElement>(null);\n\n  // State to trigger re-render of curved lines during scroll for report dialog\n  const [reportDialogScrollTrigger, setReportDialogScrollTrigger] = useState(0);\n\n  // Effect to handle scroll updates for report dialog curved lines\n  useEffect(() => {\n    if (!reportDialogTagHighlight || reportDialogTagHighlight.tag !== 'fomo') return;\n\n    const heatmapWrapper = reportDialogHeatmapContainerRef.current;\n    if (!heatmapWrapper) return;\n\n    // Find the actual scrollable element inside the heatmap component\n    const scrollableElement = heatmapWrapper.querySelector('.overflow-x-auto');\n    if (!scrollableElement) {\n      // Retry after a tiny delay if not found\n      const retryTimeout = setTimeout(() => {\n        const element = heatmapWrapper.querySelector('.overflow-x-auto');\n        if (element) {\n          attachScrollListener(element);\n        }\n      }, 10);\n\n      return () => clearTimeout(retryTimeout);\n    }\n\n    let rafId: number | null = null;\n\n    const handleScroll = () => {\n      // Immediate update for instant response\n      setReportDialogScrollTrigger(prev => prev + 1);\n\n      // Cancel any pending RAF\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n\n      // Also schedule RAF for next frame\n      rafId = requestAnimationFrame(() => {\n        setReportDialogScrollTrigger(prev => prev + 1);\n        rafId = null;\n      });\n    };\n\n    const attachScrollListener = (element: Element) => {\n      // Listen to scroll events with passive for best performance\n      element.addEventListener('scroll', handleScroll, { passive: true });\n\n      // Also listen for resize events\n      window.addEventListener('resize', handleScroll, { passive: true });\n\n      console.log('⚡ Attached scroll listener to report dialog heatmap');\n    };\n\n    // Attach immediately\n    attachScrollListener(scrollableElement);\n\n    // Cleanup\n    return () => {\n      scrollableElement.removeEventListener('scroll', handleScroll);\n      window.removeEventListener('resize', handleScroll);\n      if (rafId !== null) {\n        cancelAnimationFrame(rafId);\n      }\n    };\n  }, [reportDialogTagHighlight]);\n\n  // Date range selection state\n  const [fromDate, setFromDate] = useState<Date | null>(null);\n  const [toDate, setToDate] = useState<Date | null>(null);\n  const [heatmapYear, setHeatmapYear] = useState(new Date().getFullYear());\n  const [isCalendarDataFetched, setIsCalendarDataFetched] = useState(false);\n\n  // ✅ NEW: Heatmap data and date range state for Performance Trend filtering\n  const [heatmapDataFromComponent, setHeatmapDataFromComponent] = useState<Record<string, any>>({});\n  const [selectedDateRange, setSelectedDateRange] = useState<{ from: Date; to: Date } | null>(null);\n\n  // Track if user has manually toggled the switch (to prevent auto-switching after manual toggle)\n  const [hasManuallyToggledMode, setHasManuallyToggledMode] = useState(() => {\n    if (typeof window !== "undefined") {\n      const stored = localStorage.getItem("hasManuallyToggledMode");\n      return stored === "true";\n    }\n    return false;\n  });\n\n  // ✅ NEW: Callbacks to receive heatmap data and date range\n  // ✅ FIXED: Now updates the correct state (demo OR personal) based on isDemoMode\n  const handleHeatmapDataUpdate = (data: Record<string, any>) => {\n    console.log(`📊 Received heatmap data update: ${Object.keys(data).length} dates [Mode: ${isDemoMode ? 'DEMO' : 'PERSONAL'}]`);\n\n    // ✅ CRITICAL FIX: Update the correct state based on current mode\n    // This prevents demo and personal data from merging\n    if (isDemoMode) {\n      console.log("📊 Updating DEMO heatmap state");\n      setDemoTradingDataByDate(data);\n    } else {\n      console.log("👤 Updating PERSONAL heatmap state");\n      setPersonalTradingDataByDate(data);\n    }\n\n    // Also update the legacy shared state for backward compatibility\n    setHeatmapDataFromComponent(data);\n\n    // ✅ AUTO-SWITCH TO DEMO MODE: Only for new users on initial load (not after manual toggle)\n    if (!isDemoMode && getUserId() && !hasManuallyToggledMode) {\n      const hasAnyTradeData = Object.values(data).some((dayData: any) => {\n        // Check both wrapped (AWS) and unwrapped formats\n        const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n        const tradeHistory = dayData?.tradingData?.tradeHistory || dayData?.tradeHistory;\n\n        // Has data if:\n        // 1. Has performance metrics with non-zero P&L, OR\n        // 2. Has non-empty trade history\n        return (\n          (metrics && metrics.netPnL !== undefined && metrics.netPnL !== 0) ||\n          (Array.isArray(tradeHistory) && tradeHistory.length > 0)\n        );\n      });\n\n      if (!hasAnyTradeData && Object.keys(data).length === 0) {\n        console.log("📭 No personal trades found - auto-switching to Demo mode");\n        setIsDemoMode(true);\n        localStorage.setItem("tradingJournalDemoMode", "true");\n        // Don't set hasManuallyToggledMode here - this is automatic, not manual\n\n        // Scroll to latest data after a brief delay to ensure heatmap is rendered\n        setTimeout(() => {\n          if (heatmapContainerRef.current) {\n            const scrollContainer = heatmapContainerRef.current.querySelector('[style*="overflow"]') as HTMLElement;\n            if (scrollContainer) {\n              // Scroll to the rightmost position (latest date)\n              scrollContainer.scrollLeft = scrollContainer.scrollWidth;\n              console.log("🎯 Scrolled to latest data view");\n            }\n          }\n        }, 500);\n      } else if (!hasAnyTradeData) {\n        console.log("⚠️ Personal data exists but has no actual trade data (all zero P&L)");\n      }\n    }\n  };\n\n  const handleDateRangeChange = (range: { from: Date; to: Date } | null) => {\n    console.log("📅 Date range changed:", range);\n    setSelectedDateRange(range);\n  };\n\n  // ✅ NEW: Filter heatmap data based on selected date range\n  // ✅ FIXED: Now uses tradingDataByDate (mode-aware) instead of shared heatmapDataFromComponent\n  const getFilteredHeatmapData = () => {\n    // ✅ CRITICAL FIX: Use tradingDataByDate which correctly switches between demo and personal data\n    const modeAwareData = tradingDataByDate;\n    const totalDates = Object.keys(modeAwareData).length;\n\n    if (!selectedDateRange) {\n      // No range selected - return all data\n      // No range selected - return all data with actual trades\n      const unrangedData = Object.fromEntries(\n        Object.entries(modeAwareData).filter(([_, dayData]) => {\n          const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n          return (metrics?.totalTrades || 0) > 0;\n        })\n      );\n      const actualDates = Object.keys(unrangedData).length;\n      return unrangedData;\n    }\n\n    const filtered: Record<string, any> = {};\n    const fromTime = selectedDateRange.from.getTime();\n    const toTime = selectedDateRange.to.getTime();\n\n    console.log(`🔍 Filtering ${totalDates} dates by range: ${selectedDateRange.from.toISOString().slice(0, 10)} to ${selectedDateRange.to.toISOString().slice(0, 10)} [Mode: ${isDemoMode ? 'DEMO' : 'PERSONAL'}]`);\n\n    Object.keys(modeAwareData).forEach(dateKey => {\n      // Parse date key (expecting YYYY-MM-DD format)\n      const dateTime = new Date(dateKey).getTime();\n\n      if (isNaN(dateTime)) {\n        console.warn(`⚠️ Could not parse date key: ${dateKey}, skipping`);\n        return;\n      }\n\n      if (dateTime >= fromTime && dateTime <= toTime) {\n        const dayData = modeAwareData[dateKey];\n        const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n        if ((metrics?.totalTrades || 0) > 0) {\n          filtered[dateKey] = dayData;\n        }\n      }\n    });\n\n    const filteredCount = Object.keys(filtered).length;\n    console.log(`🔍 Filtered heatmap data: ${filteredCount} dates (from ${totalDates} total) [Mode: ${isDemoMode ? 'DEMO' : 'PERSONAL'}]`);\n\n    if (filteredCount === 0 && totalDates > 0) {\n      console.warn(`⚠️ WARNING: Filtering dropped all ${totalDates} entries! Check date key format compatibility.`);\n      console.log('Sample keys:', Object.keys(modeAwareData).slice(0, 5));\n    }\n\n    return filtered;\n  };\n\n  // Auto-set calendar data fetched when both dates are selected\n  useEffect(() => {\n    if (fromDate && toDate) {\n      setIsCalendarDataFetched(true);\n    } else {\n      setIsCalendarDataFetched(false);\n    }\n  }, [fromDate, toDate]);\n\n  // Auto-click all personal dates for current year or date range\n  const [isAutoClickingPersonal, setIsAutoClickingPersonal] = useState(false);\n\n  const handleAutoClickPersonalDates = async () => {\n    if (isDemoMode) {\n      console.log("⚠️ Auto-click only works in Personal mode");\n      return;\n    }\n\n    const userId = getUserId();\n    if (!userId) {\n      console.log("⚠️ No user ID found - cannot auto-click personal dates");\n      alert("⚠️ Please log in with your AWS account to use personal mode");\n      return;\n    }\n\n    setIsAutoClickingPersonal(true);\n\n    try {\n      console.log(`🔄 Auto-clicking personal dates for year ${heatmapYear}${fromDate && toDate ? ` (range: ${fromDate.toLocaleDateString()} - ${toDate.toLocaleDateString()})` : ''}...`);\n\n      // Fetch all personal data first\n      const response = await fetch(getFullApiUrl(`/api/user-journal/${userId}/all`));\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch personal data');\n      }\n\n      const allPersonalData = await response.json();\n      let datesToFetch: string[] = Object.keys(allPersonalData);\n\n      // Filter by year and date range\n      if (fromDate && toDate) {\n        // If date range is selected, only fetch dates within range\n        const fromTime = fromDate.getTime();\n        const toTime = toDate.getTime();\n\n        datesToFetch = datesToFetch.filter(dateStr => {\n          const dateTime = new Date(dateStr).getTime();\n          return dateTime >= fromTime && dateTime <= toTime;\n        });\n\n        console.log(`📅 Filtered to ${datesToFetch.length} dates within selected range`);\n      } else {\n        // If no range selected, filter by current heatmap year\n        datesToFetch = datesToFetch.filter(dateStr => {\n          const date = new Date(dateStr);\n          return date.getFullYear() === heatmapYear;\n        });\n\n        console.log(`📅 Filtered to ${datesToFetch.length} dates for year ${heatmapYear}`);\n      }\n\n      if (datesToFetch.length === 0) {\n        console.log("ℹ️ No personal dates found for the selected period");\n        return;\n      }\n\n      // Create all fetch promises in parallel for maximum speed\n      const fetchPromises = datesToFetch.map(async (dateStr) => {\n        try {\n          const response = await fetch(getFullApiUrl(`/api/user-journal/${userId}/${dateStr}`));\n          if (response.ok) {\n            let journalData = await response.json();\n\n            // CRITICAL FIX: Unwrap AWS response format (has tradingData wrapper)\n            if (journalData && journalData.tradingData) {\n              journalData = journalData.tradingData;\n              console.log(`📦 Unwrapped AWS tradingData for ${dateStr}`);\n            }\n\n            if (journalData && Object.keys(journalData).length > 0) {\n              return { dateStr, journalData };\n            }\n          }\n        } catch (error) {\n          console.error(`❌ Error loading personal date ${dateStr}:`, error);\n        }\n        return null;\n      });\n\n      // Wait for all fetches to complete in parallel\n      const results = await Promise.all(fetchPromises);\n\n      // Update state with all loaded data\n      const validResults = results.filter((r) => r !== null);\n      if (validResults.length > 0) {\n        const updatedData = { ...personalTradingDataByDate };\n        validResults.forEach((result: any) => {\n          if (result) {\n            updatedData[result.dateStr] = result.journalData;\n          }\n        });\n        setPersonalTradingDataByDate(updatedData);\n        setCalendarData(updatedData); // CRITICAL: Update calendarData to show heatmap colors!\n        localStorage.setItem("personalTradingDataByDate", JSON.stringify(updatedData));\n        console.log(`✅ Auto-click completed! Loaded ${validResults.length} personal dates for heatmap colors. March 3,4,5 should now show colors!`);\n      }\n    } catch (error) {\n      console.error("❌ Error during auto-click:", error);\n      // Don't show error popup for new users - they will see demo heatmap instead\n      console.log("ℹ️ No personal data found - user will see demo heatmap");\n    } finally {\n      setIsAutoClickingPersonal(false);\n    }\n  };\n\n  // Year navigation handlers - auto-click when year changes\n  const handlePreviousYear = () => {\n    const newYear = heatmapYear - 1;\n    setHeatmapYear(newYear);\n    // Auto-click dates for new year if in personal mode\n    if (!isDemoMode) {\n      setTimeout(() => {\n        handleAutoClickPersonalDates();\n      }, 100);\n    }\n  };\n\n  const handleNextYear = () => {\n    const newYear = heatmapYear + 1;\n    setHeatmapYear(newYear);\n    // Auto-click dates for new year if in personal mode\n    if (!isDemoMode) {\n      setTimeout(() => {\n        handleAutoClickPersonalDates();\n      }, 100);\n    }\n  };\n\n  // Reset date range handler\n  const handleResetDateRange = () => {\n    setFromDate(null);\n    setToDate(null);\n    setIsCalendarDataFetched(false);\n  };\n\n  // ✅ AUTO-OPEN JOURNAL INFO MODAL: Show modal when journal tab opens\n  useEffect(() => {\n    if (activeTab === "journal") {\n      setShowJournalInfoModal("auto");\n    }\n  }, [activeTab]);\n\n  // ✅ INSTANT AUTO-LOAD: Load heatmap data immediately when journal tab opens\n  // No delays, no complex logic - just instant data loading\n  useEffect(() => {\n    if (activeTab === 'journal' || activeTab === 'trading-home') {\n      if (!isDemoMode) {\n        // Personal mode - load personal data instantly\n        const userId = getUserId();\n        if (userId) {\n          console.log(`👤 Personal mode - loading personal data instantly...`);\n          handleAutoClickPersonalDates();\n        } else if (!hasManuallyToggledMode) {\n          // Only auto-switch if user hasn't manually chosen personal mode\n          console.log(`⚠️ No userId found - auto-switching to Demo mode`);\n          setIsDemoMode(true);\n          localStorage.setItem("tradingJournalDemoMode", "true");\n        } else {\n          console.log(`ℹ️ No userId but user manually selected personal mode - respecting choice`);\n        }\n      } else {\n        // ✅ SIMPLIFIED: Load demo data directly from AWS - NO localStorage!\n        console.log(`📊 Demo mode - loading from AWS DynamoDB journal-database...`);\n        (async () => {\n          try {\n            const response = await fetch(getFullApiUrl('/api/journal/all-dates'));\n            if (response.ok) {\n              const awsData = await response.json(); // AWS DynamoDB data\n              const dateCount = Object.keys(awsData).length;\n              setDemoTradingDataByDate(awsData);\n              setCalendarData(awsData);\n              console.log(`✅ Loaded ${dateCount} real dates from AWS`);\n            }\n          } catch (error) {\n            console.error("❌ Error loading from AWS:", error);\n          }\n        })();\n      }\n    }\n  }, [isDemoMode, activeTab, heatmapYear]);\n\n  // Calculate total duration of all closed trades\n  const calculateTotalDuration = (trades: any[]) => {\n    let totalMinutes = 0;\n\n    trades.forEach((trade) => {\n      if (trade.duration && trade.duration !== "-") {\n        // Parse duration like "2m 30s" or "15m 45s"\n        const match = trade.duration.match(/(\d+)m\s*(\d+)s/);\n        if (match) {\n          const minutes = parseInt(match[1]);\n          const seconds = parseInt(match[2]);\n          totalMinutes += minutes + seconds / 60;\n        }\n      }\n    });\n\n    const hours = Math.floor(totalMinutes / 60);\n    const mins = Math.floor(totalMinutes % 60);\n\n    if (hours > 0) {\n      return `${hours}h ${mins}m`;\n    } else if (mins > 0) {\n      return `${mins}m`;\n    } else {\n      return "0m";\n    }\n  };\n\n  // Notes handling functions\n  const handleEditNotes = () => {\n    setTempNotesContent(notesContent);\n    setIsEditingNotes(true);\n  };\n\n  const handleSaveNotesOnly = async () => {\n    try {\n      setNotesContent(tempNotesContent);\n      setIsEditingNotes(false);\n\n      // Simple save - only save notes to database\n      const selectedDateStr = formatDateKey(selectedDate!);\n      const existingData = tradingDataByDate[selectedDateStr] || {};\n\n      const updatedData = {\n        ...existingData,\n        tradingNotes: tempNotesContent,\n        selectedDailyFactors: selectedDailyFactors,\n        selectedIndicators: selectedIndicators,\n        selectedTags: getValidTags(selectedTags),\n      };\n\n      const response = await fetch(`/api/journal/${selectedDateStr}`, {\n        method: "PUT",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify(updatedData),\n      });\n\n      if (response.ok) {\n        console.log("✅ Notes saved successfully");\n        // Update local state\n        setTradingDataByDate((prev: any) => ({\n          ...prev,\n          [selectedDateStr]: updatedData,\n        }));\n      } else {\n        console.error("❌ Failed to save notes");\n      }\n    } catch (error) {\n      console.error("❌ Error saving notes:", error);\n    }\n  };\n\n  const handleCancelNotes = () => {\n    setTempNotesContent(notesContent);\n    setIsEditingNotes(false);\n  };\n\n  // Tag handling functions\n  const toggleTag = (tag: string) => {\n    setSelectedTags((prev) => {\n      const newTags = prev.includes(tag)\n        ? prev.filter((t) => t !== tag)\n        : [...prev, tag];\n      // Filter to ensure only valid tags are stored\n      const validTags = getValidTags(newTags);\n      if (typeof window !== "undefined") {\n        localStorage.setItem("tradingTags", JSON.stringify(validTags));\n      }\n      return validTags;\n    });\n  };\n\n  const clearAllTags = () => {\n    setSelectedTags([]);\n    setSelectedDailyFactors([]);\n    setSelectedIndicators([]);\n  };\n\n  // Calendar handler functions\n  const formatDateKey = (date: Date) => {\n    // Use local date components to avoid timezone conversion issues\n    const year = date.getFullYear();\n    const month = String(date.getMonth() + 1).padStart(2, "0");\n    const day = String(date.getDate()).padStart(2, "0");\n    return `${year}-${month}-${day}`; // YYYY-MM-DD format\n  };\n\n  const saveCalendarData = (data: any) => {\n    setCalendarData(data);\n    localStorage.setItem("calendarData", JSON.stringify(data));\n  };\n\n  // Helper function to extract traded symbols from tradeHistory - ONLY INDEX SYMBOLS\n  const extractTradedSymbols = (tradeHistory: any[]): string[] => {\n    if (!Array.isArray(tradeHistory)) return [];\n    const symbolMap = new Map<string, number>();\n\n    // Mapping from contract names to proper index symbols\n    const contractToIndex: Record<string, string> = {\n      'NIFTY': 'NIFTY50',\n      'BANKNIFTY': 'BANKNIFTY',\n      'SENSEX': 'SENSEX',\n      'NIFTYIT': 'NIFTYIT',\n      'FINNIFTY': 'FINNIFTY',\n      'MIDCPNIFTY': 'MIDCPNIFTY',\n      'NIFTYINFRA': 'NIFTYINFRA',\n      'NIFTY50': 'NIFTY50'\n    };\n\n    tradeHistory.forEach((trade: any) => {\n      let symbol = trade.symbol || trade.tradingSymbol || '';\n\n      // Skip if empty\n      if (!symbol) return;\n\n      // Remove exchange prefix if present\n      symbol = symbol.replace('NSE:', '').replace('NFO:', '').replace('MCX:', '').replace('NCDEX:', '').trim();\n\n      // Extract base symbol - get first word or continuous letters before space/number\n      const baseSymbol = symbol.match(/^([A-Z]+)/)?.[1] || '';\n\n      if (!baseSymbol) return;\n\n      // Map to proper index symbol\n      const indexSymbol = contractToIndex[baseSymbol.toUpperCase()] || baseSymbol.toUpperCase();\n\n      // Only add if it's a known index\n      if (Object.values(contractToIndex).includes(indexSymbol)) {\n        symbolMap.set(indexSymbol, (symbolMap.get(indexSymbol) || 0) + 1);\n        console.log(`📊 Mapped "${symbol}" → "${indexSymbol}"`);\n      }\n    });\n\n    // Sort by trade count (descending) and return symbols\n    const result = Array.from(symbolMap.entries())\n      .sort(([, countA], [, countB]) => countB - countA)\n      .map(([symbol]) => symbol);\n\n    console.log(`📊 Final extracted symbols:`, result);\n    return result;\n  };\n\n  const handleDateSelect = async (date: Date, awsData?: any) => {\n    // 📅 User selected date from heatmap\n    const dateString = formatDateKey(date);\n    console.log(`📅 DATE SELECTED: ${dateString}`);\n\n    // ✅ DESTROY CHART IMMEDIATELY - Don't wait for useEffect\n    if (journalChartRef.current) {\n      try {\n        journalChartRef.current.remove();\n        console.log(`✅ Chart destroyed in handleDateSelect`);\n      } catch (e) {}\n      journalChartRef.current = null;\n      journalCandlestickSeriesRef.current = null;\n      journalEma12SeriesRef.current = null;\n      journalEma26SeriesRef.current = null;\n    }\n\n    // Clear all data immediately - HEATMAP ONLY (manual search chart unaffected)\n    setSelectedDate(date);\n    setJournalChartData([]); // Clear manual search chart\n    setLiveOhlc(null);\n    setNotesContent("");\n    setTempNotesContent("");\n    setSelectedTags([]);\n    setSelectedDailyFactors([]);\n    setSelectedIndicators([]);\n    setTradeHistoryData([]);\n    setTradingImages([]);\n    setTradedSymbols([]);\n    setCurrentSymbolIndex(0);\n    setIsLoadingHeatmapData(true); // Show loading state\n\n    const dateKey = formatDateKey(date);\n\n    // If awsData is provided (from PersonalHeatmap), use it directly - NO API FETCH\n    if (awsData !== undefined) {\n      console.log(`✅ Using FRESH AWS data from PersonalHeatmap for ${dateKey}:`, awsData);\n      let journalData = awsData;\n\n      // Handle AWS response format (has tradingData wrapper)\n      if (journalData && journalData.tradingData) {\n        journalData = journalData.tradingData;\n        console.log(`📦 Unwrapped AWS tradingData:`, journalData);\n      }\n\n      if (journalData && Object.keys(journalData).length > 0) {\n        console.log("🎯 Populating UI with FRESH AWS data:", journalData);\n\n        // Load the data into correct state variables\n        const notes = journalData.notes || journalData.tradingNotes || journalData.notesContent || "";\n        if (notes) {\n          setNotesContent(notes);\n          setTempNotesContent(notes);\n          console.log("📝 Loaded notes from AWS:", notes);\n        }\n\n        const tags = journalData.tags || journalData.tradingTags || journalData.selectedTags || [];\n        if (Array.isArray(tags)) {\n          setSelectedTags(tags);\n        }\n\n        const dailyFactors = journalData.dailyFactors || journalData.selectedDailyFactors || [];\n        if (Array.isArray(dailyFactors)) {\n          setSelectedDailyFactors(dailyFactors);\n          console.log("🌅 Loaded daily factors from AWS:", dailyFactors);\n        }\n\n        const indicators = journalData.indicators || journalData.selectedIndicators || [];\n        if (Array.isArray(indicators)) {\n          setSelectedIndicators(indicators);\n          console.log("📊 Loaded indicators from AWS:", indicators);\n          console.log("🏷️ Loaded tags from AWS:", tags);\n        }\n\n        if (journalData.tradeHistory && Array.isArray(journalData.tradeHistory)) {\n          setTradeHistoryData(journalData.tradeHistory);\n          console.log("📊 Loaded trade history from AWS:", journalData.tradeHistory.length, "trades");\n\n          // Extract symbols with most trades\n          const symbols = extractTradedSymbols(journalData.tradeHistory);\n          if (symbols.length > 0) {\n            setTradedSymbols(symbols);\n            setCurrentSymbolIndex(0);\n\n            console.log(`📊 Extracted traded symbols:`, symbols);\n            // ✅ SYNC HEATMAP HEADER: Update when date is selected from trade book\n            const firstSymbol = symbols[0];\n            setHeatmapSelectedSymbol(`NSE:${firstSymbol}-INDEX`);\n            setHeatmapSelectedDate(dateString);\n            console.log(`🗓️ [TRADE BOOK SELECT] Syncing heatmap header with date: ${dateString}, symbol: ${firstSymbol}`);\n            // ✅ DO NOT set selectedJournalSymbol here - manual search chart is independent from heatmap\n            // ✅ FETCH CHART DATA: Load chart for this date and symbol from PersonalHeatmap\n            fetchHeatmapChartData(`NSE:${firstSymbol}-INDEX`, dateString);\n          }\n        }\n\n        const images = journalData.images || journalData.tradingImages || [];\n        if (Array.isArray(images)) {\n          setTradingImages(images);\n          console.log("🖼️ Loaded images from AWS:", images.length, "images");\n        }\n\n        console.log("✅ Successfully loaded all FRESH AWS data for:", dateKey);\n      } else {\n        console.log(`📭 No AWS data for: ${dateKey}`);\n      }\n      setIsLoadingHeatmapData(false);\n      return; // Exit early - we used fresh AWS data\n    }\n\n    // Load journal data from API\n    try {\n      let response;\n      const userId = getUserId();\n\n      if (userId) {\n        // Load user-specific data\n        response = await fetch(getFullApiUrl(`/api/user-journal/${userId}/${dateKey}`));\n      } else {\n        // Load shared demo data\n        response = await fetch(getFullApiUrl(`/api/journal/${dateKey}`));\n      }\n      console.log(`📡 Load response status: ${response.status}`, response);\n\n      if (response.ok) {\n        let journalData = await response.json();\n        console.log(`📊 Journal data received:`, journalData);\n\n        // Handle AWS response format (has tradingData wrapper)\n        if (journalData && journalData.tradingData) {\n          journalData = journalData.tradingData;\n          console.log(`📦 Unwrapped AWS tradingData:`, journalData);\n        }\n\n        // FALLBACK: If user data is empty and we have a userId, try loading shared demo data\n        if ((!journalData || Object.keys(journalData).length === 0) && userId) {\n          console.log(`📭 User journal empty for ${dateKey}, falling back to shared demo data`);\n          const demoResponse = await fetch(getFullApiUrl(`/api/journal/${dateKey}`));\n          if (demoResponse.ok) {\n            journalData = await demoResponse.json();\n            console.log(`✅ Loaded from shared demo endpoint:`, journalData);\n          }\n        }\n\n        if (journalData && Object.keys(journalData).length > 0) {\n          console.log(\n            "🎯 Found journal data from Google Cloud journal-database, populating UI:",\n            journalData,\n          );\n\n          // Data already cleared at start of handleDateSelect for instant feedback\n          // Now just populate with new data\n\n          // Load the data into correct state variables (with field name flexibility)\n          const notes =\n            journalData.notes ||\n            journalData.tradingNotes ||\n            journalData.notesContent ||\n            "";\n          if (notes) {\n            setNotesContent(notes);\n            setTempNotesContent(notes);\n            console.log("📝 Loaded notes from journal-database:", notes);\n          }\n\n          const tags =\n            journalData.tags ||\n            journalData.tradingTags ||\n            journalData.selectedTags ||\n            [];\n          if (Array.isArray(tags)) {\n            setSelectedTags(tags);\n        }\n\n        const dailyFactors = journalData.dailyFactors || journalData.selectedDailyFactors || [];\n        if (Array.isArray(dailyFactors)) {\n          setSelectedDailyFactors(dailyFactors);\n          console.log("🌅 Loaded daily factors from AWS:", dailyFactors);\n        }\n\n        const indicators = journalData.indicators || journalData.selectedIndicators || [];\n        if (Array.isArray(indicators)) {\n          setSelectedIndicators(indicators);\n          console.log("📊 Loaded indicators from AWS:", indicators);\n            console.log("🏷️ Loaded tags from journal-database:", tags);\n          }\n\n          // ✅ ONLY USE REAL FIREBASE TRADE HISTORY - NO HARDCODED/CONSTRUCTED DATA\n          if (\n            journalData.tradeHistory &&\n            Array.isArray(journalData.tradeHistory) &&\n            journalData.tradeHistory.length > 0\n          ) {\n            setTradeHistoryData(journalData.tradeHistory);\n            console.log(\n              "✅ Loaded REAL trade history from AWS:",\n              journalData.tradeHistory.length,\n              "trades",\n            );\n            console.log("📊 Trade data source: FIREBASE (no hardcoded data)");\n\n            // Extract symbols with most trades\n            const symbols = extractTradedSymbols(journalData.tradeHistory);\n            if (symbols.length > 0) {\n              setTradedSymbols(symbols);\n              setCurrentSymbolIndex(0);\n\n              console.log(`📊 Extracted traded symbols:`, symbols);\n              // ✅ SYNC HEATMAP HEADER: Update when date is selected from trade book\n              const firstSymbol = symbols[0];\n              setHeatmapSelectedSymbol(`NSE:${firstSymbol}-INDEX`);\n              setHeatmapSelectedDate(dateString);\n              console.log(`🗓️ [TRADE BOOK SELECT] Syncing heatmap header with date: ${dateString}, symbol: ${firstSymbol}`);\n              // ✅ DO NOT set selectedJournalSymbol here - manual search chart is independent from heatmap\n            }\n          } else {\n            // No trade history in AWS - keep empty state, DO NOT construct fake data\n            setTradeHistoryData([]);\n            console.log("📭 No trade history in AWS for this date - showing empty state");\n          }\n\n          if (journalData.images && Array.isArray(journalData.images)) {\n            setTradingImages(journalData.images);\n            console.log(\n              "🖼️ Loaded images from journal-database:",\n              journalData.images.length,\n              "images",\n            );\n          }\n\n          // Show trading data windows automatically\n          setShowTradingNotesWindow(true);\n          setShowPerformanceWindow(true);\n          setShowMultipleImageUpload(true);\n\n          // Update calendar data to ensure heatmap colors update\n          const updatedCalendarData = {\n            ...calendarData,\n            [dateKey]: journalData,\n          };\n          setCalendarData(updatedCalendarData);\n\n          // CRITICAL: Also update tradingDataByDate for heatmap colors\n          // The heatmap reads from tradingDataByDate to calculate colors\n          const updatedTradingData = {\n            ...tradingDataByDate,\n            [dateKey]: journalData,\n          };\n          setTradingDataByDate(updatedTradingData);\n\n          // Save to localStorage as backup\n          localStorage.setItem(\n            "tradingDataByDate",\n            JSON.stringify(updatedTradingData),\n          );\n          localStorage.setItem(\n            "calendarData",\n            JSON.stringify(updatedCalendarData),\n          );\n\n          console.log(\n            "✅ Successfully loaded and saved all journal data for:",\n            dateKey,\n          );\n        } else {\n          console.log("📭 No journal data found for:", dateKey);\n          // Data already cleared at start of handleDateSelect for instant feedback\n          // Empty state is already showing\n\n          // Still open windows to allow adding new data for this date\n          setShowTradingNotesWindow(true);\n          setShowPerformanceWindow(true);\n          setShowMultipleImageUpload(true);\n        }\n      } else {\n        const errorText = await response.text();\n        console.error(\n          `❌ Load failed with status ${response.status}:`,\n          errorText,\n        );\n        console.log("⚠️ Keeping existing data visible instead of clearing UI");\n        // DON'T clear data on failed load - keep existing UI state visible\n      }\n    } catch (error) {\n      console.error("❌ Error loading journal data:", error);\n      console.log("⚠️ Error loading data - UI will remain empty");\n    } finally {\n      setIsLoadingHeatmapData(false);\n    }\n  };\n\n  const handlePreviousMonth = () => {\n    setCurrentCalendarDate((prev) => {\n      const newDate = new Date(prev);\n      newDate.setMonth(prev.getMonth() - 1);\n      return newDate;\n    });\n  };\n\n  const handleNextMonth = () => {\n    setCurrentCalendarDate((prev) => {\n      const newDate = new Date(prev);\n      newDate.setMonth(prev.getMonth() + 1);\n      return newDate;\n    });\n  };\n\n  const handleTodayClick = () => {\n    const today = new Date();\n    setCurrentCalendarDate(today);\n    setSelectedDate(today);\n  };\n\n  const getCalendarDays = () => {\n    const year = currentCalendarDate.getFullYear();\n    const month = currentCalendarDate.getMonth();\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const startDate = new Date(firstDay);\n    const endDate = new Date(lastDay);\n\n    // Get first day of the week (0 = Sunday)\n    const firstDayOfWeek = firstDay.getDay();\n\n    // Start from the beginning of the week\n    startDate.setDate(1 - firstDayOfWeek);\n\n    // End at the end of the week\n    const lastDayOfWeek = lastDay.getDay();\n    endDate.setDate(lastDay.getDate() + (6 - lastDayOfWeek));\n\n    const days: Date[] = [];\n    const current = new Date(startDate);\n\n    while (current <= endDate) {\n      days.push(new Date(current));\n      current.setDate(current.getDate() + 1);\n    }\n\n    return days;\n  };\n\n  const isDateSelected = (date: Date) => {\n    return selectedDate && date.toDateString() === selectedDate.toDateString();\n  };\n\n  const isToday = (date: Date) => {\n    const today = new Date();\n    return date.toDateString() === today.toDateString();\n  };\n\n  const isCurrentMonth = (date: Date) => {\n    return date.getMonth() === currentCalendarDate.getMonth();\n  };\n\n  const hasDataForDate = (date: Date) => {\n    const dateKey = formatDateKey(date);\n    // Check both calendarData and tradingDataByDate for comprehensive data detection\n    const calData = calendarData[dateKey];\n    const tradeData = tradingDataByDate[dateKey];\n\n    return (\n      (calData &&\n        (calData.tradeHistory ||\n          calData.notes ||\n          (calData.images && calData.images.length > 0))) ||\n      (tradeData &&\n        (tradeData.tradeHistory ||\n          tradeData.tradingNotes ||\n          tradeData.notesContent ||\n          (tradeData.images && tradeData.images.length > 0) ||\n          (tradeData.performanceMetrics &&\n            tradeData.performanceMetrics.totalTrades > 0)))\n    );\n  };\n\n  const isDateInRange = (date: Date) => {\n    if (!fromDate || !toDate) return false;\n    const dateTime = date.getTime();\n    return dateTime >= fromDate.getTime() && dateTime <= toDate.getTime();\n  };\n\n  const getDateRangeData = () => {\n    if (!fromDate || !toDate) return {};\n\n    const rangeData: Record<string, any> = {};\n    const current = new Date(fromDate);\n\n    while (current <= toDate) {\n      const dateKey = formatDateKey(current);\n      if (calendarData[dateKey]) {\n        rangeData[dateKey] = calendarData[dateKey];\n      }\n      current.setDate(current.getDate() + 1);\n    }\n\n    return rangeData;\n  };\n\n  const getDateRangeSummary = () => {\n    const rangeData = getDateRangeData();\n    const dates = Object.keys(rangeData);\n\n    let totalTrades = 0;\n    let datesWithNotes = 0;\n    let datesWithImages = 0;\n    let totalNetPnL = 0;\n    let winningTrades = 0;\n    let losingTrades = 0;\n    let datesWithTrades = 0;\n\n    dates.forEach((dateKey) => {\n      const data = rangeData[dateKey];\n      let hasTradesThisDate = false;\n\n      if (data.tradeHistory && Array.isArray(data.tradeHistory)) {\n        totalTrades += data.tradeHistory.length;\n        if (data.tradeHistory.length > 0) {\n          hasTradesThisDate = true;\n        }\n      }\n\n      if (data.performanceMetrics) {\n        totalNetPnL += data.performanceMetrics.netPnL || 0;\n        winningTrades += data.performanceMetrics.winningTrades || 0;\n        losingTrades += data.performanceMetrics.losingTrades || 0;\n        if (data.performanceMetrics.totalTrades > 0) {\n          hasTradesThisDate = true;\n        }\n      }\n\n      if (hasTradesThisDate) {\n        datesWithTrades++;\n      }\n\n      if (data.tradingNotes || data.notesContent) datesWithNotes++;\n      if (data.images && data.images.length > 0) datesWithImages++;\n    });\n\n    const winRate =\n      totalTrades > 0\n        ? ((winningTrades / (winningTrades + losingTrades)) * 100).toFixed(1)\n        : "0.0";\n\n    return {\n      totalDates: dates.length,\n      totalTrades,\n      datesWithNotes,\n      datesWithImages,\n      datesWithTrades,\n      totalNetPnL,\n      winningTrades,\n      losingTrades,\n      winRate,\n    };\n  };\n\n  // Generate full year date range for heatmap (like GitHub)\n  const generateContinuousDateRange = () => {\n    const currentYear = new Date().getFullYear();\n    const dates = [];\n\n    // Start from January 1st of current year\n    const startOfYear = new Date(currentYear, 0, 1);\n    // Find the start of the week containing Jan 1st\n    const startOfWeek = new Date(startOfYear);\n    startOfWeek.setDate(startOfYear.getDate() - startOfYear.getDay());\n\n    // End at December 31st of current year\n    const endOfYear = new Date(currentYear, 11, 31);\n    // Find the end of the week containing Dec 31st\n    const endOfWeek = new Date(endOfYear);\n    endOfWeek.setDate(endOfYear.getDate() + (6 - endOfYear.getDay()));\n\n    const currentDate = new Date(startOfWeek);\n    while (currentDate <= endOfWeek) {\n      dates.push(new Date(currentDate));\n      currentDate.setDate(currentDate.getDate() + 1);\n    }\n\n    return dates;\n  };\n\n  // Group dates by weeks for proper calendar layout - only actual month dates\n  const getHeatmapWeeks = (year = heatmapYear) => {\n    const months = [];\n\n    // For demo mode in 2025, start from June (month 5) since demo data starts from June\n    // For personal mode or other years, show all 12 months starting from January\n    const startMonth = (isDemoMode && year === 2025) ? 5 : 0;\n    const endMonth = 12;\n\n    // Generate proper calendar layout for each month\n    for (let monthIndex = startMonth; monthIndex < endMonth; monthIndex++) {\n      const firstDay = new Date(year, monthIndex, 1);\n      const lastDay = new Date(year, monthIndex + 1, 0);\n\n      // Only include actual dates of the month, arranged by weeks\n      const monthWeeks = [];\n      const currentDate = new Date(firstDay);\n\n      // Calculate starting position (day of week for first day)\n      const startDayOfWeek = firstDay.getDay();\n\n      let currentWeek = [];\n\n      // Add empty slots for days before the month starts\n      for (let i = 0; i < startDayOfWeek; i++) {\n        currentWeek.push(null);\n      }\n\n      // Add all actual dates of the month\n      while (currentDate.getMonth() === monthIndex) {\n        // Create date using explicit components to avoid timezone issues\n        const day = currentDate.getDate();\n        const dateToAdd = new Date();\n        dateToAdd.setFullYear(year, monthIndex, day);\n        dateToAdd.setHours(12, 0, 0, 0); // Set to noon to avoid timezone edge cases\n        currentWeek.push(dateToAdd);\n        currentDate.setDate(currentDate.getDate() + 1);\n\n        // If week is complete (7 days) or month ended, push week and start new one\n        if (currentWeek.length === 7) {\n          monthWeeks.push(currentWeek);\n          currentWeek = [];\n        }\n      }\n\n      // If there's a partial week remaining, fill it and add it\n      if (currentWeek.length > 0) {\n        while (currentWeek.length < 7) {\n          currentWeek.push(null);\n        }\n        monthWeeks.push(currentWeek);\n      }\n\n      months.push({\n        month: monthIndex,\n        weeks: monthWeeks,\n        name: firstDay.toLocaleDateString("en-US", { month: "short" }),\n      });\n    }\n\n    return months;\n  };\n\n  // Get month labels for full year heatmap\n  const getHeatmapMonthLabels = (year = heatmapYear) => {\n    const months = [];\n\n    // Always show all 12 months of the selected year\n    for (let month = 0; month < 12; month++) {\n      const date = new Date(year, month, 1);\n      months.push({\n        name: date.toLocaleDateString("en-US", { month: "short" }),\n        year: year,\n      });\n    }\n\n    return months;\n  };\n\n  // Color grading function for heatmap based on P&L\n  const getHeatmapColor = (netPnL: number) => {\n    if (netPnL === 0) return "bg-gray-100 dark:bg-gray-700"; // Neutral for no trades\n\n    const absValue = Math.abs(netPnL);\n\n    if (netPnL > 0) {\n      // Green for profits - darker green for higher profits\n      if (absValue >= 5000) return "bg-green-800 dark:bg-green-700"; // Very high profit\n      if (absValue >= 3000) return "bg-green-700 dark:bg-green-600"; // High profit\n      if (absValue >= 1500) return "bg-green-600 dark:bg-green-500"; // Medium profit\n      if (absValue >= 500) return "bg-green-500 dark:bg-green-400"; // Low-medium profit\n      return "bg-green-300 dark:bg-green-300"; // Small profit\n    } else {\n      // Red for losses - darker red for higher losses\n      if (absValue >= 5000) return "bg-red-800 dark:bg-red-700"; // Very high loss\n      if (absValue >= 3000) return "bg-red-700 dark:bg-red-600"; // High loss\n      if (absValue >= 1500) return "bg-red-600 dark:bg-red-500"; // Medium loss\n      if (absValue >= 500) return "bg-red-500 dark:bg-red-400"; // Low-medium loss\n      return "bg-red-300 dark:bg-red-300"; // Small loss\n    }\n  };\n\n  // Save all trading data for the selected date to Google Cloud journal database\n  const saveAllTradingData = async () => {\n    console.log("🚀 SAVE BUTTON CLICKED! Current selectedDate:", selectedDate);\n\n    try {\n      // Check if a date is selected\n      if (!selectedDate) {\n        console.log("❌ No date selected for save operation");\n        alert("⚠️ Please select a date on the calendar first!");\n        return;\n      }\n\n      console.log("✅ Date is selected, proceeding with save...");\n\n      // Use formatDateKey for consistency with load function\n      const selectedDateStr = formatDateKey(selectedDate);\n\n      // Safe data collection with fallbacks to prevent crashes\n      const safeTradeHistory = Array.isArray(tradeHistoryData)\n        ? tradeHistoryData\n        : [];\n      const safeNotesContent =\n        typeof notesContent === "string" ? notesContent : "";\n      const safeTags = Array.isArray(selectedTags) ? selectedTags : [];\n      // Get current images from the image upload component\n      const currentImages = imageUploadRef.current?.getCurrentImages() || [];\n      const safeImages = Array.isArray(currentImages) ? currentImages : [];\n      const safePerformanceMetrics = performanceMetrics || {\n        totalTrades: safeTradeHistory.length,\n        winningTrades: 0,\n        losingTrades: 0,\n        totalPnL: 0,\n        netPnL: 0,\n        winRate: 0,\n        avgWin: 0,\n        avgLoss: 0,\n        profitFactor: 0,\n      };\n\n      const journalData = {\n        tradeHistory: safeTradeHistory,\n        tradingNotes: safeNotesContent,\n        tradingTags: safeTags,\n        images: safeImages,\n        performanceMetrics: safePerformanceMetrics,\n        timestamp: new Date().toISOString(),\n      };\n      console.log(`💾 SAVE SUMMARY for ${selectedDateStr}:`);\n      console.log(`  📊 Trade History: ${safeTradeHistory.length} trades`);\n      console.log(`  📝 Notes: ${safeNotesContent ? safeNotesContent.substring(0, 50) + '...' : 'None'}`);\n      console.log(`  🏷️ Tags: ${safeTags.length} tags - ${safeTags.join(', ')}`);\n      console.log(`  🖼️ Images: ${safeImages.length} images`);\n      console.log(`  💰 Net P&L: ₹${safePerformanceMetrics.netPnL}`);\n      console.log(`🔄 Attempting to save data for date: ${selectedDateStr}`, journalData);\n\n      // Choose endpoint based on demo mode\n      // Switch ON (true) = Demo mode, Switch OFF (false) = Personal mode\n      let response;\n      if (isDemoMode) {\n        // Switch ON = Demo mode: Save to shared Google Cloud journal database\n        console.log("📊 Saving to demo data (shared)");\n        response = await fetch(`/api/journal/${selectedDateStr}`, {\n          method: "POST",\n          headers: {\n            "Content-Type": "application/json",\n          },\n          body: JSON.stringify(journalData),\n        });\n      } else {\n        // Switch OFF = Personal mode: Save to AWS (user-specific)\n        const userId = getUserId();\n        if (!userId) {\n          console.error("❌ Cannot save in personal mode - no AWS user logged in");\n          alert("⚠️ Please log in with your AWS account to save personal trading data.\n\nSwitch to Demo mode or log in to continue.");\n          throw new Error("No AWS user logged in - cannot save to personal mode");\n        }\n        console.log(`👤 Saving to user-specific data (userId: ${userId})`);\n        response = await fetch(`/api/user-journal`, {\n          method: "POST",\n          headers: {\n            "Content-Type": "application/json",\n          },\n          body: JSON.stringify({\n            userId,\n            date: selectedDateStr,\n            tradingData: journalData,\n          }),\n        });\n      }\n\n      console.log(`📡 Save response status: ${response.status}`, response);\n\n      if (response.ok) {\n        const responseData = await response.json();\n        console.log(`✅ Save response data:`, responseData);\n\n        // Update local state\n        const allData = {\n          ...tradingDataByDate,\n          [selectedDateStr]: journalData,\n        };\n        setTradingDataByDate(allData);\n\n        // ✅ CRITICAL FIX: Trigger heatmap refresh immediately after save\n        // This forces PersonalHeatmap to clear old data and fetch fresh, displaying new colors\n        setPersonalHeatmapRevision(prev => prev + 1);\n\n        console.log(\n          `✅ All trading data saved successfully for ${selectedDateStr}`,\n          journalData,\n        );\n\n        // CRITICAL: Reload FULL heatmap data after save to sync everything\n        console.log("🔄 Reloading FULL heatmap data to sync all windows...");\n\n        // Reload the full heatmap data based on current mode\n        setPersonalHeatmapRevision(prev => prev + 1);\n        if (isDemoMode) {\n          console.log("📊 Refreshing demo mode heatmap...");\n          const allDatesResponse = await fetch("/api/journal/all-dates");\n          if (allDatesResponse.ok) {\n            const allDatesData = await allDatesResponse.json();\n            console.log(`✅ Heatmap refreshed with ${Object.keys(allDatesData).length} dates`);\n            setTradingDataByDate(allDatesData);\n          }\n        } else {\n          const userId = getUserId();\n          if (userId) {\n            console.log(`👤 Refreshing personal mode heatmap for user: ${userId}`);\n            const allUserDataResponse = await fetch(`/api/user-journal/${userId}/all`);\n            if (allUserDataResponse.ok) {\n              const allUserData = await allUserDataResponse.json();\n              console.log(`✅ Heatmap refreshed with ${Object.keys(allUserData).length} dates`);\n              setTradingDataByDate(allUserData);\n            }\n          }\n        }\n\n        // Reload the current date to ensure UI updates\n        console.log("🔄 Reloading current date to refresh UI...");\n        await handleDateSelect(selectedDate);\n\n        // Show success message\n        if (typeof window !== "undefined") {\n          const formattedDate = selectedDate.toLocaleDateString("en-US", {\n            weekday: "long",\n            month: "long",\n            day: "numeric",\n            year: "numeric",\n          });\n\n          const saveLocation = isDemoMode ? "Demo" : "Personal";\n\n          setSaveConfirmationData({\n            formattedDate,\n            saveLocation,\n            trades: safeTradeHistory.length,\n            notes: safeNotesContent ? "✓" : "✗",\n            tags: safeTags.length > 0 ? safeTags.join(', ') : "None",\n            images: safeImages.length,\n            netPnL: safePerformanceMetrics.netPnL.toLocaleString("en-IN")\n          });\n          setShowSaveConfirmation(true);\n        }\n      } else {\n        const errorText = await response.text();\n        console.error(\n          `❌ Save failed with status ${response.status}:`,\n          errorText,\n        );\n        throw new Error(\n          `Failed to save to Google Cloud: ${response.status} ${errorText}`,\n        );\n      }\n    } catch (error) {\n      console.error("❌ Error saving to Google Cloud journal database:", error);\n      const errorMessage =\n        error instanceof Error ? error.message : "Unknown error occurred";\n      setSaveConfirmationData({\n        error: true,\n        errorMessage\n      });\n      setShowSaveConfirmation(true);\n    }\n  };\n\n  // Calculate performance metrics from actual trade history data\n  const performanceMetrics = useMemo(() => {\n    if (!tradeHistoryData || tradeHistoryData.length === 0) {\n      return {\n        totalTrades: 0,\n        winningTrades: 0,\n        losingTrades: 0,\n        totalProfit: 0,\n        totalLoss: 0,\n        netPnL: 0,\n        winRate: "0.0",\n      };\n    }\n\n    // Parse P&L values from trade history data\n    const tradesPnL = tradeHistoryData.map((trade) => {\n      // Parse P&L string (e.g., "+₹2850", "-₹1200", "₹0") to number\n      const pnlStr = (trade.pnl || "").replace(/[₹,+\s]/g, ""); // Remove ₹, commas, + and spaces\n      const pnlValue = parseFloat(pnlStr) || 0;\n      return pnlValue;\n    });\n\n    const totalTrades = tradesPnL.length;\n    const winningTrades = tradesPnL.filter((pnl) => pnl > 0).length;\n    const losingTrades = tradesPnL.filter((pnl) => pnl < 0).length;\n    const totalProfit = tradesPnL\n      .filter((pnl) => pnl > 0)\n      .reduce((sum, pnl) => sum + pnl, 0);\n    const totalLoss = Math.abs(\n      tradesPnL.filter((pnl) => pnl < 0).reduce((sum, pnl) => sum + pnl, 0),\n    );\n    const netPnL = tradesPnL.reduce((sum, pnl) => sum + pnl, 0);\n    const closedTrades = winningTrades + losingTrades;\n    const winRate = closedTrades > 0 ? (winningTrades / closedTrades) * 100 : 0;\n\n    return {\n      totalTrades,\n      winningTrades,\n      losingTrades,\n      totalProfit,\n      totalLoss,\n      netPnL,\n      winRate: winRate.toFixed(1),\n    };\n  }, [tradeHistoryData]);\n\n  // Helper function to format duration in milliseconds to readable format (d, h, m, s)\n  const formatDuration = (durationMs: number): string => {\n    if (durationMs < 0) return '-';\n\n    const totalSeconds = Math.floor(durationMs / 1000);\n    const days = Math.floor(totalSeconds / 86400);\n    const hours = Math.floor((totalSeconds % 86400) / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = totalSeconds % 60;\n\n    const parts = [];\n    if (days > 0) parts.push(`${days}d`);\n    if (hours > 0) parts.push(`${hours}h`);\n    if (minutes > 0) parts.push(`${minutes}m`);\n    if (seconds > 0) parts.push(`${seconds}s`);\n\n    return parts.length > 0 ? parts.join(' ') : '0s';\n  };\n\n  // Helper to normalize duration string for display (handles old "210m 49s" format -> "3h 30m 49s")\n  const normalizeDurationForDisplay = (durationStr: string): string => {\n    if (!durationStr || durationStr === '-') return '-';\n\n    // Check if already in new format (contains 'd', 'h', 'm', 's')\n    if (/\d+[dhms]/.test(durationStr)) {\n      return durationStr;\n    }\n\n    // Parse old format: "210m 49s" -> convert to milliseconds and reformat\n    const minuteMatch = durationStr.match(/(\d+)m/);\n    const secondMatch = durationStr.match(/(\d+)s/);\n\n    const minutes = minuteMatch ? parseInt(minuteMatch[1]) : 0;\n    const seconds = secondMatch ? parseInt(secondMatch[1]) : 0;\n\n    const totalSeconds = minutes * 60 + seconds;\n    const days = Math.floor(totalSeconds / 86400);\n    const hours = Math.floor((totalSeconds % 86400) / 3600);\n    const mins = Math.floor((totalSeconds % 3600) / 60);\n    const secs = totalSeconds % 60;\n\n    const parts = [];\n    if (days > 0) parts.push(`${days}d`);\n    if (hours > 0) parts.push(`${hours}h`);\n    if (mins > 0) parts.push(`${mins}m`);\n    if (secs > 0) parts.push(`${secs}s`);\n\n    return parts.length > 0 ? parts.join(' ') : '-';\n  };\n\n  // Import handling functions\n  const calculateSimplePnL = (trades: any[]) => {\n    const processedTrades = [...trades];\n    const positions: {\n      [symbol: string]: {\n        qty: number;\n        avgPrice: number;\n        firstTradeTime: string;\n      };\n    } = {};\n\n    for (let i = 0; i < processedTrades.length; i++) {\n      const trade = processedTrades[i];\n      const symbol = trade.symbol;\n\n      // Initialize position tracking for this symbol\n      if (!positions[symbol]) {\n        positions[symbol] = { qty: 0, avgPrice: 0, firstTradeTime: trade.time };\n      }\n\n      if (trade.order === "BUY") {\n        // Add to position\n        const currentValue = positions[symbol].qty * positions[symbol].avgPrice;\n        const newValue = trade.qty * trade.price;\n        const totalQty = positions[symbol].qty + trade.qty;\n\n        if (totalQty > 0) {\n          positions[symbol].avgPrice = (currentValue + newValue) / totalQty;\n        }\n        positions[symbol].qty = totalQty;\n\n        // If this is the first trade for this symbol, record the time\n        if (positions[symbol].qty === trade.qty) {\n          positions[symbol].firstTradeTime = trade.time;\n        }\n      } else if (trade.order === "SELL") {\n        // Close position (partial or full)\n        if (positions[symbol].qty > 0) {\n          // Calculate P&L for the quantity being sold\n          const pnlPerShare = trade.price - positions[symbol].avgPrice;\n          const totalPnL = pnlPerShare * trade.qty;\n\n          // Calculate duration from first buy to this sell\n          const entryTime = new Date(\n            `1970-01-01 ${positions[symbol].firstTradeTime}`,\n          );\n          const exitTime = new Date(`1970-01-01 ${trade.time}`);\n          const durationMs = exitTime.getTime() - entryTime.getTime();\n          const durationText = formatDuration(durationMs);\n\n          // Set P&L and duration on this SELL trade\n          processedTrades[i].pnl = `₹${totalPnL.toFixed(2)}`;\n          processedTrades[i].duration = durationText;\n\n          // Reduce position\n          positions[symbol].qty -= trade.qty;\n\n          // If position is fully closed, reset\n          if (positions[symbol].qty <= 0) {\n            positions[symbol] = { qty: 0, avgPrice: 0, firstTradeTime: "" };\n          }\n        }\n      }\n    }\n\n    // Sort processed trades by time (earliest first) to maintain chronological order\n    processedTrades.sort((a, b) => {\n      const timeA = convertTimeToComparable(a.time);\n      const timeB = convertTimeToComparable(b.time);\n      return timeA.localeCompare(timeB);\n    });\n\n    return processedTrades;\n  };\n\n  const parseCSVData = (csvText: string) => {\n    try {\n      const lines = csvText.trim().split("\n");\n      const data = [];\n\n      console.log("🔍 Parsing", lines.length, "lines of trade data");\n\n      for (const line of lines) {\n        if (line.trim()) {\n          // Handle comma-separated (CSV), tab-separated, and space-separated data\n          let parts = [];\n          if (line.includes(",")) {\n            // CSV format: split by commas and trim each part\n            parts = line\n              .trim()\n              .split(",")\n              .map((part) => part.trim())\n              .filter((part) => part.length > 0);\n          } else if (line.includes("\t")) {\n            // Tab-separated format: split by tabs only and trim each part\n            parts = line\n              .trim()\n              .split("\t")\n              .map((part) => part.trim())\n              .filter((part) => part.length > 0);\n          } else {\n            // Space-separated format: split by multiple spaces\n            parts = line\n              .trim()\n              .split(/\s{2,}/)\n              .map((part) => part.trim())\n              .filter((part) => part.length > 0);\n          }\n\n          console.log("📋 Parsed parts:", parts);\n\n          // Smart broker format detection\n          if (parts.length >= 4) {\n            let time = "";\n            let order = "";\n            let symbol = "";\n            let type = "MIS";\n            let qty = 0;\n            let price = 0;\n\n            // Detect format by checking first field\n            const firstField = parts[0];\n            const isTimeFirst =\n              firstField && /^\d{1,2}:\d{2}(:\d{2})?/.test(firstField);\n\n            // Check if there's a date column\n            let startIndex = 0;\n            if (\n              parts[0] &&\n              (parts[0].includes("-") || parts[0].includes("/")) &&\n              parts[1] &&\n              /\d{1,2}:\d{2}/.test(parts[1])\n            ) {\n              startIndex = 1; // Skip the date column\n            }\n\n            if (\n              isTimeFirst ||\n              (startIndex === 1 && /^\d{1,2}:\d{2}/.test(parts[startIndex]))\n            ) {\n              // FORMAT 1: Time first (most common)\n              // Time, Symbol/Order, Other fields...\n              time = parts[startIndex];\n\n              // Handle AM/PM\n              if (\n                parts[startIndex + 1] &&\n                /^(AM|PM)$/i.test(parts[startIndex + 1])\n              ) {\n                time = `${time} ${parts[startIndex + 1]}`;\n                startIndex++;\n              }\n\n              // Next field could be symbol or order\n              let nextFieldIndex = startIndex + 1;\n              let nextField = parts[nextFieldIndex] || "";\n\n              // Check if it's an order type (BUY/SELL with optional pipe)\n              const orderMatch = nextField.match(/^(BUY|SELL)\|?$/i);\n              if (orderMatch) {\n                // Standard format: Time, Order, Symbol, Type, Qty, Price\n                order = orderMatch[1].toUpperCase();\n                symbol = parts[nextFieldIndex + 1] || "";\n                type = parts[nextFieldIndex + 2] || "MIS";\n                qty = parseInt(parts[nextFieldIndex + 3] || "0");\n                price = parseFloat(parts[nextFieldIndex + 4] || "0");\n              } else {\n                // Alternative: Time, Symbol, OrderType(combined), Qty, Price\n                symbol = nextField;\n\n                // Next field might be combined order+type (e.g., "buynrml", "sellmis")\n                const combinedField = (\n                  parts[nextFieldIndex + 1] || ""\n                ).toLowerCase();\n                if (combinedField.startsWith("buy")) {\n                  order = "BUY";\n                  type =\n                    combinedField.replace("buy", "").toUpperCase() || "MIS";\n                } else if (combinedField.startsWith("sell")) {\n                  order = "SELL";\n                  type =\n                    combinedField.replace("sell", "").toUpperCase() || "MIS";\n                } else {\n                  // Might be separate order and type\n                  order = (parts[nextFieldIndex + 1] || "")\n                    .toUpperCase()\n                    .replace("|", "");\n                  type = (parts[nextFieldIndex + 2] || "MIS").toUpperCase();\n                }\n\n                // Get qty and price\n                const remainingParts = parts.slice(nextFieldIndex + 2);\n                for (const part of remainingParts) {\n                  const num = parseFloat(part);\n                  if (!isNaN(num) && num > 0) {\n                    if (qty === 0 && num >= 1) {\n                      qty = Math.floor(num);\n                    } else if (price === 0) {\n                      price = num;\n                    }\n                  }\n                }\n              }\n            } else {\n              // FORMAT 2: Symbol first (legacy format)\n              // Symbol, Order|Type, Qty, Price, Time\n              symbol = parts[startIndex];\n\n              // Next field is order (might have pipe or be combined with type)\n              const orderField = parts[startIndex + 1] || "";\n\n              // Check for "BUY| NRML" format (order and type in same field with pipe)\n              if (orderField.includes("|")) {\n                const orderParts = orderField.split("|").map((p) => p.trim());\n                order = orderParts[0].toUpperCase();\n                type = (orderParts[1] || "MIS").toUpperCase();\n                qty = parseInt(parts[startIndex + 2] || "0");\n                price = parseFloat(parts[startIndex + 3] || "0");\n                time = parts[startIndex + 4] || "";\n              } else if (\n                orderField.toLowerCase().startsWith("buy") ||\n                orderField.toLowerCase().startsWith("sell")\n              ) {\n                // Extract order and type from combined field (e.g., "buynrml", "sellmis")\n                const orderFieldUpper = orderField.toUpperCase();\n                if (orderFieldUpper.startsWith("BUY")) {\n                  order = "BUY";\n                  type = orderFieldUpper.replace("BUY", "").trim() || "MIS";\n                } else {\n                  order = "SELL";\n                  type = orderFieldUpper.replace("SELL", "").trim() || "MIS";\n                }\n                qty = parseInt(parts[startIndex + 2] || "0");\n                price = parseFloat(parts[startIndex + 3] || "0");\n                time = parts[startIndex + 4] || "";\n              } else {\n                // Separate order and type fields\n                order = orderField.toUpperCase();\n                type = (parts[startIndex + 2] || "MIS").toUpperCase();\n                qty = parseInt(parts[startIndex + 3] || "0");\n                price = parseFloat(parts[startIndex + 4] || "0");\n                time = parts[startIndex + 5] || "";\n              }\n            }\n\n            // Extract quantity from "225 / 225" format if needed\n            if (qty === 0) {\n              for (const part of parts) {\n                const qtyMatch = part.match(/(\d+)/);\n                if (qtyMatch) {\n                  const testQty = parseInt(qtyMatch[1]);\n                  if (testQty > 0 && testQty < 100000) {\n                    qty = testQty;\n                    break;\n                  }\n                }\n              }\n            }\n\n            // Extract price from "200.00 / 200.00 trg." format if needed\n            if (price === 0) {\n              for (const part of parts) {\n                const priceMatch = part.match(/(\d+\.?\d*)/);\n                if (priceMatch) {\n                  const testPrice = parseFloat(priceMatch[1]);\n                  if (\n                    testPrice > 0 &&\n                    testPrice < 100000 &&\n                    testPrice !== qty\n                  ) {\n                    price = testPrice;\n                    break;\n                  }\n                }\n              }\n            }\n\n            // Clean up order type\n            order = order.toUpperCase().trim();\n            if (!["BUY", "SELL"].includes(order)) {\n              // Try to extract from the line if we still don't have a valid order\n              const lineUpper = line.toUpperCase();\n              if (lineUpper.includes("BUY")) {\n                order = "BUY";\n              } else if (lineUpper.includes("SELL")) {\n                order = "SELL";\n              } else {\n                continue; // Skip invalid orders\n              }\n            }\n\n            // Clean up type\n            type = type.toUpperCase().trim();\n            if (!["MIS", "CNC", "NRML", "BFO", "LIM", "LIMIT"].includes(type)) {\n              type = "MIS"; // Default\n            }\n\n            // Clean symbol - remove NFO, BFO, NSE, BSE suffixes and handle CE/PE\n            symbol = symbol\n              .replace(/\s+(NFO|BFO|NSE|BSE)$/i, "")\n              .replace(/\s+(CE|PE)\s+(NFO|BFO|NSE|BSE)$/i, " $1")\n              .trim();\n\n            console.log("✅ Extracted trade:", {\n              time,\n              order,\n              symbol,\n              type,\n              qty,\n              price,\n            });\n\n            // Only add trade if we have essential fields\n            if (time && order && symbol && qty > 0) {\n              const trade = {\n                time: time,\n                order: order,\n                symbol: symbol,\n                type: type,\n                qty: qty,\n                price: price,\n                pnl: "-",\n                duration: "-",\n              };\n\n              console.log("✅ Adding trade to data:", trade);\n              data.push(trade);\n            } else {\n              console.log("❌ Skipping invalid trade - missing:", {\n                hasTime: !!time,\n                hasOrder: !!order,\n                hasSymbol: !!symbol,\n                hasQty: qty > 0,\n                time,\n                order,\n                symbol,\n                qty,\n              });\n            }\n          }\n        }\n      }\n\n      console.log("📊 Total trades parsed:", data.length);\n\n      // Sort trades by time (earliest first)\n      data.sort((a, b) => {\n        const timeA = convertTimeToComparable(a.time);\n        const timeB = convertTimeToComparable(b.time);\n        return timeA.localeCompare(timeB);\n      });\n\n      return data;\n    } catch (error) {\n      throw new Error(\n        "Failed to parse trade data. Please check the format and try again.",\n      );\n    }\n  };\n\n  // Helper function to convert time strings to comparable format\n  const convertTimeToComparable = (timeStr: string) => {\n    try {\n      // Handle formats like "12:13:17 PM" or "12:13:17"\n      let time = timeStr.trim();\n\n      // If no AM/PM, assume 24-hour format\n      if (!time.includes("AM") && !time.includes("PM")) {\n        return time.padStart(8, "0"); // Ensure consistent format like "12:13:17"\n      }\n\n      // Convert 12-hour to 24-hour format for proper sorting\n      const match = time.match(/(\d{1,2}):(\d{2}):(\d{2})\s*(AM|PM)/i);\n      if (match) {\n        let hours = parseInt(match[1]);\n        const minutes = match[2];\n        const seconds = match[3];\n        const period = match[4].toUpperCase();\n\n        // Convert to 24-hour format\n        if (period === "AM" && hours === 12) {\n          hours = 0;\n        } else if (period === "PM" && hours !== 12) {\n          hours += 12;\n        }\n\n        return `${hours.toString().padStart(2, "0")}:${minutes}:${seconds}`;\n      }\n\n      return time;\n    } catch (error) {\n      return timeStr; // Fallback to original string\n    }\n  };\n\n  const calculatePnLAndDuration = (trades: any[]) => {\n    const processedTrades = [...trades];\n    const openTrades: { [symbol: string]: any[] } = {};\n\n    // Process each trade and match with open positions\n    for (let i = 0; i < processedTrades.length; i++) {\n      const trade = processedTrades[i];\n      const symbol = trade.symbol;\n\n      if (!openTrades[symbol]) {\n        openTrades[symbol] = [];\n      }\n\n      // Find matching open trade with opposite order type (partial or full match)\n      let matchedIndex = -1;\n      for (let j = 0; j < openTrades[symbol].length; j++) {\n        const openTrade = openTrades[symbol][j];\n        if (openTrade.order !== trade.order && openTrade.qty >= trade.qty) {\n          matchedIndex = j;\n          break;\n        }\n      }\n\n      if (matchedIndex !== -1) {\n        // Found a match - calculate P&L and duration\n        const openTrade = openTrades[symbol][matchedIndex];\n\n        // Calculate P&L based on first order type (using closing quantity)\n        let pnlPerShare = 0;\n        if (openTrade.order === "BUY") {\n          // Long position: Buy first, then Sell\n          pnlPerShare = trade.price - openTrade.price;\n        } else {\n          // Short position: Sell first, then Buy\n          pnlPerShare = openTrade.price - trade.price;\n        }\n\n        // Multiply by CLOSING quantity (trade.qty) to get total P&L\n        const totalPnL = pnlPerShare * trade.qty;\n\n        // Calculate duration\n        const openTime = new Date(`1970-01-01 ${openTrade.time}`);\n        const closeTime = new Date(`1970-01-01 ${trade.time}`);\n        const durationMs = closeTime.getTime() - openTime.getTime();\n        const durationText = formatDuration(durationMs);\n\n        // Only show P&L and duration on the closing trade\n        // For LONG (BUY first): Show on SELL row\n        // For SHORT (SELL first): Show on BUY row\n\n        if (openTrade.order === "BUY") {\n          // Long position: BUY first, show P&L on SELL (current trade)\n          processedTrades[i].pnl = `₹${totalPnL.toFixed(2)}`;\n          processedTrades[i].duration = durationText;\n        } else {\n          // Short position: SELL first, show P&L on BUY (current trade)\n          processedTrades[i].pnl = `₹${totalPnL.toFixed(2)}`;\n          processedTrades[i].duration = durationText;\n        }\n\n        // Handle partial vs full exit\n        if (openTrade.qty === trade.qty) {\n          // Full exit - remove the open trade\n          openTrades[symbol].splice(matchedIndex, 1);\n        } else {\n          // Partial exit - reduce the open trade quantity\n          openTrade.qty -= trade.qty;\n        }\n      } else {\n        // No match found - add to open trades\n        openTrades[symbol].push(trade);\n      }\n    }\n\n    return processedTrades;\n  };\n\n  // Helper function to find position of selected text in first line\n  const findPositionInLine = (selectedText: string, firstLine: string): number | null => {\n    if (!selectedText || !firstLine) return null;\n\n    // Split first line by tabs first, then by spaces\n    const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n\n    // Find the exact match or partial match\n    const trimmedSelection = selectedText.trim();\n    const position = words.findIndex(word => word === trimmedSelection || word.includes(trimmedSelection) || trimmedSelection.includes(word));\n\n    console.log("🔍 Position detection:", { selectedText: trimmedSelection, words, position, firstLine });\n    return position >= 0 ? position : null;\n  };\n\n  // Helper: Recalculate format positions based on current textarea's first line\n  // Uses SMART FIELD DETECTION for common fields instead of just displayValue matching\n  const recalculateFormatPositions = (format: FormatData, currentFirstLine: string): FormatData => {\n    if (!currentFirstLine || !format.displayValues) return format;\n\n    const recalculatedPositions: FormatData["positions"] = {\n      time: [],\n      order: [],\n      symbol: [],\n      type: [],\n      qty: [],\n      price: []\n    };\n\n    // Get words from current first line\n    const currentWords = currentFirstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n\n    // SMART FIELD DETECTION - use patterns to find field positions\n    // This is more robust than just matching displayValues which might be different in new data\n\n    // 1. ORDER field: Look for BUY or SELL\n    const orderPos = currentWords.findIndex(w => \n      w.toUpperCase() === "BUY" || w.toUpperCase() === "SELL"\n    );\n    if (orderPos >= 0) {\n      recalculatedPositions.order = [orderPos];\n    }\n\n    // 2. TIME field: Look for HH:MM:SS pattern\n    const timePos = currentWords.findIndex(w => \n      /^\d{1,2}:\d{2}(:\d{2})?$/.test(w)\n    );\n    if (timePos >= 0) {\n      recalculatedPositions.time = [timePos];\n    }\n\n    // 3. TYPE field: Look for MIS, NRML, CNC, etc.\n    const typePos = currentWords.findIndex(w => \n      ["MIS", "NRML", "CNC", "INTRADAY", "DELIVERY", "MARGIN"].includes(w.toUpperCase())\n    );\n    if (typePos >= 0) {\n      recalculatedPositions.type = [typePos];\n    }\n\n    // 4. QTY and PRICE: Find numeric values\n    // QTY is usually a whole number, PRICE usually has decimals or is larger\n    const numericPositions: { pos: number; value: number; hasDecimal: boolean }[] = [];\n    currentWords.forEach((word, idx) => {\n      const cleanNum = word.replace(/[₹$,]/g, "");\n      const num = parseFloat(cleanNum);\n      if (!isNaN(num) && num > 0) {\n        // Skip if already assigned to time/order/type\n        if (idx !== orderPos && idx !== timePos && idx !== typePos) {\n          numericPositions.push({ \n            pos: idx, \n            value: num, \n            hasDecimal: cleanNum.includes(".")\n          });\n        }\n      }\n    });\n\n    // Usually qty comes before price, qty is typically smaller or whole number\n    if (numericPositions.length >= 2) {\n      // Sort by position (earlier = more likely qty)\n      numericPositions.sort((a, b) => a.pos - b.pos);\n      recalculatedPositions.qty = [numericPositions[0].pos];\n      recalculatedPositions.price = [numericPositions[numericPositions.length - 1].pos];\n    } else if (numericPositions.length === 1) {\n      // If only one numeric, use original format's hint\n      if (format.positions.qty.length > 0) {\n        recalculatedPositions.qty = [numericPositions[0].pos];\n      } else {\n        recalculatedPositions.price = [numericPositions[0].pos];\n      }\n    }\n\n    // 5. SYMBOL: Everything else between ORDER and TYPE (typically)\n    // Symbol is usually the longest part or contains instrument names\n    const usedPositions = new Set([\n      ...recalculatedPositions.time,\n      ...recalculatedPositions.order,\n      ...recalculatedPositions.type,\n      ...recalculatedPositions.qty,\n      ...recalculatedPositions.price\n    ]);\n\n    // Find symbol positions - typically comes after order and before type\n    const symbolPositions: number[] = [];\n    for (let i = 0; i < currentWords.length; i++) {\n      if (!usedPositions.has(i)) {\n        const word = currentWords[i];\n        // Skip common non-symbol words\n        if (!["NFO", "NSE", "BSE", "MCX", "w", "CE", "PE", "FUT", "OPT"].includes(word.toUpperCase())) {\n          // Check if it looks like part of a symbol (contains letters)\n          if (/[A-Za-z]/.test(word)) {\n            symbolPositions.push(i);\n          }\n        } else {\n          // Include exchange/option type as part of symbol too\n          symbolPositions.push(i);\n        }\n      }\n    }\n    recalculatedPositions.symbol = symbolPositions;\n\n    console.log("🔄 SMART Recalculated format positions:", {\n      original: format.positions,\n      recalculated: recalculatedPositions,\n      currentWords,\n      displayValues: format.displayValues\n    });\n\n    return {\n      ...format,\n      sampleLine: currentFirstLine,\n      positions: recalculatedPositions\n    };\n  };\n\n  // Parse trades using saved format with position-based mapping (supports multiple positions per field)\n  const parseTradesWithFormat = (data: string, format: FormatData): ParseResult => {\n    const result: ParseResult = {\n      trades: [],\n      errors: []\n    };\n\n    const lines = data.split("\n").filter(line => line.trim());\n\n    if (lines.length === 0) {\n      result.errors.push({\n        line: 0,\n        content: "",\n        reason: "No data found"\n      });\n      return result;\n    }\n\n    // Parse each line using position mapping\n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i].trim();\n      if (!line) continue;\n\n      // Split by tabs first, then by spaces\n      const words = line.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n\n      try {\n        const tradeData: any = {};\n\n        // Extract fields based on saved positions (join if multiple positions)\n        if (format.positions.time.length > 0) {\n          tradeData.time = format.positions.time.map(pos => words[pos] || "").join(" ");\n        }\n        if (format.positions.order.length > 0) {\n          tradeData.order = format.positions.order.map(pos => words[pos] || "").join(" ");\n        }\n        if (format.positions.symbol.length > 0) {\n          tradeData.symbol = format.positions.symbol.map(pos => words[pos] || "").join(" ");\n        }\n        if (format.positions.type.length > 0) {\n          tradeData.type = format.positions.type.map(pos => words[pos] || "").join(" ");\n        }\n        if (format.positions.qty.length > 0) {\n          tradeData.qty = format.positions.qty.map(pos => words[pos] || "").join(" ");\n        }\n        if (format.positions.price.length > 0) {\n          tradeData.price = format.positions.price.map(pos => words[pos] || "").join(" ");\n        }\n\n        // Validate required fields\n        if (!tradeData.order || !tradeData.qty || !tradeData.price) {\n          result.errors.push({\n            line: i + 1,\n            content: line,\n            reason: "Missing required fields (order, qty, or price)"\n          });\n          continue;\n        }\n\n        // Validate and normalize\n        const order = tradeData.order?.toUpperCase();\n        if (order !== "BUY" && order !== "SELL") {\n          result.errors.push({\n            line: i + 1,\n            content: line,\n            reason: `Invalid order type: ${tradeData.order}`\n          });\n          continue;\n        }\n\n        const qty = parseFloat(tradeData.qty);\n        const price = parseFloat(tradeData.price?.replace(/[₹$,]/g, "") || "0");\n\n        if (isNaN(qty) || qty <= 0) {\n          result.errors.push({\n            line: i + 1,\n            content: line,\n            reason: `Invalid quantity: ${tradeData.qty}`\n          });\n          continue;\n        }\n\n        if (isNaN(price) || price <= 0) {\n          result.errors.push({\n            line: i + 1,\n            content: line,\n            reason: `Invalid price: ${tradeData.price}`\n          });\n          continue;\n        }\n\n        result.trades.push({\n          time: tradeData.time || "",\n          order: order as "BUY" | "SELL",\n          symbol: tradeData.symbol || "",\n          type: tradeData.type?.toUpperCase() || "MIS",\n          qty: Math.floor(qty),\n          price,\n          pnl: "-",\n          duration: "-"\n        });\n      } catch (err) {\n        result.errors.push({\n          line: i + 1,\n          content: line,\n          reason: err instanceof Error ? err.message : "Parsing error"\n        });\n      }\n    }\n\n    console.log("✅ Parsed trades using positions:", format.positions, "Result:", result);\n    return result;\n  };\n\n  const handleImportData = () => {\n    try {\n      setImportError("");\n      setParseErrors([]);\n\n      if (!importData.trim()) {\n        setImportError("Please paste trade data");\n        return;\n      }\n\n      // Use format-based parser if active format is set, otherwise use default parser\n      const { trades, errors } = activeFormat \n        ? parseTradesWithFormat(importData, activeFormat)\n        : parseBrokerTrades(importData);\n\n      // Store parse errors for detailed display\n      setParseErrors(errors);\n\n      if (trades.length === 0) {\n        if (errors.length > 0) {\n          setImportError(\n            `No valid trades found. ${errors.length} error(s) detected. See details below.`,\n          );\n        } else {\n          setImportError(\n            "No valid trades found in the data. Please check the format.",\n          );\n        }\n        return;\n      }\n\n      // Calculate P&L for the successfully parsed trades\n      const processedData = calculateSimplePnL(trades);\n\n      // Add imported trades to existing trade history (not replace)\n      setTradeHistoryData((prev) => [...processedData, ...prev]);\n\n      // Show success message with counts\n      if (errors.length > 0) {\n        // Partial import - some trades succeeded, some failed\n        console.log(\n          `✅ Imported ${trades.length} trades successfully. ⚠️ ${errors.length} line(s) had errors.`,\n        );\n      } else {\n        // Full success\n        const formatInfo = detectedFormatLabel ? ` using "${detectedFormatLabel}" format` : "";\n        console.log(`✅ Successfully imported ${trades.length} trades${formatInfo}! Added to existing trade history.`);\n      }\n\n      // Log format detection info\n      if (activeFormat && detectedFormatLabel) {\n        console.log(`🎯 Used auto-detected "${detectedFormatLabel}" format for parsing!`);\n      }\n\n      // Close modal and show order modal only if no errors, otherwise keep modal open to show errors\n      if (errors.length === 0) {\n        setShowImportModal(false);\n        setImportData("");\n        // setShowOrderModal(true);\n        // Reset user format selection for fresh start next time\n        setUserSelectedFormatId(null);\n      } else {\n        // Keep modal open to show errors but still set the data\n        // setShowOrderModal(true);\n      }\n    } catch (error) {\n      setImportError(\n        error instanceof Error ? error.message : "Unknown error occurred",\n      );\n    }\n  };\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file && file.type === "text/csv") {\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        const content = e.target?.result as string;\n        setImportData(content);\n      };\n      reader.readAsText(file);\n    } else {\n      setImportError("Please upload a valid CSV file");\n    }\n  };\n\n  const handleBrokerImport = (trades: BrokerTrade[]) => {\n    const convertedTrades = trades.map((trade) => ({\n      time: new Date(trade.executedAt).toLocaleTimeString("en-US", {\n        hour: "2-digit",\n        minute: "2-digit",\n        second: "2-digit",\n      }),\n      order: trade.action,\n      symbol: trade.symbol,\n      type: "MKT",\n      qty: trade.quantity,\n      price: trade.price,\n      pnl: trade.pnl ? `₹${trade.pnl}` : "-",\n      duration: "-",\n    }));\n\n    setTradeHistoryData((prev) => [...convertedTrades, ...prev]);\n    setShowBrokerImportModal(false);\n  };\n\n  // Helper function to handle tab changes with audio stopping\n  const handleTabChange = (newTab: string) => {\n    // Stop any playing news audio when switching tabs\n    if (window.stopNewsAudio) {\n      window.stopNewsAudio();\n    }\n    setActiveTab(newTab);\n  };\n\n  // Expose tab state management to window for navigation preservation\n  useEffect(() => {\n    window.getActiveTab = () => {\n      console.log('[TAB] Getting active tab:', activeTab);\n      return activeTab;\n    };\n    window.setActiveTab = (tab: string) => {\n      console.log('[TAB] Setting active tab to:', tab);\n      setActiveTab(tab);\n    };\n\n    console.log('[TAB] Tab functions exposed, current tab:', activeTab);\n\n    return () => {\n      delete window.getActiveTab;\n      delete window.setActiveTab;\n    };\n  }, [activeTab]);\n\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const tab = urlParams.get("tab");\n    if (\n      tab &&\n      [\n        "strategy-build",\n        "dashboard",\n        "cb",\n        "chart",\n        "check",\n        "4candle",\n        "scanner",\n        "complete-flexible",\n        "backtest",\n        "simulator",\n        "documentation",\n        "journal",\n        "insights",\n        "voice",\n        "portfolio",\n        "risk-management",\n      ].includes(tab)\n    ) {\n      setActiveTab(tab);\n    }\n  }, [location]);\n\n  // Render social feed with full-width layout (no sidebar)\n  if (activeTab === "voice") {\n    return (\n      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">\n        {/* Full-width Social Feed - No Sidebar */}\n        <main className="h-screen w-full">\n          <NeoFeedSocialFeed onBackClick={() => setTabWithAuthCheck("trading-home")} />\n        </main>\n      </div>\n    );\n  }\n\n  // MiniCast/Tutor tab with full page view\n  if (activeTab === "tutor") {\n    return (\n      <div className="min-h-screen bg-slate-900 p-6">\n        {/* Header */}\n        <div className="flex items-center justify-between mb-8">\n          {/* MiniCast Component - Left Side (replacing search bar) */}\n          <div className="flex items-center gap-6">\n            <div className="bg-white dark:bg-gray-900 rounded-xl px-4 py-3 flex items-center gap-3 shadow-lg border border-gray-700">\n              <div className="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">\n                <span className="text-white font-bold text-sm">M</span>\n              </div>\n              <div>\n                <div className="text-white font-semibold text-sm">MiniCast</div>\n                <div className="text-gray-400 text-xs">Premium Podcasts</div>\n              </div>\n            </div>\n          </div>\n          <div className="flex items-center gap-6">\n            {/* Top right navigation items removed as requested */}\n          </div>\n        </div>\n\n        {/* Main Greeting */}\n        <div className="mb-8">\n          <h1 className="text-3xl font-normal text-white mb-2">\n            {getTimeBasedGreeting()}\n          </h1>\n        </div>\n\n\n        {/* Main Layout Grid - Left Card Content */}\n        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">\n          {/* Left Section - Stack-based Swipeable Cards */}\n          <div className="lg:col-span-4 space-y-6">\n            <div className="relative h-80 pl-[80px] pr-[56px]">\n              <SwipeableCardStack onSectorChange={handleSectorChange} selectedSector={selectedSector} />\n            </div>\n\n          </div>\n\n          {/* Right Section - Wallet View */}\n          <div className="lg:col-span-8 space-y-6">\n            {/* Wallet View Section */}\n            <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700">\n              <div className="mb-6">\n              </div>\n\n              {/* Swipe Cards Section */}\n              <div>\n                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">\n                  {/* Card 1 - Study */}\n                  <div className="relative h-48 rounded-2xl overflow-hidden bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 p-6 cursor-pointer hover:scale-105 transition-transform duration-300">\n                    <div className="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-transparent"></div>\n                    <div className="relative z-10 h-full flex flex-col justify-center items-center text-center">\n                      <div className="text-6xl mb-4">📚</div>\n                      <div className="text-white text-2xl font-bold">Study</div>\n                      <div className="text-black text-sm mt-2">Learning Materials</div>\n                    </div>\n                  </div>\n\n                  {/* Card 2 - Courses */}\n                  <div className="relative h-48 rounded-2xl overflow-hidden bg-gradient-to-br from-emerald-600 via-teal-700 to-cyan-800 p-6 cursor-pointer hover:scale-105 transition-transform duration-300">\n                    <div className="absolute inset-0 bg-gradient-to-r from-emerald-600/20 to-transparent"></div>\n                    <div className="relative z-10 h-full flex flex-col justify-center items-center text-center">\n                      <div className="text-6xl mb-4">🎓</div>\n                      <div className="text-white text-2xl font-bold">Courses</div>\n                      <div className="text-black text-sm mt-2">Training Programs</div>\n                    </div>\n                  </div>\n\n                  {/* Card 3 - Live */}\n                  <div className="relative h-48 rounded-2xl overflow-hidden bg-gradient-to-br from-amber-500 via-yellow-600 to-orange-700 p-6 cursor-pointer hover:scale-105 transition-transform duration-300">\n                    <div className="absolute inset-0 bg-gradient-to-r from-amber-500/20 to-transparent"></div>\n                    <div className="relative z-10 h-full flex flex-col justify-center items-center text-center">\n                      <div className="text-6xl mb-4">🔴</div>\n                      <div className="text-white text-2xl font-bold">Live</div>\n                      <div className="text-black text-sm mt-2">Live Sessions</div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Statistics Section - 70% Width with Subscribe Window - 30% Width */}\n        <div className="mb-8 flex gap-6">\n          {/* Statistics Window - 70% */}\n          <div className="w-[70%]">\n            <div className="bg-slate-800 rounded-2xl p-6 border border-slate-700">\n              <Tabs value={statisticsTab} onValueChange={setStatisticsTab} className="w-full">\n                <div className="flex items-center justify-between mb-6">\n\n                  {/* Tab Switch Buttons */}\n                  <TabsList className="bg-slate-700 border-slate-600">\n                    <TabsTrigger \n                      value="overview" \n                      className="text-slate-300 data-[state=active]:bg-slate-600 data-[state=active]:text-white flex items-center gap-2"\n                    >\n                      <BarChart3 className="w-4 h-4" />\n                      Podcast\n                    </TabsTrigger>\n                    <TabsTrigger \n                      value="setup" \n                      className="text-slate-300 data-[state=active]:bg-slate-600 data-[state=active]:text-white flex items-center gap-2"\n                    >\n                      <Shield className="w-4 h-4" />\n                      Events\n                    </TabsTrigger>\n                  </TabsList>\n                </div>\n\n                {/* Overview Tab Content - Music-Style Podcast Dashboard */}\n                <TabsContent value="overview" className="mt-0">\n                  <div className="space-y-6">\n                    {/* Header */}\n                    <div className="text-white text-xl font-bold mb-6">\n                      TRENDING PODCASTS - {selectedSector === 'FINANCE' ? 'FINANCE' : selectedSector === 'IT' ? 'TECH' : selectedSector === 'COMMODITY' ? 'COMMODITY' : selectedSector === 'GLOBAL' ? 'GLOBAL' : selectedSector === 'BANKS' ? 'BANKING' : selectedSector === 'AUTOMOBILE' ? 'AUTO' : 'FINANCE'}\n                    </div>\n\n\n                    {/* Main Layout */}\n                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">\n                      {/* Featured Podcast - Left Side (2/3 width) */}\n                      <div className="lg:col-span-2">\n                        <div className="bg-gradient-to-br from-pink-500 via-purple-600 to-indigo-700 rounded-3xl p-8 relative overflow-hidden min-h-[280px]">\n                          {/* Background Elements */}\n                          <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20"></div>\n                          <div className="absolute bottom-0 left-0 w-32 h-32 bg-white/5 rounded-full -ml-16 -mb-16"></div>\n\n                          <div className="flex items-center gap-6 relative z-10 h-full">\n                            {/* Podcast Host Image */}\n                            <div className="w-40 h-40 rounded-2xl overflow-hidden bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">\n                              <Mic className="w-20 h-20 text-white" />\n                            </div>\n\n                            {/* Content */}\n                            <div className="flex-1">\n                              <div className="bg-yellow-400 text-black px-3 py-1 rounded-full text-xs font-medium inline-block mb-4">\n                                PODCAST OF THE WEEK\n                              </div>\n                              <h2 className="text-3xl font-bold mb-2 ${paperTradingTotalPnl >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">Rich Mindset</h2>\n                              <p className="text-white/80 mb-4">Finance Expert</p>\n\n                              {/* Play Button */}\n                              <Button className="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 w-12 h-12 rounded-full p-0">\n                                <Play className="w-6 h-6 ml-1" />\n                              </Button>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Top Charts - Right Side (1/3 width) */}\n                      <div className="lg:col-span-1">\n                        <div className="bg-slate-800 rounded-2xl p-4">\n                          <h3 className="text-white text-lg font-bold mb-4">Saved Podcast</h3>\n\n                          <div className="space-y-1">\n                            {/* Podcast Item 1 */}\n                            <div className="flex items-center gap-3">\n                              <div className="w-12 h-12 bg-orange-500 rounded-lg flex items-center justify-center flex-shrink-0">\n                                <DollarSign className="w-6 h-6 text-white" />\n                              </div>\n                              <div className="flex-1 min-w-0">\n                                <h4 className="text-white font-medium text-sm">Budget Planning</h4>\n                                <p className="text-slate-400 text-xs">Money Expert</p>\n                              </div>\n                              <div className="flex items-center gap-2">\n                                <div className="w-8 h-2 bg-blue-500 rounded-full"></div>\n                                <span className="text-slate-400 text-xs">03:13</span>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Heart className="w-3 h-3" />\n                                </Button>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Play className="w-3 h-3" />\n                                </Button>\n                              </div>\n                            </div>\n\n                            {/* Podcast Item 2 */}\n                            <div className="flex items-center gap-3">\n                              <div className="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">\n                                <Mic className="w-6 h-6 text-white" />\n                              </div>\n                              <div className="flex-1 min-w-0">\n                                <h4 className="text-white font-medium text-sm">Psychology of Money</h4>\n                                <p className="text-slate-400 text-xs">Mind & Money</p>\n                              </div>\n                              <div className="flex items-center gap-2">\n                                <div className="w-8 h-2 bg-green-500 rounded-full"></div>\n                                <span className="text-slate-400 text-xs">05:26</span>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Heart className="w-3 h-3" />\n                                </Button>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Play className="w-3 h-3" />\n                                </Button>\n                              </div>\n                            </div>\n\n                            {/* Podcast Item 3 */}\n                            <div className="flex items-center gap-3">\n                              <div className="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">\n                                <BookOpen className="w-6 h-6 text-white" />\n                              </div>\n                              <div className="flex-1 min-w-0">\n                                <h4 className="text-white font-medium text-sm">Entrepreneur Mindset</h4>\n                                <p className="text-slate-400 text-xs">Business Weekly</p>\n                              </div>\n                              <div className="flex items-center gap-2">\n                                <div className="w-8 h-2 bg-yellow-500 rounded-full"></div>\n                                <span className="text-slate-400 text-xs">02:51</span>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Heart className="w-3 h-3" />\n                                </Button>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Play className="w-3 h-3" />\n                                </Button>\n                              </div>\n                            </div>\n\n                            {/* Podcast Item 4 - Resilience */}\n                            <div className="flex items-center gap-3">\n                              <div className="w-12 h-12 bg-teal-500 rounded-lg flex items-center justify-center flex-shrink-0">\n                                <Shield className="w-6 h-6 text-white" />\n                              </div>\n                              <div className="flex-1 min-w-0">\n                                <h4 className="text-white font-medium text-sm">Building Resilience</h4>\n                                <p className="text-slate-400 text-xs">Mental Strength</p>\n                              </div>\n                              <div className="flex items-center gap-2">\n                                <div className="w-8 h-2 bg-teal-500 rounded-full"></div>\n                                <span className="text-slate-400 text-xs">04:12</span>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Heart className="w-3 h-3" />\n                                </Button>\n                                <Button size="sm" variant="ghost" className="w-6 h-6 p-0 text-slate-400 hover:text-white">\n                                  <Play className="w-3 h-3" />\n                                </Button>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* AI-Generated Trending Podcasts */}\n                    <div className="mt-8">\n                      <h3 className="text-white text-lg font-medium mb-4">AI-Generated {selectedSector} Podcasts</h3>\n\n                      {isPodcastsLoading ? (\n                        <div className="text-center py-8">\n                          <div className="animate-spin w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-2"></div>\n                          <p className="text-slate-400 text-sm">Generating trending podcasts...</p>\n                        </div>\n                      ) : (\n                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">\n                          {trendingPodcasts.slice(0, 10).map((podcast, index) => (\n                            <div \n                              key={podcast.id} \n                              className={`rounded-lg p-4 hover:bg-slate-600/50 transition-colors cursor-pointer group ${\n                                selectedPodcast?.id === podcast.id \n                                  ? 'bg-purple-600/30 border border-purple-500' \n                                  : 'bg-slate-700/50'\n                              }`}\n                              onClick={() => handlePodcastSelect(podcast)}\n                              data-testid={`podcast-card-${podcast.id}`}\n                            >\n                              <div className="flex items-start gap-3">\n                                <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center flex-shrink-0">\n                                  <span className="text-white font-bold text-lg">#{index + 1}</span>\n                                </div>\n                                <div className="flex-1 min-w-0">\n                                  <div className="flex items-start justify-between mb-1">\n                                    <h4 className="text-white font-medium text-sm leading-tight">{podcast.title}</h4>\n                                    {podcast.trending && <span className="text-orange-400 text-xs bg-orange-400/20 px-2 py-1 rounded-full">TRENDING</span>}\n                                  </div>\n                                  <p className="text-slate-400 text-xs mb-2 line-clamp-2">{podcast.description}</p>\n                                  <div className="flex items-center gap-4 text-xs text-slate-500">\n                                    <span>🎙️ {podcast.host}</span>\n                                    <span>⏱️ {podcast.duration}</span>\n                                    <span>👥 {podcast.listeners}</span>\n                                  </div>\n                                </div>\n                                <Button size="sm" className="w-8 h-8 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 border-0 rounded-full p-0 opacity-0 group-hover:opacity-100 transition-opacity">\n                                  <Play className="w-4 h-4 ml-0.5" />\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Weekly Top Tracks */}\n                    <div className="mt-8">\n                      <h3 className="text-white text-lg font-medium mb-4">Weekly top tracks</h3>\n\n                      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">\n                        {/* Track 1 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-green-600 to-blue-800 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">🤖</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">AI FINANCE</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">{selectedPodcast ? selectedPodcast.title : `AI in ${selectedSector === 'FINANCE' ? 'Finance' : selectedSector === 'IT' ? 'Tech' : selectedSector === 'COMMODITY' ? 'Commodity' : selectedSector === 'GLOBAL' ? 'Global' : selectedSector === 'BANKS' ? 'Banking' : selectedSector === 'AUTOMOBILE' ? 'Auto' : 'Finance'}`}</h4>\n                          <p className="text-slate-400 text-xs">Tech Weekly</p>\n                        </div>\n\n                        {/* Track 2 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-yellow-400 to-orange-600 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">📰</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">MARKET NEWS</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Market News</h4>\n                          <p className="text-slate-400 text-xs">Daily Report</p>\n                        </div>\n\n                        {/* Track 3 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-red-500 to-pink-600 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">🛡️</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">RISK MGMT</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Risk Management</h4>\n                          <p className="text-slate-400 text-xs">Pro Trader</p>\n                        </div>\n\n                        {/* Track 4 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-blue-500 to-cyan-400 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">🚀</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">STARTUP</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Building Companies</h4>\n                          <p className="text-slate-400 text-xs">Startup Stories</p>\n                        </div>\n\n                        {/* Track 5 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-purple-600 to-indigo-800 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">🎓</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">FELLOWSHIP</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Fellowship Programs</h4>\n                          <p className="text-slate-400 text-xs">Career Growth</p>\n                        </div>\n\n                        {/* Track 6 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-orange-500 to-red-600 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">💼</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">BUSINESS</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Business Models</h4>\n                          <p className="text-slate-400 text-xs">Strategy Tips</p>\n                        </div>\n\n                        {/* Track 7 */}\n                        <div className="group cursor-pointer">\n                          <div className="w-full aspect-square bg-gradient-to-br from-emerald-600 to-teal-800 rounded-lg mb-3 relative overflow-hidden">\n                            <div className="absolute inset-0 bg-black/20"></div>\n                            <div className="absolute inset-0 flex items-center justify-center">\n                              <span className="text-4xl">⭐</span>\n                            </div>\n                            <div className="absolute bottom-2 left-2 text-white text-xs font-bold">HERO ZERO</div>\n                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <Button size="sm" className="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white border-0 rounded-full p-0">\n                                <Play className="w-4 h-4 ml-0.5" />\n                              </Button>\n                            </div>\n                          </div>\n                          <h4 className="text-white font-medium text-sm">Hero to Zero Stories</h4>\n                          <p className="text-slate-400 text-xs">Quick Lessons</p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                {/* Trading Charts Tab Content */}\n                <TabsContent value="trading-charts" className="mt-0">\n                  <div className="h-full flex flex-col">\n                    {/* Header */}\n                    <div className="flex items-center justify-between mb-4 flex-shrink-0">\n                      <h4 className="text-white text-lg font-medium">Upcoming Events</h4>\n                      <div className="flex items-center gap-2 text-slate-400 text-sm">\n                        <span>Showing</span>\n                        <span className="text-white">10</span>\n                        <span>out of 48</span>\n                      </div>\n                    </div>\n\n                    {/* Scrollable Content */}\n                    <div className="flex-1 overflow-y-auto pr-2">\n                      {/* Events Grid */}\n                      <div className="grid grid-cols-3 gap-4 pb-4">\n                      {/* Art & Design Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-blue-400/80 via-cyan-500/60 to-blue-600/80 flex gap-3">\n                        {/* Background Pattern */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-blue-500/30 to-purple-600/40"></div>\n                        <div className="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>\n                        <div className="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full -ml-8 -mb-8"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Startup Summit</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">Global Startup Summit | Hyderabad 2025</h5>\n                            <p className="text-white/90 text-xs mb-1">Sat, 06 Sept • 9:00 AM</p>\n                            <p className="text-white/70 text-xs">📍 Deccan Serai Hotel, Hitech City, Hyderabad</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-4/5"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">85%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹1,299</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          <img \n                            src={getEventImage("Global Startup Summit | Hyderabad 2025")} \n                            alt="Global Startup Summit Hyderabad 2025" \n                            className="w-full h-full object-cover rounded-lg border border-white/20"\n                          />\n                        </div>\n                      </div>\n\n                      {/* Music Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-indigo-600/80 via-blue-700/70 to-purple-800/80 flex gap-3">\n                        {/* Starry Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-blue-900/40 to-purple-900/60"></div>\n                        <div className="absolute top-2 right-4 w-1 h-1 bg-white rounded-full opacity-80"></div>\n                        <div className="absolute top-6 right-8 w-0.5 h-0.5 bg-white rounded-full opacity-60"></div>\n                        <div className="absolute top-4 right-12 w-1 h-1 bg-yellow-200 rounded-full opacity-90"></div>\n                        <div className="absolute top-8 right-6 w-0.5 h-0.5 bg-white rounded-full opacity-70"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Music</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">TiE Bangalore Founders Summit</h5>\n                            <p className="text-white/90 text-xs mb-1">Feb 10, 2025 • 9:30 AM</p>\n                            <p className="text-white/70 text-xs">📍 TiE Bangalore, Koramangala</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-3/4"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">75%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹560</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          <img \n                            src={getEventImage("TiE Bangalore Founders Summit")} \n                            alt="TiE Bangalore Founders Summit" \n                            className="w-full h-full object-cover rounded-lg border border-white/20"\n                          />\n                        </div>\n                      </div>\n\n\n                      {/* Health & Wellness Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-sky-400/80 via-blue-500/70 to-cyan-600/80 flex gap-3">\n                        {/* Wellness Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-sky-400/30 to-blue-600/40"></div>\n                        <div className="absolute top-2 right-2 w-12 h-12 bg-white/10 rounded-full"></div>\n                        <div className="absolute bottom-2 left-2 w-8 h-8 bg-white/10 rounded-full"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Health & Wellness</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">Pharma Bio Summit Hyderabad</h5>\n                            <p className="text-white/90 text-xs mb-1">Jan 28, 2025 • 10:00 AM</p>\n                            <p className="text-white/70 text-xs">📍 HICC, Hyderabad</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-2/5"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">40%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹580</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          <img \n                            src={getEventImage("Pharma Bio Summit Hyderabad")} \n                            alt="Pharma Bio Summit Hyderabad" \n                            className="w-full h-full object-cover rounded-lg border border-white/20"\n                          />\n                        </div>\n                      </div>\n\n                      {/* Food & Culinary Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-orange-400/80 via-red-500/70 to-pink-500/80 flex gap-3">\n                        {/* Food Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-orange-500/30 to-red-600/40"></div>\n                        <div className="absolute top-1 right-1 w-6 h-6 bg-yellow-300/20 rounded-full"></div>\n                        <div className="absolute top-3 right-6 w-4 h-4 bg-orange-300/30 rounded-full"></div>\n                        <div className="absolute bottom-2 left-3 w-5 h-5 bg-red-300/20 rounded-full"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Food & Culinary</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">Hyderabad Food Festival</h5>\n                            <p className="text-white/90 text-xs mb-1">Feb 20, 2025 • 6:00 PM</p>\n                            <p className="text-white/70 text-xs">📍 Shilpakala Vedika, Hyderabad</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-3/5"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">60%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹1,200</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          <img \n                            src={getEventImage("Hyderabad Food Festival")} \n                            alt="Hyderabad Food Festival" \n                            className="w-full h-full object-cover rounded-lg border border-white/20"\n                          />\n                        </div>\n                      </div>\n\n\n                      {/* Technology Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-purple-500/80 via-violet-600/70 to-indigo-700/80 flex gap-3">\n                        {/* Tech Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-purple-600/30 to-indigo-800/40"></div>\n                        <div className="absolute top-0 right-0 w-16 h-16 bg-white/5 transform rotate-45 -mr-8 -mt-8"></div>\n                        <div className="absolute bottom-0 left-0 w-12 h-12 bg-white/5 transform rotate-12 -ml-6 -mb-6"></div>\n                        <div className="absolute top-1/2 right-4 w-2 h-2 bg-cyan-400/60 rounded-full"></div>\n                        <div className="absolute top-1/3 right-8 w-1 h-1 bg-pink-400/60 rounded-full"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Technology</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">HITEX IT Expo Hyderabad</h5>\n                            <p className="text-white/90 text-xs mb-1">Mar 5, 2025 • 9:00 AM</p>\n                            <p className="text-white/70 text-xs">📍 Hitex Exhibition Centre</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-1/2"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">55%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹575</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          <div className="w-full h-full bg-gradient-to-br from-purple-500/30 to-indigo-700/30 rounded-lg border border-white/20 flex items-center justify-center relative overflow-hidden">\n                            <div className="absolute inset-0 bg-gradient-to-br from-violet-600/20 to-indigo-800/20"></div>\n                            <div className="absolute top-1 right-1 w-1 h-1 bg-cyan-400/60 rounded-full"></div>\n                            <div className="absolute bottom-1 left-1 w-1 h-1 bg-pink-400/60 rounded-full"></div>\n                            <div className="relative z-10 text-center">\n                              <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mb-1">\n                                <Zap className="w-4 h-4 text-black" />\n                              </div>\n                              <div className="text-white/70 text-[8px] font-medium">TECH</div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Outdoor & Adventure Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-purple-400/80 via-indigo-500/70 to-blue-600/80 flex gap-3">\n                        {/* Adventure Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-purple-500/30 to-blue-700/40"></div>\n                        <div className="absolute top-0 left-0 w-20 h-20 bg-white/5 rounded-full -ml-10 -mt-10"></div>\n                        <div className="absolute bottom-0 right-0 w-24 h-24 bg-white/5 rounded-full -mr-12 -mb-12"></div>\n                        <div className="absolute top-1/2 left-1/2 w-6 h-6 bg-white/10 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Business</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">Mumbai Fintech Festival</h5>\n                            <p className="text-white/90 text-xs mb-1">Jan 15, 2025 • 10:30 AM</p>\n                            <p className="text-white/70 text-xs">📍 Bombay Exhibition Centre</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-4/5"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">65%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹850</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          {getEventImage("Mumbai Fintech Festival") ? (\n                            <img \n                              src={getEventImage("Mumbai Fintech Festival")!} \n                              alt="Mumbai Fintech Festival" \n                              className="w-full h-full object-cover rounded-lg border border-white/20"\n                            />\n                          ) : (\n                            <div className="w-full h-full bg-gradient-to-br from-purple-400/30 to-blue-600/30 rounded-lg border border-white/20 flex items-center justify-center relative overflow-hidden">\n                              <div className="text-white/70 text-[8px] font-medium">BUSINESS</div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n\n                      {/* Startup Innovations Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-emerald-400/80 via-teal-500/70 to-cyan-600/80 flex gap-3">\n                        {/* Innovation Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/30 to-cyan-700/40"></div>\n                        <div className="absolute top-2 right-3 w-3 h-3 bg-white/20 rounded-full"></div>\n                        <div className="absolute top-6 right-8 w-2 h-2 bg-white/15 rounded-full"></div>\n                        <div className="absolute bottom-4 left-4 w-4 h-4 bg-white/10 rounded-full"></div>\n                        <div className="absolute top-1/3 left-6 w-1 h-1 bg-yellow-300/60 rounded-full"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Startup Innovations</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">Nasscom Product Conclave Bangalore</h5>\n                            <p className="text-white/90 text-xs mb-1">Feb 25, 2025 • 9:00 AM</p>\n                            <p className="text-white/70 text-xs">📍 UB City Mall, Bengaluru</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-4/5"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">80%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹1,250</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          {getEventImage("Nasscom Product Conclave Bangalore") ? (\n                            <img \n                              src={getEventImage("Nasscom Product Conclave Bangalore")!} \n                              alt="Nasscom Product Conclave Bangalore" \n                              className="w-full h-full object-cover rounded-lg border border-white/20"\n                            />\n                          ) : (\n                            <div className="w-full h-full bg-gradient-to-br from-emerald-400/30 to-cyan-600/30 rounded-lg border border-white/20 flex items-center justify-center relative overflow-hidden">\n                              <div className="text-white/70 text-[8px] font-medium">STARTUP</div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n\n                      {/* Promotions Event */}\n                      <div className="relative rounded-xl p-4 overflow-hidden bg-gradient-to-br from-fuchsia-400/80 via-purple-500/70 to-violet-600/80 flex gap-3">\n                        {/* Marketing Background */}\n                        <div className="absolute inset-0 bg-gradient-to-br from-fuchsia-500/30 to-violet-700/40"></div>\n                        <div className="absolute top-0 right-0 w-14 h-14 bg-white/10 transform rotate-12 -mr-7 -mt-7"></div>\n                        <div className="absolute bottom-0 left-0 w-10 h-10 bg-white/10 transform -rotate-12 -ml-5 -mb-5"></div>\n                        <div className="absolute top-1/2 left-1/2 w-8 h-8 bg-white/5 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>\n\n                        {/* Event Content */}\n                        <div className="relative z-10 flex-1">\n                          <div className="flex items-center justify-between mb-3">\n                            <div className="flex items-center gap-2">\n                              <span className="bg-white/20 backdrop-blur-sm text-white px-2 py-1 rounded-full text-xs font-medium">Technology</span>\n                              <span className="bg-green-500/80 text-white px-2 py-1 rounded-full text-xs">● Active</span>\n                            </div>\n                          </div>\n                          <div className="mb-3">\n                            <h5 className="text-white font-semibold mb-1">India AI Summit Mumbai</h5>\n                            <p className="text-white/90 text-xs mb-1">Mar 12, 2025 • 10:00 AM</p>\n                            <p className="text-white/70 text-xs">📍 NESCO Goregaon, Mumbai</p>\n                          </div>\n                          <div className="flex items-center justify-between mb-2">\n                            <div className="flex-1 bg-white/30 rounded-full h-1.5 mr-3">\n                              <div className="bg-white h-1.5 rounded-full w-3/4"></div>\n                            </div>\n                            <span className="text-white/90 text-xs font-medium">70%</span>\n                          </div>\n                          <div className="text-white font-bold text-sm">₹950</div>\n                        </div>\n\n                        {/* Event Image */}\n                        <div className="relative z-10 w-20 h-20 flex-shrink-0">\n                          {getEventImage("India AI Summit Mumbai") ? (\n                            <img \n                              src={getEventImage("India AI Summit Mumbai")!} \n                              alt="India AI Summit Mumbai" \n                              className="w-full h-full object-cover rounded-lg border border-white/20"\n                            />\n                          ) : (\n                            <div className="w-full h-full bg-gradient-to-br from-fuchsia-400/30 to-violet-600/30 rounded-lg border border-white/20 flex items-center justify-center relative overflow-hidden">\n                              <div className="text-white/70 text-[8px] font-medium">AI TECH</div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      </div>\n\n                      {/* Pagination */}\n                      <div className="flex items-center justify-center gap-2 pt-4">\n                        <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white">\n                          <ChevronLeft className="w-4 h-4" />\n                        </Button>\n                        <Button variant="ghost" size="sm" className="bg-purple-600 text-white w-8 h-8 p-0">\n                          1\n                        </Button>\n                        <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white w-8 h-8 p-0">\n                          2\n                        </Button>\n                        <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white w-8 h-8 p-0">\n                          3\n                        </Button>\n                        <span className="text-slate-400 px-2">...</span>\n                        <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white w-8 h-8 p-0">\n                          6\n                        </Button>\n                        <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white">\n                          <ChevronRight className="w-4 h-4" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </TabsContent>\n              </Tabs>\n            </div>\n          </div>\n\n          {/* Subscribe Window - 30% */}\n          <div className="w-[30%] flex flex-col gap-3 h-full">\n            {/* Subscribe Card - 30% height */}\n            <div className="h-[40%] bg-gradient-to-br from-blue-500 to-cyan-400 rounded-2xl p-4 text-white relative overflow-hidden">\n              <div className="absolute top-2 right-2">\n                <span className="text-xs font-medium opacity-80">Ad</span>\n              </div>\n\n              <h3 className="text-lg font-bold mb-1">Global Startup Summit | Hyderabad 2025</h3>\n\n              <Button className="bg-white text-blue-600 hover:bg-gray-100 text-sm px-4 py-2">\n                Subscribe\n              </Button>\n\n              {/* Global Startup Summit Image - Bigger */}\n              <div className="absolute bottom-2 right-2 w-20 h-20 opacity-90">\n                <img \n                  src={getEventImage("Global Startup Summit | Hyderabad 2025")} \n                  alt="Global Startup Summit Hyderabad 2025" \n                  className="w-full h-full object-cover rounded-lg border border-white/30"\n                />\n              </div>\n            </div>\n\n            {/* Community Live Meetings - 50% height */}\n            <div className="h-[50%] bg-slate-800 rounded-2xl p-4 border border-slate-700">\n              <div className="flex items-center gap-3 mb-3">\n                <div className="w-6 h-6 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center">\n                  <span className="text-white text-xs">🔴</span>\n                </div>\n                <span className="text-white font-medium text-sm">Live Community</span>\n              </div>\n\n              <h3 className="text-white font-medium mb-2 text-sm">Join Finance AI Meetups</h3>\n              <p className="text-slate-400 text-xs mb-3">Connect with startups & finance experts. Create avatars, no login required.</p>\n\n              {/* Live Meeting Indicators */}\n              <div className="space-y-2 mb-3">\n                <div className="flex items-center gap-2">\n                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>\n                  <span className="text-slate-300 text-xs">AI Trading Discussion - 12 live</span>\n                </div>\n                <div className="flex items-center gap-2">\n                  <div className="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>\n                  <span className="text-slate-300 text-xs">Startup Pitch Night - 8 live</span>\n                </div>\n                <div className="flex items-center gap-2">\n                  <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>\n                  <span className="text-slate-300 text-xs">DeFi Study Group - 15 live</span>\n                </div>\n              </div>\n\n              <div className="flex -space-x-2 mb-3">\n                <div className="w-6 h-6 bg-blue-500 rounded-full border-2 border-slate-800"></div>\n                <div className="w-6 h-6 bg-green-500 rounded-full border-2 border-slate-800"></div>\n                <div className="w-6 h-6 bg-orange-500 rounded-full border-2 border-slate-800"></div>\n                <div className="w-6 h-6 bg-purple-500 rounded-full border-2 border-slate-800"></div>\n                <div className="w-6 h-6 bg-slate-600 rounded-full border-2 border-slate-800 flex items-center justify-center">\n                  <span className="text-white text-xs">+</span>\n                </div>\n              </div>\n\n              <Button className="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm py-2">\n                Explore Now\n              </Button>\n            </div>\n\n            {/* Podcast Scroller - 20% height */}\n            <div className="h-[20%] bg-slate-800/80 backdrop-blur-md rounded-2xl p-4 border border-slate-700/50">\n              <div className="flex items-center gap-3 h-full">\n                {/* Profile Image */}\n                <div className="w-12 h-12 bg-gradient-to-br from-pink-400 to-purple-500 rounded-xl flex items-center justify-center flex-shrink-0">\n                  <User className="w-6 h-6 text-white" />\n                </div>\n\n                {/* Content */}\n                <div className="flex-1 min-w-0">\n                  <div className="flex items-center justify-between mb-1">\n                    <h4 className="text-white text-sm font-medium truncate">{selectedPodcast ? selectedPodcast.title : `AI in ${selectedSector === 'FINANCE' ? 'Finance' : selectedSector === 'IT' ? 'Tech' : selectedSector === 'COMMODITY' ? 'Commodity' : selectedSector === 'GLOBAL' ? 'Global' : selectedSector === 'BANKS' ? 'Banking' : selectedSector === 'AUTOMOBILE' ? 'Auto' : 'Finance'}`}</h4>\n                    <Mic className="w-3 h-3 text-slate-400 flex-shrink-0" />\n                  </div>\n                  <p className="text-slate-400 text-xs mb-2">19 minutes</p>\n\n                  {/* Progress Bar */}\n                  <div className="flex items-center gap-2 mb-2">\n                    <span className="text-slate-400 text-xs">14:07</span>\n                    <div className="flex-1 bg-slate-600 rounded-full h-1">\n                      <div className="bg-purple-400 h-1 rounded-full w-3/4"></div>\n                    </div>\n                    <span className="text-slate-400 text-xs">-5:04</span>\n                  </div>\n\n                  {/* Controls */}\n                  <div className="flex items-center justify-center gap-3">\n                    <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white w-6 h-6 p-0">\n                      <SkipBack className="w-3 h-3" />\n                    </Button>\n                    <Button variant="ghost" size="sm" className="text-white w-6 h-6 p-0">\n                      <Pause className="w-3 h-3" />\n                    </Button>\n                    <Button variant="ghost" size="sm" className="text-slate-400 hover:text-white w-6 h-6 p-0">\n                      <SkipForward className="w-3 h-3" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n      </div>\n    );\n  }\n\n  return (\n    <div className={`min-h-screen bg-background overscroll-none touch-pan-y ${\n      isSharedReportMode ? 'pointer-events-none opacity-30 blur-sm' : ''\n    }`}>\n      {/* Vertical Sidebar - Fixed Position */}\n\n      {/* Main Content Area - Full Width */}\n      <div className="flex flex-col chatgpt-main-content min-h-screen md:min-h-screen min-h-[100dvh] overscroll-none">\n        {/* Content */}\n        <main className="flex-1 overflow-hidden">\n          <div className="h-full overflow-auto">\n            {/* Render content based on active tab */}\n\n            {activeTab === 'dashboard' && localStorage.getItem('currentUserEmail') === 'chiranjeevi.perala99@gmail.com' && (\n              <div className="space-y-8">\n                <div className="text-center space-y-4">\n                  <div className="flex items-center justify-center gap-3">\n                    <Star className="h-6 w-6 text-yellow-400" />\n                    <h2 className="text-2xl font-bold text-orange-400">Trading Dashboard</h2>\n                  </div>\n                  <p className="text-orange-300">Real-time market data via Angel One SmartAPI</p>\n                </div>\n\n                {/* Angel One Connection Setup */}\n                <div className="bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 shadow-sm">\n                  <div className="border-b border-slate-200 dark:border-slate-800 px-6 py-4">\n                    <div className="flex items-center justify-between">\n                      <div>\n                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Angel One Connection</h3>\n                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">Automatic TOTP authentication - No daily token refresh needed</p>\n                      </div>\n                    </div>\n                  </div>\n                  <div className="p-6">\n                    <div className="space-y-4">\n                      <div className="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg p-3">\n                        <p className="text-sm text-green-800 dark:text-green-200">\n                          <strong>✅ Angel One SmartAPI:</strong> Free API with automatic authentication. Perfect for real-time trading and market data.\n                        </p>\n                      </div>\n                      <AuthButtonAngelOne />\n                    </div>\n                  </div>\n                </div>\n\n                {/* SignIn Data Window with YouTube Link */}\n                <SigninDataWindow />\n\n                {/* Angel One Status */}\n                <AngelOneStatus />\n\n                {/* Live Market Prices - BANKNIFTY, SENSEX, GOLD with WebSocket status */}\n                <AngelOneLiveMarketPrices />\n\n                {/* Angel One API Statistics */}\n                <AngelOneApiStatistics />\n\n                {/* Angel One System Status and Recent Activity */}\n                <AngelOneSystemStatus />\n\n              </div>\n            )}\n\n            {activeTab === "trading-home" && (\n              <div className="relative min-h-screen overflow-hidden">\n                {/* Navigation Menu - Behind the home screen */}\n                <div className="fixed inset-0 bg-gradient-to-b from-blue-800 to-blue-900 z-10 flex items-start justify-end pt-20 px-0 md:items-center md:justify-center md:pt-0 md:px-6">\n                  <div className="w-auto md:w-full md:max-w-sm space-y-6 pr-4 md:pr-0">\n                    {currentUser.userId ? (\n                      <>\n                        {/* User Profile Section - Horizontal Layout */}\n                        <div className="flex items-center gap-4 pb-2">\n                          <Avatar className="w-14 h-14 border-2 border-white/20">\n                            <AvatarImage src={currentUser?.profilePicUrl} />\n                            <AvatarFallback className="bg-gradient-to-br from-purple-500 to-blue-500 text-white font-semibold text-xl">\n                              {(currentUser?.displayName || currentUser?.username || "U").charAt(0).toUpperCase()}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className="flex flex-col min-w-0">\n                            <p className="text-white font-semibold text-base">\n                              {currentUser.displayName && currentUser.displayName !== "Not available" ? currentUser.displayName : (currentUser.username && !currentUser.username.includes("@") ? currentUser.username : "")}\n                            </p>\n                            <p className="text-blue-200 text-sm">\n                               {currentUser.username && !currentUser.username.includes("@") ? `@${currentUser.username}` : ""}\n                            </p>\n                          </div>\n                        </div>\n\n                        {/* Navigation Menu Items - Left aligned */}\n                        <div className="space-y-3 flex flex-col">\n                          <button\n                            onClick={() => { if (isEditingUsername || isEditingDisplayName || isEditingDob || isEditingLocation) { setIsEditingUsername(false); setIsEditingDisplayName(false); setIsEditingDob(false); setIsEditingLocation(false); } else { setIsProfileActive(!isProfileActive); } }}\n                            className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors text-left flex items-center justify-between"\n                            data-testid="nav-profile"\n                          >\n                            <span>profile</span>\n                            {isEditingUsername || isEditingDisplayName || isEditingDob || isEditingLocation ? ( <X className="h-4 w-4" /> ) : ( <ChevronDown className={`h-4 w-4 transition-transform duration-200 ${isProfileActive ? "rotate-180" : ""}`} /> )}\n                          </button>\n                          \n                          {isProfileActive && (\n                            <div className="px-4 py-2 space-y-4 animate-in fade-in slide-in-from-top-2 duration-200">\n                              <div className="flex flex-col group relative">\n                                <span className="text-xs text-gray-400 uppercase tracking-wider">username</span>\n                                {isEditingUsername ? (\n                                  <div className="relative flex items-center gap-2">\n                                    <div className="relative w-full">\n                                      <Input value={newUsername} onChange={(e) => setNewUsername(e.target.value)} className="h-8 bg-gray-800 border-gray-700 text-white pr-10 w-full" autoFocus />\n                                      <button onClick={async (e) => { e.stopPropagation(); await handleUpdateProfile({ username: newUsername }); setIsEditingUsername(false); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded-md transition-all z-10">\n                                        <CheckCircle className="h-4 w-4 text-green-400" />\n                                      </button>\n                                    </div>\n                                  </div>\n                                ) : (\n                                  <div className="flex items-center gap-2 group">\n                                    <span className="text-white font-medium">{currentUser?.username || "Not available"}</span>\n                                    <button\n                                      onClick={(e) => {\n                                        e.stopPropagation();\n                                        setNewUsername(currentUser?.username || "");\n                                        setIsEditingUsername(true);\n                                      }}\n                                      className="p-1 hover:bg-white/10 rounded-md transition-all"\n                                    >\n                                      <Pencil className="h-3 w-3 text-blue-400 opacity-0 group-hover:opacity-100" />\n                                    </button>\n                                  </div>\n                                )}\n                              </div>\n                              <div className="flex flex-col group relative">\n                                <span className="text-xs text-gray-400 uppercase tracking-wider">display name</span>\n                                {isEditingDisplayName ? (\n                                  <div className="relative flex items-center gap-2">\n                                    <div className="relative w-full">\n                                      <Input value={newDisplayName} onChange={(e) => setNewDisplayName(e.target.value)} className="h-8 bg-gray-800 border-gray-700 text-white pr-10 w-full" autoFocus />\n                                      <button onClick={async (e) => { e.stopPropagation(); await handleUpdateProfile({ displayName: newDisplayName }); setIsEditingDisplayName(false); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-white/10 rounded-md transition-all z-10">\n                                        <CheckCircle className="h-4 w-4 text-green-400" />\n                                      </button>\n                                    </div>\n                                  </div>\n                                ) : (\n                                  <div className="flex items-center gap-2 group">\n                                    <span className="text-white font-medium">{currentUser?.displayName && currentUser.displayName !== "Not available" ? currentUser.displayName : ""}</span>\n                                    <button onClick={(e) => { e.stopPropagation(); setNewDisplayName(currentUser?.displayName || ""); setIsEditingDisplayName(true); }} className="p-1 hover:bg-white/10 rounded-md transition-all opacity-0 group-hover:opacity-100"><Pencil className="h-3 w-3 text-blue-400" /></button>\n                                  </div>\n                                )}\n                              </div>\n                              <div className="flex flex-col">\n                                <span className="text-xs text-gray-400 uppercase tracking-wider">email id</span>\n                                <span className="text-white font-medium">{currentUser?.email && currentUser.email !== "empty" ? currentUser.email : ""}</span>\n                              </div>\n                              <div className="flex flex-col group relative">\n                                <span className="text-xs text-gray-400 uppercase tracking-wider">dob</span>\n                                {isEditingDob ? (\n                                  <div className="relative flex items-center group">\n                                    <Input\n                                      type="date"\n                                      value={newDob}\n                                      onChange={(e) => setNewDob(e.target.value)}\n                                      className="h-9 bg-gray-800 border-gray-700 text-white pr-10 focus:ring-1 focus:ring-blue-500"\n                                      autoFocus\n                                      onKeyDown={async (e) => {\n                                        if (e.key === "Enter") {\n                                          e.stopPropagation();\n                                          await handleUpdateProfile({ dob: newDob });\n                                          setIsEditingDob(false);\n                                        } else if (e.key === "Escape") {\n                                          setIsEditingDob(false);\n                                        }\n                                      }}\n                                    />\n                                    <button\n                                      onClick={async (e) => {\n                                        e.stopPropagation();\n                                        await handleUpdateProfile({ dob: newDob });\n                                        setIsEditingDob(false);\n                                      }}\n                                      className="absolute right-2 p-1 hover:bg-white/10 rounded-md transition-all"\n                                      data-testid="button-save-dob"\n                                    >\n                                      <CheckCircle className="h-4 w-4 text-green-400" />\n                                    </button>\n                                  </div>\n                                ) : (\n                                  <div className="flex items-center gap-2 group">\n                                    <span className="text-white font-medium">{currentUser?.dob ? currentUser.dob.split("-").reverse().join("-") : "empty"}</span>\n                                    <button onClick={(e) => { e.stopPropagation(); setNewDob(currentUser?.dob || ""); setIsEditingDob(true); }} className="p-1 hover:bg-white/10 rounded-md transition-all opacity-0 group-hover:opacity-100"><Pencil className="h-3 w-3 text-blue-400" /></button>\n                                  </div>\n                                )}\n                              </div>\n                              <div className="flex flex-col group relative">\n                                <span className="text-xs text-gray-400 uppercase tracking-wider">location</span>\n                                {isEditingLocation ? (\n                                  <div className="relative flex items-center group">\n                                    <Input\n                                      value={newLocation}\n                                      onChange={(e) => setNewLocation(e.target.value)}\n                                      className="h-9 bg-gray-800 border-gray-700 text-white pr-10 focus:ring-1 focus:ring-blue-500"\n                                      autoFocus\n                                      onKeyDown={async (e) => {\n                                        if (e.key === "Enter") {\n                                          e.stopPropagation();\n                                          await handleUpdateProfile({ location: newLocation });\n                                          setIsEditingLocation(false);\n                                        } else if (e.key === "Escape") {\n                                          setIsEditingLocation(false);\n                                        }\n                                      }}\n                                    />\n                                    <button\n                                      onClick={async (e) => {\n                                        e.stopPropagation();\n                                        await handleUpdateProfile({ location: newLocation });\n                                        setIsEditingLocation(false);\n                                      }}\n                                      className="absolute right-2 p-1 hover:bg-white/10 rounded-md transition-all"\n                                      data-testid="button-save-location"\n                                    >\n                                      <CheckCircle className="h-4 w-4 text-green-400" />\n                                    </button>\n                                  </div>\n                                ) : (\n                                  <div className="flex items-center gap-2 group">\n                                    <span className="text-white font-medium">{currentUser?.location && currentUser.location !== "empty" ? currentUser.location : ""}</span>\n                                    <button onClick={(e) => { e.stopPropagation(); setNewLocation(currentUser?.location || ""); setIsEditingLocation(true); }} className="p-1 hover:bg-white/10 rounded-md transition-all opacity-0 group-hover:opacity-100"><Pencil className="h-3 w-3 text-blue-400" /></button>\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          )}\n                          \n                          {!isProfileActive && (\n                            <>\n                              <button\n                                onClick={() => setIsVoiceActive(!isVoiceActive)}\n                                className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors text-left flex items-center justify-between"\n                                data-testid="nav-voice"\n                              >\n                                <span>Voice</span>\n                                <ChevronDown className={`h-4 w-4 transition-transform duration-200 ${isVoiceActive ? "rotate-180" : ""}`} />\n                              </button>\n\n\n                              {isVoiceActive && (\n                                <div className="px-4 py-6 bg-gray-800/50 border border-gray-700 rounded-lg animate-in fade-in slide-in-from-top-2 duration-200">\n                                  <div className="flex flex-col items-center gap-4">\n                                    <span className="text-xs text-gray-400 uppercase tracking-wider font-semibold">voice profiles</span>\n                                    <div className="flex items-center justify-center gap-4 overflow-x-auto no-scrollbar py-2">
                                      {[
                                        { id: "samantha", name: "Samantha", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Samantha" },
                                        { id: "amro", name: "Amro", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" },
                                        { id: "heera", name: "Heera", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka" },
                                        { id: "add", name: "Add", isAdd: true }
                                      ].map((profile) => {
                                        const isSelected = typeof activeVoiceProfileId !== "undefined" && activeVoiceProfileId === profile.id;
                                        return (
                                          <div 
                                            key={profile.id} 
                                            className="flex flex-col items-center gap-1.5 group cursor-pointer" 
                                            onClick={() => {
                                              if (!profile.isAdd) {
                                                setActiveVoiceProfileId(profile.id);
                                                if (typeof window !== "undefined" && "speechSynthesis" in window) {
                                                  // Stop current playback
                                                  window.speechSynthesis.cancel();

                                                  const name = currentUser?.displayName || currentUser?.username || "Trader";
                                                  const utterance = new SpeechSynthesisUtterance(`Hello ${name}, I am ${profile.name}. How is your day? Welcome to perala!`);
                                                  const voices = window.speechSynthesis.getVoices();
                                                  
                                                  // Find profile-specific voices
                                                  let voice = null;
                                                  if (profile.id === "samantha") {
                                                    voice = voices.find(v => v.name.includes("Samantha") || v.name.includes("Zira") || (v.name.includes("Female") && v.lang.includes("en-US")));
                                                  } else if (profile.id === "amro") {
                                                    voice = voices.find(v => v.name.includes("Male") || v.name.includes("David") || v.name.includes("Google UK English Male"));
                                                  } else if (profile.id === "heera") {
                                                    voice = voices.find(v => v.name.includes("Hindi") || v.name.includes("Indian") || (v.name.includes("Female") && v.lang.includes("en-GB")));
                                                  }
                                                  
                                                  if (voice) utterance.voice = voice;
                                                  window.speechSynthesis.speak(utterance);
                                                }
                                              }
                                            }}
                                          >
                                            <div className={`relative w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all group-hover:scale-105 ${isSelected ? "border-blue-500 ring-2 ring-blue-500/50" : "border-transparent"} active:scale-95 overflow-hidden bg-gray-700 shadow-lg`}>
                                              {profile.isAdd ? (
                                                <Plus className="h-5 w-5 text-gray-400" />
                                              ) : (
                                                <img src={profile.avatar} alt={profile.name} className="w-full h-full object-cover" />
                                              )}
                                            </div>
                                            <span className={`text-[10px] font-medium transition-colors flex items-center gap-1 ${isSelected ? "text-blue-400 font-bold" : "text-gray-300 group-hover:text-blue-400"}`}>
                                              {profile.name} {isSelected && <Check className="h-2.5 w-2.5" />}
                                            </span>
                                          </div>
                                        );
                                      })}
                                    </div>\n                                    <p className="text-[11px] text-gray-500 italic">Select a voice for your minicast</p>\n                                  </div>\n                                </div>\n                              )}\n                              {!isVoiceActive && (\n                                <>\n                                  {localStorage.getItem('currentUserEmail') === 'chiranjeevi.perala99@gmail.com' && (\n                                    <button\n                                      onClick={() => {\n                                        setTabWithAuthCheck("dashboard");\n                                        setIsNavOpen(false);\n                                      }}\n                                      className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors flex items-center gap-2"\n                                      data-testid="nav-dashboard"\n                                    >\n                                      <BarChart3 className="h-4 w-4" />\n                                      <span>dashboard</span>\n                                    </button>\n                                  )}\n                                  <button\n                                    onClick={() => setShowSettingsPanel(true)}\n                                    className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors text-left flex items-center gap-2"\n                                    data-testid="nav-settings"\n                                  >\n                                    <Settings className="h-4 w-4" />\n                                    <span>setting & privacy</span>\n                                  </button>\n                                  <button\n                                    onClick={toggleTheme}\n                                    className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors flex items-center gap-2"\n                                    data-testid="nav-dark-theme"\n                                  >\n                                    {theme === 'dark' ? (\n                                      <>\n                                        <Sun className="h-4 w-4" />\n                                        <span>light mode</span>\n                                      </>\n                                    ) : (\n                                      <>\n                                        <Moon className="h-4 w-4" />\n                                        <span>dark mode</span>\n                                      </>\n                                    )}\n                                  </button>\n                                  <button\n                                    onClick={async () => {\n                                      try {\n                                        await cognitoSignOut();\n                                        localStorage.clear();\n                                        window.location.href = "/login";\n                                      } catch (error) {\n                                        console.error("Logout error:", error);\n                                      }\n                                    }}\n                                    className="w-full px-4 py-3 text-white hover:bg-white/10 rounded-lg transition-colors flex items-center gap-2"\n                                    data-testid="nav-logout"\n                                  >\n                                    <LogOut className="h-4 w-4" />\n                                    <span>logout</span>\n                                  </button>\n                                </>\n                              )}\n                            </>\n                          )}</div>\n                      </>\n                    ) : (<div className="flex flex-col items-center justify-center space-y-4">\n                        <button\n                          onClick={() => {\n                            window.location.href = "/login";\n                          }}\n                          className="w-full px-6 py-3 bg-white text-blue-900 hover:bg-blue-50 rounded-lg transition-colors font-semibold text-center"\n                          data-testid="nav-login"\n                        >\n                          Login\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n\n\n                {/* Two-line Hamburger Icon - Mobile only - Theme responsive - Fixed position */}\n                <button\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    setIsNavOpen(!isNavOpen);\n                  }}\n                  className="md:hidden fixed top-4 right-4 z-50 w-10 h-10 flex flex-col items-center justify-center gap-1.5 bg-transparent hover:bg-black/10 dark:hover:bg-white/10 rounded-lg transition-all duration-300"\n                  data-testid="button-nav-toggle"\n                >\n                  <div\n                    className={`h-0.5 bg-gray-900 dark:bg-white transition-all duration-300 ${isNavOpen ? "w-5 rotate-45 translate-y-1" : "w-5"}`}\n                  ></div>\n                  <div\n                    className={`h-0.5 bg-gray-900 dark:bg-white transition-all duration-300 ${isNavOpen ? "w-5 -rotate-45 -translate-y-1" : "w-4 ml-1"}`}\n                  ></div>\n                </button>\n\n                {/* Home Screen - Stacks on top with card effect */}\n                <div\n                  onClick={() => isNavOpen && setIsNavOpen(false)}\n                  className={`min-h-screen bg-gray-900 flex flex-col transition-all duration-500 ease-out relative z-20 ${\n                    isNavOpen\n                      ? "scale-90 -translate-x-[70%] rounded-tr-3xl shadow-2xl"\n                      : "scale-100 translate-x-0"\n                  }`}\n                  style={{\n                    transformOrigin: "right center",\n                  }}\n                >\n                  {/* World Map Section - At top of main content */}\n                  {!searchResults && (\n                    <div className="w-full flex items-center justify-center py-3" style={{ background: theme === 'dark' ? '#1a1a1a' : '#e3f2fd' }}>\n                      {/* Container for WorldMap - full width on mobile, constrained on desktop */}\n                      <div className="w-full md:max-w-lg flex items-center justify-center">\n                        <WorldMap />\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Mobile Greeting - Visible only on mobile */}\n                  <div className="w-full hidden bg-blue-900 px-4 py-3 flex justify-center pt-[1px] pb-[1px] pt-[1px] pb-[1px]">\n                    <div className="text-center">\n                      {isViewOnlyMode ? (\n                        <div className="flex items-center justify-center gap-2">\n                          <Sparkles className="h-4 w-4 text-blue-400" />\n                          <h1 className="text-lg font-normal text-gray-100">\n                            Welcome to Trading Platform\n                          </h1>\n                        </div>\n                      ) : showingInitialGreeting ? (\n                        <div className="flex items-center justify-center gap-2">\n                          <Sparkles className="h-4 w-4 text-blue-400" />\n                          <h1 className="text-lg font-normal text-gray-100">\n                            Hey {currentUser?.displayName || currentUser?.username || "Trader"}\n                          </h1>\n                        </div>\n                      ) : (\n                        <div className="flex items-center justify-center gap-2">\n                          {animatedStocks[currentStockIndex].isProfit ? (\n                            <TrendingUp className="h-4 w-4 text-green-400" />\n                          ) : (\n                            <TrendingDown className="h-4 w-4 text-red-400" />\n                          )}\n                          <span className={`text-sm font-semibold ${animatedStocks[currentStockIndex].isProfit ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                            {animatedStocks[currentStockIndex].symbol}: {animatedStocks[currentStockIndex].price}\n                          </span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Blue Section: Expands to 100% when search results show, fixed height otherwise */}\n                  <div className={`w-full bg-blue-900 flex flex-col items-center justify-start md:py-6 py-0 md:px-4 px-0 relative overflow-y-auto ${\n                    searchResults ? "h-screen" : "h-[75vh] md:h-[69vh]"\n                  }`}>\n                    <div className="max-w-4xl w-full md:space-y-4">\n                      {/* Dynamic Greeting - Hidden on mobile */}\n                    \n\n                      {/* Search Input - Hidden on mobile, moves to bottom when results appear */}\n                      {!searchResults && (\n                      <div\n                        className={`relative mx-auto transition-all duration-300 md:block hidden ${\n                          isSearchActive ? "max-w-4xl" : "max-w-2xl"\n                        }`}\n                      >\n                        <Input\n                          placeholder="Search stocks, technical analysis, social feed, news, journal, alerts, or ask AI anything..."\n                          value={searchQuery}\n                          onFocus={() => setIsSearchActive(true)}\n                          onChange={(e) => {\n                            const value = e.target.value;\n                            setSearchQuery(value);\n                            setIsSearchActive(value.length > 0);\n                          }}\n                          onKeyPress={async (e) => {\n                            if (e.key === "Enter" && searchQuery.trim()) {\n                              await handleSearch();\n                            }\n                          }}\n                          className={`w-full transition-all duration-300 bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-400 pr-12 text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${\n                            isSearchActive\n                              ? "h-14 rounded-xl"\n                              : "h-12 rounded-2xl"\n                          }`}\n                        />\n                        <Button\n                          size="sm"\n                          className="absolute right-2 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 text-gray-300 h-6 w-6 p-0"\n                          onClick={() => handleSearch()}\n                          disabled={!searchQuery.trim() || isSearchLoading}\n                        >\n                          {isSearchLoading ? (\n                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                          ) : (\n                            <Bot className="h-4 w-4" />\n                          )}\n                        </Button>\n                      </div>\n                      )}\n\n                      {/* Search bar at bottom when results are shown */}\n                      {searchResults && (\n                      <div className="fixed bottom-0 left-0 right-0 z-50 md:block hidden">\n                        <div className="w-full bg-blue-900/30 backdrop-blur-sm border-t border-gray-700 px-4 py-3">\n                          <div className="max-w-4xl mx-auto flex gap-2">\n                            <Input\n                              placeholder="New search..."\n                              value={searchQuery}\n                              onChange={(e) => {\n                                const value = e.target.value;\n                                setSearchQuery(value);\n                              }}\n                              onKeyPress={async (e) => {\n                                if (e.key === "Enter" && searchQuery.trim()) {\n                                  await handleSearch();\n                                }\n                              }}\n                              className="flex-1 bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-400 h-10 text-sm"\n                            />\n                            <Button\n                              size="sm"\n                              className="bg-gray-700 hover:bg-gray-600 text-gray-300 h-10 px-4"\n                              onClick={() => handleSearch()}\n                              disabled={!searchQuery.trim() || isSearchLoading}\n                            >\n                              {isSearchLoading ? (\n                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                              ) : (\n                                <Bot className="h-4 w-4" />\n                              )}\n                            </Button>\n                            <Button\n                              size="sm"\n                              variant="ghost"\n                              className="text-gray-400 hover:text-gray-200 h-10 px-3"\n                              onClick={() => {\n                                setSearchQuery("");\n                                setIsSearchActive(false);\n                                setSearchResults("");\n                              }}\n                            >\n                              <X className="h-4 w-4" />\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                      )}\n\n                      {/* AI Search Results - Desktop only */}\n                      {isSearchActive && (\n                        <div className="max-w-5xl mx-auto mt-4 animate-in slide-in-from-top-4 duration-300 md:block hidden">\n                          <div className="bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl p-4">\n                            {searchResults ? (\n                              <div className="space-y-1">\n                                <div className="flex items-center gap-2 pb-3 border-b border-transparent">\n                                  {searchResults.includes("[CHART:WATCHLIST]") ? (\n                                      <>\n                      <Eye className="h-4 w-4 text-gray-700 dark:text-blue-400" />\n                      <h3 className="text-lg font-medium text-gray-100">\n                        Watchlist\n                                      </h3>\n                                      </>\n                                    ) : searchResults.includes("[CHART:TRADE]") ? (\n                                      <>\n                      <Trophy className="h-4 w-4 text-orange-400" />\n                      <h3 className="text-lg font-medium text-gray-100">\n                        Trading Challenge\n                                      </h3>\n                                      </>\n                                    ) : (\n                                      <>\n                      <Bot className="h-4 w-4 text-blue-400" />\n                      <h3 className="text-lg font-medium text-gray-100">\n                        AI Assistant\n                                      </h3>\n                                      </>\n                                    )}\n                                </div>\n                                <div className="prose prose-invert max-w-none">\n                                  <div className="text-gray-300 whitespace-pre-wrap leading-relaxed">\n                                    {(() => {\n                                      let renderedContent: any = null;\n                                      let processedResults = searchResults;\n\n                                      // Handle price chart at the top\n                                      if (searchResults.includes("[CHART:PRICE_CHART]")) {\n                                        const priceChartData =\n                                          (window as any).aiAssistantPriceChartData || [];\n                                        const stockData = (window as any).aiAssistantStockData || {};\n                                        const parts = searchResults.split("[CHART:PRICE_CHART]");\n                                        processedResults = parts[1] || "";\n\n                                        const timeframes = ['1D', '5D', '1M', '6M', '1Y'];\n                                        const selectedTimeframe = aiChartSelectedTimeframe;\n\n                                        // Extract price data from chart data\n                                        const lastCandle = priceChartData[priceChartData.length - 1];\n                                        const firstCandle = priceChartData[0];\n                                        const currentPrice = lastCandle?.price || 0;\n                                        const priceChange = lastCandle && firstCandle ? lastCandle.price - firstCandle.price : 0;\n                                        const changePercent = firstCandle?.price ? (priceChange / firstCandle.price) * 100 : 0;\n                                        const stockName = stockData.name || 'Stock Price';\n\n                                        renderedContent = (\n                                          <div className="flex gap-4">\n                                            {priceChartData.length > 0 && (\n                                              <div className="flex-1 mb-4 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                                {/* Header with timeframes and price info */}\n                                                <div className="mb-4">\n                                                  <div className="flex items-center justify-between mb-3">\n                                                    {/* Timeframe buttons */}\n                                                    <div className="flex gap-1.5">\n                                                      {timeframes.map((tf) => (\n                                                        <button\n                                                          key={tf}\n                                                          onClick={async () => {\n                                                            setAiChartSelectedTimeframe(tf);\n                                                            (window as any).aiAssistantSelectedTimeframe = tf;\n                                                            // Fetch new chart data for the selected timeframe\n                                                            const symbol = (window as any).companyInsightsData?.symbol || '';\n                                                            if (symbol) {\n                                                              try {\n                                                                const response = await fetch(getFullApiUrl(`/api/stock-chart-data/${symbol}?timeframe=${tf}`));\n                                                                if (response.ok) {\n                                                                  const newChartData = await response.json();\n                                                                  if (newChartData && newChartData.length > 0) {\n                                                                    (window as any).aiAssistantPriceChartData = newChartData;\n                                                                    window.dispatchEvent(new Event('timeframeChange'));\n                                                                  }\n                                                                }\n                                                              } catch (error) {\n                                                                console.warn("Failed to fetch chart data for timeframe:", error);\n                                                              }\n                                                            }\n                                                          }}\n                                                          data-testid={`button-timeframe-${tf}`}\n                                                          className={`px-3 py-1 rounded-md text-xs font-medium transition-colors ${\n                                                            selectedTimeframe === tf\n                                                              ? 'bg-blue-500 text-white'\n                                                              : 'bg-gray-800 text-gray-300 hover:bg-gray-700'\n                                                          }`}\n                                                        >\n                                                          {tf}\n                                                        </button>\n                                                      ))}\n                                                    </div>\n\n                                                    {/* Price info on right */}\n                                                    <div className="text-right">\n                                                      <div className="flex items-center gap-2 justify-end">\n                                                        <div>\n                                                          <div className="text-sm font-semibold text-gray-100">\n                                                            ₹{currentPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 })}\n                                                          </div>\n                                                          <div className={`text-xs font-medium ${\n                                                            priceChange >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'\n                                                          }`}>\n                                                            {priceChange >= 0 ? '↑' : '↓'} ₹{Math.abs(priceChange).toFixed(2)} ({changePercent >= 0 ? '+' : ''}{changePercent.toFixed(2)}%)\n                                                          </div>\n                                                        </div>\n                                                      </div>\n                                                    </div>\n                                                  </div>\n\n                                                  {/* Stock name below timeframes */}\n                                                  <div className="text-sm font-medium text-gray-300 mb-3">\n                                                    {stockName}\n                                                  </div>\n                                                </div>\n\n                                                <div className="h-56 w-full">\n                                                  <ResponsiveContainer width="100%" height="100%">\n                                                    <LineChart data={priceChartData} margin={{ top: 5, right: 20, left: 1.5, bottom: 5 }}>\n                                                      <XAxis \n                                                        dataKey="time" \n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={{ fontSize: 10, fill: '#64748b' }}\n                                                        tickCount={8}\n                                                      />\n                                                      <YAxis \n                                                        domain={['dataMin - 10', 'dataMax + 10']}\n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={{ fontSize: 10, fill: '#64748b' }}\n                                                        width={35}\n                                                        tickFormatter={(value) => `₹${(value/1000).toFixed(0)}K`}\n                                                      />\n                                                      <Tooltip \n                                                        content={({ active, payload, label }) => {\n                                                          if (!active || !payload || !payload.length) return null;\n                                                          const value = payload[0].value;\n                                                          return (\n                                                            <div style={{\n                                                              backgroundColor: '#1e293b',\n                                                              border: '1px solid #334155',\n                                                              borderRadius: '6px',\n                                                              color: '#e2e8f0',\n                                                              padding: '8px 16px',\n                                                              fontSize: '13px',\n                                                              minWidth: '140px',\n                                                              boxShadow: '0 4px 12px rgba(0,0,0,0.4)',\n                                                              display: 'flex',\n                                                              alignItems: 'center',\n                                                              gap: '12px'\n                                                            }}>\n                                                              <span style={{ fontSize: '13px', fontWeight: '500' }}>\n                                                                ₹{Number(value).toFixed(2)}\n                                                              </span>\n                                                              <div style={{\n                                                                width: '1px',\n                                                                height: '20px',\n                                                                backgroundColor: '#475569'\n                                                              }}></div>\n                                                              <span style={{ fontSize: '12px', color: '#94a3b8' }}>\n                                                                {label}\n                                                              </span>\n                                                            </div>\n                                                          );\n                                                        }}\n                                                      />\n                                                      <Line \n                                                        type="linear" \n                                                        dataKey="price" \n                                                        stroke="#ef4444"\n                                                        strokeWidth={2}\n                                                        dot={false}\n                                                        activeDot={{ r: 4, fill: '#ef4444' }}\n                                                      />\n                                                      {currentPrice > 0 && (\n                                                        <ReferenceLine \n                                                          y={currentPrice}\n                                                          stroke={priceChange >= 0 ? '#22c55e' : '#ef4444'}\n                                                          strokeDasharray="4 4"\n                                                          strokeWidth={1}\n                                                          opacity={0.6}\n                                                        />\n                                                      )}\n                                                    </LineChart>\n                                                  </ResponsiveContainer>\n                                                </div>\n\n                                                {/* OHLC Display Section */}\n                                                {priceChartData.length > 0 && (() => {\n                                                  const firstCandle = priceChartData[0];\n                                                  const lastCandle = priceChartData[priceChartData.length - 1];\n                                                  const prices = priceChartData.map((candle: any) => candle.price);\n                                                  const open = firstCandle?.price || 0;\n                                                  const high = Math.max(...prices);\n                                                  const low = Math.min(...prices);\n                                                  const close = lastCandle?.price || 0;\n\n                                                  return (\n                                                    <div className="mt-4 grid grid-cols-4 gap-2">\n                                                      <div className="bg-gray-800/50 rounded-lg p-3 border border-gray-700">\n                                                        <div className="text-xs font-medium text-gray-400 mb-1">Open</div>\n                                                        <div className="text-sm font-semibold text-gray-100">₹{open.toFixed(2)}</div>\n                                                      </div>\n                                                      <div className="bg-gray-800/50 rounded-lg p-3 border border-gray-700">\n                                                        <div className="text-xs font-medium text-gray-400 mb-1">High</div>\n                                                        <div className="text-sm font-semibold text-green-400">₹{high.toFixed(2)}</div>\n                                                      </div>\n                                                      <div className="bg-gray-800/50 rounded-lg p-3 border border-gray-700">\n                                                        <div className="text-xs font-medium text-gray-400 mb-1">Low</div>\n                                                        <div className="text-sm font-semibold text-red-400">₹{low.toFixed(2)}</div>\n                                                      </div>\n                                                      <div className="bg-gray-800/50 rounded-lg p-3 border border-gray-700">\n                                                        <div className="text-xs font-medium text-gray-400 mb-1">Close</div>\n                                                        <div className={`text-sm font-semibold ${close >= open ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>₹{close.toFixed(2)}</div>\n                                                        <div className={`text-xs font-medium ${close >= open ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                                          {close >= open ? '+' : ''}{((close - open) / open * 100).toFixed(2)}%\n                                                        </div>\n                                                      </div>\n                                                    </div>\n                                                  );\n                                                })()}\n                                              </div>\n                                            )}\n                                            {/* Related News for Search Results */}\n                                            <div className="flex-1 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                              <div className="flex items-center justify-between mb-4">\n                                                <div className="flex items-center gap-2">\n                                                  <Clock className="h-4 w-4 text-gray-400" />\n                                                  <h3 className="text-sm font-medium text-gray-200">\n                                                    Related News\n                                                  </h3>\n                                                </div>\n                                                <Button\n                                                  variant="ghost"\n                                                  size="sm"\n                                                  className="h-7 text-xs text-gray-400 hover:text-gray-200"\n                                                  onClick={() => {\n                                                    setIsWatchlistNewsLoading(true);\n                                                    const symbol = (window as any).companyInsightsData?.symbol || searchResultsNewsSymbol;\n                                                    if (symbol) {\n                                                      const cleanSymbol = symbol.replace('-EQ', '').replace('-BE', '');\n                                                      fetch(`/api/stock-news/${cleanSymbol}?refresh=${Date.now()}`)\n                                                        .then(res => res.json())\n                                                        .then(data => {\n                                                          const newsItems = Array.isArray(data) ? data : (data.news || []);\n                                                          setWatchlistNews(newsItems.slice(0, 20));\n                                                        })\n                                                        .finally(() => setIsWatchlistNewsLoading(false));\n                                                    }\n                                                  }}\n                                                  data-testid="button-refresh-search-news"\n                                                >\n                                                  <RefreshCw className={`h-3 w-3 mr-1 ${isWatchlistNewsLoading ? 'animate-spin' : ''}`} />\n                                                  Refresh\n                                                </Button>\n                                              </div>\n\n                                              <div className="space-y-3 max-h-[320px] overflow-y-auto mb-4">\n                                                {isWatchlistNewsLoading ? (\n                                                  <div className="flex items-center justify-center py-8">\n                                                    <Loader2 className="h-6 w-6 animate-spin text-gray-400" />\n                                                  </div>\n                                                ) : watchlistNews.length > 0 ? (\n                                                  watchlistNews.map((item, index) => (\n                                                    <div \n                                                      key={index} \n                                                      className="p-3 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition-colors cursor-pointer border border-gray-700"\n                                                      onClick={() => window.open(item.url, '_blank', 'noopener,noreferrer')}\n                                                      data-testid={`search-news-item-${index}`}\n                                                    >\n                                                      <h4 className="text-gray-200 font-medium text-sm mb-2 hover:text-gray-100 transition-colors line-clamp-2">\n                                                        {item.title} <ExternalLink className="h-3 w-3 inline ml-1" />\n                                                      </h4>\n                                                      <p className="text-gray-400 text-xs line-clamp-3">{item.summary}</p>\n                                                    </div>\n                                                  ))\n                                                ) : (\n                                                  <div className="text-center py-8">\n                                                    <p className="text-gray-400 text-sm">No news available</p>\n                                                  </div>\n                                                )}\n                                              </div>\n                                            </div>\n                                          </div>\n                                        );\n                                      }\n\n                                      // Handle Watchlist view\n                                      if (searchResults.includes("[CHART:WATCHLIST]")) {\n                                        const selectedStock = watchlistSymbols.find(s => s.symbol === selectedWatchlistSymbol);\n                                        const cleanSymbolForNews = selectedWatchlistSymbol.replace('-EQ', '').replace('-BE', '');\n\n                                        renderedContent = (\n                                          <div className="flex gap-4 w-full">\n                                            {/* Left Column - Index Charts + Watchlist */}\n                                            <div className="flex-1 space-y-4">\n                                              {/* NIFTY 50 Chart */}\n                                              <div className="bg-gray-900/50 rounded-lg p-3 border border-gray-600">\n                                                <div className="space-y-2">\n                                                  <div className="flex items-center justify-between mb-1">\n                                                    <div className="flex items-center gap-1">\n                                                      <h4 className="text-sm font-semibold text-gray-200">NIFTY 50</h4>\n                                                      <span className="text-xs text-green-400 flex items-center gap-1">\n                                                        <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>\n                                                        Live\n                                                      </span>\n                                                    </div>\n                                                    <div className="text-right">\n                                                      <div className="text-sm font-mono text-gray-100">₹{getNifty50CurrentPrice().toLocaleString('en-IN', { maximumFractionDigits: 2 })}</div>\n                                                      <div className={`text-xs flex items-center justify-end gap-0.5 ${getNifty50Change() >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                                        {getNifty50Change() >= 0 ? '▲' : '▼'} ₹{Math.abs(getNifty50Change()).toFixed(2)} ({((getNifty50Change() / (getNifty50CurrentPrice() - getNifty50Change())) * 100).toFixed(2)}%)\n                                                      </div>\n                                                    </div>\n                                                  </div>\n                                                  <div className="flex items-center gap-1">\n                                                    {['1D', '5D', '1M', '6M', '1Y'].map((tf) => (\n                                                      <Button\n                                                        key={tf}\n                                                        variant="ghost"\n                                                        size="sm"\n                                                        onClick={() => setNifty50Timeframe(tf)}\n                                                        className={`px-1.5 py-0.5 text-xs h-6 ${nifty50Timeframe === tf ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700/50'}`}\n                                                      >\n                                                        {tf}\n                                                      </Button>\n                                                    ))}\n                                                  </div>\n\n                                                  <div className="h-48 w-full bg-gray-800/30 rounded-lg p-2">\n                                                    <ResponsiveContainer width="100%" height="100%">\n                                                      <LineChart data={isNifty50Loading ? [] : nifty50FormattedData} margin={{ top: 5, right: 15, left: 50, bottom: 5 }}>\n                                                        <XAxis \n                                                          dataKey="time" \n                                                          axisLine={false}\n                                                          tickLine={false}\n                                                          tick={{ fontSize: 9, fill: '#64748b' }}\n                                                          tickCount={5}\n                                                        />\n                                                        <YAxis \n                                                          domain={['dataMin - 50', 'dataMax + 50']}\n                                                          type="number"\n                                                          axisLine={false}\n                                                          tickLine={false}\n                                                          tick={{ fontSize: 9, fill: '#64748b' }}\n                                                          width={10}\n                                                        />\n                                                        <Tooltip \n                                                          content={({ active, payload, label }) => {\n                                                            if (!active || !payload || !payload.length) return null;\n                                                            const value = payload[0].value;\n                                                            return (\n                                                              <div style={{\n                                                                backgroundColor: '#1e293b',\n                                                                border: '1px solid #334155',\n                                                                borderRadius: '6px',\n                                                                color: '#e2e8f0',\n                                                                padding: '8px 16px',\n                                                                fontSize: '13px',\n                                                                minWidth: '140px',\n                                                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)',\n                                                                display: 'flex',\n                                                                alignItems: 'center',\n                                                                gap: '12px'\n                                                              }}>\n                                                                <span style={{ fontSize: '13px', fontWeight: '500' }}>\n                                                                  ₹{Number(value).toFixed(2)}\n                                                                </span>\n                                                                <div style={{\n                                                                  width: '1px',\n                                                                  height: '20px',\n                                                                  backgroundColor: '#475569'\n                                                                }}></div>\n                                                                <span style={{ fontSize: '12px', color: '#94a3b8' }}>\n                                                                  {label}\n                                                                </span>\n                                                              </div>\n                                                            );\n                                                          }}\n                                                        />\n                                                        <Line \n                                                          type="linear" \n                                                          dataKey="price" \n                                                          stroke="#ef4444"\n                                                          strokeWidth={2}\n                                                          dot={false}\n                                                          activeDot={{ r: 4, fill: '#ef4444' }}\n                                                        />\n                                                        <ReferenceLine \n                                                          y={getNifty50Baseline()} \n                                                          stroke="#64748b" \n                                                          strokeDasharray="2 2" \n                                                          strokeWidth={1}\n                                                        />\n                                                      </LineChart>\n                                                    </ResponsiveContainer>\n                                                  </div>\n                                                </div>\n                                              </div>\n\n                                              {/* Dynamic Watchlist Chart */}\n                                              <div className="bg-gray-900/50 rounded-lg p-3 border border-gray-600">\n                                                <div className="space-y-2">\n                                                  <div className="flex items-center justify-between mb-1">\n                                                    <div className="flex items-center gap-1">\n                                                      <h4 className="text-sm font-semibold text-gray-200">\n                                                        {watchlistSymbols.find(s => s.symbol === selectedWatchlistSymbol)?.displayName || selectedWatchlistSymbol.replace('-EQ', '').replace('-BE', '')}\n                                                      </h4>\n                                                      <span className="text-xs text-green-400 flex items-center gap-1">\n                                                        <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>\n                                                        Live\n                                                      </span>\n                                                    </div>\n                                                    <div className="text-right">\n                                                      <div className="text-sm font-mono text-gray-100">₹{getNiftyBankCurrentPrice().toLocaleString('en-IN', { maximumFractionDigits: 2 })}</div>\n                                                      <div className={`text-xs flex items-center justify-end gap-0.5 ${getNiftyBankChange() >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                                        {getNiftyBankChange() >= 0 ? '▲' : '▼'} ₹{Math.abs(getNiftyBankChange()).toFixed(2)} ({((getNiftyBankChange() / (getNiftyBankCurrentPrice() - getNiftyBankChange())) * 100).toFixed(2)}%)\n                                                      </div>\n                                                    </div>\n                                                  </div>\n                                                  <div className="flex items-center gap-1">\n                                                    {['1D', '5D', '1M', '6M', '1Y'].map((tf) => (\n                                                      <Button\n                                                        key={tf}\n                                                        variant="ghost"\n                                                        size="sm"\n                                                        onClick={() => setNiftyBankTimeframe(tf)}\n                                                        className={`px-1.5 py-0.5 text-xs h-6 ${niftyBankTimeframe === tf ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-700/50'}`}\n                                                      >\n                                                        {tf}\n                                                      </Button>\n                                                    ))}\n                                                  </div>\n\n                                                  <div className="h-48 w-full bg-gray-800/30 rounded-lg p-2">\n                                                    <ResponsiveContainer width="100%" height="100%">\n                                                      <LineChart data={isNiftyBankLoading ? [] : niftyBankFormattedData} margin={{ top: 5, right: 15, left: 50, bottom: 5 }}>\n                                                        <XAxis \n                                                          dataKey="time" \n                                                          axisLine={false}\n                                                          tickLine={false}\n                                                          tick={{ fontSize: 9, fill: '#64748b' }}\n                                                          tickCount={5}\n                                                        />\n                                                        <YAxis \n                                                          domain={['dataMin - 50', 'dataMax + 50']}\n                                                          type="number"\n                                                          axisLine={false}\n                                                          tickLine={false}\n                                                          tick={{ fontSize: 9, fill: '#64748b' }}\n                                                          width={10}\n                                                        />\n                                                        <Tooltip \n                                                          content={({ active, payload, label }) => {\n                                                            if (!active || !payload || !payload.length) return null;\n                                                            const value = payload[0].value;\n                                                            return (\n                                                              <div style={{\n                                                                backgroundColor: '#1e293b',\n                                                                border: '1px solid #334155',\n                                                                borderRadius: '6px',\n                                                                color: '#e2e8f0',\n                                                                padding: '8px 16px',\n                                                                fontSize: '13px',\n                                                                minWidth: '140px',\n                                                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)',\n                                                                display: 'flex',\n                                                                alignItems: 'center',\n                                                                gap: '12px'\n                                                              }}>\n                                                                <span style={{ fontSize: '13px', fontWeight: '500' }}>\n                                                                  ₹{Number(value).toFixed(2)}\n                                                                </span>\n                                                                <div style={{\n                                                                  width: '1px',\n                                                                  height: '20px',\n                                                                  backgroundColor: '#475569'\n                                                                }}></div>\n                                                                <span style={{ fontSize: '12px', color: '#94a3b8' }}>\n                                                                  {label}\n                                                                </span>\n                                                              </div>\n                                                            );\n                                                          }}\n                                                        />\n                                                        <Line \n                                                          type="linear" \n                                                          dataKey="price" \n                                                          stroke="#10b981"\n                                                          strokeWidth={2}\n                                                          dot={false}\n                                                          activeDot={{ r: 4, fill: '#10b981' }}\n                                                        />\n                                                        <ReferenceLine \n                                                          y={getNiftyBankBaseline()} \n                                                          stroke="#64748b" \n                                                          strokeDasharray="2 2" \n                                                          strokeWidth={1}\n                                                        />\n                                                      </LineChart>\n                                                    </ResponsiveContainer>\n                                                  </div>\n                                                </div>\n                                              </div>\n\n                                              {/* My Watchlist */}\n                                              <div className="bg-gray-900/50 rounded-lg p-3 border border-gray-600">\n                                                <div className="flex items-center justify-between mb-3">\n                                                  <h4 className="text-sm font-medium text-gray-200">My Watchlist</h4>\n                                                  <span className="text-xs text-gray-400">{watchlistSymbols.length} stocks</span>\n                                                </div>\n\n                                                {/* Search to add stocks */}\n                                                <div className="relative mb-3">\n                                                  <Input\n                                                    placeholder="Search to add stock..."\n                                                    value={watchlistSearchQuery}\n                                                    onChange={(e) => {\n                                                      setWatchlistSearchQuery(e.target.value);\n                                                      searchWatchlistStocks(e.target.value);\n                                                    }}\n                                                    className="h-8 text-xs bg-gray-800 border-gray-600 text-gray-200 placeholder:text-gray-500"\n                                                    data-testid="input-watchlist-search"\n                                                  />\n                                                  {watchlistSearchResults.length > 0 && (\n                                                    <div className="absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded-lg z-50 max-h-40 overflow-y-auto">\n                                                      {watchlistSearchResults.map((result, idx) => (\n                                                        <div\n                                                          key={idx}\n                                                          className="px-3 py-2 border-b border-gray-700 last:border-b-0 flex items-center justify-between hover:bg-gray-700/50 transition-colors"\n                                                          data-testid={`watchlist-search-result-${idx}`}\n                                                        >\n                                                          <div className="flex-1 min-w-0">\n                                                            <div className="text-xs font-medium text-gray-200">{result.displayName || result.symbol}</div>\n                                                            <div className="text-xs text-gray-400 truncate">{result.name}</div>\n                                                          </div>\n                                                          <button\n                                                            onClick={() => {\n                                                              addToWatchlist(result);\n                                                              setWatchlistSearchQuery('');\n                                                            }}\n                                                            className="ml-2 flex-shrink-0 text-gray-400 hover:text-green-400 transition-colors p-1"\n                                                            data-testid={`button-add-watchlist-${idx}`}\n                                                          >\n                                                            <Plus className="h-4 w-4" />\n                                                          </button>\n                                                        </div>\n                                                      ))}\n                                                    </div>\n                                                  )}\n                                                </div>\n\n                                                {/* Watchlist Items */}\n                                                <div className="space-y-1 max-h-48 overflow-y-auto">\n                                                  {watchlistSymbols.map((stock, idx) => (\n                                                    <div\n                                                      key={stock.symbol}\n                                                      className={`flex items-center justify-between px-2 py-2 rounded-lg cursor-pointer transition-colors ${\n                                                        selectedWatchlistSymbol === stock.symbol \n                                                          ? 'bg-blue-600/30 border border-blue-500/50' \n                                                          : 'hover:bg-gray-700/50'\n                                                      }`}\n                                                      onClick={() => setSelectedWatchlistSymbol(stock.symbol)}\n                                                      data-testid={`watchlist-item-${idx}`}\n                                                    >\n                                                      <div className="flex items-center gap-2">\n                                                        <div className={`w-2 h-2 rounded-full ${\n                                                          selectedWatchlistSymbol === stock.symbol ? 'bg-blue-400' : 'bg-gray-500'\n                                                        }`} />\n                                                        <div>\n                                                          <div className="text-xs font-medium text-gray-200">{stock.displayName || stock.symbol.replace('-EQ', '')}</div>\n                                                          <div className="text-xs text-gray-500 truncate max-w-[150px]">{stock.name}</div>\n                                                        </div>\n                                                      </div>\n                                                      <button\n                                                        onClick={(e) => {\n                                                          e.stopPropagation();\n                                                          removeFromWatchlist(stock.symbol);\n                                                        }}\n                                                        className="text-gray-500 hover:text-red-400 transition-colors p-1"\n                                                        data-testid={`button-remove-watchlist-${idx}`}\n                                                      >\n                                                        <X className="h-3 w-3" />\n                                                      </button>\n                                                    </div>\n                                                  ))}\n                                                </div>\n                                              </div>\n                                            </div>\n\n                                            {/* Right Column - Related News */}\n                                            <div className="flex-1 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                              <div className="flex items-center justify-between mb-4">\n                                                <div className="flex items-center gap-2">\n                                                  <Clock className="h-4 w-4 text-gray-400" />\n                                                  <h3 className="text-sm font-medium text-gray-200">\n                                                    Related News for {cleanSymbolForNews}\n                                                  </h3>\n                                                </div>\n                                                <Button\n                                                  variant="ghost"\n                                                  size="sm"\n                                                  className="h-7 text-xs text-gray-400 hover:text-gray-200"\n                                                  onClick={() => {\n                                                    setIsWatchlistNewsLoading(true);\n                                                    fetch(`/api/stock-news/${cleanSymbolForNews}?refresh=${Date.now()}`)\n                                                      .then(res => res.json())\n                                                      .then(data => {\n                                                        const newsItems = Array.isArray(data) ? data : (data.news || []);\n                                                        setWatchlistNews(newsItems.slice(0, 20));\n                                                      })\n                                                      .finally(() => setIsWatchlistNewsLoading(false));\n                                                  }}\n                                                  data-testid="button-refresh-news"\n                                                >\n                                                  <RefreshCw className={`h-3 w-3 mr-1 ${isWatchlistNewsLoading ? 'animate-spin' : ''}`} />\n                                                  Refresh\n                                                </Button>\n                                              </div>\n\n                                              <div className="space-y-3 max-h-[320px] overflow-y-auto mb-4">\n                                                {isWatchlistNewsLoading ? (\n                                                  <div className="flex items-center justify-center py-8">\n                                                    <Loader2 className="h-6 w-6 animate-spin text-gray-400" />\n                                                  </div>\n                                                ) : watchlistNews.length > 0 ? (\n                                                  watchlistNews.map((item, index) => (\n                                                    <div \n                                                      key={index} \n                                                      className="p-3 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition-colors cursor-pointer border border-gray-700"\n                                                      onClick={() => window.open(item.url, '_blank', 'noopener,noreferrer')}\n                                                      data-testid={`news-item-${index}`}\n                                                    >\n                                                      <h4 className="text-gray-200 font-medium text-sm mb-2 hover:text-gray-100 transition-colors line-clamp-2">\n                                                        {item.title} <ExternalLink className="h-3 w-3 inline ml-1" />\n                                                      </h4>\n                                                      {item.description && (\n                                                        <p className="text-gray-400 text-xs mb-2 line-clamp-2">{item.description}</p>\n                                                      )}\n                                                      <div className="flex items-center justify-between">\n                                                        <span className="text-gray-500 text-xs">{item.source}</span>\n                                                        <span className="text-gray-500 text-xs">{getWatchlistNewsRelativeTime(item.publishedAt)}</span>\n                                                      </div>\n                                                    </div>\n                                                  ))\n                                                ) : (\n                                                  <div className="text-center py-8 text-gray-500">\n                                                    <Newspaper className="h-8 w-8 mx-auto mb-2 opacity-50" />\n                                                    <p className="text-sm">No news available for {cleanSymbolForNews}</p>\n                                                    <p className="text-xs mt-1">Select a stock from the watchlist</p>\n                                                  </div>\n                                                )}\n                                              </div>\n\n                                              {/* Quarterly Results for Selected Stock Only */}\n                                              <div className="border-t border-gray-700 pt-4">\n                                                <div className="flex items-center justify-between mb-3">\n                                                  <div className="flex items-center gap-2">\n                                                    <TrendingUp className="h-4 w-4 text-gray-400" />\n                                                    <h3 className="text-sm font-medium text-gray-200">\n                                                      Quarterly Performance Trend <span className="text-xs text-gray-500 ml-1">(Net profit)</span>\n                                                    </h3>\n                                                  </div>\n                                                  <div className="flex items-center gap-2">\n                                                    {searchResultsNewsSymbol && (\n                                                      <Button\n                                                        variant="ghost"\n                                                        size="sm"\n                                                        onClick={async () => {\n                                                          setIsWatchlistQuarterlyLoading(true);\n                                                          try {\n                                                            const cleanSymbol = searchResultsNewsSymbol.replace("-EQ", "").replace("-BE", "");\n                                                            const response = await fetch(`/api/quarterly-results/${cleanSymbol}`);\n                                                            if (response.ok) {\n                                                              const data = await response.json();\n                                                              setAllWatchlistQuarterlyData(prev => ({\n                                                                ...prev,\n                                                                [searchResultsNewsSymbol]: data.results || []\n                                                              }));\n                                                            }\n                                                          } catch (error) {\n                                                            console.error("Error refreshing quarterly data:", error);\n                                                          } finally {\n                                                            setIsWatchlistQuarterlyLoading(false);\n                                                          }\n                                                        }}\n                                                        data-testid="button-refresh-quarterly"\n                                                        className="h-7 px-2"\n                                                      >\n                                                        <RefreshCw className={`h-3 w-3 ${isWatchlistQuarterlyLoading ? "animate-spin" : ""}`} />\n                                                      </Button>\n                                                    )}\n                                                    {(() => {\n                                                      if (!searchResultsNewsSymbol) return null;\n                                                      const quarterlyData = allWatchlistQuarterlyData[searchResultsNewsSymbol] || [];\n                                                      const hasTrendingUp = quarterlyData.length > 1 && \n                                                        parseFloat(quarterlyData[quarterlyData.length - 1]?.change_percent || '0') >= 0;\n                                                      return (\n                                                        <span className={`text-xs px-2 py-1 rounded ${hasTrendingUp ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>\n                                                          {hasTrendingUp ? '↑ Uptrend' : '↓ Downtrend'}\n                                                        </span>\n                                                      );\n                                                    })()}\n                                                  </div>\n                                                </div>\n\n                                                <div className="space-y-1">\n                                                  {isWatchlistQuarterlyLoading ? (\n                                                    <div className="flex items-center justify-center py-8">\n                                                      <Loader2 className="h-5 w-5 animate-spin text-gray-400" />\n                                                    </div>\n                                                  ) : searchResultsNewsSymbol ? (() => {\n                                                    const quarterlyData = allWatchlistQuarterlyData[searchResultsNewsSymbol] || [];\n                                                    // Don't show loading state if we have data\n                                                    // The isWatchlistQuarterlyLoading at the top already handles the loading indicator\n                                                    if (!quarterlyData || quarterlyData.length === 0) {\n                                                      // Check if still loading, otherwise show no data message\n                                                      if (isWatchlistQuarterlyLoading) {\n                                                        return (\n                                                          <div className="text-center py-8 text-gray-500">\n                                                            <Loader2 className="h-5 w-5 animate-spin text-gray-400 mx-auto mb-2" />\n                                                            <p className="text-xs">Loading quarterly results...</p>\n                                                          </div>\n                                                        );\n                                                      }\n                                                      return (\n                                                        <div className="text-center py-4 text-gray-500 text-xs">\n                                                          No quarterly data available\n                                                        </div>\n                                                      );\n                                                    }\n                                                    const hasTrendingUp = quarterlyData.length > 1 && \n                                                      parseFloat(quarterlyData[quarterlyData.length - 1]?.change_percent || '0') >= 0;\n\n                                                    const chartData = quarterlyData.map((q: any) => ({\n                                                      quarter: q.quarter,\n                                                      value: parseFloat(q.revenue.replace(/,/g, '')) || 0,\n                                                      changePercent: parseFloat(q.change_percent) || 0\n                                                    }));\n\n                                                    const trendColor = hasTrendingUp ? '#22c55e' : '#ef4444';\n\n                                                    return quarterlyData.length > 0 ? (\n                                                      <>\n                                                        <div className="h-40 w-full mb-3">\n                                                          <ResponsiveContainer width="100%" height="100%">\n                                                            <AreaChart data={chartData} margin={{ top: 10, right: 10, left: 10, bottom: 20 }}>\n                                                              <defs>\n                                                                <linearGradient id={`grad-${searchResultsNewsSymbol}`} x1="0" y1="0" x2="0" y2="1">\n                                                                  <stop offset="0%" stopColor={trendColor} stopOpacity={0.4} />\n                                                                  <stop offset="100%" stopColor={trendColor} stopOpacity={0.05} />\n                                                                </linearGradient>\n                                                              </defs>\n                                                              <XAxis dataKey="quarter" tick={{ fontSize: 11, fill: '#9ca3af' }} axisLine={false} tickLine={false} />\n                                                              <YAxis tick={{ fontSize: 10, fill: '#6b7280' }} tickFormatter={(value) => `₹${(value / 1000).toFixed(0)}K Cr`} axisLine={false} tickLine={false} />\n                                                              <Tooltip \n                                                                contentStyle={{ background: '#1f2937', border: '1px solid #374151', borderRadius: '6px', fontSize: '11px' }}\n                                                                formatter={(value: any, name: any, props: any) => [`₹${Number(value).toLocaleString()} Cr`, 'Revenue']}\n                                                              />\n                                                              <Area \n                                                                type="monotone" \n                                                                dataKey="value" \n                                                                stroke={trendColor} \n                                                                strokeWidth={2} \n                                                                fill={`url(#grad-${searchResultsNewsSymbol})`}\n                                                                dot={{ r: 5, stroke: trendColor, strokeWidth: 2, fill: '#1f2937' }}\n                                                                activeDot={{ r: 7, stroke: trendColor, strokeWidth: 2, fill: '#ffffff' }}\n                                                              />\n                                                            </AreaChart>\n                                                          </ResponsiveContainer>\n                                                        </div>\n                                                        <div className="flex justify-center gap-4 text-xs text-gray-400">\n                                                          <span className="flex items-center gap-1">\n                                                            <span className="w-2 h-2 rounded-full bg-green-500"></span> Positive Quarter\n                                                          </span>\n                                                          <span className="flex items-center gap-1">\n                                                            <span className="w-2 h-2 rounded-full bg-red-500"></span> Negative Quarter\n                                                          </span>\n                                                        </div>\n                                                        {/* PDF Links for Deep Analysis */}\n                                                        {quarterlyData.some((q: any) => q.pdf_url) && (\n                                                          <div className="mt-3 pt-3 border-t border-gray-700">\n                                                            <div className="flex items-center justify-between mb-2">\n                                                              <span className="text-xs font-medium text-gray-400">Quarterly Results PDFs</span>\n                                                              <button\n                                                                onClick={() => {\n                                                                  const symbol = searchResultsNewsSymbol || selectedWatchlistSymbol;\n                                                                  if (symbol) {\n                                                                    // Simply set the query which triggers the existing search handler\n                                                                    handleSearch(symbol);\n                                                                  }\n                                                                }}\n                                                                className="text-xs text-blue-400 hover:text-blue-300 cursor-pointer"\n                                                                data-testid="button-ai-full-report"\n                                                              >\n                                                                View Full Report\n                                                              </button>\n                                                            </div>\n                                                            <div className="flex flex-wrap gap-2">\n                                                              {quarterlyData.slice(-4).map((q: any, idx: number) => \n                                                                q.pdf_url && (\n                                                                  <a\n                                                                    key={idx}\n                                                                    href={q.pdf_url}\n                                                                    target="_blank"\n                                                                    rel="noopener noreferrer"\n                                                                    className="flex items-center gap-1 px-2 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs text-gray-300"\n                                                                    data-testid={`link-pdf-${idx}`}\n                                                                  >\n                                                                    <FileText className="h-3 w-3" />\n                                                                    {q.quarter}\n                                                                  </a>\n                                                                )\n                                                              )}\n                                                            </div>\n                                                          </div>\n                                                        )}\n                                                      </>\n                                                    ) : (\n                                                      <div className="text-center py-4 text-gray-500 text-xs">\n                                                        No quarterly data available\n                                                      </div>\n                                                    );\n                                                  })() : (\n                                                    <div className="text-center py-8 text-gray-500">\n                                                      <TrendingUp className="h-6 w-6 mx-auto mb-2 opacity-50" />\n                                                      <p className="text-xs">Search for a stock to see quarterly results</p>\n                                                    </div>\n                                                  )}\n                                                </div>\n                                              </div>\n                                            </div>\n                                          </div>\n                                        );\n\n                                        return renderedContent;\n                                      }\n\n                                      // Render text with inline charts\n                                      if (\n                                        processedResults.includes(\n                                          "[CHART:PERFORMANCE_TREND]",\n                                        )\n                                      ) {\n                                        const parts = processedResults.split(\n                                          "[CHART:PERFORMANCE_TREND]",\n                                        );\n                                        const chartData =\n                                          (window as any)\n                                            .performanceTrendChartData || [];\n\n                                        processedResults = parts[1] || "";\n\n                                        const performanceContent = (\n                                          <>\n                                            {parts[0]}\n                                            {chartData.length > 0 && (\n                                              <div className="my-4 bg-gray-900/50 rounded-lg p-3 border border-gray-600">\n                                                <div className="h-32 w-full">\n                                                  <ResponsiveContainer\n                                                    width="100%"\n                                                    height="100%"\n                                                  >\n                                                    <AreaChart\n                                                      data={chartData}\n                                                      margin={{\n                                                        top: 20,\n                                                        right: 20,\n                                                        left: 10,\n                                                        bottom: 5,\n                                                      }}\n                                                    >\n                                                      <defs>\n                                                        <linearGradient\n                                                          id="aiAreaGradient"\n                                                          x1="0"\n                                                          y1="0"\n                                                          x2="0"\n                                                          y2="1"\n                                                        >\n                                                          <stop\n                                                            offset="0%"\n                                                            stopColor="rgb(107, 114, 128)"\n                                                            stopOpacity={0.6}\n                                                          />\n                                                          <stop\n                                                            offset="100%"\n                                                            stopColor="rgb(107, 114, 128)"\n                                                            stopOpacity={0.1}\n                                                          />\n                                                        </linearGradient>\n                                                      </defs>\n                                                      <XAxis\n                                                        dataKey="day"\n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={false}\n                                                        className="text-slate-500 dark:text-slate-400"\n                                                      />\n                                                      <YAxis\n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={{\n                                                          fontSize: 10,\n                                                          fill: "#64748b",\n                                                        }}\n                                                        tickFormatter={(\n                                                          value,\n                                                        ) =>\n                                                          `${\n                                                            value >= 0\n                                                              ? ""\n                                                              : "-"\n                                                          }${(\n                                                            Math.abs(value) /\n                                                            1000\n                                                          ).toFixed(0)}K`\n                                                        }\n                                                        domain={[\n                                                          "dataMin - 1000",\n                                                          "dataMax + 1000",\n                                                        ]}\n                                                        className="text-slate-500 dark:text-slate-400"\n                                                      />\n                                                      <Tooltip\n                                                        contentStyle={{\n                                                          background:\n                                                            "var(--background)",\n                                                          border:\n                                                            "1px solid var(--border)",\n                                                          borderRadius: "8px",\n                                                          color:\n                                                            "var(--foreground)",\n                                                          fontSize: "11px",\n                                                          padding: "6px 10px",\n                                                        }}\n                                                        formatter={(\n                                                          value: any,\n                                                        ) => [\n                                                          `${\n                                                            value >= 0\n                                                              ? "₹"\n                                                              : "-₹"\n                                                          }${Math.abs(\n                                                            value,\n                                                          ).toLocaleString()}`,\n                                                          "Daily P&L",\n                                                        ]}\n                                                        labelFormatter={(\n                                                          label,\n                                                        ) => `${label}`}\n                                                      />\n                                                      <Area\n                                                        type="monotone"\n                                                        dataKey="value"\n                                                        stroke="#000000"\n                                                        strokeWidth={2}\n                                                        fill="url(#aiAreaGradient)"\n                                                        dot={false}\n                                                        activeDot={{\n                                                          r: 4,\n                                                          stroke: "#000000",\n                                                          strokeWidth: 1,\n                                                          fill: "#ffffff",\n                                                        }}\n                                                      />\n                                                    </AreaChart>\n                                                  </ResponsiveContainer>\n                                                </div>\n                                              </div>\n                                            )}\n                                          </>\n                                        );\n\n                                        renderedContent = renderedContent ? \n                                          <>{renderedContent}{performanceContent}</> : \n                                          performanceContent;\n                                      }\n\n                                      // Company Insights Chart with quarterly performance trend\n                                      if (\n                                        processedResults.includes(\n                                          "[CHART:COMPANY_INSIGHTS]",\n                                        )\n                                      ) {\n                                        const parts = processedResults.split(\n                                          "[CHART:COMPANY_INSIGHTS]",\n                                        );\n                                        const companyInsights =\n                                          (window as any).companyInsightsData || null;\n\n                                        // Use structured data from API response - show ACTUAL revenue values\n                                        const chartData: Array<{quarter: string; value: number; revenue: number; trend: string; changePercent: number}> = [];\n\n                                        if (companyInsights && companyInsights.quarterlyPerformance) {\n                                          companyInsights.quarterlyPerformance.forEach((q: any) => {\n                                            // Use actual revenue value from scraped data\n                                            const actualRevenue = q.value || q.revenue || 0;\n                                            chartData.push({\n                                              quarter: q.quarter,\n                                              value: actualRevenue, // Actual revenue in Crores\n                                              revenue: actualRevenue,\n                                              trend: q.changePercent >= 0 ? 'positive' : 'negative',\n                                              changePercent: q.changePercent || 0\n                                            });\n                                          });\n                                        }\n\n                                        // Use trend from structured data or calculate from chart\n                                        const overallTrend = companyInsights?.trend || \n                                          (chartData.length > 1 \n                                            ? chartData[chartData.length - 1].value > chartData[0].value \n                                              ? 'positive' \n                                              : 'negative'\n                                            : 'neutral');\n\n                                        const trendColor = overallTrend === 'positive' ? '#22c55e' : overallTrend === 'negative' ? '#ef4444' : '#6b7280';\n\n                                        const companyInsightsContent = (\n                                          <>\n                                            {parts[0]}\n                                            {chartData.length > 0 && (\n                                              <div className="my-4 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                                <div className="flex items-center justify-between mb-3">\n                                                  <span className="text-sm font-medium text-gray-300">Quarterly Performance Trend</span>\n                                                  <span className={`text-xs px-2 py-1 rounded ${overallTrend === 'positive' ? 'bg-green-500/20 text-green-400' : overallTrend === 'negative' ? 'bg-red-500/20 text-red-400' : 'bg-gray-500/20 text-gray-400'}`}>\n                                                    {overallTrend === 'positive' ? '↑ Uptrend' : overallTrend === 'negative' ? '↓ Downtrend' : '→ Neutral'}\n                                                  </span>\n                                                </div>\n                                                <div className="h-40 w-full">\n                                                  <ResponsiveContainer\n                                                    width="100%"\n                                                    height="100%"\n                                                  >\n                                                    <AreaChart\n                                                      data={chartData}\n                                                      margin={{\n                                                        top: 10,\n                                                        right: 10,\n                                                        left: 10,\n                                                        bottom: 20,\n                                                      }}\n                                                    >\n                                                      <defs>\n                                                        <linearGradient\n                                                          id="companyInsightsGradient"\n                                                          x1="0"\n                                                          y1="0"\n                                                          x2="0"\n                                                          y2="1"\n                                                        >\n                                                          <stop\n                                                            offset="0%"\n                                                            stopColor={trendColor}\n                                                            stopOpacity={0.4}\n                                                          />\n                                                          <stop\n                                                            offset="100%"\n                                                            stopColor={trendColor}\n                                                            stopOpacity={0.05}\n                                                          />\n                                                        </linearGradient>\n                                                      </defs>\n                                                      <XAxis\n                                                        dataKey="quarter"\n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={{\n                                                          fontSize: 11,\n                                                          fill: "#9ca3af",\n                                                        }}\n                                                      />\n                                                      <YAxis\n                                                        axisLine={false}\n                                                        tickLine={false}\n                                                        tick={{\n                                                          fontSize: 10,\n                                                          fill: "#6b7280",\n                                                        }}\n                                                        tickFormatter={(value) => `₹${(value / 1000).toFixed(0)}K Cr`}\n                                                        domain={['dataMin - 1000', 'dataMax + 1000']}\n                                                      />\n                                                      <Tooltip\n                                                        contentStyle={{\n                                                          background: "#1f2937",\n                                                          border: "1px solid #374151",\n                                                          borderRadius: "8px",\n                                                          color: "#f3f4f6",\n                                                          fontSize: "12px",\n                                                          padding: "8px 12px",\n                                                        }}\n                                                        formatter={(value: any, name: any, props: any) => [\n                                                          `₹${Number(value).toLocaleString()} Cr (${props.payload.changePercent >= 0 ? '+' : ''}${props.payload.changePercent.toFixed(2)}%)`,\n                                                          "Revenue"\n                                                        ]}\n                                                        labelFormatter={(label) => `${label}`}\n                                                      />\n                                                      <Area\n                                                        type="monotone"\n                                                        dataKey="value"\n                                                        stroke={trendColor}\n                                                        strokeWidth={2}\n                                                        fill="url(#companyInsightsGradient)"\n                                                        dot={{\n                                                          r: 4,\n                                                          stroke: trendColor,\n                                                          strokeWidth: 2,\n                                                          fill: "#1f2937",\n                                                        }}\n                                                        activeDot={{\n                                                          r: 6,\n                                                          stroke: trendColor,\n                                                          strokeWidth: 2,\n                                                          fill: "#ffffff",\n                                                        }}\n                                                      />\n                                                    </AreaChart>\n                                                  </ResponsiveContainer>\n                                                </div>\n                                                <div className="flex justify-center gap-4 mt-2 text-xs text-gray-400">\n                                                  <span className="flex items-center gap-1">\n                                                    <span className="w-2 h-2 rounded-full bg-green-500"></span> Positive Quarter\n                                                  </span>\n                                                  <span className="flex items-center gap-1">\n                                                    <span className="w-2 h-2 rounded-full bg-red-500"></span> Negative Quarter\n                                                  </span>\n                                                </div>\n                                              </div>\n                                            )}\n\n                                            {/* Profit & Loss Statement Table */}\n                                            {companyInsights?.annualFinancials?.profitLoss && companyInsights.annualFinancials.profitLoss.length > 0 && (\n                                              <div className="my-4 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                                <div className="flex items-center justify-between mb-3">\n                                                  <span className="text-sm font-medium text-gray-300">Profit & Loss Statement (in Cr)</span>\n                                                  <span className="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400">\n                                                    Annual Data\n                                                  </span>\n                                                </div>\n                                                <div className="overflow-x-auto">\n                                                  <table className="w-full text-sm">\n                                                    <thead>\n                                                      <tr className="border-b border-gray-200 dark:border-gray-700">\n                                                        <th className="text-left py-2 px-2 text-gray-400 font-medium">Particulars</th>\n                                                        {companyInsights.annualFinancials.years.slice(0, 5).map((year: string) => (\n                                                          <th key={year} className="text-right py-2 px-2 text-gray-400 font-medium">{year}</th>\n                                                        ))}\n                                                      </tr>\n                                                    </thead>\n                                                    <tbody>\n                                                      {companyInsights.annualFinancials.profitLoss.map((row: any, idx: number) => (\n                                                        <tr key={idx} className={`border-b border-gray-800 ${row.label.toLowerCase().includes('net profit') || row.label.toLowerCase().includes('eps') ? 'bg-gray-800/30 font-medium' : ''}`}>\n                                                          <td className="py-2 px-2 text-gray-300">{row.label}</td>\n                                                          {row.values.slice(0, 5).map((v: any, vIdx: number) => {\n                                                            const numVal = typeof v.value === 'string' ? parseFloat(v.value.replace(/,/g, '')) : Number(v.value);\n                                                            const displayVal = isNaN(numVal) ? v.value : numVal.toLocaleString();\n                                                            return (\n                                                              <td key={vIdx} className={`text-right py-2 px-2 ${numVal >= 0 ? 'text-gray-200' : 'text-red-400'}`}>\n                                                                {displayVal}\n                                                              </td>\n                                                            );\n                                                          })}\n                                                        </tr>\n                                                      ))}\n                                                    </tbody>\n                                                  </table>\n                                                </div>\n                                              </div>\n                                            )}\n\n                                            {/* Balance Sheet Table */}\n                                            {companyInsights?.annualFinancials?.balanceSheet && companyInsights.annualFinancials.balanceSheet.length > 0 && (\n                                              <div className="my-4 bg-gray-900/50 rounded-lg p-4 border border-gray-600">\n                                                <div className="flex items-center justify-between mb-3">\n                                                  <span className="text-sm font-medium text-gray-300">Balance Sheet (in Cr)</span>\n                                                  <span className="text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-400">\n                                                    Annual Data\n                                                  </span>\n                                                </div>\n                                                <div className="overflow-x-auto">\n                                                  <table className="w-full text-sm">\n                                                    <thead>\n                                                      <tr className="border-b border-gray-700">\n                                                        <th className="text-left py-2 px-2 text-gray-400 font-medium">Particulars</th>\n                                                        {companyInsights.annualFinancials.years.slice(0, 5).map((year: string) => (\n                                                          <th key={year} className="text-right py-2 px-2 text-gray-400 font-medium">{year}</th>\n                                                        ))}\n                                                      </tr>\n                                                    </thead>\n                                                    <tbody>\n                                                      {companyInsights.annualFinancials.balanceSheet.map((row: any, idx: number) => (\n                                                        <tr key={idx} className={`border-b border-gray-800 ${row.label.toLowerCase().includes('total assets') || row.label.toLowerCase().includes('total liabilities') ? 'bg-gray-800/30 font-medium' : ''}`}>\n                                                          <td className="py-2 px-2 text-gray-300">{row.label}</td>\n                                                          {row.values.slice(0, 5).map((v: any, vIdx: number) => {\n                                                            const numVal = typeof v.value === 'string' ? parseFloat(v.value.replace(/,/g, '')) : Number(v.value);\n                                                            const displayVal = isNaN(numVal) ? v.value : numVal.toLocaleString();\n                                                            return (\n                                                              <td key={vIdx} className={`text-right py-2 px-2 ${numVal >= 0 ? 'text-gray-200' : 'text-red-400'}`}>\n                                                                {displayVal}\n                                                              </td>\n                                                            );\n                                                          })}\n                                                        </tr>\n                                                      ))}\n                                                    </tbody>\n                                                  </table>\n                                                </div>\n                                              </div>\n                                            )}\n                                            {parts[1] || ""}\n                                          </>\n                                        );\n\n                                        renderedContent = renderedContent ? \n                                          <>{renderedContent}{companyInsightsContent}</> : \n                                          companyInsightsContent;\n                                      }\n                      // Handle Trading Challenge Coming Soon\n                      if (searchResults.includes("[CHART:TRADE]")) {\n                        renderedContent = (\n                          <div className="w-full bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-xl p-8 border border-gray-700">\n                            <div className="flex flex-col items-center justify-center mb-8">\n                              <div className="w-24 h-24 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center mb-6 shadow-lg">\n                                <Trophy className="w-12 h-12 text-white" />\n                              </div>\n                              <h2 className="text-4xl font-bold text-white mb-2">Trading Challenge</h2>\n                              <p className="text-xl text-gray-400">Coming Soon</p>\n                            </div>\n                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">\n                              <div className="bg-gradient-to-br from-blue-900/30 to-blue-800/20 border border-blue-700/50 rounded-lg p-6 hover:border-blue-600/70 transition-all">\n                                <div className="flex items-center gap-3 mb-3">\n                                  <div className="w-10 h-10 rounded-lg bg-blue-600/30 flex items-center justify-center">\n                                    <Users className="w-5 h-5 text-blue-400" />\n                                  </div>\n                                  <h3 className="text-lg font-semibold text-white">Compete with Traders</h3>\n                                </div>\n                                <p className="text-gray-300 text-sm">Join 7-day trading challenges and test your skills against other traders</p>\n                              </div>\n                              <div className="bg-gradient-to-br from-green-900/30 to-green-800/20 border border-green-700/50 rounded-lg p-6 hover:border-green-600/70 transition-all">\n                                <div className="flex items-center gap-3 mb-3">\n                                  <div className="w-10 h-10 rounded-lg bg-green-600/30 flex items-center justify-center">\n                                    <BarChart3 className="w-5 h-5 text-green-400" />\n                                  </div>\n                                  <h3 className="text-lg font-semibold text-white">Live P&L Tracking</h3>\n                                </div>\n                                <p className="text-gray-300 text-sm">Real-time ranking based on your trades with live profit and loss updates</p>\n                              </div>\n                              <div className="bg-gradient-to-br from-yellow-900/30 to-yellow-800/20 border border-yellow-700/50 rounded-lg p-6 hover:border-yellow-600/70 transition-all">\n                                <div className="flex items-center gap-3 mb-3">\n                                  <div className="w-10 h-10 rounded-lg bg-yellow-600/30 flex items-center justify-center">\n                                    <Award className="w-5 h-5 text-yellow-400" />\n                                  </div>\n                                  <h3 className="text-lg font-semibold text-white">Leaderboard Rankings</h3>\n                                </div>\n                                <p className="text-gray-300 text-sm">See your position among all participants and track your progress</p>\n                              </div>\n                            </div>\n                            <div className="mt-8 text-center">\n                              <p className="text-gray-400 text-sm">More features coming soon. Stay tuned!</p>\n                            </div>\n                          </div>\n                        );\n                      }\n\n\n\n                                      return renderedContent || processedResults || searchResults;\n                                    })()}\n\n\n                                  </div>\n                                  {/* Disclaimer */}\n                                  <div className="mt-4 pt-3 border-t border-gray-700">\n                                    <p className="text-xs text-gray-500 italic">\n                                      Disclaimer: Financial data is sourced from NSE/BSE and other public sources. \n                                      This information is for educational purposes only and should not be considered \n                                      financial advice. Please verify data independently before making investment decisions.\n                                    </p>\n                                  </div>\n                                </div>\n                                <div className="flex items-center gap-0 pt-0 border-t border-gray-700">\n                                  <Button\n                                    variant="ghost"\n                                    size="sm"\n                                    onClick={() => {\n                                      setSearchQuery("");\n                                      setIsSearchActive(false);\n                                      setSearchResults("");\n                                    }}\n                                    className="text-gray-400 hover:text-gray-200"\n                                  >\n                                    <X className="h-4 w-4 mr-2" />\n                                    Clear\n                                  </Button>\n                                </div>\n                              </div>\n                            ) : searchQuery && !isSearchLoading ? (\n                              <div className="text-center text-gray-400 py-8">\n                                <Bot className="h-12 w-12 mx-auto mb-4 opacity-50" />\n                                <p>\n                                  Press Enter or click the search button to get\n                                  AI assistance\n                                </p>\n                              </div>\n                            ) : isSearchLoading ? (\n                              <div className="text-center py-8">\n                                <style>{`\n                                  @keyframes thinkingDot {\n                                    0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }\n                                    30% { opacity: 1; transform: translateY(-8px); }\n                                  }\n                                  .thinking-dot {\n                                    display: inline-block;\n                                    width: 8px;\n                                    height: 8px;\n                                    border-radius: 50%;\n                                    background-color: #3b82f6;\n                                    animation: thinkingDot 1.4s infinite;\n                                    margin: 0 3px;\n                                  }\n                                  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }\n                                  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }\n                                `}</style>\n                                <div className="flex items-center justify-center">\n                                  <div className="thinking-dot"></div>\n                                  <div className="thinking-dot"></div>\n                                  <div className="thinking-dot"></div>\n                                </div>\n                              </div>\n                            ) : null}\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Enhanced AI Suggestion Buttons - Desktop only */}\n                      <div className="md:flex hidden flex-wrap items-center justify-center gap-3 max-w-6xl mx-auto md:mt-6">\n                        {/* <Button\n                        variant="secondary"\n                        className="bg-blue-600 hover:bg-blue-700 text-white border-0 h-11 px-4 rounded-full font-medium transition-all duration-200"\n                        onClick={() =>\n                          handleSuggestionClick(\n                            "Get live stock prices and fundamentals for NIFTY, SENSEX, and top Indian stocks"\n                          )\n                        }\n                      >\n                        <div className="flex items-center gap-2">\n                          <DollarSign className="h-4 w-4" />\n                          <span>Stock Prices</span>\n                        </div>\n                      </Button> */}\n\n                        <Button\n                          variant="secondary"\n                          className="bg-cyan-600 hover:bg-cyan-700  text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200"\n                          onClick={() => {\n                            setIsWatchlistLoading(true);\n                            setIsSearchActive(true);\n                            setSearchResults("[CHART:WATCHLIST]");\n                            setIsWatchlistOpen(true);\n                            // Auto-select first stock in watchlist and fetch its quarterly data\n                            if (watchlistSymbols.length > 0 && !selectedWatchlistSymbol) {\n                              const firstStock = watchlistSymbols[0];\n                              setSelectedWatchlistSymbol(firstStock.symbol);\n                              setSearchResultsNewsSymbol(firstStock.symbol);\n                            }\n                            setTimeout(() => setIsWatchlistLoading(false), 300);\n                          }}\n                          data-testid="button-watchlist"\n                        >\n                          <div className="flex items-center justify-center gap-1">\n                            {isWatchlistLoading ? (\n                              <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                            ) : (\n                              <Eye className="h-3 w-3" />\n                            )}\n                            <span>Watchlist</span>\n                          </div>\n                        </Button>\n\n                        <Button\n                          variant="secondary"\n                          className="bg-green-600 hover:bg-green-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200"\n                          onClick={() =>\n                            handleSuggestionClick(\n                              "What are today's top financial news and market updates?",\n                            )\n                          }\n                        >\n                          <div className="flex items-center gap-2">\n                            <Newspaper className="h-3 w-3" />\n                            <span>Market News</span>\n                          </div>\n                        </Button>\n\n                        <Button\n                          variant="secondary"\n                          className="bg-pink-600 hover:bg-pink-700  text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200"\n                          onClick={() =>\n                            handleSuggestionClick(\n                              "Social feed community discussions and trending topics",\n                            )\n                          }\n                        >\n                          <div className="flex items-center gap-2">\n                            <User className="h-3 w-3" />\n                            <span>Social Feed</span>\n                          </div>\n                        </Button>\n\n                        <Button\n                          variant="secondary"\n                          className="bg-indigo-600 hover:bg-indigo-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200"\n                          onClick={generateJournalAIReport}\n                          data-testid="button-trading-journal"\n                        >\n                          <div className="flex items-center gap-2">\n                            <FileText className="h-3 w-3" />\n                            <span>Trading Journal</span>\n                          </div>\n                        </Button>\n\n                        <Button\n                          variant="secondary"\n                          className="bg-red-600 hover:bg-red-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200"\n                          onClick={() => {\n                            setIsSearchActive(true);\n                            setSearchResults("[CHART:TRADE]");\n                          }}\n                          data-testid="button-trade"\n                        >\n                          <div className="flex items-center justify-center gap-1">\n                            <Trophy className="h-3 w-3" />\n                            <span>Trade Challenge</span>\n                          </div>\n                        </Button>\n\n\n                        {/* <Button\n                        variant="secondary"\n                        className="bg-yellow-600 hover:bg-yellow-700 text-white border-0 h-11 px-4 rounded-full font-medium transition-all duration-200"\n                        onClick={() =>\n                          handleSuggestionClick(\n                            "Add TCS to watchlist and set alerts"\n                          )\n                        }\n                      >\n                        <div className="flex items-center gap-2">\n                          <Bell className="h-4 w-4" />\n                          <span>Quick Actions</span>\n                        </div>\n                      </Button> */}\n\n                        {/* <Button\n                        variant="secondary"\n                        className="bg-purple-600 hover:bg-purple-700 text-white border-0 h-11 px-4 rounded-full font-medium transition-all duration-200"\n                        onClick={() =>\n                          handleSuggestionClick(\n                            "Show me upcoming IPOs and recent IPO performance in Indian markets"\n                          )\n                        }\n                      >\n                        <div className="flex items-center gap-2">\n                          <TrendingUp className="h-4 w-4" />\n                          <span>IPO Updates</span>\n                        </div>\n                      </Button> */}\n\n\n                      </div>\n\n                      {/* Trading Tools Section - White container with centered cards */}\n                      <div className={`${searchResults ? 'bg-transparent' : 'bg-white'} md:pt-4 md:pb-4 md:rounded-3xl rounded-3xl relative pointer-events-auto touch-pan-y flex-shrink-0 w-full mt-[21px] mb-[21px] pt-[32px] pb-[16px] ml-[0px] mr-[0px] pl-[0px] pr-[0px]`}>\n                        {/* Mobile Search Bar - Fully visible at top */}\n                        <div className="md:hidden absolute -top-3 left-4 right-4 z-50">\n                          <div className="relative">\n                            <Input\n                              placeholder="Search stocks, technical analysis, social feed..."\n                              value={searchQuery}\n                              onFocus={() => setIsSearchActive(true)}\n                              onChange={(e) => {\n                                const value = e.target.value;\n                                setSearchQuery(value);\n                                setIsSearchActive(value.length > 0);\n                              }}\n                              onKeyPress={async (e) => {\n                                if (e.key === "Enter" && searchQuery.trim()) {\n                                  await handleSearch();\n                                }\n                              }}\n                              className="w-full h-12 bg-gray-800 border-gray-700 text-gray-100 placeholder-gray-400 pr-24 text-xs rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-lg mt-[0px] mb-[0px]"\n                            />\n                            {searchQuery && (\n                              <Button\n                                size="sm"\n                                variant="ghost"\n                                className="absolute right-14 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 h-8 w-8 p-0"\n                                onClick={() => {\n                                  setSearchQuery("");\n                                  setIsSearchActive(false);\n                                  setSearchResults("");\n                                }}\n                                data-testid="button-clear-search"\n                              >\n                                <X className="h-4 w-4" />\n                              </Button>\n                            )}\n                            <Button\n                              size="sm"\n                              className="absolute right-3 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 text-gray-300"\n                              onClick={() => handleSearch()}\n                              disabled={!searchQuery.trim() || isSearchLoading}\n                            >\n                              {isSearchLoading ? (\n                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                              ) : (\n                                <Bot className="h-4 w-4" />\n                              )}\n                            </Button>\n                          </div>\n\n                          {/* Mobile backdrop - tap outside to close search */}\n                          {isSearchActive && !searchResults && (\n                            <div\n                              className="md:hidden fixed inset-0 z-40"\n                              onClick={() => {\n                                setSearchQuery("");\n                                setIsSearchActive(false);\n                                setSearchResults("");\n                              }}\n                            />\n                          )}\n\n                          {/* Mobile Quick Suggestion Buttons - Same as desktop, horizontal scroll when search is active */}\n                          {isSearchActive && (\n                            <div\n                              className="mt-2 flex gap-2 overflow-x-auto scrollbar-hide pb-2 relative z-50"\n                              style={{\n                                scrollbarWidth: "none",\n                                msOverflowStyle: "none",\n                              }}\n                            >\n                              <Button\n                                variant="secondary"\n                                className="bg-cyan-600 hover:bg-cyan-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0"\n                                onClick={() => {\n                                  setIsWatchlistLoading(true);\n                                  setIsSearchActive(true);\n                                  setSearchResults("[CHART:WATCHLIST]");\n                                  setIsWatchlistOpen(true);\n                                  // Auto-select first stock in watchlist and fetch its quarterly data\n                                  if (watchlistSymbols.length > 0 && !selectedWatchlistSymbol) {\n                                    const firstStock = watchlistSymbols[0];\n                                    setSelectedWatchlistSymbol(firstStock.symbol);\n                                    setSearchResultsNewsSymbol(firstStock.symbol);\n                                  }\n                                  setTimeout(() => setIsWatchlistLoading(false), 300);\n                                }}\n                                data-testid="button-watchlist-mobile"\n                              >\n                                <div className="flex items-center justify-center gap-1">\n                                  {isWatchlistLoading ? (\n                                    <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                                  ) : (\n                                    <Eye className="h-3 w-3" />\n                                  )}\n                                  <span>Watchlist</span>\n                                </div>\n                              </Button>\n\n                              <Button\n                                variant="secondary"\n                                className="bg-green-600 hover:bg-green-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0"\n                                onClick={() =>\n                                  handleSuggestionClick(\n                                    "What are today's top financial news and market updates?",\n                                  )\n                                }\n                              >\n                                <div className="flex items-center gap-1">\n                                  <Newspaper className="h-3 w-3" />\n                                  <span>Market News</span>\n                                </div>\n                              </Button>\n\n                              <Button\n                                variant="secondary"\n                                className="bg-pink-600 hover:bg-pink-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0"\n                                onClick={() =>\n                                  handleSuggestionClick(\n                                    "Social feed community discussions and trending topics",\n                                  )\n                                }\n                              >\n                                <div className="flex items-center gap-1">\n                                  <User className="h-3 w-3" />\n                                  <span>Social Feed</span>\n                                </div>\n                              </Button>\n\n                              <Button\n                                variant="secondary"\n                                className="bg-indigo-600 hover:bg-indigo-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0"\n                                onClick={generateJournalAIReport}\n                                data-testid="button-trading-journal-mobile"\n                              >\n                                <div className="flex items-center gap-1">\n                                  <FileText className="h-3 w-3" />\n                                  <span>Trading Journal</span>\n                                </div>\n                              </Button>\n\n                              <Button\n                                variant="secondary"\n                                className="bg-orange-600 hover:bg-orange-700 text-white border-0 h-7 px-2 rounded-full text-xs font-medium transition-all duration-200 whitespace-nowrap flex-shrink-0"\n                                onClick={() => {\n                                  setIsSearchActive(true);\n                                  setSearchResults("[CHART:TRADE]");\n                                }}\n                                data-testid="button-trade-challenge-mobile"\n                              >\n                                <div className="flex items-center gap-1">\n                                  <Trophy className="h-3 w-3" />\n                                  <span>Trade Challenge</span>\n                                </div>\n                              </Button>\n                            </div>\n                          )}\n\n                          {/* Mobile AI Search Results - Extends to bottom */}\n                          {isSearchActive && searchResults && (\n                            <div className="md:hidden fixed inset-x-0 top-0 bottom-0 bg-gray-900/95 backdrop-blur-sm z-[60] overflow-y-auto">\n                              <div className="p-3 space-y-3">\n                                <div className="flex items-center justify-between pb-2 border-b border-gray-700">\n                                  <div className="flex items-center gap-1.5">\n                                    {searchResults.includes("[CHART:WATCHLIST]") ? (\n                                      <>\n                                        <Eye className="h-4 w-4 text-gray-700 dark:text-blue-400" />\n                                        <h3 className="text-xs font-medium text-gray-100">\n                                          Watchlist\n                                        </h3>\n                                      </>\n                                    ) : searchResults.includes("[CHART:TRADE]") ? (\n                                      <>\n                                        <Trophy className="h-4 w-4 text-red-400" />\n                                        <h3 className="text-xs font-medium text-gray-100">\n                                          Trade Challenge\n                                        </h3>\n                                      </>\n                                    ) : (\n                                      <>\n                                        <Bot className="h-4 w-4 text-blue-400" />\n                                        <h3 className="text-xs font-medium text-gray-100">\n                                          Trading Challenge\n                                        </h3>\n                                      </>\n                                    )}\n                                  </div>\n                                  <Button\n                                    variant="ghost"\n                                    size="sm"\n                                    onClick={() => {\n                                      setSearchQuery("");\n                                      setIsSearchActive(false);\n                                      setSearchResults("");\n                                    }}\n                                    className="text-gray-400 hover:text-gray-200 h-6 w-6 p-0"\n                                  >\n                                    <X className="h-4 w-4" />\n                                  </Button>\n                                </div>\n                                <div className="prose prose-invert max-w-none">\n                                  <div className="text-gray-300 whitespace-pre-wrap leading-tight text-xs">\n                                    {searchResults.includes("[CHART:WATCHLIST]") ? (\n// Mobile Watchlist Layout - Using compact desktop layout\n                                      <div className="space-y-2">\n                                        {/* NIFTY 50 Chart */}\n                                        <div className="bg-gray-800/50 rounded-lg p-2 border border-gray-700">\n                                          <div className="space-y-1">\n                                            <div className="flex items-center justify-between">\n                                              <div className="flex items-center gap-1">\n                                                <h4 className="text-xs font-semibold text-gray-200">NIFTY 50</h4>\n                                                <span className="text-xs text-green-400 flex items-center gap-0.5">\n                                                  <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>\n                                                  Live\n                                                </span>\n                                              </div>\n                                              <div className="text-right">\n                                                <div className="text-xs font-mono text-gray-100">₹{getNifty50CurrentPrice().toLocaleString('en-IN', { maximumFractionDigits: 2 })}</div>\n                                                <div className={`text-xs flex items-center justify-end gap-0.5 ${getNifty50Change() >= 0 ? 'text-green-400' : 'text-red-400'}`}>\n                                                  {getNifty50Change() >= 0 ? '▲' : '▼'} {Math.abs((getNifty50Change() / (getNifty50CurrentPrice() - getNifty50Change())) * 100).toFixed(2)}%\n                                                </div>\n                                              </div>\n                                            </div>\n                                            <div className="flex items-center gap-0.5">\n                                              {['1D', '5D', '1M'].map((tf) => (\n                                                <Button key={tf} variant="ghost" size="sm" onClick={() => setNifty50Timeframe(tf)} className={`px-1 py-0 text-xs h-5 ${nifty50Timeframe === tf ? 'bg-blue-600/20 text-blue-400' : 'text-gray-400'}`}>\n                                                  {tf}\n                                                </Button>\n                                              ))}\n                                            </div>\n                                            <div className="h-24 w-full bg-gray-800/30 rounded p-1">\n                                              <ResponsiveContainer width="100%" height="100%">\n                                                <LineChart data={isNifty50Loading ? [] : nifty50FormattedData} margin={{ top: 2, right: 10, left: 30, bottom: 2 }}>\n                                                  <XAxis dataKey="time" axisLine={false} tickLine={false} tick={{ fontSize: 8, fill: '#64748b' }} tickCount={3} />\n                                                  <YAxis domain={['dataMin - 50', 'dataMax + 50']} axisLine={false} tickLine={false} tick={{ fontSize: 8, fill: '#64748b' }} width={8} />\n                                                  <Tooltip content={({ active, payload }) => {if (!active || !payload?.length) return null; const value = payload[0].value; return <div style={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '4px', color: '#e2e8f0', padding: '4px 8px', fontSize: '11px' }}>₹{Number(value).toFixed(2)}</div>;}} />\n                                                  <Line type="linear" dataKey="price" stroke="#ef4444" strokeWidth={1.5} dot={false} />\n                                                </LineChart>\n                                              </ResponsiveContainer>\n                                            </div>\n                                          </div>\n                                        </div>\n\n                                        {/* Selected Stock Chart */}\n                                        {selectedWatchlistSymbol && (\n                                          <div className="bg-gray-800/50 rounded-lg p-2 border border-gray-700">\n                                            <div className="space-y-1">\n                                              <div className="flex items-center justify-between">\n                                                <div className="flex items-center gap-1">\n                                                  <h4 className="text-xs font-semibold text-gray-200">{selectedWatchlistSymbol.replace('-EQ', '')}</h4>\n                                                  <span className="text-xs text-green-400">Live</span>\n                                                </div>\n                                              </div>\n                                              <div className="flex items-center gap-0.5">\n                                                {['1D', '5D', '1M'].map((tf) => (\n                                                  <Button key={tf} variant="ghost" size="sm" onClick={() => {}} className={`px-1 py-0 text-xs h-5 bg-blue-600/20 text-blue-400`}>\n                                                    {tf}\n                                                  </Button>\n                                                ))}\n                                              </div>\n                                              <div className="h-24 w-full bg-gray-800/30 rounded p-1">\n                                                <ResponsiveContainer width="100%" height="100%">\n                                                  <LineChart data={[]} margin={{ top: 2, right: 10, left: 30, bottom: 2 }}>\n                                                    <XAxis dataKey="time" axisLine={false} tickLine={false} tick={{ fontSize: 8 }} tickCount={3} />\n                                                    <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 8 }} width={8} />\n                                                    <Line type="linear" dataKey="price" stroke="#22c55e" strokeWidth={1.5} dot={false} />\n                                                  </LineChart>\n                                                </ResponsiveContainer>\n                                              </div>\n                                            </div>\n                                          </div>\n                                        )}\n\n                                        {/* My Watchlist */}\n                                        <div className="bg-gray-800/50 rounded-lg p-2 border border-gray-700">\n                                          <div className="flex items-center justify-between mb-2">\n                                            <h4 className="text-xs font-medium text-gray-200">My Watchlist</h4>\n                                            <span className="text-xs text-gray-400">{watchlistSymbols.length} stocks</span>\n                                          </div>\n                                          <div className="space-y-1 max-h-20 overflow-y-auto">\n                                            {watchlistSymbols.map((stock) => (\n                                              <div key={stock.symbol} onClick={() => setSelectedWatchlistSymbol(stock.symbol)} className={`px-2 py-1 rounded text-xs cursor-pointer ${selectedWatchlistSymbol === stock.symbol ? 'bg-blue-600/30 border border-blue-500/50' : 'hover:bg-gray-700/50'}`}>\n                                                <div className="font-medium text-gray-200">{stock.displayName || stock.symbol}</div>\n                                              </div>\n                                            ))}\n                                          </div>\n                                        </div>\n                                      </div>\n                                    ) : searchResults.includes("[CHART:TRADE]") ? (\n\n                                      <div className="w-full max-w-2xl mx-auto py-12">\n                                        {/* Header with Trophy Icon */}\n                                        <div className="flex flex-col items-center mb-8">\n                                          <div className="w-24 h-24 bg-orange-500 rounded-full flex items-center justify-center mb-6 shadow-lg">\n                                            <Trophy className="h-12 w-12 text-white" />\n                                          </div>\n                                          <h2 className="text-3xl font-bold text-white text-center mb-2">Trading Challenge</h2>\n                                          <p className="text-gray-400 text-lg">Coming Soon</p>\n                                        </div>\n\n                                        {/* Feature Cards */}\n                                        <div className="space-y-3">\n                                          {/* Compete with Traders Card */}\n                                          <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex items-start gap-4">\n                                            <div className="flex-shrink-0">\n                                              <Users className="h-6 w-6 text-blue-400" />\n                                            </div>\n                                            <div className="flex-1">\n                                              <h3 className="text-white font-semibold mb-1">Compete with Traders</h3>\n                                              <p className="text-gray-400 text-sm">Join 7-day trading challenges</p>\n                                            </div>\n                                          </div>\n\n                                          {/* Live P&L Tracking Card */}\n                                          <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex items-start gap-4">\n                                            <div className="flex-shrink-0">\n                                              <BarChart3 className="h-6 w-6 text-green-400" />\n                                            </div>\n                                            <div className="flex-1">\n                                              <h3 className="text-white font-semibold mb-1">Live P&L Tracking</h3>\n                                              <p className="text-gray-400 text-sm">Real-time ranking based on your trades</p>\n                                            </div>\n                                          </div>\n\n                                          {/* Leaderboard Rankings Card */}\n                                          <div className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex items-start gap-4">\n                                            <div className="flex-shrink-0">\n                                              <Trophy className="h-6 w-6 text-yellow-500" />\n                                            </div>\n                                            <div className="flex-1">\n                                              <h3 className="text-white font-semibold mb-1">Leaderboard Rankings</h3>\n                                              <p className="text-gray-400 text-sm">See your position among all participants</p>\n                                            </div>\n                                          </div>\n                                        </div>\n                                      </div>\n                                      ) : (searchResults\n\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                        {/* Trading Tools Grid - Desktop: 4 columns centered, Mobile: 3 horizontal cards + swipeable below */}\n                        {!searchResults && (\n                        <div className="mx-auto max-w-6xl hidden md:grid md:grid-cols-2 lg:grid-cols-4 md:gap-4 md:px-6 md:items-center">\n                          {/* Social Feed Card */}\n                          <div\n                            className="bg-blue-500 rounded-2xl overflow-hidden h-36 w-full relative cursor-pointer hover:scale-105 transition-transform"\n                            onClick={() => checkAuthAndNavigate("voice")}\n                          >\n                            <div className="absolute top-3 left-3">\n                              <span className="bg-white bg-opacity-90 text-blue-600 px-2.5 py-1 rounded-full text-xs font-medium">\n                                Social Feed\n                              </span>\n                            </div>\n                            <div className="absolute bottom-3 right-3">\n                              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                <MessageCircle className="h-6 w-6 text-white" />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Trading Master Card */}\n                          <div\n                            className="bg-indigo-500 rounded-2xl overflow-hidden h-36 w-full relative cursor-pointer hover:scale-105 transition-transform"\n                            onClick={handleTradingMasterAccess}\n                          >\n                            <div className="absolute top-3 left-3">\n                              <span className="bg-white bg-opacity-90 text-indigo-600 px-2.5 py-1 rounded-full text-xs font-medium">\n                                Trading Master\n                              </span>\n                            </div>\n                            <div className="absolute bottom-3 right-3">\n                              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                <Activity className="h-6 w-6 text-white" />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Trading Charts Card */}\n                          <div\n                            className="bg-emerald-500 rounded-2xl overflow-hidden h-36 w-full relative cursor-pointer hover:scale-105 transition-transform"\n                            onClick={() => checkAuthAndNavigate("journal")}\n                          >\n                            <div className="absolute top-3 left-3">\n                              <span className="bg-white bg-opacity-90 text-emerald-600 px-2.5 py-1 rounded-full text-xs font-medium">\n                                Journal\n                              </span>\n                            </div>\n                            <div className="absolute bottom-3 right-3">\n                              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                <BarChart3 className="h-6 w-6 text-white" />\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Tutor Daily News Swipeable Cards - Portrait orientation with proper spacing */}\n                          <div className="relative h-36 w-full flex items-center justify-center">\n                            <SwipeableCardStack\n                              onSectorChange={handleSectorChange}\n                              selectedSector={selectedSector}\n                              onCardIndexChange={setCurrentCardIndex}\n                              currentCardIndex={currentCardIndex}\n                            />\n                          </div>\n                        </div>\n                        )}\n                        {/* Mobile Layout: 3 horizontal cards + swipeable below */}\n                        {!searchResults && (\n                        <div className="md:hidden mt-6">\n                          {/* Three cards in a row */}\n                          <div className="grid grid-cols-3 gap-3 px-4 mb-3">\n                            {/* Social Feed Card */}\n                            <div\n                              className="bg-blue-500 rounded-xl overflow-hidden h-20 relative cursor-pointer active:scale-95 transition-transform"\n                              onClick={() => checkAuthAndNavigate("voice")}\n                            >\n                              <div className="absolute top-2 left-2">\n                                <span className="bg-white bg-opacity-90 text-blue-600 px-2 py-0.5 rounded-full text-[10px] font-medium">\n                                  Social Feed\n                                </span>\n                              </div>\n                              <div className="absolute bottom-2 right-2">\n                                <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                  <MessageCircle className="h-5 w-5 text-white" />\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Trading Master Card */}\n                            <div\n                              className="bg-purple-500 rounded-xl overflow-hidden h-20 relative cursor-pointer active:scale-95 transition-transform"\n                              onClick={handleTradingMasterAccess}\n                            >\n                              <div className="absolute top-2 left-2">\n                                <span className="bg-white bg-opacity-90 text-purple-600 px-2 py-0.5 rounded-full text-[10px] font-medium">\n                                  Trading Master\n                                </span>\n                              </div>\n                              <div className="absolute bottom-2 right-2">\n                                <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                  <Activity className="h-5 w-5 text-white" />\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Journal Card */}\n                            <div\n                              className="bg-green-500 rounded-xl overflow-hidden h-20 relative cursor-pointer active:scale-95 transition-transform"\n                              onClick={() => checkAuthAndNavigate("journal")}\n                            >\n                              <div className="absolute top-2 left-2">\n                                <span className="bg-white bg-opacity-90 text-green-600 px-2 py-0.5 rounded-full text-[10px] font-medium">\n                                  Journal\n                                </span>\n                              </div>\n                              <div className="absolute bottom-2 right-2">\n                                <div className="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">\n                                  <BarChart3 className="h-5 w-5 text-white" />\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Swipeable News Cards Below - Properly Centered */}\n                          <div className="flex items-center justify-center px-4 pb-0">\n                            <SwipeableCardStack\n                              onSectorChange={handleSectorChange}\n                              selectedSector={selectedSector}\n                              onCardIndexChange={setCurrentCardIndex}\n                              currentCardIndex={currentCardIndex}\n                            />\n                          </div>\n                        </div>\n                        )}\n\n                        {/* Navigation Dots - Outside white container, in blue area */}\n                        {!searchResults && (\n                        <div className="md:hidden absolute -bottom-10 left-1/2 transform -translate-x-1/2 flex gap-2 justify-center z-40">\n                          {[0, 1, 2, 3, 4, 5].map((index) => (\n                            <button\n                              key={index}\n                              data-testid={`nav-dot-${index}`}\n                              onClick={() => {\n                                // Calculate how many swipes needed to get to this card\n                                const diff = index - currentCardIndex;\n                                // Navigate to the selected card (this would need to be implemented in SwipeableCardStack)\n                                setCurrentCardIndex(index);\n                              }}\n                              className={`w-2 h-2 rounded-full transition-all duration-300 cursor-pointer hover:scale-110 ${\n                                index === currentCardIndex\n                                  ? "bg-white scale-125"\n                                  : "bg-white/40"\n                              }`}\n                            ></button>\n                          ))}\n                        </div>\n                        )}\n                      </div>\n                    </div>\n\n                    {/* Animated Floating Tutor Button */}\n                    {!searchResults && (\n                    <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 pointer-events-auto">\n                      <div className="relative">\n                        {/* Background animation rings */}\n                        <div className="absolute inset-0 w-16 h-16 rounded-full bg-gradient-to-r from-violet-600/30 to-indigo-600/30 animate-ping pointer-events-none"></div>\n                        <div className="absolute inset-0 w-16 h-16 rounded-full bg-gradient-to-r from-violet-600/20 to-indigo-600/20 animate-pulse pointer-events-none"></div>\n\n                        {/* Main clickable button */}\n                        <Button\n                          onClick={() => setTabWithAuthCheck("tutor")}\n                          className="relative w-16 h-16 rounded-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 shadow-2xl hover:animate-none transition-all duration-300 border-4 border-white/20 pointer-events-auto animate-bounce hover:scale-110"\n                        >\n                          <ChevronUp className="h-8 w-8 text-gray-400 pointer-events-none" />\n                        </Button>\n                      </div>\n                    </div>\n                    )}\n\n                    {/* Tutor Vertical Sidebar - Slides from right */}\n                    {showTutorOverlay && (\n                      <>\n                        {/* Backdrop */}\n                        <div\n                          className="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300"\n                          onClick={() => setShowTutorOverlay(false)}\n                        />\n\n                        {/* Sidebar */}\n                        <div\n                          className="fixed top-0 right-0 h-full w-96 bg-slate-900 z-50 shadow-2xl transition-transform duration-500 ease-out"\n                          style={{\n                            animation: "slideInFromRight 0.5s ease-out",\n                          }}\n                        >\n                          {/* Header with close button */}\n                          <div className="flex items-center justify-between p-4 border-b border-slate-700">\n                            <div className="flex items-center gap-3">\n                              <div className="w-8 h-8 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-lg flex items-center justify-center">\n                                <GraduationCap className="h-5 w-5 text-white" />\n                              </div>\n                              <span className="text-lg font-semibold text-white">\n                                AI Trading Tutor\n                              </span>\n                            </div>\n                            <Button\n                              variant="ghost"\n                              size="sm"\n                              onClick={() => setShowTutorOverlay(false)}\n                              className="text-slate-400 hover:text-white hover:bg-slate-800"\n                            >\n                              <X className="h-5 w-5" />\n                            </Button>\n                          </div>\n\n                          {/* Scrollable content */}\n                          <div className="h-full overflow-y-auto pb-20 custom-thin-scrollbar">\n                            <div className="p-4 space-y-6">\n                              {/* Welcome message */}\n                              <div className="text-center space-y-2">\n                                <h2 className="text-xl font-bold text-white">\n                                  Learn & Master Trading\n                                </h2>\n                                <p className="text-slate-300 text-sm">\n                                  Interactive lessons and personalized guidance\n                                </p>\n                              </div>\n\n                              {/* Quick access cards - vertical stack */}\n                              <div className="space-y-4">\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3 mb-3">\n                                    <div className="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">\n                                      <BookOpen className="h-5 w-5 text-white" />\n                                    </div>\n                                    <h3 className="text-lg font-semibold text-white">\n                                      Trading Basics\n                                    </h3>\n                                  </div>\n                                  <p className="text-slate-300 text-sm">\n                                    Learn fundamental concepts and strategies\n                                  </p>\n                                </div>\n\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3 mb-3">\n                                    <div className="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">\n                                      <BarChart3 className="h-5 w-5 text-white" />\n                                    </div>\n                                    <h3 className="text-lg font-semibold text-white">\n                                      Chart Analysis\n                                    </h3>\n                                  </div>\n                                  <p className="text-slate-300 text-sm">\n                                    Master technical analysis and patterns\n                                  </p>\n                                </div>\n\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3 mb-3">\n                                    <div className="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center">\n                                      <Target className="h-5 w-5 text-white" />\n                                    </div>\n                                    <h3 className="text-lg font-semibold text-white">\n                                      Risk Management\n                                    </h3>\n                                  </div>\n                                  <p className="text-slate-300 text-sm">\n                                    Protect your capital with smart strategies\n                                  </p>\n                                </div>\n                              </div>\n\n                              {/* Additional learning sections */}\n                              <div className="space-y-4">\n                                <h3 className="text-lg font-semibold text-white">\n                                  Quick Actions\n                                </h3>\n\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3">\n                                    <div className="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">\n                                      <Lightbulb className="h-4 w-4 text-white" />\n                                    </div>\n                                    <span className="text-white font-medium">\n                                      Trading Tips\n                                    </span>\n                                  </div>\n                                </div>\n\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3">\n                                    <div className="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">\n                                      <AlertCircle className="h-4 w-4 text-white" />\n                                    </div>\n                                    <span className="text-white font-medium">\n                                      Market Alerts\n                                    </span>\n                                  </div>\n                                </div>\n\n                                <div className="bg-slate-800 rounded-xl p-4 hover:bg-slate-700 transition-colors cursor-pointer">\n                                  <div className="flex items-center gap-3">\n                                    <div className="w-8 h-8 bg-teal-500 rounded-lg flex items-center justify-center">\n                                      <TrendingUp className="h-4 w-4 text-white" />\n                                    </div>\n                                    <span className="text-white font-medium">\n                                      Performance Insights\n                                    </span>\n                                  </div>\n                                </div>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </>\n                    )}\n\n                    {/* Global CSS for animations */}\n                    <style>{`\n                  @keyframes slideUpFromBottom {\n                    from {\n                      transform: translateY(100%);\n                    }\n                    to {\n                      transform: translateY(0);\n                    }\n                  }\n\n                  @keyframes slideInFromRight {\n                    from {\n                      transform: translateX(100%);\n                    }\n                    to {\n                      transform: translateX(0);\n                    }\n                  }\n                `}</style>\n                  </div>\n                </div>\n              </div>\n            )}\n\n\n            {activeTab === "backtest" && (\n              <div className="h-full p-6 space-y-6">\n                <div className="max-w-6xl mx-auto">\n                  {/* Header */}\n                  <div className="flex items-center justify-between mb-6">\n                    <div className="flex items-center gap-3">\n                      <div className="p-3 bg-primary/10 rounded-lg">\n                        <Activity className="h-6 w-6 text-primary" />\n                      </div>\n                      <div>\n                        <h1 className="text-3xl font-bold">Backtest Trading Strategies</h1>\n                        <p className="text-muted-foreground mt-1">Test your trading rules with historical data</p>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Coming Soon Placeholder */}\n                  <div className="bg-gradient-to-br from-card to-card/50 border border-border rounded-xl p-12">\n                    <div className="text-center space-y-4">\n                      <div className="w-20 h-20 mx-auto bg-primary/10 rounded-full flex items-center justify-center">\n                        <Activity className="h-10 w-10 text-primary" />\n                      </div>\n                      <h2 className="text-2xl font-semibold">Backtest Feature Coming Soon</h2>\n                      <p className="text-muted-foreground max-w-md mx-auto">\n                        We're building a powerful backtesting engine to help you validate your trading strategies with historical market data.\n                      </p>\n                      <div className="pt-4">\n                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 text-primary rounded-lg">\n                          <span className="text-sm font-medium">Under Development</span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Feature Demo Cards */}\n                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">\n                    <div className="bg-card border border-border rounded-lg p-6">\n                      <div className="p-2 bg-blue-500/10 rounded-lg w-fit mb-4">\n                        <BarChart3 className="h-5 w-5 text-blue-500" />\n                      </div>\n                      <h3 className="font-semibold mb-2">Historical Data Analysis</h3>\n                      <p className="text-sm text-muted-foreground">\n                        Test strategies against years of historical market data\n                      </p>\n                    </div>\n                    <div className="bg-card border border-border rounded-lg p-6">\n                      <div className="p-2 bg-green-500/10 rounded-lg w-fit mb-4">\n                        <TrendingUp className="h-5 w-5 text-green-500" />\n                      </div>\n                      <h3 className="font-semibold mb-2">Performance Metrics</h3>\n                      <p className="text-sm text-muted-foreground">\n                        Comprehensive statistics on returns, drawdowns, and win rates\n                      </p>\n                    </div>\n                    <div className="bg-card border border-border rounded-lg p-6">\n                      <div className="p-2 bg-purple-500/10 rounded-lg w-fit mb-4">\n                        <Settings className="h-5 w-5 text-purple-500" />\n                      </div>\n                      <h3 className="font-semibold mb-2">Custom Rules</h3>\n                      <p className="text-sm text-muted-foreground">\n                        Define your own entry, exit, and risk management rules\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {activeTab === "trading-master" && (\n              <div className="h-full relative">\n                {/* Back Button - Mobile Only */}\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-trading-master"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <TradingMaster />\n              </div>\n            )}\n\n            {activeTab === "backtest" && (\n              <div className="h-full relative">\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-backtest"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <ThreeCycleScanner />\n              </div>\n            )}\n\n            {activeTab === "chart" && (\n              <div className="h-full relative">\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-chart"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <AdvancedCandlestickChart />\n                <IndicatorCrossingsDisplay />\n              </div>\n            )}\n\n            {activeTab === "check" && (\n              <div className="h-full relative">\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-check"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <BattuScanSimulation />\n              </div>\n            )}\n\n            {activeTab === "4candle" && (\n              <div className="h-full relative">\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-4candle"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <FourCandleRuleScanner />\n              </div>\n            )}\n\n            {activeTab === "scanner" && (\n              <div className="h-full relative">\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-scanner"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <SimpleCompleteScanner />\n              </div>\n            )}\n\n            {activeTab === "journal" && (\n                <div className="space-y-6 px-0.5 md:px-6 py-0.5 relative">\n                {/* Back Button - Mobile Only */}\n                <Button\n                  onClick={() => setTabWithAuthCheck("trading-home")}\n                  variant="ghost"\n                  size="icon"\n                  className="lg:hidden absolute top-4 right-4 z-50 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"\n                  data-testid="button-back-to-home-journal"\n                >\n                  <ArrowLeft className="h-6 w-6" />\n                </Button>\n                <h2 className="text-2xl font-bold text-foreground">\n                  Trading Journal\n                  <span className="text-[10px] md:text-xs text-gray-500 font-medium tracking-widest uppercase italic flex items-center gap-1">\n                    Break the Loop, Find Your Edge \n                    <div className="flex items-center ml-1">\n                      <svg \n                        width="24" \n                        height="12" \n                        viewBox="0 0 24 12" \n                        fill="none" \n                        xmlns="http://www.w3.org/2000/svg"\n                        className="text-purple-500"\n                      >\n                        {/* Left loop */}\n                        <path \n                          d="M11 5.2C10.2 4 9 3 7.5 3C4.5 3 3 4.5 3 6C3 7.5 4.5 9 7.5 9C10.5 9 12 6 12 6" \n                          stroke="currentColor" \n                          strokeWidth="1.5" \n                          strokeLinecap="round" \n                        />\n                        {/* Right loop with a gap at the top right outer corner */}\n                        <path \n                          d="M12 6C12 6 13.5 9 16.5 9C19.5 9 21 7.5 21 6C21 5.6 20.9 5.2 20.7 4.8" \n                          stroke="currentColor" \n                          strokeWidth="1.5" \n                          strokeLinecap="round" \n                        />\n                        <path \n                          d="M17.8 3.3C17.4 3.1 16.9 3 16.5 3C13.5 3 12 6 12 6" \n                          stroke="currentColor" \n                          strokeWidth="1.5" \n                          strokeLinecap="round" \n                        />\n                        {/* Flying broken piece */}\n                        <path \n                          d="M21 2L23 1" \n                          stroke="currentColor" \n                          strokeWidth="1.5" \n                          strokeLinecap="round" \n                          className="animate-pulse"\n                        />\n                      </svg>\n                    </div>\n                  </span>\n                </h2>\n                {/* Main Journal Content - Mobile: Show only in "home" tab | Desktop: Always visible */}\n                <div\n                  className={`${mobileBottomTab !== "home" ? "hidden md:block" : "block"}`}\n                >\n                  {/* PERFORMANCE TIMELINE - Responsive Three Blocks */}\n                  {/* Desktop: 3-column grid | Mobile: Single panel with carousel */}\n                  <div className="relative mb-6">\n                    {/* Desktop: Grid Layout | Mobile: Single Panel */}\n                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">\n                      {/* Left Block - Performance Chart */}\n                      <div\n                        className={`h-[400px] ${mobileJournalPanel === 0 ? "block" : "hidden"} md:block`}\n                      >\n                        {/* Professional Visual Chart with Fyers Data - Same as Trading Master */}\n                        <div className="h-full relative bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg overflow-hidden">\n                          <div className="h-full flex flex-col">\n                            <div className="flex items-center justify-between px-2 py-2">\n                              <div className="flex items-center gap-1 md:gap-2 flex-wrap">\n                                {/* Stock Search Button - ONLY IN SEARCH MODE */}\n                                {journalChartMode === 'search' && (\n                                <Popover\n                                  open={showStockSearch}\n                                  onOpenChange={setShowStockSearch}\n                                >\n                                  <PopoverTrigger asChild>\n                                    <Button\n                                      variant="ghost"\n                                      size="sm"\n                                      className="h-8 px-2 md:px-3 text-xs md:text-sm text-slate-700 dark:text-slate-300"\n                                      data-testid="button-stock-search"\n                                    >\n                                      <Search className="h-3 w-3 md:h-4 md:w-4 md:mr-1" />\n                                      <span className="hidden md:inline">\n                                        {selectedJournalSymbol\n                                          .replace("NSE:", "")\n                                          .replace("-EQ", "")\n                                          .replace("-INDEX", "")}\n                                      </span>\n                                    </Button>\n                                  </PopoverTrigger>\n                                  <PopoverContent\n                                    className="w-80 p-3"\n                                    align="start"\n                                  >\n                                    <div className="space-y-1">\n                                      <div className="flex gap-1.5">\n                                        <Input\n                                          placeholder={\n                                            journalSearchType === 'STOCK'\n                                              ? 'Search RELIANCE, TCS, INFY...'\n                                              : journalSearchType === 'COMMODITY'\n                                              ? 'Search GOLD, SILVER, CRUDEOIL...'\n                                              : 'Search NIFTY, BANKNIFTY...'\n                                          }\n                                          value={stockSearchQuery}\n                                          onChange={(e) => setStockSearchQuery(e.target.value)}\n                                          className="text-xs flex-1 h-7 bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700"\n                                          data-testid="input-stock-search"\n                                        />\n                                        <select\n                                          value={journalSearchType}\n                                          onChange={(e) => {\n                                            setJournalSearchType(e.target.value as 'STOCK' | 'COMMODITY' | 'F&O');\n                                            setStockSearchQuery('');\n                                            setSearchedInstruments([]);\n                                          }}\n                                          className="h-7 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 border border-gray-200 dark:border-slate-700 rounded px-2 text-xs font-medium"\n                                          data-testid="select-journal-type"\n                                        >\n                                          <option value="STOCK">Stock</option>\n                                          <option value="COMMODITY">Commodity</option>\n                                          <option value="F&O">F&O</option>\n                                        </select>\n                                      </div>\n\n                                      <div className="max-h-64 overflow-y-auto space-y-1 custom-thin-scrollbar">\n                                        {/* Loading State */}\n                                        {isSearchingInstruments && (\n                                          <div className="flex items-center justify-center py-4">\n                                            <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />\n                                            <span className="ml-2 text-sm text-gray-500">Searching...</span>\n                                          </div>\n                                        )}\n\n                                        {/* No Results */}\n                                        {!isSearchingInstruments && stockSearchQuery.length >= 2 && (\n                                          searchedInstruments.filter((i) => {\n                                            if (selectedInstrumentCategory === 'all') return true;\n\n                                            switch(selectedInstrumentCategory) {\n                                              case 'stock':\n                                                // NSE/BSE stocks - equity instruments (like paper trading STOCK type)\n                                                return (i.exchange === 'NSE' || i.exchange === 'BSE') && \n                                                  (!i.instrumentType || i.instrumentType === '' || i.instrumentType === 'EQ' || \n                                                   i.symbol?.endsWith('-EQ') || i.instrumentType === 'AMXIDX');\n                                              case 'commodity':\n                                                // MCX and NCDEX - ALL commodity instruments (like paper trading MCX type)\n                                                return i.exchange === 'MCX' || i.exchange === 'NCDEX';\n                                              case 'fo':\n                                                // F&O: NFO and BFO exchanges (like paper trading FUTURES/OPTIONS type)\n                                                return i.exchange === 'NFO' || i.exchange === 'BFO';\n                                              case 'currency':\n                                                // Currency Derivatives: CDS exchange\n                                                return i.exchange === 'CDS';\n                                              case 'index':\n                                                // Indices: AMXIDX is the main index type from Angel One\n                                                return i.instrumentType === 'AMXIDX' || i.instrumentType === 'INDEX';\n                                              default:\n                                                return true;\n                                            }\n                                          }).length === 0\n                                        ) && (\n                                          <div className="px-3 py-4 text-center text-sm text-gray-500">\n                                            No {selectedInstrumentCategory !== 'all' ? selectedInstrumentCategory : ''} instruments found\n                                          </div>\n                                        )}\n\n                                        {/* Default Popular Instruments - Show when no search query */}\n                                        {stockSearchQuery.length < 2 && (\n                                          <>\n                                            {/* Show defaults for categories that have them */}\n                                            {(defaultInstruments[selectedInstrumentCategory as keyof typeof defaultInstruments]?.length > 0) ? (\n                                              <>\n                                                <div className="px-3 py-2 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">\n                                                  Popular {selectedInstrumentCategory !== 'all' ? selectedInstrumentCategory.charAt(0).toUpperCase() + selectedInstrumentCategory.slice(1) : ''} Instruments\n                                                </div>\n                                                {(defaultInstruments[selectedInstrumentCategory as keyof typeof defaultInstruments] || defaultInstruments.all).map((instrument) => (\n                                                  <button\n                                                    key={`default-${instrument.exchange}:${instrument.symbol}`}\n                                                    onClick={() => {\n                                                      const formattedSymbol = `${instrument.exchange}:${instrument.symbol}`;\n                                                      setSelectedJournalSymbol(formattedSymbol);\n                                                      setSelectedInstrument({\n                                                        symbol: instrument.symbol,\n                                                        token: instrument.token,\n                                                        exchange: instrument.exchange,\n                                                        tradingSymbol: instrument.tradingSymbol,\n                                                        instrumentType: instrument.instrumentType\n                                                      });\n                                                      setSelectedInstrumentToken({\n                                                        token: instrument.token,\n                                                        exchange: instrument.exchange,\n                                                        tradingSymbol: instrument.tradingSymbol\n                                                      });\n                                                      setShowStockSearch(false);\n                                                      setStockSearchQuery("");\n                                                    }}\n                                                    className={`w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${\n                                                      selectedJournalSymbol === `${instrument.exchange}:${instrument.symbol}`\n                                                        ? "bg-blue-100 dark:bg-blue-900 font-medium"\n                                                        : ""\n                                                    }`}\n                                                    data-testid={`default-stock-${instrument.exchange}:${instrument.symbol}`}\n                                                  >\n                                                    <div className="flex items-center justify-between gap-2">\n                                                      <span className="flex-1 font-medium">{instrument.name}</span>\n                                                      <div className="flex items-center gap-1">\n                                                        <span className={`px-1.5 py-0.5 text-xs font-semibold rounded ${\n                                                          instrument.exchange === 'NSE' ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300' :\n                                                          instrument.exchange === 'BSE' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' :\n                                                          instrument.exchange === 'MCX' ? 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300' :\n                                                          instrument.exchange === 'NFO' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' :\n                                                          instrument.exchange === 'BFO' ? 'bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300' :\n                                                          instrument.exchange === 'CDS' ? 'bg-cyan-100 dark:bg-cyan-900 text-cyan-700 dark:text-cyan-300' :\n                                                          instrument.exchange === 'NCDEX' ? 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300' :\n                                                          'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'\n                                                        }`}>\n                                                          {instrument.exchange}\n                                                        </span>\n                                                        {instrument.instrumentType && (\n                                                          <span className="px-1.5 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">\n                                                            {instrument.instrumentType}\n                                                          </span>\n                                                        )}\n                                                      </div>\n                                                    </div>\n                                                    <div className="text-xs text-gray-500 mt-0.5">\n                                                      {instrument.symbol}\n                                                    </div>\n                                                  </button>\n                                                ))}\n                                                <div className="px-3 py-2 text-xs text-gray-400 dark:text-gray-500 border-t border-gray-200 dark:border-gray-700 mt-1">\n                                                  Or type to search more instruments...\n                                                </div>\n                                              </>\n                                            ) : (\n                                              /* Show search suggestions for Commodity and F&O */\n                                              <div className="px-3 py-3 space-y-3">\n                                                <div className="text-sm text-gray-600 dark:text-gray-400">\n                                                  Search for {selectedInstrumentCategory === 'commodity' ? 'MCX/NCDEX Commodities' : selectedInstrumentCategory === 'currency' ? 'Currency Derivatives' : 'F&O Derivatives'}:\n                                                </div>\n                                                <div className="flex flex-wrap gap-1.5">\n                                                  {(categorySearchSuggestions[selectedInstrumentCategory] || []).map((suggestion) => (\n                                                    <button\n                                                      key={suggestion}\n                                                      onClick={() => setStockSearchQuery(suggestion)}\n                                                      className="px-2.5 py-1.5 text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"\n                                                      data-testid={`search-suggestion-${suggestion}`}\n                                                    >\n                                                      {suggestion}\n                                                    </button>\n                                                  ))}\n                                                </div>\n                                                <div className="text-xs text-gray-400 dark:text-gray-500 pt-1 border-t border-gray-200 dark:border-gray-700">\n                                                  Click a suggestion or type to search...\n                                                </div>\n                                              </div>\n                                            )}\n                                          </>\n                                        )}\n\n                                        {/* Search Results */}\n                                        {!isSearchingInstruments && stockSearchQuery.length >= 2 && searchedInstruments\n                                          .filter((i) => {\n                                            if (selectedInstrumentCategory === 'all') return true;\n\n                                            switch(selectedInstrumentCategory) {\n                                              case 'stock':\n                                                // NSE/BSE stocks - equity instruments (like paper trading STOCK type)\n                                                return (i.exchange === 'NSE' || i.exchange === 'BSE') && \n                                                  (!i.instrumentType || i.instrumentType === '' || i.instrumentType === 'EQ' || \n                                                   i.symbol?.endsWith('-EQ') || i.instrumentType === 'AMXIDX');\n                                              case 'commodity':\n                                                // MCX and NCDEX - ALL commodity instruments (like paper trading MCX type)\n                                                return i.exchange === 'MCX' || i.exchange === 'NCDEX';\n                                              case 'fo':\n                                                // F&O: NFO and BFO exchanges (like paper trading FUTURES/OPTIONS type)\n                                                return i.exchange === 'NFO' || i.exchange === 'BFO';\n                                              case 'currency':\n                                                // Currency Derivatives: CDS exchange\n                                                return i.exchange === 'CDS';\n                                              case 'index':\n                                                // Indices: AMXIDX is the main index type from Angel One\n                                                return i.instrumentType === 'AMXIDX' || i.instrumentType === 'INDEX';\n                                              default:\n                                                return true;\n                                            }\n                                          })\n                                          .map((instrument) => (\n                                          <button\n                                            key={`${instrument.exchange}:${instrument.symbol}`}\n                                            onClick={() => {\n                                              const formattedSymbol = `${instrument.exchange}:${instrument.symbol}`;\n                                              setSelectedJournalSymbol(formattedSymbol);\n                                              setSelectedInstrument({\n                                                symbol: instrument.symbol,\n                                                token: instrument.token,\n                                                exchange: instrument.exchange,\n                                                tradingSymbol: instrument.tradingSymbol,\n                                                instrumentType: instrument.instrumentType\n                                              });\n                                              setSelectedInstrumentToken({\n                                                token: instrument.token,\n                                                exchange: instrument.exchange,\n                                                tradingSymbol: instrument.tradingSymbol\n                                              });\n                                              setShowStockSearch(false);\n                                              setStockSearchQuery("");\n                                            }}\n                                            className={`w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${\n                                              selectedJournalSymbol === `${instrument.exchange}:${instrument.symbol}`\n                                                ? "bg-blue-100 dark:bg-blue-900 font-medium"\n                                                : ""\n                                            }`}\n                                            data-testid={`stock-option-${instrument.exchange}:${instrument.symbol}`}\n                                          >\n                                            <div className="flex items-center justify-between gap-2">\n                                              <span className="flex-1 font-medium">{instrument.name}</span>\n                                              <div className="flex items-center gap-1">\n                                                <span className={`px-1.5 py-0.5 text-xs font-semibold rounded ${\n                                                  instrument.exchange === 'NSE' ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300' :\n                                                  instrument.exchange === 'BSE' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' :\n                                                  instrument.exchange === 'MCX' ? 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300' :\n                                                  instrument.exchange === 'NFO' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' :\n                                                  instrument.exchange === 'BFO' ? 'bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300' :\n                                                  instrument.exchange === 'CDS' ? 'bg-cyan-100 dark:bg-cyan-900 text-cyan-700 dark:text-cyan-300' :\n                                                  instrument.exchange === 'NCDEX' ? 'bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300' :\n                                                  'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'\n                                                }`}>\n                                                  {instrument.exchange}\n                                                </span>\n                                                <span className="px-1.5 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">\n                                                  {instrument.instrumentType}\n                                                </span>\n                                              </div>\n                                            </div>\n                                            {instrument.symbol !== instrument.name && (\n                                              <div className="text-xs text-gray-500 mt-0.5">\n                                                {instrument.symbol}\n                                              </div>\n                                            )}\n                                          </button>\n                                        ))}\n                                      </div>\n                                    </div>\n                                  </PopoverContent>\n                                </Popover>\n                                )}\n\n                                {/* 🔶 Timeframe Dropdown + Time Range Filter + Next Symbol Button */}\n                                <div className="flex items-center gap-1">\n                                  {/* Heatmap Symbol Display - ONLY in Heatmap Mode */}\n                                  {journalChartMode === 'heatmap' && (\n                                    <span className="text-xs font-semibold text-slate-700 dark:text-slate-300 px-2 py-1 rounded bg-slate-100 dark:bg-slate-800/50">\n                                      {\n                                        (() => {\n                                          const sym = heatmapSelectedSymbol.replace('NSE:', '').replace('-INDEX', '').replace('-EQ', '');\n                                          const parts = sym.split(' ');\n                                          if (parts.length > 1) {\n                                            const underlying = parts[0];\n                                            if (underlying === 'NIFTY') return 'NIFTY50';\n                                            if (underlying === 'FINNIFTY') return 'NIFTYFIN';\n                                            if (['SENSEX', 'BANKNIFTY', 'FINNIFTY', 'MIDCPNIFTY'].includes(underlying)) return underlying;\n                                          }\n                                          return sym || 'No symbol';\n                                        })()\n                                      }\n                                    </span>\n                                  )}\n                                  {/* Export Button - ONLY in Heatmap Mode */}\n                                  {journalChartMode === "heatmap" && heatmapChartData.length > 0 && (\n                                    <Button\n                                      variant="ghost"\n                                      size="sm"\n                                      className="h-8 px-2 text-xs text-slate-700 dark:text-slate-300"\n                                      onClick={() => {\n                                        console.log("📥 Exporting Heatmap OHLC data to CSV...");\n                                        try {\n                                          const headers = ["Time", "Open", "High", "Low", "Close", "Volume"];\n                                          const rows = heatmapChartData.map(d => {\n                                            const date = new Date(d.time * 1000);\n                                            const timeStr = date.toISOString().replace("T", " ").replace(/\..+/, "");\n                                            return [timeStr, d.open, d.high, d.low, d.close, d.volume || 0];\n                                          });\n\n                                          let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");\n                                          const encodedUri = encodeURI(csvContent);\n                                          const link = document.createElement("a");\n                                          link.setAttribute("href", encodedUri);\n                                          const fileName = `heatmap_${heatmapSelectedSymbol.replace(/[:]/g, "_")}_${heatmapSelectedDate}.csv`;\n                                          link.setAttribute("download", fileName);\n                                          document.body.appendChild(link);\n                                          link.click();\n                                          document.body.removeChild(link);\n                                          console.log("✅ Export complete:", fileName);\n                                        } catch (error) {\n                                          console.error("❌ Export failed:", error);\n                                        }\n                                      }}\n                                      title="Export to CSV"\n                                      data-testid="button-heatmap-export"\n                                    >\n                                      <Download className="w-3 h-3" />\n                                    </Button>\n                                  )}\n\n\n                                  {/* Next Symbol Button - ONLY in Heatmap Mode */}\n                                  {journalChartMode === 'heatmap' && tradedSymbols.length > 1 && (\n                                    <Button\n                                      variant="ghost"\n                                      size="sm"\n                                      className="h-8 px-2 text-xs text-slate-700 dark:text-slate-300"\n                                      onClick={() => {\n                                        console.log(`⏭️  NEXT CLICKED | Mode: HEATMAP | Index: ${currentSymbolIndex}/${tradedSymbols.length}`);\n\n                                        // Calculate next\n                                        const nextIdx = (currentSymbolIndex + 1) % tradedSymbols.length;\n                                        const nextSymbol = tradedSymbols[nextIdx];\n\n                                        console.log(`⏭️  Switching: ${tradedSymbols[currentSymbolIndex]} → ${nextSymbol}`);\n\n                                        // HEATMAP MODE: Update heatmap chart + header\n                                        if (heatmapChartRef.current) {\n                                          try {\n                                            heatmapChartRef.current.remove();\n                                            console.log(`⏭️  Heatmap chart destroyed`);\n                                          } catch (e) {}\n                                          heatmapChartRef.current = null;\n                                          heatmapCandlestickSeriesRef.current = null;\n                                          heatmapEma12SeriesRef.current = null;\n                                          heatmapEma26SeriesRef.current = null;\n                                        }\n\n                                        setCurrentSymbolIndex(nextIdx);\n                                        const newSymbol = `NSE:${nextSymbol}-INDEX`;\n                                        setHeatmapSelectedSymbol(newSymbol);\n                                        setHeatmapChartData([]);\n                                        setHeatmapHoveredOhlc(null);\n                                        console.log(`⏭️  [HEATMAP] Symbol updated to ${nextSymbol}, refetching chart...`);\n\n                                        // Fetch heatmap data with new symbol and current date\n                                        if (heatmapSelectedDate) {\n                                          fetchHeatmapChartData(newSymbol, heatmapSelectedDate);\n                                        }\n                                      }}\n                                      data-testid="button-next-symbol"\n                                    >\n                                      <ChevronRight className="w-3 h-3" />\n                                    </Button>\n                                  )}\n\n                                  {/* Timeframe Selector - ONLY in Search Mode */}\n                                  {journalChartMode === 'search' && (\n                                  <Popover open={showJournalTimeframeDropdown} onOpenChange={setShowJournalTimeframeDropdown}>\n                                    <PopoverTrigger asChild>\n                                      <Button\n                                        variant="ghost"\n                                        className="h-8 px-2 text-xs min-w-[60px] justify-between text-slate-700 dark:text-slate-300"\n                                        data-testid="button-journal-timeframe-dropdown"\n                                      >\n                                        <span>{getJournalTimeframeLabel(journalChartTimeframe)}</span>\n                                        <ChevronDown className="w-3 h-3 ml-1" />\n                                      </Button>\n                                    </PopoverTrigger>\n                                    <PopoverContent className="w-56 p-2 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700" align="start">\n                                      <div className="grid gap-1">\n                                        {journalTimeframeOptions.map((tf) => (\n                                          <button \n                                            key={tf.value}\n                                            className={`w-full text-left px-2 py-1.5 rounded text-xs transition-colors ${\n                                              journalChartTimeframe === tf.value \n                                                ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-medium' \n                                                : 'text-slate-900 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'\n                                            }`}\n                                            onClick={() => {\n                                              // 🔴 FIX: Update BOTH display AND countdown interval\n                                              setJournalChartTimeframe(tf.value);\n                                              setSelectedJournalInterval(tf.value); // ← CRITICAL: For countdown calculation\n                                              setShowJournalTimeframeDropdown(false);\n                                            }}\n                                            data-testid={`timeframe-option-${tf.value}`}\n                                          >\n                                            {tf.label}\n                                          </button>\n                                        ))}\n                                      </div>\n                                    </PopoverContent>\n                                  </Popover>\n                                  )}\n\n                                  {/* Heatmap Timeframe Selector - ONLY in Heatmap Mode */}\n                                  {journalChartMode === 'heatmap' && (\n                                  <Popover open={showHeatmapTimeframeDropdown} onOpenChange={setShowHeatmapTimeframeDropdown}>\n                                    <PopoverTrigger asChild>\n                                      <Button\n                                        variant="ghost"\n                                        className="h-8 px-2 text-xs min-w-[60px] justify-between text-slate-700 dark:text-slate-300"\n                                        data-testid="button-heatmap-timeframe-dropdown"\n                                      >\n                                        <span>{getJournalTimeframeLabel(heatmapChartTimeframe)}</span>\n                                        <ChevronDown className="w-3 h-3 ml-1" />\n                                      </Button>\n                                    </PopoverTrigger>\n                                    <PopoverContent className="w-56 p-2 bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700" align="start">\n                                      <div className="grid gap-1">\n                                        {journalTimeframeOptions.map((tf) => (\n                                          <button \n                                            key={tf.value}\n                                            className={`w-full text-left px-2 py-1.5 rounded text-xs transition-colors ${\n                                              heatmapChartTimeframe === tf.value \n                                                ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 font-medium' \n                                                : 'text-slate-900 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'\n                                            }`}\n                                            onClick={() => {\n                                              // 🔴 FIX: Update BOTH display AND countdown interval\n                                              setHeatmapChartTimeframe(tf.value);\n                                              setSelectedJournalInterval(tf.value); // ← CRITICAL: For countdown calculation\n                                              setShowHeatmapTimeframeDropdown(false);\n                                            }}\n                                            data-testid={`heatmap-timeframe-option-${tf.value}`}\n                                          >\n                                            {tf.label}\n                                          </button>\n                                        ))}\n                                      </div>\n                                    </PopoverContent>\n                                  </Popover>\n                                  )}\n\n                                  {/* 📅 Heatmap Date Selector - ONLY in Heatmap Mode */}\n                                  {journalChartMode === 'heatmap' && (\n                                  <Popover>\n                                    <PopoverTrigger asChild>\n                                      {(() => {\n                                        // Helper functions for P&L color coding - SAME AS HEATMAP\n                                        const getNetPnL = (d: any): number => {\n                                          if (!d) return 0;\n                                          // Try performanceMetrics first (like DemoHeatmap does)\n                                          if (d?.performanceMetrics?.netPnL !== undefined) {\n                                            return d.performanceMetrics.netPnL;\n                                          }\n                                          // Calculate from tradeHistory if no performanceMetrics\n                                          if (d?.tradeHistory && Array.isArray(d.tradeHistory)) {\n                                            let totalPnL = 0;\n                                            d.tradeHistory.forEach((trade: any) => {\n                                              if (trade.pnl && typeof trade.pnl === 'string') {\n                                                const pnlValue = parseFloat(trade.pnl.replace(/[₹,]/g, ''));\n                                                if (!isNaN(pnlValue)) {\n                                                  totalPnL += pnlValue;\n                                                }\n                                              }\n                                            });\n                                            return totalPnL;\n                                          }\n                                          // Fallback to netPnL\n                                          if (typeof d?.netPnL === 'number') return d.netPnL;\n                                          // Fallback to calculated P&L\n                                          if (typeof d?.totalProfit === 'number' || typeof d?.totalLoss === 'number') {\n                                            return (d?.totalProfit || 0) - Math.abs(d?.totalLoss || 0);\n                                          }\n                                          return 0;\n                                        };\n                                        const getDatePnLColor = (netPnL: number) => {\n                                          if (netPnL === 0) return "bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200";\n                                          const absValue = Math.abs(netPnL);\n                                          if (netPnL > 0) {\n                                            if (absValue >= 5000) return "bg-green-800 dark:bg-green-700 text-white";\n                                            if (absValue >= 3000) return "bg-green-700 dark:bg-green-600 text-white";\n                                            if (absValue >= 1500) return "bg-green-600 dark:bg-green-500 text-white";\n                                            if (absValue >= 500) return "bg-green-500 dark:bg-green-400 text-white";\n                                            return "bg-green-400 dark:bg-green-300 text-gray-800 dark:text-gray-900";\n                                          } else {\n                                            if (absValue >= 5000) return "bg-red-800 dark:bg-red-700 text-white";\n                                            if (absValue >= 3000) return "bg-red-700 dark:bg-red-600 text-white";\n                                            if (absValue >= 1500) return "bg-red-600 dark:bg-red-500 text-white";\n                                            if (absValue >= 500) return "bg-red-500 dark:bg-red-400 text-white";\n                                            return "bg-red-400 dark:bg-red-300 text-gray-800 dark:text-gray-900";\n                                          }\n                                        };\n\n                                        // Get color for HEATMAP selected date\n                                        const selectedDateData = heatmapSelectedDate ? tradingDataByDate[heatmapSelectedDate] : null;\n                                        const selectedDatePnL = selectedDateData ? getNetPnL(selectedDateData) : 0;\n                                        const dateButtonColor = heatmapSelectedDate ? getDatePnLColor(selectedDatePnL) : "";\n\n                                        return (\n                                          <Button\n                                            variant={heatmapSelectedDate ? "default" : "outline"}\n                                            size="sm"\n                                            className={`h-8 px-2 text-xs flex items-center gap-1 font-medium ${dateButtonColor}`}\n                                            title={heatmapSelectedDate ? `${heatmapSelectedDate}: P&L ₹${selectedDatePnL.toLocaleString('en-IN')}` : 'Click to select date from heatmap'}\n                                            data-testid="button-open-heatmap-picker"\n                                          >\n                                            <Calendar className="w-3.5 h-3.5" />\n                                            <span>{heatmapSelectedDate ? heatmapSelectedDate : 'No date selected'}</span>\n                                          </Button>\n                                        );\n                                      })()}\n                                    </PopoverTrigger>\n                                    <PopoverContent className="w-96 p-2" align="start">\n                                      <div className="text-xs font-semibold mb-2">Select Date from Heatmap</div>\n                                      <div className="grid grid-cols-7 gap-0.5 max-h-64 overflow-y-auto">\n                                        {Object.entries(tradingDataByDate)\n                                          .filter(([_, data]) => {\n                                            // Only show dates with actual trade history or trading data\n                                            if (data?.tradeHistory && Array.isArray(data.tradeHistory) && data.tradeHistory.length > 0) {\n                                              return true;\n                                            }\n                                            // Also include dates with performance metrics (actual trades)\n                                            const pnl = (data?.netPnL || 0) || ((data?.totalProfit || 0) - Math.abs(data?.totalLoss || 0));\n                                            return pnl !== 0; // Only show dates with non-zero P&L\n                                          })\n                                          .sort(([dateA], [dateB]) => dateB.localeCompare(dateA))\n                                          .slice(0, 10)\n                                          .map(([date, data]) => {\n                                            const getNetPnL = (d: any): number => {\n                                              if (!d) return 0;\n                                              // Try performanceMetrics first (like DemoHeatmap does)\n                                              if (d?.performanceMetrics?.netPnL !== undefined) {\n                                                return d.performanceMetrics.netPnL;\n                                              }\n                                              // Calculate from tradeHistory if no performanceMetrics\n                                              if (d?.tradeHistory && Array.isArray(d.tradeHistory)) {\n                                                let totalPnL = 0;\n                                                d.tradeHistory.forEach((trade: any) => {\n                                                  if (trade.pnl && typeof trade.pnl === 'string') {\n                                                    const pnlValue = parseFloat(trade.pnl.replace(/[₹,]/g, ''));\n                                                    if (!isNaN(pnlValue)) {\n                                                      totalPnL += pnlValue;\n                                                    }\n                                                  }\n                                                });\n                                                return totalPnL;\n                                              }\n                                              // Fallback to netPnL\n                                              if (typeof d?.netPnL === 'number') return d.netPnL;\n                                              // Fallback to calculated P&L\n                                              if (typeof d?.totalProfit === 'number' || typeof d?.totalLoss === 'number') {\n                                                return (d?.totalProfit || 0) - Math.abs(d?.totalLoss || 0);\n                                              }\n                                              return 0;\n                                            };\n                                            const getHeatmapColor = (netPnL: number) => {\n                                              if (netPnL === 0) return "bg-gray-100 dark:bg-gray-700";\n                                              const absValue = Math.abs(netPnL);\n                                              if (netPnL > 0) {\n                                                if (absValue >= 5000) return "bg-green-800 dark:bg-green-700";\n                                                if (absValue >= 3000) return "bg-green-700 dark:bg-green-600";\n                                                if (absValue >= 1500) return "bg-green-600 dark:bg-green-500";\n                                                if (absValue >= 500) return "bg-green-500 dark:bg-green-400";\n                                                return "bg-green-300 dark:bg-green-300";\n                                              } else {\n                                                if (absValue >= 5000) return "bg-red-800 dark:bg-red-700";\n                                                if (absValue >= 3000) return "bg-red-700 dark:bg-red-600";\n                                                if (absValue >= 1500) return "bg-red-600 dark:bg-red-500";\n                                                if (absValue >= 500) return "bg-red-500 dark:bg-red-400";\n                                                return "bg-red-300 dark:bg-red-300";\n                                              }\n                                            };\n                                            const pnl = getNetPnL(data);\n                                            const color = getHeatmapColor(pnl);\n                                            const isSelected = heatmapSelectedDate === date;\n\n                                            return (\n                                              <button\n                                                key={date}\n                                                onClick={() => {\n                                                  // Get symbol from trading data for this date\n                                                  const tradingData = tradingDataByDate[date];\n                                                  let symbolForDate = 'NSE:NIFTY50-INDEX'; // Default to NIFTY\n\n                                                  if (tradingData?.tradeHistory && tradingData.tradeHistory.length > 0) {\n                                                    const firstTrade = tradingData.tradeHistory[0];\n                                                    if (firstTrade.symbol) {\n                                                      // Format symbol for API (e.g., SENSEX -> NSE:SENSEX-INDEX)\n                                                      const cleanSym = firstTrade.symbol.replace(/NSE:|BSE:|-INDEX|-EQ/g, '');\n                                                      symbolForDate = `NSE:${cleanSym}-INDEX`;\n                                                    }\n                                                  }\n\n                                                  console.log(`🗓️ [HEATMAP CLICK] Date: ${date}, Symbol: ${symbolForDate}`);\n\n                                                  // Use separate heatmap chart - no conflict with search chart!\n                                                  fetchHeatmapChartData(symbolForDate, date);\n                                                }}\n                                                className={`h-6 text-xs font-medium rounded border ${color} ${heatmapSelectedDate === date ? 'ring-2 ring-purple-500 ring-offset-1' : 'border-gray-300 dark:border-gray-600'} hover:opacity-80 transition`}\n                                                title={`${date}: P&L ₹${pnl.toLocaleString('en-IN')}`}\n                                                data-testid={`button-heatmap-date-${date}`}\n                                              >\n                                                {new Date(date).getDate()}\n                                              </button>\n                                            );\n                                          })}\n                                      </div>\n                                    </PopoverContent>\n                                  </Popover>\n                                  )}\n\n                                  {/* X Button to Exit Heatmap Mode - ONLY in Heatmap Mode */}\n                                  {journalChartMode === 'heatmap' && (\n                                  <Button\n                                    size="icon"\n                                    variant="outline"\n                                    className="h-8 w-8"\n                                    onClick={() => {\n                                      console.log(`❌ Switching from heatmap to manual mode`);\n                                      setJournalChartMode('search');\n                                    }}\n                                    title="Switch to manual mode"\n                                    data-testid="button-exit-heatmap-mode"\n                                  >\n                                    <X className="w-3.5 h-3.5" />\n                                  </Button>\n                                  )}\n\n                                  {/* Search Chart Fetch Button - ONLY in Search Mode */}\n                                  {journalChartMode === 'search' && (\n                                  <Button\n                                    onClick={() => {\n                                      console.log(`🔶 SEARCH CHART: Fetching ${getJournalTimeframeLabel(journalChartTimeframe)} data for manual search`);\n                                      fetchJournalChartData();\n                                    }}\n                                    disabled={journalChartLoading}\n                                    variant="outline"\n                                    size="icon"\n                                    className="h-8 w-8"\n                                    title={`Fetch ${getJournalTimeframeLabel(journalChartTimeframe)} chart data (standalone search - last 10 days)`}\n                                    data-testid="button-fetch-journal-chart"\n                                  >\n                                    {journalChartLoading ? (\n                                      <div className="w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />\n                                    ) : (\n                                      <RefreshCw className="w-3.5 h-3.5" />\n                                    )}\n                                  </Button>\n                                  )}\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Chart Mode Toggle + Chart Container */}\n                            <div className="flex-1 relative flex flex-col h-full bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 p-0">\n\n                              {/* Mode Toggle Buttons */}\n                              <div className="hidden flex items-center justify-between px-2 py-1 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">\n                                <div className="flex items-center gap-1">\n                                  <button\n                                    onClick={() => setJournalChartMode('search')}\n                                    className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${\n                                      journalChartMode === 'search'\n                                        ? 'bg-blue-500 text-white'\n                                        : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'\n                                    }`}\n                                    data-testid="button-chart-mode-search"\n                                  >\n                                    <Search className="w-3 h-3 inline mr-1" />\n                                    Search\n                                  </button>\n                                  <button\n                                    onClick={() => setJournalChartMode('heatmap')}\n                                    className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${\n                                      journalChartMode === 'heatmap'\n                                        ? 'bg-purple-500 text-white'\n                                        : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'\n                                    }`}\n                                    data-testid="button-chart-mode-heatmap"\n                                  >\n                                    <CalendarDays className="w-3 h-3 inline mr-1" />\n                                    Heatmap\n                                  </button>\n                                </div>\n                                <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">\n                                  {journalChartMode === 'search' ? (\n                                    <span>Manual: {selectedJournalSymbol.replace('NSE:', '').replace('-INDEX', '').replace('-EQ', '') || 'Select symbol'}</span>\n                                  ) : (\n                                    <span>Date: {heatmapSelectedDate || 'Select date'} | {\n                                      (() => {\n                                        const sym = heatmapSelectedSymbol.replace('NSE:', '').replace('-INDEX', '').replace('-EQ', '');\n                                        // Extract underlying from options/futures (e.g., "NIFTY 22nd w MAY PE" -> "NIFTY50")\n                                        const parts = sym.split(' ');\n                                        if (parts.length > 1) {\n                                          const underlying = parts[0];\n                                          if (underlying === 'NIFTY') return 'NIFTY50';\n                                          if (underlying === 'FINNIFTY') return 'NIFTYFIN';\n                                          if (['SENSEX', 'BANKNIFTY', 'FINNIFTY', 'MIDCPNIFTY'].includes(underlying)) return underlying;\n                                        }\n                                        return sym || 'No symbol';\n                                      })()\n                                    }</span>\n                                  )}\n                                </div>\n                              </div>\n\n                              {/* ========== SEARCH CHART (Manual Symbol Search) ========== */}\n                              <div className={`flex-1 relative overflow-hidden ${journalChartMode === 'search' ? 'flex flex-col' : 'hidden'}`}>\n                                {journalChartLoading && (\n                                  <div className="absolute inset-0 z-50 flex items-center justify-center bg-white/95 dark:bg-gray-900/95 rounded-lg">\n                                    <div className="flex flex-col items-center gap-4">\n                                      <div className="relative">\n                                        <div className="w-14 h-14 border-4 border-blue-500/20 rounded-full" />\n                                        <div className="absolute inset-0 w-14 h-14 border-4 border-transparent border-t-blue-500 border-r-blue-500 rounded-full animate-spin" />\n                                      </div>\n                                      <div className="text-center">\n                                        <p className="text-sm font-medium text-gray-800 dark:text-gray-200">Loading {getJournalTimeframeLabel(journalChartTimeframe)} chart...</p>\n                                      </div>\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Search Chart OHLC Display */}\n                                {hoveredCandleOhlc && journalChartData && journalChartData.length > 0 && (\n                                  <div \n                                    className="absolute top-1 left-2 z-40 flex items-center gap-1 text-xs font-mono pointer-events-none"\n                                    data-testid="search-chart-ohlc-display"\n                                  >\n                                    <span className="text-green-600 dark:text-green-400 font-medium">\n                                      O{hoveredCandleOhlc.open.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className="text-gray-700 dark:text-gray-300 font-medium">\n                                      H{hoveredCandleOhlc.high.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className="text-gray-700 dark:text-gray-300 font-medium">\n                                      L{hoveredCandleOhlc.low.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className={`font-medium ${hoveredCandleOhlc.close >= hoveredCandleOhlc.open ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      C{hoveredCandleOhlc.close.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className={`font-medium ${hoveredCandleOhlc.change >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      {hoveredCandleOhlc.change >= 0 ? '+' : ''}{hoveredCandleOhlc.change.toFixed(2)}\n                                    </span>\n                                    <span className={`font-medium ${hoveredCandleOhlc.changePercent >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      ({hoveredCandleOhlc.changePercent >= 0 ? '+' : ''}{hoveredCandleOhlc.changePercent.toFixed(2)}%)\n                                    </span>\n                                  </div>\n                                )}\n\n                                {/* Search Chart Container */}\n                                <div \n                                  ref={journalChartContainerRef}\n                                  className="flex-1 w-full relative bg-white dark:bg-gray-800"\n                                  data-testid="search-chart-container"\n                                />\n\n                                {/* Search Chart - No Data Message */}\n                                {(!journalChartData || journalChartData.length === 0) && !journalChartLoading && (\n                                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">\n                                    <div className="text-center">\n                                      <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">\n                                        <Search className="h-8 w-8 text-blue-500 dark:text-blue-400" />\n                                      </div>\n                                      <div className="text-gray-900 dark:text-gray-100 font-medium mb-1">Search Mode</div>\n                                      <div className="text-gray-500 dark:text-gray-400 text-sm">Select a symbol and fetch to view chart</div>\n                                    </div>\n                                  </div>\n                                )}\n                              </div>\n\n                              {/* ========== HEATMAP CHART (Date Selection from Calendar) ========== */}\n                              <div className={`flex-1 relative overflow-hidden ${journalChartMode === 'heatmap' ? 'flex flex-col' : 'hidden'}`}>\n                                {heatmapChartLoading && (\n                                  <div className="absolute inset-0 z-50 flex items-center justify-center bg-white/95 dark:bg-gray-900/95 rounded-lg">\n                                    <div className="flex flex-col items-center gap-4">\n                                      <div className="relative">\n                                        <div className="w-14 h-14 border-4 border-purple-500/20 rounded-full" />\n                                        <div className="absolute inset-0 w-14 h-14 border-4 border-transparent border-t-purple-500 border-r-purple-500 rounded-full animate-spin" />\n                                      </div>\n                                      <div className="text-center">\n                                        <p className="text-sm font-medium text-gray-800 dark:text-gray-200">Loading heatmap chart...</p>\n                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Fetching {heatmapSelectedDate} data</p>\n                                      </div>\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Heatmap Chart OHLC Display */}\n                                {heatmapHoveredOhlc && heatmapChartData && heatmapChartData.length > 0 && (\n                                  <div \n                                    className="absolute top-1 left-2 z-40 flex items-center gap-1 text-xs font-mono pointer-events-none"\n                                    data-testid="heatmap-chart-ohlc-display"\n                                  >\n                                    <span className="text-green-600 dark:text-green-400 font-medium">\n                                      O{heatmapHoveredOhlc.open.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className="text-gray-700 dark:text-gray-300 font-medium">\n                                      H{heatmapHoveredOhlc.high.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className="text-gray-700 dark:text-gray-300 font-medium">\n                                      L{heatmapHoveredOhlc.low.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className={`font-medium ${heatmapHoveredOhlc.close >= heatmapHoveredOhlc.open ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      C{heatmapHoveredOhlc.close.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                    <span className={`font-medium ${heatmapHoveredOhlc.change >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      {heatmapHoveredOhlc.change >= 0 ? '+' : ''}{heatmapHoveredOhlc.change.toFixed(2)}\n                                    </span>\n                                    <span className={`font-medium ${heatmapHoveredOhlc.changePercent >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                      ({heatmapHoveredOhlc.changePercent >= 0 ? '+' : ''}{heatmapHoveredOhlc.changePercent.toFixed(2)}%)\n                                    </span>\n                                  </div>\n                                )}\n\n                                {/* Heatmap Chart Container */}\n                                <div \n                                  ref={heatmapChartContainerRef}\n                                  className="flex-1 w-full relative bg-white dark:bg-gray-800"\n                                  data-testid="heatmap-chart-container"\n                                />\n\n                                {/* Heatmap Chart - No Data Message */}\n                                {(!heatmapChartData || heatmapChartData.length === 0) && !heatmapChartLoading && (\n                                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">\n                                    <div className="text-center">\n                                      <div className="w-16 h-16 mx-auto mb-3 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">\n                                        <CalendarDays className="h-8 w-8 text-purple-500 dark:text-purple-400" />\n                                      </div>\n                                      <div className="text-gray-900 dark:text-gray-100 font-medium mb-1">Heatmap Mode</div>\n                                      <div className="text-gray-500 dark:text-gray-400 text-sm">Select a date from the heatmap calendar</div>\n                                    </div>\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Middle Block - Multiple Image Upload */}\n                      <div\n                        className={`h-[400px] ${mobileJournalPanel === 1 ? "block" : "hidden"} md:block`}\n                      >\n                        <MultipleImageUpload\n                          ref={imageUploadRef}\n                          images={tradingImages}\n                          onImagesChange={setTradingImages}\n                        />\n                      </div>\n\n                      {/* Right Block - PERFORMANCE STATS (Split: 30% top, 70% bottom) */}\n                      <Card\n                        className={`bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 h-[400px] flex flex-col ${mobileJournalPanel === 2 ? "block" : "hidden"} md:block`}\n                      >\n                        {/* Top 30% - Performance Insights */}\n                        <div className="h-[30%] border-b border-gray-200 dark:border-gray-700">\n                          <CardContent className="p-2 h-full">\n                            <div className="grid grid-cols-3 gap-2 text-xs">\n                              <div className="text-center">\n                                <p className="text-gray-600 dark:text-gray-400">\n                                  Total Trades\n                                </p>\n                                <p className="text-base font-bold text-gray-800 dark:text-white">\n                                  {performanceMetrics.totalTrades}\n                                </p>\n                              </div>\n                              <div className="text-center">\n                                <p className="text-gray-600 dark:text-gray-400">\n                                  Win Rate\n                                </p>\n                                <p className="text-xl font-bold text-green-600">\n                                  {performanceMetrics.winRate}%\n                                </p>\n                              </div>\n                              <div className="text-center">\n                                <p className="text-gray-600 dark:text-gray-400 text-xs">\n                                  Net P&L\n                                </p>\n                                <p\n                                  className={`text-xl font-bold ${\n                                    performanceMetrics.netPnL >= 0\n                                      ? "text-green-600"\n                                      : "text-red-600"\n                                  }`}\n                                >\n                                  ₹\n                                  {performanceMetrics.netPnL.toLocaleString(\n                                    "en-IN",\n                                  )}\n                                </p>\n                              </div>\n                            </div>\n\n                            <div className="grid grid-cols-2 gap-2 mt-2 text-xs">\n                              <div className="space-y-0.5 bg-white dark:bg-gray-900/50 rounded-lg p-2">\n                                <div className="flex justify-between">\n                                  <span className="text-gray-600 dark:text-gray-400">\n                                    Winning Trades:\n                                  </span>\n                                  <span className="text-green-600 font-medium">\n                                    {performanceMetrics.winningTrades}\n                                  </span>\n                                </div>\n                                <div className="flex justify-between">\n                                  <span className="text-gray-600 dark:text-gray-400">\n                                    Total Profit:\n                                  </span>\n                                  <span className="text-green-600 font-medium">\n                                    ₹\n                                    {performanceMetrics.totalProfit.toLocaleString(\n                                      "en-IN",\n                                    )}\n                                  </span>\n                                </div>\n                              </div>\n                              <div className="space-y-0.5 bg-white dark:bg-gray-900/50 rounded-lg p-2">\n                                <div className="flex justify-between">\n                                  <span className="text-gray-600 dark:text-gray-400">\n                                    Losing Trades:\n                                  </span>\n                                  <span className="text-red-600 font-medium">\n                                    {performanceMetrics.losingTrades}\n                                  </span>\n                                </div>\n                                <div className="flex justify-between">\n                                  <span className="text-gray-600 dark:text-gray-400">\n                                    Total Loss:\n                                  </span>\n                                  <span className="text-red-600 font-medium">\n                                    ₹\n                                    {performanceMetrics.totalLoss.toLocaleString(\n                                      "en-IN",\n                                    )}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </div>\n\n                        {/* Bottom 70% - Notes Section */}\n                        <div className="h-[70%] flex flex-col">\n                          <CardContent className="p-2 flex-1 flex flex-col h-full overflow-hidden">\n                            <div className="flex items-center justify-between mb-2">\n                              <h3 className="text-sm font-semibold text-gray-800 dark:text-white">\n                                TRADING NOTES\n                              </h3>\n                              <div className="flex items-center gap-1">\n                                {/* Daily Life Factors Dropdown */}\n                                <Popover\n                                  open={isDailyFactorsDropdownOpen}\n                                  onOpenChange={setIsDailyFactorsDropdownOpen}\n                                >\n                                  <PopoverTrigger asChild>\n                                    <Button\n                                      variant="ghost"\n                                      size="icon"\n                                      className="h-8 w-8"\n                                      data-testid="button-daily-factors-dropdown"\n                                    >\n                                      <Activity className="w-4 h-4" />\n                                    </Button>\n                                  </PopoverTrigger>\n                                  <PopoverContent className="w-80 p-3">\n                                    <div className="space-y-1">\n                                      <div className="flex items-center justify-between">\n                                        <h4 className="font-medium text-sm">\n                                          Daily Life Factors\n                                        </h4>\n                                        {selectedDailyFactors.length > 0 && (\n                                          <Button\n                                            variant="ghost"\n                                            size="sm"\n                                            onClick={clearAllDailyFactors}\n                                            className="text-xs text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"\n                                            data-testid="button-clear-daily-factors"\n                                          >\n                                            <Trash2 className="w-3 h-3 mr-1" />\n                                            Clear All\n                                          </Button>\n                                        )}\n                                      </div>\n\n                                      {/* Selected Factors Display */}\n                                      {selectedDailyFactors.length > 0 && (\n                                        <div className="flex flex-wrap gap-1 p-2 bg-gray-50 dark:bg-gray-900 rounded-md">\n                                          {selectedDailyFactors.map((factor) => (\n                                            <span\n                                              key={factor}\n                                              className="inline-flex items-center px-2 py-1 text-xs font-medium bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 rounded-full cursor-pointer hover:bg-amber-200 dark:hover:bg-amber-800 transition-colors"\n                                              onClick={() => toggleDailyFactor(factor)}\n                                              data-testid={`selected-daily-factor-${factor}`}\n                                            >\n                                              {factor}\n                                              <X className="w-3 h-3 ml-1" />\n                                            </span>\n                                          ))}\n                                        </div>\n                                      )}\n\n                                      {/* Available Factors by Category */}\n                                      <div className="space-y-3 max-h-96 overflow-y-auto custom-thin-scrollbar">\n                                        {Object.entries(dailyFactorsSystem).map(\n                                          ([categoryKey, category]) => (\n                                            <div\n                                              key={categoryKey}\n                                              className="space-y-2"\n                                            >\n                                              <div className="flex items-center justify-between">\n                                                <h5\n                                                  className={`text-xs font-semibold text-${category.color}-600 dark:text-${category.color}-400`}\n                                                >\n                                                  {category.name}\n                                                </h5>\n                                                <span className="text-xs text-gray-500">\n                                                  {\n                                                    selectedDailyFactors.filter((f) =>\n                                                      category.tags.includes(f),\n                                                    ).length\n                                                  }\n                                                  /{category.maxSelections}\n                                                </span>\n                                              </div>\n                                              <div className="grid grid-cols-2 gap-1">\n                                                {category.tags.map((factor) => {\n                                                  const isSelected =\n                                                    selectedDailyFactors.includes(factor);\n                                                  const categoryCount =\n                                                    selectedDailyFactors.filter((f) =>\n                                                      category.tags.includes(f),\n                                                    ).length;\n                                                  const isDisabled =\n                                                    !isSelected &&\n                                                    categoryCount >=\n                                                      category.maxSelections;\n\n                                                  return (\n                                                    <button\n                                                      key={factor}\n                                                      onClick={() =>\n                                                        toggleDailyFactor(factor)\n                                                      }\n                                                      disabled={isDisabled}\n                                                      className={`\n                                                  px-2 py-1.5 text-xs rounded-md border transition-all duration-200 text-left\n                                                  ${\n                                                    isSelected\n                                                      ? `bg-${category.color}-500 text-white border-${category.color}-500 hover:bg-${category.color}-600`\n                                                      : isDisabled\n                                                        ? "bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-600 border-gray-200 dark:border-gray-700 cursor-not-allowed"\n                                                        : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"\n                                                  }\n                                                `}\n                                                      data-testid={`daily-factor-option-${factor}`}\n                                                    >\n                                                      {factor}\n                                                    </button>\n                                                  );\n                                                })}\n                                              </div>\n                                            </div>\n                                          ),\n                                        )}\n                                      </div>\n                                    </div>\n                                  </PopoverContent>\n                                </Popover>\n\n                                {/* Indicators Dropdown */}\n                                <Popover\n                                  open={isIndicatorDropdownOpen}\n                                  onOpenChange={setIsIndicatorDropdownOpen}\n                                >\n                                  <PopoverTrigger asChild>\n                                    <Button\n                                      variant="ghost"\n                                      size="icon"\n                                      className="h-8 w-8"\n                                      data-testid="button-indicators-dropdown"\n                                    >\n                                      <BarChart3 className="w-4 h-4" />\n                                    </Button>\n                                  </PopoverTrigger>\n                                  <PopoverContent className="w-80 p-3">\n                                    <div className="space-y-1">\n                                      <div className="flex items-center justify-between">\n                                        <h4 className="font-medium text-sm">\n                                          Indicator & Timeframe Tracker\n                                        </h4>\n                                        {selectedIndicators.length > 0 && (\n                                          <Button\n                                            variant="ghost"\n                                            size="sm"\n                                            onClick={clearAllIndicators}\n                                            className="text-xs text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"\n                                            data-testid="button-clear-indicators"\n                                          >\n                                            <Trash2 className="w-3 h-3 mr-1" />\n                                            Clear All\n                                          </Button>\n                                        )}\n                                      </div>\n\n                                      {/* Timeframe Selector */}\n                                      <div className="space-y-1 bg-white dark:bg-gray-900/50 rounded-lg p-3">\n                                        <label className="text-xs font-semibold text-gray-700 dark:text-gray-300">\n                                          Timeframe\n                                        </label>\n                                        <div className="grid grid-cols-4 gap-1">\n                                          {timeframeOptions.map((tf) => (\n                                            <button\n                                              key={tf.value}\n                                              onClick={() => {\n                                                setIndicatorTimeframe(tf.value);\n                                                if (typeof window !== "undefined") {\n                                                  localStorage.setItem("indicatorTimeframe", tf.value);\n                                                }\n                                              }}\n                                              className={`px-2 py-1.5 text-xs rounded-md border transition-all duration-200 ${\n                                                indicatorTimeframe === tf.value\n                                                  ? "bg-emerald-500 text-white border-emerald-500 hover:bg-emerald-600"\n                                                  : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"\n                                              }`}\n                                              data-testid={`timeframe-${tf.value}`}\n                                            >\n                                              {tf.label}\n                                            </button>\n                                          ))}\n                                          {/* Display custom timeframe if selected */}\n                                          {!timeframeOptions.some((tf) => tf.value === indicatorTimeframe) && (\n                                            <button\n                                              onClick={() => {\n                                                // Clicking on custom timeframe shows it's selected\n                                              }}\n                                              className="px-2 py-1.5 text-xs rounded-md border bg-emerald-500 text-white border-emerald-500 transition-all duration-200 relative group"\n                                              data-testid={`timeframe-custom-${indicatorTimeframe}`}\n                                              title={`Custom: ${indicatorTimeframe}`}\n                                            >\n                                              <span className="truncate">{indicatorTimeframe}</span>\n                                              <button\n                                                onClick={(e) => {\n                                                  e.stopPropagation();\n                                                  setIndicatorTimeframe("5min");\n                                                  localStorage.setItem("indicatorTimeframe", "5min");\n                                                }}\n                                                className="absolute right-0.5 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity"\n                                                data-testid="button-remove-custom-timeframe"\n                                              >\n                                                <X className="w-2.5 h-2.5" />\n                                              </button>\n                                            </button>\n                                          )}\n                                          <Dialog open={isCustomTimeframeDialogOpen} onOpenChange={setIsCustomTimeframeDialogOpen}>\n                                            <DialogTrigger asChild>\n                                              <button\n                                                className="px-2 py-1.5 text-xs rounded-md border bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200"\n                                                data-testid="button-add-custom-timeframe"\n                                              >\n                                                <Plus className="w-3 h-3" />\n                                              </button>\n                                            </DialogTrigger>\n                                            <DialogContent className="sm:max-w-[300px]">\n                                              <DialogHeader>\n                                                <DialogTitle>Custom Timeframe</DialogTitle>\n                                              </DialogHeader>\n                                              <div className="space-y-1">\n                                                <input\n                                                  type="text"\n                                                  placeholder="e.g., 2h, 4h, 3d, 1w"\n                                                  value={customTimeframeInput}\n                                                  onChange={(e) => setCustomTimeframeInput(e.target.value)}\n                                                  className="w-full px-3 py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-800 dark:text-white"\n                                                  data-testid="input-custom-timeframe"\n                                                />\n                                                <div className="flex gap-1.5">\n                                                  <Button\n                                                    variant="outline"\n                                                    size="sm"\n                                                    onClick={() => {\n                                                      setCustomTimeframeInput("");\n                                                      setIsCustomTimeframeDialogOpen(false);\n                                                    }}\n                                                    className="flex-1 text-xs"\n                                                    data-testid="button-cancel-custom-timeframe"\n                                                  >\n                                                    Cancel\n                                                  </Button>\n                                                  <Button\n                                                    size="sm"\n                                                    onClick={() => {\n                                                      if (customTimeframeInput.trim()) {\n                                                        setIndicatorTimeframe(customTimeframeInput.trim());\n                                                        if (typeof window !== "undefined") {\n                                                          localStorage.setItem("indicatorTimeframe", customTimeframeInput.trim());\n                                                        }\n                                                        setCustomTimeframeInput("");\n                                                        setIsCustomTimeframeDialogOpen(false);\n                                                      }\n                                                    }}\n                                                    className="flex-1 text-xs bg-emerald-600 hover:bg-emerald-700 text-white"\n                                                    data-testid="button-confirm-custom-timeframe"\n                                                  >\n                                                    Apply\n                                                  </Button>\n                                                </div>\n                                              </div>\n                                            </DialogContent>\n                                          </Dialog>\n                                        </div>\n                                      </div>\n\n                                      {/* Selected Indicators Display */}\n                                      {selectedIndicators.length > 0 && (\n                                        <div className="flex flex-wrap gap-1 p-2 bg-gray-50 dark:bg-gray-900 rounded-md">\n                                          {selectedIndicators.map((indicator) => (\n                                            <span\n                                              key={indicator}\n                                              className="inline-flex items-center px-2 py-1 text-xs font-medium bg-emerald-100 dark:bg-emerald-900 text-emerald-800 dark:text-emerald-200 rounded-full cursor-pointer hover:bg-emerald-200 dark:hover:bg-emerald-800 transition-colors"\n                                              onClick={() => toggleIndicator(indicator)}\n                                              data-testid={`selected-indicator-${indicator}`}\n                                            >\n                                              {indicator}\n                                              <X className="w-3 h-3 ml-1" />\n                                            </span>\n                                          ))}\n                                        </div>\n                                      )}\n\n                                      {/* Available Indicators Grid */}\n                                      <div className="grid grid-cols-2 gap-1">\n                                        {indicatorList.map((indicator) => {\n                                          const isSelected = selectedIndicators.includes(indicator);\n                                          return (\n                                            <button\n                                              key={indicator}\n                                              onClick={() => toggleIndicator(indicator)}\n                                              className={`px-2 py-1.5 text-xs rounded-md border transition-all duration-200 text-left ${\n                                                isSelected\n                                                  ? "bg-emerald-500 text-white border-emerald-500 hover:bg-emerald-600"\n                                                  : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"\n                                              }`}\n                                              data-testid={`indicator-option-${indicator}`}\n                                            >\n                                              {indicator}\n                                            </button>\n                                          );\n                                        })}\n                                      </div>\n                                    </div>\n                                  </PopoverContent>\n                                </Popover>\n\n                                {/* Tag Dropdown */}\n                                <Popover\n                                  open={isTagDropdownOpen}\n                                  onOpenChange={setIsTagDropdownOpen}\n                                >\n                                  <PopoverTrigger asChild>\n                                    <Button\n                                      variant="ghost"\n                                      size="icon"\n                                      className="h-8 w-8"\n                                      data-testid="button-tags-dropdown"\n                                    >\n                                      <Brain className="w-4 h-4" />\n                                    </Button>\n                                  </PopoverTrigger>\n                                  <PopoverContent className="w-80 p-3">\n                                    <div className="space-y-1">\n                                      <div className="flex items-center justify-between">\n                                        <h4 className="font-medium text-sm">\n                                          Trading Psychology & Strategy Tags\n                                        </h4>\n                                        {selectedTags.length > 0 && (\n                                          <Button\n                                            variant="ghost"\n                                            size="sm"\n                                            onClick={clearAllTags}\n                                            className="text-xs text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"\n                                            data-testid="button-clear-tags"\n                                          >\n                                            <Trash2 className="w-3 h-3 mr-1" />\n                                            Clear All\n                                          </Button>\n                                        )}\n                                      </div>\n\n                                      {/* Selected Tags Display */}\n                                      {getValidTags(selectedTags).length > 0 && (\n                                        <div className="flex flex-wrap gap-1 p-2 bg-gray-50 dark:bg-gray-900 rounded-md">\n                                          {getValidTags(selectedTags).map((tag) => (\n                                            <span\n                                              key={tag}\n                                              className="inline-flex items-center px-2 py-1 text-xs font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-full cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors"\n                                              onClick={() => toggleTag(tag)}\n                                              data-testid={`selected-tag-${tag}`}\n                                            >\n                                              {tag}\n                                              <X className="w-3 h-3 ml-1" />\n                                            </span>\n                                          ))}\n                                        </div>\n                                      )}\n\n                                      {/* Available Tags by Category */}\n                                      <div className="space-y-4 max-h-96 overflow-y-auto custom-thin-scrollbar">\n                                        {Object.entries(tradingTagSystem).map(\n                                          ([categoryKey, category]) => (\n                                            <div\n                                              key={categoryKey}\n                                              className="space-y-2"\n                                            >\n                                              <div className="flex items-center justify-between">\n                                                <h5\n                                                  className={`text-xs font-semibold text-${category.color}-600 dark:text-${category.color}-400`}\n                                                >\n                                                  {category.name}\n                                                  {(category as any)\n                                                    .required && (\n                                                    <span className="text-red-500 ml-1">\n                                                      *\n                                                    </span>\n                                                  )}\n                                                </h5>\n                                                <span className="text-xs text-gray-500">\n                                                  {\n                                                    selectedTags.filter((tag) =>\n                                                      category.tags.includes(\n                                                        tag,\n                                                      ),\n                                                    ).length\n                                                  }\n                                                  /{category.maxSelections}\n                                                </span>\n                                              </div>\n                                              <div className="grid grid-cols-2 gap-1">\n                                                {category.tags.map((tag) => {\n                                                  const isSelected =\n                                                    selectedTags.includes(tag);\n                                                  const categoryCount =\n                                                    selectedTags.filter((t) =>\n                                                      category.tags.includes(t),\n                                                    ).length;\n                                                  const isDisabled =\n                                                    !isSelected &&\n                                                    categoryCount >=\n                                                      category.maxSelections;\n\n                                                  return (\n                                                    <button\n                                                      key={tag}\n                                                      onClick={() =>\n                                                        toggleTagWithValidation(\n                                                          tag,\n                                                        )\n                                                      }\n                                                      disabled={isDisabled}\n                                                      className={`\n                                                  px-2 py-1.5 text-xs rounded-md border transition-all duration-200 text-left\n                                                  ${\n                                                    isSelected\n                                                      ? `bg-${category.color}-500 text-white border-${category.color}-500 hover:bg-${category.color}-600`\n                                                      : isDisabled\n                                                        ? "bg-gray-100 dark:bg-gray-800 text-gray-400 dark:text-gray-600 border-gray-200 dark:border-gray-700 cursor-not-allowed"\n                                                        : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"\n                                                  }\n                                                `}\n                                                      data-testid={`tag-option-${tag}`}\n                                                    >\n                                                      {tag}\n                                                    </button>\n                                                  );\n                                                })}\n                                              </div>\n                                            </div>\n                                          ),\n                                        )}\n                                      </div>\n                                    </div>\n                                  </PopoverContent>\n                                </Popover>\n                                {isEditingNotes ? (\n                                  <>\n                                    <Button\n                                      size="icon"\n                                      variant="ghost"\n                                      onClick={handleCancelNotes}\n                                      className="h-7 w-7 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"\n                                      data-testid="button-cancel-notes"\n                                    >\n                                      <X className="w-3 h-3" />\n                                    </Button>\n                                    <Button\n                                      size="icon"\n                                      onClick={handleSaveNotesOnly}\n                                      className="h-7 w-7 bg-green-600 hover:bg-green-700 text-white"\n                                      data-testid="button-save-notes"\n                                    >\n                                      <Check className="w-3 h-3" />\n                                    </Button>\n                                  </>\n                                ) : (\n                                  <Button\n                                    size="sm"\n                                    variant="ghost"\n                                    onClick={handleEditNotes}\n                                    className="text-xs text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white"\n                                    data-testid="button-edit-notes"\n                                  >\n                                    <Edit className="w-3 h-3" />\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n\n                            {isEditingNotes ? (\n                              <textarea\n                                value={tempNotesContent}\n                                onChange={(e) =>\n                                  setTempNotesContent(e.target.value)\n                                }\n                                placeholder="Write your trading notes, strategies, observations..."\n                                className="flex-1 w-full p-2 text-xs border border-slate-200 dark:border-slate-800 rounded-lg bg-white dark:bg-slate-900 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"\n                                data-testid="textarea-notes"\n                              />\n                            ) : (\n                              <div className="flex-1 w-full p-2 text-xs border border-slate-200 dark:border-slate-800 rounded-lg bg-white dark:bg-slate-900 text-gray-800 dark:text-white overflow-y-auto custom-thin-scrollbar">\n                                {/* Display daily factors inline when they exist */}\n                                {selectedDailyFactors.length > 0 && (\n                                  <div className="mb-2 pb-2 border-b border-gray-300 dark:border-gray-600">\n                                    <div className="flex flex-wrap gap-1">\n                                      {selectedDailyFactors.map((factor) => (\n                                        <span\n                                          key={factor}\n                                          className="inline-flex items-center px-1.5 py-0.5 text-xs font-medium bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-200 rounded-full cursor-pointer hover:bg-amber-200 dark:hover:bg-amber-700 transition-colors group"\n                                          onClick={() => toggleDailyFactor(factor)}\n                                          title="Click to remove daily factor"\n                                          data-testid={`inline-daily-factor-${factor}`}\n                                        >\n                                          {factor}\n                                          <X className="w-3 h-3 ml-1 opacity-60 group-hover:opacity-100" />\n                                        </span>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Display indicators inline when they exist */}\n                                {selectedIndicators.length > 0 && (\n                                  <div className="mb-2 pb-2 border-b border-gray-300 dark:border-gray-600">\n                                    <div className="flex flex-wrap gap-1">\n                                      {selectedIndicators.map((indicator) => (\n                                        <span\n                                          key={indicator}\n                                          className="inline-flex items-center px-1.5 py-0.5 text-xs font-medium bg-emerald-100 dark:bg-emerald-800 text-emerald-800 dark:text-emerald-200 rounded-full cursor-pointer hover:bg-emerald-200 dark:hover:bg-emerald-700 transition-colors group"\n                                          onClick={() => toggleIndicator(indicator)}\n                                          title="Click to remove indicator"\n                                          data-testid={`inline-indicator-${indicator}`}\n                                        >\n                                          {indicator}\n                                          <X className="w-3 h-3 ml-1 opacity-60 group-hover:opacity-100" />\n                                        </span>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Display tags inline when they exist */}\n                                {/* Display tags inline when they exist */}\n                                {getValidTags(selectedTags).length > 0 && (\n                                  <div className="mb-2 pb-2 border-b border-gray-300 dark:border-gray-600">\n                                    <div className="flex flex-wrap gap-1">\n                                      {getValidTags(selectedTags).map((tag) => (\n                                        <span\n                                          key={tag}\n                                          className="inline-flex items-center px-1.5 py-0.5 text-xs font-medium bg-indigo-100 dark:bg-indigo-800 text-indigo-800 dark:text-indigo-200 rounded-full cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-700 transition-colors group"\n                                          onClick={() => toggleTag(tag)}\n                                          title="Click to remove tag"\n                                          data-testid={`inline-tag-${tag}`}\n                                        >\n                                          {tag}\n                                          <X className="w-3 h-3 ml-1 opacity-60 group-hover:opacity-100" />\n                                        </span>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* Notes content */}\n                                {notesContent ? (\n                                  <pre className="font-sans text-xs overflow-y-auto flex-1 whitespace-pre">\n                                    {notesContent}\n                                  </pre>\n                                ) : (\n                                  <p className="text-gray-500 dark:text-gray-400 italic">\n                                    No trading notes yet. Click Edit to add your\n                                    first note.\n                                  </p>\n                                )}\n                              </div>\n                            )}\n                          </CardContent>\n                        </div>\n                      </Card>\n                    </div>\n\n                    {/* Mobile Navigation Arrows - Bottom of panels */}\n                    <div className="md:hidden flex items-center justify-between mt-4 gap-4">\n                      <Button\n                        variant="outline"\n                        onClick={() =>\n                          setMobileJournalPanel((prev) =>\n                            prev === 0 ? 2 : prev - 1,\n                          )\n                        }\n                        className="flex-1 h-12"\n                        data-testid="button-journal-prev"\n                      >\n                        <ChevronLeft className="h-5 w-5 mr-2" />\n                        <span className="text-sm font-medium">\n                          {mobileJournalPanel === 0\n                            ? "Notes"\n                            : mobileJournalPanel === 1\n                              ? "Chart"\n                              : "Upload"}\n                        </span>\n                      </Button>\n                      <div className="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-md">\n                        <div className="text-xs text-gray-500 dark:text-gray-400">\n                          Current\n                        </div>\n                        <div className="text-sm font-medium text-gray-700 dark:text-gray-300">\n                          {mobileJournalPanel === 0\n                            ? "Chart"\n                            : mobileJournalPanel === 1\n                              ? "Upload"\n                              : "Notes"}\n                        </div>\n                      </div>\n                      <Button\n                        variant="outline"\n                        onClick={() =>\n                          setMobileJournalPanel((prev) =>\n                            prev === 2 ? 0 : prev + 1,\n                          )\n                        }\n                        className="flex-1 h-12"\n                        data-testid="button-journal-next"\n                      >\n                        <span className="text-sm font-medium">\n                          {mobileJournalPanel === 0\n                            ? "Upload"\n                            : mobileJournalPanel === 1\n                              ? "Notes"\n                              : "Chart"}\n                        </span>\n                        <ChevronRight className="h-5 w-5 ml-2" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  {/* Two Column Layout: TRADE HISTORY SUMMARY (Left) and PROFIT CONSISTENCY (Right) */}\n                  {/* Desktop: 2-column grid | Mobile: Show Trade Book with collapsible Trade History */}\n                  <div className="space-y-4 md:space-y-0 md:grid md:grid-cols-2 gap-6">\n\n                    {/* Mobile: TRADE HISTORY SUMMARY - DROPDOWN HEADER */}\n                    <div className="md:hidden">\n                      <Button\n                        variant="ghost"\n                        onClick={() => setShowMobileTradeHistory(!showMobileTradeHistory)}\n                        className="w-full flex items-center justify-between h-12 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg px-4"\n                        data-testid="button-mobile-trade-history-toggle"\n                      >\n                        <div className="flex items-center gap-2">\n                          <span className="text-sm font-medium text-slate-700 dark:text-slate-300 uppercase tracking-wide">\n                            Trade History Summary\n                          </span>\n                        </div>\n                        <div className="flex items-center gap-3">\n                          <div className="px-2 py-0.5 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded text-[10px] font-bold text-blue-600 dark:text-blue-400 flex items-center">\n                            <Timer className="h-3 w-3 mr-1" />\n                            {calculateTotalDuration(tradeHistoryData)}\n                          </div>\n                          <Button\n                            variant="ghost"\n                            size="icon"\n                            className="h-7 w-7 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-full"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              setShowJournalInfoModal("manual");\n                            }}\n                            data-testid="button-journal-info-mobile"\n                          >\n                            <Info className="h-4 w-4 text-slate-600 dark:text-slate-400" />\n                          </Button>\n                          {showMobileTradeHistory ? (\n                            <ChevronUp className="h-5 w-5 text-slate-400" />\n                          ) : (\n                            <ChevronDown className="h-5 w-5 text-slate-400" />\n                          )}\n                        </div>\n                      </Button>\n\n                      {showMobileTradeHistory && (\n                        <Card className="mt-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 max-h-[420px] overflow-hidden">\n                          <CardContent className="p-3">\n                            <div className="flex items-center justify-between mb-3 gap-2">\n                              <div className="flex gap-1.5 overflow-x-auto custom-thin-scrollbar pb-1">\n                                <Button\n                                  variant="ghost"\n                                  size="sm"\n                                  onClick={() => setShowConnectDialog(true)}\n                                  className="h-7 px-2 text-xs shrink-0"\n                                  data-testid="button-connect-mobile"\n                                >\n                                  Connect\n                                </Button>\n                                {zerodhaIsConnected && (\n                                  <Button\n                                    variant="ghost"\n                                    size="sm"\n                                    className="h-7 px-2 text-xs shrink-0"\n                                    onClick={() => setShowOrderModal(true)}\n                                    data-testid="button-broker-orders-zerodha-mobile"\n                                  >\n                                    <img \n                                      src="https://zerodha.com/static/images/products/kite-logo.svg" \n                                      alt="Zerodha" \n                                      className="h-4 w-4"\n                                    />\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n\n                            <div className="max-h-80 overflow-y-auto overflow-x-auto custom-thin-scrollbar">\n                              <table className="text-xs w-full" style={{minWidth: "600px"}}>\n                                <thead className="sticky top-0 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">\n                                  <tr>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">Time</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[50px]">Order</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[80px]">Symbol</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[45px]">Type</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[40px]">Qty</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">Price</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">P&L</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[45px]">%</th>\n                                    <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[50px]">Duration</th>\n                                  </tr>\n                                </thead>\n                                <tbody className="bg-white dark:bg-slate-900">\n                                  {tradeHistoryData.length === 0 ? (\n                                    <tr>\n                                      <td colSpan={9} className="p-6 text-center text-xs text-slate-500 dark:text-slate-400">\n                                        No data yet\n                                      </td>\n                                    </tr>\n                                  ) : (\n                                    tradeHistoryData.map((trade, index) => (\n                                      <tr key={index} className="border-b border-slate-100 dark:border-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">\n                                        <td className="px-2 py-2 text-slate-600 dark:text-slate-400">{trade.time}</td>\n                                        <td className="px-2 py-2">\n                                          <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${\n                                            trade.order === "BUY" ? "bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300" : "bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300"\n                                          }`}>\n                                            {trade.order}\n                                          </span>\n                                        </td>\n                                        <td className="px-2 py-2 text-slate-700 dark:text-slate-300 font-medium truncate max-w-[100px]">\n                                          {trade.symbol}\n                                        </td>\n                                        <td className="px-2 py-2 text-indigo-600 dark:text-indigo-300 font-semibold">MIS</td>\n                                        <td className="px-2 py-2 text-slate-600 dark:text-slate-400">{trade.qty}</td>\n                                        <td className="px-2 py-2 text-amber-600 dark:text-amber-300 font-medium">₹{typeof trade.price === "number" ? trade.price.toFixed(2) : trade.price}</td>\n                                        <td className={`px-2 py-2 font-bold ${(trade.pnl || "").includes("+") ? "text-emerald-600" : "text-red-600"}`}>\n                                          {trade.pnl}\n                                        </td>\n                                        <td className="px-2 py-2 font-bold text-slate-600 dark:text-slate-400">\n                                          {(() => {\n                                            if (!trade.pnl || trade.pnl === "-") return "-";\n                                            const pnlStr = (trade.pnl || "").replace(/[₹,+\s]/g, "");\n                                            const pnlValue = parseFloat(pnlStr) || 0;\n                                            const openPrice = trade.price;\n                                            const totalInvestment = openPrice * trade.qty || 1;\n                                            const percentage = (pnlValue / totalInvestment) * 100;\n                                            return `${percentage >= 0 ? "+" : ""}${percentage.toFixed(2)}%`;\n                                          })()}\n                                        </td>\n                                        <td className="px-2 py-2 text-violet-600 dark:text-violet-300 font-medium">{normalizeDurationForDisplay(trade.duration)}</td>\n                                      </tr>\n                                    ))\n                                  )}\n                                </tbody>\n                                  </table>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      )}\n                    </div>\n                    {/* Desktop: TRADE HISTORY SUMMARY - Left Side - MINIMALIST WITH BRIGHT COLORS */}\n                    <Card className="hidden md:block bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 h-[420px]">\n                      <CardContent className="p-3">\n                        <div className="flex items-center justify-between mb-3 gap-2">\n                          <h3 className="text-sm font-medium text-slate-700 dark:text-slate-300 uppercase tracking-wide">\n                            Trade History\n                          </h3>\n                          <div className="flex gap-1.5">\n                            <Button\n                              variant="ghost"\n                              size="sm"\n                              onClick={() => setShowConnectDialog(true)}\n                              className="h-7 px-2 text-xs"\n                              data-testid="button-connect"\n                            >\n                              Connect\n                            </Button>\n                            {zerodhaIsConnected && (\n                              <Button\n                                variant="ghost"\n                                size="sm"\n                                className="h-7 px-2 text-xs"\n                                onClick={() => setShowOrderModal(true)}\n                                data-testid="button-broker-orders-zerodha"\n                                title="View Orders & Positions (Zerodha)"\n                              >\n                                <img \n                                  src="https://zerodha.com/static/images/products/kite-logo.svg" \n                                  alt="Zerodha" \n                                  className="h-4 w-4"\n                                />\n                              </Button>\n                            )}\n                            {upstoxIsConnected && (\n                              <Button\n                                variant="ghost"\n                                size="sm"\n                                className="h-7 px-2 text-xs"\n                                onClick={() => setShowOrderModal(true)}\n                                data-testid="button-broker-orders-upstox"\n                                title="View Orders & Positions (Upstox)"\n                              >\n                                <img \n                                  src="https://assets.upstox.com/content/assets/images/cms/202494/MediumWordmark_UP(WhiteOnPurple).png" \n                                  alt="Upstox" \n                                  className="h-4 w-4"\n                                />\n                              </Button>\n                            )}\n                            {angelOneIsConnected && (\n                              <Button\n                                variant="ghost"\n                                size="sm"\n                                className="h-7 px-2 text-xs"\n                                onClick={() => setShowOrderModal(true)}\n                                data-testid="button-broker-orders-angelone"\n                                title="View Orders & Positions (Angel One)"\n                              >\n                                <img \n                                  src="https://play-lh.googleusercontent.com/Ic8lUYwMCgTePpo-Gbg0VwE_0srDj1xD386BvQHO_mOwsfMjX8lFBLl0Def28pO_Mvk=s48-rw?v=1701" \n                                  alt="Angel One" \n                                  className="h-4 w-4"\n                                />\n                              </Button>\n                            )}\n                            {dhanIsConnected && (\n                              <Button\n                                variant="ghost"\n                                size="sm"\n                                className="h-7 px-2 text-xs"\n                                onClick={() => setShowOrderModal(true)}\n                                data-testid="button-broker-orders-dhan"\n                                title="View Orders & Positions (Dhan)"\n                              >\n                                <img \n                                  src="https://play-lh.googleusercontent.com/lVXf_i8Gi3C7eZVWKgeG8U5h_kAzUT0MrmvEAXfM_ihlo44VEk01HgAi6vbBNsSzBQ=w240-h480-rw?v=1701" \n                                  alt="Dhan" \n                                  className="h-4 w-4"\n                                />\n                              </Button>\n                            )}\n                            <Button\n                              variant="ghost"\n                              size="sm"\n                              onClick={() => setShowImportModal(true)}\n                              className="h-7 px-2 text-xs"\n                              data-testid="button-import-pnl"\n                            >\n                              Import\n                            </Button>\n                            <Button\n                              variant="ghost"\n                              size="sm"\n                              onClick={() => setShowPaperTradingModal(true)}\n                              className="h-7 px-2 text-xs hidden md:flex items-center gap-1"\n                              data-testid="button-paper-trade"\n                            >\n                              <TrendingUp className="h-4 w-4 mr-1" />\n                              Paper Trade\n                            </Button>\n                            <Button\n                              variant="ghost"\n                              size="icon"\n                              onClick={() => setShowTradingChallengeModal(true)}\n                              className="h-7 w-7"\n                              data-testid="button-trading-challenge"\n                              title="Trading Challenge"\n                            >\n                              <Trophy className="h-4 w-4" />\n                            </Button>\n                            <Button\n                              variant="ghost"\n                              size="icon"\n                              onClick={() => setShowJournalInfoModal("manual")}\n                              className="h-7 w-7 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-full"\n                              data-testid="button-journal-info"\n                              title="Journal Information"\n                            >\n                              <Info className="h-4 w-4 text-slate-600 dark:text-slate-400" />\n                            </Button>\n                            <div className="h-7 px-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700 rounded-md flex items-center justify-center text-xs font-semibold text-blue-600 dark:text-blue-300">\n                              <Timer className="h-4 w-4 mr-1.5" />\n                              {calculateTotalDuration(tradeHistoryData)}\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className="max-h-80 overflow-y-auto overflow-x-auto custom-thin-scrollbar">\n                          <table className="text-xs" style={{minWidth: "100%"}}>\n                            <thead className="sticky top-0 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">\n                              <tr>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">Time</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[50px]">Order</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[80px]">Symbol</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[45px]">Type</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[40px]">Qty</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">Price</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[60px]">P&L</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[45px]">%</th>\n                                <th className="px-2 py-2 text-left text-slate-600 dark:text-slate-400 font-medium min-w-[50px]">Duration</th>\n                              </tr>\n                            </thead>\n                            <tbody className="bg-white dark:bg-slate-900">\n                              {isLoadingHeatmapData && tradeHistoryData.length === 0 ? (\n                                <tr>\n                                  <td colSpan={9} className="p-6 text-center">\n                                    <div className="flex flex-col items-center gap-2">\n                                      <div className="w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>\n                                      <span className="text-xs text-slate-500 dark:text-slate-400">Loading...</span>\n                                    </div>\n                                  </td>\n                                </tr>\n                              ) : tradeHistoryData.length === 0 ? (\n                                <tr>\n                                  <td colSpan={9} className="p-6 text-center text-xs text-slate-500 dark:text-slate-400">\n                                    {!isDemoMode \n                                      ? "No data yet" \n                                      : selectedDate \n                                        ? "No trades for this date" \n                                        : "Select a date to view trades"}\n                                  </td>\n                                </tr>\n                              ) : (\n                                tradeHistoryData.map((trade, index) => (\n                                  <tr\n                                    key={index}\n                                    className="border-b border-slate-100 dark:border-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors"\n                                  >\n                                    <td className="px-2 py-2 text-slate-600 dark:text-slate-400">{trade.time}</td>\n                                    <td className="px-2 py-2">\n                                      <span\n                                        className={`text-xs font-bold px-1.5 py-0.5 rounded ${\n                                          trade.order === "BUY"\n                                            ? "bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300"\n                                            : "bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300"\n                                        }`}\n                                      >\n                                        {trade.order}\n                                      </span>\n                                    </td>\n                                    <td className="px-2 py-2 text-slate-700 dark:text-slate-300 font-medium">\n                                      {(() => {\n                                        if (!selectedDate) return trade.symbol;\n                                        const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];\n                  {/* Desktop: TRADE HISTORY SUMMARY - Left Side - MINIMALIST WITH BRIGHT COLORS */}\n                                        const selectedMonth = monthNames[selectedDate.getMonth()];\n                                        const symbolWithoutMonth = trade.symbol.replace(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/, selectedMonth);\n                                        return symbolWithoutMonth;\n                                      })()}\n                                    </td>\n                                    <td className="px-2 py-2 text-indigo-600 dark:text-indigo-300 font-semibold">MIS</td>\n                                    <td className="px-2 py-2 text-slate-600 dark:text-slate-400">{trade.qty}</td>\n                                    <td className="px-2 py-2 text-amber-600 dark:text-amber-300 font-medium">₹{typeof trade.price === "number" ? trade.price.toFixed(2) : trade.price}</td>\n                                    <td\n                                      className={`px-2 py-2 font-bold ${\n                                        (trade.pnl || "").includes("+")\n                                          ? "text-emerald-600 dark:text-emerald-400"\n                                          : (trade.pnl || "").includes("-")\n                                            ? "text-red-600 dark:text-red-400"\n                                            : "text-slate-600 dark:text-slate-400"\n                                      }`}\n                                    >\n                                      {trade.pnl}\n                                    </td>\n                                    <td\n                                      className={`px-2 py-2 font-bold ${(() => {\n                                        if (!trade.pnl || trade.pnl === "-")\n                                          return "text-slate-400";\n                                        const pnlStr = (trade.pnl || "").replace(\n                                          /[₹,+\s]/g,\n                                          "",\n                                        );\n                                        const pnlValue = parseFloat(pnlStr) || 0;\n                                        const openPrice = trade.price;\n                                        const totalInvestment =\n                                          openPrice * trade.qty || 1;\n                                        const percentage =\n                                          (pnlValue / totalInvestment) * 100;\n                                        return percentage > 0\n                                          ? "text-emerald-600 dark:text-emerald-400"\n                                          : percentage < 0\n                                            ? "text-red-600 dark:text-red-400"\n                                            : "text-slate-600";\n                                      })()}`}\n                                    >\n                                      {(() => {\n                                        if (!trade.pnl || trade.pnl === "-")\n                                          return "-";\n                                        const pnlStr = (trade.pnl || "").replace(\n                                          /[₹,+\s]/g,\n                                          "",\n                                        );\n                                        const pnlValue = parseFloat(pnlStr) || 0;\n                                        const openPrice = trade.price;\n                                        const totalInvestment =\n                                          openPrice * trade.qty || 1;\n                                        const percentage =\n                                          (pnlValue / totalInvestment) * 100;\n                                        return `${\n                                          percentage >= 0 ? "+" : ""\n                                        }${percentage.toFixed(2)}%`;\n                                      })()}\n                                    </td>\n                                    <td className="px-2 py-2 text-violet-600 dark:text-violet-300 font-medium">{normalizeDurationForDisplay(trade.duration)}</td>\n                                  </tr>\n                                ))\n                              )}\n                            </tbody>\n                          </table>\n                        </div>\n                      </CardContent>\n\n                    </Card>\n                    {/* Connect Dialog - Shows Zerodha and Upstox broker options */}\n                    <Dialog open={showConnectDialog} onOpenChange={setShowConnectDialog}>\n                      <DialogContent className="max-w-md">\n                        <DialogHeader>\n                          <DialogTitle>Connect Your Broker</DialogTitle>\n                        </DialogHeader>\n                        <div className="space-y-3">\n                          {zerodhaIsConnected ? (\n                            <div className="flex items-center gap-2">\n                              <Button\n                                variant="outline"\n                                className="flex-1 h-10 bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700 cursor-default"\n                                data-testid="button-zerodha-connected-display"\n                              >\n                                <img \n                                  src="https://zerodha.com/static/images/products/kite-logo.svg" \n                                  alt="Zerodha" \n                                  className="w-4 h-4 mr-2"\n                                />\n                                Zerodha\n                              </Button>\n                              <Button \n                                variant="ghost" \n                                size="icon" \n                                className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 h-10 w-10 border border-slate-200 hover:border-red-100"\n                                onClick={() => {\n                                  localStorage.removeItem("zerodha_token"); document.cookie = "zerodha_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";\n                                  setZerodhaAccessToken(null);\n                                  setZerodhaIsConnected(false);\n                                }}\n                                title="Disconnect Zerodha"\n                              >\n                                <X className="h-4 w-4" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <Button\n                              onClick={handleZerodhaConnect}\n                              variant="outline"\n                              className={`w-full h-10 ${\n                                (upstoxIsConnected || angelOneIsConnected || dhanIsConnected)\n                                  ? 'bg-slate-100 dark:bg-slate-900 text-slate-400 dark:text-slate-600 border-slate-300 dark:border-slate-700 cursor-not-allowed opacity-50'\n                                  : 'bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700'\n                              }`}\n                              data-testid="button-zerodha-dialog"\n                              disabled={upstoxIsConnected || angelOneIsConnected || dhanIsConnected}\n                            >\n                              <img \n                                src="https://zerodha.com/static/images/products/kite-logo.svg" \n                                alt="Zerodha" \n                                className="w-4 h-4 mr-2"\n                              />\n                              Zerodha\n                            </Button>\n                          )}\n                          {upstoxIsConnected ? (\n                            <div className="flex items-center gap-2">\n                              <Button\n                                variant="outline"\n                                className="flex-1 h-10 bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700 cursor-default"\n                                data-testid="button-upstox-connected-display"\n                              >\n                                <img src="https://assets.upstox.com/content/assets/images/cms/202494/MediumWordmark_UP(WhiteOnPurple).png" alt="Upstox" className="h-4 mr-2" />\n                                Upstox\n                              </Button>\n                              <Button \n                                variant="ghost" \n                                size="icon" \n                                className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 h-10 w-10 border border-slate-200 hover:border-red-100"\n                                onClick={handleUpstoxDisconnect}\n                                title="Disconnect Upstox"\n                              >\n                                <X className="h-4 w-4" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <Button\n                              variant="outline"\n                              className={`w-full h-10 ${\n                                (zerodhaIsConnected || angelOneIsConnected || dhanIsConnected)\n                                  ? 'bg-slate-100 dark:bg-slate-900 text-slate-400 dark:text-slate-600 border-slate-300 dark:border-slate-700 cursor-not-allowed opacity-50'\n                                  : 'bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700'\n                              }`}\n                              data-testid="button-upstox-dialog"\n                              onClick={handleUpstoxConnect}\n                              disabled={zerodhaIsConnected || angelOneIsConnected || dhanIsConnected}\n                            >\n                              <img src="https://assets.upstox.com/content/assets/images/cms/202494/MediumWordmark_UP(WhiteOnPurple).png" alt="Upstox" className="h-4 mr-2" />\n                              Upstox\n                            </Button>\n                          )}\n                          {angelOneIsConnected ? (\n                            <div className="flex items-center gap-2">\n                              <Button\n                                variant="outline"\n                                className="flex-1 h-10 bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700 cursor-default"\n                                data-testid="button-angelone-connected-display"\n                              >\n                                <img src="https://play-lh.googleusercontent.com/Ic8lUYwMCgTePpo-Gbg0VwE_0srDj1xD386BvQHO_mOwsfMjX8lFBLl0Def28pO_Mvk=s48-rw?v=1701" alt="Angel One" className="h-4 mr-2" />\n                                Angel One\n                              </Button>\n                              <Button \n                                variant="ghost" \n                                size="icon" \n                                className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 h-10 w-10 border border-slate-200 hover:border-red-100"\n                                onClick={() => {\n                                  localStorage.removeItem("angel_one_token");\n                                  setAngelOneAccessToken(null);\n                                  setAngelOneIsConnected(false);\n                                }}\n                                title="Disconnect Angel One"\n                              >\n                                <X className="h-4 w-4" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <Button\n                              variant="outline"\n                              className={`w-full h-10 ${\n                                (zerodhaIsConnected || upstoxIsConnected || dhanIsConnected)\n                                  ? 'bg-slate-100 dark:bg-slate-900 text-slate-400 dark:text-slate-600 border-slate-300 dark:border-slate-700 cursor-not-allowed opacity-50'\n                                  : 'bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700'\n                              }`}\n                              data-testid="button-angelone-dialog"\n                              onClick={handleAngelOneConnect}\n                              disabled={zerodhaIsConnected || upstoxIsConnected || dhanIsConnected}\n                            >\n                              <img src="https://play-lh.googleusercontent.com/Ic8lUYwMCgTePpo-Gbg0VwE_0srDj1xD386BvQHO_mOwsfMjX8lFBLl0Def28pO_Mvk=s48-rw?v=1701" alt="Angel One" className="h-4 mr-2" />\n                              Angel One\n                            </Button>\n                          )}\n                          {dhanIsConnected ? (\n                            <div className="flex items-center gap-2">\n                              <Button\n                                variant="outline"\n                                className="flex-1 h-10 bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700 cursor-default"\n                                data-testid="button-dhan-connected-display"\n                              >\n                                <img src="https://play-lh.googleusercontent.com/lVXf_i8Gi3C7eZVWKgeG8U5h_kAzUT0MrmvEAXfM_ihlo44VEk01HgAi6vbBNsSzBQ=w240-h480-rw?v=1701" alt="Dhan" className="h-4 mr-2" />\n                                Dhan\n                              </Button>\n                              <Button \n                                variant="ghost" \n                                size="icon" \n                                className="text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 h-10 w-10 border border-slate-200 hover:border-red-100"\n                                onClick={() => {\n                                  localStorage.removeItem("dhan_token");\n                                  setDhanAccessToken(null);\n                                  setDhanIsConnected(false);\n                                }}\n                                title="Disconnect Dhan"\n                              >\n                                <X className="h-4 w-4" />\n                              </Button>\n                            </div>\n                          ) : (\n                            <Button\n                              onClick={handleDhanConnect}\n                              variant="outline"\n                              className={`w-full h-10 ${\n                                (zerodhaIsConnected || upstoxIsConnected || angelOneIsConnected)\n                                  ? 'bg-slate-100 dark:bg-slate-900 text-slate-400 dark:text-slate-600 border-slate-300 dark:border-slate-700 cursor-not-allowed opacity-50'\n                                  : 'bg-white dark:bg-slate-800 text-black dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700'\n                              }`}\n                              data-testid="button-dhan-dialog"\n                              disabled={zerodhaIsConnected || upstoxIsConnected || angelOneIsConnected}\n                            >\n                              <img src="https://play-lh.googleusercontent.com/lVXf_i8Gi3C7eZVWKgeG8U5h_kAzUT0MrmvEAXfM_ihlo44VEk01HgAi6vbBNsSzBQ=w240-h480-rw?v=1701" alt="Dhan" className="h-4 mr-2" />\n                              Dhan\n                            </Button>\n                          )}\n\n                          <p className="text-xs text-center text-muted-foreground mt-4">\n                            Connect your broker account to auto-import trades\n                          </p>\n                        </div>\n                      </DialogContent>\n                    </Dialog>\n\n                    {/* Trade Book - Right Side (Functional Calendar) */}\n                    <div className="relative">\n                    <Card className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800">\n                      <CardContent className="p-6 px-0.5 md:px-4 md:py-4 pt-[10px] pb-[10px]">\n                        <div className="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2 flex items-center justify-between gap-2">\n                          <div className="flex items-center gap-1">\n                            <div>Trade Book</div>\n                            <Dialog>\n                              <DialogTrigger asChild>\n                                <Button size="icon" variant="ghost" className="h-4 w-4" data-testid="button-tradebook-help">\n                                  <Headset className="h-3 w-3" />\n                                </Button>\n                              </DialogTrigger>\n                              <DialogContent className="max-w-[700px] p-0 overflow-hidden bg-white dark:bg-slate-900 border-none rounded-xl shadow-2xl">\n                                <div className="flex flex-col md:flex-row h-full min-h-[350px]">\n                                  {/* Left Side: Card Display */}\n                                  <div className="w-full md:w-1/2 p-8 bg-slate-100 dark:bg-slate-800 flex items-center justify-center relative overflow-hidden border-r border-slate-200 dark:border-slate-700">\n                                    <div className="absolute inset-0 opacity-10">\n                                      <div className="absolute top-[-20%] left-[-20%] w-[140%] h-[140%] rounded-full bg-gradient-to-br from-violet-500 via-transparent to-transparent"></div>\n                                    </div>\n                                    <motion.div key={selectedAudioTrack?.id || "none"} initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} transition={{ type: "spring", stiffness: 300, damping: 30 }} className={`relative w-full aspect-[1.6/1] rounded-2xl shadow-2xl flex flex-col justify-between border border-white/10 overflow-hidden`}>\n                                      {selectedAudioTrack?.youtubeId && (\n                                        <div className="absolute inset-0 z-0">\n                                          <img \n                                            src={`https://img.youtube.com/vi/${selectedAudioTrack.youtubeId}/maxresdefault.jpg`} \n                                            className="w-full h-full object-cover"\n                                            alt=""\n                                          />\n                                        </div>\n                                      )}\n                                      <div className="flex justify-between items-start">\n                                        <div className="text-[10px] font-medium tracking-widest text-black uppercase"></div>\n                                        <div className="text-[10px] font-bold text-green-400 uppercase tracking-wider"></div>\n                                      </div>\n                                      <div className="space-y-4">\n                                        <div className="flex items-center gap-2">\n                                          <div className="text-sm font-bold text-white tracking-[0.2em]"></div>\n                                          <button onClick={() => selectedAudioTrack?.youtubeId && window.open(`https://www.youtube.com/watch?v=${selectedAudioTrack.youtubeId}`, "_blank")} className="absolute bottom-4 right-4 z-10 hover:scale-110 transition-transform active:scale-95"><Info className="w-4 h-4 text-black" /></button>\n                                        </div>\n                                        <div className="flex justify-between items-end">\n                                          <div className="text-xs font-medium text-white/80 uppercase tracking-widest"></div>\n                                          <div className="text-[10px] font-mono text-black"></div>\n                                        </div>\n                                      </div>\n                                    </motion.div>\n                                  </div>\n                                  <div className="w-full md:w-1/2 flex flex-col bg-white dark:bg-slate-900">\n                                    <div className="p-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-center relative">\n                                      <div className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em] opacity-50">Mini Play</div>\n                                    </div>\n                                    \n                                    <div className="flex-1 overflow-y-auto p-4 space-y-4">\n                                      {/* Meditation Section */}\n                                      <div>\n                                        <h4 className="text-[10px] font-bold text-violet-500 uppercase tracking-widest mb-2 flex items-center gap-2">\n                                          <span className="w-1 h-1 rounded-full bg-violet-500"></span>\n                                          Meditation\n                                        </h4>\n                                        <div className="space-y-1">\n                                          {[\n                                            { title: "Deep Relaxation Meditation", duration: "10:05", id: "m1", youtubeId: "B7nkVhC10Gw" }\n                                          ].map((track) => (\n                                            <div key={track.id} onClick={() => setSelectedAudioTrack(track)} className="group flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 cursor-pointer transition-colors">\n                                              <div className="flex items-center gap-3">\n                                                <div className="w-6 h-6 rounded-full bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center group-hover:bg-violet-500 transition-colors">\n                                                  <Play className="w-3 h-3 text-violet-500 group-hover:text-white" />\n                                                </div>\n                                                <span className="text-xs font-medium text-slate-700 dark:text-slate-300">{track.title}</span>\n                                              </div>\n                                              <span className="text-[10px] font-mono text-slate-400">{track.duration}</span>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      </div>\n\n                                      {/* Psychology Section */}\n                                      <div>\n                                        <h4 className="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2 flex items-center gap-2">\n                                          <span className="w-1 h-1 rounded-full bg-blue-500"></span>\n                                          Psychology\n                                        </h4>\n                                        <div className="space-y-1">\n                                          {[\n                                            { title: 'Bruce Lee: "Your Greatest Enemy Is Within"', duration: "22:30", id: "p1", youtubeId: "KnppzfiZcgM" }\n                                          ].map((track) => (\n                                            <div key={track.id} onClick={() => setSelectedAudioTrack(track)} className="group flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 cursor-pointer transition-colors">\n                                              <div className="flex items-center gap-3">\n                                                <div className="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center group-hover:bg-blue-500 transition-colors">\n                                                  <Play className="w-3 h-3 text-blue-500 group-hover:text-white" />\n                                                </div>\n                                                <span className="text-xs font-medium text-slate-700 dark:text-slate-300">{track.title}</span>\n                                              </div>\n                                              <span className="text-[10px] font-mono text-slate-400">{track.duration}</span>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      </div>\n                                    </div>\n\n                                                                        {/* Footer / Now Playing Stub */}\n                                    <div className="p-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 space-y-3">\n                                      <div className="flex items-center justify-between gap-3">\n                                        <div className="flex items-center gap-3 flex-1 min-w-0">\n                                          <div className={`w-8 h-8 rounded bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg ${selectedAudioTrack ? "animate-none" : "animate-pulse"}`}>\n                                            <Music2 className="w-4 h-4 text-white" />\n                                          </div>\n                                          <div className="flex-1 min-w-0">\n                                            <div className="text-[10px] font-bold text-slate-900 dark:text-slate-100 truncate">\n                                              {selectedAudioTrack ? selectedAudioTrack.title : "Select a session"}\n                                            </div>\n                                            <div className="text-[9px] text-slate-500 uppercase tracking-tighter">\n                                              {selectedAudioTrack ? `Playing • ${selectedAudioTrack.duration}` : "Ready to play"}\n                                            <div id="youtube-audio-player" className="hidden"></div>\n                                            </div>\n                                          </div>\n                                        </div>\n                                        \n                                        {/* Audio Controls */}\n                                        <div className="flex items-center gap-1">\n                                          <Button size="icon" variant="ghost" className="h-6 w-6 text-slate-500 hover:text-slate-900 dark:hover:text-slate-100">\n                                            <SkipBack className="h-3 w-3" />\n                                          </Button>\n                                          <Button \n                                            size="icon" \n                                            variant="ghost" \n                                            className="h-8 w-8 text-violet-600 dark:text-violet-400 hover:bg-violet-50 dark:hover:bg-violet-900/20"\n                                            onClick={() => setIsAudioPlaying(!isAudioPlaying)}\n                                          >\n                                            {isAudioPlaying ? <Pause className="h-4 w-4 fill-current" /> : <Play className="h-4 w-4 fill-current" />}\n                                          </Button>\n                                          <Button size="icon" variant="ghost" className="h-6 w-6 text-slate-500 hover:text-slate-900 dark:hover:text-slate-100">\n                                            <SkipForward className="h-3 w-3" />\n                                          </Button>\n                                        </div>\n                                      </div>\n                                      \n                                      {/* Audio Progress Slider */}\n                                      <div className="px-1">\n                                        <div className="relative w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden cursor-pointer" onClick={(e) => { if (selectedAudioTrack && youtubePlayerRef.current && duration > 0) { const rect = e.currentTarget.getBoundingClientRect(); const x = e.clientX - rect.left; const clickedProgress = x / rect.width; const newTime = clickedProgress * duration; youtubePlayerRef.current.seekTo(newTime, true); setCurrentTime(newTime); setAudioProgress(clickedProgress * 100); } } }>\n                                          <div \n                                            className="absolute top-0 left-0 h-full bg-gradient-to-r from-violet-500 to-purple-600 transition-all duration-300"\n                                            style={{ width: `${selectedAudioTrack ? audioProgress : 0}%` }}\n                                          ></div>\n                                        </div>\n                                        <div className="flex justify-between mt-1">\n                                          <span className="text-[8px] font-mono text-slate-400">\n                                            {selectedAudioTrack ? new Date(currentTime * 1000).toISOString().substr(14, 5) : "0:00"}\n                                          </span>\n                                          <span className="text-[8px] font-mono text-slate-400">\n                                            {selectedAudioTrack ? (duration > 0 ? new Date(duration * 1000).toISOString().substr(14, 5) : selectedAudioTrack.duration) : "0:00"}\n                                          </span>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  </div>\n                                </div>\n                              </DialogContent>\n                            </Dialog>\n                          </div>\n                          <div className="flex items-center gap-1">\n                            <span className="text-[10px] text-gray-600 dark:text-gray-400">\n                              {isDemoMode ? "Demo" : "Personal"}\n                            </span>\n                            <Switch\n                              checked={isDemoMode}\n                              onCheckedChange={(checked) => {\n                                console.log(`🔄 Demo mode toggle: ${checked ? 'ON (Demo)' : 'OFF (Personal)'}`);\n                                setHasManuallyToggledMode(true);\n                                localStorage.setItem("hasManuallyToggledMode", "true");\n                                setIsDemoMode(checked);\n                                setSelectedDailyFactors([]);\n                                setSelectedIndicators([]);\n                                setTradeHistoryData([]);\n                                setTradingImages([]);\n                                setTradingDataByDate({});\n                                setPersonalHeatmapRevision(prev => prev + 1);\n                                console.log(`✅ Switched to ${checked ? 'Demo' : 'Personal'} mode - CLEARED cache, heatmap fetching fresh AWS data...`);\n                              }}\n                              data-testid="switch-demo-mode"\n                              className="scale-75"\n                            />\n                            <Button\n                              onClick={saveAllTradingData}\n                              size="sm"\n                              variant="outline"\n                              disabled={isDemoMode && localStorage.getItem('currentUserId') !== 'c06ce90c-20a1-7033-d457-efac5a682529'}\n                              className={`h-5 px-2 text-[10px] border-gray-300 dark:border-gray-700 ${\n                                (isDemoMode && localStorage.getItem('currentUserId') !== 'c06ce90c-20a1-7033-d457-efac5a682529')\n                                  ? 'text-gray-400 dark:text-gray-500 opacity-50 cursor-not-allowed' \n                                  : 'text-gray-600 dark:text-gray-400'\n                              }`}\n                              data-testid="button-save-trade-book"\n                            >\n                              Save\n                            </Button>\n                          </div>\n                        </div>\n                        {/* ✅ NEW CLEAN HEATMAP IMPLEMENTATION - Separate components for Demo & Personal */}\n                        <div className="relative">\n                         <div ref={heatmapContainerRef} className="pt-0.5">\n                          {isDemoMode ? (\n                            <DemoHeatmap \n                              onDateSelect={handleDateSelect}\n                              selectedDate={selectedDate}\n                              tradingDataByDate={tradingDataByDate}\n                              onDataUpdate={(data) => {\n                                handleHeatmapDataUpdate(data);\n                                // Scroll to latest data for demo mode\n                                setTimeout(() => {\n                                  if (heatmapContainerRef.current) {\n                                    const scrollContainer = heatmapContainerRef.current.querySelector('[style*="overflow"]') as HTMLElement;\n                                    if (scrollContainer) {\n                                      scrollContainer.scrollLeft = scrollContainer.scrollWidth;\n                                      console.log("🎯 Demo heatmap: Scrolled to latest data view");\n                                    }\n                                  }\n                                }, 300);\n                              }}\n                              onRangeChange={handleDateRangeChange}\n                              highlightedDates={activeTagHighlight}\n                              refreshTrigger={personalHeatmapRevision}\n                              onSelectDateForHeatmap={(symbol, date) => {\n                                console.log(`📊 [HOME] Switching to heatmap mode - Symbol: ${symbol}, Date: ${date}`);\n                                setJournalChartMode('heatmap');\n                                fetchHeatmapChartData(symbol, date);\n                              }}\n                            />\n                          ) : (\n                            <PersonalHeatmap\n                              userId={getUserId()}\n                              onDateSelect={handleDateSelect}\n                              selectedDate={selectedDate}\n                              onDataUpdate={handleHeatmapDataUpdate}\n                              onRangeChange={handleDateRangeChange}\n                              highlightedDates={activeTagHighlight}\n                              refreshTrigger={personalHeatmapRevision}\n                            />\n                          )}\n                        </div>\n\n                        {/* Curved Lines Overlay - connects FOMO tag block to highlighted dates */}\n                        {(activeTagHighlight?.tag === 'fomo' || activeTagHighlight?.tag === 'overtrading' || activeTagHighlight?.tag === 'planned') && activeTagHighlight.dates.length > 0 && (() => {\n                          // Force recalculation on scroll (dependency: scrollTrigger)\n                          void scrollTrigger;\n\n                          // Calculate curved paths from FOMO button to each highlighted date cell\n                          const paths: JSX.Element[] = [];\n\n                          const buttonRef = activeTagHighlight?.tag === 'fomo' ? fomoButtonRef : activeTagHighlight?.tag === 'overtrading' ? overtradingButtonRef : plannedButtonRef;\n                          if (!buttonRef.current || !heatmapContainerRef.current) {\n                            return null;\n                          }\n\n                          // Get scrollable dimensions (like DemoHeatmap does)\n                          const scrollWidth = heatmapContainerRef.current.scrollWidth || 0;\n                          const scrollHeight = heatmapContainerRef.current.scrollHeight || 0;\n                          const scrollLeft = heatmapContainerRef.current.scrollLeft || 0;\n                          const scrollTop = heatmapContainerRef.current.scrollTop || 0;\n\n                          // Get positions relative to the heatmap's scrollable content\n                          const containerRect = heatmapContainerRef.current.getBoundingClientRect();\n                          const buttonRect = buttonRef.current!.getBoundingClientRect();\n\n                          // Calculate button position relative to scrollable content\n                          const buttonCenterX = buttonRect.left - containerRect.left + scrollLeft + buttonRect.width / 2;\n                          const buttonCenterY = buttonRect.top - containerRect.top + scrollTop + buttonRect.height / 2;\n\n                          // Find all highlighted date cells and draw curved lines to them\n                          activeTagHighlight.dates.forEach((date, index) => {\n                            // Find the heatmap cell for this date\n                            const cellElement = heatmapContainerRef.current?.querySelector(\n                              `[data-date="${date}"]`\n                            );\n\n                            if (cellElement) {\n                              const cellRect = cellElement.getBoundingClientRect();\n\n                              // Calculate cell position relative to scrollable content\n                              const cellCenterX = cellRect.left - containerRect.left + scrollLeft + cellRect.width / 2;\n                              const cellCenterY = cellRect.top - containerRect.top + scrollTop + cellRect.height / 2;\n\n                              // Create quadratic Bezier curve (Q command)\n                              // Control point is positioned to create a nice arc\n                              const controlX = (buttonCenterX + cellCenterX) / 2;\n                              const controlY = Math.min(buttonCenterY, cellCenterY) - 50; // Arc upward\n\n                              const pathD = `M ${buttonCenterX} ${buttonCenterY} Q ${controlX} ${controlY}, ${cellCenterX} ${cellCenterY}`;\n\n                              paths.push(\n                                <g key={`connection-${date}-${index}`}>\n                                  {/* Bright colored line with dashed pattern */}\n                                  <path\n                                    d={pathD}\n                                    fill="none"\n                                    stroke={activeTagHighlight?.tag === 'fomo' ? "url(#curvedLineGradient)" : activeTagHighlight?.tag === 'overtrading' ? "url(#overtradingLineGradient)" : "url(#plannedLineGradient)"}\n                                    strokeWidth="2.5"\n                                    strokeDasharray="6,4"\n                                    opacity="0.95"\n                                  />\n                                  {/* Glowing dot at the end of each line */}\n                                  <circle\n                                    cx={cellCenterX}\n                                    cy={cellCenterY}\n                                    r="4"\n                                    fill={activeTagHighlight?.tag === 'fomo' ? "#fcd34d" : activeTagHighlight?.tag === 'overtrading' ? "#fb923c" : "#4ade80"}\n                                    opacity="0.9"\n                                  />\n                                  <circle\n                                    cx={cellCenterX}\n                                    cy={cellCenterY}\n                                    r="3"\n                                    fill={activeTagHighlight?.tag === 'fomo' ? "#fbbf24" : activeTagHighlight?.tag === 'overtrading' ? "#f97316" : "#22c55e"}\n                                    className="animate-pulse"\n                                  />\n                                </g>\n                              );\n                            }\n                          });\n\n                          return (\n                            <svg\n                              style={{\n                                position: 'absolute',\n                                top: 0,\n                                left: 0,\n                                width: `${scrollWidth}px`,\n                                height: `${scrollHeight}px`,\n                                pointerEvents: 'none',\n                                zIndex: 10,\n                              }}\n                            >\n                              {/* Define bright gradient for the curved lines */}\n                              <defs>\n                                <linearGradient id="curvedLineGradient" x1="0%" y1="0%" x2="100%" y2="0%">\n                                  <stop offset="0%" stopColor="#c084fc" stopOpacity="1" />\n                                  <stop offset="50%" stopColor="#f472b6" stopOpacity="1" />\n                                  <stop offset="100%" stopColor="#fbbf24" stopOpacity="1" />\n                                </linearGradient>\n                                <linearGradient id="overtradingLineGradient" x1="0%" y1="0%" x2="100%" y2="0%">\n                                  <stop offset="0%" stopColor="#fb923c" stopOpacity="1" />\n                                  <stop offset="50%" stopColor="#f97316" stopOpacity="1" />\n                                  <stop offset="100%" stopColor="#ea580c" stopOpacity="1" />\n                                </linearGradient>\n                                <linearGradient id="plannedLineGradient" x1="0%" y1="0%" x2="100%" y2="0%">\n                                  <stop offset="0%" stopColor="#4ade80" stopOpacity="1" />\n                                  <stop offset="50%" stopColor="#22c55e" stopOpacity="1" />\n                                  <stop offset="100%" stopColor="#16a34a" stopOpacity="1" />\n                                </linearGradient>\n                              </defs>\n                              {paths}\n                            </svg>\n                          );\n                        })()}\n                        </div>\n\n                        {/* Quick Stats Banner */}\n                        <div className="mt-2 mb-20 md:mb-2 bg-gradient-to-r from-violet-500 to-purple-600 rounded-md px-2 py-1.5 relative" data-testid="banner-quick-stats">\n                          {(() => {\n                            // Calculate metrics from heatmap data and build tag-to-dates mapping\n                            const filteredData = getFilteredHeatmapData();\n                            const dates = Object.keys(filteredData);\n                            let totalPnL = 0;\n                            let totalTrades = 0;\n                            let winningTrades = 0;\n                            let fomoTrades = 0;\n                            let consecutiveWins = 0;\n                            let maxWinStreak = 0;\n                            const trendData: number[] = [];\n                            const fomoDates: string[] = [];\n                            const overTradingDates: string[] = [];\n                            const plannedDates: string[] = [];\n                            let plannedCount = 0;\n                            const tagStats: Record<string, any> = {};\n                            const tagDates: Record<string, string[]> = {};\n                            let overTradingCount = 0;\n\n                            dates.sort().forEach(dateKey => {\n                              const dayData = filteredData[dateKey];\n                              const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n                              const tags = dayData?.tradingData?.tradingTags || dayData?.tradingTags || [];\n\n                              if (metrics) {\n                                const netPnL = metrics.netPnL || 0;\n                                totalPnL += netPnL;\n                                totalTrades += metrics.totalTrades || 0;\n                                winningTrades += metrics.winningTrades || 0;\n                                trendData.push(netPnL);\n\n                                // Track overtrading - check for tag or high trade count\n                                if ((metrics.totalTrades || 0) > 10) {\n                                  overTradingCount++;\n                                  overTradingDates.push(dateKey);\n                                }\n\n                                // Also track if overtrading tag exists\n                                if (Array.isArray(tags) && tags.length > 0) {\n                                  const normalizedTags = tags.map((t: string) => t.trim().toLowerCase());\n                                  if (normalizedTags.includes('overtrading')) {\n                                    if (!overTradingDates.includes(dateKey)) {\n                                      overTradingCount++;\n                                      overTradingDates.push(dateKey);\n                                    }\n                                  }\n                                }\n\n                                if (Array.isArray(tags) && tags.length > 0) {\n                                  const normalizedTags = tags.map((t: string) => t.trim().toLowerCase());\n                                  if (normalizedTags.includes('fomo')) {\n                                    fomoTrades++;\n                                    fomoDates.push(dateKey);\n}\n                                  if (normalizedTags.includes('planned')) {\n                                    plannedCount++;\n                                    plannedDates.push(dateKey);\n                                  }\n                                  // Track all tags with their dates\n                                  normalizedTags.forEach(tag => {\n                                    tagStats[tag] = (tagStats[tag] || 0) + 1;\n                                    if (!tagDates[tag]) tagDates[tag] = [];\n                                    tagDates[tag].push(dateKey);\n                                  });\n                                }\n\n                                if (netPnL > 0) {\n                                  consecutiveWins++;\n                                  maxWinStreak = Math.max(maxWinStreak, consecutiveWins);\n                                } else if (netPnL < 0) {\n                                  consecutiveWins = 0;\n                                }\n                              }\n                            });\n\n                            const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;\n                            const isProfitable = totalPnL >= 0;\n                            const topTags = Object.entries(tagStats)\n                              .sort(([,a], [,b]) => b - a)\n                              .slice(0, 3)\n                              .map(([tag, count]) => ({ tag, count }));\n\n                            const createSparkline = (data: number[]) => {\n                              if (data.length === 0) return '';\n                              const max = Math.max(...data);\n                              const min = Math.min(...data);\n                              const range = max - min || 1;\n                              const width = 40;\n                              const height = 16;\n                              const points = data.map((val, i) => {\n                                const x = (i / (data.length - 1 || 1)) * width;\n                                const y = height - ((val - min) / range) * height;\n                                return `${x},${y}`;\n                              }).join(' ');\n                              return `M ${points.split(' ').join(' L ')}`;\n                            };\n\n                            return (\n                              <div className="space-y-2">\n                                {/* Header row with stats and menu */}\n                                <div className="flex justify-between items-center gap-2">\n                                  <div className={`text-white flex-1 flex ${Object.values(visibleStats).filter(v => v).length === 1 ? 'justify-center' : 'justify-around'} items-stretch gap-2`}>\n                                    {visibleStats.pnl && (\n                                      <div className="flex flex-col items-center justify-center" data-testid="stat-total-pnl">\n                                        <div className="text-[10px] opacity-80">P&L</div>\n                                        <div className={`text-xs font-bold ${isProfitable ? 'text-green-200' : 'text-red-200'}`}>\n                                          {totalPnL >= 0 ? '+' : ''}₹{(totalPnL / 1000).toFixed(1)}K\n                                        </div>\n                                      </div>\n                                    )}\n                                    {visibleStats.trend && (\n                                      <div className="flex flex-col items-center justify-center" data-testid="stat-trend">\n                                        <div className="text-[10px] opacity-80">Trend</div>\n                                        <svg width="40" height="16" className="mt-0.5">\n                                          <path d={createSparkline(trendData)} fill="none" stroke="white" strokeWidth="1.5" opacity="0.9" />\n                                        </svg>\n                                      </div>\n                                    )}\n                                    {visibleStats.fomo && (\n                                      <button \n                                        ref={fomoButtonRef}\n                                        className={`flex flex-col items-center justify-center hover-elevate active-elevate-2 rounded px-1 transition-all ${\n                                          activeTagHighlight?.tag === 'fomo' ? 'bg-white/30 ring-2 ring-white/50' : ''\n                                        }`} \n                                        onClick={() => setActiveTagHighlight(activeTagHighlight?.tag === 'fomo' ? null : { tag: 'fomo', dates: fomoDates })} \n                                        data-testid="stat-fomo"\n                                        title={`Click to ${activeTagHighlight?.tag === 'fomo' ? 'hide' : 'show'} FOMO dates on heatmap`}\n                                      >\n                                        <div className="text-[10px] opacity-80">FOMO</div>\n                                        <div className="text-xs font-bold">{fomoTrades}</div>\n                                      </button>\n                                    )}\n                                    {visibleStats.winRate && (\n                                      <div className="flex flex-col items-center justify-center" data-testid="stat-success-rate">\n                                        <div className="text-[10px] opacity-80">Win%</div>\n                                        <div className="text-xs font-bold">{winRate.toFixed(0)}%</div>\n                                      </div>\n                                    )}\n                                    {visibleStats.streak && (\n                                      <div className="flex flex-col items-center justify-center" data-testid="stat-win-streak">\n                                        <div className="text-[10px] opacity-80">Streak</div>\n                                        <div className="text-xs font-bold">{maxWinStreak}</div>\n                                      </div>\n                                    )}\n                                    {visibleStats.overtrading && (\n                                      <button \n                                        ref={overtradingButtonRef}\n                                        className={`flex flex-col items-center justify-center hover-elevate active-elevate-2 rounded px-1 transition-all ${\n                                          activeTagHighlight?.tag === 'overtrading' ? 'bg-white/30 ring-2 ring-white/50' : ''\n                                        }`} \n                                        onClick={() => setActiveTagHighlight(activeTagHighlight?.tag === 'overtrading' ? null : { tag: 'overtrading', dates: overTradingDates })} \n                                        data-testid="stat-overtrading"\n                                        title={`Click to ${activeTagHighlight?.tag === 'overtrading' ? 'hide' : 'show'} overtrading dates on heatmap`}\n                                      >\n                                        <div className="text-[10px] opacity-80">OvrTrade</div>\n                                        <div className="text-xs font-bold text-orange-200">{overTradingCount}</div>\n                                      </button>\n                                    )}\n                                    {visibleStats.planned && (\n                                      <button \n                                        ref={plannedButtonRef}\n                                        className={`flex flex-col items-center justify-center hover-elevate active-elevate-2 rounded px-1 transition-all ${activeTagHighlight?.tag === 'planned' ? 'bg-white/30 ring-2 ring-white/50' : ''}`} \n                                        onClick={() => setActiveTagHighlight(activeTagHighlight?.tag === 'planned' ? null : { tag: 'planned', dates: plannedDates })} \n                                        data-testid="stat-planned"\n                                        title={`Click to ${activeTagHighlight?.tag === 'planned' ? 'hide' : 'show'} planned trade dates on heatmap`}\n                                      >\n                                        <div className="text-[10px] opacity-80">Planned</div>\n                                        <div className="text-xs font-bold text-green-200">{plannedCount}</div>\n                                      </button>\n                                    )}\n\n                                  </div>\n\n                                  {/* Share Icon */}\n                                  <button\n                                    className="flex items-center justify-center w-6 h-6 bg-white/20 rounded hover:bg-white/30 transition-colors"\n                                    onClick={() => setShowShareDialog(true)}\n                                    data-testid="button-share-tradebook"\n                                    title="Share tradebook"\n                                  >\n                                    <Share2 className="w-4 h-4 text-white" />\n                                  </button>\n\n                                  {/* 3-Dot Menu Button */}\n                                  <Popover>\n                                    <PopoverTrigger asChild>\n                                      <button className="flex items-center justify-center w-6 h-6 bg-white/20 rounded hover:bg-white/30 transition-colors text-white" data-testid="button-stats-menu">\n                                        <MoreVertical className="w-4 h-4" />\n                                      </button>\n                                    </PopoverTrigger>\n                                    <PopoverContent className="w-56 p-3 bg-white dark:bg-slate-900 border-gray-200 dark:border-slate-700 text-slate-900 dark:text-slate-100">\n                                      <div className="space-y-2">\n                                        <div className="text-xs font-semibold text-slate-400 mb-2 flex items-center justify-between">\n                                          <span>Customize Magic Bar</span>\n                                          <span className="text-xs opacity-70">{Object.values(visibleStats).filter(v => v).length}/6</span>\n                                        </div>\n                                        {(() => {\n                                          const selectedCount = Object.values(visibleStats).filter(v => v).length;\n                                          const isAtLimit = selectedCount >= 6;\n                                          const handleCheckChange = (field: string, checked: boolean) => {\n                                            if (checked && isAtLimit) return;\n                                            const updated = {...visibleStats, [field]: checked}; setVisibleStats(updated); localStorage.setItem("magicBarPrefs", JSON.stringify(updated));\n                                          };\n                                          return (\n                                            <div className="flex flex-col gap-2">\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.pnl && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.pnl} onChange={(e) => handleCheckChange('pnl', e.target.checked)} disabled={!visibleStats.pnl && isAtLimit} className="rounded" />\n                                                P&L\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.trend && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.trend} onChange={(e) => handleCheckChange('trend', e.target.checked)} disabled={!visibleStats.trend && isAtLimit} className="rounded" />\n                                                Trend\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.fomo && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.fomo} onChange={(e) => handleCheckChange('fomo', e.target.checked)} disabled={!visibleStats.fomo && isAtLimit} className="rounded" />\n                                                FOMO\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.winRate && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.winRate} onChange={(e) => handleCheckChange('winRate', e.target.checked)} disabled={!visibleStats.winRate && isAtLimit} className="rounded" />\n                                                Win Rate\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.streak && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.streak} onChange={(e) => handleCheckChange('streak', e.target.checked)} disabled={!visibleStats.streak && isAtLimit} className="rounded" />\n                                                Streak\n                                              </label>\n                                              <div className="border-t border-slate-700 my-1"></div>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.overtrading && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.overtrading} onChange={(e) => handleCheckChange('overtrading', e.target.checked)} disabled={!visibleStats.overtrading && isAtLimit} className="rounded" />\n                                                Overtrading\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.planned && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.planned} onChange={(e) => handleCheckChange('planned', e.target.checked)} disabled={!visibleStats.planned && isAtLimit} className="rounded" />\n                                                Planned\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.topTags && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.topTags} onChange={(e) => handleCheckChange('topTags', e.target.checked)} disabled={!visibleStats.topTags && isAtLimit} className="rounded" />\n                                                Top Tags\n                                              </label>\n                                              <label className={`flex items-center gap-2 text-sm p-1.5 rounded ${!visibleStats.aiAnalysis && isAtLimit ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-slate-800/50'}`}>\n                                                <input type="checkbox" checked={visibleStats.aiAnalysis} onChange={(e) => handleCheckChange('aiAnalysis', e.target.checked)} disabled={!visibleStats.aiAnalysis && isAtLimit} className="rounded" />\n                                                AI Analysis\n                                              </label>\n                                            </div>\n                                          );\n                                        })()}\n                                      </div>\n                                    </PopoverContent>\n                                  </Popover>\n                                </div>\n\n\n                                {/* Top Tags Block with Curved Lines */}\n                                {visibleStats.topTags && topTags.length > 0 && (\n                                  <div className="bg-white/10 rounded px-2 py-1 text-xs text-white">\n                                    <div className="opacity-80 mb-1">Top Tags:</div>\n                                    <div className="flex flex-wrap gap-1">\n                                      {topTags.map(({tag, count}) => (\n                                        <button \n                                          key={tag}\n                                          className={`hover-elevate active-elevate-2 rounded px-2 py-0.5 text-xs transition-all ${\n                                            activeTagHighlight?.tag === tag ? 'bg-white/50 ring-2 ring-white/50' : 'bg-white/20'\n                                          }`}\n                                          onClick={() => setActiveTagHighlight(activeTagHighlight?.tag === tag ? null : { tag, dates: tagDates[tag] || [] })}\n                                          data-testid={`stat-toptag-${tag}`}\n                                        >\n                                          {tag} <span className="text-black">({count})</span>\n                                        </button>\n                                      ))}\n                                    </div>\n                                  </div>\n                                )}\n\n                                {/* AI Analysis Block - Static Text Only */}\n                                {visibleStats.aiAnalysis && (\n                                  <div className="bg-white/10 rounded px-2 py-1 text-xs text-white">\n                                    <span className="opacity-80">AI Insight: </span>\n                                    <span className="italic text-blue-200">\n                                      {totalTrades > 0 ? (winRate > 60 ? "Strong performance detected" : winRate > 50 ? "Balanced trading pattern" : "Risk management recommended") : "No data yet"}\n                                    </span>\n                                  </div>\n                                )}\n                              </div>\n                            );\n                          })()}\n                        </div>\n                      </CardContent>\n                    </Card>\n                    </div>\n                  </div>\n                </div>\n                {/* End of Main Journal Content */}\n                {/* Ranking Tab Content - Mobile only - Empty placeholder */}\n                {mobileBottomTab === "ranking" && (\n                  <div className="md:hidden p-4">\n                    <div className="flex flex-col items-center justify-center py-16 text-center">\n                      <div className="w-20 h-20 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center mb-4">\n                        <Trophy className="h-10 w-10 text-white" />\n                      </div>\n                      <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-2">Trading Challenge</h3>\n                      <p className="text-slate-500 dark:text-slate-400 mb-4">Coming Soon</p>\n                      <div className="space-y-3 w-full max-w-xs">\n                        <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg text-left">\n                          <Users className="h-5 w-5 text-blue-500" />\n                          <div>\n                            <p className="text-sm font-medium text-slate-700 dark:text-slate-200">Compete with Traders</p>\n                            <p className="text-xs text-gray-500">Join 7-day trading challenges</p>\n                          </div>\n                        </div>\n                        <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg text-left">\n                          <BarChart3 className="h-5 w-5 text-green-500" />\n                          <div>\n                            <p className="text-sm font-medium text-slate-700 dark:text-slate-200">Live P&L Tracking</p>\n                            <p className="text-xs text-gray-500">Real-time ranking based on your trades</p>\n                          </div>\n                        </div>\n                        <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg text-left">\n                          <Trophy className="h-5 w-5 text-amber-500" />\n                          <div>\n                            <p className="text-sm font-medium text-slate-700 dark:text-slate-200">Leaderboard Rankings</p>\n                            <p className="text-xs text-gray-500">See your position among all participants</p>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* ============== MODERN TRADING ANALYTICS DASHBOARD ============== */}\n                {/* Mobile: Show only in "insight" tab | Desktop: Always visible */}\n                <div\n                  className={`mt-8 space-y-6 ${mobileBottomTab !== "insight" ? "hidden md:block" : "block"}`}\n                >\n                  {(() => {\n                    // Calculate comprehensive insights from all trading data\n                    const calculateTradingInsights = () => {\n                      const allData = Object.values(tradingDataByDate).filter(\n                        (data: any) =>\n                          data &&\n                          data.tradeHistory &&\n                          Array.isArray(data.tradeHistory) &&\n                          data.tradeHistory.length > 0,\n                      );\n\n                      if (allData.length === 0) {\n                        return {\n                          tagAnalysis: [],\n                          overallStats: {\n                            totalTrades: 0,\n                            winRate: 0,\n                            totalPnL: 0,\n                          },\n                          topPerformers: [],\n                          worstPerformers: [],\n                          tradingDayAnalysis: [],\n                        };\n                      }\n\n                      // Tag-based performance analysis\n                      const tagStats: any = {};\n                      const dailyStats: any[] = [];\n\n                      allData.forEach((dayData: any, index: number) => {\n                        const trades = dayData.tradeHistory || [];\n                        const tags = dayData.tradingTags || [];\n                        const metrics = dayData.performanceMetrics;\n\n                        // Calculate day statistics\n                        if (metrics) {\n                          dailyStats.push({\n                            day: index + 1,\n                            trades: metrics.totalTrades || trades.length,\n                            winRate: parseFloat(metrics.winRate) || 0,\n                            netPnL: metrics.netPnL || 0,\n                            tags: tags,\n                          });\n                        }\n\n                        // Analyze each tag's performance\n                        tags.forEach((tag: string) => {\n                          if (!tagStats[tag]) {\n                            tagStats[tag] = {\n                              tag,\n                              tradingDays: 0,\n                              totalTrades: 0,\n                              wins: 0,\n                              losses: 0,\n                              totalPnL: 0,\n                              winRate: 0,\n                              avgPnL: 0,\n                              bestDay: 0,\n                              worstDay: 0,\n                            };\n                          }\n\n                          const stats = tagStats[tag];\n                          stats.tradingDays++;\n\n                          if (metrics) {\n                            stats.totalTrades += metrics.totalTrades || 0;\n                            stats.wins += metrics.winningTrades || 0;\n                            stats.losses += metrics.losingTrades || 0;\n                            stats.totalPnL += metrics.netPnL || 0;\n                            stats.bestDay = Math.max(\n                              stats.bestDay,\n                              metrics.netPnL || 0,\n                            );\n                            stats.worstDay = Math.min(\n                              stats.worstDay,\n                              metrics.netPnL || 0,\n                            );\n                          }\n                        });\n                      });\n\n                      // Calculate final stats for each tag\n                      Object.values(tagStats).forEach((stats: any) => {\n                        stats.winRate =\n                          stats.totalTrades > 0\n                            ? (stats.wins / stats.totalTrades) * 100\n                            : 0;\n                        stats.avgPnL =\n                          stats.tradingDays > 0\n                            ? stats.totalPnL / stats.tradingDays\n                            : 0;\n                      });\n\n                      const tagAnalysis = Object.values(tagStats).sort(\n                        (a: any, b: any) => b.totalPnL - a.totalPnL,\n                      );\n\n                      // Overall statistics\n                      const totalTrades = tagAnalysis.reduce(\n                        (sum: number, tag: any) => sum + tag.totalTrades,\n                        0,\n                      );\n                      const totalPnL = tagAnalysis.reduce(\n                        (sum: number, tag: any) => sum + tag.totalPnL,\n                        0,\n                      );\n                      const totalWins = tagAnalysis.reduce(\n                        (sum: number, tag: any) => sum + tag.wins,\n                        0,\n                      );\n                      const overallWinRate =\n                        totalTrades > 0 ? (totalWins / totalTrades) * 100 : 0;\n\n                      const overallStats = {\n                        totalTrades,\n                        winRate: overallWinRate,\n                        totalPnL,\n                      };\n                      const topPerformers = tagAnalysis.slice(0, 5);\n                      const worstPerformers = tagAnalysis.slice(-3).reverse();\n\n                      return {\n                        tagAnalysis,\n                        overallStats,\n                        topPerformers,\n                        worstPerformers,\n                        tradingDayAnalysis: dailyStats,\n                      };\n                    };\n\n                    // ✅ NEW: Use filtered heatmap data directly instead of complex insights\n                    const filteredHeatmapData = getFilteredHeatmapData();\n                    const insights = calculateTradingInsights(); // Keep for other sections that still need it\n\n                    // Calculate metrics from filtered heatmap data - only include dates with actual trading (non-zero P&L)\n                    const calculateHeatmapMetrics = () => {\n                      const dates = Object.keys(filteredHeatmapData);\n                      let totalPnL = 0;\n                      let totalTrades = 0;\n                      let winningTrades = 0;\n                      let datesWithTrading = 0;\n\n                      dates.forEach(dateKey => {\n                        const dayData = filteredHeatmapData[dateKey];\n\n                        // Handle both wrapped (AWS) and unwrapped formats\n                        const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n\n                        if (metrics) {\n                          const netPnL = metrics.netPnL || 0;\n\n                          // Only include dates with actual trading activity (non-zero P&L)\n                          if (netPnL !== 0) {\n                            totalPnL += netPnL;\n                            totalTrades += metrics.totalTrades || 0;\n                            winningTrades += metrics.winningTrades || 0;\n                            datesWithTrading++;\n                          }\n                        }\n                      });\n\n                      const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;\n\n                      return { totalPnL, totalTrades, winRate, datesCount: datesWithTrading };\n                    };\n\n                    const heatmapMetrics = calculateHeatmapMetrics();\n                    const totalPnL = heatmapMetrics.totalPnL;\n                    const isProfitable = totalPnL >= 0;\n\n                    console.log(`📊 Performance Trend using ${selectedDateRange ? 'FILTERED' : 'ALL'} heatmap data: ${heatmapMetrics.datesCount} dates, Total P&L: ₹${totalPnL.toFixed(2)}`);\n\n                    return (\n                      <div className="space-y-6">\n                        {/* Desktop: Single Row with Total P&L, Performance Trend, Top Tags */}\n                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">\n                          {/* Total Performance Card - Desktop: Left side */}\n                          <div\n                            className={`md:col-span-3 rounded-3xl p-6 md:p-8 text-white shadow-2xl ${isProfitable ? "bg-gradient-to-br from-emerald-500 to-teal-600" : "bg-gradient-to-br from-red-500 to-rose-600"}`}\n                          >\n                            <div className="flex items-center justify-between mb-6">\n                              <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">\n                                <Target className="w-6 h-6" />\n                              </div>\n                              <div className="text-right">\n                                <div className="text-sm opacity-80">\n                                  {selectedDateRange ? 'Range' : 'Total'} P&L\n                                </div>\n                                <div className="text-2xl md:text-3xl font-bold">\n                                  {totalPnL >= 0 ? "" : "-"}₹\n                                  {Math.abs(totalPnL).toLocaleString("en-IN")}\n                                </div>\n                              </div>\n                            </div>\n\n                            <div className="space-y-4">\n                              <div className="flex justify-between items-center">\n                                <span className="text-sm opacity-80">\n                                  Total Trades\n                                </span>\n                                <span className="font-semibold">\n                                  {heatmapMetrics.totalTrades}\n                                </span>\n                              </div>\n                              <div className="flex justify-between items-center">\n                                <span className="text-sm opacity-80">\n                                  Success Rate\n                                </span>\n                                <span className="font-semibold">\n                                  {heatmapMetrics.winRate.toFixed(1)}%\n                                </span>\n                              </div>\n                              <div className="w-full bg-white/20 rounded-full h-2">\n                                <div\n                                  className="bg-white rounded-full h-2 transition-all duration-1000"\n                                  style={{\n                                    width: `${Math.min(\n                                      heatmapMetrics.winRate,\n                                      100,\n                                    )}%`,\n                                  }}\n                                ></div>\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Performance Trend Chart - Desktop: Middle */}\n                          <div className="md:col-span-6 bg-white dark:bg-slate-900 rounded-3xl p-4 md:p-8 shadow-lg border border-slate-200 dark:border-slate-800">\n                          <div className="flex items-center justify-between mb-6">\n                            <h3 className="text-lg font-semibold text-slate-800 dark:text-white">\n                              Performance Trend\n                            </h3>\n                            {(() => {\n                              return (\n                                <div className="flex items-center gap-2">\n                                  <div\n                                    className={`w-3 h-3 ${\n                                      isProfitable\n                                        ? "bg-emerald-400"\n                                        : "bg-red-400"\n                                    } rounded-full`}\n                                  ></div>\n                                  <span className="text-sm text-slate-600 dark:text-slate-400">\n                                    {isProfitable\n                                      ? "Profitable"\n                                      : "Not Profitable"}\n                                  </span>\n                                </div>\n                              );\n                            })()}\n                          </div>\n\n                          {Object.keys(filteredHeatmapData).length > 0 ? (\n                            <div className="h-64 w-full">\n                              {(() => {\n                                // ✅ NEW: Get filtered heatmap data and prepare daily chart data\n                                const allDates = Object.keys(filteredHeatmapData).sort();\n\n                                // ✅ NEW: Convert filtered heatmap data to daily chart data format\n                                const chartData = allDates.map(\n\n                                  (dateStr, idx) => {\n                                    const date = new Date(dateStr);\n                                    const dayData = filteredHeatmapData[dateStr];\n\n                                    // Handle both wrapped (AWS) and unwrapped formats\n                                    const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n\n                                    const netPnL = metrics?.netPnL || 0;\n                                    const totalTrades = metrics?.totalTrades || 0;\n\n                                    return {\n                                      day: `${date.getDate()}/${\n                                        date.getMonth() + 1\n                                      }`,\n                                      value: netPnL,\n                                      pnl: netPnL,\n                                      date: dateStr,\n                                      trades: totalTrades,\n                                      formattedDate: date.toLocaleDateString(\n                                        "en-IN",\n                                        {\n                                          day: "numeric",\n                                          month: "short",\n                                        },\n                                      ),\n                                    };\n                                  },\n                                ).filter((item) => item.trades > 0);\n\n                                // Find peak value for indicator\n                                const peakData = chartData.reduce(\n                                  (max, current) =>\n                                    current.value > max.value ? current : max,\n                                  chartData[0] || { value: 0, day: "", pnl: 0 },\n                                );\n\n                                return (\n                                  <div className="relative h-full">\n                                    <ResponsiveContainer\n                                      width="100%"\n                                      height="100%"\n                                    >\n                                      {(() => {\n                                        const chartStrokeColor = theme === 'dark' ? '#ffffff' : '#000000';\n                                        const tooltipBg = theme === 'dark' ? '#1e293b' : '#ffffff';\n                                        const tooltipText = theme === 'dark' ? '#e2e8f0' : '#1e293b';\n                                        return (\n                                        <AreaChart\n                                        data={chartData}\n                                        margin={{\n                                          top: 40,\n                                          right: 30,\n                                          left: 0,\n                                          bottom: 5,\n                                        }}\n                                      >\n                                        <defs>\n                                          <linearGradient\n                                            id="areaGradientPositive"\n                                            x1="0"\n                                            y1="0"\n                                            x2="0"\n                                            y2="1"\n                                          >\n                                            <stop\n                                              offset="0%"\n                                              stopColor="rgb(107, 114, 128)"\n                                              stopOpacity={0.6}\n                                            />\n                                            <stop\n                                              offset="100%"\n                                              stopColor="rgb(107, 114, 128)"\n                                              stopOpacity={0.1}\n                                            />\n                                          </linearGradient>\n                                        </defs>\n                                        <XAxis\n                                          dataKey="day"\n                                          axisLine={false}\n                                          tickLine={false}\n                                          tick={false}\n                                          className="text-slate-500 dark:text-slate-400"\n                                        />\n                                        <YAxis\n                                          axisLine={false}\n                                          tickLine={false}\n                                          tick={{\n                                            fontSize: 12,\n                                            fill: theme === 'dark' ? '#cbd5e1' : '#64748b',\n                                          }}\n                                          tickFormatter={(value) =>\n                                            `${value >= 0 ? "" : "-"}${(\n                                              Math.abs(value) / 1000\n                                            ).toFixed(0)}K`\n                                          }\n                                          domain={[\n                                            "dataMin - 1000",\n                                            "dataMax + 1000",\n                                          ]}\n                                          className="text-slate-500 dark:text-slate-400"\n                                        />\n                                        <Tooltip\n                                          contentStyle={{\n                                            background: tooltipBg,\n                                            border: `1px solid ${theme === 'dark' ? '#334155' : '#e2e8f0'}`,\n                                            borderRadius: "12px",\n                                            color: tooltipText,\n                                            fontSize: "12px",\n                                            padding: "8px 12px",\n                                          }}\n                                          formatter={(\n                                            value: any,\n                                            name: any,\n                                            props: any,\n                                          ) => [\n                                            `${\n                                              value >= 0 ? "₹" : "-₹"\n                                            }${Math.abs(\n                                              value,\n                                            ).toLocaleString()}`,\n                                            "Daily P&L",\n                                          ]}\n                                          labelFormatter={(label, payload) => {\n                                            if (\n                                              payload &&\n                                              payload[0] &&\n                                              payload[0].payload\n                                            ) {\n                                              const data = payload[0].payload;\n                                              return `${data.formattedDate} • ${data.trades} trades`;\n                                            }\n                                            return label;\n                                          }}\n                                        />\n                                        <Area\n                                          type="natural"\n                                          dataKey="value"\n                                          stroke={chartStrokeColor}\n                                          strokeWidth={3}\n                                          fill="url(#areaGradientPositive)"\n                                          dot={false}\n                                          activeDot={{\n                                            r: 6,\n                                            fill: chartStrokeColor,\n                                            stroke: "white",\n                                            strokeWidth: 2,\n                                          }}\n                                          isAnimationActive={true}\n                                          animationDuration={600}\n                                          animationEasing="ease-in-out"\n                                        />\n                                      </AreaChart>\n                                        );\n                                      })()}\n                                    </ResponsiveContainer>\n                                  </div>\n                                );\n                              })()}\n                            </div>\n                          ) : (\n                            <div className="flex items-center justify-center h-48 text-slate-400">\n                              <div className="text-center">\n                                <BarChart3 className="w-12 h-12 mx-auto mb-3 opacity-50" />\n                                <p>No trend data available</p>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n\n                          {/* Top Tags - Desktop: Right side */}\n                          <div className="md:col-span-3 bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-lg border border-slate-200 dark:border-slate-800">\n                            <div className="flex items-center gap-3 mb-6">\n                              <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">\n                                <Tag className="w-5 h-5 text-white" />\n                              </div>\n                              <div>\n                                <h3 className="font-semibold text-slate-800 dark:text-white">\n                                  Top Tags\n                                </h3>\n                                <p className="text-xs text-slate-500">\n                                  Strategy Performance\n                                </p>\n                              </div>\n                            </div>\n\n                            {insights.topPerformers.length > 0 ? (\n                              <div className="space-y-4">\n                                {insights.topPerformers\n                                  .slice(0, 4)\n                                  .map((tag: any, idx: number) => (\n                                    <div key={tag.tag} className="relative">\n                                      <div className="flex items-center justify-between mb-2">\n                                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">\n                                          {tag.tag}\n                                        </span>\n                                        <span\n                                          className={`text-sm font-semibold ${\n                                            tag.totalPnL >= 0\n                                              ? "text-emerald-600"\n                                              : "text-red-500"\n                                          }`}\n                                        >\n                                          {tag.totalPnL >= 0 ? "+" : ""}₹\n                                          {Math.abs(\n                                            tag.totalPnL,\n                                          ).toLocaleString()}\n                                        </span>\n                                      </div>\n                                      <div className="w-full h-2 bg-slate-100 dark:bg-slate-700 rounded-full">\n                                        <div\n                                          className={`h-2 rounded-full transition-all duration-1000 ${\n                                            tag.totalPnL >= 0\n                                              ? "bg-gradient-to-r from-emerald-400 to-green-500"\n                                              : "bg-gradient-to-r from-red-400 to-rose-500"\n                                          }`}\n                                          style={{\n                                            width: `${Math.min(\n                                              tag.winRate,\n                                              100,\n                                            )}%`,\n                                          }}\n                                        ></div>\n                                      </div>\n                                      <div className="text-xs text-slate-500 mt-1">\n                                        {tag.winRate.toFixed(1)}% success rate\n                                      </div>\n                                    </div>\n                                  ))}\n                              </div>\n                            ) : (\n                              <div className="flex items-center justify-center h-32 text-slate-400">\n                                <div className="text-center">\n                                  <Tag className="w-8 h-8 mx-auto mb-2 opacity-50" />\n                                  <p className="text-sm">No tag data</p>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n\n                        {/* Strategy Summary Cards */}\n                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">\n                          {(() => {\n                            // Filter to only include dates with actual trading activity (non-zero P&L)\n                            const allData = Object.values(\n                              tradingDataByDate,\n                            ).filter(\n                              (data: any) => data && data.performanceMetrics && data.performanceMetrics.netPnL !== 0,\n                            );\n\n                            if (allData.length === 0) return null;\n\n                            const totalDays = allData.length;\n                            const profitableDays = allData.filter(\n                              (d: any) => d.performanceMetrics.netPnL > 0,\n                            ).length;\n                            const avgDailyPnL =\n                              allData.reduce(\n                                (sum: number, d: any) =>\n                                  sum + d.performanceMetrics.netPnL,\n                                0,\n                              ) / totalDays;\n                            const maxProfit = Math.max(\n                              ...allData.map(\n                                (d: any) => d.performanceMetrics.netPnL,\n                              ),\n                            );\n\n                            const metrics = [\n                              {\n                                label: "Trading Days",\n                                value: totalDays,\n                                icon: Calendar,\n                                color: "from-blue-500 to-indigo-600",\n                                textColor: "text-blue-600",\n                              },\n                              {\n                                label: "Best Day",\n                                value: `₹${maxProfit.toLocaleString()}`,\n                                icon: TrendingUp,\n                                color: "from-emerald-500 to-green-600",\n                                textColor: "text-emerald-600",\n                              },\n                              {\n                                label: "Profitable Days",\n                                value: profitableDays,\n                                icon: Target,\n                                color: "from-violet-500 to-purple-600",\n                                textColor: "text-violet-600",\n                              },\n                              {\n                                label: "Avg Daily P&L",\n                                value: `₹${Math.abs(\n                                  avgDailyPnL,\n                                ).toLocaleString()}`,\n                                icon: BarChart3,\n                                color:\n                                  avgDailyPnL >= 0\n                                    ? "from-emerald-500 to-green-600"\n                                    : "from-red-500 to-rose-600",\n                                textColor:\n                                  avgDailyPnL >= 0\n                                    ? "text-emerald-600"\n                                    : "text-red-600",\n                              },\n                            ];\n\n                            return metrics.map((metric) => (\n                              <div\n                                key={metric.label}\n                                className="bg-white dark:bg-slate-800 rounded-2xl p-3 md:p-6 shadow-lg border border-slate-200 dark:border-slate-700 hover:shadow-xl transition-all duration-300"\n                              >\n                                <div className="flex md:flex-col items-center md:items-start gap-3 md:gap-0">\n                                  <div\n                                    className={`w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br ${metric.color} rounded-xl flex items-center justify-center md:mb-4 shadow-lg flex-shrink-0`}\n                                  >\n                                    <metric.icon className="w-5 h-5 md:w-6 md:h-6 text-white" />\n                                  </div>\n                                  <div className="flex-1 md:space-y-1">\n                                    <div\n                                      className={`text-xl md:text-2xl font-bold ${metric.textColor}`}\n                                    >\n                                      {metric.value}\n                                    </div>\n                                    <div className="text-xs md:text-sm text-slate-600 dark:text-slate-400">\n                                      {metric.label}\n                                    </div>\n                                  </div>\n                                </div>\n                              </div>\n                            ));\n                          })()}\n                        </div>\n\n                        {/* Full Width Loss Making Analysis - Extended Like Discipline Window */}\n                        <div className="col-span-12 bg-gradient-to-br from-red-500 to-rose-600 rounded-3xl p-8 text-white shadow-2xl mt-6">\n                          <div className="flex items-center gap-4 mb-6">\n                            <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">\n                              <TrendingDown className="w-6 h-6" />\n                            </div>\n                            <div>\n                              <h3 className="text-xl font-bold">\n                                Loss Making Analysis\n                              </h3>\n                              <p className="opacity-80">\n                                Identify and fix problematic patterns\n                              </p>\n                            </div>\n                          </div>\n\n                          {(() => {\n                            const allData = Object.values(\n                              tradingDataByDate\n                            ).filter(\n                              (data: any) =>\n                                data &&\n                                data.tradingTags &&\n                                Array.isArray(data.tradingTags) &&\n                                data.performanceMetrics\n                            );\n\n                            if (allData.length === 0) {\n                              return (\n                                <div className="bg-white/10 rounded-2xl p-6 text-center">\n                                  <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">\n                                    <AlertTriangle className="w-8 h-8" />\n                                  </div>\n                                  <p className="text-lg font-medium mb-2">\n                                    No Data Available\n                                  </p>\n                                  <p className="opacity-80">\n                                    Start trading and tagging to identify loss\n                                    patterns!\n                                  </p>\n                                </div>\n                              );\n                            }\n\n                            // Analyze loss-making patterns\n                            const tagLossAnalysis: any = {};\n                            const riskMetrics: any = {\n                              consecutiveLosses: 0,\n                              maxConsecutiveLosses: 0,\n                              emotionalTradingDays: 0,\n                              impulsiveTrades: 0,\n                              totalLossingDays: 0,\n                            };\n\n                            allData.forEach((data: any) => {\n                              const rawTags = data.tradingTags || [];\n                              const pnl = data.performanceMetrics.netPnL;\n                              const trades =\n                                data.performanceMetrics.totalTrades;\n\n                              if (pnl < 0) {\n                                riskMetrics.totalLossingDays++;\n\n                                // ✅ Improved: Check for emotional trading patterns with array validation\n                                if (Array.isArray(rawTags) && rawTags.length > 0) {\n                                  const emotionalTags = [\n                                    "fomo",\n                                    "fear",\n                                    "greedy",\n                                    "revenge",\n                                    "impatient",\n                                  ];\n                                  const hasEmotionalTag = rawTags.some((tag: string) =>\n                                    emotionalTags.includes(tag.toLowerCase().trim())\n                                  );\n\n                                  if (hasEmotionalTag) {\n                                    riskMetrics.emotionalTradingDays++;\n                                    console.log(`🚨 Loss Analysis: Emotional trading detected with tags: [${rawTags.join(', ')}] | P&L: ₹${pnl.toFixed(2)}`);\n                                  }\n                                }\n\n                                // Check for impulsive trading (high number of trades with losses)\n                                if (trades > 5 && pnl < 0) {\n                                  riskMetrics.impulsiveTrades += trades;\n                                }\n                              }\n\n                              // ✅ Improved: Normalize tags to lowercase for consistent counting\n                              if (Array.isArray(rawTags) && rawTags.length > 0) {\n                                rawTags.forEach((rawTag: string) => {\n                                  // Normalize tag: trim and lowercase for dictionary key\n                                  const normalizedTag = rawTag.trim().toLowerCase();\n\n                                  if (!tagLossAnalysis[normalizedTag]) {\n                                    tagLossAnalysis[normalizedTag] = {\n                                      tag: normalizedTag,\n                                      displayTag: rawTag, // Keep original for display\n                                      totalPnL: 0,\n                                      lossDays: 0,\n                                      totalDays: 0,\n                                      avgLoss: 0,\n                                      lossFrequency: 0,\n                                    };\n                                  }\n\n                                  const analysis = tagLossAnalysis[normalizedTag];\n                                  analysis.totalPnL += pnl;\n                                  analysis.totalDays++;\n\n                                  if (pnl < 0) {\n                                    analysis.lossDays++;\n                                    console.log(`📊 Tag '${normalizedTag}': Loss day detected | P&L: ₹${pnl.toFixed(2)} | Total losses: ${analysis.lossDays}/${analysis.totalDays} days`);\n                                  }\n                                });\n                              }\n                            });\n\n                            // Calculate loss metrics\n                            Object.values(tagLossAnalysis).forEach(\n                              (analysis: any) => {\n                                analysis.lossFrequency =\n                                  (analysis.lossDays / analysis.totalDays) *\n                                  100;\n                                analysis.avgLoss =\n                                  analysis.totalPnL / analysis.totalDays;\n                              }\n                            );\n\n                            // Get worst performing tags\n                            const worstTags = Object.values(tagLossAnalysis)\n                              .filter((tag: any) => tag.totalPnL < 0)\n                              .sort((a: any, b: any) => a.totalPnL - b.totalPnL)\n                              .slice(0, 4);\n\n                            return (\n                              <div className="space-y-6">\n                                {/* Risk Metrics Summary */}\n                                <div className="grid md:grid-cols-4 gap-4">\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">\n                                    <div className="text-2xl font-bold">\n                                      {riskMetrics.totalLossingDays}\n                                    </div>\n                                    <div className="text-sm opacity-80">\n                                      Losing Days\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">\n                                    <div className="text-2xl font-bold">\n                                      {riskMetrics.emotionalTradingDays}\n                                    </div>\n                                    <div className="text-sm opacity-80">\n                                      Emotional Trading Days\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">\n                                    <div className="text-2xl font-bold">\n                                      {riskMetrics.impulsiveTrades}\n                                    </div>\n                                    <div className="text-sm opacity-80">\n                                      Impulsive Trades\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">\n                                    <div className="text-2xl font-bold">\n                                      {allData.length > 0\n                                        ? (\n                                            (riskMetrics.totalLossingDays /\n                                              allData.length) *\n                                            100\n                                          ).toFixed(0)\n                                        : 0}\n                                      %\n                                    </div>\n                                    <div className="text-sm opacity-80">\n                                      Loss Rate\n                                    </div>\n                                  </div>\n                                </div>\n\n                                {/* Worst Performing Tags */}\n                                <div>\n                                  <h4 className="text-lg font-semibold mb-4">\n                                    🚨 Most Problematic Tags\n                                  </h4>\n                                  <div className="grid md:grid-cols-2 gap-4">\n                                    {worstTags.length > 0 ? (\n                                      worstTags.map((tag: any, idx: number) => (\n                                        <div\n                                          key={idx}\n                                          className="bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/20"\n                                        >\n                                          <div className="flex items-start gap-3">\n                                            <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">\n                                              <AlertTriangle className="w-5 h-5" />\n                                            </div>\n                                            <div className="flex-1">\n                                              <div className="font-semibold text-lg">\n                                                {(tag.displayTag || tag.tag).toUpperCase()}\n                                              </div>\n                                              <div className="text-sm opacity-90 mb-2">\n                                                Avg Loss: ₹\n                                                {Math.abs(tag.avgLoss).toFixed(\n                                                  0\n                                                )}{" "}\n                                                • {tag.lossFrequency.toFixed(0)}\n                                                % loss rate\n                                              </div>\n                                              <div className="text-xs bg-red-500/30 rounded-lg p-2">\n                                                Total Loss: ₹\n                                                {Math.abs(\n                                                  tag.totalPnL\n                                                ).toLocaleString("en-IN")}{" "}\n                                                across {tag.totalDays} days\n                                              </div>\n                                            </div>\n                                          </div>\n                                        </div>\n                                      ))\n                                    ) : (\n                                      <div className="col-span-2 text-center py-8">\n                                        <div className="text-4xl mb-2">🎉</div>\n                                        <p className="font-medium">\n                                          No consistent loss-making patterns\n                                          detected!\n                                        </p>\n                                        <p className="text-sm opacity-80">\n                                          Your trading discipline is on track.\n                                        </p>\n                                      </div>\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            );\n                          })()}\n                        </div>\n\n                        {/* Disciplined Trading Insights */}\n                        <div className="col-span-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-8 text-white shadow-2xl mt-6">\n                          <div className="flex items-center gap-4 mb-6">\n                            <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">\n                              <Shield className="w-6 h-6" />\n                            </div>\n                            <div>\n                              <h3 className="text-xl font-bold">\n                                Discipline & Risk Management\n                              </h3>\n                              <p className="opacity-80">\n                                Build consistent, profitable trading habits\n                              </p>\n                            </div>\n                          </div>\n\n                          {(() => {\n                            const allData = Object.values(\n                              tradingDataByDate,\n                            ).filter(\n                              (data: any) =>\n                                data &&\n                                data.tradingTags &&\n                                Array.isArray(data.tradingTags) &&\n                                data.performanceMetrics,\n                            );\n\n                            if (allData.length === 0) {\n                              return (\n                                <div className="bg-white/10 rounded-2xl p-6 text-center">\n                                  <div className="text-4xl mb-3">📊</div>\n                                  <p className="font-medium">\n                                    Ready for Discipline Analysis\n                                  </p>\n                                  <p className="opacity-80 text-sm">\n                                    Start building your trading history!\n                                  </p>\n                                </div>\n                              );\n                            }\n\n                            // Calculate discipline metrics\n                            const disciplineMetrics = {\n                              plannedTrades: 0,\n                              emotionalTrades: 0,\n                              consistentDays: 0,\n                              riskManagedTrades: 0,\n                              totalDays: allData.length,\n                              avgTradesPerDay: 0,\n                              winStreaks: 0,\n                              lossStreaks: 0,\n                            };\n\n                            const disciplineInsights: any[] = [];\n                            let totalTrades = 0;\n                            let consecutiveWins = 0;\n                            let consecutiveLosses = 0;\n                            let maxWinStreak = 0;\n                            let maxLossStreak = 0;\n\n                            allData.forEach((data: any, idx: number) => {\n                              const tags = data.tradingTags;\n                              const pnl = data.performanceMetrics.netPnL;\n                              const trades =\n                                data.performanceMetrics.totalTrades;\n                              totalTrades += trades;\n\n                              // Check for planned trading\n                              if (\n                                tags.includes("planned") ||\n                                tags.includes("setup") ||\n                                tags.includes("strategy")\n                              ) {\n                                disciplineMetrics.plannedTrades++;\n                              }\n\n                              // Check for emotional trading\n                              const emotionalTags = [\n                                "fomo",\n                                "fear",\n                                "greedy",\n                                "revenge",\n                                "impatient",\n                                "unplanned",\n                              ];\n                              if (\n                                tags.some((tag: string) =>\n                                  emotionalTags.includes(tag.toLowerCase()),\n                                )\n                              ) {\n                                disciplineMetrics.emotionalTrades++;\n                              }\n\n                              // Track win/loss streaks\n                              if (pnl > 0) {\n                                consecutiveWins++;\n                                consecutiveLosses = 0;\n                                maxWinStreak = Math.max(\n                                  maxWinStreak,\n                                  consecutiveWins,\n                                );\n                              } else if (pnl < 0) {\n                                consecutiveLosses++;\n                                consecutiveWins = 0;\n                                maxLossStreak = Math.max(\n                                  maxLossStreak,\n                                  consecutiveLosses,\n                                );\n                              }\n\n                              // Check for consistent trade size (discipline indicator)\n                              if (trades <= 5) {\n                                // Not overtrading\n                                disciplineMetrics.consistentDays++;\n                              }\n                            });\n\n                            disciplineMetrics.avgTradesPerDay =\n                              totalTrades / disciplineMetrics.totalDays;\n                            disciplineMetrics.winStreaks = maxWinStreak;\n                            disciplineMetrics.lossStreaks = maxLossStreak;\n\n                            // Generate discipline insights\n                            const plannedRatio =\n                              (disciplineMetrics.plannedTrades /\n                                disciplineMetrics.totalDays) *\n                              100;\n                            const emotionalRatio =\n                              (disciplineMetrics.emotionalTrades /\n                                disciplineMetrics.totalDays) *\n                              100;\n                            const consistencyRatio =\n                              (disciplineMetrics.consistentDays /\n                                disciplineMetrics.totalDays) *\n                              100;\n\n                            if (plannedRatio > 70) {\n                              disciplineInsights.push({\n                                type: "success",\n                                icon: "🎯",\n                                title: "Excellent Planning",\n                                message: `${plannedRatio.toFixed(\n                                  0,\n                                )}% of your trades are well-planned. Keep this discipline!`,\n                              });\n                            } else if (plannedRatio < 30) {\n                              disciplineInsights.push({\n                                type: "warning",\n                                icon: "⚠️",\n                                title: "Planning Needed",\n                                message: `Only ${plannedRatio.toFixed(\n                                  0,\n                                )}% planned trades. Create setups before trading.`,\n                              });\n                            }\n\n                            if (emotionalRatio > 40) {\n                              disciplineInsights.push({\n                                type: "danger",\n                                icon: "🚨",\n                                title: "Emotional Trading Alert",\n                                message: `${emotionalRatio.toFixed(\n                                  0,\n                                )}% emotional trades detected. Practice mindfulness.`,\n                              });\n                            }\n\n                            if (disciplineMetrics.avgTradesPerDay > 8) {\n                              disciplineInsights.push({\n                                type: "warning",\n                                icon: "⚡",\n                                title: "Overtrading Risk",\n                                message: `Avg ${disciplineMetrics.avgTradesPerDay.toFixed(\n                                  1,\n                                )} trades/day. Consider quality over quantity.`,\n                              });\n                            }\n\n                            if (maxLossStreak > 3) {\n                              disciplineInsights.push({\n                                type: "danger",\n                                icon: "🛑",\n                                title: "Loss Streak Warning",\n                                message: `Max loss streak: ${maxLossStreak} days. Implement strict stop-loss rules.`,\n                              });\n                            }\n\n                            if (consistencyRatio > 80) {\n                              disciplineInsights.push({\n                                type: "success",\n                                icon: "⭐",\n                                title: "Great Consistency",\n                                message: `${consistencyRatio.toFixed(\n                                  0,\n                                )}% consistent trading days. Excellent discipline!`,\n                              });\n                            }\n\n                            // Add professional recommendations\n                            const recommendations = [\n                              {\n                                icon: "📝",\n                                title: "Pre-Market Planning",\n                                tip: "Plan 3 trades max before market open with clear entry/exit rules",\n                              },\n                              {\n                                icon: "💰",\n                                title: "Risk Management",\n                                tip: "Never risk more than 2% of capital per trade",\n                              },\n                              {\n                                icon: "⏰",\n                                title: "Trading Hours",\n                                tip: "Trade only during high-volume hours (9:30-11:30 AM, 2:00-3:15 PM)",\n                              },\n                              {\n                                icon: "📊",\n                                title: "Position Sizing",\n                                tip: "Use consistent position sizes based on account balance",\n                              },\n                            ];\n\n                            return (\n                              <div className="space-y-4 md:space-y-6">\n                                {/* Discipline Metrics */}\n                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-3 md:p-4 text-center">\n                                    <div className="text-lg md:text-2xl font-bold">\n                                      {plannedRatio.toFixed(0)}%\n                                    </div>\n                                    <div className="text-xs md:text-sm opacity-80">\n                                      Planned Trades\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-3 md:p-4 text-center">\n                                    <div className="text-lg md:text-2xl font-bold">\n                                      {disciplineMetrics.avgTradesPerDay.toFixed(\n                                        1,\n                                      )}\n                                    </div>\n                                    <div className="text-xs md:text-sm opacity-80">\n                                      Avg Trades/Day\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-3 md:p-4 text-center">\n                                    <div className="text-lg md:text-2xl font-bold">\n                                      {maxWinStreak}\n                                    </div>\n                                    <div className="text-xs md:text-sm opacity-80">\n                                      Max Win Streak\n                                    </div>\n                                  </div>\n                                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-3 md:p-4 text-center">\n                                    <div className="text-lg md:text-2xl font-bold">\n                                      {consistencyRatio.toFixed(0)}%\n                                    </div>\n                                    <div className="text-xs md:text-sm opacity-80">\n                                      Consistent Days\n                                    </div>\n                                  </div>\n                                </div>\n\n                                {/* Discipline Insights */}\n                                <div className="grid md:grid-cols-2 gap-6">\n                                  <div>\n                                    <h4 className="text-lg font-semibold mb-4">\n                                      📈 Performance Insights\n                                    </h4>\n                                    <div className="space-y-1">\n                                      {disciplineInsights.length > 0 ? (\n                                        disciplineInsights\n                                          .slice(0, 4)\n                                          .map((insight, idx) => (\n                                            <div\n                                              key={idx}\n                                              className={`p-4 rounded-xl border ${\n                                                insight.type === "success"\n                                                  ? "bg-emerald-500/20 border-emerald-400/30"\n                                                  : insight.type === "warning"\n                                                    ? "bg-amber-500/20 border-amber-400/30"\n                                                    : "bg-red-500/20 border-red-400/30"\n                                              }`}\n                                            >\n                                              <div className="flex items-start gap-3">\n                                                <div className="text-xl">\n                                                  {insight.icon}\n                                                </div>\n                                                <div>\n                                                  <div className="font-medium">\n                                                    {insight.title}\n                                                  </div>\n                                                  <div className="text-sm opacity-90">\n                                                    {insight.message}\n                                                  </div>\n                                                </div>\n                                              </div>\n                                            </div>\n                                          ))\n                                      ) : (\n                                        <div className="text-center py-6">\n                                          <div className="text-3xl mb-2">\n                                            📊\n                                          </div>\n                                          <p className="opacity-80">\n                                            Insights will appear as you build\n                                            trading history\n                                          </p>\n                                        </div>\n                                      )}\n                                    </div>\n                                  </div>\n\n                                  <div>\n                                    <h4 className="text-lg font-semibold mb-4">\n                                      🎯 Professional Tips\n                                    </h4>\n                                    <div className="space-y-1">\n                                      {recommendations.map((rec, idx) => (\n                                        <div\n                                          key={idx}\n                                          className="bg-white/10 backdrop-blur-sm rounded-xl p-4"\n                                        >\n                                          <div className="flex items-start gap-3">\n                                            <div className="text-xl">\n                                              {rec.icon}\n                                            </div>\n                                            <div>\n                                              <div className="font-medium text-sm">\n                                                {rec.title}\n                                              </div>\n                                              <div className="text-xs opacity-90 mt-1">\n                                                {rec.tip}\n                                              </div>\n                                            </div>\n                                          </div>\n                                        </div>\n                                      ))}\n                                    </div>\n                                  </div>\n                                </div>\n                              </div>\n                            );\n                          })()}\n                        </div>\n                      </div>\n                    );\n                  })()}\n                </div>\n              </div>\n            )}\n\n          </div>\n        </main>\n\n        <BrokerData \n          showOrderModal={showOrderModal} \n          setShowOrderModal={setShowOrderModal} \n          orderTab={orderTab} \n          setOrderTab={setOrderTab} \n          showUserId={showUserId} \n          setShowUserId={setShowUserId} \n          zerodhaClientId={zerodhaClientId} \n          zerodhaUserName={zerodhaUserName} \n          brokerOrders={brokerOrders} \n          fetchingBrokerOrders={fetchingBrokerOrders} \n          zerodhaAccessToken={zerodhaAccessToken} \n          recordAllBrokerOrders={recordAllBrokerOrders} \n          upstoxAccessToken={upstoxAccessToken}\n          upstoxUserId={upstoxUserId}\n          upstoxUserName={upstoxUserName}\n          brokerPositions={brokerPositions} \n          fetchingBrokerPositions={fetchingBrokerPositions} \n          showBrokerImportModal={showBrokerImportModal} \n          setShowBrokerImportModal={setShowBrokerImportModal} \n          handleBrokerImport={handleBrokerImport} \n          showImportModal={showImportModal} \n          setShowImportModal={setShowImportModal} \n          handleFileUpload={handleFileUpload} \n          activeFormat={activeFormat} \n          detectedFormatLabel={detectedFormatLabel} \n          isBuildMode={isBuildMode} \n          setIsBuildMode={setIsBuildMode} \n          brokerSearchInput={brokerSearchInput} \n          setBrokerSearchInput={setBrokerSearchInput} \n          showBrokerSuggestions={showBrokerSuggestions} \n          setShowBrokerSuggestions={setShowBrokerSuggestions} \n          filteredBrokers={filteredBrokers} \n          buildModeData={buildModeData} \n          setBuildModeData={setBuildModeData} \n          allColumnsFilledForSave={allColumnsFilledForSave} \n          missingColumns={missingColumns} \n          saveFormatToUniversalLibrary={saveFormatToUniversalLibrary} \n          currentUser={currentUser} \n          getCognitoToken={getCognitoToken} \n          setSavedFormats={setSavedFormats} \n          importDataTextareaRef={importDataTextareaRef} brokerFunds={brokerFunds} \n        />\n        {/* Broker Import Dialog */}\n        <BrokerImportDialog\n          open={showBrokerImportModal}\n          onOpenChange={setShowBrokerImportModal}\n          onSuccess={handleBrokerImport}\n        />\n\n        {/* Import Modal - Minimalist Design */}\n        <Dialog open={showImportModal} onOpenChange={setShowImportModal}>\n          <DialogContent className="max-w-2xl max-h-[85vh] overflow-y-auto custom-thin-scrollbar p-0">\n            {/* Compact Header */}\n            <div className="sticky top-0 z-10 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 py-3">\n              <span className="text-sm font-semibold text-slate-800 dark:text-slate-100">Import P&L Data</span>\n            </div>\n\n            <div className="p-4 space-y-4">\n              <div>\n                <Label htmlFor="csv-upload" className="text-xs font-medium text-slate-700 dark:text-slate-300">\n                  Upload CSV\n                </Label>\n                <Input\n                  id="csv-upload"\n                  type="file"\n                  accept=".csv"\n                  onChange={handleFileUpload}\n                  className="mt-1.5 h-8 text-xs"\n                  data-testid="input-csv-upload"\n                />\n                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">\n                  Expected: date, symbol, action, qty, entry, exit, pnl, duration\n                </p>\n              </div>\n\n              <div>\n                <Label className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-1.5 block">\n                  Or Paste Data\n                </Label>\n                <div className="flex items-center gap-2 mb-2">\n                  {activeFormat && detectedFormatLabel && (\n                    <span className="text-xs px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded font-medium">\n                      Format: {detectedFormatLabel}\n                    </span>\n                  )}\n                </div>\n                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2">\n                  {activeFormat \n                    ? `Using "${detectedFormatLabel}" format`\n                    : "Paste your trade data. Format will be auto-detected if saved."\n                  }\n                </p>\n\n                <div className="border border-slate-200 dark:border-slate-700 rounded-md bg-slate-50 dark:bg-slate-900/30 p-3 mb-3">\n                  {isBuildMode ? (\n                    <div className="space-y-1">\n                      <div className="flex items-center justify-between gap-2">\n                        <div className="text-xs font-medium text-slate-700 dark:text-slate-300">\n                          Build Mode - Select text, click +, X to delete\n                        </div>\n                        <div className="flex items-center gap-2">\n                          <div className="relative">\n                            <Input\n                              placeholder="Type broker name or custom name (e.g., Zerodha, Coinbase, MyBroker...)"\n                              value={brokerSearchInput}\n                              onChange={(e) => {\n                                setBrokerSearchInput(e.target.value);\n                                setShowBrokerSuggestions(true);\n                              }}\n                              onFocus={() => setShowBrokerSuggestions(true)}\n                              onBlur={() => setTimeout(() => setShowBrokerSuggestions(false), 200)}\n                              className="h-8 w-56 text-xs"\n                              data-testid="input-broker-search"\n                            />\n                            {showBrokerSuggestions && filteredBrokers.length > 0 && (\n                              <div className="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded shadow-md z-50 max-h-64 overflow-y-auto">\n                                {filteredBrokers.map((broker) => (\n                                  <div\n                                    key={broker}\n                                    onMouseDown={(e) => {\n                                      e.preventDefault();\n                                      setBrokerSearchInput(broker);\n                                      setShowBrokerSuggestions(false);\n                                    }}\n                                    className="px-3 py-1.5 text-xs cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/30"\n                                    data-testid={`broker-suggestion-${broker}`}\n                                  >\n                                    {broker}\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                          <Button\n                            variant="ghost"\n                            size="sm"\n                            disabled={!currentUser?.userId || !brokerSearchInput.trim() || !allColumnsFilledForSave}\n                            title={\n                              !currentUser?.userId ? "Log in to save formats" : \n                              !brokerSearchInput.trim() ? "Enter broker or custom name" :\n                              !allColumnsFilledForSave ? `Fill all columns: ${missingColumns.join(", ")}` :\n                              ""\n                            }\n                            onClick={async () => {\n                              if (!brokerSearchInput.trim()) {\n                                alert("Please enter a broker name");\n                                return;\n                              }\n                              if (!allColumnsFilledForSave) {\n                                alert(`Please fill all columns: ${missingColumns.join(", ")}`);\n                                return;\n                              }\n                              const brokerName = brokerSearchInput.trim();\n                              const formatLabel = `${brokerName} Format`;\n                              // Save to universal library\n                              const saved = await saveFormatToUniversalLibrary(formatLabel, buildModeData, brokerName);\n                              if (saved) {\n                                setActiveFormat(buildModeData);\n                                setBrokerSearchInput("");\n                                console.log("✅ Format saved to library for:", brokerName, buildModeData.positions);\n\n                                // Reload saved formats immediately to trigger auto-apply\n                                if (currentUser?.userId) {\n                                  try {\n                                    const idToken = await getCognitoToken();\n                                    if (idToken) {\n                                      const response = await fetch(`/api/user-formats/${currentUser.userId}`, {\n                                        headers: { 'Authorization': `Bearer ${idToken}` }\n                                      });\n                                      if (response.ok) {\n                                        const updatedFormats = await response.json();\n                                        setSavedFormats(updatedFormats);\n\n                                        // IMMEDIATELY apply first saved format to live preview\n                                        if (Object.keys(updatedFormats).length > 0) {\n                                          const firstLabel = Object.keys(updatedFormats)[0];\n                                          const firstFormat = updatedFormats[firstLabel];\n                                          setActiveFormat(firstFormat);\n                                          console.log("✨ Live preview auto-applying first format:", firstLabel);\n                                        }\n                                        console.log("🔄 Saved formats reloaded - live preview updated:", Object.keys(updatedFormats).length);\n                                      }\n                                    }\n                                  } catch (err) {\n                                    console.error("❌ Failed to reload formats after save:", err);\n                                  }\n                                }\n                              }\n                            }}\n                            data-testid="button-save-format"\n                            className="h-8 text-xs px-2"\n                          >\n                            <Save className="w-3 h-3 mr-1" />\n                            Save\n                          </Button>\n                          <Button\n                            variant="ghost"\n                            size="sm"\n                            onClick={() => setIsBuildMode(false)}\n                            data-testid="button-close-build-mode"\n                          >\n                            <X className="w-4 h-4" />\n                          </Button>\n                        </div>\n                      </div>\n\n                      <div className="bg-background rounded border overflow-hidden">\n                        <table className="w-full font-mono text-xs">\n                          <thead>\n                            <tr className="bg-blue-50 dark:bg-blue-950 border-b border-blue-200 dark:border-blue-800">\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Time</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Order</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Symbol</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Type</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Qty</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Price</th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr className="border-b">\n                              {/* Time Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "time") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        time: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.time\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        time: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.time\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.time.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "time");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.time);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.time.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, time: [] },\n                                          displayValues: { ...prev.displayValues!, time: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-time"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.time}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, time: [...prev.positions.time, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, time: prev.displayValues.time ? `${prev.displayValues.time} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-time"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n\n                              {/* Order Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "order") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        order: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.order\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        order: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.order\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.order.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "order");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.order);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.order.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, order: [] },\n                                          displayValues: { ...prev.displayValues!, order: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-order"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.order}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, order: [...prev.positions.order, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, order: prev.displayValues.order ? `${prev.displayValues.order} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-order"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n\n                              {/* Symbol Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "symbol") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        symbol: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.symbol\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        symbol: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.symbol\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.symbol.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "symbol");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.symbol);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.symbol.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, symbol: [] },\n                                          displayValues: { ...prev.displayValues!, symbol: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-symbol"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.symbol}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, symbol: [...prev.positions.symbol, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, symbol: prev.displayValues.symbol ? `${prev.displayValues.symbol} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-symbol"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n\n                              {/* Type Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "type") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        type: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.type\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        type: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.type\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.type.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "type");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.type);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.type.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, type: [] },\n                                          displayValues: { ...prev.displayValues!, type: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-type"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.type}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, type: [...prev.positions.type, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, type: prev.displayValues.type ? `${prev.displayValues.type} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-type"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n\n                              {/* Qty Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "qty") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        qty: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.qty\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        qty: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.qty\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.qty.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "qty");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.qty);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.qty.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, qty: [] },\n                                          displayValues: { ...prev.displayValues!, qty: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-qty"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.qty}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, qty: [...prev.positions.qty, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, qty: prev.displayValues.qty ? `${prev.displayValues.qty} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-qty"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n\n                              {/* Price Column */}\n                              <td \n                                className="px-2 py-2"\n                                onDragOver={(e) => e.preventDefault()}\n                                onDrop={(e) => {\n                                  e.preventDefault();\n                                  const sourceField = e.dataTransfer.getData("sourceField") as keyof typeof buildModeData.positions;\n                                  if (sourceField && sourceField !== "price") {\n                                    // Swap: exchange data between source and destination\n                                    setBuildModeData(prev => ({\n                                      ...prev,\n                                      positions: {\n                                        ...prev.positions,\n                                        price: prev.positions[sourceField],\n                                        [sourceField]: prev.positions.price\n                                      },\n                                      displayValues: {\n                                        ...prev.displayValues!,\n                                        price: prev.displayValues[sourceField],\n                                        [sourceField]: prev.displayValues.price\n                                      }\n                                    }));\n                                  }\n                                }}\n                              >\n                                {buildModeData.positions.price.length > 0 ? (\n                                  <div \n                                    draggable\n                                    onDragStart={(e) => {\n                                      e.dataTransfer.setData("sourceField", "price");\n                                      e.dataTransfer.setData("sourceValue", buildModeData.displayValues.price);\n                                    }}\n                                    className="inline-flex flex-col gap-0.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs cursor-move"\n                                  >\n                                    <div className="flex items-center gap-1">\n                                      <span className="text-xs text-blue-500 dark:text-blue-400 font-mono">[Pos {buildModeData.positions.price.join(", ")}]</span>\n                                      <button\n                                        onClick={() => setBuildModeData(prev => ({ \n                                          ...prev, \n                                          positions: { ...prev.positions, price: [] },\n                                          displayValues: { ...prev.displayValues!, price: "" }\n                                        }))}\n                                        className="hover:bg-blue-200 dark:hover:bg-blue-900/50 rounded p-0.5"\n                                        data-testid="delete-price"\n                                        title="Delete all"\n                                      >\n                                        <X className="w-3 h-3" />\n                                      </button>\n                                    </div>\n                                    <span className="font-medium text-xs">{buildModeData.displayValues.price}</span>\n                                  </div>\n                                ) : (\n                                  <button\n                                    onClick={() => {\n                                      const textarea = importDataTextareaRef.current;\n                                      if (textarea) {\n                                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();\n                                        const firstLine = textarea.value.trim().split('\n')[0] || "";\n                                        if (selectedText && firstLine) {\n                                          const selectedWords = selectedText.split(/\s+/);\n                                          const words = firstLine.split(/\t+/).flatMap(part => part.split(/\s+/)).filter(w => w.trim());\n                                          const newPositions = selectedWords.map(word => words.findIndex(w => w === word || w.includes(word) || word.includes(w))).filter(p => p >= 0);\n                                          if (newPositions.length > 0) {\n                                            setBuildModeData(prev => ({ \n                                              ...prev,\n                                              sampleLine: firstLine,\n                                              positions: { ...prev.positions, price: [...prev.positions.price, ...newPositions] },\n                                              displayValues: { ...prev.displayValues!, price: prev.displayValues.price ? `${prev.displayValues.price} ${selectedText}` : selectedText }\n                                            }));\n                                          } else {\n                                            alert("Could not find selected text in first line!");\n                                          }\n                                        }\n                                      }\n                                    }}\n                                    className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-gray-800 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"\n                                    data-testid="add-price"\n                                    title="Select text and click +"\n                                  >\n                                    <Plus className="w-4 h-4" />\n                                  </button>\n                                )}\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </div>\n\n                      {/* Saved Formats Table - Shows all saved formats with their original trade lines */}\n                      {Object.keys(savedFormats).length > 0 && (\n                        <div className="mt-4 space-y-2">\n                          <button\n                            onClick={() => setShowSavedFormatsDropdown(!showSavedFormatsDropdown)}\n                            className="flex items-center gap-2 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors w-full"\n                            data-testid="button-toggle-saved-formats"\n                          >\n                            <ChevronDown \n                              className={`w-3 h-3 transition-transform ${showSavedFormatsDropdown ? "rotate-180" : ""}`}\n                            />\n                            📚 Saved Formats ({Object.keys(savedFormats).length})\n                          </button>\n                          {showSavedFormatsDropdown && (\n                          <div className="bg-background rounded border overflow-hidden">\n                            <table className="w-full text-xs">\n                              <thead>\n                                <tr className="bg-muted/50 border-b">\n                                  <th className="px-3 py-2 text-left font-semibold">Format Label</th>\n                                  <th className="px-3 py-2 text-left font-semibold">Original Trade Line</th>\n                                  <th className="px-3 py-2 text-left font-semibold">Actions</th>\n                                </tr>\n                              </thead>\n                              <tbody>\n                                {Object.entries(savedFormats).map(([formatId, format]) => {\n                                  const displayLabel = format.label || formatId;\n                                  return (\n                                  <tr key={formatId} className="border-b last:border-b-0 hover-elevate">\n                                    <td className="px-3 py-2 font-medium">{displayLabel}</td>\n                                    <td className="px-3 py-2 font-mono text-muted-foreground truncate max-w-md">\n                                      {format.sampleLine || "No sample line saved"}\n                                    </td>\n                                    <td className="px-3 py-2">\n                                      <div className="flex items-center gap-2">\n                                        <Button\n                                          variant="outline"\n                                          size="sm"\n                                          className="h-7 text-xs"\n                                          onClick={() => {\n                                            // Set user's manual selection\n                                            setUserSelectedFormatId(formatId);\n                                            setBuildModeData(format);\n                                            setActiveFormat(format);\n                                            setDetectedFormatLabel(displayLabel);\n                                            console.log("✅ Format loaded from table:", displayLabel, format);\n                                          }}\n                                          data-testid={`button-use-format-${displayLabel}`}\n                                        >\n                                          Use\n                                        </Button>\n                                        <Button\n                                          variant="ghost"\n                                          size="sm"\n                                          className="h-7 text-xs text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 disabled:opacity-50 disabled:cursor-not-allowed"\n                                          disabled={!currentUser?.userId}\n                                          title={!currentUser?.userId ? "Log in to delete formats" : ""}\n                                          onClick={async () => {if (confirm(`Delete format "${displayLabel}"?`)) {\n                                              const newFormats = { ...savedFormats };\n                                              delete newFormats[formatId];\n                                              setSavedFormats(newFormats);\n                                              await saveFormatsToAWS(newFormats);\n                                              if (activeFormat === format) {\n                                                setActiveFormat(null);\n                                              }\n                                              // Clear user selection if deleted format was selected\n                                              if (userSelectedFormatId === formatId) {\n                                                setUserSelectedFormatId(null);\n                                              }\n                                              console.log("🗑️ Format deleted:", displayLabel);\n                                            }\n                                          }}\n                                          data-testid={`button-delete-format-${displayLabel}`}\n                                        >\n                                          <X className="w-3 h-3" />\n                                        </Button>\n                                      </div>\n                                    </td>\n                                  </tr>\n                                  );\n                                })}\n                              </tbody>\n                            </table>\n                          </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  ) : (\n                    <>\n                      <div className="text-xs font-medium text-muted-foreground mb-2">\n                        Live Demo - How Your First Trade Will Import:\n                      </div>\n                      <div className="bg-background rounded border overflow-hidden">\n                        <table className="w-full font-mono text-xs">\n                          <thead>\n                            <tr className="bg-blue-50 dark:bg-blue-950 border-b border-blue-200 dark:border-blue-800">\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Time</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Order</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Symbol</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Type</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Qty</th>\n                              <th className="px-2 py-2 text-left text-blue-600 dark:text-blue-400 font-semibold">Price</th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            {(() => {\n                              // Parse first trade from pasted data\n                              if (!importData.trim()) {\n                                return (\n                                  <tr className="border-b last:border-b-0">\n                                    <td colSpan={6} className="px-2 py-3 text-center text-muted-foreground italic">\n                                      Paste trade data below to see live preview...\n                                    </td>\n                                  </tr>\n                                );\n                              }\n\n                              // Use format-based parser if active format is set, otherwise use default parser\n                              const { trades, errors } = activeFormat \n                                ? parseTradesWithFormat(importData, activeFormat)\n                                : parseBrokerTrades(importData);\n\n                              if (trades.length === 0) {\n                                return (\n                                  <tr className="border-b last:border-b-0">\n                                    <td colSpan={6} className="px-2 py-3 text-center text-orange-600 dark:text-orange-400">\n                                      ⚠️ Unable to parse - check format\n                                    </td>\n                                  </tr>\n                                );\n                              }\n\n                              const firstTrade = trades[0];\n                              return (\n                                <tr className="border-b last:border-b-0 bg-green-50/50 dark:bg-green-950/20">\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.time}</td>\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.order}</td>\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.symbol}</td>\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.type}</td>\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.qty}</td>\n                                  <td className="px-2 py-2 text-foreground">{firstTrade.price}</td>\n                                </tr>\n                              );\n                            })()}\n                          </tbody>\n                        </table>\n                      </div>\n                      <div className="flex items-center justify-between mt-2">\n                        <p className="text-xs text-muted-foreground">\n                          ✨ This preview updates automatically as you paste - check your format before importing\n                        </p>\n                        <div className="flex items-center gap-2">\n                          <select\n                            className="h-9 px-3 text-sm border rounded-md bg-background disabled:opacity-50"\n                            onChange={(e) => {\n                              if (e.target.value) {\n                                const formatId = e.target.value;\n                                const loadedFormat = savedFormats[formatId];\n\n                                // Set user's manual selection to prevent auto-override\n                                setUserSelectedFormatId(formatId);\n\n                                // Recalculate positions based on current textarea's first line\n                                const textarea = importDataTextareaRef.current;\n                                if (textarea && loadedFormat) {\n                                  const currentFirstLine = textarea.value.trim().split('\n')[0] || "";\n                                  if (currentFirstLine) {\n                                    const recalculatedFormat = recalculateFormatPositions(loadedFormat, currentFirstLine);\n                                    setBuildModeData(recalculatedFormat);\n                                    setActiveFormat(recalculatedFormat);\n                                    setDetectedFormatLabel(loadedFormat.label || formatId);\n                                  } else {\n                                    setBuildModeData(loadedFormat);\n                                    setActiveFormat(loadedFormat);\n                                    setDetectedFormatLabel(loadedFormat.label || formatId);\n                                  }\n                                } else {\n                                  setBuildModeData(loadedFormat);\n                                  setActiveFormat(loadedFormat);\n                                  setDetectedFormatLabel(loadedFormat.label || formatId);\n                                }\n                                setIsBuildMode(true);\n                                console.log("✅ Format manually selected:", loadedFormat.label || formatId, loadedFormat);\n                              }\n                            }}\n                            defaultValue=""\n                            data-testid="select-load-format"\n                            disabled={formatsLoading}\n                          >\n                            <option value="">\n                              {formatsLoading \n                                ? "Loading formats..." \n                                : `Load Saved Format${Object.keys(savedFormats).length > 0 ? ` (${Object.keys(savedFormats).length})` : ""}`}\n                            </option>\n                            {Object.entries(savedFormats).map(([formatId, format]) => (\n                              <option key={formatId} value={formatId}>\n                                {format.label || formatId}\n                              </option>\n                            ))}\n                          </select>\n                          {currentUser?.userId && (\n                            <Button\n                              variant="ghost"\n                              size="sm"\n                              className="h-9 px-2"\n                              onClick={async () => {\n                                console.log("🔃 Manually refreshing formats...");\n                                setFormatsLoading(true);\n                                try {\n                                  const idToken = await getCognitoToken();\n                                  if (idToken) {\n                                    const response = await fetch(`/api/user-formats/${currentUser.userId}`, {\n                                      headers: { 'Authorization': `Bearer ${idToken}` }\n                                    });\n                                    if (response.ok) {\n                                      const formats = await response.json();\n                                      console.log("✅ Formats refreshed:", Object.keys(formats).length);\n                                      setSavedFormats(formats);\n                                      toast({\n                                        title: "Refreshed",\n                                        description: `Loaded ${Object.keys(formats).length} format(s)`\n                                      });\n                                    }\n                                  }\n                                } catch (err) {\n                                  console.error("❌ Refresh failed:", err);\n                                  toast({\n                                    title: "Refresh Failed",\n                                    description: "Could not load formats",\n                                    variant: "destructive"\n                                  });\n                                } finally {\n                                  setFormatsLoading(false);\n                                }\n                              }}\n                              data-testid="button-refresh-formats"\n                              title="Refresh saved formats"\n                            >\n                              <RotateCw className="w-3.5 h-3.5" />\n                            </Button>\n                          )}\n                          <Button\n                            variant="outline"\n                            size="sm"\n                            className="gap-1.5"\n                            onClick={() => {\n                              // Auto-extract from first line - using WORD POSITIONS not character positions\n                              const firstLine = importData.trim().split('\n')[0] || "";\n                              const parts = firstLine.split(/\s+/);\n\n                              // Find positions by matching patterns (track found state to avoid reusing parts)\n                              let timePos = -1, orderPos = -1, symbolPos = -1, typePos = -1, qtyPos = -1, pricePos = -1;\n                              let timeVal = "", orderVal = "", symbolVal = "", typeVal = "", qtyVal = "", priceVal = "";\n                              let foundTime = false, foundOrder = false, foundSymbol = false;\n\n                              // Identify price and qty first (they're at the end) - use array INDEX, not character position!\n                              const lastIdx = parts.length - 1;\n                              if (lastIdx >= 0 && /^\d+(\.\d+)?$/.test(parts[lastIdx])) {\n                                qtyPos = lastIdx;\n                                qtyVal = parts[lastIdx];\n                              }\n                              if (lastIdx >= 1 && /^\d+(\.\d+)?$/.test(parts[lastIdx - 1])) {\n                                pricePos = lastIdx - 1;\n                                priceVal = parts[lastIdx - 1];\n                              }\n\n                              // Now scan left to right for time, order, symbol, type\n                              for (let i = 0; i < parts.length; i++) {\n                                const part = parts[i];\n\n                                // Time pattern: HH:MM:SS - use index i, not indexOf!\n                                if (!foundTime && /^\d{1,2}:\d{2}:\d{2}$/.test(part)) {\n                                  timePos = i;\n                                  timeVal = part;\n                                  foundTime = true;\n                                  continue;\n                                }\n\n                                // Order: BUY/SELL - use index i, not indexOf!\n                                if (!foundOrder && /^(BUY|SELL)$/i.test(part)) {\n                                  orderPos = i;\n                                  orderVal = part.toUpperCase();\n                                  foundOrder = true;\n                                  continue;\n                                }\n\n                                // Symbol: all caps, comes after order - use index i, not indexOf!\n                                if (!foundSymbol && foundOrder && /^[A-Z]+$/.test(part) && !/^(CE|PE|FUT|MIS|NRML|IOC)$/i.test(part)) {\n                                  symbolPos = i;\n                                  symbolVal = part;\n                                  foundSymbol = true;\n                                  continue;\n                                }\n\n                                // Type: (CE, PE, FUT, MIS, NRML, etc) or numbers (strike price, expiry codes) - use index i, not indexOf!\n                                if (foundSymbol && !typeVal && (/(CE|PE|FUT|NRML|MIS|IOC|CALL|PUT)$/i.test(part) || /^\d+$/.test(part))) {\n                                  typePos = i;\n                                  typeVal = part;\n                                }\n                              }\n\n                              setBuildModeData({\n                                sampleLine: firstLine,\n                                positions: {\n                                  time: timePos >= 0 ? [timePos] : [],\n                                  order: orderPos >= 0 ? [orderPos] : [],\n                                  symbol: symbolPos >= 0 ? [symbolPos] : [],\n                                  type: typePos >= 0 ? [typePos] : [],\n                                  qty: qtyPos >= 0 ? [qtyPos] : [],\n                                  price: pricePos >= 0 ? [pricePos] : []\n                                },\n                                displayValues: {\n                                  time: timeVal,\n                                  order: orderVal,\n                                  symbol: symbolVal,\n                                  type: typeVal,\n                                  qty: qtyVal,\n                                  price: priceVal\n                                }\n                              });\n                              setIsBuildMode(true);\n                              console.log("🔨 Build mode - auto-extracted from first line with CORRECT word positions", { positions: { timePos, orderPos, symbolPos, typePos, qtyPos, pricePos }, displayValues: { timeVal, orderVal, symbolVal, typeVal, qtyVal, priceVal } });\n                            }}\n                            data-testid="button-build"\n                          >\n                            <Hammer className="w-3.5 h-3.5" />\n                            Build\n                          </Button>\n                        </div>\n                      </div>\n                    </>\n                  )}\n                </div>\n\n                <Textarea\n                  ref={importDataTextareaRef}\n                  id="paste-data"\n                  placeholder="Paste your trade data..."\n                  value={importData}\n                  onChange={(e) => setImportData(e.target.value)}\n                  className="min-h-32 text-xs"\n                  data-testid="textarea-paste-data"\n                />\n              </div>\n\n              {importError && (\n                <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-3">\n                  <p className="text-xs text-red-600 dark:text-red-400">{importError}</p>\n                </div>\n              )}\n\n              {parseErrors.length > 0 && (\n                <div className="bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md p-3 max-h-40 overflow-y-auto custom-thin-scrollbar">\n                  <p className="text-xs font-medium text-slate-700 dark:text-slate-300 mb-2">\n                    {parseErrors.length} line(s) could not be parsed\n                  </p>\n                  <div className="space-y-2">\n                    {parseErrors.map((error, index) => (\n                      <div\n                        key={index}\n                        className="bg-white rounded p-2 text-xs border border-yellow-100"\n                      >\n                        <div className="flex justify-between items-start gap-2">\n                          <span className="font-mono text-yellow-700">\n                            Line {error.line}:\n                          </span>\n                          <span className="text-red-600 font-medium">\n                            {error.reason}\n                          </span>\n                        </div>\n                        <div className="mt-1 text-gray-600 font-mono truncate">\n                          {error.content}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              <div className="flex justify-end gap-2 pt-3 border-t border-slate-200 dark:border-slate-700">\n                <Button\n                  variant="ghost"\n                  size="sm"\n                  onClick={() => {\n                    setShowImportModal(false);\n                    setImportData("");\n                    setImportError("");\n                    setParseErrors([]);\n                    // Reset user format selection for fresh start next time\n                    setUserSelectedFormatId(null);\n                  }}\n                  className="h-8 text-xs"\n                >\n                  Cancel\n                </Button>\n                <Button \n                  size="sm"\n                  onClick={handleImportData}\n                  className="h-8 text-xs"\n                >\n                  Import\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Trading Challenge Coming Soon Modal */}\n        <Dialog open={showTradingChallengeModal} onOpenChange={setShowTradingChallengeModal}>\n          <DialogContent className="max-w-sm">\n            <DialogHeader className="text-center">\n              <div className="flex justify-center mb-4">\n                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">\n                  <Trophy className="h-8 w-8 text-white" />\n                </div>\n              </div>\n              <DialogTitle className="text-xl font-bold text-center">Trading Challenge</DialogTitle>\n              <p className="text-sm text-gray-500 dark:text-gray-400 mt-2 text-center">\n                Coming Soon\n              </p>\n            </DialogHeader>\n            <div className="py-4 space-y-3">\n              <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">\n                <Users className="h-5 w-5 text-blue-500" />\n                <div>\n                  <p className="text-sm font-medium">Compete with Traders</p>\n                  <p className="text-xs text-gray-500">Join 7-day trading challenges</p>\n                </div>\n              </div>\n              <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">\n                <BarChart3 className="h-5 w-5 text-green-500" />\n                <div>\n                  <p className="text-sm font-medium">Live P&L Tracking</p>\n                  <p className="text-xs text-gray-500">Real-time ranking based on your trades</p>\n                </div>\n              </div>\n              <div className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">\n                <Trophy className="h-5 w-5 text-amber-500" />\n                <div>\n                  <p className="text-sm font-medium">Leaderboard Rankings</p>\n                  <p className="text-xs text-gray-500">See your position among all participants</p>\n                </div>\n              </div>\n            </div>\n            <Button \n              onClick={() => setShowTradingChallengeModal(false)}\n              className="w-full"\n              data-testid="button-close-challenge-modal"\n            >\n              Got It\n            </Button>\n          </DialogContent>\n        </Dialog>\n\n        <TradingJournalModal open={!!showJournalInfoModal} onOpenChange={setShowJournalInfoModal} isAutoPopup={showJournalInfoModal === "auto"} />\n\n\n        {/* Paper Trading (Demo Trading) Modal - Minimalist Design */}\n        <Dialog open={showPaperTradingModal} onOpenChange={setShowPaperTradingModal}>\n          <DialogContent className="w-full h-auto sm:max-w-2xl sm:max-h-[85vh] rounded-none sm:rounded-lg overflow-hidden p-0 bg-white sm:dark:bg-gray-900 hidden sm:flex flex-col">\n            {/* Mobile Wallet-Style View */}\n            <div className="flex flex-col h-full sm:hidden">\n              {/* Hero Balance Section - Dark gradient background */}\n              <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 px-5 pt-8 pb-6 relative">\n\n              <div className="text-gray-400 text-xs mb-1">P&L</div>\n              <div className={`text-3xl font-bold mb-2 ${paperTradingTotalPnl >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`} data-testid="paper-trading-pnl-mobile">\n                {hidePositionDetails ? '***' : `₹${paperTradingTotalPnl.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`}\n              </div>\n              <div className="text-sm flex items-center gap-1 text-gray-400">\n                <span>{hidePositionDetails ? '***' : `₹${paperTradingCapital.toLocaleString('en-IN')}`}</span>\n                <span className="text-gray-500 text-xs">Total Capital</span>\n              </div>\n\n                {/* Quick Stats */}\n                <div className="flex items-center gap-4 mt-4 text-xs">\n                  <div className="flex items-center gap-1.5 text-gray-400">\n                    <span>Positions:</span>\n                    <span className="text-white font-medium">{paperPositions.filter(p => p.isOpen).length}</span>\n                  </div>\n                  <div className="flex items-center gap-1.5 text-gray-400">\n                    <span>Trades:</span>\n                    <span className="text-white font-medium">{paperTradeHistory.length}</span>\n                  </div>\n                  <Button\n                    onClick={() => setHidePositionDetails(!hidePositionDetails)}\n                    size="icon"\n                    variant="ghost"\n                    className="h-6 w-6 ml-auto text-gray-400 hover:text-white"\n                    data-testid="button-toggle-visibility-mobile"\n                  >\n                    {hidePositionDetails ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}\n                  </Button>\n                </div>\n              </div>\n\n              {/* Content Area - Scrollable */}\n              <div className="flex-1 overflow-y-auto bg-white dark:bg-gray-950 custom-thin-scrollbar">\n                {/* Trade Entry Card */}\n                <div className="p-4">\n                  <div className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4 border border-gray-100 dark:border-gray-800">\n                    <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">New Trade</div>\n\n                    {/* Instrument Search */}\n                    <div className="relative mb-3">\n                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />\n                      <Input\n                        type="text"\n                        placeholder="Search instrument..."\n                        value={paperTradeSymbolSearch}\n                        onChange={(e) => {\n                          const query = e.target.value;\n                          if (!query && paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                            const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                            if (stream) stream.close();\n                            paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                            setPaperTradingWsStatus('disconnected');\n                          }\n                          setPaperTradeSymbolSearch(query);\n                          setPaperTradeSymbol("");\n                          setPaperTradeCurrentPrice(null);\n                          if (query.length > 0) {\n                            searchPaperTradingInstruments(query);\n                          } else {\n                            setPaperTradeSearchResults([]);\n                          }\n                        }}\n                        className="h-10 pl-10 text-sm rounded-lg bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"\n                        data-testid="input-paper-trade-search-mobile"\n                      />\n                      {/* Search Dropdown */}\n                      {paperTradeSymbolSearch && !paperTradeSymbol && (\n                        <div className="absolute z-[100] left-0 right-0 mt-1 max-h-48 overflow-auto bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg">\n                          {paperTradeSearchLoading ? (\n                            <div className="px-4 py-3 text-sm text-gray-500 flex items-center gap-2">\n                              <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                              Searching...\n                            </div>\n                          ) : paperTradeSearchResults.length === 0 ? (\n                            <div className="px-4 py-3 text-sm text-gray-500">No results found</div>\n                          ) : (\n                            paperTradeSearchResults.slice(0, 6).map((stock, idx) => (\n                              <button\n                                key={`${stock.symbol}-${stock.exchange}-${idx}`}\n                                onClick={() => {\n                                  setSelectedPaperTradingInstrument(stock);\n                                  setPaperTradeSymbol(stock.symbol);\n                                  setPaperTradeSymbolSearch(stock.symbol);\n                                  if (paperTradeType === 'STOCK') {\n                                    setPaperTradeQuantity("");\n                                  } else {\n                                    setPaperTradeLotInput("1");\n                                  }\n                                  fetchPaperTradePrice(stock);\n                                }}\n                                className="w-full text-left px-4 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between text-sm border-b border-gray-100 dark:border-gray-800 last:border-0"\n                                data-testid={`select-stock-mobile-${stock.symbol}`}\n                              >\n                                <span className="font-medium">{stock.symbol}</span>\n                                <span className="text-xs text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{stock.exchange}</span>\n                              </button>\n                            ))\n                          )}\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Type and Option Chain Row */}\n                    <div className="flex gap-2 mb-3">\n                      <Select \n                        value={paperTradeType} \n                        onValueChange={(v) => {\n                          const newType = v as 'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX';\n                          if (paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                            const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                            if (stream) stream.close();\n                            paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                          }\n                          setPaperTradeType(newType);\n                          setPaperTradeSymbol("");\n                          setPaperTradeSymbolSearch("");\n                          setPaperTradeSearchResults([]);\n                          setPaperTradeCurrentPrice(null);\n                          setSelectedPaperTradingInstrument(null);\n                          setPaperTradeQuantity("");\n                          setPaperTradeLotInput("");\n                          setPaperTradingWsStatus('disconnected');\n                        }}\n                      >\n                        <SelectTrigger className="flex-1 h-10 text-sm rounded-lg" data-testid="select-paper-trade-type-mobile">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value="STOCK">Stock</SelectItem>\n                          <SelectItem value="FUTURES">Futures</SelectItem>\n                          <SelectItem value="OPTIONS">Options</SelectItem>\n                          <SelectItem value="MCX">MCX</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <Button\n                        onClick={() => {\n                          fetchOptionChainData();\n                          setShowOptionChain(true);\n                        }}\n                        size="icon"\n                        variant="outline"\n                        className="h-10 w-10 rounded-lg"\n                        data-testid="button-option-chain-mobile"\n                      >\n                        <Grid3X3 className="h-4 w-4" />\n                      </Button>\n                    </div>\n\n                    {/* Quantity and Price Row */}\n                    <div className="flex gap-2 mb-4">\n                      {paperTradeType === 'STOCK' ? (\n                        <Input\n                          type="number"\n                          placeholder="Quantity"\n                          value={paperTradeQuantity}\n                          onChange={(e) => setPaperTradeQuantity(e.target.value)}\n                          className="flex-1 h-10 text-sm text-center rounded-lg"\n                          min="1"\n                          data-testid="input-paper-trade-qty-mobile"\n                        />\n                      ) : (\n                        <Input\n                          type="number"\n                          placeholder="Lots"\n                          value={paperTradeLotInput}\n                          onChange={(e) => setPaperTradeLotInput(e.target.value)}\n                          className="flex-1 h-10 text-sm text-center rounded-lg"\n                          min="1"\n                          data-testid="input-paper-trade-lots-mobile"\n                        />\n                      )}\n                      <div className="flex-1 h-10 flex items-center justify-center text-sm font-medium border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-800">\n                        {paperTradePriceLoading ? (\n                          <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                        ) : paperTradeCurrentPrice ? (\n                          <span>₹{paperTradeCurrentPrice.toFixed(2)}</span>\n                        ) : (\n                          <span className="text-gray-500 dark:text-gray-400">Price</span>\n                        )}\n                      </div>\n                    </div>\n\n                    {/* Trade Value Display */}\n                    {paperTradeSymbol && paperTradeCurrentPrice && (() => {\n                      const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n                      if (!inputValue) return null;\n                      let quantity = parseInt(inputValue);\n                      if (paperTradeType !== 'STOCK') {\n                        const lotSize = getLotSizeForInstrument(paperTradeSymbol, paperTradeType);\n                        quantity = quantity * lotSize;\n                      }\n                      return (\n                        <div className="text-xs text-gray-500 dark:text-gray-400 text-center mb-3">\n                          Trade Value: ₹{(quantity * paperTradeCurrentPrice).toLocaleString('en-IN')}\n                        </div>\n                      );\n                    })()}\n\n                    {/* Action Buttons */}\n                    <div className="flex gap-3">\n                      {(() => {\n                        const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n                        return (\n                          <>\n                            <Button\n                              onClick={() => { setPaperTradeAction('BUY'); executePaperTrade(); }}\n                              disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                              className="flex-1 h-12 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold text-base"\n                              data-testid="button-paper-buy-mobile"\n                            >\n                              BUY\n                            </Button>\n                            <Button\n                              onClick={() => { setPaperTradeAction('SELL'); executePaperTrade(); }}\n                              disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                              className="flex-1 h-12 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold text-base"\n                              data-testid="button-paper-sell-mobile"\n                            >\n                              SELL\n                            </Button>\n\n                            {/* Mobile SL Button with Dropdown */}\n                            <div className="relative">\n                              <Button\n                                onClick={() => setShowMobilePaperTradeSLDropdown(!showMobilePaperTradeSLDropdown)}\n                                disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                                variant={paperTradeSLEnabled ? "default" : "outline"}\n                                className={`h-12 w-12 rounded-xl ${paperTradeSLEnabled ? 'bg-orange-500 hover:bg-orange-600 text-white' : ''}`}\n                                data-testid="button-paper-sl-mobile"\n                              >\n                                {paperTradeSLEnabled ? <ShieldCheck className="h-5 w-5" /> : <Shield className="h-5 w-5" />}\n                              </Button>\n                              {showMobilePaperTradeSLDropdown && (\n                                <div className="absolute z-50 bottom-14 right-0 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg">\n                                  <div className="p-4 space-y-3 min-w-[240px]">\n                                    <div className="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">Stop Loss Configuration</div>\n                                    <div>\n                                      <label className="text-[10px] text-gray-500 uppercase">Type</label>\n                                      <Select value={paperTradeSLType} onValueChange={(v: any) => setPaperTradeSLType(v)}>\n                                        <SelectTrigger className="h-9 text-sm mt-1">\n                                          <SelectValue />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          <SelectItem value="price">Price SL</SelectItem>\n                                          <SelectItem value="percent">% SL</SelectItem>\n                                          <SelectItem value="duration">Duration</SelectItem>\n                                          <SelectItem value="high">Candle High</SelectItem>\n                                          <SelectItem value="low">Candle Low</SelectItem>\n                                        </SelectContent>\n                                      </Select>\n                                    </div>\n\n                                    {(paperTradeSLType === 'high' || paperTradeSLType === 'low') && (\n                                      <div>\n                                        <label className="text-[10px] text-gray-500 uppercase">Timeframe</label>\n                                        <Select value={paperTradeSLTimeframe} onValueChange={(v) => setPaperTradeSLTimeframe(v)}>\n                                          <SelectTrigger className="h-9 text-sm mt-1">\n                                            <SelectValue />\n                                          </SelectTrigger>\n                                          <SelectContent>\n                                            <SelectItem value="1m">1 Minute</SelectItem>\n                                            <SelectItem value="5m">5 Minutes</SelectItem>\n                                            <SelectItem value="15m">15 Minutes</SelectItem>\n                                            <SelectItem value="30m">30 Minutes</SelectItem>\n                                            <SelectItem value="1h">1 Hour</SelectItem>\n                                            <SelectItem value="4h">4 Hours</SelectItem>\n                                            <SelectItem value="1d">1 Day</SelectItem>\n                                          </SelectContent>\n                                        </Select>\n                                      </div>\n                                    )}\n\n                                    {paperTradeSLType === 'duration' && (\n                                      <div className="flex gap-1.5">\n                                        <Input\n                                          type="number"\n                                          placeholder="Duration"\n                                          value={paperTradeSLValue}\n                                          onChange={(e) => setPaperTradeSLValue(e.target.value)}\n                                          className="h-9 text-sm flex-1"\n                                          data-testid="input-paper-sl-duration-mobile"\n                                        />\n                                        <Select value={paperTradeSLDurationUnit} onValueChange={(v) => setPaperTradeSLDurationUnit(v)}>\n                                          <SelectTrigger className="h-9 text-sm w-20">\n                                            <SelectValue />\n                                          </SelectTrigger>\n                                          <SelectContent>\n                                            <SelectItem value="min">Min</SelectItem>\n                                            <SelectItem value="hr">Hr</SelectItem>\n                                          </SelectContent>\n                                        </Select>\n                                      </div>\n                                    )}\n\n                                    {paperTradeSLType !== 'high' && paperTradeSLType !== 'low' && paperTradeSLType !== 'duration' && (\n                                      <Input\n                                        type="number"\n                                        placeholder={paperTradeSLType === 'price' ? 'Price' : '%'}\n                                        value={paperTradeSLValue}\n                                        onChange={(e) => setPaperTradeSLValue(e.target.value)}\n                                        className="h-9 text-sm"\n                                        data-testid="input-paper-sl-value-mobile"\n                                      />\n                                    )}\n\n                                    <div className="flex gap-2 pt-1">\n                                      <Button\n                                        onClick={() => {\n                                          setPaperTradeSLEnabled(false);\n                                          setPaperTradeSLValue("");\n                                          setShowMobilePaperTradeSLDropdown(false);\n                                        }}\n                                        size="sm"\n                                        variant="outline"\n                                        className="flex-1 h-9"\n                                        data-testid="button-clear-paper-sl-mobile"\n                                      >\n                                        Clear\n                                      </Button>\n                                      <Button\n                                        onClick={() => {\n                                          if (paperTradeSLValue || paperTradeSLType === 'high' || paperTradeSLType === 'low') {\n                                            setPaperTradeSLEnabled(true);\n                                            toast({\n                                              title: "Stop Loss Set",\n                                              description: paperTradeSLType === 'price' \n                                                ? `SL at ₹${paperTradeSLValue}` \n                                                : paperTradeSLType === 'percent'\n                                                ? `SL at ${paperTradeSLValue}% loss`\n                                                : paperTradeSLType === 'duration'\n                                                ? `SL after ${paperTradeSLValue} ${paperTradeSLDurationUnit}`\n                                                : `SL at ${paperTradeSLTimeframe} candle ${paperTradeSLType}`\n                                            });\n                                          }\n                                          setShowMobilePaperTradeSLDropdown(false);\n                                        }}\n                                        size="sm"\n                                        className="flex-1 h-9 bg-orange-500 hover:bg-orange-600 text-white"\n                                        data-testid="button-set-paper-sl-mobile"\n                                      >\n                                        Set SL\n                                      </Button>\n                                    </div>\n                                  </div>\n                                </div>\n                              )}\n                            </div>\n                          </>\n                        );\n                      })()}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Open Positions Section */}\n                {paperPositions.filter(p => p.isOpen).length > 0 && (\n                  <div className="">\n                    <div className="flex items-center justify-between mb-3">\n                      <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider flex items-center gap-2">\n                        Open Positions\n                        {paperTradingWsStatus === 'connected' && <span className="w-1.5 h-1.5 bg-green-500 rounded-full" />}\n                      </div>\n                      <Button\n                        onClick={exitAllPaperPositions}\n                        size="sm"\n                        variant="ghost"\n                        className="h-7 px-2 text-xs text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20"\n                        data-testid="button-exit-all-mobile"\n                      >\n                        Exit All\n                      </Button>\n                    </div>\n                    <div className="space-y-2">\n                      {paperPositions.filter(p => p.isOpen).map(position => {\n                        const entryTimeParts = position.entryTime.match(/(\d+):(\d+):(\d+)\s*(AM|PM)?/i);\n                        let durationStr = '-';\n                        if (entryTimeParts) {\n                          const now = new Date();\n                          const entryDate = new Date();\n                          let hours = parseInt(entryTimeParts[1]);\n                          const minutes = parseInt(entryTimeParts[2]);\n                          const seconds = parseInt(entryTimeParts[3]);\n                          const ampm = entryTimeParts[4];\n                          if (ampm) {\n                            if (ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;\n                            if (ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;\n                          }\n                          entryDate.setHours(hours, minutes, seconds, 0);\n                          const diffMs = now.getTime() - entryDate.getTime();\n                          if (diffMs > 0) {\n                            const diffMins = Math.floor(diffMs / 60000);\n                            const diffHrs = Math.floor(diffMins / 60);\n                            const remainMins = diffMins % 60;\n                            durationStr = diffHrs > 0 ? `${diffHrs}h ${remainMins}m` : `${remainMins}m`;\n                          } else {\n                            durationStr = '0m';\n                          }\n                        }\n                        return (\n                          <div \n                            key={position.id}\n                            className="bg-gray-50 dark:bg-gray-900 rounded-xl p-3 border border-gray-100 dark:border-gray-800"\n                            data-testid={`position-card-${position.symbol}`}\n                          >\n                            <div className="flex items-center justify-between mb-2">\n                              <div className="flex items-center gap-2">\n                                <span className="font-medium text-sm">{position.symbol}</span>\n                                <span className={`text-[10px] px-1.5 py-0.5 rounded ${\n                                  position.action === 'BUY' \n                                    ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' \n                                    : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'\n                                }`}>\n                                  {position.action}\n                                </span>\n                              </div>\n                              <span className="text-xs text-gray-400">{durationStr}</span>\n                            </div>\n                            <div className="flex items-center justify-between text-xs">\n                              <div className="text-gray-600 dark:text-gray-400">\n                                Qty: {position.quantity} | Avg: {hidePositionDetails ? '***' : `₹${position.entryPrice.toFixed(2)}`}\n                              </div>\n                              <div className={`font-semibold ${position.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                                {hidePositionDetails ? '***' : `₹${position.pnl.toFixed(0)}`}\n                                <span className="text-[10px] ml-1">({position.pnlPercent >= 0 ? '+' : ''}{position.pnlPercent.toFixed(1)}%)</span>\n                              </div>\n                            </div>\n                            <div className="text-[10px] text-gray-400 mt-1">\n                              LTP: ₹{position.currentPrice.toFixed(2)}\n                              {(position as any).slTriggerPrice && (\n                                <span className="text-orange-500 ml-2">SL: ₹{(position as any).slTriggerPrice.toFixed(2)}</span>\n                              )}\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </div>\n                )}\n\n                {/* Trade History Section */}\n                {paperTradeHistory.length > 0 && (\n                  <div className="">\n                    <div className="flex items-center justify-between mb-3">\n                      <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">\n                        Trade History\n                      </div>\n                      <Button\n                        onClick={recordAllPaperTrades}\n                        size="sm"\n                        variant="ghost"\n                        className="h-7 px-2 text-xs text-blue-600 hover:text-blue-700 hover:bg-blue-50 dark:hover:bg-blue-900/20"\n                        data-testid="button-record-all-mobile"\n                      >\n                        Record\n                      </Button>\n                    </div>\n                    <div className="space-y-1 bg-white dark:bg-gray-900/50 rounded-lg p-3">\n                      {[...paperTradeHistory].reverse().slice(0, 10).map(trade => (\n                        <div \n                          key={trade.id}\n                          className="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-800 last:border-0"\n                        >\n                          <div className="flex items-center gap-3">\n                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium ${\n                              trade.action === 'BUY' \n                                ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' \n                                : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'\n                            }`}>\n                              {trade.action === 'BUY' ? 'B' : 'S'}\n                            </div>\n                            <div>\n                              <div className="text-sm font-medium">{trade.symbol}</div>\n                              <div className="text-[10px] text-gray-400">{trade.time} | Qty: {trade.quantity}</div>\n                            </div>\n                          </div>\n                          <div className="text-right">\n                            <div className="text-sm font-medium">₹{trade.price.toFixed(2)}</div>\n                            <div className={`text-xs ${\n                              !trade.pnl ? 'text-gray-600 dark:text-gray-400' : trade.pnl.includes('+') ? 'text-green-600' : 'text-red-600'\n                            }`}>\n                              {trade.pnl || '-'}\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Footer */}\n                <div className="px-4 pb-6">\n                  <div className="flex items-center justify-between pt-3 border-t border-gray-100 dark:border-gray-800">\n                    <button\n                      onClick={resetPaperTradingAccount}\n                      className="text-xs text-gray-400 hover:text-red-500 transition-colors"\n                      data-testid="button-reset-mobile"\n                    >\n                      Reset Account\n                    </button>\n                    <span className="text-xs text-gray-400">Demo mode</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Desktop View - Original Design */}\n            <div className="hidden sm:block">\n              {/* Compact Header */}\n              <div className="sticky top-0 z-10 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 py-3">\n                <div className="flex items-center justify-between">\n                  <div className="flex items-center gap-2">\n                    <span className="text-sm font-semibold text-gray-900 dark:text-gray-100">Paper Trading</span>\n                    <span className={`text-[10px] px-1.5 py-0.5 rounded ${\n                      paperTradingWsStatus === 'connected' \n                        ? 'bg-green-500/10 text-green-600 dark:text-green-400' \n                        : 'bg-gray-100 dark:bg-gray-800 text-gray-500'\n                    }`} data-testid="paper-trading-ws-status">\n                      <span className={`inline-block w-1.5 h-1.5 rounded-full mr-1 ${\n                        paperTradingWsStatus === 'connected' ? 'bg-green-500' : 'bg-gray-400'\n                      }`} />\n                      {paperTradingWsStatus === 'connected' ? 'Live' : 'Offline'}\n                    </span>\n                  </div>\n                  <div className="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">\n                    <span>Capital: <span className="font-medium text-gray-900 dark:text-gray-100">₹{paperTradingCapital.toLocaleString('en-IN')}</span></span>\n                    <span className="text-gray-300 dark:text-gray-600">|</span>\n                    <span className={paperTradingTotalPnl >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}>\n                      P&L: <span className="font-medium" data-testid="paper-trading-total-pnl">{hidePositionDetails ? '***' : (paperTradingTotalPnl >= 0 ? '+' : '') + '₹' + paperTradingTotalPnl.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>\n                    </span>\n                  </div>\n                </div>\n              </div>\n\n              <div className="p-4 space-y-4">\n                {/* Compact Stats Row */}\n                <div className="flex items-center gap-4 text-xs">\n                  <div className="flex items-center gap-1.5">\n                    <span className="text-gray-500 dark:text-gray-400">Positions:</span>\n                    <span className="font-medium">{paperPositions.filter(p => p.isOpen).length}</span>\n                  </div>\n                  <div className="flex items-center gap-1.5">\n                    <span className="text-gray-500 dark:text-gray-400">Trades:</span>\n                    <span className="font-medium">{paperTradeHistory.length}</span>\n                  </div>\n                </div>\n\n                {/* Trade Entry - Compact Inline Form */}\n                <div className="border border-gray-200 dark:border-gray-800 rounded-md p-3">\n                  <div className="flex flex-wrap items-end gap-2 justify-end">\n                    {/* Symbol Search */}\n                    <div className="flex-1 min-w-[180px] relative">\n                      <div className="relative">\n                        <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-400" />\n                        <Input\n                          type="text"\n                          placeholder="Search instrument..."\n                          value={paperTradeSymbolSearch}\n                          onChange={(e) => {\n                            const query = e.target.value;\n                            if (!query && paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                              const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                              if (stream) stream.close();\n                              paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                              setPaperTradingWsStatus('disconnected');\n                            }\n                            setPaperTradeSymbolSearch(query);\n                            setPaperTradeSymbol("");\n                            setPaperTradeCurrentPrice(null);\n                            if (query.length > 0) {\n                              searchPaperTradingInstruments(query);\n                            } else {\n                              setPaperTradeSearchResults([]);\n                            }\n                          }}\n                          className="h-8 pl-8 text-xs"\n                          data-testid="input-paper-trade-search"\n                        />\n                      </div>\n                      {/* Dropdown */}\n                      {paperTradeSymbolSearch && !paperTradeSymbol && (\n                        <div className="absolute z-[100] left-0 right-0 mt-1 max-h-40 overflow-auto bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg">\n                          {paperTradeSearchLoading ? (\n                            <div className="px-3 py-2 text-xs text-gray-500 flex items-center gap-2">\n                              <div className="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                              Searching...\n                            </div>\n                          ) : paperTradeSearchResults.length === 0 ? (\n                            <div className="px-3 py-2 text-xs text-gray-500">No results</div>\n                          ) : (\n                            paperTradeSearchResults.slice(0, 6).map((stock, idx) => (\n                              <button\n                                key={`${stock.symbol}-${stock.exchange}-${idx}`}\n                                onClick={() => {\n                                  setSelectedPaperTradingInstrument(stock);\n                                  setPaperTradeSymbol(stock.symbol);\n                                  setPaperTradeSymbolSearch(stock.symbol);\n                                  if (paperTradeType === 'STOCK') {\n                                    setPaperTradeQuantity("");\n                                  } else {\n                                    setPaperTradeLotInput("1");\n                                  }\n                                  fetchPaperTradePrice(stock);\n                                }}\n                                className="w-full text-left px-3 py-1.5 hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between text-xs"\n                                data-testid={`select-stock-${stock.symbol}`}\n                              >\n                                <span className="font-medium truncate">{stock.symbol}</span>\n                                <span className="text-[10px] text-gray-400 ml-2">{stock.exchange}</span>\n                              </button>\n                            ))\n                          )}\n                        </div>\n                      )}\n                    </div>\n                    {/* Option Chain Button */}\n                    <Button\n                      onClick={() => {\n                        fetchOptionChainData();\n                        setShowOptionChain(true);\n                      }}\n                      size="icon"\n                      variant="outline"\n                      className="h-8 w-8"\n                      data-testid="button-option-chain"\n                    >\n                      <Grid3X3 className="h-4 w-4" />\n                    </Button>\n\n                    {/* Type */}\n                    <Select \n                      value={paperTradeType} \n                      onValueChange={(v) => {\n                        const newType = v as 'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX';\n                        if (paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                          const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                          if (stream) stream.close();\n                          paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                        }\n                        setPaperTradeType(newType);\n                        setPaperTradeSymbol("");\n                        setPaperTradeSymbolSearch("");\n                        setPaperTradeSearchResults([]);\n                        setPaperTradeCurrentPrice(null);\n                        setSelectedPaperTradingInstrument(null);\n                        setPaperTradeQuantity("");\n                        setPaperTradeLotInput("");\n                        setPaperTradeSLPrice("");\n                        setPaperTradingWsStatus('disconnected');\n                      }}\n                    >\n                      <SelectTrigger className="w-24 h-8 text-xs" data-testid="select-paper-trade-type">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value="STOCK">Stock</SelectItem>\n                        <SelectItem value="FUTURES">Futures</SelectItem>\n                        <SelectItem value="OPTIONS">Options</SelectItem>\n                        <SelectItem value="MCX">MCX</SelectItem>\n                      </SelectContent>\n                    </Select>\n\n                    {/* Quantity or Lots Input */}\n                    {paperTradeType === 'STOCK' ? (\n                      <Input\n                        type="number"\n                        placeholder="Qty"\n                        value={paperTradeQuantity}\n                        onChange={(e) => setPaperTradeQuantity(e.target.value)}\n                        className="w-20 h-8 text-xs text-center"\n                        min="1"\n                        data-testid="input-paper-trade-qty"\n                      />\n                    ) : (\n                      <Input\n                        type="number"\n                        placeholder="Lots"\n                        value={paperTradeLotInput}\n                        onChange={(e) => setPaperTradeLotInput(e.target.value)}\n                        className="w-20 h-8 text-xs text-center"\n                        min="1"\n                        data-testid="input-paper-trade-lots"\n                      />\n                    )}\n\n                    {/* Price Display */}\n                    <div className="w-32 h-8 flex items-center justify-center text-xs font-medium border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">\n                      {paperTradePriceLoading ? (\n                        <div className="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                      ) : paperTradeCurrentPrice ? (\n                        <span>₹{paperTradeCurrentPrice.toFixed(2)}</span>\n                      ) : (\n                        <span className="text-gray-500 dark:text-gray-400">--</span>\n                      )}\n                    </div>\n\n                    {/* Buy/Sell and SL Buttons */}\n                    {(() => {\n                      const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n                      return (\n                        <div className="flex gap-2 items-center justify-end">\n                          <Button\n                            onClick={() => { setPaperTradeAction('BUY'); executePaperTrade(); }}\n                            disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                            size="sm"\n                            className="h-8 px-4 bg-green-600 hover:bg-green-700 text-white text-xs"\n                            data-testid="button-paper-buy"\n                          >\n                            BUY\n                          </Button>\n                          <Button\n                            onClick={() => { setPaperTradeAction('SELL'); executePaperTrade(); }}\n                            disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                            size="sm"\n                            className="h-8 px-4 bg-red-600 hover:bg-red-700 text-white text-xs"\n                            data-testid="button-paper-sell"\n                          >\n                            SELL\n                          </Button>\n\n                          {/* SL Button with Dropdown */}\n                          <div className="relative">\n                            <Button\n                              onClick={() => setShowPaperTradeSLDropdown(!showPaperTradeSLDropdown)}\n                              disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                              size="sm"\n                              variant={paperTradeSLEnabled ? "default" : "outline"}\n                              className={`h-8 px-3 text-xs ${paperTradeSLEnabled ? 'bg-orange-500 hover:bg-orange-600 text-white' : ''}`}\n                              data-testid="button-paper-sl"\n                            >\n                              SL {paperTradeSLEnabled && '✓'}\n                            </Button>\n                            {showPaperTradeSLDropdown && (\n                              <div className="fixed z-[9999] top-10 -right-2 mt-1 w-64 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg">\n                                <div className="p-2.5 space-y-1.5">\n                                  <div>\n                                    <label className="text-[10px] text-gray-500 uppercase">Type</label>\n                                    <Select value={paperTradeSLType} onValueChange={(v: any) => setPaperTradeSLType(v)}>\n                                      <SelectTrigger className="h-7 text-xs mt-1">\n                                        <SelectValue />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        <SelectItem value="price">Price SL</SelectItem>\n                                        <SelectItem value="percent">% SL</SelectItem>\n                                        <SelectItem value="duration">Duration</SelectItem>\n                                        <SelectItem value="high">Candle High</SelectItem>\n                                        <SelectItem value="low">Candle Low</SelectItem>\n                                      </SelectContent>\n                                    </Select>\n                                  </div>\n\n                                  {(paperTradeSLType === 'high' || paperTradeSLType === 'low') && (\n                                    <div>\n                                      <label className="text-[10px] text-gray-500 uppercase">Timeframe</label>\n                                      <Select value={paperTradeSLTimeframe} onValueChange={(v) => setPaperTradeSLTimeframe(v)}>\n                                        <SelectTrigger className="h-6 text-xs mt-0">\n                                          <SelectValue />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          <SelectItem value="1m">1 Minute</SelectItem>\n                                          <SelectItem value="5m">5 Minutes</SelectItem>\n                                          <SelectItem value="15m">15 Minutes</SelectItem>\n                                          <SelectItem value="30m">30 Minutes</SelectItem>\n                                          <SelectItem value="1h">1 Hour</SelectItem>\n                                          <SelectItem value="4h">4 Hours</SelectItem>\n                                          <SelectItem value="1d">1 Day</SelectItem>\n                                        </SelectContent>\n                                      </Select>\n                                    </div>\n                                  )}\n\n                                  {paperTradeSLType === 'duration' && (\n                                    <div className="flex gap-1.5">\n                                      <Input\n                                        type="number"\n                                        placeholder="Duration"\n                                        value={paperTradeSLValue}\n                                        onChange={(e) => setPaperTradeSLValue(e.target.value)}\n                                        className="h-6 text-xs flex-1"\n                                        data-testid="input-paper-sl-duration"\n                                      />\n                                      <Select value={paperTradeSLDurationUnit} onValueChange={(v) => setPaperTradeSLDurationUnit(v)}>\n                                        <SelectTrigger className="h-6 text-xs w-14">\n                                          <SelectValue />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                          <SelectItem value="min">Min</SelectItem>\n                                          <SelectItem value="hr">Hr</SelectItem>\n                                        </SelectContent>\n                                      </Select>\n                                    </div>\n                                  )}\n\n                                  {paperTradeSLType !== 'high' && paperTradeSLType !== 'low' && paperTradeSLType !== 'duration' && (\n                                    <Input\n                                      type="number"\n                                      placeholder={paperTradeSLType === 'price' ? 'Price' : '%'}\n                                      value={paperTradeSLValue}\n                                      onChange={(e) => setPaperTradeSLValue(e.target.value)}\n                                      className="h-6 text-xs"\n                                      data-testid="input-paper-sl-value"\n                                    />\n                                  )}\n\n                                  <Button\n                                    onClick={() => {\n                                      if (paperTradeSLValue || paperTradeSLType === 'high' || paperTradeSLType === 'low') {\n                                        setPaperTradeSLEnabled(true);\n                                        toast({\n                                          title: "Stop Loss Set",\n                                          description: paperTradeSLType === 'price' \n                                            ? `SL at ₹${paperTradeSLValue}` \n                                            : paperTradeSLType === 'percent'\n                                            ? `SL at ${paperTradeSLValue}% loss`\n                                            : paperTradeSLType === 'duration'\n                                            ? `SL after ${paperTradeSLValue} ${paperTradeSLDurationUnit}`\n                                            : `SL at ${paperTradeSLTimeframe} candle ${paperTradeSLType}`\n                                        });\n                                      }\n                                      setShowPaperTradeSLDropdown(false);\n                                    }}\n                                    size="sm"\n                                    className="w-full h-6 text-xs bg-gray-600 hover:bg-gray-700 text-white"\n                                    data-testid="button-set-paper-sl"\n                                  >\n                                    Set SL\n                                  </Button>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })()}\n                  </div>\n\n                  {/* Trade Value */}\n                  {paperTradeSymbol && paperTradeCurrentPrice && (() => {\n                    const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n                    if (!inputValue) return null;\n                    let quantity = parseInt(inputValue);\n                    if (paperTradeType !== 'STOCK') {\n                      const lotSize = getLotSizeForInstrument(paperTradeSymbol, paperTradeType);\n                      quantity = quantity * lotSize;\n                    }\n                    return (\n                      <div className="mt-2 text-[10px] text-gray-500 dark:text-gray-400">\n                        Value: ₹{(quantity * paperTradeCurrentPrice).toLocaleString('en-IN')}\n                      </div>\n                    );\n                  })()}\n                </div>\n\n                {/* Open Positions - Compact Table */}\n                {paperPositions.filter(p => p.isOpen).length > 0 && (\n                  <div>\n                    <div className="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2 flex items-center justify-between gap-2">\n                      <div className="flex items-center gap-1.5">\n                        Open Positions\n                        {paperTradingWsStatus === 'connected' && <span className="w-1 h-1 bg-green-500 rounded-full" />}\n                      </div>\n                      <div className="flex items-center gap-2">\n                        <Button\n                          onClick={() => setHidePositionDetails(!hidePositionDetails)}\n                          size="icon"\n                          variant="ghost"\n                          className="h-5 w-5"\n                          data-testid="button-toggle-position-visibility"\n                          title={hidePositionDetails ? "Show details" : "Hide details"}\n                        >\n                          {hidePositionDetails ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}\n                        </Button>\n                        <Button\n                          onClick={exitAllPaperPositions}\n                          size="sm"\n                          variant="outline"\n                          className="h-5 px-2 text-[10px] text-red-500 border-red-300 hover:bg-red-50 hover:text-red-600 dark:border-red-700 dark:hover:bg-red-900/20"\n                          data-testid="button-exit-all-positions"\n                        >\n                          Exit All\n                        </Button>\n                      </div>\n                    </div>\n                    <div className="border border-gray-200 dark:border-gray-800 rounded-md overflow-x-auto">\n                      <table className="w-full text-[11px]">\n                        <thead>\n                          <tr className="bg-gray-50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400">\n                            <th className="px-2 py-1.5 text-left font-medium">Symbol</th>\n                            <th className="px-2 py-1.5 text-center font-medium">Order</th>\n                            <th className="px-2 py-1.5 text-right font-medium">Qty</th>\n                            <th className="px-2 py-1.5 text-right font-medium">Avg</th>\n                            <th className="px-2 py-1.5 text-right font-medium">LTP</th>\n                            <th className="px-2 py-1.5 text-right font-medium">SL</th>\n                            <th className="px-2 py-1.5 text-right font-medium">P&L</th>\n                            <th className="px-2 py-1.5 text-right font-medium">%</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {paperPositions.filter(p => p.isOpen).map(position => (\n                            <tr \n                              key={position.id} \n                              className="border-t border-gray-100 dark:border-gray-800"\n                              data-testid={`position-row-${position.symbol}`}\n                            >\n                              <td className="px-2 py-1.5 font-medium flex items-center gap-2">\n                                <span>{position.symbol}</span>\n                                <button\n                                  onClick={() => exitPosition(position.id)}\n                                  className="h-5 w-5 text-red-500 hover:text-red-600 hover:opacity-80 transition-all"\n                                  data-testid="button-exit-desktop-position"\n                                  title="Exit position"\n                                >\n                                  <X className="w-3.5 h-3.5" />\n                                </button>\n                              </td>\n                              <td className="px-2 py-1.5 text-center">\n                                <span className={`text-[10px] ${position.action === 'BUY' ? 'text-green-600' : 'text-red-600'}`}>\n                                  {position.action}\n                                </span>\n                              </td>\n                              <td className="px-2 py-1.5 text-right">{position.quantity}</td>\n                              <td className="px-2 py-1.5 text-right text-gray-500">{hidePositionDetails ? '***' : position.entryPrice.toFixed(2)}</td>\n                              <td className="px-2 py-1.5 text-right">{position.currentPrice.toFixed(2)}</td>\n                              <td className="px-2 py-1.5 text-right text-orange-500 text-[10px] font-medium">\n                                {(position as any).slTriggerPrice ? `₹${(position as any).slTriggerPrice.toFixed(2)}` : '-'}\n                              </td>\n                              <td className={`px-2 py-1.5 text-right font-medium ${position.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                                {hidePositionDetails ? '***' : `₹${position.pnl.toFixed(0)}`}\n                              </td>\n                              <td className={`px-2 py-1.5 text-right text-[10px] ${position.pnlPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                                {position.pnlPercent >= 0 ? '+' : ''}{position.pnlPercent.toFixed(2)}%\n                              </td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </div>\n                )}\n\n                {/* Trade History */}\n                {paperTradeHistory.length > 0 && (\n                  <div>\n                    <div className="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2 flex items-center justify-between gap-2">\n                      <div>History</div>\n                      <Button\n                        onClick={recordAllPaperTrades}\n                        size="sm"\n                        variant="outline"\n                        className="h-5 px-2 text-[10px] text-blue-600 border-blue-300 hover:bg-blue-50 hover:text-blue-700 dark:border-blue-700 dark:hover:bg-blue-900/20"\n                        data-testid="button-record-all-trades"\n                      >\n                        Record\n                      </Button>\n                    </div>\n                    <div className="border border-gray-200 dark:border-gray-800 rounded-md overflow-x-auto max-h-40 overflow-y-auto custom-thin-scrollbar">\n                      <table className="w-full text-[11px]">\n                        <thead className="sticky top-0">\n                          <tr className="bg-gray-50 dark:bg-gray-800/50 text-gray-500 dark:text-gray-400">\n                            <th className="px-2 py-1.5 text-left font-medium">Time</th>\n                            <th className="px-2 py-1.5 text-center font-medium">Order</th>\n                            <th className="px-2 py-1.5 text-left font-medium">Symbol</th>\n                            <th className="px-2 py-1.5 text-right font-medium">Qty</th>\n                            <th className="px-2 py-1.5 text-right font-medium">Price</th>\n                            <th className="px-2 py-1.5 text-right font-medium">P&L</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {[...paperTradeHistory].reverse().map(trade => (\n                            <tr key={trade.id} className="border-t border-gray-100 dark:border-gray-800">\n                              <td className="px-2 py-1.5 text-gray-400">{trade.time}</td>\n                              <td className="px-2 py-1.5 text-center">\n                                <span className={`text-[10px] font-medium px-1.5 py-0.5 rounded ${\n                                  trade.action === 'BUY' \n                                    ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' \n                                    : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'\n                                }`}>\n                                  {trade.action}\n                                </span>\n                              </td>\n                              <td className="px-2 py-1.5 font-medium">{trade.symbol}</td>\n                              <td className="px-2 py-1.5 text-right">{trade.quantity}</td>\n                              <td className="px-2 py-1.5 text-right">₹{trade.price.toFixed(2)}</td>\n                              <td className={`px-2 py-1.5 text-right font-medium ${\n                                !trade.pnl ? 'text-gray-600 dark:text-gray-400' : trade.pnl.includes('+') ? 'text-green-600' : 'text-red-600'\n                              }`}>\n                                {trade.pnl || '-'}\n                              </td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </div>\n                )}\n\n                {/* Footer */}\n                <div className="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-800">\n                  <button\n                    onClick={resetPaperTradingAccount}\n                    className="text-[10px] text-gray-400 hover:text-red-500 transition-colors"\n                    data-testid="button-reset-paper-trading"\n                  >\n                    Reset Account\n                  </button>\n                  <span className="text-[10px] text-gray-400">Demo mode - no real trades</span>\n                </div>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Save Confirmation Dialog - Minimalistic Design */}\n        <Dialog open={showSaveConfirmation} onOpenChange={setShowSaveConfirmation}>\n          <DialogContent className="max-w-sm">\n            <DialogHeader className="space-y-2">\n              {saveConfirmationData?.error ? (\n                <>\n                  <DialogTitle className="text-red-600">Save Failed</DialogTitle>\n                  <p className="text-sm text-gray-600 dark:text-gray-400">\n                    {saveConfirmationData.errorMessage}\n                  </p>\n                </>\n              ) : (\n                <>\n                  <DialogTitle className="text-green-600">Saved Successfully</DialogTitle>\n                  <div className="space-y-2 text-sm mt-4">\n                    <div className="flex justify-between">\n                      <span className="text-gray-600 dark:text-gray-400">Date:</span>\n                      <span className="font-medium">{saveConfirmationData?.formattedDate}</span>\n                    </div>\n                    <div className="flex justify-between">\n                      <span className="text-gray-600 dark:text-gray-400">Saved to:</span>\n                      <span className="font-medium">{saveConfirmationData?.saveLocation}</span>\n                    </div>\n                    <div className="border-t pt-2 mt-2">\n                      <div className="flex justify-between">\n                        <span className="text-gray-600 dark:text-gray-400">Trades:</span>\n                        <span>{saveConfirmationData?.trades}</span>\n                      </div>\n                      <div className="flex justify-between">\n                        <span className="text-gray-600 dark:text-gray-400">Notes:</span>\n                        <span>{saveConfirmationData?.notes}</span>\n                      </div>\n                      <div className="flex justify-between">\n                        <span className="text-gray-600 dark:text-gray-400">Tags:</span>\n                        <span>{saveConfirmationData?.tags}</span>\n                      </div>\n                      <div className="flex justify-between">\n                        <span className="text-gray-600 dark:text-gray-400">Images:</span>\n                        <span>{saveConfirmationData?.images}</span>\n                      </div>\n                      <div className="flex justify-between font-semibold">\n                        <span className="text-gray-600 dark:text-gray-400">Net P&L:</span>\n                        <span>₹{saveConfirmationData?.netPnL}</span>\n                      </div>\n                    </div>\n                  </div>\n                </>\n              )}\n            </DialogHeader>\n            <div className="flex justify-center gap-3 mt-4">\n              <Button\n                onClick={() => setShowSaveConfirmation(false)}\n                variant={saveConfirmationData?.error ? "outline" : "default"}\n              >\n                OK\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Passcode Modal */}\n        <Dialog open={showPasscodeModal} onOpenChange={setShowPasscodeModal}>\n          <DialogContent className="max-w-sm">\n            <DialogHeader>\n              <DialogTitle className="text-center">Enter Passcode</DialogTitle>\n            </DialogHeader>\n            <div className="space-y-4">\n              <div className="text-center text-sm text-muted-foreground">\n                This section is protected. Please enter the passcode to\n                continue.\n              </div>\n              <div className="flex justify-center">\n                <Input\n                  type="password"\n                  placeholder="Enter 4-digit passcode"\n                  value={passcodeInput}\n                  onChange={(e) => setPasscodeInput(e.target.value)}\n                  className="w-40 text-center text-lg tracking-widest"\n                  maxLength={4}\n                  onKeyDown={(e) => {\n                    if (e.key === "Enter") {\n                      handlePasscodeSubmit();\n                    }\n                  }}\n                  autoFocus\n                  data-testid="input-passcode"\n                />\n              </div>\n              <div className="flex justify-center gap-3">\n                <Button\n                  variant="outline"\n                  onClick={handlePasscodeCancel}\n                  data-testid="button-cancel-passcode"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={handlePasscodeSubmit}\n                  data-testid="button-submit-passcode"\n                >\n                  Submit\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Option Chain Modal */}\n        <Dialog open={showOptionChain} onOpenChange={(open) => { setShowOptionChain(open); if (open) { fetchOptionChainData(selectedOptionIndex); } }}>\n          <DialogContent className="w-full max-w-2xl md:max-w-2xl p-0 md:p-0 bg-white dark:bg-gray-900 rounded-lg md:rounded-lg border border-gray-200 dark:border-gray-700">\n\n            {/* Desktop Header */}\n            <div className="hidden md:block border-b border-gray-200 dark:border-gray-700 px-4 py-2">\n              <div className="flex items-center justify-center mb-2">\n                <span className="text-xs font-semibold text-green-600 dark:text-green-400">Spot: ₹{(optionChainData?.spotPrice || 0)?.toLocaleString()}</span>\n              </div>\n\n              {/* Desktop Controls */}\n              <div className="flex items-center justify-center gap-2">\n                <Select value={selectedOptionIndex} onValueChange={(val) => { setSelectedOptionIndex(val); setSelectedOptionExpiryDate(""); setOptionChainData(null); setTimeout(() => fetchOptionChainData(val), 0); }}>\n                  <SelectTrigger className="px-2 py-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded text-gray-900 dark:text-white text-xs w-auto" data-testid="select-option-index-desktop">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg">\n                    <SelectItem value="NIFTY">NIFTY</SelectItem>\n                    <SelectItem value="BANKNIFTY">BANKNIFTY</SelectItem>\n                    <SelectItem value="SENSEX">SENSEX</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedOptionExpiryDate || (getOptionExpiryDates(selectedOptionIndex)[0]?.value || "")} onValueChange={(val) => { setSelectedOptionExpiryDate(val); fetchOptionChainData(selectedOptionIndex, val); }}>\n                  <SelectTrigger className="px-2 py-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded text-gray-900 dark:text-white text-xs w-auto" data-testid="select-option-expiry-date-desktop">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg">\n                    {getOptionExpiryDates(selectedOptionIndex).map((date) => (\n                      <SelectItem key={date.value} value={date.value}>\n                        {date.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            {/* Content Area */}\n            {/* Desktop Table View */}\n            <div className="hidden md:block px-6 py-4 overflow-y-auto max-h-96">\n              {optionChainLoading && (\n                <div className="text-center py-8">\n                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>\n                  <p className="text-sm text-gray-600 dark:text-gray-400">Loading {selectedOptionIndex} options...</p>\n                </div>\n              )}\n\n              {!optionChainLoading && optionChainData && (() => {\n                const getOptionSymbols = () => {\n                  const calls = optionChainData?.calls || [];\n                  const puts = optionChainData?.puts || [];\n                  const effectiveExpiry = normalizeExpiryDate(getEffectiveExpiry());\n                  const filteredCalls = filterOptionsByExpiry(calls, effectiveExpiry);\n                  const filteredPuts = filterOptionsByExpiry(puts, effectiveExpiry);\n                  return { calls: filteredCalls, puts: filteredPuts };\n                };\n\n                const { calls, puts } = getOptionSymbols();\n                const currentPrice = optionChainData?.spotPrice || 0;\n                const allStrikes = new Set();\n                calls.forEach(c => allStrikes.add(c.strikePrice));\n                puts.forEach(p => allStrikes.add(p.strikePrice));\n                const strikeArray = Array.from(allStrikes) as number[];\n                let atmStrike = null;\n                if (strikeArray.length > 0) {\n                  atmStrike = strikeArray.reduce((nearest, strike) => \n                    Math.abs(strike - currentPrice) < Math.abs(nearest - currentPrice) ? strike : nearest\n                  );\n                }\n\n                const filteredCalls = (() => {\n                  const itm = calls.filter(c => c.strikePrice < currentPrice && c.strikePrice !== atmStrike).reverse().slice(0, 10).reverse();\n                  const oTm = calls.filter(c => c.strikePrice > currentPrice && c.strikePrice !== atmStrike).slice(0, 10);\n                  const atm = atmStrike ? calls.filter(c => c.strikePrice === atmStrike).slice(0, 1) : [];\n                  return [...itm, ...atm, ...oTm].sort((a, b) => a.strikePrice - b.strikePrice);\n                })();\n\n                const filteredPuts = (() => {\n                  const itm = puts.filter(p => p.strikePrice > currentPrice && p.strikePrice !== atmStrike).slice(0, 10);\n                  const oTm = puts.filter(p => p.strikePrice < currentPrice && p.strikePrice !== atmStrike).reverse().slice(0, 10).reverse();\n                  const atm = atmStrike ? puts.filter(p => p.strikePrice === atmStrike).slice(0, 1) : [];\n                  return [...oTm, ...atm, ...itm].sort((a, b) => a.strikePrice - b.strikePrice);\n                })();\n\n                const maxRows = Math.max(filteredCalls.length, filteredPuts.length);\n                const getOptionStatus = (strike, isCall) => {\n                  const allStrikes = new Set();\n                  calls.forEach(c => allStrikes.add(c.strikePrice));\n                  puts.forEach(p => allStrikes.add(p.strikePrice));\n                  const strikeArray = Array.from(allStrikes);\n                  if (strikeArray.length === 0) return 'OTM';\n                  if (strike === atmStrike) return 'ATM';\n                  if (isCall) return strike < currentPrice ? 'ITM' : 'OTM';\n                  return strike > currentPrice ? 'ITM' : 'OTM';\n                };\n\n                const getExchangeForIndex = (index: string): string => {\n                  const exchangeMap: Record<string, string> = {\n                    'NIFTY': 'NFO',\n                    'BANKNIFTY': 'NFO',\n                    'SENSEX': 'BFO',\n                    'MIDCPNIFTY': 'NFO'\n                  };\n                  return exchangeMap[index] || 'NFO';\n                };\n\n                const handleOptionClick = async (option: any) => {\n                  const { symbol: instrumentSymbol, ltp, token: optionToken, exchange: optionExchange } = option;\n                  setPaperTradeSymbol(instrumentSymbol);\n                  setPaperTradeSymbolSearch(instrumentSymbol);\n                  setPaperTradeType('OPTIONS');\n                  setPaperTradeLotInput("1");\n\n                  if (ltp && ltp > 0) {\n                    setPaperTradeCurrentPrice(ltp);\n                    setPaperTradePriceLoading(false);\n                    const optionInstrument = {\n                      symbol: instrumentSymbol,\n                      exchange: optionExchange || getExchangeForIndex(selectedOptionIndex),\n                      token: optionToken || '',\n                      name: instrumentSymbol\n                    };\n                    setSelectedPaperTradingInstrument(optionInstrument);\n                    fetchPaperTradePrice(optionInstrument);\n                  }\n                  setShowOptionChain(false);\n                };\n\n                const getClasses = (strike, isCall) => {\n                  const status = getOptionStatus(strike, isCall);\n                  if (status === 'ATM') return 'px-2 py-1 bg-yellow-100 dark:bg-yellow-900/20 rounded text-center cursor-pointer hover:bg-yellow-200 dark:hover:bg-yellow-900/40 transition-colors';\n                  if (status === 'ITM' && isCall) return 'px-2 py-1 bg-green-100 dark:bg-green-900/20 rounded text-center cursor-pointer hover:bg-green-200 dark:hover:bg-green-900/40 transition-colors';\n                  if (status === 'ITM') return 'px-2 py-1 bg-red-100 dark:bg-red-900/20 rounded text-center cursor-pointer hover:bg-red-200 dark:hover:bg-red-900/40 transition-colors';\n                  return 'px-2 py-1 bg-gray-100 dark:bg-gray-800/40 rounded text-center cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800/60 transition-colors';\n                };\n\n                const getTextClasses = (strike, isCall) => {\n                  const status = getOptionStatus(strike, isCall);\n                  if (status === 'ATM') return 'text-xs font-semibold text-yellow-900 dark:text-yellow-300';\n                  if (status === 'ITM' && isCall) return 'text-xs font-semibold text-green-900 dark:text-green-300';\n                  if (status === 'ITM') return 'text-xs font-semibold text-red-900 dark:text-red-300';\n                  return 'text-xs font-semibold text-gray-700 dark:text-gray-400';\n                };\n\n                const getPriceClasses = (strike, isCall) => {\n                  const status = getOptionStatus(strike, isCall);\n                  if (status === 'ATM') return 'text-xs text-yellow-700 dark:text-yellow-400 mt-0.5';\n                  if (status === 'ITM' && isCall) return 'text-xs text-green-700 dark:text-green-400 mt-0.5';\n                  if (status === 'ITM') return 'text-xs text-red-700 dark:text-red-400 mt-0.5';\n                  return 'text-xs text-gray-600 dark:text-gray-500 mt-0.5';\n                };\n\n                if (maxRows === 0) {\n                  return <div className="text-center py-8"><p className="text-sm text-gray-600 dark:text-gray-400">No options available for {selectedOptionIndex} on {selectedOptionExpiryDate}</p></div>;\n                }\n\n                return <div className="overflow-x-auto"><table className="w-full text-xs"><thead className="sticky top-0 bg-gray-100 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-700"><tr><th className="text-left py-2 px-3 font-semibold text-gray-900 dark:text-white">CE</th><th className="text-center py-2 px-2 font-semibold text-gray-900 dark:text-white">Strike</th><th className="text-right py-2 px-3 font-semibold text-gray-900 dark:text-white">PE</th></tr></thead><tbody>{Array.from({ length: maxRows }).map((_, index) => <tr key={index} className="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800"><td className="py-2 px-3">{filteredCalls[index] ? <div onClick={() => handleOptionClick(filteredCalls[index])} className={getClasses(filteredCalls[index].strikePrice, true)} data-testid={`option-call-${filteredCalls[index].strikePrice}`}><div className={getPriceClasses(filteredCalls[index].strikePrice, true)}>₹{filteredCalls[index].ltp?.toFixed(2) || 0}</div></div> : null}</td><td className="py-2 px-2 text-center font-medium text-gray-700 dark:text-gray-300">{filteredCalls[index]?.strikePrice || filteredPuts[index]?.strikePrice || '-'}</td><td className="py-2 px-3 text-right">{filteredPuts[index] ? <div onClick={() => handleOptionClick(filteredPuts[index])} className={getClasses(filteredPuts[index].strikePrice, false)} data-testid={`option-put-${filteredPuts[index].strikePrice}`}><div className={getPriceClasses(filteredPuts[index].strikePrice, false)}>₹{filteredPuts[index].ltp?.toFixed(2) || 0}</div></div> : null}</td></tr>)}</tbody></table></div>;\n              })()}\n            </div>\n          </DialogContent>\n        </Dialog>\n\n\n        {/* Trading Master Coming Soon Modal */}\n        <Dialog open={showTradingMasterComingSoon} onOpenChange={setShowTradingMasterComingSoon}>\n          <DialogContent className="max-w-md">\n            <div className="space-y-6 py-6">\n              <div className="flex flex-col items-center justify-center space-y-4">\n                <div className="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center animate-pulse">\n                  <Activity className="h-10 w-10 text-white" />\n                </div>\n                <DialogHeader className="space-y-2">\n                  <DialogTitle className="text-center text-2xl bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-bold">\n                    Advanced Trading Master\n                  </DialogTitle>\n                </DialogHeader>\n                <div className="text-center space-y-2">\n                  <p className="text-lg font-semibold text-foreground">Coming Soon!</p>\n                  <p className="text-sm text-muted-foreground max-w-xs mx-auto">\n                    We're working on bringing you advanced trading features and analytics.\n                  </p>\n                </div>\n              </div>\n              <div className="flex justify-center">\n                <Button\n                  onClick={() => setShowTradingMasterComingSoon(false)}\n                  className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700"\n                  data-testid="button-close-trading-master-coming-soon"\n                >\n                  Got It\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Journal AI Dialog */}\n        <Dialog open={showJournalAI} onOpenChange={setShowJournalAI}>\n          <DialogContent className="max-w-5xl h-[85vh] p-0">\n            <DialogHeader className="p-6 pb-4 border-b border-gray-200 dark:border-gray-700">\n              <DialogTitle className="flex items-center gap-3">\n                <div className="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">\n                  <Bot className="h-5 w-5 text-white" />\n                </div>\n                <span className="bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-bold">\n                  Trading Journal AI Assistant\n                </span>\n              </DialogTitle>\n            </DialogHeader>\n\n            <div className="flex-1 h-full overflow-hidden">\n              <div className="grid grid-cols-1 lg:grid-cols-3 h-full">\n                {/* Performance Report */}\n                <div className="lg:col-span-2 p-6 overflow-y-auto">\n                  <div className="prose prose-sm max-w-none dark:prose-invert">\n                    {journalAIData?.report ? (\n                      <div className="whitespace-pre-wrap text-sm leading-relaxed">\n                        {journalAIData.report}\n                      </div>\n                    ) : (\n                      <div className="text-center py-12">\n                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>\n                        <p className="text-gray-600 dark:text-gray-400">\n                          Loading journal analysis...\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* Performance Trend Chart */}\n                <div className="lg:col-span-1 bg-gray-50 dark:bg-gray-800 p-6 border-l border-gray-200 dark:border-gray-700">\n                  <div className="h-full flex flex-col">\n                    <div className="mb-4">\n                      <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">\n                        Performance Trend\n                      </h3>\n                      <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">\n                        <div className="w-2 h-2 bg-gray-400 rounded-full"></div>\n                        <span>Not Profitable</span>\n                      </div>\n                    </div>\n\n                    <div className="flex-1 min-h-[250px]">\n                      {journalAIData?.performanceData &&\n                      journalAIData.performanceData.length > 0 ? (\n                        <ResponsiveContainer width="100%" height="100%">\n                          <AreaChart\n                            data={journalAIData.performanceData}\n                            margin={{\n                              top: 20,\n                              right: 20,\n                              left: 20,\n                              bottom: 20,\n                            }}\n                          >\n                            <defs>\n                              <linearGradient\n                                id="performanceGradient"\n                                x1="0"\n                                y1="0"\n                                x2="0"\n                                y2="1"\n                              >\n                                <stop\n                                  offset="0%"\n                                  stopColor="rgb(107, 114, 128)"\n                                  stopOpacity={0.4}\n                                />\n                                <stop\n                                  offset="100%"\n                                  stopColor="rgb(107, 114, 128)"\n                                  stopOpacity={0.1}\n                                />\n                              </linearGradient>\n                            </defs>\n                            <XAxis\n                              dataKey="day"\n                              axisLine={false}\n                              tickLine={false}\n                              tick={{ fontSize: 11, fill: "#6B7280" }}\n                            />\n                            <YAxis\n                              axisLine={false}\n                              tickLine={false}\n                              tick={{ fontSize: 11, fill: "#6B7280" }}\n                              tickFormatter={(value) => `₹${value}`}\n                            />\n                            <Tooltip\n                              contentStyle={{\n                                backgroundColor: "rgba(17, 24, 39, 0.95)",\n                                border: "none",\n                                borderRadius: "8px",\n                                color: "white",\n                                fontSize: "12px",\n                              }}\n                              formatter={(value: any, name: string) => [\n                                `₹${parseFloat(value).toFixed(2)}`,\n                                "P&L",\n                              ]}\n                              labelFormatter={(label) => `Day: ${label}`}\n                            />\n                            <Area\n                              type="monotone"\n                              dataKey="value"\n                              stroke="rgb(107, 114, 128)"\n                              strokeWidth={2}\n                              fill="url(#performanceGradient)"\n                            />\n                          </AreaChart>\n                        </ResponsiveContainer>\n                      ) : (\n                        <div className="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">\n                          <div className="text-center">\n                            <BarChart3 className="h-12 w-12 mx-auto mb-3 opacity-40" />\n                            <p className="text-sm">\n                              No performance data available\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n\n        {/* Minimalist Floating Pill Navigation - Mobile Only */}\n        {activeTab === "journal" && (\n          <div className="md:hidden fixed bottom-0 left-0 right-0 z-50 pb-4 px-6 pointer-events-none">\n            <div className="max-w-xs mx-auto bg-white/90 dark:bg-gray-900/90 backdrop-blur-md rounded-full shadow-lg border border-gray-200/50 dark:border-gray-700/50 pointer-events-auto">\n              <div className="flex items-center justify-around px-1.5 py-1.5">\n                {/* Home Tab */}\n                <button\n                  onClick={() => setMobileBottomTab("home")}\n                  className={`flex items-center justify-center flex-1 rounded-full px-4 py-2 transition-all duration-200 ${\n                    mobileBottomTab === "home"\n                      ? "bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md"\n                      : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"\n                  }`}\n                  data-testid="mobile-tab-home"\n                >\n                  <HomeIcon className={`h-5 w-5 ${mobileBottomTab === "home" ? "fill-current" : ""}`} />\n                </button>\n\n                {/* Insight Tab */}\n                <button\n                  onClick={() => setMobileBottomTab("insight")}\n                  className={`flex items-center justify-center flex-1 rounded-full px-4 py-2 transition-all duration-200 ${\n                    mobileBottomTab === "insight"\n                      ? "bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md"\n                      : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"\n                  }`}\n                  data-testid="mobile-tab-insight"\n                >\n                  <svg viewBox="0 0 24 16" className="h-5 w-6" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <defs>\n                      <linearGradient id={`navAreaGradient-${mobileBottomTab === "insight" ? "active" : navSparklineData.trend}`} x1="0" y1="0" x2="0" y2="1">\n                        <stop offset="0%" stopColor={mobileBottomTab === "insight" ? "#d1d5db" : (navSparklineData.trend === "up" ? "#22c55e" : navSparklineData.trend === "down" ? "#ef4444" : "#9ca3af")} stopOpacity="0.4" />\n                        <stop offset="100%" stopColor={mobileBottomTab === "insight" ? "#d1d5db" : (navSparklineData.trend === "up" ? "#22c55e" : navSparklineData.trend === "down" ? "#ef4444" : "#9ca3af")} stopOpacity="0.05" />\n                      </linearGradient>\n                    </defs>\n                    <polygon \n                      points={`0,14 ${navSparklineData.points.split(' ').map((p, i) => {\n                        const [x, y] = p.split(',');\n                        return `${(parseFloat(x) / 40 * 22) + 1},${(parseFloat(y) / 24 * 12) + 1}`;\n                      }).join(' ')} 22,14`}\n                      fill={`url(#navAreaGradient-${mobileBottomTab === "insight" ? "active" : navSparklineData.trend})`}\n                    />\n                    <polyline \n                      points={navSparklineData.points.split(' ').map(p => {\n                        const [x, y] = p.split(',');\n                        return `${(parseFloat(x) / 40 * 22) + 1},${(parseFloat(y) / 24 * 12) + 1}`;\n                      }).join(' ')}\n                      stroke={mobileBottomTab === "insight" ? "#ffffff" : (navSparklineData.trend === "up" ? "#22c55e" : navSparklineData.trend === "down" ? "#ef4444" : "#9ca3af")} \n                      strokeWidth={mobileBottomTab === "insight" ? "2" : "1.5"} \n                      strokeLinecap="round" \n                      strokeLinejoin="round" \n                      fill="none"\n                    />\n                  </svg>\n                </button>\n\n                {/* Paper Trade Tab */}\n                <button\n                  onClick={() => setMobileBottomTab("paper-trade")}\n                  className={`flex items-center justify-center flex-1 rounded-full px-4 py-2 transition-all duration-200 ${\n                    mobileBottomTab === "paper-trade"\n                      ? "bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md"\n                      : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"\n                  }`}\n                  data-testid="mobile-tab-paper-trade"\n                >\n                  <TrendingUp className={`h-5 w-5 ${mobileBottomTab === "paper-trade" ? "fill-current" : ""}`} />\n                </button>\n\n                {/* Ranking Tab */}\n                <button\n                  onClick={() => setMobileBottomTab("ranking")}\n                  className={`flex items-center justify-center flex-1 rounded-full px-4 py-2 transition-all duration-200 ${\n                    mobileBottomTab === "ranking"\n                      ? "bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md"\n                      : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"\n                  }`}\n                  data-testid="mobile-tab-ranking"\n                >\n                  <Trophy className={`h-5 w-5 ${mobileBottomTab === "ranking" ? "fill-current" : ""}`} />\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Mobile Paper Trade Tab - Full Screen */}\n{activeTab === "journal" && mobileBottomTab === "paper-trade" && (\n          <div className="md:hidden fixed inset-0 z-40 bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-950 overflow-y-auto pb-20 flex flex-col">\n            {/* Hero Balance Section - Dark gradient background */}\n            <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 px-5 pt-8 pb-6 relative">\n\n              <div className="text-gray-400 text-xs mb-1">P&L</div>\n              <div className={`text-3xl font-bold mb-2 ${paperTradingTotalPnl >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`} data-testid="paper-trading-pnl-mobile">\n                {hidePositionDetails ? '***' : `₹${paperTradingTotalPnl.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`}\n              </div>\n              <div className="text-sm flex items-center gap-1 text-gray-400">\n                <span>{hidePositionDetails ? '***' : `₹${paperTradingCapital.toLocaleString('en-IN')}`}</span>\n                <span className="text-gray-500 text-xs">Total Capital</span>\n              </div>\n\n              {/* Quick Stats */}\n              <div className="flex items-center gap-4 mt-4 text-xs">\n                <div className="flex items-center gap-1.5 text-gray-400">\n                  <span>Positions:</span>\n                  <span className="text-white font-medium">{paperPositions.filter(p => p.isOpen).length}</span>\n                </div>\n                <div className="flex items-center gap-1.5 text-gray-400">\n                  <span>Trades:</span>\n                  <span className="text-white font-medium">{paperTradeHistory.length}</span>\n                </div>\n                <Button\n                  onClick={() => setHidePositionDetails(!hidePositionDetails)}\n                  size="icon"\n                  variant="ghost"\n                  className="h-6 w-6 ml-auto text-gray-400 hover:text-white"\n                  data-testid="button-toggle-visibility-mobile"\n                >\n                  {hidePositionDetails ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}\n                </Button>\n              </div>\n            </div>\n\n            {/* Content Area - Scrollable */}\n            <div className="flex-1 overflow-y-auto">\n              {/* New Trade Card */}\n              <div className="px-4 py-4">\n                <div className="bg-white dark:bg-gray-900 rounded-xl p-4 border border-gray-100 dark:border-gray-800">\n                  <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">New Trade</div>\n\n                  {/* Search Input */}\n                  <div className="relative mb-3">\n                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />\n                    <Input\n                      placeholder="Search instrument..."\n                      value={paperTradeSymbolSearch}\n                      onChange={(e) => {\n                        const query = e.target.value;\n                        if (!query && paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                          const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                          if (stream) stream.close();\n                          paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                          setPaperTradingWsStatus('disconnected');\n                        }\n                        setPaperTradeSymbolSearch(query);\n                        setPaperTradeSymbol("");\n                        setPaperTradeCurrentPrice(null);\n                        if (query.length > 0) {\n                          searchPaperTradingInstruments(query);\n                        } else {\n                          setPaperTradeSearchResults([]);\n                        }\n                      }}\n                      className="h-10 pl-10 text-sm rounded-lg bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"\n                      data-testid="input-paper-trade-search-mobile-tab"\n                    />\n                    {/* Search Dropdown */}\n                    {paperTradeSymbolSearch && !paperTradeSymbol && (\n                      <div className="absolute z-[100] left-0 right-0 mt-1 max-h-48 overflow-auto bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg">\n                        {paperTradeSearchLoading ? (\n                          <div className="px-4 py-3 text-sm text-gray-500 flex items-center gap-2">\n                            <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                            Searching...\n                          </div>\n                        ) : paperTradeSearchResults.length === 0 ? (\n                          <div className="px-4 py-3 text-sm text-gray-500">No results found</div>\n                        ) : (\n                          paperTradeSearchResults.slice(0, 6).map((stock, idx) => (\n                            <button\n                              key={`${stock.symbol}-${stock.exchange}-${idx}`}\n                              onClick={() => {\n                                setSelectedPaperTradingInstrument(stock);\n                                setPaperTradeSymbol(stock.symbol);\n                                setPaperTradeSymbolSearch(stock.symbol);\n                                if (paperTradeType === 'STOCK') {\n                                  setPaperTradeQuantity("");\n                                } else {\n                                  setPaperTradeLotInput("1");\n                                }\n                                fetchPaperTradePrice(stock);\n                              }}\n                              className="w-full text-left px-4 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-800 flex items-center justify-between text-sm border-b border-gray-100 dark:border-gray-800 last:border-0"\n                              data-testid={`select-stock-mobile-tab-${stock.symbol}`}\n                            >\n                              <span className="font-medium">{stock.symbol}</span>\n                              <span className="text-xs text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">{stock.exchange}</span>\n                            </button>\n                          ))\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Type and Option Chain Row */}\n                  <div className="flex gap-2 mb-3">\n                    <Select \n                      value={paperTradeType} \n                      onValueChange={(v) => {\n                        const newType = v as 'STOCK' | 'FUTURES' | 'OPTIONS' | 'MCX';\n                        if (paperTradeSymbol && paperTradingEventSourcesRef.current.has(paperTradeSymbol)) {\n                          const stream = paperTradingEventSourcesRef.current.get(paperTradeSymbol);\n                          if (stream) stream.close();\n                          paperTradingEventSourcesRef.current.delete(paperTradeSymbol);\n                        }\n                        setPaperTradeType(newType);\n                        setPaperTradeSymbol("");\n                        setPaperTradeSymbolSearch("");\n                        setPaperTradeSearchResults([]);\n                        setPaperTradeCurrentPrice(null);\n                        setSelectedPaperTradingInstrument(null);\n                        setPaperTradeQuantity("");\n                        setPaperTradeLotInput("");\n                        setPaperTradeSLPrice("");\n                        setPaperTradingWsStatus('disconnected');\n                      }}\n                    >\n                      <SelectTrigger className="flex-1 h-10 text-sm rounded-lg" data-testid="select-paper-trade-type-mobile-tab">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value="STOCK">Stock</SelectItem>\n                        <SelectItem value="FUTURES">Futures</SelectItem>\n                        <SelectItem value="OPTIONS">Options</SelectItem>\n                        <SelectItem value="MCX">MCX</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Button\n                      onClick={() => {\n                        fetchOptionChainData();\n                        setShowOptionChain(true);\n                      }}\n                      size="icon"\n                      variant="outline"\n                      className="h-10 w-10 rounded-lg"\n                      data-testid="button-option-chain-mobile-tab"\n                    >\n                      <Grid3X3 className="h-4 w-4" />\n                    </Button>\n                  </div>\n\n                  {/* Quantity and Price Row */}\n                  <div className="flex gap-2 mb-4">\n                    {paperTradeType === 'STOCK' ? (\n                      <Input\n                        type="number"\n                        placeholder="Quantity"\n                        value={paperTradeQuantity}\n                        onChange={(e) => setPaperTradeQuantity(e.target.value)}\n                        className="flex-1 h-10 text-sm text-center rounded-lg"\n                        min="1"\n                        data-testid="input-paper-trade-qty-mobile-tab"\n                      />\n                    ) : (\n                      <Input\n                        type="number"\n                        placeholder="Lots"\n                        value={paperTradeLotInput}\n                        onChange={(e) => setPaperTradeLotInput(e.target.value)}\n                        className="flex-1 h-10 text-sm text-center rounded-lg"\n                        min="1"\n                        data-testid="input-paper-trade-lots-mobile-tab"\n                      />\n                    )}\n                    <div className="flex-1 h-10 flex items-center justify-center text-sm font-medium border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-800">\n                      {paperTradePriceLoading ? (\n                        <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>\n                      ) : paperTradeCurrentPrice ? (\n                        <span>₹{paperTradeCurrentPrice.toFixed(2)}</span>\n                      ) : (\n                        <span className="text-gray-500 dark:text-gray-400">Price</span>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Stop Loss Button with Dropdown - Mobile Tab */}\n                  <div className="flex gap-2 mb-3">\n                    <div className="relative flex-1">\n                      <Button\n                        onClick={() => setShowMobilePaperTradeSLDropdown(!showMobilePaperTradeSLDropdown)}\n                        disabled={!paperTradeSymbol || !(paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput) || !paperTradeCurrentPrice}\n                        variant={paperTradeSLEnabled ? "default" : "outline"}\n                        className={`w-full h-10 rounded-lg ${paperTradeSLEnabled ? 'bg-orange-500 hover:bg-orange-600 text-white' : ''}`}\n                        data-testid="button-paper-sl-mobile-tab"\n                      >\n                        <Shield className="h-4 w-4 mr-2" />\n                        {paperTradeSLEnabled ? `SL: ₹${paperTradeSLPrice}` : 'Set SL'}\n                      </Button>\n                      {showMobilePaperTradeSLDropdown && (\n                        <div className="absolute z-50 bottom-1/2 transform translate-y-1/2 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg w-64">\n                          <div className="p-4 space-y-3">\n                            <div className="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">Stop Loss Configuration</div>\n                            <div>\n                              <label className="text-[10px] text-gray-500 uppercase">Type</label>\n                              <Select value={paperTradeSLType} onValueChange={(v: any) => setPaperTradeSLType(v)}>\n                                <SelectTrigger className="h-9 text-sm mt-1">\n                                  <SelectValue />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  <SelectItem value="price">Price SL</SelectItem>\n                                  <SelectItem value="percent">% SL</SelectItem>\n                                  <SelectItem value="duration">Duration</SelectItem>\n                                  <SelectItem value="high">Candle High</SelectItem>\n                                  <SelectItem value="low">Candle Low</SelectItem>\n                                </SelectContent>\n                              </Select>\n                            </div>\n\n                            {(paperTradeSLType === 'high' || paperTradeSLType === 'low') && (\n                              <div>\n                                <label className="text-[10px] text-gray-500 uppercase">Timeframe</label>\n                                <Select value={paperTradeSLTimeframe} onValueChange={(v) => setPaperTradeSLTimeframe(v)}>\n                                  <SelectTrigger className="h-9 text-sm mt-1">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value="1m">1 Minute</SelectItem>\n                                    <SelectItem value="5m">5 Minutes</SelectItem>\n                                    <SelectItem value="15m">15 Minutes</SelectItem>\n                                    <SelectItem value="30m">30 Minutes</SelectItem>\n                                    <SelectItem value="1h">1 Hour</SelectItem>\n                                    <SelectItem value="4h">4 Hours</SelectItem>\n                                    <SelectItem value="1d">1 Day</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n                            )}\n\n                            {paperTradeSLType === 'duration' && (\n                              <div>\n                                <label className="text-[10px] text-gray-500 uppercase">Duration Unit</label>\n                                <Select value={paperTradeSLDurationUnit} onValueChange={(v) => setPaperTradeSLDurationUnit(v)}>\n                                  <SelectTrigger className="h-9 text-sm mt-1">\n                                    <SelectValue />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value="min">Minutes</SelectItem>\n                                    <SelectItem value="hr">Hours</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n                            )}\n\n                            {paperTradeSLType !== 'high' && paperTradeSLType !== 'low' && (\n                              <div>\n                                <label className="text-[10px] text-gray-500 uppercase">Value</label>\n                                <Input\n                                  type="number"\n                                  placeholder={paperTradeSLType === 'price' ? 'Price' : '%'}\n                                  value={paperTradeSLValue}\n                                  onChange={(e) => setPaperTradeSLValue(e.target.value)}\n                                  className="h-9 text-sm mt-1"\n                                  data-testid="input-paper-sl-value-mobile-tab"\n                                />\n                              </div>\n                            )}\n\n                            <div className="flex gap-2 pt-1">\n                              <Button\n                                onClick={() => {\n                                  setPaperTradeSLEnabled(false);\n                                  setPaperTradeSLValue("");\n                                  setPaperTradeSLPrice("");\n                                  setShowMobilePaperTradeSLDropdown(false);\n                                }}\n                                size="sm"\n                                variant="outline"\n                                className="flex-1 h-9"\n                                data-testid="button-clear-sl-mobile-tab"\n                              >\n                                Clear\n                              </Button>\n                              <Button\n                                onClick={() => {\n                                  if (paperTradeSLValue || paperTradeSLType === 'high' || paperTradeSLType === 'low') {\n                                    setPaperTradeSLEnabled(true);\n                                    setPaperTradeSLPrice(paperTradeSLValue);\n                                    toast({\n                                      title: "Stop Loss Set",\n                                      description: paperTradeSLType === 'price' \n                                        ? `SL at ₹${paperTradeSLValue}` \n                                        : paperTradeSLType === 'percent'\n                                        ? `SL at ${paperTradeSLValue}% loss`\n                                        : paperTradeSLType === 'duration'\n                                        ? `SL after ${paperTradeSLValue} ${paperTradeSLDurationUnit}`\n                                        : `SL at ${paperTradeSLTimeframe} candle ${paperTradeSLType}`\n                                    });\n                                  }\n                                  setShowMobilePaperTradeSLDropdown(false);\n                                }}\n                                size="sm"\n                                className="flex-1 h-9 bg-orange-500 hover:bg-orange-600 text-white"\n                                data-testid="button-set-sl-mobile-tab"\n                              >\n                                Set SL\n                              </Button>\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n\n                  {/* Action Buttons */}\n                  <div className="flex gap-3">\n                    {(() => {\n                      const inputValue = paperTradeType === 'STOCK' ? paperTradeQuantity : paperTradeLotInput;\n                      return (\n                        <>\n                          <Button\n                            onClick={() => { setPaperTradeAction('BUY'); executePaperTrade(); }}\n                            disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                            className="flex-1 h-12 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold text-base"\n                            data-testid="button-paper-buy-mobile-tab"\n                          >\n                            BUY\n                          </Button>\n                          <Button\n                            onClick={() => { setPaperTradeAction('SELL'); executePaperTrade(); }}\n                            disabled={!paperTradeSymbol || !inputValue || !paperTradeCurrentPrice}\n                            className="flex-1 h-12 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold text-base"\n                            data-testid="button-paper-sell-mobile-tab"\n                          >\n                            SELL\n                          </Button>\n                        </>\n                      );\n                    })()}\n                  </div>\n                </div>\n              </div>\n\n              {/* Positions & Trade History Toggle Section */}\n              {(paperPositions.filter(p => p.isOpen).length > 0 || paperTradeHistory.length > 0) && (\n                <div className="">\n                  <div className="flex items-center justify-between mb-3">\n                    <Button\n                      onClick={() => setShowMobileTradeHistory(!showMobileTradeHistory)}\n                      size="icon"\n                      variant="ghost"\n                      className="h-7 w-7 text-gray-400 hover:text-white"\n                      data-testid="button-toggle-mobile-position-history"\n                    >\n                      <ChevronLeft className="h-4 w-4" />\n                    </Button>\n                    <div className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider flex items-center gap-2">\n                      {showMobileTradeHistory ? 'Trade History' : 'Open Positions'}\n                      {!showMobileTradeHistory && paperTradingWsStatus === 'connected' && <span className="w-1.5 h-1.5 bg-green-500 rounded-full" />}\n                    </div>\n                    <Button\n                      onClick={showMobileTradeHistory ? recordAllPaperTrades : exitAllPaperPositions}\n                      size="sm"\n                      variant="ghost"\n                      className={`h-7 px-2 text-xs ${\n                        showMobileTradeHistory \n                          ? 'text-blue-400 hover:text-blue-500' \n                          : 'text-red-500 hover:text-red-600'\n                      }`}\n                      data-testid={showMobileTradeHistory ? "button-record-all-mobile-tab" : "button-exit-all-mobile-tab"}\n                    >\n                      {showMobileTradeHistory ? 'Record' : 'Exit All'}\n                    </Button>\n                  </div>\n\n\n\n\n                  {/* Open Positions View */}\n                  {!showMobileTradeHistory && paperPositions.filter(p => p.isOpen).length > 0 && (\n                    <div className="space-y-2 px-4 divide-gray-200 dark:divide-gray-800">\n                      {paperPositions.filter(p => p.isOpen).map(position => (\n                        <div \n                          key={position.id}\n                          className="relative bg-red-500 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden select-none cursor-grab active:cursor-grabbing h-auto"\n                          data-testid={`position-card-tab-${position.symbol}`}\n                          onMouseDown={(e) => {\n                            swipeStartXRef.current = e.clientX;\n                            swipeStartYRef.current = e.clientY;\n                            console.log('🔴 MOUSE DOWN on', position.symbol, ':', swipeStartXRef.current);\n                          }}\n                          onMouseUp={(e) => {\n                            const endX = e.clientX;\n                            const endY = e.clientY;\n                            const diffX = swipeStartXRef.current - endX;\n                            const diffY = Math.abs(swipeStartYRef.current - endY);\n\n                            console.log('🟢 MOUSE UP on', position.symbol, '- diffX:', diffX, 'diffY:', diffY);\n\n                            // Swipe left (diffX > 0) with minimal vertical movement - REVEAL EXIT\n                            if (diffX > 25 && diffY < 50) {\n                              console.log('✅ LEFT SWIPE DETECTED - SHOW EXIT BUTTON');\n                              setSwipedPositionId(position.id);\n                            }\n                            // Swipe right to close (diffX < 0) - HIDE EXIT\n                            else if (diffX < -25 && diffY < 50) {\n                              console.log('✅ RIGHT SWIPE DETECTED - HIDE EXIT BUTTON');\n                              setSwipedPositionId(null);\n                            }\n                          }}\n                          onTouchStart={(e) => {\n                            if (e.touches && e.touches[0]) {\n                              swipeStartXRef.current = e.touches[0].clientX;\n                              swipeStartYRef.current = e.touches[0].clientY;\n                              console.log('🔴 TOUCH START on', position.symbol, ':', swipeStartXRef.current);\n                            }\n                          }}\n                          onTouchMove={(e) => {\n                            if (Math.abs(swipeStartXRef.current - (e.touches[0]?.clientX || 0)) > 10) {\n                              e.preventDefault();\n                            }\n                          }}\n                          onTouchEnd={(e) => {\n                            if (e.changedTouches && e.changedTouches[0]) {\n                              const endX = e.changedTouches[0].clientX;\n                              const endY = e.changedTouches[0].clientY;\n                              const diffX = swipeStartXRef.current - endX;\n                              const diffY = Math.abs(swipeStartYRef.current - endY);\n\n                              console.log('🟢 TOUCH END on', position.symbol, '- diffX:', diffX, 'diffY:', diffY);\n\n                              if (diffX > 25 && diffY < 50) {\n                                console.log('✅ LEFT SWIPE DETECTED - SHOW EXIT BUTTON');\n                                setSwipedPositionId(position.id);\n                              }\n                              else if (diffX < -25 && diffY < 50) {\n                                console.log('✅ RIGHT SWIPE DETECTED - HIDE EXIT BUTTON');\n                                setSwipedPositionId(null);\n                              }\n                            }\n                          }}\n                        >\n                          {/* Exit button - always rendered, visible when card slides */}\n                          <div className="absolute right-0 top-0 bottom-0 w-1/5 bg-red-500 flex items-center justify-center">\n                            <button\n                              onClick={() => exitPosition(position.id)}\n                              className="flex flex-col items-center justify-center w-full h-full hover:bg-red-600 transition-colors active:bg-red-700"\n                              data-testid={`button-exit-position-${position.symbol}`}\n                              title="Exit position"\n                            >\n                              <div className="text-white text-sm font-bold">×</div>\n                              <div className="text-[7px] text-white dark:text-white font-bold whitespace-nowrap">EXIT</div>\n                            </button>\n                          </div>\n\n                          {/* Main position card content - slides left on swipe */}\n                          <div \n                            className="w-full p-3 bg-white dark:bg-gray-900 cursor-pointer"\n                            style={{\n                              transform: swipedPositionId === position.id ? 'translateX(-20%)' : 'translateX(0)',\n                              transition: 'transform 300ms ease-in-out'\n                            }}\n                            onClick={() => {\n                              // Clicking on main content (80% area) resets the swipe\n                              if (swipedPositionId === position.id) {\n                                console.log('🔄 Tapped on content - resetting swipe');\n                                setSwipedPositionId(null);\n                              }\n                            }}\n                          >\n                            <div className="flex items-center justify-between mb-2">\n                              <div className="flex items-center gap-2">\n                                <span className="font-medium text-sm">{position.symbol}</span>\n                                <span className={`text-[10px] px-1.5 py-0.5 rounded ${\n                                  position.action === 'BUY' \n                                    ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' \n                                    : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'\n                                }`}>\n                                  {position.action}\n                                </span>\n                              </div>\n                              {swipedPositionId !== position.id && (\n                                <ChevronLeft className="w-4 h-4 text-gray-400 opacity-50" />\n                              )}\n                            </div>\n                            <div className="flex items-center justify-between text-xs">\n                              <div className="text-gray-600 dark:text-gray-400">\n                                Qty: {position.quantity} | Avg: {hidePositionDetails ? '***' : `₹${position.entryPrice.toFixed(2)}`}\n                              </div>\n                              <div className={`font-semibold ${position.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                                {hidePositionDetails ? '***' : `₹${position.pnl.toFixed(0)}`}\n                              </div>\n                            </div>\n                            <div className="text-[10px] text-gray-400 mt-1">\n                            <div className="text-[10px] text-gray-400 mt-1 flex items-center justify-between">\n                              <div>\n                                LTP: ₹{position.currentPrice.toFixed(2)}\n                                {(position as any).slTriggerPrice && (\n                                  <span className="text-orange-500 ml-2">SL: ₹{(position as any).slTriggerPrice.toFixed(2)}</span>\n                                )}\n                              </div>\n                              <div className={`text-[10px] font-semibold ${position.pnlPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                                {position.pnlPercent >= 0 ? '+' : ''}{position.pnlPercent.toFixed(2)}%\n                              </div>\n                            </div>\n                              {(position as any).slTriggerPrice && (\n                                <span className="text-orange-500 ml-2">SL: ₹{(position as any).slTriggerPrice.toFixed(2)}</span>\n                              )}\n                            </div>\n                          </div>\n\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n\n\n\n\n                  {/* Trade History View */}\n                  {showMobileTradeHistory && paperTradeHistory.length > 0 && (\n                    <div className="space-y-1 bg-white dark:bg-gray-900/50 rounded-lg p-3">\n                      {[...paperTradeHistory].reverse().slice(0, 10).map(trade => (\n                        <div \n                          key={trade.id}\n                          className="flex items-center justify-between py-2.5 border-b border-gray-200 dark:border-gray-800 last:border-0"\n                        >\n                          <div className="flex items-center gap-3">\n                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium ${\n                              trade.action === 'BUY' \n                                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' \n                                : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'\n                            }`}>\n                              {trade.action === 'BUY' ? 'B' : 'S'}\n                            </div>\n                            <div>\n                              <div className="text-sm font-medium text-gray-900 dark:text-white">{trade.symbol}</div>\n                              <div className="text-[10px] text-gray-400">{trade.time} | Qty: {trade.quantity}</div>\n                            </div>\n                          </div>\n                          <div className="text-right">\n                            <div className="text-sm font-medium text-gray-900 dark:text-white">₹{trade.price.toFixed(2)}</div>\n                            <div className={`text-xs ${\n                              !trade.pnl ? 'text-gray-600 dark:text-gray-400' : trade.pnl.includes('+') ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'\n                            }`}>\n                              {trade.pnl || '-'}\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Footer */}\n              <div className="px-4 pb-6">\n                <div className="flex items-center justify-between pt-3 border-t border-gray-800">\n                  <button\n                    onClick={resetPaperTradingAccount}\n                    className="text-xs text-gray-400 hover:text-red-500 transition-colors"\n                    data-testid="button-reset-mobile-tab"\n                  >\n                    Reset Account\n                  </button>\n                  <span className="text-xs text-gray-400">Demo mode</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Share Tradebook Dialog */}\n        <Dialog \n          open={showShareDialog} \n          onOpenChange={(open) => {\n            if (!open) {\n              // Use the centralized close handler\n              handleShareDialogClose();\n              // Reset BOTH share dialog tag highlight AND report dialog tag highlight\n              setShareDialogTagHighlight(null);\n              setReportDialogTagHighlight(null);\n              console.log('🔄 Share Dialog closed - reset tag highlighting and shareable URL');\n            } else {\n              setShowShareDialog(open);\n            }\n          }}\n        >\n          <DialogContent className="max-w-3xl max-h-[90vh] overflow-hidden flex flex-col" data-testid="dialog-share-tradebook">\n            <DialogHeader className="flex-shrink-0">\n              <div className="flex items-start justify-between gap-4">\n                {/* Left side: PERALA and tagline */}\n                <div className="flex flex-col gap-1">\n                  <h1 className="text-3xl font-bold tracking-tight">PERALA</h1>\n                  <p className="text-xs text-muted-foreground">rethink & reinvest</p>\n                </div>\n\n                {/* Right side: Report title, UserID, and Link icon */}\n                <div className="flex flex-col items-end gap-2">\n                  <DialogTitle className="text-lg font-semibold">MY trading report</DialogTitle>\n\n                  {/* UserID */}\n                  <p className="text-xs text-muted-foreground">\n                    userID: {isSharedReportMode && sharedReportData?.reportData?.username \n                      ? sharedReportData.reportData.username \n                      : (currentUser?.displayName || currentUser?.email || currentUser?.userId || 'Guest')}\n                  </p>\n\n                  {/* Link icon button - Only show for owners (not in shared report mode) */}\n                  {!isSharedReportMode && (\n                    <div className="flex flex-col items-end gap-1">\n                      {!shareableUrl ? (\n                        <Button\n                          size="icon"\n                          onClick={handleCreateShareableLink}\n                          disabled={isCreatingShareableLink}\n                          className="bg-green-600 hover:bg-green-700 h-8 w-8"\n                          data-testid="button-create-shareable-link"\n                        >\n                          {isCreatingShareableLink ? (\n                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />\n                          ) : (\n                            <Link2 className="w-4 h-4" />\n                          )}\n                        </Button>\n                      ) : (\n                        <div className="flex items-center gap-2">\n                          <Button\n                            size="icon"\n                            variant="outline"\n                            className="bg-green-600 hover:bg-green-700 text-white h-8 w-8"\n                            onClick={() => {\n                              navigator.clipboard.writeText(shareableUrl);\n                              toast({\n                                title: "Link copied!",\n                                description: "Shareable URL copied to clipboard",\n                              });\n                            }}\n                            data-testid="button-copy-shareable-url"\n                          >\n                            <Copy className="w-4 h-4" />\n                          </Button>\n                          <Button\n                            size="icon"\n                            variant="ghost"\n                            className="h-8 w-8"\n                            onClick={() => window.open(shareableUrl, '_blank')}\n                            data-testid="button-open-shareable-url"\n                          >\n                            <ExternalLink className="w-4 h-4" />\n                          </Button>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </DialogHeader>\n\n            <div className="flex-1 overflow-auto space-y-4">\n              {/* Heatmap Container with ref for curved lines */}\n              <div className="relative">\n                <div \n                  ref={reportDialogHeatmapContainerRef}\n                  className="max-h-96 overflow-auto border border-gray-200 dark:border-gray-700 rounded-lg"\n                >\n                  <DemoHeatmap\n                    tradingDataByDate={isSharedReportMode && sharedReportData?.reportData?.tradingDataByDate \n                      ? sharedReportData.reportData.tradingDataByDate \n                      : getFilteredHeatmapData()}\n                    onDateSelect={() => {}}\n                    selectedDate={null}\n                    onDataUpdate={() => {}}\n                    isPublicView={true}\n                    onSelectDateForHeatmap={(symbol, date) => {\n                      console.log(`📊 [REPORT] Switching to heatmap mode - Symbol: ${symbol}, Date: ${date}`);\n                      setJournalChartMode('heatmap');\n                      fetchHeatmapChartData(symbol, date);\n                    }}\n                  />\n                </div>\n\n                {/* Curved Lines Overlay for FOMO button */}\n                {reportDialogTagHighlight?.tag === 'fomo' && reportDialogTagHighlight.dates.length > 0 && (() => {\n                  // Force recalculation on scroll\n                  void reportDialogScrollTrigger;\n\n                  const paths: JSX.Element[] = [];\n\n                  if (!reportDialogFomoButtonRef.current || !reportDialogHeatmapContainerRef.current) {\n                    return null;\n                  }\n\n                  // Get scrollable dimensions\n                  const scrollWidth = reportDialogHeatmapContainerRef.current.scrollWidth || 0;\n                  const scrollHeight = reportDialogHeatmapContainerRef.current.scrollHeight || 0;\n                  const scrollLeft = reportDialogHeatmapContainerRef.current.scrollLeft || 0;\n                  const scrollTop = reportDialogHeatmapContainerRef.current.scrollTop || 0;\n\n                  // Get positions relative to the heatmap's scrollable content\n                  const containerRect = reportDialogHeatmapContainerRef.current.getBoundingClientRect();\n                  const buttonRect = reportDialogFomoButtonRef.current.getBoundingClientRect();\n\n                  // Calculate button position relative to scrollable content\n                  const buttonCenterX = buttonRect.left - containerRect.left + scrollLeft + buttonRect.width / 2;\n                  const buttonCenterY = buttonRect.top - containerRect.top + scrollTop + buttonRect.height / 2;\n\n                  // Find all highlighted date cells and draw curved lines to them\n                  reportDialogTagHighlight.dates.forEach((date, index) => {\n                    // Find the heatmap cell for this date\n                    const cellElement = reportDialogHeatmapContainerRef.current?.querySelector(\n                      `[data-date="${date}"]`\n                    );\n\n                    if (cellElement) {\n                      const cellRect = cellElement.getBoundingClientRect();\n\n                      // Calculate cell position relative to scrollable content\n                      const cellCenterX = cellRect.left - containerRect.left + scrollLeft + cellRect.width / 2;\n                      const cellCenterY = cellRect.top - containerRect.top + scrollTop + cellRect.height / 2;\n\n                      // Create quadratic Bezier curve (Q command)\n                      // Control point is positioned to create a nice arc\n                      const controlX = (buttonCenterX + cellCenterX) / 2;\n                      const controlY = Math.min(buttonCenterY, cellCenterY) - 50; // Arc upward\n\n                      const pathD = `M ${buttonCenterX} ${buttonCenterY} Q ${controlX} ${controlY}, ${cellCenterX} ${cellCenterY}`;\n\n                      paths.push(\n                        <g key={`connection-${date}-${index}`}>\n                          {/* Bright colored line with dashed pattern */}\n                          <path\n                            d={pathD}\n                            fill="none"\n                            stroke="url(#reportDialogCurvedLineGradient)"\n                            strokeWidth="2.5"\n                            strokeDasharray="6,4"\n                            opacity="0.95"\n                          />\n                          {/* Glowing dot at the end of each line */}\n                          <circle\n                            cx={cellCenterX}\n                            cy={cellCenterY}\n                            r="4"\n                            fill="#fcd34d"\n                            opacity="0.9"\n                          />\n                          <circle\n                            cx={cellCenterX}\n                            cy={cellCenterY}\n                            r="3"\n                            fill="#fbbf24"\n                            className="animate-pulse"\n                          />\n                        </g>\n                      );\n                    }\n                  });\n\n                  return (\n                    <svg\n                      style={{\n                        position: 'absolute',\n                        top: 0,\n                        left: 0,\n                        width: `${scrollWidth}px`,\n                        height: `${scrollHeight}px`,\n                        pointerEvents: 'none',\n                        zIndex: 10,\n                      }}\n                    >\n                      {/* Define bright gradient for the curved lines */}\n                      <defs>\n                        <linearGradient id="reportDialogCurvedLineGradient" x1="0%" y1="0%" x2="100%" y2="0%">\n                          <stop offset="0%" stopColor="#c084fc" stopOpacity="1" />\n                          <stop offset="50%" stopColor="#f472b6" stopOpacity="1" />\n                          <stop offset="100%" stopColor="#fbbf24" stopOpacity="1" />\n                        </linearGradient>\n                      </defs>\n                      {paths}\n                    </svg>\n                  );\n                })()}\n              </div>\n\n              {/* Stats Bar - Purple metrics from journal tab */}\n              {(() => {\n                const filteredData = isSharedReportMode && sharedReportData?.reportData?.tradingDataByDate \n                  ? sharedReportData.reportData.tradingDataByDate \n                  : getFilteredHeatmapData();\n                const dates = Object.keys(filteredData).sort();\n\n                let totalPnL = 0;\n                let totalTrades = 0;\n                let winningTrades = 0;\n                let currentStreak = 0;\n                let maxWinStreak = 0;\n                let fomoTrades = 0;\n                const trendData: number[] = [];\n\n                dates.forEach(dateKey => {\n                  const dayData = filteredData[dateKey];\n                  const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n                  const tags = dayData?.tradingData?.tradingTags || dayData?.tradingTags || [];\n\n                  if (metrics) {\n                    const netPnL = metrics.netPnL || 0;\n                    totalPnL += netPnL;\n                    totalTrades += metrics.totalTrades || 0;\n                    winningTrades += metrics.winningTrades || 0;\n                    trendData.push(netPnL);\n\n                    // Calculate streak\n                    if (netPnL > 0) {\n                      currentStreak++;\n                      maxWinStreak = Math.max(maxWinStreak, currentStreak);\n                    } else {\n                      currentStreak = 0;\n                    }\n\n                    // Count FOMO tags\n                    if (Array.isArray(tags)) {\n                      tags.forEach((tag: string) => {\n                        if (tag.toLowerCase().includes('fomo')) {\n                          fomoTrades++;\n                        }\n                      });\n                    }\n                  }\n                });\n\n                const isProfitable = totalPnL >= 0;\n                const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;\n\n                // Create trend path function (from public-heatmap.tsx)\n                const createTrendPath = (data: number[]) => {\n                  if (data.length === 0) return '';\n                  const max = Math.max(...data, 0);\n                  const min = Math.min(...data, 0);\n                  const range = max - min || 1;\n                  const width = 40;\n                  const height = 20;\n\n                  const points = data.map((val, i) => {\n                    const x = (i / (data.length - 1 || 1)) * width;\n                    const y = height - ((val - min) / range) * height;\n                    return `${x},${y}`;\n                  }).join(' L ');\n\n                  return `M ${points}`;\n                };\n\n                return (\n                  <div className="bg-gradient-to-r from-violet-500 to-purple-600 rounded-md px-2 py-1.5">\n                    <div className="flex items-center justify-around text-white gap-1">\n                      {/* P&L */}\n                      <div className="flex flex-col items-center justify-center">\n                        <div className="text-[10px] opacity-80">P&L</div>\n                        <div className="text-xs font-bold">\n                          {isProfitable ? '+' : ''}₹{(totalPnL / 1000).toFixed(1)}K\n                        </div>\n                      </div>\n\n                      {/* Trend */}\n                      <div className="flex flex-col items-center justify-center">\n                        <div className="text-[10px] opacity-80">Trend</div>\n                        <div className="w-8 h-4">\n                          <svg viewBox="0 0 40 20" className="w-full h-full">\n                            <path\n                              d={createTrendPath(trendData)}\n                              fill="none"\n                              stroke="white"\n                              strokeWidth="1.5"\n                              opacity="0.9"\n                              strokeLinecap="round"\n                              strokeLinejoin="round"\n                            />\n                          </svg>\n                        </div>\n                      </div>\n\n                      {/* FOMO - Clickable button with curved lines */}\n                      <button\n                        ref={reportDialogFomoButtonRef}\n                        className={`flex flex-col items-center justify-center hover-elevate active-elevate-2 rounded px-1 transition-all ${\n                          reportDialogTagHighlight?.tag === 'fomo' ? 'bg-white/30 ring-2 ring-white/50' : ''\n                        }`}\n                        onClick={() => {\n                          if (reportDialogTagHighlight?.tag === 'fomo') {\n                            // Toggle off if already active\n                            setReportDialogTagHighlight(null);\n                            console.log('📍 Deactivated FOMO tag highlighting in report dialog');\n                          } else {\n                            // Get FOMO dates from filtered data\n                            const filteredData = isSharedReportMode && sharedReportData?.reportData?.tradingDataByDate \n                              ? sharedReportData.reportData.tradingDataByDate \n                              : getFilteredHeatmapData();\n                            const dates = Object.keys(filteredData).sort();\n\n                            const fomoDates: string[] = [];\n                            dates.forEach(dateKey => {\n                              const dayData = filteredData[dateKey];\n                              const tags = dayData?.tradingData?.tradingTags || dayData?.tradingTags || [];\n\n                              if (Array.isArray(tags)) {\n                                tags.forEach((tag: string) => {\n                                  if (tag.toLowerCase().includes('fomo') && !fomoDates.includes(dateKey)) {\n                                    fomoDates.push(dateKey);\n                                  }\n                                });\n                              }\n                            });\n\n                            // Activate FOMO highlighting\n                            setReportDialogTagHighlight({ tag: 'fomo', dates: fomoDates });\n                            console.log(`📍 Activated FOMO tag highlighting in report dialog for ${fomoDates.length} dates:`, fomoDates);\n                          }\n                        }}\n                        title={`Click to ${reportDialogTagHighlight?.tag === 'fomo' ? 'hide' : 'show'} FOMO dates on heatmap`}\n                      >\n                        <div className="text-[10px] opacity-80">FOMO</div>\n                        <div className="text-xs font-bold">{fomoTrades}</div>\n                      </button>\n\n                      {/* Win% */}\n                      <div className="flex flex-col items-center justify-center">\n                        <div className="text-[10px] opacity-80">Win%</div>\n                        <div className="text-xs font-bold">{winRate.toFixed(0)}%</div>\n                      </div>\n\n                      {/* Streak */}\n                      <div className="flex flex-col items-center justify-center">\n                        <div className="text-[10px] opacity-80">Streak</div>\n                        <div className="text-xs font-bold">{maxWinStreak}</div>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })()}\n\n              {/* Analytics Row: Total P&L, Performance Trend, Top Tags */}\n              <div className="grid grid-cols-3 gap-3">\n                {(() => {\n                  const filteredData = isSharedReportMode && sharedReportData?.reportData?.tradingDataByDate \n                    ? sharedReportData.reportData.tradingDataByDate \n                    : getFilteredHeatmapData();\n                  const dates = Object.keys(filteredData).sort();\n\n                  let totalPnL = 0;\n                  let totalTrades = 0;\n                  let winningTrades = 0;\n                  const trendData: number[] = [];\n                  const lossTagsMap = new Map<string, number>();\n\n                  dates.forEach(dateKey => {\n                    const dayData = filteredData[dateKey];\n                    const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;\n                    const tags = dayData?.tradingData?.tradingTags || dayData?.tradingTags || [];\n\n                    if (metrics) {\n                      const netPnL = metrics.netPnL || 0;\n                      totalPnL += netPnL;\n                      totalTrades += metrics.totalTrades || 0;\n                      winningTrades += metrics.winningTrades || 0;\n                      trendData.push(netPnL);\n\n                      // Only track tags from losing trades - accumulate actual loss amounts\n                      if (netPnL < 0 && Array.isArray(tags) && tags.length > 0) {\n                        tags.forEach((tag: string) => {\n                          const normalizedTag = tag.trim().toLowerCase();\n                          lossTagsMap.set(normalizedTag, (lossTagsMap.get(normalizedTag) || 0) + Math.abs(netPnL));\n                        });\n                      }\n                    }\n                  });\n\n                  const isProfitable = totalPnL >= 0;\n                  const successRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;\n\n                  const lossTags = Array.from(lossTagsMap.entries())\n                    .sort((a, b) => b[1] - a[1])\n                    .map(([tag, lossAmount]) => ({ tag, lossAmount }));\n\n                  const createTrendPath = (data: number[]) => {\n                    if (data.length === 0) return '';\n                    const max = Math.max(...data, 0);\n                    const min = Math.min(...data, 0);\n                    const range = max - min || 1;\n                    const width = 100;\n                    const height = 45;\n\n                    if (data.length === 1) {\n                      const x = width / 2;\n                      const y = height - ((data[0] - min) / range) * height;\n                      return `M ${x} ${y}`;\n                    }\n\n                    // Create smooth bezier curve\n                    let path = '';\n                    const points = data.map((val, i) => {\n                      const x = (i / (data.length - 1)) * width;\n                      const y = height - ((val - min) / range) * height;\n                      return { x, y };\n                    });\n\n                    // Start path\n                    path += `M ${points[0].x} ${points[0].y}`;\n\n                    // Use quadratic bezier curves for smoothness\n                    for (let i = 1; i < points.length; i++) {\n                      const current = points[i];\n                      const prev = points[i - 1];\n                      const cpX = (prev.x + current.x) / 2;\n                      const cpY = (prev.y + current.y) / 2;\n                      path += ` Q ${cpX} ${cpY}, ${current.x} ${current.y}`;\n                    }\n\n                    return path;\n                  };\n\n                  return (\n                    <>\n                      {/* Column 1: Total P&L - Minimalistic Card */}\n                      <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-slate-200 dark:border-slate-800 shadow-lg">\n                        <div className="mb-4">\n                          <div className="text-[11px] text-slate-600 dark:text-slate-400 uppercase font-semibold mb-2">Total P&L</div>\n                          <div className={`text-2xl font-bold ${isProfitable ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400'}`}>\n                            {isProfitable ? '+' : ''}₹{(Math.abs(totalPnL) / 1000).toFixed(1)}K\n                          </div>\n                        </div>\n                        <div className="space-y-2.5">\n                          <div className="flex justify-between text-[12px]">\n                            <span className="text-slate-600 dark:text-slate-400">Total Trades</span>\n                            <span className="font-medium text-slate-900 dark:text-slate-100">{totalTrades}</span>\n                          </div>\n                          <div className="flex justify-between text-[12px]">\n                            <span className="text-slate-600 dark:text-slate-400">Success Rate</span>\n                            <span className="font-medium text-slate-900 dark:text-slate-100">{successRate.toFixed(1)}%</span>\n                          </div>\n                          <div className="mt-3">\n                            <div className="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">\n                              <div \n                                className={`h-full rounded-full transition-all ${isProfitable ? 'bg-emerald-500' : 'bg-red-500'}`}\n                                style={{ width: `${successRate}%` }}\n                              />\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Column 2: Performance Trend */}\n                      <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-slate-200 dark:border-slate-800 shadow-lg">\n                        <div className="flex items-start justify-between mb-3">\n                          <div className="text-[11px] text-gray-600 dark:text-gray-400 uppercase font-semibold">Performance Trend</div>\n                          <div className={`text-[10px] px-2 py-1 rounded ${isProfitable ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'}`}>\n                            {isProfitable ? 'Profitable' : 'Not Profitable'}\n                          </div>\n                        </div>\n                        {trendData.length > 0 ? (\n                          <div className="h-28 w-full">\n                            {(() => {\n                              // Convert trend data to chart format\n                              const chartData = trendData.map((pnl, idx) => ({\n                                day: `${idx + 1}`,\n                                value: pnl,\n                                pnl: pnl,\n                              }));\n\n                              \n  return (\n                                <ResponsiveContainer width="100%" height="100%">\n                                  <AreaChart\n                                    data={chartData}\n                                    margin={{ top: 10, right: 10, left: 0, bottom: 0 }}\n                                  >\n                                    <defs>\n                                      <linearGradient id="reportTrendGradient" x1="0" y1="0" x2="0" y2="1">\n                                        <stop offset="0%" stopColor="rgb(107, 114, 128)" stopOpacity={0.4} />\n                                        <stop offset="100%" stopColor="rgb(107, 114, 128)" stopOpacity={0.05} />\n                                      </linearGradient>\n                                    </defs>\n                                    <XAxis dataKey="day" axisLine={false} tickLine={false} tick={false} />\n                                    <YAxis axisLine={false} tickLine={false} tick={false} domain={['dataMin - 1000', 'dataMax + 1000']} />\n                                    <Tooltip\n                                      contentStyle={{\n                                        background: 'var(--background)',\n                                        border: '1px solid var(--border)',\n                                        borderRadius: '8px',\n                                        fontSize: '11px',\n                                        padding: '6px 10px',\n                                      }}\n                                      formatter={(value: any) => [\n                                        `${value >= 0 ? '₹' : '-₹'}${Math.abs(value).toLocaleString()}`,\n                                        'P&L',\n                                      ]}\n                                    />\n                                    <Area\n                                      type="natural"\n                                      dataKey="value"\n                                      stroke={isProfitable ? '#16a34a' : '#dc2626'}\n                                      strokeWidth={2}\n                                      fill="url(#reportTrendGradient)"\n                                      dot={false}\n                                      activeDot={{\n                                        r: 4,\n                                        fill: isProfitable ? '#16a34a' : '#dc2626',\n                                        stroke: 'white',\n                                        strokeWidth: 2,\n                                      }}\n                                      isAnimationActive={true}\n                                      animationDuration={600}\n                                      animationEasing="ease-in-out"\n                                    />\n                                  </AreaChart>\n                                </ResponsiveContainer>\n                              );\n                            })()}\n                          </div>\n                        ) : (\n                          <div className="h-28 flex items-center justify-center text-gray-400 text-xs">\n                            No data\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Column 3: Loss Tags */}\n                      <div className="bg-white dark:bg-slate-900 rounded-lg p-4 border border-slate-200 dark:border-slate-800 shadow-lg">\n                        <div className="text-[11px] text-gray-600 dark:text-gray-400 uppercase font-semibold mb-3">Loss Tags</div>\n                        {lossTags.length > 0 ? (\n                          <div className="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-md p-3 space-y-2 max-h-32 overflow-y-auto">\n                            {lossTags.map(({ tag, lossAmount }) => (\n                              <div\n                                key={tag}\n                                className="flex items-center justify-between px-2.5 py-1.5 bg-red-100 dark:bg-red-900/50 border border-red-300 dark:border-red-700 rounded-md"\n                                data-testid={`tag-loss-${tag}`}\n                              >\n                                <span className="text-[12px] font-medium text-red-800 dark:text-red-300 capitalize truncate">{tag}</span>\n                                <span className="text-[11px] font-bold text-red-600 dark:text-red-400 ml-2 flex-shrink-0">-₹{lossAmount.toLocaleString('en-IN')}</span>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className="text-[12px] text-gray-500 dark:text-gray-400 italic py-3">No loss tags</div>\n                        )}\n                      </div>\n                    </>\n                  );\n                })()}\n              </div>\n\n              {/* Promotional Section */}\n              <div className="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 rounded-lg p-4 border border-purple-200 dark:border-purple-800 mt-4">\n                <div className="space-y-2">\n                  <div className="flex items-start gap-3">\n                    <div className="w-5 h-5 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0 mt-0.5">\n                      <span className="text-white text-xs font-bold">★</span>\n                    </div>\n                    <div>\n                      <p className="text-sm font-semibold text-gray-800 dark:text-gray-100">Advanced Trading Journal</p>\n                      <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">Tracks emotional decisions • Works on all brokers • NSE, Crypto, Commodity, Forex</p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n            </div>\n          </DialogContent>\n        </Dialog>\n\n      </div>\n    </div>\n  );\n}\n