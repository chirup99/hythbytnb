                        0,
                      );
                      const totalPnL = tagAnalysis.reduce(
                        (sum: number, tag: any) => sum + tag.totalPnL,
                        0,
                      );
                      const totalWins = tagAnalysis.reduce(
                        (sum: number, tag: any) => sum + tag.wins,
                        0,
                      );
                      const overallWinRate =
                        totalTrades > 0 ? (totalWins / totalTrades) * 100 : 0;

                      const overallStats = {
                        totalTrades,
                        winRate: overallWinRate,
                        totalPnL,
                      };
                      const topPerformers = tagAnalysis.slice(0, 5);
                      const worstPerformers = tagAnalysis.slice(-3).reverse();

                      return {
                        tagAnalysis,
                        overallStats,
                        topPerformers,
                        worstPerformers,
                        tradingDayAnalysis: dailyStats,
                      };
                    };

                    // âœ… NEW: Use filtered heatmap data directly instead of complex insights
                    const filteredHeatmapData = getFilteredHeatmapData();
                    const insights = calculateTradingInsights(filteredHeatmapData);
                    const calculateHeatmapMetrics = () => {
                      const dates = Object.keys(filteredHeatmapData);
                      let totalPnL = 0;
                      let totalTrades = 0;
                      let winningTrades = 0;
                      let datesWithTrading = 0;
                      dates.forEach(dateKey => {
                        const dayData = filteredHeatmapData[dateKey];

                        // Handle both wrapped (AWS) and unwrapped formats
                        const metrics = dayData?.tradingData?.performanceMetrics || dayData?.performanceMetrics;

                        if (metrics) {
                          const netPnL = metrics.netPnL || 0;

                          // Only include dates with actual trading activity (non-zero P&L)
                          if (netPnL !== 0) {
                            totalPnL += netPnL;
                            totalTrades += metrics.totalTrades || 0;
                            winningTrades += metrics.winningTrades || 0;
                            datesWithTrading++;
                          }
                        }
                      });

                      const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;

                      return { totalPnL, totalTrades, winRate, datesCount: datesWithTrading };
                    };

                    const heatmapMetrics = calculateHeatmapMetrics();
                    const totalPnL = heatmapMetrics.totalPnL;
                    const isProfitable = totalPnL >= 0;

                    console.log(`ðŸ“Š Performance Trend using ${selectedDateRange ? 'FILTERED' : 'ALL'} heatmap data: ${heatmapMetrics.datesCount} dates, Total P&L: â‚¹${totalPnL.toFixed(2)}`);

                    return (
                      <div className="space-y-6">
                        {/* Desktop: Single Row with Total P&L, Performance Trend, Top Tags */}
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                          {/* Total Performance Card - Desktop: Left side */}
                          <div
                            className={`md:col-span-3 rounded-3xl p-6 md:p-8 text-white shadow-2xl ${isProfitable ? "bg-gradient-to-br from-emerald-500 to-teal-600" : "bg-gradient-to-br from-red-500 to-rose-600"}`}
                          >
                            <div className="flex items-center justify-between mb-6">
                              <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                                <Target className="w-6 h-6" />
                              </div>
                              <div className="text-right">
                                <div className="text-sm opacity-80">
                                  {selectedDateRange ? 'Range' : 'Total'} P&L
                                </div>
                                <div className="text-2xl md:text-3xl font-bold">
                                  {totalPnL >= 0 ? "" : "-"}â‚¹
                                  {Math.abs(totalPnL).toLocaleString("en-IN")}
                                </div>
                              </div>
                            </div>

                            <div className="space-y-4">
                              <div className="flex justify-between items-center">
                                <span className="text-sm opacity-80">
                                  Total Trades
                                </span>
                                <span className="font-semibold">
                                  {heatmapMetrics.totalTrades}
                                </span>
                              </div>
